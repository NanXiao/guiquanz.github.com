<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>tools/build.c - linux-0.11-ebook</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

code {
    font-family: consolas, monospace;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
  <h3>tools/build.c - linux-0.11-ebook</h3>
   <a href="../index.html"> Table of Contents </a>
 <h4>Functions defined</h4>
 <ul>
<li><a href="#L50">die</a></li>
<li><a href="#L61">main</a></li>
<li><a href="#L56">usage</a></li>
</ul>
 <h4>Macros defined</h4>
 <ul>
<li><a href="#L41">DEFAULT_MAJOR_ROOT</a></li>
<li><a href="#L42">DEFAULT_MINOR_ROOT</a></li>
<li><a href="#L37">GCC_HEADER</a></li>
<li><a href="#L32">MAJOR</a></li>
<li><a href="#L36">MINIX_HEADER</a></li>
<li><a href="#L34">MINOR</a></li>
<li><a href="#L46">SETUP_SECTS</a></li>
<li><a href="#L48">STRINGIFY</a></li>
<li><a href="#L39">SYS_SIZE</a></li>
</ul>
 <h4>Source code</h4>

  <code><ol><li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> *&nbsp; linux/tools/build.c<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *&nbsp; (C) 1991&nbsp; Linus Torvalds<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * This <a href="../include/linux/fs.h.html#L116" title="include/linux/fs.h:116">file</a> builds a disk-image from three different files:<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * - bootsect: max 510 bytes of 8086 machine code, loads the rest<br/></li>
<li></span><span class="Comment"> * - setup: max 4 sectors of 8086 machine code, sets up system parm<br/></li>
<li></span><span class="Comment"> * - system: 80386 code for actual system<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * It does some checking that all files are of the correct type, and<br/></li>
<li></span><span class="Comment"> * just writes the <a href="../kernel/blk_drv/floppy.c.html#L212" title="kernel/blk_drv/floppy.c:212">result</a> to stdout, removing headers and padding to<br/></li>
<li></span><span class="Comment"> * the right amount. It also writes some system data to stderr.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Changes by tytso to allow root device specification<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;stdio.h&gt;</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* fprintf */<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;string.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;stdlib.h&gt;</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* contains exit */<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;sys/types.h&gt;</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* unistd.h needs this */<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;sys/<a href="../include/sys/stat.h.html#L6" title="include/sys/stat.h:6">stat</a>.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;linux/fs.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;unistd.h&gt;</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* contains read/write */<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;fcntl.h&gt;<br/></li>
<li></span><br/></li>
<li><a id="L32">&#x200c;</a><span class="PreProc">#define <span class="linkable">MAJOR</span>(<a href="../kernel/chr_drv/console.c.html#L72" title="kernel/chr_drv/console.c:72">x</a>) (((</span><span class="Type">unsigned</span><span class="PreProc">)(<a href="../kernel/chr_drv/console.c.html#L72" title="kernel/chr_drv/console.c:72">x</a>))&gt;&gt;</span><span class="Constant">8</span><span class="PreProc">)<br/></li>
<li></span><br/></li>
<li><a id="L34">&#x200c;</a><span class="PreProc">#define <span class="linkable">MINOR</span>(<a href="../kernel/chr_drv/console.c.html#L72" title="kernel/chr_drv/console.c:72">x</a>) ((<a href="../kernel/chr_drv/console.c.html#L72" title="kernel/chr_drv/console.c:72">x</a>)&amp;</span><span class="Constant">0xff</span><span class="PreProc">)<br/></li>
<li></span><br/></li>
<li><a id="L36">&#x200c;</a><span class="PreProc">#define <span class="linkable">MINIX_HEADER</span> </span><span class="Constant">32<br/></li>
<li><a id="L37">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">GCC_HEADER</span> </span><span class="Constant">1024<br/></li>
<li></span><br/></li>
<li><a id="L39">&#x200c;</a><span class="PreProc">#define <span class="linkable">SYS_SIZE</span> </span><span class="Constant">0x2000<br/></li>
<li></span><br/></li>
<li><a id="L41">&#x200c;</a><span class="PreProc">#define <span class="linkable">DEFAULT_MAJOR_ROOT</span> </span><span class="Constant">3<br/></li>
<li><a id="L42">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">DEFAULT_MINOR_ROOT</span> </span><span class="Constant">6<br/></li>
<li></span><br/></li>
<li><span class="Comment">/* max nr of sectors of setup: don't change unless you also change<br/></li>
<li></span><span class="Comment"> * bootsect etc */<br/></li>
<li><a id="L46">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">SETUP_SECTS</span> </span><span class="Constant">4<br/></li>
<li></span><br/></li>
<li><a id="L48">&#x200c;</a><span class="PreProc">#define <span class="linkable">STRINGIFY</span>(<a href="../kernel/chr_drv/console.c.html#L72" title="kernel/chr_drv/console.c:72">x</a>) #<a href="../kernel/chr_drv/console.c.html#L72" title="kernel/chr_drv/console.c:72">x</a><br/></li>
<li></span><br/></li>
<li><a id="L50">&#x200c;</a><span class="Type">void</span> <span class="linkable">die</span>(<span class="Type">char</span> * <a href="../include/linux/sched.h.html#L159" title="include/linux/sched.h:159">str</a>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; fprintf(<span class="Constant">stderr</span>,<span class="Constant">&quot;</span><span class="Special">%s\n</span><span class="Constant">&quot;</span>,<a href="../include/linux/sched.h.html#L159" title="include/linux/sched.h:159">str</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; exit(<span class="Constant">1</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L56">&#x200c;</a><span class="Type">void</span> <span class="linkable">usage</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L50" title="tools/build.c:50">die</a>(<span class="Constant">&quot;Usage: build bootsect setup system [rootdev] [&gt; image]&quot;</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L61">&#x200c;</a><span class="Type">int</span> <span class="linkable">main</span>(<span class="Type">int</span> argc, <span class="Type">char</span> ** <a href="../init/main.c.html#L165" title="init/main.c:165">argv</a>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> i,c,id;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">char</span> <a href="../kernel/printk.c.html#L17" title="kernel/printk.c:17">buf</a>[<span class="Constant">1024</span>];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">char</span> major_root, minor_root;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">struct</span> <a href="../include/sys/stat.h.html#L6" title="include/sys/stat.h:6">stat</a> sb;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((argc != <span class="Constant">4</span>) &amp;&amp; (argc != <span class="Constant">5</span>))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L56" title="tools/build.c:56">usage</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (argc == <span class="Constant">5</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../include/string.h.html#L88" title="include/string.h:88">strcmp</a>(<a href="../init/main.c.html#L165" title="init/main.c:165">argv</a>[<span class="Constant">4</span>], <span class="Constant">&quot;FLOPPY&quot;</span>)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../include/sys/stat.h.html#L6" title="include/sys/stat.h:6">stat</a>(<a href="../init/main.c.html#L165" title="init/main.c:165">argv</a>[<span class="Constant">4</span>], &amp;sb)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; perror(<a href="../init/main.c.html#L165" title="init/main.c:165">argv</a>[<span class="Constant">4</span>]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L50" title="tools/build.c:50">die</a>(<span class="Constant">&quot;Couldn't <a href="../include/sys/stat.h.html#L6" title="include/sys/stat.h:6">stat</a> root device.&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; major_root = <a href="../include/linux/fs.h.html#L33" title="include/linux/fs.h:33">MAJOR</a>(sb.st_rdev);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; minor_root = <a href="../include/linux/fs.h.html#L34" title="include/linux/fs.h:34">MINOR</a>(sb.st_rdev);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; major_root = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; minor_root = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; major_root = <a href="#L41" title="tools/build.c:41">DEFAULT_MAJOR_ROOT</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; minor_root = <a href="#L42" title="tools/build.c:42">DEFAULT_MINOR_ROOT</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; fprintf(<span class="Constant">stderr</span>, <span class="Constant">&quot;Root device is (</span><span class="Special">%d</span><span class="Constant">, </span><span class="Special">%d</span><span class="Constant">)</span><span class="Special">\n</span><span class="Constant">&quot;</span>, major_root, minor_root);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((major_root != <span class="Constant">2</span>) &amp;&amp; (major_root != <span class="Constant">3</span>) &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (major_root != <span class="Constant">0</span>)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fprintf(<span class="Constant">stderr</span>, <span class="Constant">&quot;Illegal root device (major = </span><span class="Special">%d</span><span class="Constant">)</span><span class="Special">\n</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; major_root);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L50" title="tools/build.c:50">die</a>(<span class="Constant">&quot;Bad root device --- major #&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (i=<span class="Constant">0</span>;i&lt;<span class="Statement">sizeof</span> <a href="../kernel/printk.c.html#L17" title="kernel/printk.c:17">buf</a>; i++) <a href="../kernel/printk.c.html#L17" title="kernel/printk.c:17">buf</a>[i]=<span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((id=<a href="../lib/open.c.html#L11" title="lib/open.c:11">open</a>(<a href="../init/main.c.html#L165" title="init/main.c:165">argv</a>[<span class="Constant">1</span>],<a href="../include/fcntl.h.html#L8" title="include/fcntl.h:8">O_RDONLY</a>,<span class="Constant">0</span>))&lt;<span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L50" title="tools/build.c:50">die</a>(<span class="Constant">&quot;Unable to <a href="../lib/open.c.html#L11" title="lib/open.c:11">open</a> 'boot'&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (read(id,<a href="../kernel/printk.c.html#L17" title="kernel/printk.c:17">buf</a>,<a href="#L36" title="tools/build.c:36">MINIX_HEADER</a>) != <a href="#L36" title="tools/build.c:36">MINIX_HEADER</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L50" title="tools/build.c:50">die</a>(<span class="Constant">&quot;Unable to read header of 'boot'&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (((<span class="Type">long</span> *) <a href="../kernel/printk.c.html#L17" title="kernel/printk.c:17">buf</a>)[<span class="Constant">0</span>]!=<span class="Constant">0x04100301</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L50" title="tools/build.c:50">die</a>(<span class="Constant">&quot;Non-Minix header of 'boot'&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (((<span class="Type">long</span> *) <a href="../kernel/printk.c.html#L17" title="kernel/printk.c:17">buf</a>)[<span class="Constant">1</span>]!=<a href="#L36" title="tools/build.c:36">MINIX_HEADER</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L50" title="tools/build.c:50">die</a>(<span class="Constant">&quot;Non-Minix header of 'boot'&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (((<span class="Type">long</span> *) <a href="../kernel/printk.c.html#L17" title="kernel/printk.c:17">buf</a>)[<span class="Constant">3</span>]!=<span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L50" title="tools/build.c:50">die</a>(<span class="Constant">&quot;Illegal data segment in 'boot'&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (((<span class="Type">long</span> *) <a href="../kernel/printk.c.html#L17" title="kernel/printk.c:17">buf</a>)[<span class="Constant">4</span>]!=<span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L50" title="tools/build.c:50">die</a>(<span class="Constant">&quot;Illegal bss in 'boot'&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (((<span class="Type">long</span> *) <a href="../kernel/printk.c.html#L17" title="kernel/printk.c:17">buf</a>)[<span class="Constant">5</span>] != <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L50" title="tools/build.c:50">die</a>(<span class="Constant">&quot;Non-Minix header of 'boot'&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (((<span class="Type">long</span> *) <a href="../kernel/printk.c.html#L17" title="kernel/printk.c:17">buf</a>)[<span class="Constant">7</span>] != <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L50" title="tools/build.c:50">die</a>(<span class="Constant">&quot;Illegal symbol table in 'boot'&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; i=read(id,<a href="../kernel/printk.c.html#L17" title="kernel/printk.c:17">buf</a>,<span class="Statement">sizeof</span> <a href="../kernel/printk.c.html#L17" title="kernel/printk.c:17">buf</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; fprintf(<span class="Constant">stderr</span>,<span class="Constant">&quot;Boot <a href="../kernel/blk_drv/floppy.c.html#L116" title="kernel/blk_drv/floppy.c:116">sector</a> </span><span class="Special">%d</span><span class="Constant"> bytes.</span><span class="Special">\n</span><span class="Constant">&quot;</span>,i);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (i != <span class="Constant">512</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L50" title="tools/build.c:50">die</a>(<span class="Constant">&quot;Boot block must be exactly 512 bytes&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((*(<span class="Type">unsigned</span> <span class="Type">short</span> *)(<a href="../kernel/printk.c.html#L17" title="kernel/printk.c:17">buf</a>+<span class="Constant">510</span>)) != <span class="Constant">0xAA55</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L50" title="tools/build.c:50">die</a>(<span class="Constant">&quot;Boot block hasn't got boot flag (0xAA55)&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../kernel/printk.c.html#L17" title="kernel/printk.c:17">buf</a>[<span class="Constant">508</span>] = (<span class="Type">char</span>) minor_root;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../kernel/printk.c.html#L17" title="kernel/printk.c:17">buf</a>[<span class="Constant">509</span>] = (<span class="Type">char</span>) major_root;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; i=write(<span class="Constant">1</span>,<a href="../kernel/printk.c.html#L17" title="kernel/printk.c:17">buf</a>,<span class="Constant">512</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (i!=<span class="Constant">512</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L50" title="tools/build.c:50">die</a>(<span class="Constant">&quot;Write call failed&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; close (id);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((id=<a href="../lib/open.c.html#L11" title="lib/open.c:11">open</a>(<a href="../init/main.c.html#L165" title="init/main.c:165">argv</a>[<span class="Constant">2</span>],<a href="../include/fcntl.h.html#L8" title="include/fcntl.h:8">O_RDONLY</a>,<span class="Constant">0</span>))&lt;<span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L50" title="tools/build.c:50">die</a>(<span class="Constant">&quot;Unable to <a href="../lib/open.c.html#L11" title="lib/open.c:11">open</a> 'setup'&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (read(id,<a href="../kernel/printk.c.html#L17" title="kernel/printk.c:17">buf</a>,<a href="#L36" title="tools/build.c:36">MINIX_HEADER</a>) != <a href="#L36" title="tools/build.c:36">MINIX_HEADER</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L50" title="tools/build.c:50">die</a>(<span class="Constant">&quot;Unable to read header of 'setup'&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (((<span class="Type">long</span> *) <a href="../kernel/printk.c.html#L17" title="kernel/printk.c:17">buf</a>)[<span class="Constant">0</span>]!=<span class="Constant">0x04100301</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L50" title="tools/build.c:50">die</a>(<span class="Constant">&quot;Non-Minix header of 'setup'&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (((<span class="Type">long</span> *) <a href="../kernel/printk.c.html#L17" title="kernel/printk.c:17">buf</a>)[<span class="Constant">1</span>]!=<a href="#L36" title="tools/build.c:36">MINIX_HEADER</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L50" title="tools/build.c:50">die</a>(<span class="Constant">&quot;Non-Minix header of 'setup'&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (((<span class="Type">long</span> *) <a href="../kernel/printk.c.html#L17" title="kernel/printk.c:17">buf</a>)[<span class="Constant">3</span>]!=<span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L50" title="tools/build.c:50">die</a>(<span class="Constant">&quot;Illegal data segment in 'setup'&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (((<span class="Type">long</span> *) <a href="../kernel/printk.c.html#L17" title="kernel/printk.c:17">buf</a>)[<span class="Constant">4</span>]!=<span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L50" title="tools/build.c:50">die</a>(<span class="Constant">&quot;Illegal bss in 'setup'&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (((<span class="Type">long</span> *) <a href="../kernel/printk.c.html#L17" title="kernel/printk.c:17">buf</a>)[<span class="Constant">5</span>] != <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L50" title="tools/build.c:50">die</a>(<span class="Constant">&quot;Non-Minix header of 'setup'&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (((<span class="Type">long</span> *) <a href="../kernel/printk.c.html#L17" title="kernel/printk.c:17">buf</a>)[<span class="Constant">7</span>] != <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L50" title="tools/build.c:50">die</a>(<span class="Constant">&quot;Illegal symbol table in 'setup'&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (i=<span class="Constant">0</span> ; (c=read(id,<a href="../kernel/printk.c.html#L17" title="kernel/printk.c:17">buf</a>,<span class="Statement">sizeof</span> <a href="../kernel/printk.c.html#L17" title="kernel/printk.c:17">buf</a>))&gt;<span class="Constant">0</span> ; i+=c )<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (write(<span class="Constant">1</span>,<a href="../kernel/printk.c.html#L17" title="kernel/printk.c:17">buf</a>,c)!=c)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L50" title="tools/build.c:50">die</a>(<span class="Constant">&quot;Write call failed&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; close (id);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (i &gt; <a href="#L46" title="tools/build.c:46">SETUP_SECTS</a>*<span class="Constant">512</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L50" title="tools/build.c:50">die</a>(<span class="Constant">&quot;Setup exceeds &quot;</span> <a href="#L48" title="tools/build.c:48">STRINGIFY</a>(<a href="#L46" title="tools/build.c:46">SETUP_SECTS</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot; sectors - rewrite build/boot/setup&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; fprintf(<span class="Constant">stderr</span>,<span class="Constant">&quot;Setup is </span><span class="Special">%d</span><span class="Constant"> bytes.</span><span class="Special">\n</span><span class="Constant">&quot;</span>,i);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (c=<span class="Constant">0</span> ; c&lt;<span class="Statement">sizeof</span>(<a href="../kernel/printk.c.html#L17" title="kernel/printk.c:17">buf</a>) ; c++)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../kernel/printk.c.html#L17" title="kernel/printk.c:17">buf</a>[c] = <span class="Special">'\0'</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">while</span> (i&lt;<a href="#L46" title="tools/build.c:46">SETUP_SECTS</a>*<span class="Constant">512</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c = <a href="#L46" title="tools/build.c:46">SETUP_SECTS</a>*<span class="Constant">512</span>-i;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (c &gt; <span class="Statement">sizeof</span>(<a href="../kernel/printk.c.html#L17" title="kernel/printk.c:17">buf</a>))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c = <span class="Statement">sizeof</span>(<a href="../kernel/printk.c.html#L17" title="kernel/printk.c:17">buf</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (write(<span class="Constant">1</span>,<a href="../kernel/printk.c.html#L17" title="kernel/printk.c:17">buf</a>,c) != c)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L50" title="tools/build.c:50">die</a>(<span class="Constant">&quot;Write call failed&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i += c;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((id=<a href="../lib/open.c.html#L11" title="lib/open.c:11">open</a>(<a href="../init/main.c.html#L165" title="init/main.c:165">argv</a>[<span class="Constant">3</span>],<a href="../include/fcntl.h.html#L8" title="include/fcntl.h:8">O_RDONLY</a>,<span class="Constant">0</span>))&lt;<span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L50" title="tools/build.c:50">die</a>(<span class="Constant">&quot;Unable to <a href="../lib/open.c.html#L11" title="lib/open.c:11">open</a> 'system'&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (read(id,<a href="../kernel/printk.c.html#L17" title="kernel/printk.c:17">buf</a>,<a href="#L37" title="tools/build.c:37">GCC_HEADER</a>) != <a href="#L37" title="tools/build.c:37">GCC_HEADER</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L50" title="tools/build.c:50">die</a>(<span class="Constant">&quot;Unable to read header of 'system'&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (((<span class="Type">long</span> *) <a href="../kernel/printk.c.html#L17" title="kernel/printk.c:17">buf</a>)[<span class="Constant">6</span>] != <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L50" title="tools/build.c:50">die</a>(<span class="Constant">&quot;Non-GCC header of 'system'&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (i=<span class="Constant">0</span> ; (c=read(id,<a href="../kernel/printk.c.html#L17" title="kernel/printk.c:17">buf</a>,<span class="Statement">sizeof</span> <a href="../kernel/printk.c.html#L17" title="kernel/printk.c:17">buf</a>))&gt;<span class="Constant">0</span> ; i+=c )<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (write(<span class="Constant">1</span>,<a href="../kernel/printk.c.html#L17" title="kernel/printk.c:17">buf</a>,c)!=c)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L50" title="tools/build.c:50">die</a>(<span class="Constant">&quot;Write call failed&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; close(id);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; fprintf(<span class="Constant">stderr</span>,<span class="Constant">&quot;System is </span><span class="Special">%d</span><span class="Constant"> bytes.</span><span class="Special">\n</span><span class="Constant">&quot;</span>,i);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (i &gt; <a href="#L39" title="tools/build.c:39">SYS_SIZE</a>*<span class="Constant">16</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L50" title="tools/build.c:50">die</a>(<span class="Constant">&quot;System is too big&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>(<span class="Constant">0</span>);<br/></li>
<li>}<br/></li>
</ol></code>
 </body>
</html>
