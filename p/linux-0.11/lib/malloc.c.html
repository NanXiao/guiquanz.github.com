<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>lib/malloc.c - linux-0.11-ebook</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

code {
    font-family: consolas, monospace;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
  <h3>lib/malloc.c - linux-0.11-ebook</h3>
   <a href="../index.html"> Table of Contents </a>
 <h4>Global variables defined</h4>
 <ul>
<li><a href="#L77">bucket_dir</a></li>
<li><a href="#L92">free_bucket_desc</a></li>
</ul>
 <h4>Data types defined</h4>
 <ul>
<li><a href="#L60">_bucket_dir</a></li>
<li><a href="#L52">bucket_desc</a></li>
</ul>
 <h4>Functions defined</h4>
 <ul>
<li><a href="#L183">free_s</a></li>
<li><a href="#L97">init_bucket_desc</a></li>
<li><a href="#L117">malloc</a></li>
</ul>
 <h4>Source code</h4>

  <code><ol><li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L117" title="lib/malloc.c:117">malloc</a>.c --- a general purpose kernel memory allocator for Linux.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Written by Theodore Ts'o (tytso@mit.edu), 11/29/91<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * This routine is written to be as fast as possible, so that it<br/></li>
<li></span><span class="Comment"> * can be called from the interrupt level.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Limitations: maximum size of memory we can allocate using this routine<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; is 4k, the size of a page in Linux.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * The general game plan is that each page (called a bucket) will only hold<br/></li>
<li></span><span class="Comment"> * objects of a given size.&nbsp; When all of the object on a page are released,<br/></li>
<li></span><span class="Comment"> * the page can be returned to the general <a href="../include/linux/kernel.h.html#L12" title="include/linux/kernel.h:12">free</a> pool.&nbsp; When <a href="#L117" title="lib/malloc.c:117">malloc</a>() is<br/></li>
<li></span><span class="Comment"> * called, it looks for the smallest bucket size which will fulfill its<br/></li>
<li></span><span class="Comment"> * <a href="../kernel/blk_drv/ll_rw_blk.c.html#L21" title="kernel/blk_drv/ll_rw_blk.c:21">request</a>, and allocate a piece of memory from that bucket pool.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Each bucket has as its control block a bucket descriptor which keeps<br/></li>
<li></span><span class="Comment"> * <a href="../kernel/blk_drv/floppy.c.html#L118" title="kernel/blk_drv/floppy.c:118">track</a> of how many objects are in use on that page, and the <a href="../include/linux/kernel.h.html#L12" title="include/linux/kernel.h:12">free</a> list<br/></li>
<li></span><span class="Comment"> * for that page.&nbsp; Like the buckets themselves, bucket descriptors are<br/></li>
<li></span><span class="Comment"> * stored on pages requested from <a href="../mm/memory.c.html#L63" title="mm/memory.c:63">get_free_page</a>().&nbsp; However, unlike buckets,<br/></li>
<li></span><span class="Comment"> * pages devoted to bucket descriptor pages are never released back to the<br/></li>
<li></span><span class="Comment"> * system.&nbsp; Fortunately, a system should probably only need 1 or 2 bucket<br/></li>
<li></span><span class="Comment"> * descriptor pages, since a page can hold 256 bucket descriptors (which<br/></li>
<li></span><span class="Comment"> * corresponds to 1 megabyte worth of bucket pages.)&nbsp; If the kernel is using<br/></li>
<li></span><span class="Comment"> * that much allocated memory, it's probably doing something wrong.&nbsp; :-)<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Note: <a href="#L117" title="lib/malloc.c:117">malloc</a>() and <a href="../include/linux/kernel.h.html#L12" title="include/linux/kernel.h:12">free</a>() both call <a href="../mm/memory.c.html#L63" title="mm/memory.c:63">get_free_page</a>() and <a href="../mm/memory.c.html#L89" title="mm/memory.c:89">free_page</a>()<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; in sections of code where interrupts are turned off, to allow<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L117" title="lib/malloc.c:117">malloc</a>() and <a href="../include/linux/kernel.h.html#L12" title="include/linux/kernel.h:12">free</a>() to be safely called from an interrupt routine.<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; (We will probably need this functionality when networking code,<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; particularily things like NFS, is added to Linux.)&nbsp; However, this<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; presumes that <a href="../mm/memory.c.html#L63" title="mm/memory.c:63">get_free_page</a>() and <a href="../mm/memory.c.html#L89" title="mm/memory.c:89">free_page</a>() are interrupt-level<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; safe, which they may not be once paging is added.&nbsp; If this is the<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; case, we will need to modify <a href="#L117" title="lib/malloc.c:117">malloc</a>() to keep a few unused pages<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; &quot;pre-allocated&quot; so that it can safely draw upon those pages if<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; it is called from an interrupt routine.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; Another concern is that <a href="../mm/memory.c.html#L63" title="mm/memory.c:63">get_free_page</a>() should not sleep; if it<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; does, the code is carefully ordered so as to avoid any race<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; conditions.&nbsp; The catch is that if <a href="#L117" title="lib/malloc.c:117">malloc</a>() is called re-entrantly,<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; there is a chance that unecessary pages will be grabbed from the<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; system.&nbsp; Except for the pages for the bucket descriptor page, the<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; extra pages will eventually get released back to the system, though,<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; so it isn't all that bad.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;linux/kernel.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;linux/mm.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;asm/system.h&gt;<br/></li>
<li></span><br/></li>
<li><a id="L52">&#x200c;</a><span class="Type">struct</span> <span class="linkable">bucket_desc</span> {&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* 16 bytes */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">void</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *page;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">struct</span> <a href="#L52" title="lib/malloc.c:52">bucket_desc</a>&nbsp; &nbsp; &nbsp; &nbsp; *next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">void</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *freeptr;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">unsigned</span> <span class="Type">short</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; refcnt;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">unsigned</span> <span class="Type">short</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bucket_size;<br/></li>
<li>};<br/></li>
<li><br/></li>
<li><a id="L60">&#x200c;</a><span class="Type">struct</span> <span class="linkable">_bucket_dir</span> {&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* 8 bytes */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; size;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">struct</span> <a href="#L52" title="lib/malloc.c:52">bucket_desc</a>&nbsp; &nbsp; &nbsp; &nbsp; *chain;<br/></li>
<li>};<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * The following is the where we store a pointer to the first bucket<br/></li>
<li></span><span class="Comment"> * descriptor for a given size.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * If it turns out that the Linux kernel allocates a lot of objects of a<br/></li>
<li></span><span class="Comment"> * specific size, then we may want to add that specific size to this list,<br/></li>
<li></span><span class="Comment"> * since that will allow the memory to be allocated more efficiently.<br/></li>
<li></span><span class="Comment"> * However, since an entire page must be dedicated to each specific size<br/></li>
<li></span><span class="Comment"> * on this list, some amount of temperance must be exercised here.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Note that this list *must* be kept in order.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li><a id="L77">&#x200c;</a></span><span class="Type">struct</span> <a href="#L60" title="lib/malloc.c:60">_bucket_dir</a> <span class="linkable">bucket_dir</span>[] = {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; { <span class="Constant">16</span>,&nbsp; &nbsp; &nbsp; &nbsp; (<span class="Type">struct</span> <a href="#L52" title="lib/malloc.c:52">bucket_desc</a> *) <span class="Constant">0</span>},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; { <span class="Constant">32</span>,&nbsp; &nbsp; &nbsp; &nbsp; (<span class="Type">struct</span> <a href="#L52" title="lib/malloc.c:52">bucket_desc</a> *) <span class="Constant">0</span>},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; { <span class="Constant">64</span>,&nbsp; &nbsp; &nbsp; &nbsp; (<span class="Type">struct</span> <a href="#L52" title="lib/malloc.c:52">bucket_desc</a> *) <span class="Constant">0</span>},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; { <span class="Constant">128</span>,&nbsp; &nbsp; &nbsp; &nbsp; (<span class="Type">struct</span> <a href="#L52" title="lib/malloc.c:52">bucket_desc</a> *) <span class="Constant">0</span>},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; { <span class="Constant">256</span>,&nbsp; &nbsp; &nbsp; &nbsp; (<span class="Type">struct</span> <a href="#L52" title="lib/malloc.c:52">bucket_desc</a> *) <span class="Constant">0</span>},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; { <span class="Constant">512</span>,&nbsp; &nbsp; &nbsp; &nbsp; (<span class="Type">struct</span> <a href="#L52" title="lib/malloc.c:52">bucket_desc</a> *) <span class="Constant">0</span>},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; { <span class="Constant">1024</span>,&nbsp; &nbsp; &nbsp; &nbsp; (<span class="Type">struct</span> <a href="#L52" title="lib/malloc.c:52">bucket_desc</a> *) <span class="Constant">0</span>},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; { <span class="Constant">2048</span>, (<span class="Type">struct</span> <a href="#L52" title="lib/malloc.c:52">bucket_desc</a> *) <span class="Constant">0</span>},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; { <span class="Constant">4096</span>, (<span class="Type">struct</span> <a href="#L52" title="lib/malloc.c:52">bucket_desc</a> *) <span class="Constant">0</span>},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; { <span class="Constant">0</span>,&nbsp; &nbsp; (<span class="Type">struct</span> <a href="#L52" title="lib/malloc.c:52">bucket_desc</a> *) <span class="Constant">0</span>}};&nbsp;&nbsp; <span class="Comment">/* End of list marker */<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * This contains a linked list of <a href="../include/linux/kernel.h.html#L12" title="include/linux/kernel.h:12">free</a> bucket descriptor blocks<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li><a id="L92">&#x200c;</a></span><span class="Type">struct</span> <a href="#L52" title="lib/malloc.c:52">bucket_desc</a> *<span class="linkable">free_bucket_desc</span> = (<span class="Type">struct</span> <a href="#L52" title="lib/malloc.c:52">bucket_desc</a> *) <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * This routine initializes a bucket description page.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li><a id="L97">&#x200c;</a></span><span class="Type">static</span> <span class="Type"><a href="string.c.html#L12" title="lib/string.c:12">inline</a></span> <span class="Type">void</span> <span class="linkable">init_bucket_desc</span>()<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">struct</span> <a href="#L52" title="lib/malloc.c:52">bucket_desc</a> *bdesc, *first;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; i;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; first = bdesc = (<span class="Type">struct</span> <a href="#L52" title="lib/malloc.c:52">bucket_desc</a> *) <a href="../mm/memory.c.html#L63" title="mm/memory.c:63">get_free_page</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!bdesc)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../kernel/panic.c.html#L16" title="kernel/panic.c:16">panic</a>(<span class="Constant">&quot;Out of memory in <a href="#L97" title="lib/malloc.c:97">init_bucket_desc</a>()&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (i = <a href="../include/linux/mm.h.html#L4" title="include/linux/mm.h:4">PAGE_SIZE</a>/<span class="Statement">sizeof</span>(<span class="Type">struct</span> <a href="#L52" title="lib/malloc.c:52">bucket_desc</a>); i &gt; <span class="Constant">1</span>; i--) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bdesc-&gt;next = bdesc+<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bdesc++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * This is done last, to avoid race conditions in case<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * <a href="../mm/memory.c.html#L63" title="mm/memory.c:63">get_free_page</a>() sleeps and this routine gets called again....<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; bdesc-&gt;next = <a href="#L92" title="lib/malloc.c:92">free_bucket_desc</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L92" title="lib/malloc.c:92">free_bucket_desc</a> = first;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L117">&#x200c;</a><span class="Type">void</span> *<span class="linkable">malloc</span>(<span class="Type">unsigned</span> <span class="Type">int</span> len)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">struct</span> <a href="#L60" title="lib/malloc.c:60">_bucket_dir</a>&nbsp; &nbsp; &nbsp; &nbsp; *bdir;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">struct</span> <a href="#L52" title="lib/malloc.c:52">bucket_desc</a>&nbsp; &nbsp; &nbsp; &nbsp; *bdesc;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">void</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *retval;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * First we search the <a href="#L77" title="lib/malloc.c:77">bucket_dir</a> to find the right bucket change<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * for this <a href="../kernel/blk_drv/ll_rw_blk.c.html#L21" title="kernel/blk_drv/ll_rw_blk.c:21">request</a>.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (bdir = <a href="#L77" title="lib/malloc.c:77">bucket_dir</a>; bdir-&gt;size; bdir++)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (bdir-&gt;size &gt;= len)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!bdir-&gt;size) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../kernel/printk.c.html#L21" title="kernel/printk.c:21">printk</a>(<span class="Constant">&quot;<a href="#L117" title="lib/malloc.c:117">malloc</a> called with impossibly large argument (</span><span class="Special">%d</span><span class="Constant">)</span><span class="Special">\n</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../kernel/panic.c.html#L16" title="kernel/panic.c:16">panic</a>(<span class="Constant">&quot;<a href="#L117" title="lib/malloc.c:117">malloc</a>: bad arg&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * Now we search for a bucket descriptor which has <a href="../include/linux/kernel.h.html#L12" title="include/linux/kernel.h:12">free</a> space<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../include/asm/system.h.html#L17" title="include/asm/system.h:17">cli</a>();&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Avoid race conditions */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (bdesc = bdir-&gt;chain; bdesc; bdesc = bdesc-&gt;next)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (bdesc-&gt;freeptr)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * If we didn't find a bucket with <a href="../include/linux/kernel.h.html#L12" title="include/linux/kernel.h:12">free</a> space, then we'll<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * allocate a new one.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!bdesc) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *cp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!<a href="#L92" title="lib/malloc.c:92">free_bucket_desc</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L97" title="lib/malloc.c:97">init_bucket_desc</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bdesc = <a href="#L92" title="lib/malloc.c:92">free_bucket_desc</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L92" title="lib/malloc.c:92">free_bucket_desc</a> = bdesc-&gt;next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bdesc-&gt;refcnt = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bdesc-&gt;bucket_size = bdir-&gt;size;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cp = (<span class="Type">char</span>*)<a href="../mm/memory.c.html#L63" title="mm/memory.c:63">get_free_page</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bdesc-&gt;page = bdesc-&gt;freeptr = (<span class="Type">void</span> *) cp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!cp)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../kernel/panic.c.html#L16" title="kernel/panic.c:16">panic</a>(<span class="Constant">&quot;Out of memory in kernel <a href="#L117" title="lib/malloc.c:117">malloc</a>()&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Set up the chain of <a href="../include/linux/kernel.h.html#L12" title="include/linux/kernel.h:12">free</a> objects */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (i=<a href="../include/linux/mm.h.html#L4" title="include/linux/mm.h:4">PAGE_SIZE</a>/bdir-&gt;size; i &gt; <span class="Constant">1</span>; i--) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *((<span class="Type">char</span> **) cp) = cp + bdir-&gt;size;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cp += bdir-&gt;size;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *((<span class="Type">char</span> **) cp) = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bdesc-&gt;next = bdir-&gt;chain; <span class="Comment">/* OK, link it in! */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bdir-&gt;chain = bdesc;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; retval = (<span class="Type">void</span> *) bdesc-&gt;freeptr;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; bdesc-&gt;freeptr = *((<span class="Type">void</span> **) retval);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; bdesc-&gt;refcnt++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../include/asm/system.h.html#L16" title="include/asm/system.h:16">sti</a>();&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* OK, we're safe again */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>(retval);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Here is the <a href="../include/linux/kernel.h.html#L12" title="include/linux/kernel.h:12">free</a> routine.&nbsp; If you know the size of the object that you<br/></li>
<li></span><span class="Comment"> * are freeing, then <a href="#L183" title="lib/malloc.c:183">free_s</a>() will use that information to speed up the<br/></li>
<li></span><span class="Comment"> * search for the bucket descriptor.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * We will #define a macro so that &quot;<a href="../include/linux/kernel.h.html#L12" title="include/linux/kernel.h:12">free</a>(<a href="../kernel/chr_drv/console.c.html#L72" title="kernel/chr_drv/console.c:72">x</a>)&quot; is becomes &quot;<a href="#L183" title="lib/malloc.c:183">free_s</a>(<a href="../kernel/chr_drv/console.c.html#L72" title="kernel/chr_drv/console.c:72">x</a>, 0)&quot;<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li><a id="L183">&#x200c;</a></span><span class="Type">void</span> <span class="linkable">free_s</span>(<span class="Type">void</span> *obj, <span class="Type">int</span> size)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">void</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *page;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">struct</span> <a href="#L60" title="lib/malloc.c:60">_bucket_dir</a>&nbsp; &nbsp; &nbsp; &nbsp; *bdir;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">struct</span> <a href="#L52" title="lib/malloc.c:52">bucket_desc</a>&nbsp; &nbsp; &nbsp; &nbsp; *bdesc, *prev;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Calculate what page this object lives in */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; page = (<span class="Type">void</span> *)&nbsp; ((<span class="Type">unsigned</span> <span class="Type">long</span>) obj &amp; <span class="Constant">0xfffff000</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Now search the buckets looking for that page */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (bdir = <a href="#L77" title="lib/malloc.c:77">bucket_dir</a>; bdir-&gt;size; bdir++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; prev = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* If size is zero then this conditional is always false */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (bdir-&gt;size &lt; size)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (bdesc = bdir-&gt;chain; bdesc; bdesc = bdesc-&gt;next) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (bdesc-&gt;page == page)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> found;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; prev = bdesc;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../kernel/panic.c.html#L16" title="kernel/panic.c:16">panic</a>(<span class="Constant">&quot;Bad address passed to kernel <a href="#L183" title="lib/malloc.c:183">free_s</a>()&quot;</span>);<br/></li>
<li><span class="Statement">found</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../include/asm/system.h.html#L17" title="include/asm/system.h:17">cli</a>(); <span class="Comment">/* To avoid race conditions */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; *((<span class="Type">void</span> **)obj) = bdesc-&gt;freeptr;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; bdesc-&gt;freeptr = obj;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; bdesc-&gt;refcnt--;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (bdesc-&gt;refcnt == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * We need to make sure that prev is still accurate.&nbsp; It<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * may not be, if someone rudely interrupted us....<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((prev &amp;&amp; (prev-&gt;next != bdesc)) ||<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (!prev &amp;&amp; (bdir-&gt;chain != bdesc)))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (prev = bdir-&gt;chain; prev; prev = prev-&gt;next)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (prev-&gt;next == bdesc)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (prev)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; prev-&gt;next = bdesc-&gt;next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (bdir-&gt;chain != bdesc)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../kernel/panic.c.html#L16" title="kernel/panic.c:16">panic</a>(<span class="Constant">&quot;<a href="#L117" title="lib/malloc.c:117">malloc</a> bucket chains corrupted&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bdir-&gt;chain = bdesc-&gt;next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../mm/memory.c.html#L89" title="mm/memory.c:89">free_page</a>((<span class="Type">unsigned</span> <span class="Type">long</span>) bdesc-&gt;page);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bdesc-&gt;next = <a href="#L92" title="lib/malloc.c:92">free_bucket_desc</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L92" title="lib/malloc.c:92">free_bucket_desc</a> = bdesc;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../include/asm/system.h.html#L16" title="include/asm/system.h:16">sti</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
</ol></code>
 </body>
</html>
