<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>fs/open.c - linux-0.11-ebook</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

code {
    font-family: consolas, monospace;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
  <h3>fs/open.c - linux-0.11-ebook</h3>
   <a href="../index.html"> Table of Contents </a>
 <h4>Functions defined</h4>
 <ul>
<li><a href="#L47">sys_access</a></li>
<li><a href="#L75">sys_chdir</a></li>
<li><a href="#L105">sys_chmod</a></li>
<li><a href="#L121">sys_chown</a></li>
<li><a href="#L90">sys_chroot</a></li>
<li><a href="#L192">sys_close</a></li>
<li><a href="#L187">sys_creat</a></li>
<li><a href="#L138">sys_open</a></li>
<li><a href="#L19">sys_ustat</a></li>
<li><a href="#L24">sys_utime</a></li>
</ul>
 <h4>Source code</h4>

  <code><ol><li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> *&nbsp; linux/fs/<a href="../lib/open.c.html#L11" title="lib/open.c:11">open</a>.c<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *&nbsp; (C) 1991&nbsp; Linus Torvalds<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;string.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;<a href="../lib/errno.c.html#L7" title="lib/errno.c:7">errno</a>.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;fcntl.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;sys/types.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;utime.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;sys/<a href="../include/sys/stat.h.html#L6" title="include/sys/stat.h:6">stat</a>.h&gt;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;linux/sched.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;linux/tty.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;linux/kernel.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;asm/segment.h&gt;<br/></li>
<li></span><br/></li>
<li><a id="L19">&#x200c;</a><span class="Type">int</span> <span class="linkable">sys_ustat</span>(<span class="Type">int</span> dev, <span class="Type">struct</span> <a href="../include/sys/types.h.html#L39" title="include/sys/types.h:39">ustat</a> * ubuf)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant"><a href="../include/errno.h.html#L57" title="include/errno.h:57">ENOSYS</a></span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L24">&#x200c;</a><span class="Type">int</span> <span class="linkable">sys_utime</span>(<span class="Type">char</span> * filename, <span class="Type">struct</span> <a href="../include/utime.h.html#L6" title="include/utime.h:6">utimbuf</a> * times)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">struct</span> <a href="../include/linux/fs.h.html#L93" title="include/linux/fs.h:93">m_inode</a> * inode;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">long</span> actime,modtime;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!(inode=<a href="namei.c.html#L303" title="fs/namei.c:303">namei</a>(filename)))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant"><a href="../include/errno.h.html#L21" title="include/errno.h:21">ENOENT</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (times) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; actime = <a href="../include/asm/segment.h.html#L17" title="include/asm/segment.h:17">get_fs_long</a>((<span class="Type">unsigned</span> <span class="Type">long</span> *) &amp;times-&gt;actime);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; modtime = <a href="../include/asm/segment.h.html#L17" title="include/asm/segment.h:17">get_fs_long</a>((<span class="Type">unsigned</span> <span class="Type">long</span> *) &amp;times-&gt;modtime);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; actime = modtime = <a href="../include/linux/sched.h.html#L142" title="include/linux/sched.h:142">CURRENT_TIME</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; inode-&gt;i_atime = actime;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; inode-&gt;i_mtime = modtime;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; inode-&gt;i_dirt = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(inode);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * </span><span class="Todo">XXX</span><span class="Comment"> should we use the real or effective uid?&nbsp; BSD uses the real uid,<br/></li>
<li></span><span class="Comment"> * so as to make this call useful to setuid programs.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li><a id="L47">&#x200c;</a></span><span class="Type">int</span> <span class="linkable">sys_access</span>(<span class="Type">const</span> <span class="Type">char</span> * filename,<span class="Type">int</span> mode)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">struct</span> <a href="../include/linux/fs.h.html#L93" title="include/linux/fs.h:93">m_inode</a> * inode;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> res, i_mode;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; mode &amp;= <span class="PreProc">0</span><span class="Constant">007</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!(inode=<a href="namei.c.html#L303" title="fs/namei.c:303">namei</a>(filename)))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant"><a href="../include/errno.h.html#L32" title="include/errno.h:32">EACCES</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; i_mode = res = inode-&gt;i_mode &amp; <span class="PreProc">0</span><span class="Constant">777</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(inode);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../kernel/sched.c.html#L62" title="kernel/sched.c:62">current</a>-&gt;uid == inode-&gt;i_uid)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; res &gt;&gt;= <span class="Constant">6</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (<a href="../kernel/sched.c.html#L62" title="kernel/sched.c:62">current</a>-&gt;gid == inode-&gt;i_gid)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; res &gt;&gt;= <span class="Constant">6</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((res &amp; <span class="PreProc">0</span><span class="Constant">007</span> &amp; mode) == mode)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * </span><span class="Todo">XXX</span><span class="Comment"> we are doing this test last because we really should be<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * swapping the effective with the real user id (temporarily),<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * and then calling <a href="../include/linux/kernel.h.html#L21" title="include/linux/kernel.h:21">suser</a>() routine.&nbsp; If we do call the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * <a href="../include/linux/kernel.h.html#L21" title="include/linux/kernel.h:21">suser</a>() routine, it needs to be called last.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((!<a href="../kernel/sched.c.html#L62" title="kernel/sched.c:62">current</a>-&gt;uid) &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (!(mode &amp; <span class="Constant">1</span>) || (i_mode &amp; <span class="PreProc">0</span><span class="Constant">111</span>)))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant"><a href="../include/errno.h.html#L32" title="include/errno.h:32">EACCES</a></span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L75">&#x200c;</a><span class="Type">int</span> <span class="linkable">sys_chdir</span>(<span class="Type">const</span> <span class="Type">char</span> * filename)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">struct</span> <a href="../include/linux/fs.h.html#L93" title="include/linux/fs.h:93">m_inode</a> * inode;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!(inode = <a href="namei.c.html#L303" title="fs/namei.c:303">namei</a>(filename)))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant"><a href="../include/errno.h.html#L21" title="include/errno.h:21">ENOENT</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!<a href="../include/sys/stat.h.html#L31" title="include/sys/stat.h:31">S_ISDIR</a>(inode-&gt;i_mode)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(inode);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant"><a href="../include/errno.h.html#L39" title="include/errno.h:39">ENOTDIR</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(<a href="../kernel/sched.c.html#L62" title="kernel/sched.c:62">current</a>-&gt;pwd);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../kernel/sched.c.html#L62" title="kernel/sched.c:62">current</a>-&gt;pwd = inode;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> (<span class="Constant">0</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L90">&#x200c;</a><span class="Type">int</span> <span class="linkable">sys_chroot</span>(<span class="Type">const</span> <span class="Type">char</span> * filename)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">struct</span> <a href="../include/linux/fs.h.html#L93" title="include/linux/fs.h:93">m_inode</a> * inode;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!(inode=<a href="namei.c.html#L303" title="fs/namei.c:303">namei</a>(filename)))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant"><a href="../include/errno.h.html#L21" title="include/errno.h:21">ENOENT</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!<a href="../include/sys/stat.h.html#L31" title="include/sys/stat.h:31">S_ISDIR</a>(inode-&gt;i_mode)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(inode);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant"><a href="../include/errno.h.html#L39" title="include/errno.h:39">ENOTDIR</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(<a href="../kernel/sched.c.html#L62" title="kernel/sched.c:62">current</a>-&gt;root);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../kernel/sched.c.html#L62" title="kernel/sched.c:62">current</a>-&gt;root = inode;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> (<span class="Constant">0</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L105">&#x200c;</a><span class="Type">int</span> <span class="linkable">sys_chmod</span>(<span class="Type">const</span> <span class="Type">char</span> * filename,<span class="Type">int</span> mode)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">struct</span> <a href="../include/linux/fs.h.html#L93" title="include/linux/fs.h:93">m_inode</a> * inode;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!(inode=<a href="namei.c.html#L303" title="fs/namei.c:303">namei</a>(filename)))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant"><a href="../include/errno.h.html#L21" title="include/errno.h:21">ENOENT</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((<a href="../kernel/sched.c.html#L62" title="kernel/sched.c:62">current</a>-&gt;euid != inode-&gt;i_uid) &amp;&amp; !<a href="../include/linux/kernel.h.html#L21" title="include/linux/kernel.h:21">suser</a>()) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(inode);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant"><a href="../include/errno.h.html#L32" title="include/errno.h:32">EACCES</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; inode-&gt;i_mode = (mode &amp; <span class="PreProc">0</span><span class="Constant">7777</span>) | (inode-&gt;i_mode &amp; ~<span class="PreProc">0</span><span class="Constant">7777</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; inode-&gt;i_dirt = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(inode);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L121">&#x200c;</a><span class="Type">int</span> <span class="linkable">sys_chown</span>(<span class="Type">const</span> <span class="Type">char</span> * filename,<span class="Type">int</span> uid,<span class="Type">int</span> gid)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">struct</span> <a href="../include/linux/fs.h.html#L93" title="include/linux/fs.h:93">m_inode</a> * inode;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!(inode=<a href="namei.c.html#L303" title="fs/namei.c:303">namei</a>(filename)))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant"><a href="../include/errno.h.html#L21" title="include/errno.h:21">ENOENT</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!<a href="../include/linux/kernel.h.html#L21" title="include/linux/kernel.h:21">suser</a>()) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(inode);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant"><a href="../include/errno.h.html#L32" title="include/errno.h:32">EACCES</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; inode-&gt;i_uid=uid;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; inode-&gt;i_gid=gid;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; inode-&gt;i_dirt=<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(inode);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L138">&#x200c;</a><span class="Type">int</span> <span class="linkable">sys_open</span>(<span class="Type">const</span> <span class="Type">char</span> * filename,<span class="Type">int</span> flag,<span class="Type">int</span> mode)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">struct</span> <a href="../include/linux/fs.h.html#L93" title="include/linux/fs.h:93">m_inode</a> * inode;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">struct</span> <a href="../include/linux/fs.h.html#L116" title="include/linux/fs.h:116">file</a> * f;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> i,fd;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; mode &amp;= <span class="PreProc">0</span><span class="Constant">777</span> &amp; ~<a href="../kernel/sched.c.html#L62" title="kernel/sched.c:62">current</a>-&gt;umask;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span>(fd=<span class="Constant">0</span> ; fd&lt;<a href="../include/linux/fs.h.html#L43" title="include/linux/fs.h:43">NR_OPEN</a> ; fd++)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!<a href="../kernel/sched.c.html#L62" title="kernel/sched.c:62">current</a>-&gt;filp[fd])<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (fd&gt;=<a href="../include/linux/fs.h.html#L43" title="include/linux/fs.h:43">NR_OPEN</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant"><a href="../include/errno.h.html#L41" title="include/errno.h:41">EINVAL</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../kernel/sched.c.html#L62" title="kernel/sched.c:62">current</a>-&gt;close_on_exec &amp;= ~(<span class="Constant">1</span>&lt;&lt;fd);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; f=<span class="Constant">0</span>+<a href="file_table.c.html#L9" title="fs/file_table.c:9">file_table</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (i=<span class="Constant">0</span> ; i&lt;<a href="../include/linux/fs.h.html#L45" title="include/linux/fs.h:45">NR_FILE</a> ; i++,f++)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!f-&gt;f_count) <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (i&gt;=<a href="../include/linux/fs.h.html#L45" title="include/linux/fs.h:45">NR_FILE</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant"><a href="../include/errno.h.html#L41" title="include/errno.h:41">EINVAL</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; (<a href="../kernel/sched.c.html#L62" title="kernel/sched.c:62">current</a>-&gt;filp[fd]=f)-&gt;f_count++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((i=<a href="namei.c.html#L337" title="fs/namei.c:337">open_namei</a>(filename,flag,mode,&amp;inode))&lt;<span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../kernel/sched.c.html#L62" title="kernel/sched.c:62">current</a>-&gt;filp[fd]=<span class="Constant"><a href="../include/linux/sched.h.html#L26" title="include/linux/sched.h:26">NULL</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; f-&gt;f_count=<span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> i;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><span class="Comment">/* ttys are somewhat special (ttyxx major==4, tty major==5) */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../include/sys/stat.h.html#L32" title="include/sys/stat.h:32">S_ISCHR</a>(inode-&gt;i_mode))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../include/linux/fs.h.html#L33" title="include/linux/fs.h:33">MAJOR</a>(inode-&gt;i_zone[<span class="Constant">0</span>])==<span class="Constant">4</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../kernel/sched.c.html#L62" title="kernel/sched.c:62">current</a>-&gt;leader &amp;&amp; <a href="../kernel/sched.c.html#L62" title="kernel/sched.c:62">current</a>-&gt;tty&lt;<span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../kernel/sched.c.html#L62" title="kernel/sched.c:62">current</a>-&gt;tty = <a href="../include/linux/fs.h.html#L34" title="include/linux/fs.h:34">MINOR</a>(inode-&gt;i_zone[<span class="Constant">0</span>]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../kernel/chr_drv/tty_io.c.html#L51" title="kernel/chr_drv/tty_io.c:51">tty_table</a>[<a href="../kernel/sched.c.html#L62" title="kernel/sched.c:62">current</a>-&gt;tty].pgrp = <a href="../kernel/sched.c.html#L62" title="kernel/sched.c:62">current</a>-&gt;pgrp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (<a href="../include/linux/fs.h.html#L33" title="include/linux/fs.h:33">MAJOR</a>(inode-&gt;i_zone[<span class="Constant">0</span>])==<span class="Constant">5</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../kernel/sched.c.html#L62" title="kernel/sched.c:62">current</a>-&gt;tty&lt;<span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(inode);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../kernel/sched.c.html#L62" title="kernel/sched.c:62">current</a>-&gt;filp[fd]=<span class="Constant"><a href="../include/linux/sched.h.html#L26" title="include/linux/sched.h:26">NULL</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; f-&gt;f_count=<span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant"><a href="../include/errno.h.html#L20" title="include/errno.h:20">EPERM</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><span class="Comment">/* Likewise with block-devices: check for <a href="../kernel/blk_drv/floppy.c.html#L139" title="kernel/blk_drv/floppy.c:139">floppy_change</a> */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../include/sys/stat.h.html#L33" title="include/sys/stat.h:33">S_ISBLK</a>(inode-&gt;i_mode))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="buffer.c.html#L113" title="fs/buffer.c:113">check_disk_change</a>(inode-&gt;i_zone[<span class="Constant">0</span>]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; f-&gt;f_mode = inode-&gt;i_mode;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; f-&gt;f_flags = flag;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; f-&gt;f_count = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; f-&gt;f_inode = inode;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; f-&gt;f_pos = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> (fd);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L187">&#x200c;</a><span class="Type">int</span> <span class="linkable">sys_creat</span>(<span class="Type">const</span> <span class="Type">char</span> * pathname, <span class="Type">int</span> mode)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L138" title="fs/open.c:138">sys_open</a>(pathname, <a href="../include/fcntl.h.html#L11" title="include/fcntl.h:11">O_CREAT</a> | <a href="../include/fcntl.h.html#L14" title="include/fcntl.h:14">O_TRUNC</a>, mode);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L192">&#x200c;</a><span class="Type">int</span> <span class="linkable">sys_close</span>(<span class="Type">unsigned</span> <span class="Type">int</span> fd)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">struct</span> <a href="../include/linux/fs.h.html#L116" title="include/linux/fs.h:116">file</a> * filp;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (fd &gt;= <a href="../include/linux/fs.h.html#L43" title="include/linux/fs.h:43">NR_OPEN</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant"><a href="../include/errno.h.html#L41" title="include/errno.h:41">EINVAL</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../kernel/sched.c.html#L62" title="kernel/sched.c:62">current</a>-&gt;close_on_exec &amp;= ~(<span class="Constant">1</span>&lt;&lt;fd);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!(filp = <a href="../kernel/sched.c.html#L62" title="kernel/sched.c:62">current</a>-&gt;filp[fd]))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant"><a href="../include/errno.h.html#L41" title="include/errno.h:41">EINVAL</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../kernel/sched.c.html#L62" title="kernel/sched.c:62">current</a>-&gt;filp[fd] = <span class="Constant"><a href="../include/linux/sched.h.html#L26" title="include/linux/sched.h:26">NULL</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (filp-&gt;f_count == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../kernel/panic.c.html#L16" title="kernel/panic.c:16">panic</a>(<span class="Constant">&quot;Close: <a href="../include/linux/fs.h.html#L116" title="include/linux/fs.h:116">file</a> <a href="exec.c.html#L75" title="fs/exec.c:75">count</a> is 0&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (--filp-&gt;f_count)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> (<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(filp-&gt;f_inode);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> (<span class="Constant">0</span>);<br/></li>
<li>}<br/></li>
</ol></code>
 </body>
</html>
