<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>fs/buffer.c - linux-0.11-ebook</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

code {
    font-family: consolas, monospace;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
  <h3>fs/buffer.c - linux-0.11-ebook</h3>
   <a href="../index.html"> Table of Contents </a>
 <h4>Global variables defined</h4>
 <ul>
<li><a href="#L34">NR_BUFFERS</a></li>
<li><a href="#L33">buffer_wait</a></li>
<li><a href="#L32">free_list</a></li>
<li><a href="#L31">hash_table</a></li>
<li><a href="#L30">start_buffer</a></li>
</ul>
 <h4>Functions defined</h4>
 <ul>
<li><a href="#L267">bread</a></li>
<li><a href="#L296">bread_page</a></li>
<li><a href="#L322">breada</a></li>
<li><a href="#L253">brelse</a></li>
<li><a href="#L348">buffer_init</a></li>
<li><a href="#L113">check_disk_change</a></li>
<li><a href="#L166">find_buffer</a></li>
<li><a href="#L183">get_hash_table</a></li>
<li><a href="#L206">getblk</a></li>
<li><a href="#L149">insert_into_queues</a></li>
<li><a href="#L84">invalidate_buffers</a></li>
<li><a href="#L131">remove_from_queues</a></li>
<li><a href="#L59">sync_dev</a></li>
<li><a href="#L44">sys_sync</a></li>
<li><a href="#L36">wait_on_buffer</a></li>
</ul>
 <h4>Macros defined</h4>
 <ul>
<li><a href="#L205">BADNESS</a></li>
<li><a href="#L283">COPYBLK</a></li>
<li><a href="#L128">_hashfn</a></li>
<li><a href="#L129">hash</a></li>
</ul>
 <h4>Source code</h4>

  <code><ol><li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> *&nbsp; linux/fs/buffer.c<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *&nbsp; (C) 1991&nbsp; Linus Torvalds<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> *&nbsp; 'buffer.c' implements the buffer-cache functions. Race-conditions have<br/></li>
<li></span><span class="Comment"> * been avoided by NEVER letting a interrupt change a buffer (except for the<br/></li>
<li></span><span class="Comment"> * data, of course), but instead letting the caller do it. NOTE! As interrupts<br/></li>
<li></span><span class="Comment"> * can wake up a caller, some <a href="../include/asm/system.h.html#L17" title="include/asm/system.h:17">cli</a>-<a href="../include/asm/system.h.html#L16" title="include/asm/system.h:16">sti</a> sequences are needed to check for<br/></li>
<li></span><span class="Comment"> * sleep-on-calls. These should be extremely quick, though (I hope).<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * NOTE! There is one discordant note here: checking floppies for<br/></li>
<li></span><span class="Comment"> * disk change. This is where it fits best, I think, as it should<br/></li>
<li></span><span class="Comment"> * <a href="../mm/memory.c.html#L39" title="mm/memory.c:39">invalidate</a> changed <a href="../kernel/blk_drv/floppy.c.html#L114" title="kernel/blk_drv/floppy.c:114">floppy</a>-disk-caches.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;stdarg.h&gt;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;linux/config.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;linux/sched.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;linux/kernel.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;asm/system.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;asm/io.h&gt;<br/></li>
<li></span><br/></li>
<li><span class="Type"><a href="../lib/string.c.html#L11" title="lib/string.c:11">extern</a></span> <span class="Type">int</span> end;<br/></li>
<li><a id="L30">&#x200c;</a><span class="Type">struct</span> <a href="../include/linux/fs.h.html#L68" title="include/linux/fs.h:68">buffer_head</a> * <span class="linkable">start_buffer</span> = (<span class="Type">struct</span> <a href="../include/linux/fs.h.html#L68" title="include/linux/fs.h:68">buffer_head</a> *) &amp;end;<br/></li>
<li><a id="L31">&#x200c;</a><span class="Type">struct</span> <a href="../include/linux/fs.h.html#L68" title="include/linux/fs.h:68">buffer_head</a> * <span class="linkable">hash_table</span>[<a href="../include/linux/fs.h.html#L47" title="include/linux/fs.h:47">NR_HASH</a>];<br/></li>
<li><a id="L32">&#x200c;</a><span class="Type">static</span> <span class="Type">struct</span> <a href="../include/linux/fs.h.html#L68" title="include/linux/fs.h:68">buffer_head</a> * <span class="linkable">free_list</span>;<br/></li>
<li><a id="L33">&#x200c;</a><span class="Type">static</span> <span class="Type">struct</span> <a href="../include/linux/sched.h.html#L78" title="include/linux/sched.h:78">task_struct</a> * <span class="linkable">buffer_wait</span> = <span class="Constant"><a href="../include/linux/sched.h.html#L26" title="include/linux/sched.h:26">NULL</a></span>;<br/></li>
<li><a id="L34">&#x200c;</a><span class="Type">int</span> <span class="linkable">NR_BUFFERS</span> = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li><a id="L36">&#x200c;</a><span class="Type">static</span> <span class="Type"><a href="../lib/string.c.html#L12" title="lib/string.c:12">inline</a></span> <span class="Type">void</span> <span class="linkable">wait_on_buffer</span>(<span class="Type">struct</span> <a href="../include/linux/fs.h.html#L68" title="include/linux/fs.h:68">buffer_head</a> * bh)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../include/asm/system.h.html#L17" title="include/asm/system.h:17">cli</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">while</span> (bh-&gt;b_lock)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../kernel/sched.c.html#L151" title="kernel/sched.c:151">sleep_on</a>(&amp;bh-&gt;b_wait);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../include/asm/system.h.html#L16" title="include/asm/system.h:16">sti</a>();<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L44">&#x200c;</a><span class="Type">int</span> <span class="linkable">sys_sync</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> i;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">struct</span> <a href="../include/linux/fs.h.html#L68" title="include/linux/fs.h:68">buffer_head</a> * bh;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L59" title="fs/inode.c:59">sync_inodes</a>();&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* write out inodes into buffers */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; bh = <a href="#L30" title="fs/buffer.c:30">start_buffer</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (i=<span class="Constant">0</span> ; i&lt;<a href="../include/linux/fs.h.html#L48" title="include/linux/fs.h:48">NR_BUFFERS</a> ; i++,bh++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L36" title="fs/buffer.c:36">wait_on_buffer</a>(bh);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (bh-&gt;b_dirt)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../kernel/blk_drv/ll_rw_blk.c.html#L145" title="kernel/blk_drv/ll_rw_blk.c:145">ll_rw_block</a>(<a href="../include/linux/fs.h.html#L27" title="include/linux/fs.h:27">WRITE</a>,bh);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L59">&#x200c;</a><span class="Type">int</span> <span class="linkable">sync_dev</span>(<span class="Type">int</span> dev)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> i;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">struct</span> <a href="../include/linux/fs.h.html#L68" title="include/linux/fs.h:68">buffer_head</a> * bh;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; bh = <a href="#L30" title="fs/buffer.c:30">start_buffer</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (i=<span class="Constant">0</span> ; i&lt;<a href="../include/linux/fs.h.html#L48" title="include/linux/fs.h:48">NR_BUFFERS</a> ; i++,bh++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (bh-&gt;b_dev != dev)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L36" title="fs/buffer.c:36">wait_on_buffer</a>(bh);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (bh-&gt;b_dev == dev &amp;&amp; bh-&gt;b_dirt)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../kernel/blk_drv/ll_rw_blk.c.html#L145" title="kernel/blk_drv/ll_rw_blk.c:145">ll_rw_block</a>(<a href="../include/linux/fs.h.html#L27" title="include/linux/fs.h:27">WRITE</a>,bh);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L59" title="fs/inode.c:59">sync_inodes</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; bh = <a href="#L30" title="fs/buffer.c:30">start_buffer</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (i=<span class="Constant">0</span> ; i&lt;<a href="../include/linux/fs.h.html#L48" title="include/linux/fs.h:48">NR_BUFFERS</a> ; i++,bh++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (bh-&gt;b_dev != dev)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L36" title="fs/buffer.c:36">wait_on_buffer</a>(bh);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (bh-&gt;b_dev == dev &amp;&amp; bh-&gt;b_dirt)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../kernel/blk_drv/ll_rw_blk.c.html#L145" title="kernel/blk_drv/ll_rw_blk.c:145">ll_rw_block</a>(<a href="../include/linux/fs.h.html#L27" title="include/linux/fs.h:27">WRITE</a>,bh);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L84">&#x200c;</a><span class="Type">void</span> <span class="Type"><a href="../lib/string.c.html#L12" title="lib/string.c:12">inline</a></span> <span class="linkable">invalidate_buffers</span>(<span class="Type">int</span> dev)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> i;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">struct</span> <a href="../include/linux/fs.h.html#L68" title="include/linux/fs.h:68">buffer_head</a> * bh;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; bh = <a href="#L30" title="fs/buffer.c:30">start_buffer</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (i=<span class="Constant">0</span> ; i&lt;<a href="../include/linux/fs.h.html#L48" title="include/linux/fs.h:48">NR_BUFFERS</a> ; i++,bh++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (bh-&gt;b_dev != dev)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L36" title="fs/buffer.c:36">wait_on_buffer</a>(bh);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (bh-&gt;b_dev == dev)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bh-&gt;b_uptodate = bh-&gt;b_dirt = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * This routine checks whether a <a href="../kernel/blk_drv/floppy.c.html#L114" title="kernel/blk_drv/floppy.c:114">floppy</a> has been changed, and<br/></li>
<li></span><span class="Comment"> * invalidates all buffer-cache-entries in that case. This<br/></li>
<li></span><span class="Comment"> * is a relatively slow routine, so we have to try to minimize using<br/></li>
<li></span><span class="Comment"> * it. Thus it is called only upon a 'mount' or '<a href="../lib/open.c.html#L11" title="lib/open.c:11">open</a>'. This<br/></li>
<li></span><span class="Comment"> * is the best way of combining speed and utility, I think.<br/></li>
<li></span><span class="Comment"> * People changing diskettes in the middle of an operation deserve<br/></li>
<li></span><span class="Comment"> * to loose :-)<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * NOTE! Although currently this is only for floppies, the idea is<br/></li>
<li></span><span class="Comment"> * that any additional removable block-device will use this routine,<br/></li>
<li></span><span class="Comment"> * and that mount/<a href="../lib/open.c.html#L11" title="lib/open.c:11">open</a> needn't know that floppies/whatever are<br/></li>
<li></span><span class="Comment"> * special.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li><a id="L113">&#x200c;</a></span><span class="Type">void</span> <span class="linkable">check_disk_change</span>(<span class="Type">int</span> dev)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> i;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../include/linux/fs.h.html#L33" title="include/linux/fs.h:33">MAJOR</a>(dev) != <span class="Constant">2</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!<a href="../kernel/blk_drv/floppy.c.html#L139" title="kernel/blk_drv/floppy.c:139">floppy_change</a>(dev &amp; <span class="Constant">0x03</span>))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (i=<span class="Constant">0</span> ; i&lt;<a href="../include/linux/fs.h.html#L46" title="include/linux/fs.h:46">NR_SUPER</a> ; i++)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../include/linux/fs.h.html#L124" title="include/linux/fs.h:124">super_block</a>[i].s_dev == dev)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="super.c.html#L74" title="fs/super.c:74">put_super</a>(<a href="../include/linux/fs.h.html#L124" title="include/linux/fs.h:124">super_block</a>[i].s_dev);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L43" title="fs/inode.c:43">invalidate_inodes</a>(dev);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L84" title="fs/buffer.c:84">invalidate_buffers</a>(dev);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L128">&#x200c;</a><span class="PreProc">#define <span class="linkable">_hashfn</span>(dev,block) (((</span><span class="Type">unsigned</span><span class="PreProc">)(dev^block))%<a href="../include/linux/fs.h.html#L47" title="include/linux/fs.h:47">NR_HASH</a>)<br/></li>
<li><a id="L129">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">hash</span>(dev,block) <a href="#L31" title="fs/buffer.c:31">hash_table</a>[<a href="#L128" title="fs/buffer.c:128">_hashfn</a>(dev,block)]<br/></li>
<li></span><br/></li>
<li><a id="L131">&#x200c;</a><span class="Type">static</span> <span class="Type"><a href="../lib/string.c.html#L12" title="lib/string.c:12">inline</a></span> <span class="Type">void</span> <span class="linkable">remove_from_queues</span>(<span class="Type">struct</span> <a href="../include/linux/fs.h.html#L68" title="include/linux/fs.h:68">buffer_head</a> * bh)<br/></li>
<li>{<br/></li>
<li><span class="Comment">/* remove from <a href="#L129" title="fs/buffer.c:129">hash</a>-queue */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (bh-&gt;b_next)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bh-&gt;b_next-&gt;b_prev = bh-&gt;b_prev;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (bh-&gt;b_prev)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bh-&gt;b_prev-&gt;b_next = bh-&gt;b_next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L129" title="fs/buffer.c:129">hash</a>(bh-&gt;b_dev,bh-&gt;b_blocknr) == bh)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L129" title="fs/buffer.c:129">hash</a>(bh-&gt;b_dev,bh-&gt;b_blocknr) = bh-&gt;b_next;<br/></li>
<li><span class="Comment">/* remove from <a href="../include/linux/kernel.h.html#L12" title="include/linux/kernel.h:12">free</a> list */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!(bh-&gt;b_prev_free) || !(bh-&gt;b_next_free))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../kernel/panic.c.html#L16" title="kernel/panic.c:16">panic</a>(<span class="Constant">&quot;Free block list corrupted&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; bh-&gt;b_prev_free-&gt;b_next_free = bh-&gt;b_next_free;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; bh-&gt;b_next_free-&gt;b_prev_free = bh-&gt;b_prev_free;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L32" title="fs/buffer.c:32">free_list</a> == bh)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L32" title="fs/buffer.c:32">free_list</a> = bh-&gt;b_next_free;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L149">&#x200c;</a><span class="Type">static</span> <span class="Type"><a href="../lib/string.c.html#L12" title="lib/string.c:12">inline</a></span> <span class="Type">void</span> <span class="linkable">insert_into_queues</span>(<span class="Type">struct</span> <a href="../include/linux/fs.h.html#L68" title="include/linux/fs.h:68">buffer_head</a> * bh)<br/></li>
<li>{<br/></li>
<li><span class="Comment">/* put at end of <a href="../include/linux/kernel.h.html#L12" title="include/linux/kernel.h:12">free</a> list */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; bh-&gt;b_next_free = <a href="#L32" title="fs/buffer.c:32">free_list</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; bh-&gt;b_prev_free = <a href="#L32" title="fs/buffer.c:32">free_list</a>-&gt;b_prev_free;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L32" title="fs/buffer.c:32">free_list</a>-&gt;b_prev_free-&gt;b_next_free = bh;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L32" title="fs/buffer.c:32">free_list</a>-&gt;b_prev_free = bh;<br/></li>
<li><span class="Comment">/* put the buffer in new <a href="#L129" title="fs/buffer.c:129">hash</a>-queue if it has a device */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; bh-&gt;b_prev = <span class="Constant"><a href="../include/linux/sched.h.html#L26" title="include/linux/sched.h:26">NULL</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; bh-&gt;b_next = <span class="Constant"><a href="../include/linux/sched.h.html#L26" title="include/linux/sched.h:26">NULL</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!bh-&gt;b_dev)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; bh-&gt;b_next = <a href="#L129" title="fs/buffer.c:129">hash</a>(bh-&gt;b_dev,bh-&gt;b_blocknr);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L129" title="fs/buffer.c:129">hash</a>(bh-&gt;b_dev,bh-&gt;b_blocknr) = bh;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; bh-&gt;b_next-&gt;b_prev = bh;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L166">&#x200c;</a><span class="Type">static</span> <span class="Type">struct</span> <a href="../include/linux/fs.h.html#L68" title="include/linux/fs.h:68">buffer_head</a> * <span class="linkable">find_buffer</span>(<span class="Type">int</span> dev, <span class="Type">int</span> block)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">struct</span> <a href="../include/linux/fs.h.html#L68" title="include/linux/fs.h:68">buffer_head</a> * tmp;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (tmp = <a href="#L129" title="fs/buffer.c:129">hash</a>(dev,block) ; tmp != <span class="Constant"><a href="../include/linux/sched.h.html#L26" title="include/linux/sched.h:26">NULL</a></span> ; tmp = tmp-&gt;b_next)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (tmp-&gt;b_dev==dev &amp;&amp; tmp-&gt;b_blocknr==block)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> tmp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant"><a href="../include/linux/sched.h.html#L26" title="include/linux/sched.h:26">NULL</a></span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Why like this, I hear you say... The reason is race-conditions.<br/></li>
<li></span><span class="Comment"> * As we don't lock buffers (unless we are readint them, that is),<br/></li>
<li></span><span class="Comment"> * something might happen to it while we sleep (ie a read-error<br/></li>
<li></span><span class="Comment"> * will force it bad). This shouldn't really happen currently, but<br/></li>
<li></span><span class="Comment"> * the code is ready.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li><a id="L183">&#x200c;</a></span><span class="Type">struct</span> <a href="../include/linux/fs.h.html#L68" title="include/linux/fs.h:68">buffer_head</a> * <span class="linkable">get_hash_table</span>(<span class="Type">int</span> dev, <span class="Type">int</span> block)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">struct</span> <a href="../include/linux/fs.h.html#L68" title="include/linux/fs.h:68">buffer_head</a> * bh;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (;;) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!(bh=<a href="#L166" title="fs/buffer.c:166">find_buffer</a>(dev,block)))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant"><a href="../include/linux/sched.h.html#L26" title="include/linux/sched.h:26">NULL</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bh-&gt;b_count++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L36" title="fs/buffer.c:36">wait_on_buffer</a>(bh);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (bh-&gt;b_dev == dev &amp;&amp; bh-&gt;b_blocknr == block)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> bh;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bh-&gt;b_count--;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Ok, this is <a href="#L206" title="fs/buffer.c:206">getblk</a>, and it isn't very clear, again to hinder<br/></li>
<li></span><span class="Comment"> * race-conditions. Most of the code is seldom used, (ie repeating),<br/></li>
<li></span><span class="Comment"> * so it should be much more efficient than it looks.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * The algoritm is changed: hopefully better, and an elusive bug removed.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li><a id="L205">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">BADNESS</span>(bh) (((bh)-&gt;b_dirt&lt;&lt;</span><span class="Constant">1</span><span class="PreProc">)+(bh)-&gt;b_lock)<br/></li>
<li><a id="L206">&#x200c;</a></span><span class="Type">struct</span> <a href="../include/linux/fs.h.html#L68" title="include/linux/fs.h:68">buffer_head</a> * <span class="linkable">getblk</span>(<span class="Type">int</span> dev,<span class="Type">int</span> block)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">struct</span> <a href="../include/linux/fs.h.html#L68" title="include/linux/fs.h:68">buffer_head</a> * tmp, * bh;<br/></li>
<li><br/></li>
<li><span class="Statement">repeat</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (bh = <a href="#L183" title="fs/buffer.c:183">get_hash_table</a>(dev,block))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> bh;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; tmp = <a href="#L32" title="fs/buffer.c:32">free_list</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">do</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (tmp-&gt;b_count)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!bh || <a href="#L205" title="fs/buffer.c:205">BADNESS</a>(tmp)&lt;<a href="#L205" title="fs/buffer.c:205">BADNESS</a>(bh)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bh = tmp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!<a href="#L205" title="fs/buffer.c:205">BADNESS</a>(tmp))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><span class="Comment">/* and repeat until we find something good */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">while</span> ((tmp = tmp-&gt;b_next_free) != <a href="#L32" title="fs/buffer.c:32">free_list</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!bh) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../kernel/sched.c.html#L151" title="kernel/sched.c:151">sleep_on</a>(&amp;<a href="#L33" title="fs/buffer.c:33">buffer_wait</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> repeat;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L36" title="fs/buffer.c:36">wait_on_buffer</a>(bh);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (bh-&gt;b_count)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> repeat;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">while</span> (bh-&gt;b_dirt) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L59" title="fs/buffer.c:59">sync_dev</a>(bh-&gt;b_dev);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L36" title="fs/buffer.c:36">wait_on_buffer</a>(bh);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (bh-&gt;b_count)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> repeat;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><span class="Comment">/* NOTE!! While we slept waiting for this block, somebody else might */<br/></li>
<li></span><span class="Comment">/* already have added &quot;this&quot; block to the cache. check it */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L166" title="fs/buffer.c:166">find_buffer</a>(dev,block))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> repeat;<br/></li>
<li><span class="Comment">/* OK, FINALLY we know that this buffer is the only one of it's kind, */<br/></li>
<li></span><span class="Comment">/* and that it's unused (b_count=0), unlocked (b_lock=0), and clean */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; bh-&gt;b_count=<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; bh-&gt;b_dirt=<span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; bh-&gt;b_uptodate=<span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L131" title="fs/buffer.c:131">remove_from_queues</a>(bh);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; bh-&gt;b_dev=dev;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; bh-&gt;b_blocknr=block;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L149" title="fs/buffer.c:149">insert_into_queues</a>(bh);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> bh;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L253">&#x200c;</a><span class="Type">void</span> <span class="linkable">brelse</span>(<span class="Type">struct</span> <a href="../include/linux/fs.h.html#L68" title="include/linux/fs.h:68">buffer_head</a> * <a href="../kernel/printk.c.html#L17" title="kernel/printk.c:17">buf</a>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!<a href="../kernel/printk.c.html#L17" title="kernel/printk.c:17">buf</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L36" title="fs/buffer.c:36">wait_on_buffer</a>(<a href="../kernel/printk.c.html#L17" title="kernel/printk.c:17">buf</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!(<a href="../kernel/printk.c.html#L17" title="kernel/printk.c:17">buf</a>-&gt;b_count--))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../kernel/panic.c.html#L16" title="kernel/panic.c:16">panic</a>(<span class="Constant">&quot;Trying to <a href="../include/linux/kernel.h.html#L12" title="include/linux/kernel.h:12">free</a> <a href="../include/linux/kernel.h.html#L12" title="include/linux/kernel.h:12">free</a> buffer&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../kernel/sched.c.html#L188" title="kernel/sched.c:188">wake_up</a>(&amp;<a href="#L33" title="fs/buffer.c:33">buffer_wait</a>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L267" title="fs/buffer.c:267">bread</a>() reads a specified block and returns the buffer that contains<br/></li>
<li></span><span class="Comment"> * it. It returns <a href="../include/linux/sched.h.html#L26" title="include/linux/sched.h:26">NULL</a> if the block was unreadable.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li><a id="L267">&#x200c;</a></span><span class="Type">struct</span> <a href="../include/linux/fs.h.html#L68" title="include/linux/fs.h:68">buffer_head</a> * <span class="linkable">bread</span>(<span class="Type">int</span> dev,<span class="Type">int</span> block)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">struct</span> <a href="../include/linux/fs.h.html#L68" title="include/linux/fs.h:68">buffer_head</a> * bh;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!(bh=<a href="#L206" title="fs/buffer.c:206">getblk</a>(dev,block)))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../kernel/panic.c.html#L16" title="kernel/panic.c:16">panic</a>(<span class="Constant">&quot;<a href="#L267" title="fs/buffer.c:267">bread</a>: <a href="#L206" title="fs/buffer.c:206">getblk</a> returned <a href="../include/linux/sched.h.html#L26" title="include/linux/sched.h:26">NULL</a></span><span class="Special">\n</span><span class="Constant">&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (bh-&gt;b_uptodate)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> bh;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../kernel/blk_drv/ll_rw_blk.c.html#L145" title="kernel/blk_drv/ll_rw_blk.c:145">ll_rw_block</a>(<a href="../include/linux/fs.h.html#L26" title="include/linux/fs.h:26">READ</a>,bh);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L36" title="fs/buffer.c:36">wait_on_buffer</a>(bh);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (bh-&gt;b_uptodate)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> bh;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L253" title="fs/buffer.c:253">brelse</a>(bh);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant"><a href="../include/linux/sched.h.html#L26" title="include/linux/sched.h:26">NULL</a></span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L283">&#x200c;</a><span class="PreProc">#define <span class="linkable">COPYBLK</span>(from,to) \<br/></li>
<li></span><span class="PreProc">__asm__(</span><span class="Constant">&quot;cld</span><span class="Special">\n\t</span><span class="Constant">&quot;</span><span class="PreProc"> \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">&quot;rep</span><span class="Special">\n\t</span><span class="Constant">&quot;</span><span class="PreProc"> \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">&quot;movsl</span><span class="Special">\n\t</span><span class="Constant">&quot;</span><span class="PreProc"> \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; &nbsp; &nbsp; ::</span><span class="Constant">&quot;c&quot;</span><span class="PreProc"> (<a href="../include/linux/fs.h.html#L49" title="include/linux/fs.h:49">BLOCK_SIZE</a>/</span><span class="Constant">4</span><span class="PreProc">),</span><span class="Constant">&quot;S&quot;</span><span class="PreProc"> (from),</span><span class="Constant">&quot;D&quot;</span><span class="PreProc"> (to) \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; &nbsp; &nbsp; :)<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L296" title="fs/buffer.c:296">bread_page</a> reads four buffers into memory at the desired address. It's<br/></li>
<li></span><span class="Comment"> * a function of its own, as there is some speed to be got by reading them<br/></li>
<li></span><span class="Comment"> * all at the same time, not waiting for one to be read, and then another<br/></li>
<li></span><span class="Comment"> * etc.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li><a id="L296">&#x200c;</a></span><span class="Type">void</span> <span class="linkable">bread_page</span>(<span class="Type">unsigned</span> <span class="Type">long</span> address,<span class="Type">int</span> dev,<span class="Type">int</span> b[<span class="Constant">4</span>])<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">struct</span> <a href="../include/linux/fs.h.html#L68" title="include/linux/fs.h:68">buffer_head</a> * bh[<span class="Constant">4</span>];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> i;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (i=<span class="Constant">0</span> ; i&lt;<span class="Constant">4</span> ; i++)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (b[i]) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (bh[i] = <a href="#L206" title="fs/buffer.c:206">getblk</a>(dev,b[i]))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!bh[i]-&gt;b_uptodate)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../kernel/blk_drv/ll_rw_blk.c.html#L145" title="kernel/blk_drv/ll_rw_blk.c:145">ll_rw_block</a>(<a href="../include/linux/fs.h.html#L26" title="include/linux/fs.h:26">READ</a>,bh[i]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bh[i] = <span class="Constant"><a href="../include/linux/sched.h.html#L26" title="include/linux/sched.h:26">NULL</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (i=<span class="Constant">0</span> ; i&lt;<span class="Constant">4</span> ; i++,address += <a href="../include/linux/fs.h.html#L49" title="include/linux/fs.h:49">BLOCK_SIZE</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (bh[i]) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L36" title="fs/buffer.c:36">wait_on_buffer</a>(bh[i]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (bh[i]-&gt;b_uptodate)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L283" title="fs/buffer.c:283">COPYBLK</a>((<span class="Type">unsigned</span> <span class="Type">long</span>) bh[i]-&gt;b_data,address);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L253" title="fs/buffer.c:253">brelse</a>(bh[i]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Ok, <a href="#L322" title="fs/buffer.c:322">breada</a> can be used as <a href="#L267" title="fs/buffer.c:267">bread</a>, but additionally to mark other<br/></li>
<li></span><span class="Comment"> * blocks for reading as well. End the argument list with a negative<br/></li>
<li></span><span class="Comment"> * <a href="../kernel/vsprintf.c.html#L40" title="kernel/vsprintf.c:40">number</a>.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li><a id="L322">&#x200c;</a></span><span class="Type">struct</span> <a href="../include/linux/fs.h.html#L68" title="include/linux/fs.h:68">buffer_head</a> * <span class="linkable">breada</span>(<span class="Type">int</span> dev,<span class="Type">int</span> first, ...)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type"><a href="../include/stdarg.h.html#L4" title="include/stdarg.h:4">va_list</a></span> args;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">struct</span> <a href="../include/linux/fs.h.html#L68" title="include/linux/fs.h:68">buffer_head</a> * bh, *tmp;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../include/stdarg.h.html#L13" title="include/stdarg.h:13">va_start</a>(args,first);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!(bh=<a href="#L206" title="fs/buffer.c:206">getblk</a>(dev,first)))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../kernel/panic.c.html#L16" title="kernel/panic.c:16">panic</a>(<span class="Constant">&quot;<a href="#L267" title="fs/buffer.c:267">bread</a>: <a href="#L206" title="fs/buffer.c:206">getblk</a> returned <a href="../include/linux/sched.h.html#L26" title="include/linux/sched.h:26">NULL</a></span><span class="Special">\n</span><span class="Constant">&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!bh-&gt;b_uptodate)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../kernel/blk_drv/ll_rw_blk.c.html#L145" title="kernel/blk_drv/ll_rw_blk.c:145">ll_rw_block</a>(<a href="../include/linux/fs.h.html#L26" title="include/linux/fs.h:26">READ</a>,bh);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">while</span> ((first=<a href="../include/stdarg.h.html#L24" title="include/stdarg.h:24">va_arg</a>(args,<span class="Type">int</span>))&gt;=<span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tmp=<a href="#L206" title="fs/buffer.c:206">getblk</a>(dev,first);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (tmp) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!tmp-&gt;b_uptodate)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../kernel/blk_drv/ll_rw_blk.c.html#L145" title="kernel/blk_drv/ll_rw_blk.c:145">ll_rw_block</a>(<a href="../include/linux/fs.h.html#L28" title="include/linux/fs.h:28">READA</a>,bh);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tmp-&gt;b_count--;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../include/stdarg.h.html#L22" title="include/stdarg.h:22">va_end</a>(args);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L36" title="fs/buffer.c:36">wait_on_buffer</a>(bh);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (bh-&gt;b_uptodate)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> bh;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L253" title="fs/buffer.c:253">brelse</a>(bh);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> (<span class="Constant"><a href="../include/linux/sched.h.html#L26" title="include/linux/sched.h:26">NULL</a></span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L348">&#x200c;</a><span class="Type">void</span> <span class="linkable">buffer_init</span>(<span class="Type">long</span> buffer_end)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">struct</span> <a href="../include/linux/fs.h.html#L68" title="include/linux/fs.h:68">buffer_head</a> * h = <a href="#L30" title="fs/buffer.c:30">start_buffer</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">void</span> * b;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> i;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (buffer_end == <span class="Constant">1</span>&lt;&lt;<span class="Constant">20</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b = (<span class="Type">void</span> *) (<span class="Constant">640</span>*<span class="Constant">1024</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b = (<span class="Type">void</span> *) buffer_end;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">while</span> ( (b -= <a href="../include/linux/fs.h.html#L49" title="include/linux/fs.h:49">BLOCK_SIZE</a>) &gt;= ((<span class="Type">void</span> *) (h+<span class="Constant">1</span>)) ) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; h-&gt;b_dev = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; h-&gt;b_dirt = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; h-&gt;b_count = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; h-&gt;b_lock = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; h-&gt;b_uptodate = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; h-&gt;b_wait = <span class="Constant"><a href="../include/linux/sched.h.html#L26" title="include/linux/sched.h:26">NULL</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; h-&gt;b_next = <span class="Constant"><a href="../include/linux/sched.h.html#L26" title="include/linux/sched.h:26">NULL</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; h-&gt;b_prev = <span class="Constant"><a href="../include/linux/sched.h.html#L26" title="include/linux/sched.h:26">NULL</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; h-&gt;b_data = (<span class="Type">char</span> *) b;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; h-&gt;b_prev_free = h-<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; h-&gt;b_next_free = h+<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; h++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../include/linux/fs.h.html#L48" title="include/linux/fs.h:48">NR_BUFFERS</a>++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (b == (<span class="Type">void</span> *) <span class="Constant">0x100000</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b = (<span class="Type">void</span> *) <span class="Constant">0xA0000</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; h--;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L32" title="fs/buffer.c:32">free_list</a> = <a href="#L30" title="fs/buffer.c:30">start_buffer</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L32" title="fs/buffer.c:32">free_list</a>-&gt;b_prev_free = h;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; h-&gt;b_next_free = <a href="#L32" title="fs/buffer.c:32">free_list</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (i=<span class="Constant">0</span>;i&lt;<a href="../include/linux/fs.h.html#L47" title="include/linux/fs.h:47">NR_HASH</a>;i++)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L31" title="fs/buffer.c:31">hash_table</a>[i]=<span class="Constant"><a href="../include/linux/sched.h.html#L26" title="include/linux/sched.h:26">NULL</a></span>;<br/></li>
<li>}<br/></li>
</ol></code>
 </body>
</html>
