<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>fs/namei.c - linux-0.11-ebook</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

code {
    font-family: consolas, monospace;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
  <h3>fs/namei.c - linux-0.11-ebook</h3>
   <a href="../index.html"> Table of Contents </a>
 <h4>Functions defined</h4>
 <ul>
<li><a href="#L165">add_entry</a></li>
<li><a href="#L278">dir_namei</a></li>
<li><a href="#L543">empty_dir</a></li>
<li><a href="#L91">find_entry</a></li>
<li><a href="#L228">get_dir</a></li>
<li><a href="#L63">match</a></li>
<li><a href="#L303">namei</a></li>
<li><a href="#L337">open_namei</a></li>
<li><a href="#L40">permission</a></li>
<li><a href="#L721">sys_link</a></li>
<li><a href="#L463">sys_mkdir</a></li>
<li><a href="#L412">sys_mknod</a></li>
<li><a href="#L587">sys_rmdir</a></li>
<li><a href="#L663">sys_unlink</a></li>
</ul>
 <h4>Macros defined</h4>
 <ul>
<li><a href="#L21">ACC_MODE</a></li>
<li><a href="#L29">MAY_EXEC</a></li>
<li><a href="#L31">MAY_READ</a></li>
<li><a href="#L30">MAY_WRITE</a></li>
</ul>
 <h4>Source code</h4>

  <code><ol><li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> *&nbsp; linux/fs/<a href="#L303" title="fs/namei.c:303">namei</a>.c<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *&nbsp; (C) 1991&nbsp; Linus Torvalds<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Some corrections by tytso.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;linux/sched.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;linux/kernel.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;asm/segment.h&gt;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;string.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;fcntl.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;<a href="../lib/errno.c.html#L7" title="lib/errno.c:7">errno</a>.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;const.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;sys/<a href="../include/sys/stat.h.html#L6" title="include/sys/stat.h:6">stat</a>.h&gt;<br/></li>
<li></span><br/></li>
<li><a id="L21">&#x200c;</a><span class="PreProc">#define <span class="linkable">ACC_MODE</span>(<a href="../kernel/chr_drv/console.c.html#L72" title="kernel/chr_drv/console.c:72">x</a>) (</span><span class="Constant">&quot;</span><span class="Special">\004\002\006\377</span><span class="Constant">&quot;</span><span class="PreProc">[(<a href="../kernel/chr_drv/console.c.html#L72" title="kernel/chr_drv/console.c:72">x</a>)&amp;<a href="../include/fcntl.h.html#L7" title="include/fcntl.h:7">O_ACCMODE</a>])<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * comment out this line if you want names &gt; <a href="../include/linux/fs.h.html#L36" title="include/linux/fs.h:36">NAME_LEN</a> chars to be<br/></li>
<li></span><span class="Comment"> * truncated. Else they will be disallowed.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Comment">/* #define NO_TRUNCATE */<br/></li>
<li></span><br/></li>
<li><a id="L29">&#x200c;</a><span class="PreProc">#define <span class="linkable">MAY_EXEC</span> </span><span class="Constant">1<br/></li>
<li><a id="L30">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">MAY_WRITE</span> </span><span class="Constant">2<br/></li>
<li><a id="L31">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">MAY_READ</span> </span><span class="Constant">4<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L40" title="fs/namei.c:40">permission</a>()<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * is used to check for read/write/execute permissions on a <a href="../include/linux/fs.h.html#L116" title="include/linux/fs.h:116">file</a>.<br/></li>
<li></span><span class="Comment"> * I don't know if we should look at just the euid or both euid and<br/></li>
<li></span><span class="Comment"> * uid, but that should be easily changed.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li><a id="L40">&#x200c;</a></span><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">permission</span>(<span class="Type">struct</span> <a href="../include/linux/fs.h.html#L93" title="include/linux/fs.h:93">m_inode</a> * inode,<span class="Type">int</span> mask)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> mode = inode-&gt;i_mode;<br/></li>
<li><br/></li>
<li><span class="Comment">/* special case: not even root can read/write a deleted <a href="../include/linux/fs.h.html#L116" title="include/linux/fs.h:116">file</a> */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (inode-&gt;i_dev &amp;&amp; !inode-&gt;i_nlinks)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (<a href="../kernel/sched.c.html#L62" title="kernel/sched.c:62">current</a>-&gt;euid==inode-&gt;i_uid)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mode &gt;&gt;= <span class="Constant">6</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (<a href="../kernel/sched.c.html#L62" title="kernel/sched.c:62">current</a>-&gt;egid==inode-&gt;i_gid)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mode &gt;&gt;= <span class="Constant">3</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (((mode &amp; mask &amp; <span class="PreProc">0</span><span class="Constant">007</span>) == mask) || <a href="../include/linux/kernel.h.html#L21" title="include/linux/kernel.h:21">suser</a>())<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * ok, we cannot use <a href="../include/string.h.html#L107" title="include/string.h:107">strncmp</a>, as the name is not in our data space.<br/></li>
<li></span><span class="Comment"> * Thus we'll have to use <a href="#L63" title="fs/namei.c:63">match</a>. No big problem. Match also makes<br/></li>
<li></span><span class="Comment"> * some sanity tests.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * NOTE! unlike <a href="../include/string.h.html#L107" title="include/string.h:107">strncmp</a>, <a href="#L63" title="fs/namei.c:63">match</a> returns 1 for success, 0 for failure.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li><a id="L63">&#x200c;</a></span><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">match</span>(<span class="Type">int</span> len,<span class="Type">const</span> <span class="Type">char</span> * name,<span class="Type">struct</span> <a href="../include/linux/fs.h.html#L157" title="include/linux/fs.h:157">dir_entry</a> * de)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">register</span> <span class="Type">int</span> same __asm__(<span class="Constant">&quot;ax&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!de || !de-&gt;inode || len &gt; <a href="../include/linux/fs.h.html#L36" title="include/linux/fs.h:36">NAME_LEN</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (len &lt; <a href="../include/linux/fs.h.html#L36" title="include/linux/fs.h:36">NAME_LEN</a> &amp;&amp; de-&gt;name[len])<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; __asm__(<span class="Constant">&quot;cld</span><span class="Special">\n\t</span><span class="Constant">&quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;fs ; repe ; cmpsb</span><span class="Special">\n\t</span><span class="Constant">&quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;setz </span><span class="Special">%%</span><span class="Constant">al&quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :<span class="Constant">&quot;=a&quot;</span> (same)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :<span class="Constant">&quot;0&quot;</span> (<span class="Constant">0</span>),<span class="Constant">&quot;S&quot;</span> ((<span class="Type">long</span>) name),<span class="Constant">&quot;D&quot;</span> ((<span class="Type">long</span>) de-&gt;name),<span class="Constant">&quot;c&quot;</span> (len)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :) ;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> same;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L91" title="fs/namei.c:91">find_entry</a>()<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * finds an entry in the specified directory with the wanted name. It<br/></li>
<li></span><span class="Comment"> * returns the cache buffer in which the entry was found, and the entry<br/></li>
<li></span><span class="Comment"> * itself (as a parameter - res_dir). It does NOT read the inode of the<br/></li>
<li></span><span class="Comment"> * entry - you'll have to do that yourself if you want to.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * This also takes care of the few special cases due to '..'-traversal<br/></li>
<li></span><span class="Comment"> * over a pseudo-root and a mount point.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li><a id="L91">&#x200c;</a></span><span class="Type">static</span> <span class="Type">struct</span> <a href="../include/linux/fs.h.html#L68" title="include/linux/fs.h:68">buffer_head</a> * <span class="linkable">find_entry</span>(<span class="Type">struct</span> <a href="../include/linux/fs.h.html#L93" title="include/linux/fs.h:93">m_inode</a> ** dir,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span> * name, <span class="Type">int</span> namelen, <span class="Type">struct</span> <a href="../include/linux/fs.h.html#L157" title="include/linux/fs.h:157">dir_entry</a> ** res_dir)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> entries;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> block,i;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">struct</span> <a href="../include/linux/fs.h.html#L68" title="include/linux/fs.h:68">buffer_head</a> * bh;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">struct</span> <a href="../include/linux/fs.h.html#L157" title="include/linux/fs.h:157">dir_entry</a> * de;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">struct</span> <a href="../include/linux/fs.h.html#L124" title="include/linux/fs.h:124">super_block</a> * sb;<br/></li>
<li><br/></li>
<li><span class="PreProc">#ifdef NO_TRUNCATE<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (namelen &gt; <a href="../include/linux/fs.h.html#L36" title="include/linux/fs.h:36">NAME_LEN</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant"><a href="../include/linux/sched.h.html#L26" title="include/linux/sched.h:26">NULL</a></span>;<br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (namelen &gt; <a href="../include/linux/fs.h.html#L36" title="include/linux/fs.h:36">NAME_LEN</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; namelen = <a href="../include/linux/fs.h.html#L36" title="include/linux/fs.h:36">NAME_LEN</a>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; entries = (*dir)-&gt;i_size / (<span class="Statement">sizeof</span> (<span class="Type">struct</span> <a href="../include/linux/fs.h.html#L157" title="include/linux/fs.h:157">dir_entry</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *res_dir = <span class="Constant"><a href="../include/linux/sched.h.html#L26" title="include/linux/sched.h:26">NULL</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!namelen)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant"><a href="../include/linux/sched.h.html#L26" title="include/linux/sched.h:26">NULL</a></span>;<br/></li>
<li><span class="Comment">/* check for '..', as we might have to do some &quot;magic&quot; for it */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (namelen==<span class="Constant">2</span> &amp;&amp; <a href="../include/asm/segment.h.html#L1" title="include/asm/segment.h:1">get_fs_byte</a>(name)==<span class="Constant">'.'</span> &amp;&amp; <a href="../include/asm/segment.h.html#L1" title="include/asm/segment.h:1">get_fs_byte</a>(name+<span class="Constant">1</span>)==<span class="Constant">'.'</span>) {<br/></li>
<li><span class="Comment">/* '..' in a pseudo-root results in a faked '.' (just change namelen) */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((*dir) == <a href="../kernel/sched.c.html#L62" title="kernel/sched.c:62">current</a>-&gt;root)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; namelen=<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">if</span> ((*dir)-&gt;i_num == <a href="../include/linux/fs.h.html#L37" title="include/linux/fs.h:37">ROOT_INO</a>) {<br/></li>
<li><span class="Comment">/* '..' over a mount-point results in 'dir' being exchanged for the mounted<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; directory-inode. NOTE! We set mounted, so that we can <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a> the new dir */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sb=<a href="super.c.html#L56" title="fs/super.c:56">get_super</a>((*dir)-&gt;i_dev);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (sb-&gt;s_imount) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(*dir);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (*dir)=sb-&gt;s_imount;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (*dir)-&gt;i_count++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!(block = (*dir)-&gt;i_zone[<span class="Constant">0</span>]))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant"><a href="../include/linux/sched.h.html#L26" title="include/linux/sched.h:26">NULL</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!(bh = <a href="buffer.c.html#L267" title="fs/buffer.c:267">bread</a>((*dir)-&gt;i_dev,block)))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant"><a href="../include/linux/sched.h.html#L26" title="include/linux/sched.h:26">NULL</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; i = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; de = (<span class="Type">struct</span> <a href="../include/linux/fs.h.html#L157" title="include/linux/fs.h:157">dir_entry</a> *) bh-&gt;b_data;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">while</span> (i &lt; entries) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((<span class="Type">char</span> *)de &gt;= <a href="../include/linux/fs.h.html#L49" title="include/linux/fs.h:49">BLOCK_SIZE</a>+bh-&gt;b_data) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="buffer.c.html#L253" title="fs/buffer.c:253">brelse</a>(bh);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bh = <span class="Constant"><a href="../include/linux/sched.h.html#L26" title="include/linux/sched.h:26">NULL</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!(block = <a href="inode.c.html#L140" title="fs/inode.c:140">bmap</a>(*dir,i/<a href="../include/linux/fs.h.html#L56" title="include/linux/fs.h:56">DIR_ENTRIES_PER_BLOCK</a>)) ||<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; !(bh = <a href="buffer.c.html#L267" title="fs/buffer.c:267">bread</a>((*dir)-&gt;i_dev,block))) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i += <a href="../include/linux/fs.h.html#L56" title="include/linux/fs.h:56">DIR_ENTRIES_PER_BLOCK</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; de = (<span class="Type">struct</span> <a href="../include/linux/fs.h.html#L157" title="include/linux/fs.h:157">dir_entry</a> *) bh-&gt;b_data;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L63" title="fs/namei.c:63">match</a>(namelen,name,de)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *res_dir = de;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> bh;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; de++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="buffer.c.html#L253" title="fs/buffer.c:253">brelse</a>(bh);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant"><a href="../include/linux/sched.h.html#L26" title="include/linux/sched.h:26">NULL</a></span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L165" title="fs/namei.c:165">add_entry</a>()<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * adds a <a href="../include/linux/fs.h.html#L116" title="include/linux/fs.h:116">file</a> entry to the specified directory, using the same<br/></li>
<li></span><span class="Comment"> * semantics as <a href="#L91" title="fs/namei.c:91">find_entry</a>(). It returns <a href="../include/linux/sched.h.html#L26" title="include/linux/sched.h:26">NULL</a> if it failed.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * NOTE!! The inode part of 'de' is left at 0 - which means you<br/></li>
<li></span><span class="Comment"> * may not sleep between calling this and putting something into<br/></li>
<li></span><span class="Comment"> * the entry, as someone else might have used it while you slept.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li><a id="L165">&#x200c;</a></span><span class="Type">static</span> <span class="Type">struct</span> <a href="../include/linux/fs.h.html#L68" title="include/linux/fs.h:68">buffer_head</a> * <span class="linkable">add_entry</span>(<span class="Type">struct</span> <a href="../include/linux/fs.h.html#L93" title="include/linux/fs.h:93">m_inode</a> * dir,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span> * name, <span class="Type">int</span> namelen, <span class="Type">struct</span> <a href="../include/linux/fs.h.html#L157" title="include/linux/fs.h:157">dir_entry</a> ** res_dir)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> block,i;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">struct</span> <a href="../include/linux/fs.h.html#L68" title="include/linux/fs.h:68">buffer_head</a> * bh;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">struct</span> <a href="../include/linux/fs.h.html#L157" title="include/linux/fs.h:157">dir_entry</a> * de;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *res_dir = <span class="Constant"><a href="../include/linux/sched.h.html#L26" title="include/linux/sched.h:26">NULL</a></span>;<br/></li>
<li><span class="PreProc">#ifdef NO_TRUNCATE<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (namelen &gt; <a href="../include/linux/fs.h.html#L36" title="include/linux/fs.h:36">NAME_LEN</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant"><a href="../include/linux/sched.h.html#L26" title="include/linux/sched.h:26">NULL</a></span>;<br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (namelen &gt; <a href="../include/linux/fs.h.html#L36" title="include/linux/fs.h:36">NAME_LEN</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; namelen = <a href="../include/linux/fs.h.html#L36" title="include/linux/fs.h:36">NAME_LEN</a>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!namelen)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant"><a href="../include/linux/sched.h.html#L26" title="include/linux/sched.h:26">NULL</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!(block = dir-&gt;i_zone[<span class="Constant">0</span>]))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant"><a href="../include/linux/sched.h.html#L26" title="include/linux/sched.h:26">NULL</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!(bh = <a href="buffer.c.html#L267" title="fs/buffer.c:267">bread</a>(dir-&gt;i_dev,block)))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant"><a href="../include/linux/sched.h.html#L26" title="include/linux/sched.h:26">NULL</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; i = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; de = (<span class="Type">struct</span> <a href="../include/linux/fs.h.html#L157" title="include/linux/fs.h:157">dir_entry</a> *) bh-&gt;b_data;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">while</span> (<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((<span class="Type">char</span> *)de &gt;= <a href="../include/linux/fs.h.html#L49" title="include/linux/fs.h:49">BLOCK_SIZE</a>+bh-&gt;b_data) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="buffer.c.html#L253" title="fs/buffer.c:253">brelse</a>(bh);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bh = <span class="Constant"><a href="../include/linux/sched.h.html#L26" title="include/linux/sched.h:26">NULL</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; block = <a href="inode.c.html#L145" title="fs/inode.c:145">create_block</a>(dir,i/<a href="../include/linux/fs.h.html#L56" title="include/linux/fs.h:56">DIR_ENTRIES_PER_BLOCK</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!block)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant"><a href="../include/linux/sched.h.html#L26" title="include/linux/sched.h:26">NULL</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!(bh = <a href="buffer.c.html#L267" title="fs/buffer.c:267">bread</a>(dir-&gt;i_dev,block))) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i += <a href="../include/linux/fs.h.html#L56" title="include/linux/fs.h:56">DIR_ENTRIES_PER_BLOCK</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; de = (<span class="Type">struct</span> <a href="../include/linux/fs.h.html#L157" title="include/linux/fs.h:157">dir_entry</a> *) bh-&gt;b_data;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (i*<span class="Statement">sizeof</span>(<span class="Type">struct</span> <a href="../include/linux/fs.h.html#L157" title="include/linux/fs.h:157">dir_entry</a>) &gt;= dir-&gt;i_size) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; de-&gt;inode=<span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dir-&gt;i_size = (i+<span class="Constant">1</span>)*<span class="Statement">sizeof</span>(<span class="Type">struct</span> <a href="../include/linux/fs.h.html#L157" title="include/linux/fs.h:157">dir_entry</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dir-&gt;i_dirt = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dir-&gt;i_ctime = <a href="../include/linux/sched.h.html#L142" title="include/linux/sched.h:142">CURRENT_TIME</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!de-&gt;inode) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dir-&gt;i_mtime = <a href="../include/linux/sched.h.html#L142" title="include/linux/sched.h:142">CURRENT_TIME</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (i=<span class="Constant">0</span>; i &lt; <a href="../include/linux/fs.h.html#L36" title="include/linux/fs.h:36">NAME_LEN</a> ; i++)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; de-&gt;name[i]=(i&lt;namelen)?<a href="../include/asm/segment.h.html#L1" title="include/asm/segment.h:1">get_fs_byte</a>(name+i):<span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bh-&gt;b_dirt = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *res_dir = de;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> bh;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; de++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="buffer.c.html#L253" title="fs/buffer.c:253">brelse</a>(bh);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant"><a href="../include/linux/sched.h.html#L26" title="include/linux/sched.h:26">NULL</a></span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L228" title="fs/namei.c:228">get_dir</a>()<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Getdir traverses the pathname until it hits the topmost directory.<br/></li>
<li></span><span class="Comment"> * It returns <a href="../include/linux/sched.h.html#L26" title="include/linux/sched.h:26">NULL</a> on failure.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li><a id="L228">&#x200c;</a></span><span class="Type">static</span> <span class="Type">struct</span> <a href="../include/linux/fs.h.html#L93" title="include/linux/fs.h:93">m_inode</a> * <span class="linkable">get_dir</span>(<span class="Type">const</span> <span class="Type">char</span> * pathname)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">char</span> c;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span> * thisname;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">struct</span> <a href="../include/linux/fs.h.html#L93" title="include/linux/fs.h:93">m_inode</a> * inode;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">struct</span> <a href="../include/linux/fs.h.html#L68" title="include/linux/fs.h:68">buffer_head</a> * bh;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> namelen,inr,idev;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">struct</span> <a href="../include/linux/fs.h.html#L157" title="include/linux/fs.h:157">dir_entry</a> * de;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!<a href="../kernel/sched.c.html#L62" title="kernel/sched.c:62">current</a>-&gt;root || !<a href="../kernel/sched.c.html#L62" title="kernel/sched.c:62">current</a>-&gt;root-&gt;i_count)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../kernel/panic.c.html#L16" title="kernel/panic.c:16">panic</a>(<span class="Constant">&quot;No root inode&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!<a href="../kernel/sched.c.html#L62" title="kernel/sched.c:62">current</a>-&gt;pwd || !<a href="../kernel/sched.c.html#L62" title="kernel/sched.c:62">current</a>-&gt;pwd-&gt;i_count)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../kernel/panic.c.html#L16" title="kernel/panic.c:16">panic</a>(<span class="Constant">&quot;No cwd inode&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((c=<a href="../include/asm/segment.h.html#L1" title="include/asm/segment.h:1">get_fs_byte</a>(pathname))==<span class="Constant">'/'</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inode = <a href="../kernel/sched.c.html#L62" title="kernel/sched.c:62">current</a>-&gt;root;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pathname++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (c)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inode = <a href="../kernel/sched.c.html#L62" title="kernel/sched.c:62">current</a>-&gt;pwd;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant"><a href="../include/linux/sched.h.html#L26" title="include/linux/sched.h:26">NULL</a></span>;&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* empty name is bad */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; inode-&gt;i_count++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">while</span> (<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; thisname = pathname;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!<a href="../include/sys/stat.h.html#L31" title="include/sys/stat.h:31">S_ISDIR</a>(inode-&gt;i_mode) || !<a href="#L40" title="fs/namei.c:40">permission</a>(inode,<a href="#L29" title="fs/namei.c:29">MAY_EXEC</a>)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(inode);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant"><a href="../include/linux/sched.h.html#L26" title="include/linux/sched.h:26">NULL</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span>(namelen=<span class="Constant">0</span>;(c=<a href="../include/asm/segment.h.html#L1" title="include/asm/segment.h:1">get_fs_byte</a>(pathname++))&amp;&amp;(c!=<span class="Constant">'/'</span>);namelen++)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* nothing */</span> ;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!c)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> inode;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!(bh = <a href="#L91" title="fs/namei.c:91">find_entry</a>(&amp;inode,thisname,namelen,&amp;de))) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(inode);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant"><a href="../include/linux/sched.h.html#L26" title="include/linux/sched.h:26">NULL</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inr = de-&gt;inode;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; idev = inode-&gt;i_dev;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="buffer.c.html#L253" title="fs/buffer.c:253">brelse</a>(bh);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(inode);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!(inode = <a href="inode.c.html#L244" title="fs/inode.c:244">iget</a>(idev,inr)))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant"><a href="../include/linux/sched.h.html#L26" title="include/linux/sched.h:26">NULL</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L278" title="fs/namei.c:278">dir_namei</a>()<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * <a href="#L278" title="fs/namei.c:278">dir_namei</a>() returns the inode of the directory of the<br/></li>
<li></span><span class="Comment"> * specified name, and the name within that directory.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li><a id="L278">&#x200c;</a></span><span class="Type">static</span> <span class="Type">struct</span> <a href="../include/linux/fs.h.html#L93" title="include/linux/fs.h:93">m_inode</a> * <span class="linkable">dir_namei</span>(<span class="Type">const</span> <span class="Type">char</span> * pathname,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> * namelen, <span class="Type">const</span> <span class="Type">char</span> ** name)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">char</span> c;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span> * basename;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">struct</span> <a href="../include/linux/fs.h.html#L93" title="include/linux/fs.h:93">m_inode</a> * dir;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!(dir = <a href="#L228" title="fs/namei.c:228">get_dir</a>(pathname)))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant"><a href="../include/linux/sched.h.html#L26" title="include/linux/sched.h:26">NULL</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; basename = pathname;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">while</span> (c=<a href="../include/asm/segment.h.html#L1" title="include/asm/segment.h:1">get_fs_byte</a>(pathname++))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (c==<span class="Constant">'/'</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; basename=pathname;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *namelen = pathname-basename-<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *name = basename;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> dir;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L303" title="fs/namei.c:303">namei</a>()<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * is used by most simple commands to get the inode of a specified name.<br/></li>
<li></span><span class="Comment"> * Open, link etc use their own routines, but this is enough for things<br/></li>
<li></span><span class="Comment"> * like 'chmod' etc.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li><a id="L303">&#x200c;</a></span><span class="Type">struct</span> <a href="../include/linux/fs.h.html#L93" title="include/linux/fs.h:93">m_inode</a> * <span class="linkable">namei</span>(<span class="Type">const</span> <span class="Type">char</span> * pathname)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span> * basename;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> inr,dev,namelen;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">struct</span> <a href="../include/linux/fs.h.html#L93" title="include/linux/fs.h:93">m_inode</a> * dir;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">struct</span> <a href="../include/linux/fs.h.html#L68" title="include/linux/fs.h:68">buffer_head</a> * bh;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">struct</span> <a href="../include/linux/fs.h.html#L157" title="include/linux/fs.h:157">dir_entry</a> * de;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!(dir = <a href="#L278" title="fs/namei.c:278">dir_namei</a>(pathname,&amp;namelen,&amp;basename)))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant"><a href="../include/linux/sched.h.html#L26" title="include/linux/sched.h:26">NULL</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!namelen)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* special case: '/usr/' etc */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> dir;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; bh = <a href="#L91" title="fs/namei.c:91">find_entry</a>(&amp;dir,basename,namelen,&amp;de);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!bh) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(dir);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant"><a href="../include/linux/sched.h.html#L26" title="include/linux/sched.h:26">NULL</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; inr = de-&gt;inode;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; dev = dir-&gt;i_dev;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="buffer.c.html#L253" title="fs/buffer.c:253">brelse</a>(bh);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(dir);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; dir=<a href="inode.c.html#L244" title="fs/inode.c:244">iget</a>(dev,inr);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (dir) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dir-&gt;i_atime=<a href="../include/linux/sched.h.html#L142" title="include/linux/sched.h:142">CURRENT_TIME</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dir-&gt;i_dirt=<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> dir;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L337" title="fs/namei.c:337">open_namei</a>()<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * <a href="#L303" title="fs/namei.c:303">namei</a> for <a href="../lib/open.c.html#L11" title="lib/open.c:11">open</a> - this is in fact almost the whole <a href="../lib/open.c.html#L11" title="lib/open.c:11">open</a>-routine.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li><a id="L337">&#x200c;</a></span><span class="Type">int</span> <span class="linkable">open_namei</span>(<span class="Type">const</span> <span class="Type">char</span> * pathname, <span class="Type">int</span> flag, <span class="Type">int</span> mode,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">struct</span> <a href="../include/linux/fs.h.html#L93" title="include/linux/fs.h:93">m_inode</a> ** res_inode)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span> * basename;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> inr,dev,namelen;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">struct</span> <a href="../include/linux/fs.h.html#L93" title="include/linux/fs.h:93">m_inode</a> * dir, *inode;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">struct</span> <a href="../include/linux/fs.h.html#L68" title="include/linux/fs.h:68">buffer_head</a> * bh;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">struct</span> <a href="../include/linux/fs.h.html#L157" title="include/linux/fs.h:157">dir_entry</a> * de;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((flag &amp; <a href="../include/fcntl.h.html#L14" title="include/fcntl.h:14">O_TRUNC</a>) &amp;&amp; !(flag &amp; <a href="../include/fcntl.h.html#L7" title="include/fcntl.h:7">O_ACCMODE</a>))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; flag |= <a href="../include/fcntl.h.html#L9" title="include/fcntl.h:9">O_WRONLY</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; mode &amp;= <span class="PreProc">0</span><span class="Constant">777</span> &amp; ~<a href="../kernel/sched.c.html#L62" title="kernel/sched.c:62">current</a>-&gt;umask;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; mode |= <a href="../include/const.h.html#L8" title="include/const.h:8">I_REGULAR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!(dir = <a href="#L278" title="fs/namei.c:278">dir_namei</a>(pathname,&amp;namelen,&amp;basename)))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant"><a href="../include/errno.h.html#L21" title="include/errno.h:21">ENOENT</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!namelen) {&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* special case: '/usr/' etc */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!(flag &amp; (<a href="../include/fcntl.h.html#L7" title="include/fcntl.h:7">O_ACCMODE</a>|<a href="../include/fcntl.h.html#L11" title="include/fcntl.h:11">O_CREAT</a>|<a href="../include/fcntl.h.html#L14" title="include/fcntl.h:14">O_TRUNC</a>))) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *res_inode=dir;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(dir);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant"><a href="../include/errno.h.html#L40" title="include/errno.h:40">EISDIR</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; bh = <a href="#L91" title="fs/namei.c:91">find_entry</a>(&amp;dir,basename,namelen,&amp;de);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!bh) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!(flag &amp; <a href="../include/fcntl.h.html#L11" title="include/fcntl.h:11">O_CREAT</a>)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(dir);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant"><a href="../include/errno.h.html#L21" title="include/errno.h:21">ENOENT</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!<a href="#L40" title="fs/namei.c:40">permission</a>(dir,<a href="#L30" title="fs/namei.c:30">MAY_WRITE</a>)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(dir);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant"><a href="../include/errno.h.html#L32" title="include/errno.h:32">EACCES</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inode = <a href="bitmap.c.html#L136" title="fs/bitmap.c:136">new_inode</a>(dir-&gt;i_dev);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!inode) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(dir);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant"><a href="../include/errno.h.html#L47" title="include/errno.h:47">ENOSPC</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inode-&gt;i_uid = <a href="../kernel/sched.c.html#L62" title="kernel/sched.c:62">current</a>-&gt;euid;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inode-&gt;i_mode = mode;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inode-&gt;i_dirt = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bh = <a href="#L165" title="fs/namei.c:165">add_entry</a>(dir,basename,namelen,&amp;de);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!bh) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inode-&gt;i_nlinks--;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(inode);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(dir);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant"><a href="../include/errno.h.html#L47" title="include/errno.h:47">ENOSPC</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; de-&gt;inode = inode-&gt;i_num;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bh-&gt;b_dirt = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="buffer.c.html#L253" title="fs/buffer.c:253">brelse</a>(bh);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(dir);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *res_inode = inode;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; inr = de-&gt;inode;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; dev = dir-&gt;i_dev;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="buffer.c.html#L253" title="fs/buffer.c:253">brelse</a>(bh);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(dir);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (flag &amp; <a href="../include/fcntl.h.html#L12" title="include/fcntl.h:12">O_EXCL</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant"><a href="../include/errno.h.html#L36" title="include/errno.h:36">EEXIST</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!(inode=<a href="inode.c.html#L244" title="fs/inode.c:244">iget</a>(dev,inr)))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant"><a href="../include/errno.h.html#L32" title="include/errno.h:32">EACCES</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((<a href="../include/sys/stat.h.html#L31" title="include/sys/stat.h:31">S_ISDIR</a>(inode-&gt;i_mode) &amp;&amp; (flag &amp; <a href="../include/fcntl.h.html#L7" title="include/fcntl.h:7">O_ACCMODE</a>)) ||<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; !<a href="#L40" title="fs/namei.c:40">permission</a>(inode,<a href="#L21" title="fs/namei.c:21">ACC_MODE</a>(flag))) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(inode);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant"><a href="../include/errno.h.html#L20" title="include/errno.h:20">EPERM</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; inode-&gt;i_atime = <a href="../include/linux/sched.h.html#L142" title="include/linux/sched.h:142">CURRENT_TIME</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (flag &amp; <a href="../include/fcntl.h.html#L14" title="include/fcntl.h:14">O_TRUNC</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="truncate.c.html#L47" title="fs/truncate.c:47">truncate</a>(inode);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *res_inode = inode;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L412">&#x200c;</a><span class="Type">int</span> <span class="linkable">sys_mknod</span>(<span class="Type">const</span> <span class="Type">char</span> * filename, <span class="Type">int</span> mode, <span class="Type">int</span> dev)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span> * basename;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> namelen;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">struct</span> <a href="../include/linux/fs.h.html#L93" title="include/linux/fs.h:93">m_inode</a> * dir, * inode;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">struct</span> <a href="../include/linux/fs.h.html#L68" title="include/linux/fs.h:68">buffer_head</a> * bh;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">struct</span> <a href="../include/linux/fs.h.html#L157" title="include/linux/fs.h:157">dir_entry</a> * de;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!<a href="../include/linux/kernel.h.html#L21" title="include/linux/kernel.h:21">suser</a>())<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant"><a href="../include/errno.h.html#L20" title="include/errno.h:20">EPERM</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!(dir = <a href="#L278" title="fs/namei.c:278">dir_namei</a>(filename,&amp;namelen,&amp;basename)))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant"><a href="../include/errno.h.html#L21" title="include/errno.h:21">ENOENT</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!namelen) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(dir);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant"><a href="../include/errno.h.html#L21" title="include/errno.h:21">ENOENT</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!<a href="#L40" title="fs/namei.c:40">permission</a>(dir,<a href="#L30" title="fs/namei.c:30">MAY_WRITE</a>)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(dir);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant"><a href="../include/errno.h.html#L20" title="include/errno.h:20">EPERM</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; bh = <a href="#L91" title="fs/namei.c:91">find_entry</a>(&amp;dir,basename,namelen,&amp;de);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (bh) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="buffer.c.html#L253" title="fs/buffer.c:253">brelse</a>(bh);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(dir);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant"><a href="../include/errno.h.html#L36" title="include/errno.h:36">EEXIST</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; inode = <a href="bitmap.c.html#L136" title="fs/bitmap.c:136">new_inode</a>(dir-&gt;i_dev);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!inode) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(dir);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant"><a href="../include/errno.h.html#L47" title="include/errno.h:47">ENOSPC</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; inode-&gt;i_mode = mode;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../include/sys/stat.h.html#L33" title="include/sys/stat.h:33">S_ISBLK</a>(mode) || <a href="../include/sys/stat.h.html#L32" title="include/sys/stat.h:32">S_ISCHR</a>(mode))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inode-&gt;i_zone[<span class="Constant">0</span>] = dev;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; inode-&gt;i_mtime = inode-&gt;i_atime = <a href="../include/linux/sched.h.html#L142" title="include/linux/sched.h:142">CURRENT_TIME</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; inode-&gt;i_dirt = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; bh = <a href="#L165" title="fs/namei.c:165">add_entry</a>(dir,basename,namelen,&amp;de);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!bh) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(dir);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inode-&gt;i_nlinks=<span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(inode);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant"><a href="../include/errno.h.html#L47" title="include/errno.h:47">ENOSPC</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; de-&gt;inode = inode-&gt;i_num;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; bh-&gt;b_dirt = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(dir);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(inode);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="buffer.c.html#L253" title="fs/buffer.c:253">brelse</a>(bh);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L463">&#x200c;</a><span class="Type">int</span> <span class="linkable">sys_mkdir</span>(<span class="Type">const</span> <span class="Type">char</span> * pathname, <span class="Type">int</span> mode)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span> * basename;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> namelen;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">struct</span> <a href="../include/linux/fs.h.html#L93" title="include/linux/fs.h:93">m_inode</a> * dir, * inode;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">struct</span> <a href="../include/linux/fs.h.html#L68" title="include/linux/fs.h:68">buffer_head</a> * bh, *dir_block;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">struct</span> <a href="../include/linux/fs.h.html#L157" title="include/linux/fs.h:157">dir_entry</a> * de;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!<a href="../include/linux/kernel.h.html#L21" title="include/linux/kernel.h:21">suser</a>())<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant"><a href="../include/errno.h.html#L20" title="include/errno.h:20">EPERM</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!(dir = <a href="#L278" title="fs/namei.c:278">dir_namei</a>(pathname,&amp;namelen,&amp;basename)))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant"><a href="../include/errno.h.html#L21" title="include/errno.h:21">ENOENT</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!namelen) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(dir);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant"><a href="../include/errno.h.html#L21" title="include/errno.h:21">ENOENT</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!<a href="#L40" title="fs/namei.c:40">permission</a>(dir,<a href="#L30" title="fs/namei.c:30">MAY_WRITE</a>)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(dir);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant"><a href="../include/errno.h.html#L20" title="include/errno.h:20">EPERM</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; bh = <a href="#L91" title="fs/namei.c:91">find_entry</a>(&amp;dir,basename,namelen,&amp;de);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (bh) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="buffer.c.html#L253" title="fs/buffer.c:253">brelse</a>(bh);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(dir);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant"><a href="../include/errno.h.html#L36" title="include/errno.h:36">EEXIST</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; inode = <a href="bitmap.c.html#L136" title="fs/bitmap.c:136">new_inode</a>(dir-&gt;i_dev);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!inode) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(dir);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant"><a href="../include/errno.h.html#L47" title="include/errno.h:47">ENOSPC</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; inode-&gt;i_size = <span class="Constant">32</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; inode-&gt;i_dirt = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; inode-&gt;i_mtime = inode-&gt;i_atime = <a href="../include/linux/sched.h.html#L142" title="include/linux/sched.h:142">CURRENT_TIME</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!(inode-&gt;i_zone[<span class="Constant">0</span>]=<a href="bitmap.c.html#L75" title="fs/bitmap.c:75">new_block</a>(inode-&gt;i_dev))) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(dir);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inode-&gt;i_nlinks--;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(inode);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant"><a href="../include/errno.h.html#L47" title="include/errno.h:47">ENOSPC</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; inode-&gt;i_dirt = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!(dir_block=<a href="buffer.c.html#L267" title="fs/buffer.c:267">bread</a>(inode-&gt;i_dev,inode-&gt;i_zone[<span class="Constant">0</span>]))) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(dir);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="bitmap.c.html#L47" title="fs/bitmap.c:47">free_block</a>(inode-&gt;i_dev,inode-&gt;i_zone[<span class="Constant">0</span>]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inode-&gt;i_nlinks--;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(inode);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<a href="../include/errno.h.html#L19" title="include/errno.h:19">ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; de = (<span class="Type">struct</span> <a href="../include/linux/fs.h.html#L157" title="include/linux/fs.h:157">dir_entry</a> *) dir_block-&gt;b_data;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; de-&gt;inode=inode-&gt;i_num;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../include/string.h.html#L27" title="include/string.h:27">strcpy</a>(de-&gt;name,<span class="Constant">&quot;.&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; de++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; de-&gt;inode = dir-&gt;i_num;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../include/string.h.html#L27" title="include/string.h:27">strcpy</a>(de-&gt;name,<span class="Constant">&quot;..&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; inode-&gt;i_nlinks = <span class="Constant">2</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; dir_block-&gt;b_dirt = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="buffer.c.html#L253" title="fs/buffer.c:253">brelse</a>(dir_block);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; inode-&gt;i_mode = <a href="../include/const.h.html#L7" title="include/const.h:7">I_DIRECTORY</a> | (mode &amp; <span class="PreProc">0</span><span class="Constant">777</span> &amp; ~<a href="../kernel/sched.c.html#L62" title="kernel/sched.c:62">current</a>-&gt;umask);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; inode-&gt;i_dirt = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; bh = <a href="#L165" title="fs/namei.c:165">add_entry</a>(dir,basename,namelen,&amp;de);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!bh) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(dir);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="bitmap.c.html#L47" title="fs/bitmap.c:47">free_block</a>(inode-&gt;i_dev,inode-&gt;i_zone[<span class="Constant">0</span>]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inode-&gt;i_nlinks=<span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(inode);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant"><a href="../include/errno.h.html#L47" title="include/errno.h:47">ENOSPC</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; de-&gt;inode = inode-&gt;i_num;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; bh-&gt;b_dirt = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; dir-&gt;i_nlinks++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; dir-&gt;i_dirt = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(dir);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(inode);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="buffer.c.html#L253" title="fs/buffer.c:253">brelse</a>(bh);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * routine to check that the specified directory is empty (for rmdir)<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li><a id="L543">&#x200c;</a></span><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">empty_dir</span>(<span class="Type">struct</span> <a href="../include/linux/fs.h.html#L93" title="include/linux/fs.h:93">m_inode</a> * inode)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> nr,block;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> len;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">struct</span> <a href="../include/linux/fs.h.html#L68" title="include/linux/fs.h:68">buffer_head</a> * bh;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">struct</span> <a href="../include/linux/fs.h.html#L157" title="include/linux/fs.h:157">dir_entry</a> * de;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; len = inode-&gt;i_size / <span class="Statement">sizeof</span> (<span class="Type">struct</span> <a href="../include/linux/fs.h.html#L157" title="include/linux/fs.h:157">dir_entry</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (len&lt;<span class="Constant">2</span> || !inode-&gt;i_zone[<span class="Constant">0</span>] ||<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; !(bh=<a href="buffer.c.html#L267" title="fs/buffer.c:267">bread</a>(inode-&gt;i_dev,inode-&gt;i_zone[<span class="Constant">0</span>]))) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../kernel/printk.c.html#L21" title="kernel/printk.c:21">printk</a>(<span class="Constant">&quot;warning - bad directory on dev </span><span class="Special">%04x\n</span><span class="Constant">&quot;</span>,inode-&gt;i_dev);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; de = (<span class="Type">struct</span> <a href="../include/linux/fs.h.html#L157" title="include/linux/fs.h:157">dir_entry</a> *) bh-&gt;b_data;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (de[<span class="Constant">0</span>].inode != inode-&gt;i_num || !de[<span class="Constant">1</span>].inode ||<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../include/string.h.html#L88" title="include/string.h:88">strcmp</a>(<span class="Constant">&quot;.&quot;</span>,de[<span class="Constant">0</span>].name) || <a href="../include/string.h.html#L88" title="include/string.h:88">strcmp</a>(<span class="Constant">&quot;..&quot;</span>,de[<span class="Constant">1</span>].name)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../kernel/printk.c.html#L21" title="kernel/printk.c:21">printk</a>(<span class="Constant">&quot;warning - bad directory on dev </span><span class="Special">%04x\n</span><span class="Constant">&quot;</span>,inode-&gt;i_dev);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; nr = <span class="Constant">2</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; de += <span class="Constant">2</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">while</span> (nr&lt;len) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((<span class="Type">void</span> *) de &gt;= (<span class="Type">void</span> *) (bh-&gt;b_data+<a href="../include/linux/fs.h.html#L49" title="include/linux/fs.h:49">BLOCK_SIZE</a>)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="buffer.c.html#L253" title="fs/buffer.c:253">brelse</a>(bh);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; block=<a href="inode.c.html#L140" title="fs/inode.c:140">bmap</a>(inode,nr/<a href="../include/linux/fs.h.html#L56" title="include/linux/fs.h:56">DIR_ENTRIES_PER_BLOCK</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!block) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; nr += <a href="../include/linux/fs.h.html#L56" title="include/linux/fs.h:56">DIR_ENTRIES_PER_BLOCK</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!(bh=<a href="buffer.c.html#L267" title="fs/buffer.c:267">bread</a>(inode-&gt;i_dev,block)))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; de = (<span class="Type">struct</span> <a href="../include/linux/fs.h.html#L157" title="include/linux/fs.h:157">dir_entry</a> *) bh-&gt;b_data;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (de-&gt;inode) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="buffer.c.html#L253" title="fs/buffer.c:253">brelse</a>(bh);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; de++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; nr++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="buffer.c.html#L253" title="fs/buffer.c:253">brelse</a>(bh);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">1</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L587">&#x200c;</a><span class="Type">int</span> <span class="linkable">sys_rmdir</span>(<span class="Type">const</span> <span class="Type">char</span> * name)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span> * basename;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> namelen;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">struct</span> <a href="../include/linux/fs.h.html#L93" title="include/linux/fs.h:93">m_inode</a> * dir, * inode;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">struct</span> <a href="../include/linux/fs.h.html#L68" title="include/linux/fs.h:68">buffer_head</a> * bh;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">struct</span> <a href="../include/linux/fs.h.html#L157" title="include/linux/fs.h:157">dir_entry</a> * de;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!<a href="../include/linux/kernel.h.html#L21" title="include/linux/kernel.h:21">suser</a>())<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant"><a href="../include/errno.h.html#L20" title="include/errno.h:20">EPERM</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!(dir = <a href="#L278" title="fs/namei.c:278">dir_namei</a>(name,&amp;namelen,&amp;basename)))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant"><a href="../include/errno.h.html#L21" title="include/errno.h:21">ENOENT</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!namelen) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(dir);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant"><a href="../include/errno.h.html#L21" title="include/errno.h:21">ENOENT</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!<a href="#L40" title="fs/namei.c:40">permission</a>(dir,<a href="#L30" title="fs/namei.c:30">MAY_WRITE</a>)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(dir);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant"><a href="../include/errno.h.html#L20" title="include/errno.h:20">EPERM</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; bh = <a href="#L91" title="fs/namei.c:91">find_entry</a>(&amp;dir,basename,namelen,&amp;de);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!bh) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(dir);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant"><a href="../include/errno.h.html#L21" title="include/errno.h:21">ENOENT</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!(inode = <a href="inode.c.html#L244" title="fs/inode.c:244">iget</a>(dir-&gt;i_dev, de-&gt;inode))) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(dir);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="buffer.c.html#L253" title="fs/buffer.c:253">brelse</a>(bh);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant"><a href="../include/errno.h.html#L20" title="include/errno.h:20">EPERM</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((dir-&gt;i_mode &amp; <a href="../include/sys/stat.h.html#L28" title="include/sys/stat.h:28">S_ISVTX</a>) &amp;&amp; <a href="../kernel/sched.c.html#L62" title="kernel/sched.c:62">current</a>-&gt;euid &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inode-&gt;i_uid != <a href="../kernel/sched.c.html#L62" title="kernel/sched.c:62">current</a>-&gt;euid) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(dir);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(inode);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="buffer.c.html#L253" title="fs/buffer.c:253">brelse</a>(bh);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant"><a href="../include/errno.h.html#L20" title="include/errno.h:20">EPERM</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (inode-&gt;i_dev != dir-&gt;i_dev || inode-&gt;i_count&gt;<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(dir);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(inode);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="buffer.c.html#L253" title="fs/buffer.c:253">brelse</a>(bh);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant"><a href="../include/errno.h.html#L20" title="include/errno.h:20">EPERM</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (inode == dir) {&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* we may not delete &quot;.&quot;, but &quot;../dir&quot; is ok */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(inode);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(dir);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="buffer.c.html#L253" title="fs/buffer.c:253">brelse</a>(bh);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant"><a href="../include/errno.h.html#L20" title="include/errno.h:20">EPERM</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!<a href="../include/sys/stat.h.html#L31" title="include/sys/stat.h:31">S_ISDIR</a>(inode-&gt;i_mode)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(inode);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(dir);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="buffer.c.html#L253" title="fs/buffer.c:253">brelse</a>(bh);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant"><a href="../include/errno.h.html#L39" title="include/errno.h:39">ENOTDIR</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!<a href="#L543" title="fs/namei.c:543">empty_dir</a>(inode)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(inode);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(dir);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="buffer.c.html#L253" title="fs/buffer.c:253">brelse</a>(bh);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant"><a href="../include/errno.h.html#L58" title="include/errno.h:58">ENOTEMPTY</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (inode-&gt;i_nlinks != <span class="Constant">2</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../kernel/printk.c.html#L21" title="kernel/printk.c:21">printk</a>(<span class="Constant">&quot;empty directory has nlink!=2 (</span><span class="Special">%d</span><span class="Constant">)&quot;</span>,inode-&gt;i_nlinks);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; de-&gt;inode = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; bh-&gt;b_dirt = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="buffer.c.html#L253" title="fs/buffer.c:253">brelse</a>(bh);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; inode-&gt;i_nlinks=<span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; inode-&gt;i_dirt=<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; dir-&gt;i_nlinks--;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; dir-&gt;i_ctime = dir-&gt;i_mtime = <a href="../include/linux/sched.h.html#L142" title="include/linux/sched.h:142">CURRENT_TIME</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; dir-&gt;i_dirt=<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(dir);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(inode);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L663">&#x200c;</a><span class="Type">int</span> <span class="linkable">sys_unlink</span>(<span class="Type">const</span> <span class="Type">char</span> * name)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span> * basename;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> namelen;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">struct</span> <a href="../include/linux/fs.h.html#L93" title="include/linux/fs.h:93">m_inode</a> * dir, * inode;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">struct</span> <a href="../include/linux/fs.h.html#L68" title="include/linux/fs.h:68">buffer_head</a> * bh;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">struct</span> <a href="../include/linux/fs.h.html#L157" title="include/linux/fs.h:157">dir_entry</a> * de;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!(dir = <a href="#L278" title="fs/namei.c:278">dir_namei</a>(name,&amp;namelen,&amp;basename)))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant"><a href="../include/errno.h.html#L21" title="include/errno.h:21">ENOENT</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!namelen) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(dir);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant"><a href="../include/errno.h.html#L21" title="include/errno.h:21">ENOENT</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!<a href="#L40" title="fs/namei.c:40">permission</a>(dir,<a href="#L30" title="fs/namei.c:30">MAY_WRITE</a>)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(dir);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant"><a href="../include/errno.h.html#L20" title="include/errno.h:20">EPERM</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; bh = <a href="#L91" title="fs/namei.c:91">find_entry</a>(&amp;dir,basename,namelen,&amp;de);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!bh) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(dir);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant"><a href="../include/errno.h.html#L21" title="include/errno.h:21">ENOENT</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!(inode = <a href="inode.c.html#L244" title="fs/inode.c:244">iget</a>(dir-&gt;i_dev, de-&gt;inode))) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(dir);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="buffer.c.html#L253" title="fs/buffer.c:253">brelse</a>(bh);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant"><a href="../include/errno.h.html#L21" title="include/errno.h:21">ENOENT</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((dir-&gt;i_mode &amp; <a href="../include/sys/stat.h.html#L28" title="include/sys/stat.h:28">S_ISVTX</a>) &amp;&amp; !<a href="../include/linux/kernel.h.html#L21" title="include/linux/kernel.h:21">suser</a>() &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../kernel/sched.c.html#L62" title="kernel/sched.c:62">current</a>-&gt;euid != inode-&gt;i_uid &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../kernel/sched.c.html#L62" title="kernel/sched.c:62">current</a>-&gt;euid != dir-&gt;i_uid) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(dir);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(inode);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="buffer.c.html#L253" title="fs/buffer.c:253">brelse</a>(bh);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant"><a href="../include/errno.h.html#L20" title="include/errno.h:20">EPERM</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../include/sys/stat.h.html#L31" title="include/sys/stat.h:31">S_ISDIR</a>(inode-&gt;i_mode)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(inode);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(dir);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="buffer.c.html#L253" title="fs/buffer.c:253">brelse</a>(bh);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant"><a href="../include/errno.h.html#L20" title="include/errno.h:20">EPERM</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!inode-&gt;i_nlinks) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../kernel/printk.c.html#L21" title="kernel/printk.c:21">printk</a>(<span class="Constant">&quot;Deleting nonexistent <a href="../include/linux/fs.h.html#L116" title="include/linux/fs.h:116">file</a> (</span><span class="Special">%04x</span><span class="Constant">:</span><span class="Special">%d</span><span class="Constant">), </span><span class="Special">%d\n</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inode-&gt;i_dev,inode-&gt;i_num,inode-&gt;i_nlinks);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inode-&gt;i_nlinks=<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; de-&gt;inode = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; bh-&gt;b_dirt = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="buffer.c.html#L253" title="fs/buffer.c:253">brelse</a>(bh);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; inode-&gt;i_nlinks--;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; inode-&gt;i_dirt = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; inode-&gt;i_ctime = <a href="../include/linux/sched.h.html#L142" title="include/linux/sched.h:142">CURRENT_TIME</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(inode);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(dir);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L721">&#x200c;</a><span class="Type">int</span> <span class="linkable">sys_link</span>(<span class="Type">const</span> <span class="Type">char</span> * oldname, <span class="Type">const</span> <span class="Type">char</span> * newname)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">struct</span> <a href="../include/linux/fs.h.html#L157" title="include/linux/fs.h:157">dir_entry</a> * de;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">struct</span> <a href="../include/linux/fs.h.html#L93" title="include/linux/fs.h:93">m_inode</a> * oldinode, * dir;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">struct</span> <a href="../include/linux/fs.h.html#L68" title="include/linux/fs.h:68">buffer_head</a> * bh;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span> * basename;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> namelen;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; oldinode=<a href="#L303" title="fs/namei.c:303">namei</a>(oldname);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!oldinode)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant"><a href="../include/errno.h.html#L21" title="include/errno.h:21">ENOENT</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../include/sys/stat.h.html#L31" title="include/sys/stat.h:31">S_ISDIR</a>(oldinode-&gt;i_mode)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(oldinode);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant"><a href="../include/errno.h.html#L20" title="include/errno.h:20">EPERM</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; dir = <a href="#L278" title="fs/namei.c:278">dir_namei</a>(newname,&amp;namelen,&amp;basename);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!dir) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(oldinode);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant"><a href="../include/errno.h.html#L32" title="include/errno.h:32">EACCES</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!namelen) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(oldinode);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(dir);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant"><a href="../include/errno.h.html#L20" title="include/errno.h:20">EPERM</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (dir-&gt;i_dev != oldinode-&gt;i_dev) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(dir);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(oldinode);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant"><a href="../include/errno.h.html#L37" title="include/errno.h:37">EXDEV</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!<a href="#L40" title="fs/namei.c:40">permission</a>(dir,<a href="#L30" title="fs/namei.c:30">MAY_WRITE</a>)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(dir);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(oldinode);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant"><a href="../include/errno.h.html#L32" title="include/errno.h:32">EACCES</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; bh = <a href="#L91" title="fs/namei.c:91">find_entry</a>(&amp;dir,basename,namelen,&amp;de);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (bh) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="buffer.c.html#L253" title="fs/buffer.c:253">brelse</a>(bh);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(dir);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(oldinode);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant"><a href="../include/errno.h.html#L36" title="include/errno.h:36">EEXIST</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; bh = <a href="#L165" title="fs/namei.c:165">add_entry</a>(dir,basename,namelen,&amp;de);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!bh) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(dir);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(oldinode);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant"><a href="../include/errno.h.html#L47" title="include/errno.h:47">ENOSPC</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; de-&gt;inode = oldinode-&gt;i_num;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; bh-&gt;b_dirt = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="buffer.c.html#L253" title="fs/buffer.c:253">brelse</a>(bh);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(dir);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; oldinode-&gt;i_nlinks++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; oldinode-&gt;i_ctime = <a href="../include/linux/sched.h.html#L142" title="include/linux/sched.h:142">CURRENT_TIME</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; oldinode-&gt;i_dirt = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="inode.c.html#L150" title="fs/inode.c:150">iput</a>(oldinode);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>}<br/></li>
</ol></code>
 </body>
</html>
