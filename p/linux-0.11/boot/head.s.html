<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>boot/head.s - linux-0.11-ebook</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

code {
    font-family: consolas, monospace;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
  <h3>boot/head.s - linux-0.11-ebook</h3>
   <a href="../index.html"> Table of Contents </a>

  <code><ol><li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> *&nbsp; linux/boot/<a href="../kernel/chr_drv/keyboard.S.html#L23" title="kernel/chr_drv/keyboard.S:23">head</a>.s<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *&nbsp; (C) 1991&nbsp; Linus Torvalds<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> *&nbsp; <a href="../kernel/chr_drv/keyboard.S.html#L23" title="kernel/chr_drv/keyboard.S:23">head</a>.s contains the 32-bit <a href="../kernel/chr_drv/rs_io.s.html#L27" title="kernel/chr_drv/rs_io.s:27">startup</a> code.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * NOTE!!! Startup happens at absolute address 0x00000000, which is also where<br/></li>
<li></span><span class="Comment"> * the page directory will exist. The <a href="../kernel/chr_drv/rs_io.s.html#L27" title="kernel/chr_drv/rs_io.s:27">startup</a> code will be overwritten by<br/></li>
<li></span><span class="Comment"> * the page directory.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Statement">.text<br/></li>
<li></span><span class="Statement">.globl</span> <span class="Identifier">_idt</span>,<span class="Identifier">_gdt</span>,<span class="Identifier">_pg_dir</span>,<span class="Identifier">_tmp_floppy_area</span>,<span class="Identifier">startup_32<br/></li>
<li></span><span class="Identifier">_pg_dir</span>:<br/></li>
<li><span class="Identifier">startup_32</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">movl</span> $<span class="Constant">0x10</span>,%<span class="Identifier">eax<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">mov</span> %<span class="Identifier">ax</span>,%<span class="Identifier">ds<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">mov</span> %<span class="Identifier">ax</span>,%<span class="Identifier">es<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">mov</span> %<span class="Identifier">ax</span>,%<span class="Identifier">fs<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">mov</span> %<span class="Identifier">ax</span>,%<span class="Identifier">gs<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">lss</span> <span class="Identifier">_stack_start</span>,%<span class="Identifier">esp<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">call</span> <span class="Identifier">setup_idt<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">call</span> <span class="Identifier">setup_gdt<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">movl</span> $<span class="Constant">0x10</span>,%<span class="Identifier">eax</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment"># reload all the segment registers<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">mov</span> %<span class="Identifier">ax</span>,%<span class="Identifier">ds</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment"># after changing gdt. <a href="../kernel/system_call.s.html#L43" title="kernel/system_call.s:43">CS</a> was already<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">mov</span> %<span class="Identifier">ax</span>,%<span class="Identifier">es</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment"># reloaded in 'setup_gdt'<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">mov</span> %<span class="Identifier">ax</span>,%<span class="Identifier">fs<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">mov</span> %<span class="Identifier">ax</span>,%<span class="Identifier">gs<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">lss</span> <span class="Identifier">_stack_start</span>,%<span class="Identifier">esp<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">xorl</span> %<span class="Identifier">eax</span>,%<span class="Identifier">eax<br/></li>
<li></span><span class="Constant">1</span>:&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">incl</span> %<span class="Identifier">eax</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment"># check that A20 really IS enabled<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">movl</span> %<span class="Identifier">eax</span>,<span class="Constant">0x000000</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment"># loop forever if it isn't<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">cmpl</span> %<span class="Identifier">eax</span>,<span class="Constant">0x100000<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">je</span> <span class="Constant">1</span><span class="Identifier">b<br/></li>
<li></span><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * NOTE! 486 should set bit 16, to check for write-protect in supervisor<br/></li>
<li></span><span class="Comment"> * mode. Then it would be unnecessary with the &quot;verify_area()&quot;-calls.<br/></li>
<li></span><span class="Comment"> * 486 users probably want to set the NE (#5) bit also, so as to use<br/></li>
<li></span><span class="Comment"> * int 16 for math errors.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">movl</span> %<span class="Identifier">cr0</span>,%<span class="Identifier">eax</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment"># check math chip<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">andl</span> $<span class="Constant">0x80000011</span>,%<span class="Identifier">eax</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment"># Save PG,PE,ET<br/></li>
<li></span><span class="Comment">/* &quot;orl $0x10020,%eax&quot; here for 486 might be good */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">orl</span> $<span class="Constant">2</span>,%<span class="Identifier">eax</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment"># set MP<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">movl</span> %<span class="Identifier">eax</span>,%<span class="Identifier">cr0<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">call</span> <span class="Identifier">check_x87<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">jmp</span> <span class="Identifier">after_page_tables<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * We depend on ET to be correct. This checks for 287/387.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Identifier">check_x87</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">fninit<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">fstsw</span> %<span class="Identifier">ax<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">cmpb</span> $<span class="Constant">0,</span>%<span class="Identifier">al<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">je</span> <span class="Constant">1</span><span class="Identifier">f</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* no coprocessor: have to set bits */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">movl</span> %<span class="Identifier">cr0</span>,%<span class="Identifier">eax<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">xorl</span> $<span class="Constant">6</span>,%<span class="Identifier">eax</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* reset MP, set EM */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">movl</span> %<span class="Identifier">eax</span>,%<span class="Identifier">cr0<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">ret<br/></li>
<li></span><span class="Statement">.align</span> <span class="Constant">4<br/></li>
<li></span><span class="Constant">1</span>:&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">.byte</span> <span class="Constant">0xDB</span>,<span class="Constant">0xE4</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* fsetpm for 287, ignored by 387 */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">ret<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> *&nbsp; setup_idt<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *&nbsp; sets up a idt with 256 entries pointing to<br/></li>
<li></span><span class="Comment"> *&nbsp; ignore_int, interrupt gates. It then loads<br/></li>
<li></span><span class="Comment"> *&nbsp; idt. Everything that wants to install itself<br/></li>
<li></span><span class="Comment"> *&nbsp; in the idt-table may do so themselves. Interrupts<br/></li>
<li></span><span class="Comment"> *&nbsp; are enabled elsewhere, when we can be relatively<br/></li>
<li></span><span class="Comment"> *&nbsp; sure everything is ok. This routine will be over-<br/></li>
<li></span><span class="Comment"> *&nbsp; written by the page tables.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Identifier">setup_idt</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">lea</span> <span class="Identifier">ignore_int</span>,%<span class="Identifier">edx<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">movl</span> $<span class="Constant">0x00080000</span>,%<span class="Identifier">eax<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">movw</span> %<span class="Identifier">dx</span>,%<span class="Identifier">ax</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* selector = 0x0008 = cs */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">movw</span> $<span class="Constant">0x8E00</span>,%<span class="Identifier">dx</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* interrupt gate - dpl=0, present */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">lea</span> <span class="Identifier">_idt</span>,%<span class="Identifier">edi<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">mov</span> $<span class="Constant">256</span>,%<span class="Identifier">ecx<br/></li>
<li></span><span class="Identifier">rp_sidt</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">movl</span> %<span class="Identifier">eax</span>,(%<span class="Identifier">edi</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">movl</span> %<span class="Identifier">edx</span>,<span class="Constant">4</span>(%<span class="Identifier">edi</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">addl</span> $<span class="Constant">8</span>,%<span class="Identifier">edi<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">dec</span> %<span class="Identifier">ecx<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">jne</span> <span class="Identifier">rp_sidt<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">lidt</span> <span class="Identifier">idt_descr<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">ret<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> *&nbsp; setup_gdt<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *&nbsp; This routines sets up a new gdt and loads it.<br/></li>
<li></span><span class="Comment"> *&nbsp; Only two entries are currently built, the same<br/></li>
<li></span><span class="Comment"> *&nbsp; ones that were built in init.s. The routine<br/></li>
<li></span><span class="Comment"> *&nbsp; is VERY complicated at two whole lines, so this<br/></li>
<li></span><span class="Comment"> *&nbsp; rather long comment is certainly needed :-).<br/></li>
<li></span><span class="Comment"> *&nbsp; This routine will beoverwritten by the page tables.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Identifier">setup_gdt</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">lgdt</span> <span class="Identifier">gdt_descr<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">ret<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * I put the kernel page tables right after the page directory,<br/></li>
<li></span><span class="Comment"> * using 4 of them to span 16 Mb of physical memory. People with<br/></li>
<li></span><span class="Comment"> * more than 16MB will have to expand this.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Statement">.org</span> <span class="Constant">0x1000<br/></li>
<li></span><span class="Identifier">pg0</span>:<br/></li>
<li><br/></li>
<li><span class="Statement">.org</span> <span class="Constant">0x2000<br/></li>
<li></span><span class="Identifier">pg1</span>:<br/></li>
<li><br/></li>
<li><span class="Statement">.org</span> <span class="Constant">0x3000<br/></li>
<li></span><span class="Identifier">pg2</span>:<br/></li>
<li><br/></li>
<li><span class="Statement">.org</span> <span class="Constant">0x4000<br/></li>
<li></span><span class="Identifier">pg3</span>:<br/></li>
<li><br/></li>
<li><span class="Statement">.org</span> <span class="Constant">0x5000<br/></li>
<li></span><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * tmp_floppy_area is used by the floppy-driver when DMA cannot<br/></li>
<li></span><span class="Comment"> * reach to a buffer-block. It needs to be aligned, so that it isn't<br/></li>
<li></span><span class="Comment"> * on a 64kB border.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Identifier">_tmp_floppy_area</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">.fill</span> <span class="Constant">1024</span>,<span class="Constant">1</span>,<span class="Constant">0<br/></li>
<li></span><br/></li>
<li><span class="Identifier">after_page_tables</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">pushl</span> $<span class="Constant">0&nbsp; &nbsp; &nbsp; &nbsp; </span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment"># These are the parameters to main :-)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">pushl</span> $<span class="Constant">0<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">pushl</span> $<span class="Constant">0<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">pushl</span> $<span class="Identifier">L6</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment"># return address for main, if it decides to.<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">pushl</span> $<span class="Identifier">_main<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">jmp</span> <span class="Identifier">setup_paging<br/></li>
<li></span><span class="Identifier">L6</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">jmp</span> <span class="Identifier">L6</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment"># main should never return here, but<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment"># just in case, we know what happens.<br/></li>
<li></span><br/></li>
<li><span class="Comment">/* This is the default interrupt &quot;handler&quot; :-) */<br/></li>
<li></span><span class="Identifier">int_msg</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">.asciz</span> &quot;<span class="Identifier">Unknown</span> <span class="Identifier">interrupt</span>\<span class="Identifier">n</span>\<span class="Identifier">r</span>&quot;<br/></li>
<li><span class="Statement">.align</span> <span class="Constant">4<br/></li>
<li></span><span class="Identifier">ignore_int</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">pushl</span> %<span class="Identifier">eax<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">pushl</span> %<span class="Identifier">ecx<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">pushl</span> %<span class="Identifier">edx<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier"><a href="bootsect.s.html#L202" title="boot/bootsect.s:202">push</a></span> %<span class="Identifier">ds<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier"><a href="bootsect.s.html#L202" title="boot/bootsect.s:202">push</a></span> %<span class="Identifier">es<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier"><a href="bootsect.s.html#L202" title="boot/bootsect.s:202">push</a></span> %<span class="Identifier">fs<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">movl</span> $<span class="Constant">0x10</span>,%<span class="Identifier">eax<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">mov</span> %<span class="Identifier">ax</span>,%<span class="Identifier">ds<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">mov</span> %<span class="Identifier">ax</span>,%<span class="Identifier">es<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">mov</span> %<span class="Identifier">ax</span>,%<span class="Identifier">fs<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">pushl</span> $<span class="Identifier">int_msg<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">call</span> <span class="Identifier">_printk<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">popl</span> %<span class="Identifier">eax<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier"><a href="bootsect.s.html#L214" title="boot/bootsect.s:214">pop</a></span> %<span class="Identifier">fs<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier"><a href="bootsect.s.html#L214" title="boot/bootsect.s:214">pop</a></span> %<span class="Identifier">es<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier"><a href="bootsect.s.html#L214" title="boot/bootsect.s:214">pop</a></span> %<span class="Identifier">ds<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">popl</span> %<span class="Identifier">edx<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">popl</span> %<span class="Identifier">ecx<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">popl</span> %<span class="Identifier">eax<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">iret<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Setup_paging<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * This routine sets up paging by setting the page bit<br/></li>
<li></span><span class="Comment"> * in cr0. The page tables are set up, identity-mapping<br/></li>
<li></span><span class="Comment"> * the first 16MB. The pager assumes that no illegal<br/></li>
<li></span><span class="Comment"> * addresses are produced (ie &gt;4Mb on a 4Mb machine).<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * NOTE! Although all physical memory should be identity<br/></li>
<li></span><span class="Comment"> * mapped by this routine, only the kernel page functions<br/></li>
<li></span><span class="Comment"> * use the &gt;1Mb addresses directly. All &quot;normal&quot; functions<br/></li>
<li></span><span class="Comment"> * use just the lower 1Mb, or the local data space, which<br/></li>
<li></span><span class="Comment"> * will be mapped to some other place - mm keeps track of<br/></li>
<li></span><span class="Comment"> * that.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * For those with more memory than 16 Mb - tough luck. I've<br/></li>
<li></span><span class="Comment"> * not got it, why should you :-) The source is here. Change<br/></li>
<li></span><span class="Comment"> * it. (Seriously - it shouldn't be too difficult. Mostly<br/></li>
<li></span><span class="Comment"> * change some constants etc. I left it at 16Mb, as my machine<br/></li>
<li></span><span class="Comment"> * even cannot be extended past that (ok, but it was cheap :-)<br/></li>
<li></span><span class="Comment"> * I've tried to show which constants to change by having<br/></li>
<li></span><span class="Comment"> * some kind of marker at them (search for &quot;16Mb&quot;), but I<br/></li>
<li></span><span class="Comment"> * won't guarantee that's all :-( )<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Statement">.align</span> <span class="Constant">4<br/></li>
<li></span><span class="Identifier">setup_paging</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">movl</span> $<span class="Constant">1024</span>*<span class="Constant">5</span>,%<span class="Identifier">ecx</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* 5 pages - pg_dir+4 page tables */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">xorl</span> %<span class="Identifier">eax</span>,%<span class="Identifier">eax<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">xorl</span> %<span class="Identifier">edi</span>,%<span class="Identifier">edi</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* pg_dir is at 0x000 */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">cld</span><span class="Comment">;rep;stosl<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">movl</span> $<span class="Identifier">pg0</span>+<span class="Constant">7</span>,<span class="Identifier">_pg_dir</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* set present bit/user r/w */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">movl</span> $<span class="Identifier">pg1</span>+<span class="Constant">7</span>,<span class="Identifier">_pg_dir</span>+<span class="Constant">4</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*&nbsp; --------- &quot; &quot; --------- */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">movl</span> $<span class="Identifier">pg2</span>+<span class="Constant">7</span>,<span class="Identifier">_pg_dir</span>+<span class="Constant">8</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*&nbsp; --------- &quot; &quot; --------- */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">movl</span> $<span class="Identifier">pg3</span>+<span class="Constant">7</span>,<span class="Identifier">_pg_dir</span>+<span class="Constant">12</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*&nbsp; --------- &quot; &quot; --------- */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">movl</span> $<span class="Identifier">pg3</span>+<span class="Constant">4092</span>,%<span class="Identifier">edi<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">movl</span> $<span class="Constant">0xfff007</span>,%<span class="Identifier">eax</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*&nbsp; 16Mb - 4096 + 7 (r/w user,p) */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">std<br/></li>
<li></span><span class="Constant">1</span>:&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">stosl</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* fill pages backwards - more efficient :-) */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">subl</span> $<span class="Constant">0x1000</span>,%<span class="Identifier">eax<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">jge</span> <span class="Constant">1</span><span class="Identifier">b<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">xorl</span> %<span class="Identifier">eax</span>,%<span class="Identifier">eax</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* pg_dir is at 0x0000 */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">movl</span> %<span class="Identifier">eax</span>,%<span class="Identifier">cr3</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* cr3 - page directory start */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">movl</span> %<span class="Identifier">cr0</span>,%<span class="Identifier">eax<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">orl</span> $<span class="Constant">0x80000000</span>,%<span class="Identifier">eax<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">movl</span> %<span class="Identifier">eax</span>,%<span class="Identifier">cr0</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* set paging (PG) bit */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">ret</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* this also flushes prefetch-queue */<br/></li>
<li></span><br/></li>
<li><span class="Statement">.align</span> <span class="Constant">4<br/></li>
<li></span><span class="Statement">.word</span> <span class="Constant">0<br/></li>
<li></span><span class="Identifier">idt_descr</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">.word</span> <span class="Constant">256</span>*<span class="Constant">8</span>-<span class="Constant">1</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment"># idt contains 256 entries<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">.long</span> <span class="Identifier">_idt<br/></li>
<li></span><span class="Statement">.align</span> <span class="Constant">4<br/></li>
<li></span><span class="Statement">.word</span> <span class="Constant">0<br/></li>
<li></span><span class="Identifier">gdt_descr</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">.word</span> <span class="Constant">256</span>*<span class="Constant">8</span>-<span class="Constant">1</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment"># so does gdt (not that that's any<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">.long</span> <span class="Identifier">_gdt</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment"># magic number, but it works for me :^)<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">.align</span> <span class="Constant">8<br/></li>
<li></span><span class="Identifier">_idt</span>:&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">.fill</span> <span class="Constant">256</span>,<span class="Constant">8</span>,<span class="Constant">0&nbsp; &nbsp; &nbsp; &nbsp; </span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment"># idt is uninitialized<br/></li>
<li></span><br/></li>
<li><span class="Identifier">_gdt</span>:&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">.quad</span> <span class="Constant">0x0000000000000000</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* NULL descriptor */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">.quad</span> <span class="Constant">0x00c09a0000000fff</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* 16Mb */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">.quad</span> <span class="Constant">0x00c0920000000fff</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* 16Mb */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">.quad</span> <span class="Constant">0x0000000000000000</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* TEMPORARY - don't use */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">.fill</span> <span class="Constant">252</span>,<span class="Constant">8</span>,<span class="Constant">0&nbsp; &nbsp; &nbsp; &nbsp; </span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* space for LDT's and TSS's etc */<br/></li>
</ol></span></code>
 </body>
</html>
