<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>boot/setup.s - linux-0.11-ebook</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

code {
    font-family: consolas, monospace;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
  <h3>boot/setup.s - linux-0.11-ebook</h3>
   <a href="../index.html"> Table of Contents </a>
 <h4>Macros defined</h4>
 <ul>
<li><a href="#L17">INITSEG</a></li>
<li><a href="#L19">SETUPSEG</a></li>
<li><a href="#L18">SYSSEG</a></li>
</ul>
 <h4>Source code</h4>

  <code><ol><li><span class="Comment">!<br/></li>
<li></span><span class="Comment">!&nbsp; &nbsp; &nbsp; &nbsp; setup.s&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (C) 1991 Linus Torvalds<br/></li>
<li></span><span class="Comment">!<br/></li>
<li></span><span class="Comment">! setup.s is responsible for getting the system data from the BIOS,<br/></li>
<li></span><span class="Comment">! and putting them into the appropriate places in system memory.<br/></li>
<li></span><span class="Comment">! both setup.s and system has been loaded by the bootblock.<br/></li>
<li></span><span class="Comment">!<br/></li>
<li></span><span class="Comment">! This code asks the bios for memory/disk/other parameters, and<br/></li>
<li></span><span class="Comment">! puts them in a &quot;safe&quot; place: 0x90000-0x901FF, ie where the<br/></li>
<li></span><span class="Comment">! boot-block used to be. It is then up to the protected mode<br/></li>
<li></span><span class="Comment">! system to read them from there before the area is overwritten<br/></li>
<li></span><span class="Comment">! for buffer-blocks.<br/></li>
<li></span><span class="Comment">!<br/></li>
<li></span><br/></li>
<li><span class="Comment">! NOTE! These had better be the same as in bootsect.s!<br/></li>
<li></span><br/></li>
<li><a id="L17">&#x200c;</a><span class="Identifier"><span class="linkable">INITSEG</span></span>&nbsp; = <span class="Constant">0x9000</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">! we move boot here - out of the way<br/></li>
<li><a id="L18">&#x200c;</a></span><span class="Identifier"><span class="linkable">SYSSEG</span></span>&nbsp;&nbsp; = <span class="Constant">0x1000</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">! system loaded at 0x10000 (65536).<br/></li>
<li><a id="L19">&#x200c;</a></span><span class="Identifier"><span class="linkable">SETUPSEG</span></span> = <span class="Constant">0x9020</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">! this is the current segment<br/></li>
<li></span><br/></li>
<li><span class="Statement">.globl</span> <span class="Identifier">begtext</span>, <span class="Identifier">begdata</span>, <span class="Identifier">begbss</span>, <span class="Identifier">endtext</span>, <span class="Identifier">enddata</span>, <span class="Identifier">endbss<br/></li>
<li></span><span class="Statement">.text<br/></li>
<li></span><span class="Identifier">begtext</span>:<br/></li>
<li><span class="Statement">.data<br/></li>
<li></span><span class="Identifier">begdata</span>:<br/></li>
<li><span class="Statement">.bss<br/></li>
<li></span><span class="Identifier">begbss</span>:<br/></li>
<li><span class="Statement">.text<br/></li>
<li></span><br/></li>
<li><span class="Identifier">entry</span> <span class="Identifier">start<br/></li>
<li></span><span class="Identifier">start</span>:<br/></li>
<li><br/></li>
<li><span class="Comment">! ok, the read went well so we get current cursor position and save it for<br/></li>
<li></span><span class="Comment">! posterity.<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">mov</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">ax</span>,<span class="Comment">#<a href="bootsect.s.html#L36" title="boot/bootsect.s:36">INITSEG</a>&nbsp; &nbsp; &nbsp; &nbsp; ! this is done in bootsect already, but...<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">mov</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">ds</span>,<span class="Identifier">ax<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">mov</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">ah</span>,<span class="Comment">#0x03&nbsp; &nbsp; &nbsp; &nbsp; ! read cursor pos<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">xor</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">bh</span>,<span class="Identifier">bh<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">int</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">0x10</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">! save it in known place, con_init fetches<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">mov</span>&nbsp; &nbsp; &nbsp; &nbsp; [0],<span class="Identifier">dx</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">! it from 0x90000.<br/></li>
<li></span><br/></li>
<li><span class="Comment">! Get memory <a href="../kernel/chr_drv/keyboard.S.html#L21" title="kernel/chr_drv/keyboard.S:21">size</a> (extended mem, kB)<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">mov</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">ah</span>,<span class="Comment">#0x88<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">int</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">0x15<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">mov</span>&nbsp; &nbsp; &nbsp; &nbsp; [<span class="Constant">2</span>],<span class="Identifier">ax<br/></li>
<li></span><br/></li>
<li><span class="Comment">! Get video-card data:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">mov</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">ah</span>,<span class="Comment">#0x0f<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">int</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">0x10<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">mov</span>&nbsp; &nbsp; &nbsp; &nbsp; [<span class="Constant">4</span>],<span class="Identifier">bx</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">! bh = display page<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">mov</span>&nbsp; &nbsp; &nbsp; &nbsp; [<span class="Constant">6</span>],<span class="Identifier">ax</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">! al = video mode, ah = window width<br/></li>
<li></span><br/></li>
<li><span class="Comment">! check for EGA/VGA and some config parameters<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">mov</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">ah</span>,<span class="Comment">#0x12<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">mov</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">bl</span>,<span class="Comment">#0x10<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">int</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">0x10<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">mov</span>&nbsp; &nbsp; &nbsp; &nbsp; [<span class="Constant">8</span>],<span class="Identifier">ax<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">mov</span>&nbsp; &nbsp; &nbsp; &nbsp; [<span class="Constant">10</span>],<span class="Identifier">bx<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">mov</span>&nbsp; &nbsp; &nbsp; &nbsp; [<span class="Constant">12</span>],<span class="Identifier">cx<br/></li>
<li></span><br/></li>
<li><span class="Comment">! Get hd0 data<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">mov</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">ax</span>,<span class="Comment">#0x0000<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">mov</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">ds</span>,<span class="Identifier">ax<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">lds</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">si</span>,[<span class="Constant">4</span>*<span class="Constant">0x41</span>]<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">mov</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">ax</span>,<span class="Comment">#<a href="bootsect.s.html#L36" title="boot/bootsect.s:36">INITSEG</a><br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">mov</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">es</span>,<span class="Identifier">ax<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">mov</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">di</span>,<span class="Comment">#0x0080<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">mov</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">cx</span>,<span class="Comment">#0x10<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">rep<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">movsb<br/></li>
<li></span><br/></li>
<li><span class="Comment">! Get hd1 data<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">mov</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">ax</span>,<span class="Comment">#0x0000<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">mov</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">ds</span>,<span class="Identifier">ax<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">lds</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">si</span>,[<span class="Constant">4</span>*<span class="Constant">0x46</span>]<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">mov</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">ax</span>,<span class="Comment">#<a href="bootsect.s.html#L36" title="boot/bootsect.s:36">INITSEG</a><br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">mov</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">es</span>,<span class="Identifier">ax<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">mov</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">di</span>,<span class="Comment">#0x0090<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">mov</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">cx</span>,<span class="Comment">#0x10<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">rep<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">movsb<br/></li>
<li></span><br/></li>
<li><span class="Comment">! Check that there IS a hd1 :-)<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">mov</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">ax</span>,<span class="Comment">#0x01500<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">mov</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">dl</span>,<span class="Comment">#0x81<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">int</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">0x13<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">jc</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">no_disk1<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">cmp</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">ah</span>,<span class="Comment">#3<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">je</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">is_disk1<br/></li>
<li></span><span class="Identifier">no_disk1</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">mov</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">ax</span>,<span class="Comment">#<a href="bootsect.s.html#L36" title="boot/bootsect.s:36">INITSEG</a><br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">mov</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">es</span>,<span class="Identifier">ax<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">mov</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">di</span>,<span class="Comment">#0x0090<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">mov</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">cx</span>,<span class="Comment">#0x10<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">mov</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">ax</span>,<span class="Comment">#0x00<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">rep<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">stosb<br/></li>
<li></span><span class="Identifier">is_disk1</span>:<br/></li>
<li><br/></li>
<li><span class="Comment">! now we want to move to protected mode ...<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">cli</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">! no interrupts allowed !<br/></li>
<li></span><br/></li>
<li><span class="Comment">! first we move the system to it's rightful place<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">mov</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">ax</span>,<span class="Comment">#0x0000<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">cld</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">! 'direction'=0, movs moves forward<br/></li>
<li></span><span class="Identifier">do_move</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">mov</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">es</span>,<span class="Identifier">ax</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">! destination segment<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">add</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">ax</span>,<span class="Comment">#0x1000<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">cmp</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">ax</span>,<span class="Comment">#0x9000<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">jz</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">end_move<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">mov</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">ds</span>,<span class="Identifier">ax</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">! source segment<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">sub</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">di</span>,<span class="Identifier">di<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">sub</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">si</span>,<span class="Identifier">si<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">mov</span>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Identifier">cx</span>,<span class="Comment">#0x8000<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">rep<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">movsw<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">jmp</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">do_move<br/></li>
<li></span><br/></li>
<li><span class="Comment">! then we load the segment descriptors<br/></li>
<li></span><br/></li>
<li><span class="Identifier">end_move</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">mov</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">ax</span>,<span class="Comment">#<a href="bootsect.s.html#L37" title="boot/bootsect.s:37">SETUPSEG</a>&nbsp; &nbsp; &nbsp; &nbsp; ! right, forgot this at first. didn't work :-)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">mov</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">ds</span>,<span class="Identifier">ax<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">lidt</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">idt_48</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">! load idt with 0,0<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">lgdt</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">gdt_48</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">! load gdt with whatever appropriate<br/></li>
<li></span><br/></li>
<li><span class="Comment">! that was painless, now we enable A20<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">call</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">empty_8042<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">mov</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">al</span>,<span class="Comment">#0xD1&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ! command write<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">out</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">#0x64,al<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">call</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">empty_8042<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">mov</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">al</span>,<span class="Comment">#0xDF&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ! A20 on<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">out</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">#0x60,al<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">call</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">empty_8042<br/></li>
<li></span><br/></li>
<li><span class="Comment">! well, that went ok, I hope. Now we have to reprogram the interrupts :-(<br/></li>
<li></span><span class="Comment">! we put them right after the intel-reserved hardware interrupts, at<br/></li>
<li></span><span class="Comment">! int 0x20-0x2F. There they won't mess up anything. Sadly IBM really<br/></li>
<li></span><span class="Comment">! messed this up with the original PC, and they haven't been able to<br/></li>
<li></span><span class="Comment">! rectify it afterwards. Thus the bios puts interrupts at 0x08-0x0f,<br/></li>
<li></span><span class="Comment">! which is used for the internal hardware interrupts as well. We just<br/></li>
<li></span><span class="Comment">! have to reprogram the 8259's, and it isn't fun.<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">mov</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">al</span>,<span class="Comment">#0x11&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ! initialization sequence<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">out</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">#0x20,al&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ! send it to 8259A-1<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">.word</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">0x00eb</span>,<span class="Constant">0x00eb</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">! jmp $+2, jmp $+2<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">out</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">#0xA0,al&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ! and to 8259A-2<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">.word</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">0x00eb</span>,<span class="Constant">0x00eb<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">mov</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">al</span>,<span class="Comment">#0x20&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ! start of hardware int's (0x20)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">out</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">#0x21,al<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">.word</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">0x00eb</span>,<span class="Constant">0x00eb<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">mov</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">al</span>,<span class="Comment">#0x28&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ! start of hardware int's 2 (0x28)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">out</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">#0xA1,al<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">.word</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">0x00eb</span>,<span class="Constant">0x00eb<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">mov</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">al</span>,<span class="Comment">#0x04&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ! 8259-1 is master<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">out</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">#0x21,al<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">.word</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">0x00eb</span>,<span class="Constant">0x00eb<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">mov</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">al</span>,<span class="Comment">#0x02&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ! 8259-2 is slave<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">out</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">#0xA1,al<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">.word</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">0x00eb</span>,<span class="Constant">0x00eb<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">mov</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">al</span>,<span class="Comment">#0x01&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ! 8086 mode for both<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">out</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">#0x21,al<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">.word</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">0x00eb</span>,<span class="Constant">0x00eb<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">out</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">#0xA1,al<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">.word</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">0x00eb</span>,<span class="Constant">0x00eb<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">mov</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">al</span>,<span class="Comment">#0xFF&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ! mask off all interrupts for now<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">out</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">#0x21,al<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">.word</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">0x00eb</span>,<span class="Constant">0x00eb<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">out</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">#0xA1,al<br/></li>
<li></span><br/></li>
<li><span class="Comment">! well, that certainly wasn't fun :-(. Hopefully it works, and we don't<br/></li>
<li></span><span class="Comment">! need no steenking BIOS anyway (except for the initial loading :-).<br/></li>
<li></span><span class="Comment">! The BIOS-routine wants lots of unnecessary data, and it's less<br/></li>
<li></span><span class="Comment">! &quot;interesting&quot; anyway. This is how REAL programmers do it.<br/></li>
<li></span><span class="Comment">!<br/></li>
<li></span><span class="Comment">! Well, now's the time to actually move into protected mode. To make<br/></li>
<li></span><span class="Comment">! things as simple as possible, we do no register set-up or anything,<br/></li>
<li></span><span class="Comment">! we let the gnu-compiled 32-bit programs do that. We just jump to<br/></li>
<li></span><span class="Comment">! absolute address 0x00000, in 32-bit protected mode.<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">mov</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">ax</span>,<span class="Comment">#0x0001&nbsp; &nbsp; &nbsp; &nbsp; ! protected mode (PE) bit<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">lmsw</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">ax</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">! This is it!<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">jmpi</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">0,8</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">! jmp offset 0 of segment 8 (cs)<br/></li>
<li></span><br/></li>
<li><span class="Comment">! This routine checks that the keyboard command queue is empty<br/></li>
<li></span><span class="Comment">! No timeout is used - if this hangs there is something wrong with<br/></li>
<li></span><span class="Comment">! the machine, and we probably couldn't proceed anyway.<br/></li>
<li></span><span class="Identifier">empty_8042</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">.word</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">0x00eb</span>,<span class="Constant">0x00eb<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">in</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">al</span>,<span class="Comment">#0x64&nbsp; &nbsp; &nbsp; &nbsp; ! 8042 status port<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">test</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">al</span>,<span class="Comment">#2&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ! is input buffer full?<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">jnz</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">empty_8042</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">! yes - loop<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">ret<br/></li>
<li></span><br/></li>
<li><span class="Identifier">gdt</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">.word</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">0,0,0,0&nbsp; &nbsp; &nbsp; &nbsp; </span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">! dummy<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">.word</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">0x07FF</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">! 8Mb - limit=2047 (2048*4096=8Mb)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">.word</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">0x0000</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">! base address=0<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">.word</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">0x9A00</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">! code read/exec<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">.word</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">0x00C0</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">! granularity=4096, 386<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">.word</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">0x07FF</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">! 8Mb - limit=2047 (2048*4096=8Mb)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">.word</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">0x0000</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">! base address=0<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">.word</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">0x9200</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">! data read/write<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">.word</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">0x00C0</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">! granularity=4096, 386<br/></li>
<li></span><br/></li>
<li><span class="Identifier">idt_48</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">.word</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">0&nbsp; &nbsp; &nbsp; &nbsp; </span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">! idt limit=0<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">.word</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">0,0&nbsp; &nbsp; &nbsp; &nbsp; </span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">! idt base=0L<br/></li>
<li></span><br/></li>
<li><span class="Identifier">gdt_48</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">.word</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">0x800</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">! gdt limit=2048, 256 GDT entries<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">.word</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">512</span>+<span class="Identifier">gdt</span>,<span class="Constant">0x9</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">! gdt base = 0X9xxxx<br/></li>
<li></span><br/></li>
<li><span class="Statement">.text<br/></li>
<li></span><span class="Identifier">endtext</span>:<br/></li>
<li><span class="Statement">.data<br/></li>
<li></span><span class="Identifier">enddata</span>:<br/></li>
<li><span class="Statement">.bss<br/></li>
<li></span><span class="Identifier">endbss</span>:<br/></li>
</ol></code>
 </body>
</html>
