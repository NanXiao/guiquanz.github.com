<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>kernel/signal.c - linux-0.11-ebook</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

code {
    font-family: consolas, monospace;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
  <h3>kernel/signal.c - linux-0.11-ebook</h3>
   <a href="../index.html"> Table of Contents </a>
 <h4>Functions defined</h4>
 <ul>
<li><a href="#L82">do_signal</a></li>
<li><a href="#L40">get_new</a></li>
<li><a href="#L28">save_old</a></li>
<li><a href="#L15">sys_sgetmask</a></li>
<li><a href="#L63">sys_sigaction</a></li>
<li><a href="#L48">sys_signal</a></li>
<li><a href="#L20">sys_ssetmask</a></li>
</ul>
 <h4>Source code</h4>

  <code><ol><li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> *&nbsp; linux/kernel/signal.c<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *&nbsp; (C) 1991&nbsp; Linus Torvalds<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;linux/sched.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;linux/kernel.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;asm/segment.h&gt;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;signal.h&gt;<br/></li>
<li></span><br/></li>
<li><span class="Type">volatile</span> <span class="Type">void</span> <a href="exit.c.html#L102" title="kernel/exit.c:102">do_exit</a>(<span class="Type">int</span> error_code);<br/></li>
<li><br/></li>
<li><a id="L15">&#x200c;</a><span class="Type">int</span> <span class="linkable">sys_sgetmask</span>()<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="sched.c.html#L62" title="kernel/sched.c:62">current</a>-&gt;blocked;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L20">&#x200c;</a><span class="Type">int</span> <span class="linkable">sys_ssetmask</span>(<span class="Type">int</span> newmask)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> old=<a href="sched.c.html#L62" title="kernel/sched.c:62">current</a>-&gt;blocked;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="sched.c.html#L62" title="kernel/sched.c:62">current</a>-&gt;blocked = newmask &amp; ~(<span class="Constant">1</span>&lt;&lt;(<span class="Constant"><a href="../include/signal.h.html#L21" title="include/signal.h:21">SIGKILL</a></span>-<span class="Constant">1</span>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> old;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L28">&#x200c;</a><span class="Type">static</span> <span class="Type"><a href="../lib/string.c.html#L12" title="lib/string.c:12">inline</a></span> <span class="Type">void</span> <span class="linkable">save_old</span>(<span class="Type">char</span> * from,<span class="Type">char</span> * to)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> i;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="fork.c.html#L24" title="kernel/fork.c:24">verify_area</a>(to, <span class="Statement">sizeof</span>(<span class="Type">struct</span> <a href="../include/signal.h.html#L48" title="include/signal.h:48">sigaction</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (i=<span class="Constant">0</span> ; i&lt; <span class="Statement">sizeof</span>(<span class="Type">struct</span> <a href="../include/signal.h.html#L48" title="include/signal.h:48">sigaction</a>) ; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../include/asm/segment.h.html#L25" title="include/asm/segment.h:25">put_fs_byte</a>(*from,to);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; from++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; to++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L40">&#x200c;</a><span class="Type">static</span> <span class="Type"><a href="../lib/string.c.html#L12" title="lib/string.c:12">inline</a></span> <span class="Type">void</span> <span class="linkable">get_new</span>(<span class="Type">char</span> * from,<span class="Type">char</span> * to)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> i;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (i=<span class="Constant">0</span> ; i&lt; <span class="Statement">sizeof</span>(<span class="Type">struct</span> <a href="../include/signal.h.html#L48" title="include/signal.h:48">sigaction</a>) ; i++)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *(to++) = <a href="../include/asm/segment.h.html#L1" title="include/asm/segment.h:1">get_fs_byte</a>(from++);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L48">&#x200c;</a><span class="Type">int</span> <span class="linkable">sys_signal</span>(<span class="Type">int</span> signum, <span class="Type">long</span> handler, <span class="Type">long</span> restorer)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">struct</span> <a href="../include/signal.h.html#L48" title="include/signal.h:48">sigaction</a> tmp;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (signum&lt;<span class="Constant">1</span> || signum&gt;<span class="Constant">32</span> || signum==<span class="Constant"><a href="../include/signal.h.html#L21" title="include/signal.h:21">SIGKILL</a></span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; tmp.sa_handler = (<span class="Type">void</span> (*)(<span class="Type">int</span>)) handler;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; tmp.sa_mask = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; tmp.sa_flags = <a href="../include/signal.h.html#L39" title="include/signal.h:39">SA_ONESHOT</a> | <a href="../include/signal.h.html#L38" title="include/signal.h:38">SA_NOMASK</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; tmp.sa_restorer = (<span class="Type">void</span> (*)(<span class="Type">void</span>)) restorer;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; handler = (<span class="Type">long</span>) <a href="sched.c.html#L62" title="kernel/sched.c:62">current</a>-&gt;<a href="../include/signal.h.html#L48" title="include/signal.h:48">sigaction</a>[signum-<span class="Constant">1</span>].sa_handler;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="sched.c.html#L62" title="kernel/sched.c:62">current</a>-&gt;<a href="../include/signal.h.html#L48" title="include/signal.h:48">sigaction</a>[signum-<span class="Constant">1</span>] = tmp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> handler;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L63">&#x200c;</a><span class="Type">int</span> <span class="linkable">sys_sigaction</span>(<span class="Type">int</span> signum, <span class="Type">const</span> <span class="Type">struct</span> <a href="../include/signal.h.html#L48" title="include/signal.h:48">sigaction</a> * action,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">struct</span> <a href="../include/signal.h.html#L48" title="include/signal.h:48">sigaction</a> * oldaction)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">struct</span> <a href="../include/signal.h.html#L48" title="include/signal.h:48">sigaction</a> tmp;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (signum&lt;<span class="Constant">1</span> || signum&gt;<span class="Constant">32</span> || signum==<span class="Constant"><a href="../include/signal.h.html#L21" title="include/signal.h:21">SIGKILL</a></span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; tmp = <a href="sched.c.html#L62" title="kernel/sched.c:62">current</a>-&gt;<a href="../include/signal.h.html#L48" title="include/signal.h:48">sigaction</a>[signum-<span class="Constant">1</span>];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L40" title="kernel/signal.c:40">get_new</a>((<span class="Type">char</span> *) action,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<span class="Type">char</span> *) (signum-<span class="Constant">1</span>+<a href="sched.c.html#L62" title="kernel/sched.c:62">current</a>-&gt;<a href="../include/signal.h.html#L48" title="include/signal.h:48">sigaction</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (oldaction)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L28" title="kernel/signal.c:28">save_old</a>((<span class="Type">char</span> *) &amp;tmp,(<span class="Type">char</span> *) oldaction);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="sched.c.html#L62" title="kernel/sched.c:62">current</a>-&gt;<a href="../include/signal.h.html#L48" title="include/signal.h:48">sigaction</a>[signum-<span class="Constant">1</span>].sa_flags &amp; <a href="../include/signal.h.html#L38" title="include/signal.h:38">SA_NOMASK</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="sched.c.html#L62" title="kernel/sched.c:62">current</a>-&gt;<a href="../include/signal.h.html#L48" title="include/signal.h:48">sigaction</a>[signum-<span class="Constant">1</span>].sa_mask = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="sched.c.html#L62" title="kernel/sched.c:62">current</a>-&gt;<a href="../include/signal.h.html#L48" title="include/signal.h:48">sigaction</a>[signum-<span class="Constant">1</span>].sa_mask |= (<span class="Constant">1</span>&lt;&lt;(signum-<span class="Constant">1</span>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L82">&#x200c;</a><span class="Type">void</span> <span class="linkable">do_signal</span>(<span class="Type">long</span> signr,<span class="Type">long</span> eax, <span class="Type">long</span> ebx, <span class="Type">long</span> ecx, <span class="Type">long</span> edx,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">long</span> fs, <span class="Type">long</span> es, <span class="Type">long</span> ds,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">long</span> eip, <span class="Type">long</span> cs, <span class="Type">long</span> eflags,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">unsigned</span> <span class="Type">long</span> * esp, <span class="Type">long</span> ss)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">unsigned</span> <span class="Type">long</span> sa_handler;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">long</span> old_eip=eip;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">struct</span> <a href="../include/signal.h.html#L48" title="include/signal.h:48">sigaction</a> * sa = <a href="sched.c.html#L62" title="kernel/sched.c:62">current</a>-&gt;<a href="../include/signal.h.html#L48" title="include/signal.h:48">sigaction</a> + signr - <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> longs;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">unsigned</span> <span class="Type">long</span> * tmp_esp;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; sa_handler = (<span class="Type">unsigned</span> <span class="Type">long</span>) sa-&gt;sa_handler;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (sa_handler==<span class="Constant">1</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!sa_handler) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (signr==<span class="Constant"><a href="../include/signal.h.html#L29" title="include/signal.h:29">SIGCHLD</a></span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="exit.c.html#L102" title="kernel/exit.c:102">do_exit</a>(<span class="Constant">1</span>&lt;&lt;(signr-<span class="Constant">1</span>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (sa-&gt;sa_flags &amp; <a href="../include/signal.h.html#L39" title="include/signal.h:39">SA_ONESHOT</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sa-&gt;sa_handler = <span class="Constant"><a href="../include/linux/sched.h.html#L26" title="include/linux/sched.h:26">NULL</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *(&amp;eip) = sa_handler;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; longs = (sa-&gt;sa_flags &amp; <a href="../include/signal.h.html#L38" title="include/signal.h:38">SA_NOMASK</a>)?<span class="Constant">7</span>:<span class="Constant">8</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *(&amp;esp) -= longs;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="fork.c.html#L24" title="kernel/fork.c:24">verify_area</a>(esp,longs*<span class="Constant">4</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; tmp_esp=esp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../include/asm/segment.h.html#L35" title="include/asm/segment.h:35">put_fs_long</a>((<span class="Type">long</span>) sa-&gt;sa_restorer,tmp_esp++);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../include/asm/segment.h.html#L35" title="include/asm/segment.h:35">put_fs_long</a>(signr,tmp_esp++);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!(sa-&gt;sa_flags &amp; <a href="../include/signal.h.html#L38" title="include/signal.h:38">SA_NOMASK</a>))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../include/asm/segment.h.html#L35" title="include/asm/segment.h:35">put_fs_long</a>(<a href="sched.c.html#L62" title="kernel/sched.c:62">current</a>-&gt;blocked,tmp_esp++);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../include/asm/segment.h.html#L35" title="include/asm/segment.h:35">put_fs_long</a>(eax,tmp_esp++);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../include/asm/segment.h.html#L35" title="include/asm/segment.h:35">put_fs_long</a>(ecx,tmp_esp++);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../include/asm/segment.h.html#L35" title="include/asm/segment.h:35">put_fs_long</a>(edx,tmp_esp++);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../include/asm/segment.h.html#L35" title="include/asm/segment.h:35">put_fs_long</a>(eflags,tmp_esp++);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../include/asm/segment.h.html#L35" title="include/asm/segment.h:35">put_fs_long</a>(old_eip,tmp_esp++);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="sched.c.html#L62" title="kernel/sched.c:62">current</a>-&gt;blocked |= sa-&gt;sa_mask;<br/></li>
<li>}<br/></li>
</ol></code>
 </body>
</html>
