<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>kernel/blk_drv/hd.c - linux-0.11-ebook</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

code {
    font-family: consolas, monospace;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
  <h3>kernel/blk_drv/hd.c - linux-0.11-ebook</h3>
   <a href="../index.html"> Table of Contents </a>
 <h4>Global variables defined</h4>
 <ul>
<li><a href="#L53">NR_HD</a></li>
<li><a href="#L59">hd</a></li>
<li><a href="#L49">hd_info</a></li>
<li><a href="#L52">hd_info</a></li>
<li><a href="#L39">recalibrate</a></li>
<li><a href="#L40">reset</a></li>
</ul>
 <h4>Data types defined</h4>
 <ul>
<li><a href="#L45">hd_i_struct</a></li>
<li><a href="#L56">hd_struct</a></li>
</ul>
 <h4>Functions defined</h4>
 <ul>
<li><a href="#L242">bad_rw_intr</a></li>
<li><a href="#L161">controller_ready</a></li>
<li><a href="#L294">do_hd_request</a></li>
<li><a href="#L202">drive_busy</a></li>
<li><a href="#L343">hd_init</a></li>
<li><a href="#L180">hd_out</a></li>
<li><a href="#L250">read_intr</a></li>
<li><a href="#L287">recal_intr</a></li>
<li><a href="#L217">reset_controller</a></li>
<li><a href="#L230">reset_hd</a></li>
<li><a href="#L71">sys_setup</a></li>
<li><a href="#L237">unexpected_hd_interrupt</a></li>
<li><a href="#L169">win_result</a></li>
<li><a href="#L269">write_intr</a></li>
</ul>
 <h4>Macros defined</h4>
 <ul>
<li><a href="#L28">CMOS_READ</a></li>
<li><a href="#L25">MAJOR_NR</a></li>
<li><a href="#L34">MAX_ERRORS</a></li>
<li><a href="#L35">MAX_HD</a></li>
<li><a href="#L50">NR_HD</a></li>
<li><a href="#L61">port_read</a></li>
<li><a href="#L64">port_write</a></li>
</ul>
 <h4>Source code</h4>

  <code><ol><li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> *&nbsp; linux/kernel/<a href="#L59" title="kernel/blk_drv/hd.c:59">hd</a>.c<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *&nbsp; (C) 1991&nbsp; Linus Torvalds<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * This is the low-level <a href="#L59" title="kernel/blk_drv/hd.c:59">hd</a> interrupt support. It traverses the<br/></li>
<li></span><span class="Comment"> * <a href="ll_rw_blk.c.html#L21" title="kernel/blk_drv/ll_rw_blk.c:21">request</a>-list, using interrupts to jump between functions. As<br/></li>
<li></span><span class="Comment"> * all the functions are called within interrupts, we may not<br/></li>
<li></span><span class="Comment"> * sleep. Special care is recommended.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *&nbsp; modified by Drew Eckhardt to check nr of <a href="#L59" title="kernel/blk_drv/hd.c:59">hd</a>'s from the CMOS.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;linux/config.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;linux/sched.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;linux/fs.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;linux/kernel.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;linux/hdreg.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;asm/system.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;asm/io.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;asm/segment.h&gt;<br/></li>
<li></span><br/></li>
<li><a id="L25">&#x200c;</a><span class="PreProc">#define <span class="linkable">MAJOR_NR</span> </span><span class="Constant">3<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;blk.h&quot;<br/></li>
<li></span><br/></li>
<li><a id="L28">&#x200c;</a><span class="PreProc">#define <span class="linkable">CMOS_READ</span>(addr) (</span><span class="Error">{</span><span class="PreProc"> \<br/></li>
<li></span><span class="PreProc"><a href="../../include/asm/io.h.html#L11" title="include/asm/io.h:11">outb_p</a>(</span><span class="Constant">0x80</span><span class="PreProc">|addr,</span><span class="Constant">0x70</span><span class="PreProc">); \<br/></li>
<li></span><span class="PreProc"><a href="../../include/asm/io.h.html#L17" title="include/asm/io.h:17">inb_p</a>(</span><span class="Constant">0x71</span><span class="PreProc">); \<br/></li>
<li></span><span class="Error">}</span><span class="PreProc">)<br/></li>
<li></span><br/></li>
<li><span class="Comment">/* Max read/write errors/<a href="floppy.c.html#L116" title="kernel/blk_drv/floppy.c:116">sector</a> */<br/></li>
<li><a id="L34">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">MAX_ERRORS</span>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">7<br/></li>
<li><a id="L35">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">MAX_HD</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">2<br/></li>
<li></span><br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L287" title="kernel/blk_drv/hd.c:287">recal_intr</a>(<span class="Type">void</span>);<br/></li>
<li><br/></li>
<li><a id="L39">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">recalibrate</span> = <span class="Constant">1</span>;<br/></li>
<li><a id="L40">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">reset</span> = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> *&nbsp; This struct defines the HD's and their types.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li><a id="L45">&#x200c;</a></span><span class="Type">struct</span> <span class="linkable">hd_i_struct</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> <a href="floppy.c.html#L117" title="kernel/blk_drv/floppy.c:117">head</a>,sect,cyl,wpcom,lzone,ctl;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; };<br/></li>
<li><span class="PreProc">#ifdef HD_TYPE<br/></li>
<li><a id="L49">&#x200c;</a></span><span class="Type">struct</span> <a href="#L45" title="kernel/blk_drv/hd.c:45">hd_i_struct</a> <span class="linkable">hd_info</span>[] = { HD_TYPE };<br/></li>
<li><a id="L50">&#x200c;</a><span class="PreProc">#define <span class="linkable">NR_HD</span> ((</span><span class="Statement">sizeof</span><span class="PreProc"> (<a href="#L49" title="kernel/blk_drv/hd.c:49">hd_info</a>))/(</span><span class="Statement">sizeof</span><span class="PreProc"> (</span><span class="Type">struct</span><span class="PreProc"> <a href="#L45" title="kernel/blk_drv/hd.c:45">hd_i_struct</a>)))<br/></li>
<li></span><span class="PreProc">#else<br/></li>
<li><a id="L52">&#x200c;</a></span><span class="Type">struct</span> <a href="#L45" title="kernel/blk_drv/hd.c:45">hd_i_struct</a> <span class="linkable">hd_info</span>[] = { {<span class="Constant">0</span>,<span class="Constant">0</span>,<span class="Constant">0</span>,<span class="Constant">0</span>,<span class="Constant">0</span>,<span class="Constant">0</span>},{<span class="Constant">0</span>,<span class="Constant">0</span>,<span class="Constant">0</span>,<span class="Constant">0</span>,<span class="Constant">0</span>,<span class="Constant">0</span>} };<br/></li>
<li><a id="L53">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">NR_HD</span> = <span class="Constant">0</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><a id="L56">&#x200c;</a><span class="Type">static</span> <span class="Type">struct</span> <span class="linkable">hd_struct</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">long</span> start_sect;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">long</span> nr_sects;<br/></li>
<li><a id="L59">&#x200c;</a>} <span class="linkable">hd</span>[<span class="Constant">5</span>*<a href="#L35" title="kernel/blk_drv/hd.c:35">MAX_HD</a>]={{<span class="Constant">0</span>,<span class="Constant">0</span>},};<br/></li>
<li><br/></li>
<li><a id="L61">&#x200c;</a><span class="PreProc">#define <span class="linkable">port_read</span>(port,<a href="../printk.c.html#L17" title="kernel/printk.c:17">buf</a>,nr) \<br/></li>
<li></span><span class="PreProc">__asm__(</span><span class="Constant">&quot;cld;rep;insw&quot;</span><span class="PreProc">::</span><span class="Constant">&quot;d&quot;</span><span class="PreProc"> (port),</span><span class="Constant">&quot;D&quot;</span><span class="PreProc"> (<a href="../printk.c.html#L17" title="kernel/printk.c:17">buf</a>),</span><span class="Constant">&quot;c&quot;</span><span class="PreProc"> (nr):)<br/></li>
<li></span><br/></li>
<li><a id="L64">&#x200c;</a><span class="PreProc">#define <span class="linkable">port_write</span>(port,<a href="../printk.c.html#L17" title="kernel/printk.c:17">buf</a>,nr) \<br/></li>
<li></span><span class="PreProc">__asm__(</span><span class="Constant">&quot;cld;rep;outsw&quot;</span><span class="PreProc">::</span><span class="Constant">&quot;d&quot;</span><span class="PreProc"> (port),</span><span class="Constant">&quot;S&quot;</span><span class="PreProc"> (<a href="../printk.c.html#L17" title="kernel/printk.c:17">buf</a>),</span><span class="Constant">&quot;c&quot;</span><span class="PreProc"> (nr):)<br/></li>
<li></span><br/></li>
<li><span class="Type"><a href="../../lib/string.c.html#L11" title="lib/string.c:11">extern</a></span> <span class="Type">void</span> hd_interrupt(<span class="Type">void</span>);<br/></li>
<li><span class="Type"><a href="../../lib/string.c.html#L11" title="lib/string.c:11">extern</a></span> <span class="Type">void</span> <a href="ramdisk.c.html#L71" title="kernel/blk_drv/ramdisk.c:71">rd_load</a>(<span class="Type">void</span>);<br/></li>
<li><br/></li>
<li><span class="Comment">/* This may be used only once, enforced by 'static int callable' */<br/></li>
<li><a id="L71">&#x200c;</a></span><span class="Type">int</span> <span class="linkable">sys_setup</span>(<span class="Type">void</span> * BIOS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">static</span> <span class="Type">int</span> callable = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> i,drive;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">unsigned</span> <span class="Type">char</span> cmos_disks;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">struct</span> <a href="../../include/linux/hdreg.h.html#L52" title="include/linux/hdreg.h:52">partition</a> *p;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">struct</span> <a href="../../include/linux/fs.h.html#L68" title="include/linux/fs.h:68">buffer_head</a> * bh;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!callable)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; callable = <span class="Constant">0</span>;<br/></li>
<li><span class="PreProc">#ifndef HD_TYPE<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (drive=<span class="Constant">0</span> ; drive&lt;<span class="Constant">2</span> ; drive++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L49" title="kernel/blk_drv/hd.c:49">hd_info</a>[drive].cyl = *(<span class="Type">unsigned</span> <span class="Type">short</span> *) BIOS;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L49" title="kernel/blk_drv/hd.c:49">hd_info</a>[drive].<a href="floppy.c.html#L117" title="kernel/blk_drv/floppy.c:117">head</a> = *(<span class="Type">unsigned</span> <span class="Type">char</span> *) (<span class="Constant">2</span>+BIOS);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L49" title="kernel/blk_drv/hd.c:49">hd_info</a>[drive].wpcom = *(<span class="Type">unsigned</span> <span class="Type">short</span> *) (<span class="Constant">5</span>+BIOS);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L49" title="kernel/blk_drv/hd.c:49">hd_info</a>[drive].ctl = *(<span class="Type">unsigned</span> <span class="Type">char</span> *) (<span class="Constant">8</span>+BIOS);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L49" title="kernel/blk_drv/hd.c:49">hd_info</a>[drive].lzone = *(<span class="Type">unsigned</span> <span class="Type">short</span> *) (<span class="Constant">12</span>+BIOS);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L49" title="kernel/blk_drv/hd.c:49">hd_info</a>[drive].sect = *(<span class="Type">unsigned</span> <span class="Type">char</span> *) (<span class="Constant">14</span>+BIOS);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; BIOS += <span class="Constant">16</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L49" title="kernel/blk_drv/hd.c:49">hd_info</a>[<span class="Constant">1</span>].cyl)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L50" title="kernel/blk_drv/hd.c:50">NR_HD</a>=<span class="Constant">2</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L50" title="kernel/blk_drv/hd.c:50">NR_HD</a>=<span class="Constant">1</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (i=<span class="Constant">0</span> ; i&lt;<a href="#L50" title="kernel/blk_drv/hd.c:50">NR_HD</a> ; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L59" title="kernel/blk_drv/hd.c:59">hd</a>[i*<span class="Constant">5</span>].start_sect = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L59" title="kernel/blk_drv/hd.c:59">hd</a>[i*<span class="Constant">5</span>].nr_sects = <a href="#L49" title="kernel/blk_drv/hd.c:49">hd_info</a>[i].<a href="floppy.c.html#L117" title="kernel/blk_drv/floppy.c:117">head</a>*<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L49" title="kernel/blk_drv/hd.c:49">hd_info</a>[i].sect*<a href="#L49" title="kernel/blk_drv/hd.c:49">hd_info</a>[i].cyl;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; We querry CMOS about hard disks : it could be that<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; we have a SCSI/ESDI/etc controller that is BIOS<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; compatable with ST-506, and thus showing up in our<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; BIOS table, but not register compatable, and therefore<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; not present in CMOS.<br/></li>
<li></span><br/></li>
<li><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Furthurmore, we will assume that our ST-506 drives<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;if any&gt; are the primary drives in the system, and<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; the ones reflected as drive 1 or 2.<br/></li>
<li></span><br/></li>
<li><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; The first drive is stored in the high nibble of CMOS<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; byte 0x12, the second in the low nibble.&nbsp; This will be<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; either a 4 bit drive type or 0xf indicating use byte 0x19<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; for an 8 bit type, drive 1, 0x1a for drive 2 in CMOS.<br/></li>
<li></span><br/></li>
<li><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Needless to say, a non-zero value means we have<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; an AT controller hard disk for that drive.<br/></li>
<li></span><br/></li>
<li><span class="Comment"><br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((cmos_disks = <a href="../../init/main.c.html#L69" title="init/main.c:69">CMOS_READ</a>(<span class="Constant">0x12</span>)) &amp; <span class="Constant">0xf0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (cmos_disks &amp; <span class="Constant">0x0f</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L50" title="kernel/blk_drv/hd.c:50">NR_HD</a> = <span class="Constant">2</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L50" title="kernel/blk_drv/hd.c:50">NR_HD</a> = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L50" title="kernel/blk_drv/hd.c:50">NR_HD</a> = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (i = <a href="#L50" title="kernel/blk_drv/hd.c:50">NR_HD</a> ; i &lt; <span class="Constant">2</span> ; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L59" title="kernel/blk_drv/hd.c:59">hd</a>[i*<span class="Constant">5</span>].start_sect = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L59" title="kernel/blk_drv/hd.c:59">hd</a>[i*<span class="Constant">5</span>].nr_sects = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (drive=<span class="Constant">0</span> ; drive&lt;<a href="#L50" title="kernel/blk_drv/hd.c:50">NR_HD</a> ; drive++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!(bh = <a href="../../fs/buffer.c.html#L267" title="fs/buffer.c:267">bread</a>(<span class="Constant">0x300</span> + drive*<span class="Constant">5</span>,<span class="Constant">0</span>))) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../printk.c.html#L21" title="kernel/printk.c:21">printk</a>(<span class="Constant">&quot;Unable to read <a href="../../include/linux/hdreg.h.html#L52" title="include/linux/hdreg.h:52">partition</a> table of drive </span><span class="Special">%d\n\r</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; drive);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../panic.c.html#L16" title="kernel/panic.c:16">panic</a>(<span class="Constant">&quot;&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (bh-&gt;b_data[<span class="Constant">510</span>] != <span class="Constant">0x55</span> || (<span class="Type">unsigned</span> <span class="Type">char</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bh-&gt;b_data[<span class="Constant">511</span>] != <span class="Constant">0xAA</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../printk.c.html#L21" title="kernel/printk.c:21">printk</a>(<span class="Constant">&quot;Bad <a href="../../include/linux/hdreg.h.html#L52" title="include/linux/hdreg.h:52">partition</a> table on drive </span><span class="Special">%d\n\r</span><span class="Constant">&quot;</span>,drive);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../panic.c.html#L16" title="kernel/panic.c:16">panic</a>(<span class="Constant">&quot;&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = <span class="Constant">0x1BE</span> + (<span class="Type">void</span> *)bh-&gt;b_data;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (i=<span class="Constant">1</span>;i&lt;<span class="Constant">5</span>;i++,p++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L59" title="kernel/blk_drv/hd.c:59">hd</a>[i+<span class="Constant">5</span>*drive].start_sect = p-&gt;start_sect;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L59" title="kernel/blk_drv/hd.c:59">hd</a>[i+<span class="Constant">5</span>*drive].nr_sects = p-&gt;nr_sects;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../fs/buffer.c.html#L253" title="fs/buffer.c:253">brelse</a>(bh);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L50" title="kernel/blk_drv/hd.c:50">NR_HD</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../printk.c.html#L21" title="kernel/printk.c:21">printk</a>(<span class="Constant">&quot;Partition table</span><span class="Special">%s</span><span class="Constant"> ok.</span><span class="Special">\n\r</span><span class="Constant">&quot;</span>,(<a href="#L50" title="kernel/blk_drv/hd.c:50">NR_HD</a>&gt;<span class="Constant">1</span>)?<span class="Constant">&quot;s&quot;</span>:<span class="Constant">&quot;&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ramdisk.c.html#L71" title="kernel/blk_drv/ramdisk.c:71">rd_load</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../fs/super.c.html#L242" title="fs/super.c:242">mount_root</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> (<span class="Constant">0</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L161">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">controller_ready</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> retries=<span class="Constant">10000</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">while</span> (--retries &amp;&amp; (<a href="../../include/asm/io.h.html#L17" title="include/asm/io.h:17">inb_p</a>(<a href="../../include/linux/hdreg.h.html#L17" title="include/linux/hdreg.h:17">HD_STATUS</a>)&amp;<span class="Constant">0xc0</span>)!=<span class="Constant">0x40</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> (retries);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L169">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">win_result</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> i=<a href="../../include/asm/io.h.html#L17" title="include/asm/io.h:17">inb_p</a>(<a href="../../include/linux/hdreg.h.html#L17" title="include/linux/hdreg.h:17">HD_STATUS</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((i &amp; (<a href="../../include/linux/hdreg.h.html#L31" title="include/linux/hdreg.h:31">BUSY_STAT</a> | <a href="../../include/linux/hdreg.h.html#L30" title="include/linux/hdreg.h:30">READY_STAT</a> | <a href="../../include/linux/hdreg.h.html#L29" title="include/linux/hdreg.h:29">WRERR_STAT</a> | <a href="../../include/linux/hdreg.h.html#L28" title="include/linux/hdreg.h:28">SEEK_STAT</a> | <a href="../../include/linux/hdreg.h.html#L24" title="include/linux/hdreg.h:24">ERR_STAT</a>))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; == (<a href="../../include/linux/hdreg.h.html#L30" title="include/linux/hdreg.h:30">READY_STAT</a> | <a href="../../include/linux/hdreg.h.html#L28" title="include/linux/hdreg.h:28">SEEK_STAT</a>))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>(<span class="Constant">0</span>); <span class="Comment">/* ok */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (i&amp;<span class="Constant">1</span>) i=<a href="../../include/asm/io.h.html#L5" title="include/asm/io.h:5">inb</a>(<a href="../../include/linux/hdreg.h.html#L11" title="include/linux/hdreg.h:11">HD_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> (<span class="Constant">1</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L180">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">hd_out</span>(<span class="Type">unsigned</span> <span class="Type">int</span> drive,<span class="Type">unsigned</span> <span class="Type">int</span> nsect,<span class="Type">unsigned</span> <span class="Type">int</span> sect,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">unsigned</span> <span class="Type">int</span> <a href="floppy.c.html#L117" title="kernel/blk_drv/floppy.c:117">head</a>,<span class="Type">unsigned</span> <span class="Type">int</span> cyl,<span class="Type">unsigned</span> <span class="Type">int</span> cmd,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">void</span> (*intr_addr)(<span class="Type">void</span>))<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">register</span> <span class="Type">int</span> port <span class="Statement">asm</span>(<span class="Constant">&quot;dx&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (drive&gt;<span class="Constant">1</span> || <a href="floppy.c.html#L117" title="kernel/blk_drv/floppy.c:117">head</a>&gt;<span class="Constant">15</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../panic.c.html#L16" title="kernel/panic.c:16">panic</a>(<span class="Constant">&quot;Trying to write bad <a href="floppy.c.html#L116" title="kernel/blk_drv/floppy.c:116">sector</a>&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!<a href="#L161" title="kernel/blk_drv/hd.c:161">controller_ready</a>())<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../panic.c.html#L16" title="kernel/panic.c:16">panic</a>(<span class="Constant">&quot;HD controller not ready&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; do_hd = intr_addr;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../include/asm/io.h.html#L11" title="include/asm/io.h:11">outb_p</a>(<a href="#L49" title="kernel/blk_drv/hd.c:49">hd_info</a>[drive].ctl,<a href="../../include/linux/hdreg.h.html#L21" title="include/linux/hdreg.h:21">HD_CMD</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; port=<a href="../../include/linux/hdreg.h.html#L10" title="include/linux/hdreg.h:10">HD_DATA</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../include/asm/io.h.html#L11" title="include/asm/io.h:11">outb_p</a>(<a href="#L49" title="kernel/blk_drv/hd.c:49">hd_info</a>[drive].wpcom&gt;&gt;<span class="Constant">2</span>,++port);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../include/asm/io.h.html#L11" title="include/asm/io.h:11">outb_p</a>(nsect,++port);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../include/asm/io.h.html#L11" title="include/asm/io.h:11">outb_p</a>(sect,++port);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../include/asm/io.h.html#L11" title="include/asm/io.h:11">outb_p</a>(cyl,++port);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../include/asm/io.h.html#L11" title="include/asm/io.h:11">outb_p</a>(cyl&gt;&gt;<span class="Constant">8</span>,++port);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../include/asm/io.h.html#L11" title="include/asm/io.h:11">outb_p</a>(<span class="Constant">0xA0</span>|(drive&lt;&lt;<span class="Constant">4</span>)|<a href="floppy.c.html#L117" title="kernel/blk_drv/floppy.c:117">head</a>,++port);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../include/asm/io.h.html#L1" title="include/asm/io.h:1">outb</a>(cmd,++port);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L202">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">drive_busy</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">unsigned</span> <span class="Type">int</span> i;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; <span class="Constant">10000</span>; i++)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../include/linux/hdreg.h.html#L30" title="include/linux/hdreg.h:30">READY_STAT</a> == (<a href="../../include/asm/io.h.html#L17" title="include/asm/io.h:17">inb_p</a>(<a href="../../include/linux/hdreg.h.html#L17" title="include/linux/hdreg.h:17">HD_STATUS</a>) &amp; (<a href="../../include/linux/hdreg.h.html#L31" title="include/linux/hdreg.h:31">BUSY_STAT</a>|<a href="../../include/linux/hdreg.h.html#L30" title="include/linux/hdreg.h:30">READY_STAT</a>)))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; i = <a href="../../include/asm/io.h.html#L5" title="include/asm/io.h:5">inb</a>(<a href="../../include/linux/hdreg.h.html#L17" title="include/linux/hdreg.h:17">HD_STATUS</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; i &amp;= <a href="../../include/linux/hdreg.h.html#L31" title="include/linux/hdreg.h:31">BUSY_STAT</a> | <a href="../../include/linux/hdreg.h.html#L30" title="include/linux/hdreg.h:30">READY_STAT</a> | <a href="../../include/linux/hdreg.h.html#L28" title="include/linux/hdreg.h:28">SEEK_STAT</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (i == <a href="../../include/linux/hdreg.h.html#L30" title="include/linux/hdreg.h:30">READY_STAT</a> | <a href="../../include/linux/hdreg.h.html#L28" title="include/linux/hdreg.h:28">SEEK_STAT</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../printk.c.html#L21" title="kernel/printk.c:21">printk</a>(<span class="Constant">&quot;HD controller times out</span><span class="Special">\n\r</span><span class="Constant">&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>(<span class="Constant">1</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L217">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">reset_controller</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; i;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../include/asm/io.h.html#L1" title="include/asm/io.h:1">outb</a>(<span class="Constant">4</span>,<a href="../../include/linux/hdreg.h.html#L21" title="include/linux/hdreg.h:21">HD_CMD</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span>(i = <span class="Constant">0</span>; i &lt; <span class="Constant">100</span>; i++) <a href="../../include/asm/system.h.html#L18" title="include/asm/system.h:18">nop</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../include/asm/io.h.html#L1" title="include/asm/io.h:1">outb</a>(<a href="#L49" title="kernel/blk_drv/hd.c:49">hd_info</a>[<span class="Constant">0</span>].ctl &amp; <span class="Constant">0x0f</span> ,<a href="../../include/linux/hdreg.h.html#L21" title="include/linux/hdreg.h:21">HD_CMD</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L202" title="kernel/blk_drv/hd.c:202">drive_busy</a>())<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../printk.c.html#L21" title="kernel/printk.c:21">printk</a>(<span class="Constant">&quot;HD-controller still busy</span><span class="Special">\n\r</span><span class="Constant">&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((i = <a href="../../include/asm/io.h.html#L5" title="include/asm/io.h:5">inb</a>(<a href="../../include/linux/hdreg.h.html#L11" title="include/linux/hdreg.h:11">HD_ERROR</a>)) != <span class="Constant">1</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../printk.c.html#L21" title="kernel/printk.c:21">printk</a>(<span class="Constant">&quot;HD-controller <a href="#L40" title="kernel/blk_drv/hd.c:40">reset</a> failed: </span><span class="Special">%02x\n\r</span><span class="Constant">&quot;</span>,i);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L230">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">reset_hd</span>(<span class="Type">int</span> nr)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L217" title="kernel/blk_drv/hd.c:217">reset_controller</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L180" title="kernel/blk_drv/hd.c:180">hd_out</a>(nr,<a href="#L49" title="kernel/blk_drv/hd.c:49">hd_info</a>[nr].sect,<a href="#L49" title="kernel/blk_drv/hd.c:49">hd_info</a>[nr].sect,<a href="#L49" title="kernel/blk_drv/hd.c:49">hd_info</a>[nr].<a href="floppy.c.html#L117" title="kernel/blk_drv/floppy.c:117">head</a>-<span class="Constant">1</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L49" title="kernel/blk_drv/hd.c:49">hd_info</a>[nr].cyl,<a href="../../include/linux/hdreg.h.html#L42" title="include/linux/hdreg.h:42">WIN_SPECIFY</a>,&amp;<a href="#L287" title="kernel/blk_drv/hd.c:287">recal_intr</a>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L237">&#x200c;</a><span class="Type">void</span> <span class="linkable">unexpected_hd_interrupt</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../printk.c.html#L21" title="kernel/printk.c:21">printk</a>(<span class="Constant">&quot;Unexpected HD interrupt</span><span class="Special">\n\r</span><span class="Constant">&quot;</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L242">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">bad_rw_intr</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (++<a href="blk.h.html#L93" title="kernel/blk_drv/blk.h:93">CURRENT</a>-&gt;errors &gt;= <a href="#L34" title="kernel/blk_drv/hd.c:34">MAX_ERRORS</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="blk.h.html#L109" title="kernel/blk_drv/blk.h:109">end_request</a>(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="blk.h.html#L93" title="kernel/blk_drv/blk.h:93">CURRENT</a>-&gt;errors &gt; <a href="#L34" title="kernel/blk_drv/hd.c:34">MAX_ERRORS</a>/<span class="Constant">2</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L40" title="kernel/blk_drv/hd.c:40">reset</a> = <span class="Constant">1</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L250">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">read_intr</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L169" title="kernel/blk_drv/hd.c:169">win_result</a>()) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L242" title="kernel/blk_drv/hd.c:242">bad_rw_intr</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L294" title="kernel/blk_drv/hd.c:294">do_hd_request</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L61" title="kernel/blk_drv/hd.c:61">port_read</a>(<a href="../../include/linux/hdreg.h.html#L10" title="include/linux/hdreg.h:10">HD_DATA</a>,<a href="blk.h.html#L93" title="kernel/blk_drv/blk.h:93">CURRENT</a>-&gt;buffer,<span class="Constant">256</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="blk.h.html#L93" title="kernel/blk_drv/blk.h:93">CURRENT</a>-&gt;errors = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="blk.h.html#L93" title="kernel/blk_drv/blk.h:93">CURRENT</a>-&gt;buffer += <span class="Constant">512</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="blk.h.html#L93" title="kernel/blk_drv/blk.h:93">CURRENT</a>-&gt;<a href="floppy.c.html#L116" title="kernel/blk_drv/floppy.c:116">sector</a>++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (--<a href="blk.h.html#L93" title="kernel/blk_drv/blk.h:93">CURRENT</a>-&gt;nr_sectors) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; do_hd = &amp;<a href="#L250" title="kernel/blk_drv/hd.c:250">read_intr</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="blk.h.html#L109" title="kernel/blk_drv/blk.h:109">end_request</a>(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L294" title="kernel/blk_drv/hd.c:294">do_hd_request</a>();<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L269">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">write_intr</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L169" title="kernel/blk_drv/hd.c:169">win_result</a>()) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L242" title="kernel/blk_drv/hd.c:242">bad_rw_intr</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L294" title="kernel/blk_drv/hd.c:294">do_hd_request</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (--<a href="blk.h.html#L93" title="kernel/blk_drv/blk.h:93">CURRENT</a>-&gt;nr_sectors) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="blk.h.html#L93" title="kernel/blk_drv/blk.h:93">CURRENT</a>-&gt;<a href="floppy.c.html#L116" title="kernel/blk_drv/floppy.c:116">sector</a>++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="blk.h.html#L93" title="kernel/blk_drv/blk.h:93">CURRENT</a>-&gt;buffer += <span class="Constant">512</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; do_hd = &amp;<a href="#L269" title="kernel/blk_drv/hd.c:269">write_intr</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L64" title="kernel/blk_drv/hd.c:64">port_write</a>(<a href="../../include/linux/hdreg.h.html#L10" title="include/linux/hdreg.h:10">HD_DATA</a>,<a href="blk.h.html#L93" title="kernel/blk_drv/blk.h:93">CURRENT</a>-&gt;buffer,<span class="Constant">256</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="blk.h.html#L109" title="kernel/blk_drv/blk.h:109">end_request</a>(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L294" title="kernel/blk_drv/hd.c:294">do_hd_request</a>();<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L287">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">recal_intr</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L169" title="kernel/blk_drv/hd.c:169">win_result</a>())<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L242" title="kernel/blk_drv/hd.c:242">bad_rw_intr</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L294" title="kernel/blk_drv/hd.c:294">do_hd_request</a>();<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L294">&#x200c;</a><span class="Type">void</span> <span class="linkable">do_hd_request</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> i,r;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">unsigned</span> <span class="Type">int</span> block,dev;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">unsigned</span> <span class="Type">int</span> sec,<a href="floppy.c.html#L117" title="kernel/blk_drv/floppy.c:117">head</a>,cyl;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">unsigned</span> <span class="Type">int</span> nsect;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="blk.h.html#L127" title="kernel/blk_drv/blk.h:127">INIT_REQUEST</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; dev = <a href="../../include/linux/fs.h.html#L34" title="include/linux/fs.h:34">MINOR</a>(<a href="blk.h.html#L93" title="kernel/blk_drv/blk.h:93">CURRENT</a>-&gt;dev);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; block = <a href="blk.h.html#L93" title="kernel/blk_drv/blk.h:93">CURRENT</a>-&gt;<a href="floppy.c.html#L116" title="kernel/blk_drv/floppy.c:116">sector</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (dev &gt;= <span class="Constant">5</span>*<a href="#L50" title="kernel/blk_drv/hd.c:50">NR_HD</a> || block+<span class="Constant">2</span> &gt; <a href="#L59" title="kernel/blk_drv/hd.c:59">hd</a>[dev].nr_sects) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="blk.h.html#L109" title="kernel/blk_drv/blk.h:109">end_request</a>(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> repeat;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; block += <a href="#L59" title="kernel/blk_drv/hd.c:59">hd</a>[dev].start_sect;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; dev /= <span class="Constant">5</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; __asm__(<span class="Constant">&quot;divl %4&quot;</span>:<span class="Constant">&quot;=a&quot;</span> (block),<span class="Constant">&quot;=d&quot;</span> (sec):<span class="Constant">&quot;0&quot;</span> (block),<span class="Constant">&quot;1&quot;</span> (<span class="Constant">0</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;r&quot;</span> (<a href="#L49" title="kernel/blk_drv/hd.c:49">hd_info</a>[dev].sect));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; __asm__(<span class="Constant">&quot;divl %4&quot;</span>:<span class="Constant">&quot;=a&quot;</span> (cyl),<span class="Constant">&quot;=d&quot;</span> (<a href="floppy.c.html#L117" title="kernel/blk_drv/floppy.c:117">head</a>):<span class="Constant">&quot;0&quot;</span> (block),<span class="Constant">&quot;1&quot;</span> (<span class="Constant">0</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;r&quot;</span> (<a href="#L49" title="kernel/blk_drv/hd.c:49">hd_info</a>[dev].<a href="floppy.c.html#L117" title="kernel/blk_drv/floppy.c:117">head</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; sec++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; nsect = <a href="blk.h.html#L93" title="kernel/blk_drv/blk.h:93">CURRENT</a>-&gt;nr_sectors;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L40" title="kernel/blk_drv/hd.c:40">reset</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L40" title="kernel/blk_drv/hd.c:40">reset</a> = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L39" title="kernel/blk_drv/hd.c:39">recalibrate</a> = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L230" title="kernel/blk_drv/hd.c:230">reset_hd</a>(<a href="blk.h.html#L94" title="kernel/blk_drv/blk.h:94">CURRENT_DEV</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L39" title="kernel/blk_drv/hd.c:39">recalibrate</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L39" title="kernel/blk_drv/hd.c:39">recalibrate</a> = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L180" title="kernel/blk_drv/hd.c:180">hd_out</a>(dev,<a href="#L49" title="kernel/blk_drv/hd.c:49">hd_info</a>[<a href="blk.h.html#L94" title="kernel/blk_drv/blk.h:94">CURRENT_DEV</a>].sect,<span class="Constant">0</span>,<span class="Constant">0</span>,<span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../include/linux/hdreg.h.html#L34" title="include/linux/hdreg.h:34">WIN_RESTORE</a>,&amp;<a href="#L287" title="kernel/blk_drv/hd.c:287">recal_intr</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="blk.h.html#L93" title="kernel/blk_drv/blk.h:93">CURRENT</a>-&gt;cmd == <a href="../../include/linux/fs.h.html#L27" title="include/linux/fs.h:27">WRITE</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L180" title="kernel/blk_drv/hd.c:180">hd_out</a>(dev,nsect,sec,<a href="floppy.c.html#L117" title="kernel/blk_drv/floppy.c:117">head</a>,cyl,<a href="../../include/linux/hdreg.h.html#L36" title="include/linux/hdreg.h:36">WIN_WRITE</a>,&amp;<a href="#L269" title="kernel/blk_drv/hd.c:269">write_intr</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span>(i=<span class="Constant">0</span> ; i&lt;<span class="Constant">3000</span> &amp;&amp; !(r=<a href="../../include/asm/io.h.html#L17" title="include/asm/io.h:17">inb_p</a>(<a href="../../include/linux/hdreg.h.html#L17" title="include/linux/hdreg.h:17">HD_STATUS</a>)&amp;<a href="../../include/linux/hdreg.h.html#L27" title="include/linux/hdreg.h:27">DRQ_STAT</a>) ; i++)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* nothing */</span> ;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!r) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L242" title="kernel/blk_drv/hd.c:242">bad_rw_intr</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> repeat;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L64" title="kernel/blk_drv/hd.c:64">port_write</a>(<a href="../../include/linux/hdreg.h.html#L10" title="include/linux/hdreg.h:10">HD_DATA</a>,<a href="blk.h.html#L93" title="kernel/blk_drv/blk.h:93">CURRENT</a>-&gt;buffer,<span class="Constant">256</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (<a href="blk.h.html#L93" title="kernel/blk_drv/blk.h:93">CURRENT</a>-&gt;cmd == <a href="../../include/linux/fs.h.html#L26" title="include/linux/fs.h:26">READ</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L180" title="kernel/blk_drv/hd.c:180">hd_out</a>(dev,nsect,sec,<a href="floppy.c.html#L117" title="kernel/blk_drv/floppy.c:117">head</a>,cyl,<a href="../../include/linux/hdreg.h.html#L35" title="include/linux/hdreg.h:35">WIN_READ</a>,&amp;<a href="#L250" title="kernel/blk_drv/hd.c:250">read_intr</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../panic.c.html#L16" title="kernel/panic.c:16">panic</a>(<span class="Constant">&quot;unknown <a href="#L59" title="kernel/blk_drv/hd.c:59">hd</a>-<a href="floppy.c.html#L121" title="kernel/blk_drv/floppy.c:121">command</a>&quot;</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L343">&#x200c;</a><span class="Type">void</span> <span class="linkable">hd_init</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ll_rw_blk.c.html#L32" title="kernel/blk_drv/ll_rw_blk.c:32">blk_dev</a>[<a href="ramdisk.c.html#L17" title="kernel/blk_drv/ramdisk.c:17">MAJOR_NR</a>].request_fn = <a href="blk.h.html#L64" title="kernel/blk_drv/blk.h:64">DEVICE_REQUEST</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../include/asm/system.h.html#L33" title="include/asm/system.h:33">set_intr_gate</a>(<span class="Constant">0x2E</span>,&amp;hd_interrupt);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../include/asm/io.h.html#L11" title="include/asm/io.h:11">outb_p</a>(<a href="../../include/asm/io.h.html#L17" title="include/asm/io.h:17">inb_p</a>(<span class="Constant">0x21</span>)&amp;<span class="Constant">0xfb</span>,<span class="Constant">0x21</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../include/asm/io.h.html#L1" title="include/asm/io.h:1">outb</a>(<a href="../../include/asm/io.h.html#L17" title="include/asm/io.h:17">inb_p</a>(<span class="Constant">0xA1</span>)&amp;<span class="Constant">0xbf</span>,<span class="Constant">0xA1</span>);<br/></li>
<li>}<br/></li>
</ol></code>
 </body>
</html>
