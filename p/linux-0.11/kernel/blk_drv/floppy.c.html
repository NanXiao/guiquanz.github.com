<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>kernel/blk_drv/floppy.c - linux-0.11-ebook</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

code {
    font-family: consolas, monospace;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
  <h3>kernel/blk_drv/floppy.c - linux-0.11-ebook</h3>
   <a href="../index.html"> Table of Contents </a>
 <h4>Global variables defined</h4>
 <ul>
<li><a href="#L121">command</a></li>
<li><a href="#L113">cur_rate</a></li>
<li><a href="#L112">cur_spec1</a></li>
<li><a href="#L115">current_drive</a></li>
<li><a href="#L120">current_track</a></li>
<li><a href="#L114">floppy</a></li>
<li><a href="#L85">floppy_type</a></li>
<li><a href="#L117">head</a></li>
<li><a href="#L44">recalibrate</a></li>
<li><a href="#L66">reply_buffer</a></li>
<li><a href="#L45">reset</a></li>
<li><a href="#L116">sector</a></li>
<li><a href="#L46">seek</a></li>
<li><a href="#L119">seek_track</a></li>
<li><a href="#L122">selected</a></li>
<li><a href="#L118">track</a></li>
<li><a href="#L123">wait_on_floppy_select</a></li>
</ul>
 <h4>Data types defined</h4>
 <ul>
<li><a href="#L82">floppy_struct</a></li>
</ul>
 <h4>Functions defined</h4>
 <ul>
<li><a href="#L233">bad_flp_intr</a></li>
<li><a href="#L417">do_fd_request</a></li>
<li><a href="#L139">floppy_change</a></li>
<li><a href="#L125">floppy_deselect</a></li>
<li><a href="#L457">floppy_init</a></li>
<li><a href="#L404">floppy_on_interrupt</a></li>
<li><a href="#L194">output_byte</a></li>
<li><a href="#L343">recal_interrupt</a></li>
<li><a href="#L362">recalibrate_floppy</a></li>
<li><a href="#L386">reset_floppy</a></li>
<li><a href="#L373">reset_interrupt</a></li>
<li><a href="#L212">result</a></li>
<li><a href="#L250">rw_interrupt</a></li>
<li><a href="#L291">seek_interrupt</a></li>
<li><a href="#L160">setup_DMA</a></li>
<li><a href="#L269">setup_rw_floppy</a></li>
<li><a href="#L309">transfer</a></li>
<li><a href="#L353">unexpected_floppy_interrupt</a></li>
</ul>
 <h4>Macros defined</h4>
 <ul>
<li><a href="#L54">DRIVE</a></li>
<li><a href="#L41">MAJOR_NR</a></li>
<li><a href="#L60">MAX_ERRORS</a></li>
<li><a href="#L65">MAX_REPLIES</a></li>
<li><a href="#L67">ST0</a></li>
<li><a href="#L68">ST1</a></li>
<li><a href="#L69">ST2</a></li>
<li><a href="#L70">ST3</a></li>
<li><a href="#L53">TYPE</a></li>
<li><a href="#L155">copy_buffer</a></li>
<li><a href="#L50">immoutb_p</a></li>
</ul>
 <h4>Source code</h4>

  <code><ol><li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> *&nbsp; linux/kernel/<a href="#L114" title="kernel/blk_drv/floppy.c:114">floppy</a>.c<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *&nbsp; (C) 1991&nbsp; Linus Torvalds<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * 02.12.91 - Changed to static variables to indicate need for <a href="hd.c.html#L40" title="kernel/blk_drv/hd.c:40">reset</a><br/></li>
<li></span><span class="Comment"> * and <a href="hd.c.html#L39" title="kernel/blk_drv/hd.c:39">recalibrate</a>. This makes some things easier (<a href="#L194" title="kernel/blk_drv/floppy.c:194">output_byte</a> <a href="hd.c.html#L40" title="kernel/blk_drv/hd.c:40">reset</a><br/></li>
<li></span><span class="Comment"> * checking etc), and means less interrupt jumping in case of errors,<br/></li>
<li></span><span class="Comment"> * so the code is hopefully easier to understand.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * This <a href="../../include/linux/fs.h.html#L116" title="include/linux/fs.h:116">file</a> is certainly a mess. I've tried my best to get it working,<br/></li>
<li></span><span class="Comment"> * but I don't like programming floppies, and I have only one anyway.<br/></li>
<li></span><span class="Comment"> * Urgel. I should check for more errors, and do more graceful error<br/></li>
<li></span><span class="Comment"> * recovery. Seems there are problems with several drives. I've tried to<br/></li>
<li></span><span class="Comment"> * correct them. No promises.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * As with <a href="hd.c.html#L59" title="kernel/blk_drv/hd.c:59">hd</a>.c, all routines within this <a href="../../include/linux/fs.h.html#L116" title="include/linux/fs.h:116">file</a> can (and will) be called<br/></li>
<li></span><span class="Comment"> * by interrupts, so extreme caution is needed. A hardware interrupt<br/></li>
<li></span><span class="Comment"> * handler may not sleep, or a kernel <a href="../panic.c.html#L16" title="kernel/panic.c:16">panic</a> will happen. Thus I cannot<br/></li>
<li></span><span class="Comment"> * call &quot;<a href="#L114" title="kernel/blk_drv/floppy.c:114">floppy</a>-on&quot; directly, but have to set a special timer interrupt<br/></li>
<li></span><span class="Comment"> * etc.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Also, I'm not certain this works on more than 1 <a href="#L114" title="kernel/blk_drv/floppy.c:114">floppy</a>. Bugs may<br/></li>
<li></span><span class="Comment"> * abund.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;linux/sched.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;linux/fs.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;linux/kernel.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;linux/fdreg.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;asm/system.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;asm/io.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;asm/segment.h&gt;<br/></li>
<li></span><br/></li>
<li><a id="L41">&#x200c;</a><span class="PreProc">#define <span class="linkable">MAJOR_NR</span> </span><span class="Constant">2<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;blk.h&quot;<br/></li>
<li></span><br/></li>
<li><a id="L44">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">recalibrate</span> = <span class="Constant">0</span>;<br/></li>
<li><a id="L45">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">reset</span> = <span class="Constant">0</span>;<br/></li>
<li><a id="L46">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">seek</span> = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li><span class="Type"><a href="../../lib/string.c.html#L11" title="lib/string.c:11">extern</a></span> <span class="Type">unsigned</span> <span class="Type">char</span> <a href="../sched.c.html#L204" title="kernel/sched.c:204">current_DOR</a>;<br/></li>
<li><br/></li>
<li><a id="L50">&#x200c;</a><span class="PreProc">#define <span class="linkable">immoutb_p</span>(val,port) \<br/></li>
<li></span><span class="PreProc">__asm__(</span><span class="Constant">&quot;<a href="../../include/asm/io.h.html#L1" title="include/asm/io.h:1">outb</a> %0,%1</span><span class="Special">\n\t</span><span class="Constant">jmp 1f</span><span class="Special">\n</span><span class="Constant">1:</span><span class="Special">\t</span><span class="Constant">jmp 1f</span><span class="Special">\n</span><span class="Constant">1:&quot;</span><span class="PreProc">::</span><span class="Constant">&quot;a&quot;</span><span class="PreProc"> ((</span><span class="Type">char</span><span class="PreProc">) (val)),</span><span class="Constant">&quot;i&quot;</span><span class="PreProc"> (port))<br/></li>
<li></span><br/></li>
<li><a id="L53">&#x200c;</a><span class="PreProc">#define <span class="linkable">TYPE</span>(<a href="../chr_drv/console.c.html#L72" title="kernel/chr_drv/console.c:72">x</a>) ((<a href="../chr_drv/console.c.html#L72" title="kernel/chr_drv/console.c:72">x</a>)&gt;&gt;</span><span class="Constant">2</span><span class="PreProc">)<br/></li>
<li><a id="L54">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">DRIVE</span>(<a href="../chr_drv/console.c.html#L72" title="kernel/chr_drv/console.c:72">x</a>) ((<a href="../chr_drv/console.c.html#L72" title="kernel/chr_drv/console.c:72">x</a>)&amp;</span><span class="Constant">0x03</span><span class="PreProc">)<br/></li>
<li></span><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Note that <a href="hd.c.html#L34" title="kernel/blk_drv/hd.c:34">MAX_ERRORS</a>=8 doesn't imply that we retry every bad read<br/></li>
<li></span><span class="Comment"> * max 8 times - some types of errors increase the errorcount by 2,<br/></li>
<li></span><span class="Comment"> * so we might actually retry only 5-6 times before giving up.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li><a id="L60">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">MAX_ERRORS</span> </span><span class="Constant">8<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * globals used by '<a href="#L212" title="kernel/blk_drv/floppy.c:212">result</a>()'<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li><a id="L65">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">MAX_REPLIES</span> </span><span class="Constant">7<br/></li>
<li><a id="L66">&#x200c;</a></span><span class="Type">static</span> <span class="Type">unsigned</span> <span class="Type">char</span> <span class="linkable">reply_buffer</span>[<a href="#L65" title="kernel/blk_drv/floppy.c:65">MAX_REPLIES</a>];<br/></li>
<li><a id="L67">&#x200c;</a><span class="PreProc">#define <span class="linkable">ST0</span> (<a href="#L66" title="kernel/blk_drv/floppy.c:66">reply_buffer</a>[</span><span class="Constant">0</span><span class="PreProc">])<br/></li>
<li><a id="L68">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">ST1</span> (<a href="#L66" title="kernel/blk_drv/floppy.c:66">reply_buffer</a>[</span><span class="Constant">1</span><span class="PreProc">])<br/></li>
<li><a id="L69">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">ST2</span> (<a href="#L66" title="kernel/blk_drv/floppy.c:66">reply_buffer</a>[</span><span class="Constant">2</span><span class="PreProc">])<br/></li>
<li><a id="L70">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">ST3</span> (<a href="#L66" title="kernel/blk_drv/floppy.c:66">reply_buffer</a>[</span><span class="Constant">3</span><span class="PreProc">])<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * This struct defines the different <a href="#L114" title="kernel/blk_drv/floppy.c:114">floppy</a> types. Unlike minix<br/></li>
<li></span><span class="Comment"> * linux doesn't have a &quot;search for right type&quot;-type, as the code<br/></li>
<li></span><span class="Comment"> * for that is convoluted and weird. I've got enough problems with<br/></li>
<li></span><span class="Comment"> * this driver as it is.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * The 'stretch' tells if the tracks need to be boubled for some<br/></li>
<li></span><span class="Comment"> * types (ie 360kB diskette in 1.2MB drive etc). Others should<br/></li>
<li></span><span class="Comment"> * be self-explanatory.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li><a id="L82">&#x200c;</a></span><span class="Type">static</span> <span class="Type">struct</span> <span class="linkable">floppy_struct</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">unsigned</span> <span class="Type">int</span> size, sect, <a href="#L117" title="kernel/blk_drv/floppy.c:117">head</a>, <a href="#L118" title="kernel/blk_drv/floppy.c:118">track</a>, stretch;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">unsigned</span> <span class="Type">char</span> gap,rate,spec1;<br/></li>
<li><a id="L85">&#x200c;</a>} <span class="linkable">floppy_type</span>[] = {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {&nbsp; &nbsp; <span class="Constant">0</span>, <span class="Constant">0</span>,<span class="Constant">0</span>, <span class="Constant">0</span>,<span class="Constant">0</span>,<span class="Constant">0x00</span>,<span class="Constant">0x00</span>,<span class="Constant">0x00</span> },&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* no testing */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; {&nbsp; <span class="Constant">720</span>, <span class="Constant">9</span>,<span class="Constant">2</span>,<span class="Constant">40</span>,<span class="Constant">0</span>,<span class="Constant">0x2A</span>,<span class="Constant">0x02</span>,<span class="Constant">0xDF</span> },&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* 360kB PC diskettes */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; { <span class="Constant">2400</span>,<span class="Constant">15</span>,<span class="Constant">2</span>,<span class="Constant">80</span>,<span class="Constant">0</span>,<span class="Constant">0x1B</span>,<span class="Constant">0x00</span>,<span class="Constant">0xDF</span> },&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* 1.2 MB AT-diskettes */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; {&nbsp; <span class="Constant">720</span>, <span class="Constant">9</span>,<span class="Constant">2</span>,<span class="Constant">40</span>,<span class="Constant">1</span>,<span class="Constant">0x2A</span>,<span class="Constant">0x02</span>,<span class="Constant">0xDF</span> },&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* 360kB in 720kB drive */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; { <span class="Constant">1440</span>, <span class="Constant">9</span>,<span class="Constant">2</span>,<span class="Constant">80</span>,<span class="Constant">0</span>,<span class="Constant">0x2A</span>,<span class="Constant">0x02</span>,<span class="Constant">0xDF</span> },&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* 3.5&quot; 720kB diskette */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; {&nbsp; <span class="Constant">720</span>, <span class="Constant">9</span>,<span class="Constant">2</span>,<span class="Constant">40</span>,<span class="Constant">1</span>,<span class="Constant">0x23</span>,<span class="Constant">0x01</span>,<span class="Constant">0xDF</span> },&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* 360kB in 1.2MB drive */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; { <span class="Constant">1440</span>, <span class="Constant">9</span>,<span class="Constant">2</span>,<span class="Constant">80</span>,<span class="Constant">0</span>,<span class="Constant">0x23</span>,<span class="Constant">0x01</span>,<span class="Constant">0xDF</span> },&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* 720kB in 1.2MB drive */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; { <span class="Constant">2880</span>,<span class="Constant">18</span>,<span class="Constant">2</span>,<span class="Constant">80</span>,<span class="Constant">0</span>,<span class="Constant">0x1B</span>,<span class="Constant">0x00</span>,<span class="Constant">0xCF</span> },&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* 1.44MB diskette */<br/></li>
<li></span>};<br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Rate is 0 for 500kb/s, 2 for 300kbps, 1 for 250kbps<br/></li>
<li></span><span class="Comment"> * Spec1 is 0xSH, where S is stepping rate (F=1ms, E=2ms, D=3ms etc),<br/></li>
<li></span><span class="Comment"> * H is <a href="#L117" title="kernel/blk_drv/floppy.c:117">head</a> unload time (1=16ms, 2=32ms, etc)<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Spec2 is (HLD&lt;&lt;1 | ND), where HLD is <a href="#L117" title="kernel/blk_drv/floppy.c:117">head</a> load time (1=2ms, 2=4 ms etc)<br/></li>
<li></span><span class="Comment"> * and ND is set means no DMA. Hardcoded to 6 (HLD=6ms, use DMA).<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><span class="Type"><a href="../../lib/string.c.html#L11" title="lib/string.c:11">extern</a></span> <span class="Type">void</span> floppy_interrupt(<span class="Type">void</span>);<br/></li>
<li><span class="Type"><a href="../../lib/string.c.html#L11" title="lib/string.c:11">extern</a></span> <span class="Type">char</span> tmp_floppy_area[<span class="Constant">1024</span>];<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * These are global variables, as that's the easiest way to give<br/></li>
<li></span><span class="Comment"> * information to interrupts. They are the data used for the <a href="../sched.c.html#L62" title="kernel/sched.c:62">current</a><br/></li>
<li></span><span class="Comment"> * <a href="ll_rw_blk.c.html#L21" title="kernel/blk_drv/ll_rw_blk.c:21">request</a>.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li><a id="L112">&#x200c;</a></span><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">cur_spec1</span> = -<span class="Constant">1</span>;<br/></li>
<li><a id="L113">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">cur_rate</span> = -<span class="Constant">1</span>;<br/></li>
<li><a id="L114">&#x200c;</a><span class="Type">static</span> <span class="Type">struct</span> <a href="#L82" title="kernel/blk_drv/floppy.c:82">floppy_struct</a> * <span class="linkable">floppy</span> = <a href="#L85" title="kernel/blk_drv/floppy.c:85">floppy_type</a>;<br/></li>
<li><a id="L115">&#x200c;</a><span class="Type">static</span> <span class="Type">unsigned</span> <span class="Type">char</span> <span class="linkable">current_drive</span> = <span class="Constant">0</span>;<br/></li>
<li><a id="L116">&#x200c;</a><span class="Type">static</span> <span class="Type">unsigned</span> <span class="Type">char</span> <span class="linkable">sector</span> = <span class="Constant">0</span>;<br/></li>
<li><a id="L117">&#x200c;</a><span class="Type">static</span> <span class="Type">unsigned</span> <span class="Type">char</span> <span class="linkable">head</span> = <span class="Constant">0</span>;<br/></li>
<li><a id="L118">&#x200c;</a><span class="Type">static</span> <span class="Type">unsigned</span> <span class="Type">char</span> <span class="linkable">track</span> = <span class="Constant">0</span>;<br/></li>
<li><a id="L119">&#x200c;</a><span class="Type">static</span> <span class="Type">unsigned</span> <span class="Type">char</span> <span class="linkable">seek_track</span> = <span class="Constant">0</span>;<br/></li>
<li><a id="L120">&#x200c;</a><span class="Type">static</span> <span class="Type">unsigned</span> <span class="Type">char</span> <span class="linkable">current_track</span> = <span class="Constant">255</span>;<br/></li>
<li><a id="L121">&#x200c;</a><span class="Type">static</span> <span class="Type">unsigned</span> <span class="Type">char</span> <span class="linkable">command</span> = <span class="Constant">0</span>;<br/></li>
<li><a id="L122">&#x200c;</a><span class="Type">unsigned</span> <span class="Type">char</span> <span class="linkable">selected</span> = <span class="Constant">0</span>;<br/></li>
<li><a id="L123">&#x200c;</a><span class="Type">struct</span> <a href="../../include/linux/sched.h.html#L78" title="include/linux/sched.h:78">task_struct</a> * <span class="linkable">wait_on_floppy_select</span> = <span class="Constant"><a href="../../include/linux/sched.h.html#L26" title="include/linux/sched.h:26">NULL</a></span>;<br/></li>
<li><br/></li>
<li><a id="L125">&#x200c;</a><span class="Type">void</span> <span class="linkable">floppy_deselect</span>(<span class="Type">unsigned</span> <span class="Type">int</span> nr)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (nr != (<a href="../sched.c.html#L204" title="kernel/sched.c:204">current_DOR</a> &amp; <span class="Constant">3</span>))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../printk.c.html#L21" title="kernel/printk.c:21">printk</a>(<span class="Constant">&quot;<a href="#L125" title="kernel/blk_drv/floppy.c:125">floppy_deselect</a>: drive not <a href="#L122" title="kernel/blk_drv/floppy.c:122">selected</a></span><span class="Special">\n\r</span><span class="Constant">&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L122" title="kernel/blk_drv/floppy.c:122">selected</a> = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../sched.c.html#L188" title="kernel/sched.c:188">wake_up</a>(&amp;<a href="#L123" title="kernel/blk_drv/floppy.c:123">wait_on_floppy_select</a>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L114" title="kernel/blk_drv/floppy.c:114">floppy</a>-change is never called from an interrupt, so we can relax a bit<br/></li>
<li></span><span class="Comment"> * here, sleep etc. Note that <a href="#L114" title="kernel/blk_drv/floppy.c:114">floppy</a>-on tries to set <a href="../sched.c.html#L204" title="kernel/sched.c:204">current_DOR</a> to point<br/></li>
<li></span><span class="Comment"> * to the desired drive, but it will probably not survive the sleep if<br/></li>
<li></span><span class="Comment"> * several floppies are used at the same time: thus the loop.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li><a id="L139">&#x200c;</a></span><span class="Type">int</span> <span class="linkable">floppy_change</span>(<span class="Type">unsigned</span> <span class="Type">int</span> nr)<br/></li>
<li>{<br/></li>
<li><span class="Statement">repeat</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../sched.c.html#L232" title="kernel/sched.c:232">floppy_on</a>(nr);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">while</span> ((<a href="../sched.c.html#L204" title="kernel/sched.c:204">current_DOR</a> &amp; <span class="Constant">3</span>) != nr &amp;&amp; <a href="#L122" title="kernel/blk_drv/floppy.c:122">selected</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../sched.c.html#L167" title="kernel/sched.c:167">interruptible_sleep_on</a>(&amp;<a href="#L123" title="kernel/blk_drv/floppy.c:123">wait_on_floppy_select</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((<a href="../sched.c.html#L204" title="kernel/sched.c:204">current_DOR</a> &amp; <span class="Constant">3</span>) != nr)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> repeat;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../include/asm/io.h.html#L5" title="include/asm/io.h:5">inb</a>(<a href="../../include/linux/fdreg.h.html#L19" title="include/linux/fdreg.h:19">FD_DIR</a>) &amp; <span class="Constant">0x80</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../sched.c.html#L240" title="kernel/sched.c:240">floppy_off</a>(nr);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../sched.c.html#L240" title="kernel/sched.c:240">floppy_off</a>(nr);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L155">&#x200c;</a><span class="PreProc">#define <span class="linkable">copy_buffer</span>(from,to) \<br/></li>
<li></span><span class="PreProc">__asm__(</span><span class="Constant">&quot;cld ; rep ; movsl&quot;</span><span class="PreProc"> \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; &nbsp; &nbsp; ::</span><span class="Constant">&quot;c&quot;</span><span class="PreProc"> (<a href="../../include/linux/fs.h.html#L49" title="include/linux/fs.h:49">BLOCK_SIZE</a>/</span><span class="Constant">4</span><span class="PreProc">),</span><span class="Constant">&quot;S&quot;</span><span class="PreProc"> ((</span><span class="Type">long</span><span class="PreProc">)(from)),</span><span class="Constant">&quot;D&quot;</span><span class="PreProc"> ((</span><span class="Type">long</span><span class="PreProc">)(to)) \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; &nbsp; &nbsp; :)<br/></li>
<li></span><br/></li>
<li><a id="L160">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">setup_DMA</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">long</span> addr = (<span class="Type">long</span>) <a href="blk.h.html#L93" title="kernel/blk_drv/blk.h:93">CURRENT</a>-&gt;buffer;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../include/asm/system.h.html#L17" title="include/asm/system.h:17">cli</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (addr &gt;= <span class="Constant">0x100000</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; addr = (<span class="Type">long</span>) tmp_floppy_area;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L121" title="kernel/blk_drv/floppy.c:121">command</a> == <a href="../../include/linux/fdreg.h.html#L63" title="include/linux/fdreg.h:63">FD_WRITE</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L155" title="kernel/blk_drv/floppy.c:155">copy_buffer</a>(<a href="blk.h.html#L93" title="kernel/blk_drv/blk.h:93">CURRENT</a>-&gt;buffer,tmp_floppy_area);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><span class="Comment">/* mask DMA 2 */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L50" title="kernel/blk_drv/floppy.c:50">immoutb_p</a>(<span class="Constant">4</span>|<span class="Constant">2</span>,<span class="Constant">10</span>);<br/></li>
<li><span class="Comment">/* output <a href="#L121" title="kernel/blk_drv/floppy.c:121">command</a> byte. I don't know why, but everyone (minix, */<br/></li>
<li></span><span class="Comment">/* sanches &amp; canton) output this twice, first to 12 then to 11 */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; __asm__(<span class="Constant">&quot;<a href="../../include/asm/io.h.html#L1" title="include/asm/io.h:1">outb</a> </span><span class="Special">%%</span><span class="Constant">al,$12</span><span class="Special">\n\t</span><span class="Constant">jmp 1f</span><span class="Special">\n</span><span class="Constant">1:</span><span class="Special">\t</span><span class="Constant">jmp 1f</span><span class="Special">\n</span><span class="Constant">1:</span><span class="Special">\t</span><span class="Constant">&quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;<a href="../../include/asm/io.h.html#L1" title="include/asm/io.h:1">outb</a> </span><span class="Special">%%</span><span class="Constant">al,$11</span><span class="Special">\n\t</span><span class="Constant">jmp 1f</span><span class="Special">\n</span><span class="Constant">1:</span><span class="Special">\t</span><span class="Constant">jmp 1f</span><span class="Special">\n</span><span class="Constant">1:&quot;</span>::<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;a&quot;</span> ((<span class="Type">char</span>) ((<a href="#L121" title="kernel/blk_drv/floppy.c:121">command</a> == <a href="../../include/linux/fdreg.h.html#L62" title="include/linux/fdreg.h:62">FD_READ</a>)?<a href="../../include/linux/fdreg.h.html#L68" title="include/linux/fdreg.h:68">DMA_READ</a>:<a href="../../include/linux/fdreg.h.html#L69" title="include/linux/fdreg.h:69">DMA_WRITE</a>)));<br/></li>
<li><span class="Comment">/* 8 low bits of addr */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L50" title="kernel/blk_drv/floppy.c:50">immoutb_p</a>(addr,<span class="Constant">4</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; addr &gt;&gt;= <span class="Constant">8</span>;<br/></li>
<li><span class="Comment">/* bits 8-15 of addr */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L50" title="kernel/blk_drv/floppy.c:50">immoutb_p</a>(addr,<span class="Constant">4</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; addr &gt;&gt;= <span class="Constant">8</span>;<br/></li>
<li><span class="Comment">/* bits 16-19 of addr */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L50" title="kernel/blk_drv/floppy.c:50">immoutb_p</a>(addr,<span class="Constant">0x81</span>);<br/></li>
<li><span class="Comment">/* low 8 bits of <a href="../../fs/exec.c.html#L75" title="fs/exec.c:75">count</a>-1 (1024-1=0x3ff) */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L50" title="kernel/blk_drv/floppy.c:50">immoutb_p</a>(<span class="Constant">0xff</span>,<span class="Constant">5</span>);<br/></li>
<li><span class="Comment">/* high 8 bits of <a href="../../fs/exec.c.html#L75" title="fs/exec.c:75">count</a>-1 */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L50" title="kernel/blk_drv/floppy.c:50">immoutb_p</a>(<span class="Constant">3</span>,<span class="Constant">5</span>);<br/></li>
<li><span class="Comment">/* activate DMA 2 */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L50" title="kernel/blk_drv/floppy.c:50">immoutb_p</a>(<span class="Constant">0</span>|<span class="Constant">2</span>,<span class="Constant">10</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../include/asm/system.h.html#L16" title="include/asm/system.h:16">sti</a>();<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L194">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">output_byte</span>(<span class="Type">char</span> byte)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> counter;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">unsigned</span> <span class="Type">char</span> status;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="hd.c.html#L40" title="kernel/blk_drv/hd.c:40">reset</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span>(counter = <span class="Constant">0</span> ; counter &lt; <span class="Constant">10000</span> ; counter++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; status = <a href="../../include/asm/io.h.html#L17" title="include/asm/io.h:17">inb_p</a>(<a href="../../include/linux/fdreg.h.html#L16" title="include/linux/fdreg.h:16">FD_STATUS</a>) &amp; (<a href="../../include/linux/fdreg.h.html#L27" title="include/linux/fdreg.h:27">STATUS_READY</a> | <a href="../../include/linux/fdreg.h.html#L26" title="include/linux/fdreg.h:26">STATUS_DIR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (status == <a href="../../include/linux/fdreg.h.html#L27" title="include/linux/fdreg.h:27">STATUS_READY</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../include/asm/io.h.html#L1" title="include/asm/io.h:1">outb</a>(byte,<a href="../../include/linux/fdreg.h.html#L17" title="include/linux/fdreg.h:17">FD_DATA</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="hd.c.html#L40" title="kernel/blk_drv/hd.c:40">reset</a> = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../printk.c.html#L21" title="kernel/printk.c:21">printk</a>(<span class="Constant">&quot;Unable to send byte to FDC</span><span class="Special">\n\r</span><span class="Constant">&quot;</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L212">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">result</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> i = <span class="Constant">0</span>, counter, status;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="hd.c.html#L40" title="kernel/blk_drv/hd.c:40">reset</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (counter = <span class="Constant">0</span> ; counter &lt; <span class="Constant">10000</span> ; counter++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; status = <a href="../../include/asm/io.h.html#L17" title="include/asm/io.h:17">inb_p</a>(<a href="../../include/linux/fdreg.h.html#L16" title="include/linux/fdreg.h:16">FD_STATUS</a>)&amp;(<a href="../../include/linux/fdreg.h.html#L26" title="include/linux/fdreg.h:26">STATUS_DIR</a>|<a href="../../include/linux/fdreg.h.html#L27" title="include/linux/fdreg.h:27">STATUS_READY</a>|<a href="../../include/linux/fdreg.h.html#L24" title="include/linux/fdreg.h:24">STATUS_BUSY</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (status == <a href="../../include/linux/fdreg.h.html#L27" title="include/linux/fdreg.h:27">STATUS_READY</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> i;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (status == (<a href="../../include/linux/fdreg.h.html#L26" title="include/linux/fdreg.h:26">STATUS_DIR</a>|<a href="../../include/linux/fdreg.h.html#L27" title="include/linux/fdreg.h:27">STATUS_READY</a>|<a href="../../include/linux/fdreg.h.html#L24" title="include/linux/fdreg.h:24">STATUS_BUSY</a>)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (i &gt;= <a href="#L65" title="kernel/blk_drv/floppy.c:65">MAX_REPLIES</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L66" title="kernel/blk_drv/floppy.c:66">reply_buffer</a>[i++] = <a href="../../include/asm/io.h.html#L17" title="include/asm/io.h:17">inb_p</a>(<a href="../../include/linux/fdreg.h.html#L17" title="include/linux/fdreg.h:17">FD_DATA</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="hd.c.html#L40" title="kernel/blk_drv/hd.c:40">reset</a> = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../printk.c.html#L21" title="kernel/printk.c:21">printk</a>(<span class="Constant">&quot;Getstatus times out</span><span class="Special">\n\r</span><span class="Constant">&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant">1</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L233">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">bad_flp_intr</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="blk.h.html#L93" title="kernel/blk_drv/blk.h:93">CURRENT</a>-&gt;errors++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="blk.h.html#L93" title="kernel/blk_drv/blk.h:93">CURRENT</a>-&gt;errors &gt; <a href="hd.c.html#L34" title="kernel/blk_drv/hd.c:34">MAX_ERRORS</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L125" title="kernel/blk_drv/floppy.c:125">floppy_deselect</a>(<a href="#L115" title="kernel/blk_drv/floppy.c:115">current_drive</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="blk.h.html#L109" title="kernel/blk_drv/blk.h:109">end_request</a>(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="blk.h.html#L93" title="kernel/blk_drv/blk.h:93">CURRENT</a>-&gt;errors &gt; <a href="hd.c.html#L34" title="kernel/blk_drv/hd.c:34">MAX_ERRORS</a>/<span class="Constant">2</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="hd.c.html#L40" title="kernel/blk_drv/hd.c:40">reset</a> = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="hd.c.html#L39" title="kernel/blk_drv/hd.c:39">recalibrate</a> = <span class="Constant">1</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Ok, this interrupt is called after a DMA read/write has succeeded,<br/></li>
<li></span><span class="Comment"> * so we check the results, and copy any buffers.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li><a id="L250">&#x200c;</a></span><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">rw_interrupt</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L212" title="kernel/blk_drv/floppy.c:212">result</a>() != <span class="Constant">7</span> || (<a href="#L67" title="kernel/blk_drv/floppy.c:67">ST0</a> &amp; <span class="Constant">0xf8</span>) || (<a href="#L68" title="kernel/blk_drv/floppy.c:68">ST1</a> &amp; <span class="Constant">0xbf</span>) || (<a href="#L69" title="kernel/blk_drv/floppy.c:69">ST2</a> &amp; <span class="Constant">0x73</span>)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L68" title="kernel/blk_drv/floppy.c:68">ST1</a> &amp; <span class="Constant">0x02</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../printk.c.html#L21" title="kernel/printk.c:21">printk</a>(<span class="Constant">&quot;Drive </span><span class="Special">%d</span><span class="Constant"> is write protected</span><span class="Special">\n\r</span><span class="Constant">&quot;</span>,<a href="#L115" title="kernel/blk_drv/floppy.c:115">current_drive</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L125" title="kernel/blk_drv/floppy.c:125">floppy_deselect</a>(<a href="#L115" title="kernel/blk_drv/floppy.c:115">current_drive</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="blk.h.html#L109" title="kernel/blk_drv/blk.h:109">end_request</a>(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L233" title="kernel/blk_drv/floppy.c:233">bad_flp_intr</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L417" title="kernel/blk_drv/floppy.c:417">do_fd_request</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L121" title="kernel/blk_drv/floppy.c:121">command</a> == <a href="../../include/linux/fdreg.h.html#L62" title="include/linux/fdreg.h:62">FD_READ</a> &amp;&amp; (<span class="Type">unsigned</span> <span class="Type">long</span>)(<a href="blk.h.html#L93" title="kernel/blk_drv/blk.h:93">CURRENT</a>-&gt;buffer) &gt;= <span class="Constant">0x100000</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L155" title="kernel/blk_drv/floppy.c:155">copy_buffer</a>(tmp_floppy_area,<a href="blk.h.html#L93" title="kernel/blk_drv/blk.h:93">CURRENT</a>-&gt;buffer);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L125" title="kernel/blk_drv/floppy.c:125">floppy_deselect</a>(<a href="#L115" title="kernel/blk_drv/floppy.c:115">current_drive</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="blk.h.html#L109" title="kernel/blk_drv/blk.h:109">end_request</a>(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L417" title="kernel/blk_drv/floppy.c:417">do_fd_request</a>();<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L269">&#x200c;</a><span class="Type"><a href="../../lib/string.c.html#L12" title="lib/string.c:12">inline</a></span> <span class="Type">void</span> <span class="linkable">setup_rw_floppy</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L160" title="kernel/blk_drv/floppy.c:160">setup_DMA</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; do_floppy = <a href="#L250" title="kernel/blk_drv/floppy.c:250">rw_interrupt</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L194" title="kernel/blk_drv/floppy.c:194">output_byte</a>(<a href="#L121" title="kernel/blk_drv/floppy.c:121">command</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L194" title="kernel/blk_drv/floppy.c:194">output_byte</a>(<a href="#L117" title="kernel/blk_drv/floppy.c:117">head</a>&lt;&lt;<span class="Constant">2</span> | <a href="#L115" title="kernel/blk_drv/floppy.c:115">current_drive</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L194" title="kernel/blk_drv/floppy.c:194">output_byte</a>(<a href="#L118" title="kernel/blk_drv/floppy.c:118">track</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L194" title="kernel/blk_drv/floppy.c:194">output_byte</a>(<a href="#L117" title="kernel/blk_drv/floppy.c:117">head</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L194" title="kernel/blk_drv/floppy.c:194">output_byte</a>(<a href="#L116" title="kernel/blk_drv/floppy.c:116">sector</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L194" title="kernel/blk_drv/floppy.c:194">output_byte</a>(<span class="Constant">2</span>);&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* <a href="#L116" title="kernel/blk_drv/floppy.c:116">sector</a> size = 512 */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L194" title="kernel/blk_drv/floppy.c:194">output_byte</a>(<a href="#L114" title="kernel/blk_drv/floppy.c:114">floppy</a>-&gt;sect);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L194" title="kernel/blk_drv/floppy.c:194">output_byte</a>(<a href="#L114" title="kernel/blk_drv/floppy.c:114">floppy</a>-&gt;gap);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L194" title="kernel/blk_drv/floppy.c:194">output_byte</a>(<span class="Constant">0xFF</span>);&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* <a href="#L116" title="kernel/blk_drv/floppy.c:116">sector</a> size (0xff when n!=0 ?) */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="hd.c.html#L40" title="kernel/blk_drv/hd.c:40">reset</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L417" title="kernel/blk_drv/floppy.c:417">do_fd_request</a>();<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * This is the routine called after every <a href="#L46" title="kernel/blk_drv/floppy.c:46">seek</a> (or <a href="hd.c.html#L39" title="kernel/blk_drv/hd.c:39">recalibrate</a>) interrupt<br/></li>
<li></span><span class="Comment"> * from the <a href="#L114" title="kernel/blk_drv/floppy.c:114">floppy</a> controller. Note that the &quot;unexpected interrupt&quot; routine<br/></li>
<li></span><span class="Comment"> * also does a <a href="hd.c.html#L39" title="kernel/blk_drv/hd.c:39">recalibrate</a>, but doesn't come here.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li><a id="L291">&#x200c;</a></span><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">seek_interrupt</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li><span class="Comment">/* sense drive status */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L194" title="kernel/blk_drv/floppy.c:194">output_byte</a>(<a href="../../include/linux/fdreg.h.html#L64" title="include/linux/fdreg.h:64">FD_SENSEI</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L212" title="kernel/blk_drv/floppy.c:212">result</a>() != <span class="Constant">2</span> || (<a href="#L67" title="kernel/blk_drv/floppy.c:67">ST0</a> &amp; <span class="Constant">0xF8</span>) != <span class="Constant">0x20</span> || <a href="#L68" title="kernel/blk_drv/floppy.c:68">ST1</a> != <a href="#L119" title="kernel/blk_drv/floppy.c:119">seek_track</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L233" title="kernel/blk_drv/floppy.c:233">bad_flp_intr</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L417" title="kernel/blk_drv/floppy.c:417">do_fd_request</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L120" title="kernel/blk_drv/floppy.c:120">current_track</a> = <a href="#L68" title="kernel/blk_drv/floppy.c:68">ST1</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L269" title="kernel/blk_drv/floppy.c:269">setup_rw_floppy</a>();<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * This routine is called when everything should be correctly set up<br/></li>
<li></span><span class="Comment"> * for the <a href="#L309" title="kernel/blk_drv/floppy.c:309">transfer</a> (ie <a href="#L114" title="kernel/blk_drv/floppy.c:114">floppy</a> motor is on and the correct <a href="#L114" title="kernel/blk_drv/floppy.c:114">floppy</a> is<br/></li>
<li></span><span class="Comment"> * <a href="#L122" title="kernel/blk_drv/floppy.c:122">selected</a>).<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li><a id="L309">&#x200c;</a></span><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">transfer</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L112" title="kernel/blk_drv/floppy.c:112">cur_spec1</a> != <a href="#L114" title="kernel/blk_drv/floppy.c:114">floppy</a>-&gt;spec1) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L112" title="kernel/blk_drv/floppy.c:112">cur_spec1</a> = <a href="#L114" title="kernel/blk_drv/floppy.c:114">floppy</a>-&gt;spec1;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L194" title="kernel/blk_drv/floppy.c:194">output_byte</a>(<a href="../../include/linux/fdreg.h.html#L65" title="include/linux/fdreg.h:65">FD_SPECIFY</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L194" title="kernel/blk_drv/floppy.c:194">output_byte</a>(<a href="#L112" title="kernel/blk_drv/floppy.c:112">cur_spec1</a>);&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* hut etc */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L194" title="kernel/blk_drv/floppy.c:194">output_byte</a>(<span class="Constant">6</span>);&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Head load time =6ms, DMA */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L113" title="kernel/blk_drv/floppy.c:113">cur_rate</a> != <a href="#L114" title="kernel/blk_drv/floppy.c:114">floppy</a>-&gt;rate)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../include/asm/io.h.html#L11" title="include/asm/io.h:11">outb_p</a>(<a href="#L113" title="kernel/blk_drv/floppy.c:113">cur_rate</a> = <a href="#L114" title="kernel/blk_drv/floppy.c:114">floppy</a>-&gt;rate,<a href="../../include/linux/fdreg.h.html#L20" title="include/linux/fdreg.h:20">FD_DCR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="hd.c.html#L40" title="kernel/blk_drv/hd.c:40">reset</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L417" title="kernel/blk_drv/floppy.c:417">do_fd_request</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!<a href="#L46" title="kernel/blk_drv/floppy.c:46">seek</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L269" title="kernel/blk_drv/floppy.c:269">setup_rw_floppy</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; do_floppy = <a href="#L291" title="kernel/blk_drv/floppy.c:291">seek_interrupt</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L119" title="kernel/blk_drv/floppy.c:119">seek_track</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L194" title="kernel/blk_drv/floppy.c:194">output_byte</a>(<a href="../../include/linux/fdreg.h.html#L61" title="include/linux/fdreg.h:61">FD_SEEK</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L194" title="kernel/blk_drv/floppy.c:194">output_byte</a>(<a href="#L117" title="kernel/blk_drv/floppy.c:117">head</a>&lt;&lt;<span class="Constant">2</span> | <a href="#L115" title="kernel/blk_drv/floppy.c:115">current_drive</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L194" title="kernel/blk_drv/floppy.c:194">output_byte</a>(<a href="#L119" title="kernel/blk_drv/floppy.c:119">seek_track</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L194" title="kernel/blk_drv/floppy.c:194">output_byte</a>(<a href="../../include/linux/fdreg.h.html#L60" title="include/linux/fdreg.h:60">FD_RECALIBRATE</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L194" title="kernel/blk_drv/floppy.c:194">output_byte</a>(<a href="#L117" title="kernel/blk_drv/floppy.c:117">head</a>&lt;&lt;<span class="Constant">2</span> | <a href="#L115" title="kernel/blk_drv/floppy.c:115">current_drive</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="hd.c.html#L40" title="kernel/blk_drv/hd.c:40">reset</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L417" title="kernel/blk_drv/floppy.c:417">do_fd_request</a>();<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Special case - used after a unexpected interrupt (or <a href="hd.c.html#L40" title="kernel/blk_drv/hd.c:40">reset</a>)<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li><a id="L343">&#x200c;</a></span><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">recal_interrupt</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L194" title="kernel/blk_drv/floppy.c:194">output_byte</a>(<a href="../../include/linux/fdreg.h.html#L64" title="include/linux/fdreg.h:64">FD_SENSEI</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L212" title="kernel/blk_drv/floppy.c:212">result</a>()!=<span class="Constant">2</span> || (<a href="#L67" title="kernel/blk_drv/floppy.c:67">ST0</a> &amp; <span class="Constant">0xE0</span>) == <span class="Constant">0x60</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="hd.c.html#L40" title="kernel/blk_drv/hd.c:40">reset</a> = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="hd.c.html#L39" title="kernel/blk_drv/hd.c:39">recalibrate</a> = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L417" title="kernel/blk_drv/floppy.c:417">do_fd_request</a>();<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L353">&#x200c;</a><span class="Type">void</span> <span class="linkable">unexpected_floppy_interrupt</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L194" title="kernel/blk_drv/floppy.c:194">output_byte</a>(<a href="../../include/linux/fdreg.h.html#L64" title="include/linux/fdreg.h:64">FD_SENSEI</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L212" title="kernel/blk_drv/floppy.c:212">result</a>()!=<span class="Constant">2</span> || (<a href="#L67" title="kernel/blk_drv/floppy.c:67">ST0</a> &amp; <span class="Constant">0xE0</span>) == <span class="Constant">0x60</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="hd.c.html#L40" title="kernel/blk_drv/hd.c:40">reset</a> = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="hd.c.html#L39" title="kernel/blk_drv/hd.c:39">recalibrate</a> = <span class="Constant">1</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L362">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">recalibrate_floppy</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="hd.c.html#L39" title="kernel/blk_drv/hd.c:39">recalibrate</a> = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L120" title="kernel/blk_drv/floppy.c:120">current_track</a> = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; do_floppy = <a href="#L343" title="kernel/blk_drv/floppy.c:343">recal_interrupt</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L194" title="kernel/blk_drv/floppy.c:194">output_byte</a>(<a href="../../include/linux/fdreg.h.html#L60" title="include/linux/fdreg.h:60">FD_RECALIBRATE</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L194" title="kernel/blk_drv/floppy.c:194">output_byte</a>(<a href="#L117" title="kernel/blk_drv/floppy.c:117">head</a>&lt;&lt;<span class="Constant">2</span> | <a href="#L115" title="kernel/blk_drv/floppy.c:115">current_drive</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="hd.c.html#L40" title="kernel/blk_drv/hd.c:40">reset</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L417" title="kernel/blk_drv/floppy.c:417">do_fd_request</a>();<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L373">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">reset_interrupt</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L194" title="kernel/blk_drv/floppy.c:194">output_byte</a>(<a href="../../include/linux/fdreg.h.html#L64" title="include/linux/fdreg.h:64">FD_SENSEI</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; (<span class="Type">void</span>) <a href="#L212" title="kernel/blk_drv/floppy.c:212">result</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L194" title="kernel/blk_drv/floppy.c:194">output_byte</a>(<a href="../../include/linux/fdreg.h.html#L65" title="include/linux/fdreg.h:65">FD_SPECIFY</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L194" title="kernel/blk_drv/floppy.c:194">output_byte</a>(<a href="#L112" title="kernel/blk_drv/floppy.c:112">cur_spec1</a>);&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* hut etc */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L194" title="kernel/blk_drv/floppy.c:194">output_byte</a>(<span class="Constant">6</span>);&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Head load time =6ms, DMA */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L417" title="kernel/blk_drv/floppy.c:417">do_fd_request</a>();<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="hd.c.html#L40" title="kernel/blk_drv/hd.c:40">reset</a> is done by pulling bit 2 of DOR low for a while.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li><a id="L386">&#x200c;</a></span><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">reset_floppy</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> i;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="hd.c.html#L40" title="kernel/blk_drv/hd.c:40">reset</a> = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L112" title="kernel/blk_drv/floppy.c:112">cur_spec1</a> = -<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L113" title="kernel/blk_drv/floppy.c:113">cur_rate</a> = -<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="hd.c.html#L39" title="kernel/blk_drv/hd.c:39">recalibrate</a> = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../printk.c.html#L21" title="kernel/printk.c:21">printk</a>(<span class="Constant">&quot;Reset-<a href="#L114" title="kernel/blk_drv/floppy.c:114">floppy</a> called</span><span class="Special">\n\r</span><span class="Constant">&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../include/asm/system.h.html#L17" title="include/asm/system.h:17">cli</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; do_floppy = <a href="#L373" title="kernel/blk_drv/floppy.c:373">reset_interrupt</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../include/asm/io.h.html#L11" title="include/asm/io.h:11">outb_p</a>(<a href="../sched.c.html#L204" title="kernel/sched.c:204">current_DOR</a> &amp; ~<span class="Constant">0x04</span>,<a href="../../include/linux/fdreg.h.html#L18" title="include/linux/fdreg.h:18">FD_DOR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (i=<span class="Constant">0</span> ; i&lt;<span class="Constant">100</span> ; i++)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; __asm__(<span class="Constant">&quot;<a href="../../include/asm/system.h.html#L18" title="include/asm/system.h:18">nop</a>&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../include/asm/io.h.html#L1" title="include/asm/io.h:1">outb</a>(<a href="../sched.c.html#L204" title="kernel/sched.c:204">current_DOR</a>,<a href="../../include/linux/fdreg.h.html#L18" title="include/linux/fdreg.h:18">FD_DOR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../include/asm/system.h.html#L16" title="include/asm/system.h:16">sti</a>();<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L404">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">floppy_on_interrupt</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li><span class="Comment">/* We cannot do a <a href="#L114" title="kernel/blk_drv/floppy.c:114">floppy</a>-select, as that might sleep. We just force it */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L122" title="kernel/blk_drv/floppy.c:122">selected</a> = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L115" title="kernel/blk_drv/floppy.c:115">current_drive</a> != (<a href="../sched.c.html#L204" title="kernel/sched.c:204">current_DOR</a> &amp; <span class="Constant">3</span>)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../sched.c.html#L204" title="kernel/sched.c:204">current_DOR</a> &amp;= <span class="Constant">0xFC</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../sched.c.html#L204" title="kernel/sched.c:204">current_DOR</a> |= <a href="#L115" title="kernel/blk_drv/floppy.c:115">current_drive</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../include/asm/io.h.html#L1" title="include/asm/io.h:1">outb</a>(<a href="../sched.c.html#L204" title="kernel/sched.c:204">current_DOR</a>,<a href="../../include/linux/fdreg.h.html#L18" title="include/linux/fdreg.h:18">FD_DOR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../sched.c.html#L272" title="kernel/sched.c:272">add_timer</a>(<span class="Constant">2</span>,&amp;<a href="#L309" title="kernel/blk_drv/floppy.c:309">transfer</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L309" title="kernel/blk_drv/floppy.c:309">transfer</a>();<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L417">&#x200c;</a><span class="Type">void</span> <span class="linkable">do_fd_request</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">unsigned</span> <span class="Type">int</span> block;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L46" title="kernel/blk_drv/floppy.c:46">seek</a> = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="hd.c.html#L40" title="kernel/blk_drv/hd.c:40">reset</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L386" title="kernel/blk_drv/floppy.c:386">reset_floppy</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="hd.c.html#L39" title="kernel/blk_drv/hd.c:39">recalibrate</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L362" title="kernel/blk_drv/floppy.c:362">recalibrate_floppy</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="blk.h.html#L127" title="kernel/blk_drv/blk.h:127">INIT_REQUEST</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L114" title="kernel/blk_drv/floppy.c:114">floppy</a> = (<a href="../../include/linux/fs.h.html#L34" title="include/linux/fs.h:34">MINOR</a>(<a href="blk.h.html#L93" title="kernel/blk_drv/blk.h:93">CURRENT</a>-&gt;dev)&gt;&gt;<span class="Constant">2</span>) + <a href="#L85" title="kernel/blk_drv/floppy.c:85">floppy_type</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L115" title="kernel/blk_drv/floppy.c:115">current_drive</a> != <a href="blk.h.html#L94" title="kernel/blk_drv/blk.h:94">CURRENT_DEV</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L46" title="kernel/blk_drv/floppy.c:46">seek</a> = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L115" title="kernel/blk_drv/floppy.c:115">current_drive</a> = <a href="blk.h.html#L94" title="kernel/blk_drv/blk.h:94">CURRENT_DEV</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; block = <a href="blk.h.html#L93" title="kernel/blk_drv/blk.h:93">CURRENT</a>-&gt;<a href="#L116" title="kernel/blk_drv/floppy.c:116">sector</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (block+<span class="Constant">2</span> &gt; <a href="#L114" title="kernel/blk_drv/floppy.c:114">floppy</a>-&gt;size) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="blk.h.html#L109" title="kernel/blk_drv/blk.h:109">end_request</a>(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> repeat;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L116" title="kernel/blk_drv/floppy.c:116">sector</a> = block % <a href="#L114" title="kernel/blk_drv/floppy.c:114">floppy</a>-&gt;sect;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; block /= <a href="#L114" title="kernel/blk_drv/floppy.c:114">floppy</a>-&gt;sect;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L117" title="kernel/blk_drv/floppy.c:117">head</a> = block % <a href="#L114" title="kernel/blk_drv/floppy.c:114">floppy</a>-&gt;<a href="#L117" title="kernel/blk_drv/floppy.c:117">head</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L118" title="kernel/blk_drv/floppy.c:118">track</a> = block / <a href="#L114" title="kernel/blk_drv/floppy.c:114">floppy</a>-&gt;<a href="#L117" title="kernel/blk_drv/floppy.c:117">head</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L119" title="kernel/blk_drv/floppy.c:119">seek_track</a> = <a href="#L118" title="kernel/blk_drv/floppy.c:118">track</a> &lt;&lt; <a href="#L114" title="kernel/blk_drv/floppy.c:114">floppy</a>-&gt;stretch;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L119" title="kernel/blk_drv/floppy.c:119">seek_track</a> != <a href="#L120" title="kernel/blk_drv/floppy.c:120">current_track</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L46" title="kernel/blk_drv/floppy.c:46">seek</a> = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L116" title="kernel/blk_drv/floppy.c:116">sector</a>++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="blk.h.html#L93" title="kernel/blk_drv/blk.h:93">CURRENT</a>-&gt;cmd == <a href="../../include/linux/fs.h.html#L26" title="include/linux/fs.h:26">READ</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L121" title="kernel/blk_drv/floppy.c:121">command</a> = <a href="../../include/linux/fdreg.h.html#L62" title="include/linux/fdreg.h:62">FD_READ</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (<a href="blk.h.html#L93" title="kernel/blk_drv/blk.h:93">CURRENT</a>-&gt;cmd == <a href="../../include/linux/fs.h.html#L27" title="include/linux/fs.h:27">WRITE</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L121" title="kernel/blk_drv/floppy.c:121">command</a> = <a href="../../include/linux/fdreg.h.html#L63" title="include/linux/fdreg.h:63">FD_WRITE</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../panic.c.html#L16" title="kernel/panic.c:16">panic</a>(<span class="Constant">&quot;<a href="#L417" title="kernel/blk_drv/floppy.c:417">do_fd_request</a>: unknown <a href="#L121" title="kernel/blk_drv/floppy.c:121">command</a>&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../sched.c.html#L272" title="kernel/sched.c:272">add_timer</a>(<a href="../sched.c.html#L206" title="kernel/sched.c:206">ticks_to_floppy_on</a>(<a href="#L115" title="kernel/blk_drv/floppy.c:115">current_drive</a>),&amp;<a href="#L404" title="kernel/blk_drv/floppy.c:404">floppy_on_interrupt</a>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L457">&#x200c;</a><span class="Type">void</span> <span class="linkable">floppy_init</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ll_rw_blk.c.html#L32" title="kernel/blk_drv/ll_rw_blk.c:32">blk_dev</a>[<a href="ramdisk.c.html#L17" title="kernel/blk_drv/ramdisk.c:17">MAJOR_NR</a>].request_fn = <a href="blk.h.html#L64" title="kernel/blk_drv/blk.h:64">DEVICE_REQUEST</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../include/asm/system.h.html#L36" title="include/asm/system.h:36">set_trap_gate</a>(<span class="Constant">0x26</span>,&amp;floppy_interrupt);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../include/asm/io.h.html#L1" title="include/asm/io.h:1">outb</a>(<a href="../../include/asm/io.h.html#L17" title="include/asm/io.h:17">inb_p</a>(<span class="Constant">0x21</span>)&amp;~<span class="Constant">0x40</span>,<span class="Constant">0x21</span>);<br/></li>
<li>}<br/></li>
</ol></code>
 </body>
</html>
