<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>mm/memory.c - linux-0.11-ebook</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

code {
    font-family: consolas, monospace;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
  <h3>mm/memory.c - linux-0.11-ebook</h3>
   <a href="../index.html"> Table of Contents </a>
 <h4>Global variables defined</h4>
 <ul>
<li><a href="#L52">HIGH_MEMORY</a></li>
<li><a href="#L57">mem_map</a></li>
</ul>
 <h4>Functions defined</h4>
 <ul>
<li><a href="#L413">calc_mem</a></li>
<li><a href="#L150">copy_page_tables</a></li>
<li><a href="#L365">do_no_page</a></li>
<li><a href="#L247">do_wp_page</a></li>
<li><a href="#L89">free_page</a></li>
<li><a href="#L105">free_page_tables</a></li>
<li><a href="#L274">get_empty_page</a></li>
<li><a href="#L63">get_free_page</a></li>
<li><a href="#L399">mem_init</a></li>
<li><a href="#L33">oom</a></li>
<li><a href="#L197">put_page</a></li>
<li><a href="#L344">share_page</a></li>
<li><a href="#L292">try_to_share</a></li>
<li><a href="#L221">un_wp_page</a></li>
<li><a href="#L261">write_verify</a></li>
</ul>
 <h4>Macros defined</h4>
 <ul>
<li><a href="#L49">CODE_SPACE</a></li>
<li><a href="#L43">LOW_MEM</a></li>
<li><a href="#L46">MAP_NR</a></li>
<li><a href="#L44">PAGING_MEMORY</a></li>
<li><a href="#L45">PAGING_PAGES</a></li>
<li><a href="#L47">USED</a></li>
<li><a href="#L54">copy_page</a></li>
<li><a href="#L39">invalidate</a></li>
</ul>
 <h4>Source code</h4>

  <code><ol><li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> *&nbsp; linux/mm/memory.c<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *&nbsp; (C) 1991&nbsp; Linus Torvalds<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * demand-loading started 01.12.91 - seems it is high on the list of<br/></li>
<li></span><span class="Comment"> * things wanted, and it should be easy to implement. - Linus<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Ok, demand-loading was easy, shared pages a little bit tricker. Shared<br/></li>
<li></span><span class="Comment"> * pages started 02.12.91, seems to work. - Linus.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Tested sharing by executing about 30 /bin/sh: under the old kernel it<br/></li>
<li></span><span class="Comment"> * would have taken more than the 6M I have <a href="../include/linux/kernel.h.html#L12" title="include/linux/kernel.h:12">free</a>, but it worked well as<br/></li>
<li></span><span class="Comment"> * far as I could see.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Also corrected some &quot;<a href="#L39" title="mm/memory.c:39">invalidate</a>()&quot;s - I wasn't doing enough of them.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;signal.h&gt;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;asm/system.h&gt;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;linux/sched.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;linux/<a href="../kernel/blk_drv/floppy.c.html#L117" title="kernel/blk_drv/floppy.c:117">head</a>.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;linux/kernel.h&gt;<br/></li>
<li></span><br/></li>
<li><span class="Type">volatile</span> <span class="Type">void</span> <a href="../kernel/exit.c.html#L102" title="kernel/exit.c:102">do_exit</a>(<span class="Type">long</span> code);<br/></li>
<li><br/></li>
<li><a id="L33">&#x200c;</a><span class="Type">static</span> <span class="Type"><a href="../lib/string.c.html#L12" title="lib/string.c:12">inline</a></span> <span class="Type">volatile</span> <span class="Type">void</span> <span class="linkable">oom</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../kernel/printk.c.html#L21" title="kernel/printk.c:21">printk</a>(<span class="Constant">&quot;out of memory</span><span class="Special">\n\r</span><span class="Constant">&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../kernel/exit.c.html#L102" title="kernel/exit.c:102">do_exit</a>(<span class="Constant"><a href="../include/signal.h.html#L23" title="include/signal.h:23">SIGSEGV</a></span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L39">&#x200c;</a><span class="PreProc">#define <span class="linkable">invalidate</span>() \<br/></li>
<li></span><span class="PreProc">__asm__(</span><span class="Constant">&quot;movl </span><span class="Special">%%</span><span class="Constant">eax,</span><span class="Special">%%</span><span class="Constant">cr3&quot;</span><span class="PreProc">::</span><span class="Constant">&quot;a&quot;</span><span class="PreProc"> (</span><span class="Constant">0</span><span class="PreProc">))<br/></li>
<li></span><br/></li>
<li><span class="Comment">/* these are not to be changed without changing <a href="../kernel/blk_drv/floppy.c.html#L117" title="kernel/blk_drv/floppy.c:117">head</a>.s etc */<br/></li>
<li><a id="L43">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">LOW_MEM</span> </span><span class="Constant">0x100000<br/></li>
<li><a id="L44">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">PAGING_MEMORY</span> (</span><span class="Constant">15</span><span class="PreProc">*</span><span class="Constant">1024</span><span class="PreProc">*</span><span class="Constant">1024</span><span class="PreProc">)<br/></li>
<li><a id="L45">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">PAGING_PAGES</span> (<a href="#L44" title="mm/memory.c:44">PAGING_MEMORY</a>&gt;&gt;</span><span class="Constant">12</span><span class="PreProc">)<br/></li>
<li><a id="L46">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">MAP_NR</span>(addr) (((addr)-<a href="#L43" title="mm/memory.c:43">LOW_MEM</a>)&gt;&gt;</span><span class="Constant">12</span><span class="PreProc">)<br/></li>
<li><a id="L47">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">USED</span> </span><span class="Constant">100<br/></li>
<li></span><br/></li>
<li><a id="L49">&#x200c;</a><span class="PreProc">#define <span class="linkable">CODE_SPACE</span>(addr) ((((addr)+</span><span class="Constant">4095</span><span class="PreProc">)&amp;~</span><span class="Constant">4095</span><span class="PreProc">) &lt; \<br/></li>
<li></span><span class="PreProc"><a href="../kernel/sched.c.html#L62" title="kernel/sched.c:62">current</a>-&gt;start_code + <a href="../kernel/sched.c.html#L62" title="kernel/sched.c:62">current</a>-&gt;end_code)<br/></li>
<li></span><br/></li>
<li><a id="L52">&#x200c;</a><span class="Type">static</span> <span class="Type">long</span> <span class="linkable">HIGH_MEMORY</span> = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li><a id="L54">&#x200c;</a><span class="PreProc">#define <span class="linkable">copy_page</span>(from,to) \<br/></li>
<li></span><span class="PreProc">__asm__(</span><span class="Constant">&quot;cld ; rep ; movsl&quot;</span><span class="PreProc">::</span><span class="Constant">&quot;S&quot;</span><span class="PreProc"> (from),</span><span class="Constant">&quot;D&quot;</span><span class="PreProc"> (to),</span><span class="Constant">&quot;c&quot;</span><span class="PreProc"> (</span><span class="Constant">1024</span><span class="PreProc">):)<br/></li>
<li></span><br/></li>
<li><a id="L57">&#x200c;</a><span class="Type">static</span> <span class="Type">unsigned</span> <span class="Type">char</span> <span class="linkable">mem_map</span> [ <a href="#L45" title="mm/memory.c:45">PAGING_PAGES</a> ] = {<span class="Constant">0</span>,};<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Get physical address of first (actually last :-) <a href="../include/linux/kernel.h.html#L12" title="include/linux/kernel.h:12">free</a> page, and mark it<br/></li>
<li></span><span class="Comment"> * used. If no <a href="../include/linux/kernel.h.html#L12" title="include/linux/kernel.h:12">free</a> pages left, return 0.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li><a id="L63">&#x200c;</a></span><span class="Type">unsigned</span> <span class="Type">long</span> <span class="linkable">get_free_page</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li><span class="Type">register</span> <span class="Type">unsigned</span> <span class="Type">long</span> __res <span class="Statement">asm</span>(<span class="Constant">&quot;ax&quot;</span>);<br/></li>
<li><br/></li>
<li>__asm__(<span class="Constant">&quot;std ; repne ; scasb</span><span class="Special">\n\t</span><span class="Constant">&quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;jne 1f</span><span class="Special">\n\t</span><span class="Constant">&quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;movb $1,1(</span><span class="Special">%%</span><span class="Constant">edi)</span><span class="Special">\n\t</span><span class="Constant">&quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;sall $12,</span><span class="Special">%%</span><span class="Constant">ecx</span><span class="Special">\n\t</span><span class="Constant">&quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;addl %2,</span><span class="Special">%%</span><span class="Constant">ecx</span><span class="Special">\n\t</span><span class="Constant">&quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;movl </span><span class="Special">%%</span><span class="Constant">ecx,</span><span class="Special">%%</span><span class="Constant">edx</span><span class="Special">\n\t</span><span class="Constant">&quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;movl $1024,</span><span class="Special">%%</span><span class="Constant">ecx</span><span class="Special">\n\t</span><span class="Constant">&quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;leal 4092(</span><span class="Special">%%</span><span class="Constant">edx),</span><span class="Special">%%</span><span class="Constant">edi</span><span class="Special">\n\t</span><span class="Constant">&quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;rep ; stosl</span><span class="Special">\n\t</span><span class="Constant">&quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;movl </span><span class="Special">%%</span><span class="Constant">edx,</span><span class="Special">%%</span><span class="Constant">eax</span><span class="Special">\n</span><span class="Constant">&quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;1:&quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; :<span class="Constant">&quot;=a&quot;</span> (__res)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; :<span class="Constant">&quot;0&quot;</span> (<span class="Constant">0</span>),<span class="Constant">&quot;i&quot;</span> (<a href="#L43" title="mm/memory.c:43">LOW_MEM</a>),<span class="Constant">&quot;c&quot;</span> (<a href="#L45" title="mm/memory.c:45">PAGING_PAGES</a>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;D&quot;</span> (<a href="#L57" title="mm/memory.c:57">mem_map</a>+<a href="#L45" title="mm/memory.c:45">PAGING_PAGES</a>-<span class="Constant">1</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; :) ;<br/></li>
<li><span class="Statement">return</span> __res;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Free a page of memory at physical address 'addr'. Used by<br/></li>
<li></span><span class="Comment"> * '<a href="#L105" title="mm/memory.c:105">free_page_tables</a>()'<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li><a id="L89">&#x200c;</a></span><span class="Type">void</span> <span class="linkable">free_page</span>(<span class="Type">unsigned</span> <span class="Type">long</span> addr)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (addr &lt; <a href="#L43" title="mm/memory.c:43">LOW_MEM</a>) <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (addr &gt;= <a href="#L52" title="mm/memory.c:52">HIGH_MEMORY</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../kernel/panic.c.html#L16" title="kernel/panic.c:16">panic</a>(<span class="Constant">&quot;trying to <a href="../include/linux/kernel.h.html#L12" title="include/linux/kernel.h:12">free</a> nonexistent page&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; addr -= <a href="#L43" title="mm/memory.c:43">LOW_MEM</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; addr &gt;&gt;= <span class="Constant">12</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L57" title="mm/memory.c:57">mem_map</a>[addr]--) <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L57" title="mm/memory.c:57">mem_map</a>[addr]=<span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../kernel/panic.c.html#L16" title="kernel/panic.c:16">panic</a>(<span class="Constant">&quot;trying to <a href="../include/linux/kernel.h.html#L12" title="include/linux/kernel.h:12">free</a> <a href="../include/linux/kernel.h.html#L12" title="include/linux/kernel.h:12">free</a> page&quot;</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * This function frees a continuos block of page tables, as needed<br/></li>
<li></span><span class="Comment"> * by 'exit()'. As does <a href="#L150" title="mm/memory.c:150">copy_page_tables</a>(), this handles only 4Mb blocks.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li><a id="L105">&#x200c;</a></span><span class="Type">int</span> <span class="linkable">free_page_tables</span>(<span class="Type">unsigned</span> <span class="Type">long</span> from,<span class="Type">unsigned</span> <span class="Type">long</span> size)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">unsigned</span> <span class="Type">long</span> *pg_table;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">unsigned</span> <span class="Type">long</span> * dir, nr;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (from &amp; <span class="Constant">0x3fffff</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../kernel/panic.c.html#L16" title="kernel/panic.c:16">panic</a>(<span class="Constant">&quot;<a href="#L105" title="mm/memory.c:105">free_page_tables</a> called with wrong alignment&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!from)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../kernel/panic.c.html#L16" title="kernel/panic.c:16">panic</a>(<span class="Constant">&quot;Trying to <a href="../include/linux/kernel.h.html#L12" title="include/linux/kernel.h:12">free</a> up swapper memory space&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; size = (size + <span class="Constant">0x3fffff</span>) &gt;&gt; <span class="Constant">22</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; dir = (<span class="Type">unsigned</span> <span class="Type">long</span> *) ((from&gt;&gt;<span class="Constant">20</span>) &amp; <span class="Constant">0xffc</span>); <span class="Comment">/* _pg_dir = 0 */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> ( ; size--&gt;<span class="Constant">0</span> ; dir++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!(<span class="Constant">1</span> &amp; *dir))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pg_table = (<span class="Type">unsigned</span> <span class="Type">long</span> *) (<span class="Constant">0xfffff000</span> &amp; *dir);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (nr=<span class="Constant">0</span> ; nr&lt;<span class="Constant">1024</span> ; nr++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<span class="Constant">1</span> &amp; *pg_table)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L89" title="mm/memory.c:89">free_page</a>(<span class="Constant">0xfffff000</span> &amp; *pg_table);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *pg_table = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pg_table++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L89" title="mm/memory.c:89">free_page</a>(<span class="Constant">0xfffff000</span> &amp; *dir);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *dir = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L39" title="mm/memory.c:39">invalidate</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> *&nbsp; Well, here is one of the most complicated functions in mm. It<br/></li>
<li></span><span class="Comment"> * copies a range of linerar addresses by copying only the pages.<br/></li>
<li></span><span class="Comment"> * Let's hope this is bug-<a href="../include/linux/kernel.h.html#L12" title="include/linux/kernel.h:12">free</a>, 'cause this one I don't want to debug :-)<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Note! We don't copy just any chunks of memory - addresses have to<br/></li>
<li></span><span class="Comment"> * be divisible by 4Mb (one page-directory entry), as this makes the<br/></li>
<li></span><span class="Comment"> * function easier. It's used only by fork anyway.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * NOTE 2!! When from==0 we are copying kernel space for the first<br/></li>
<li></span><span class="Comment"> * fork(). Then we DONT want to copy a full page-directory entry, as<br/></li>
<li></span><span class="Comment"> * that would lead to some serious memory waste - we just copy the<br/></li>
<li></span><span class="Comment"> * first 160 pages - 640kB. Even that is more than we need, but it<br/></li>
<li></span><span class="Comment"> * doesn't take any more memory - we don't copy-on-write in the low<br/></li>
<li></span><span class="Comment"> * 1 Mb-range, so the pages can be shared with the kernel. Thus the<br/></li>
<li></span><span class="Comment"> * special case for nr=xxxx.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li><a id="L150">&#x200c;</a></span><span class="Type">int</span> <span class="linkable">copy_page_tables</span>(<span class="Type">unsigned</span> <span class="Type">long</span> from,<span class="Type">unsigned</span> <span class="Type">long</span> to,<span class="Type">long</span> size)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">unsigned</span> <span class="Type">long</span> * from_page_table;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">unsigned</span> <span class="Type">long</span> * to_page_table;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">unsigned</span> <span class="Type">long</span> this_page;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">unsigned</span> <span class="Type">long</span> * from_dir, * to_dir;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">unsigned</span> <span class="Type">long</span> nr;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((from&amp;<span class="Constant">0x3fffff</span>) || (to&amp;<span class="Constant">0x3fffff</span>))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../kernel/panic.c.html#L16" title="kernel/panic.c:16">panic</a>(<span class="Constant">&quot;<a href="#L150" title="mm/memory.c:150">copy_page_tables</a> called with wrong alignment&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; from_dir = (<span class="Type">unsigned</span> <span class="Type">long</span> *) ((from&gt;&gt;<span class="Constant">20</span>) &amp; <span class="Constant">0xffc</span>); <span class="Comment">/* _pg_dir = 0 */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; to_dir = (<span class="Type">unsigned</span> <span class="Type">long</span> *) ((to&gt;&gt;<span class="Constant">20</span>) &amp; <span class="Constant">0xffc</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; size = ((<span class="Type">unsigned</span>) (size+<span class="Constant">0x3fffff</span>)) &gt;&gt; <span class="Constant">22</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span>( ; size--&gt;<span class="Constant">0</span> ; from_dir++,to_dir++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<span class="Constant">1</span> &amp; *to_dir)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../kernel/panic.c.html#L16" title="kernel/panic.c:16">panic</a>(<span class="Constant">&quot;<a href="#L150" title="mm/memory.c:150">copy_page_tables</a>: already exist&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!(<span class="Constant">1</span> &amp; *from_dir))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; from_page_table = (<span class="Type">unsigned</span> <span class="Type">long</span> *) (<span class="Constant">0xfffff000</span> &amp; *from_dir);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!(to_page_table = (<span class="Type">unsigned</span> <span class="Type">long</span> *) <a href="#L63" title="mm/memory.c:63">get_free_page</a>()))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant">1</span>;&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Out of memory, see freeing */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *to_dir = ((<span class="Type">unsigned</span> <span class="Type">long</span>) to_page_table) | <span class="Constant">7</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; nr = (from==<span class="Constant">0</span>)?<span class="Constant">0xA0</span>:<span class="Constant">1024</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> ( ; nr-- &gt; <span class="Constant">0</span> ; from_page_table++,to_page_table++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; this_page = *from_page_table;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!(<span class="Constant">1</span> &amp; this_page))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; this_page &amp;= ~<span class="Constant">2</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *to_page_table = this_page;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (this_page &gt; <a href="#L43" title="mm/memory.c:43">LOW_MEM</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *from_page_table = this_page;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; this_page -= <a href="#L43" title="mm/memory.c:43">LOW_MEM</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; this_page &gt;&gt;= <span class="Constant">12</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L57" title="mm/memory.c:57">mem_map</a>[this_page]++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L39" title="mm/memory.c:39">invalidate</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * This function puts a page in memory at the wanted address.<br/></li>
<li></span><span class="Comment"> * It returns the physical address of the page gotten, 0 if<br/></li>
<li></span><span class="Comment"> * out of memory (either when trying to access page-table or<br/></li>
<li></span><span class="Comment"> * page.)<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li><a id="L197">&#x200c;</a></span><span class="Type">unsigned</span> <span class="Type">long</span> <span class="linkable">put_page</span>(<span class="Type">unsigned</span> <span class="Type">long</span> page,<span class="Type">unsigned</span> <span class="Type">long</span> address)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">unsigned</span> <span class="Type">long</span> tmp, *page_table;<br/></li>
<li><br/></li>
<li><span class="Comment">/* NOTE !!! This uses the fact that _pg_dir=0 */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (page &lt; <a href="#L43" title="mm/memory.c:43">LOW_MEM</a> || page &gt;= <a href="#L52" title="mm/memory.c:52">HIGH_MEMORY</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../kernel/printk.c.html#L21" title="kernel/printk.c:21">printk</a>(<span class="Constant">&quot;Trying to put page </span><span class="Special">%p</span><span class="Constant"> at </span><span class="Special">%p\n</span><span class="Constant">&quot;</span>,page,address);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L57" title="mm/memory.c:57">mem_map</a>[(page-<a href="#L43" title="mm/memory.c:43">LOW_MEM</a>)&gt;&gt;<span class="Constant">12</span>] != <span class="Constant">1</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../kernel/printk.c.html#L21" title="kernel/printk.c:21">printk</a>(<span class="Constant">&quot;<a href="#L57" title="mm/memory.c:57">mem_map</a> disagrees with </span><span class="Special">%p</span><span class="Constant"> at </span><span class="Special">%p\n</span><span class="Constant">&quot;</span>,page,address);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; page_table = (<span class="Type">unsigned</span> <span class="Type">long</span> *) ((address&gt;&gt;<span class="Constant">20</span>) &amp; <span class="Constant">0xffc</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((*page_table)&amp;<span class="Constant">1</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; page_table = (<span class="Type">unsigned</span> <span class="Type">long</span> *) (<span class="Constant">0xfffff000</span> &amp; *page_table);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!(tmp=<a href="#L63" title="mm/memory.c:63">get_free_page</a>()))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *page_table = tmp|<span class="Constant">7</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; page_table = (<span class="Type">unsigned</span> <span class="Type">long</span> *) tmp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; page_table[(address&gt;&gt;<span class="Constant">12</span>) &amp; <span class="Constant">0x3ff</span>] = page | <span class="Constant">7</span>;<br/></li>
<li><span class="Comment">/* no need for <a href="#L39" title="mm/memory.c:39">invalidate</a> */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> page;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L221">&#x200c;</a><span class="Type">void</span> <span class="linkable">un_wp_page</span>(<span class="Type">unsigned</span> <span class="Type">long</span> * table_entry)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">unsigned</span> <span class="Type">long</span> old_page,new_page;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; old_page = <span class="Constant">0xfffff000</span> &amp; *table_entry;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (old_page &gt;= <a href="#L43" title="mm/memory.c:43">LOW_MEM</a> &amp;&amp; <a href="#L57" title="mm/memory.c:57">mem_map</a>[<a href="#L46" title="mm/memory.c:46">MAP_NR</a>(old_page)]==<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *table_entry |= <span class="Constant">2</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L39" title="mm/memory.c:39">invalidate</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!(new_page=<a href="#L63" title="mm/memory.c:63">get_free_page</a>()))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L33" title="mm/memory.c:33">oom</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (old_page &gt;= <a href="#L43" title="mm/memory.c:43">LOW_MEM</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L57" title="mm/memory.c:57">mem_map</a>[<a href="#L46" title="mm/memory.c:46">MAP_NR</a>(old_page)]--;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *table_entry = new_page | <span class="Constant">7</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L39" title="mm/memory.c:39">invalidate</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L54" title="mm/memory.c:54">copy_page</a>(old_page,new_page);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * This routine handles present pages, when users try to write<br/></li>
<li></span><span class="Comment"> * to a shared page. It is done by copying the page to a new address<br/></li>
<li></span><span class="Comment"> * and decrementing the shared-page counter for the old page.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * If it's in code space we exit with a segment error.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li><a id="L247">&#x200c;</a></span><span class="Type">void</span> <span class="linkable">do_wp_page</span>(<span class="Type">unsigned</span> <span class="Type">long</span> error_code,<span class="Type">unsigned</span> <span class="Type">long</span> address)<br/></li>
<li>{<br/></li>
<li><span class="Comment">#if 0<br/></li>
<li></span><span class="Comment">/* we cannot do this yet: the estdio library writes to code space */<br/></li>
<li></span><span class="Comment">/* stupid, stupid. I really want the libc.a from GNU */<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; if (<a href="#L49" title="mm/memory.c:49">CODE_SPACE</a>(address))<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../kernel/exit.c.html#L102" title="kernel/exit.c:102">do_exit</a>(<a href="../include/signal.h.html#L23" title="include/signal.h:23">SIGSEGV</a>);<br/></li>
<li></span><span class="Comment">#endif<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L221" title="mm/memory.c:221">un_wp_page</a>((<span class="Type">unsigned</span> <span class="Type">long</span> *)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (((address&gt;&gt;<span class="Constant">10</span>) &amp; <span class="Constant">0xffc</span>) + (<span class="Constant">0xfffff000</span> &amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *((<span class="Type">unsigned</span> <span class="Type">long</span> *) ((address&gt;&gt;<span class="Constant">20</span>) &amp;<span class="Constant">0xffc</span>)))));<br/></li>
<li><br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L261">&#x200c;</a><span class="Type">void</span> <span class="linkable">write_verify</span>(<span class="Type">unsigned</span> <span class="Type">long</span> address)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">unsigned</span> <span class="Type">long</span> page;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!( (page = *((<span class="Type">unsigned</span> <span class="Type">long</span> *) ((address&gt;&gt;<span class="Constant">20</span>) &amp; <span class="Constant">0xffc</span>)) )&amp;<span class="Constant">1</span>))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; page &amp;= <span class="Constant">0xfffff000</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; page += ((address&gt;&gt;<span class="Constant">10</span>) &amp; <span class="Constant">0xffc</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((<span class="Constant">3</span> &amp; *(<span class="Type">unsigned</span> <span class="Type">long</span> *) page) == <span class="Constant">1</span>)&nbsp; <span class="Comment">/* non-writeable, present */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L221" title="mm/memory.c:221">un_wp_page</a>((<span class="Type">unsigned</span> <span class="Type">long</span> *) page);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L274">&#x200c;</a><span class="Type">void</span> <span class="linkable">get_empty_page</span>(<span class="Type">unsigned</span> <span class="Type">long</span> address)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">unsigned</span> <span class="Type">long</span> tmp;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!(tmp=<a href="#L63" title="mm/memory.c:63">get_free_page</a>()) || !<a href="#L197" title="mm/memory.c:197">put_page</a>(tmp,address)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L89" title="mm/memory.c:89">free_page</a>(tmp);&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* 0 is ok - ignored */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L33" title="mm/memory.c:33">oom</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L292" title="mm/memory.c:292">try_to_share</a>() checks the page at address &quot;address&quot; in the <a href="../kernel/sched.c.html#L65" title="kernel/sched.c:65">task</a> &quot;p&quot;,<br/></li>
<li></span><span class="Comment"> * to see if it exists, and if it is clean. If so, share it with the <a href="../kernel/sched.c.html#L62" title="kernel/sched.c:62">current</a><br/></li>
<li></span><span class="Comment"> * <a href="../kernel/sched.c.html#L65" title="kernel/sched.c:65">task</a>.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * NOTE! This assumes we have checked that p != <a href="../kernel/sched.c.html#L62" title="kernel/sched.c:62">current</a>, and that they<br/></li>
<li></span><span class="Comment"> * share the same executable.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li><a id="L292">&#x200c;</a></span><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">try_to_share</span>(<span class="Type">unsigned</span> <span class="Type">long</span> address, <span class="Type">struct</span> <a href="../include/linux/sched.h.html#L78" title="include/linux/sched.h:78">task_struct</a> * p)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">unsigned</span> <span class="Type">long</span> from;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">unsigned</span> <span class="Type">long</span> to;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">unsigned</span> <span class="Type">long</span> from_page;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">unsigned</span> <span class="Type">long</span> to_page;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">unsigned</span> <span class="Type">long</span> phys_addr;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; from_page = to_page = ((address&gt;&gt;<span class="Constant">20</span>) &amp; <span class="Constant">0xffc</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; from_page += ((p-&gt;start_code&gt;&gt;<span class="Constant">20</span>) &amp; <span class="Constant">0xffc</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; to_page += ((<a href="../kernel/sched.c.html#L62" title="kernel/sched.c:62">current</a>-&gt;start_code&gt;&gt;<span class="Constant">20</span>) &amp; <span class="Constant">0xffc</span>);<br/></li>
<li><span class="Comment">/* is there a page-directory at from? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; from = *(<span class="Type">unsigned</span> <span class="Type">long</span> *) from_page;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!(from &amp; <span class="Constant">1</span>))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; from &amp;= <span class="Constant">0xfffff000</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; from_page = from + ((address&gt;&gt;<span class="Constant">10</span>) &amp; <span class="Constant">0xffc</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; phys_addr = *(<span class="Type">unsigned</span> <span class="Type">long</span> *) from_page;<br/></li>
<li><span class="Comment">/* is the page clean and present? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((phys_addr &amp; <span class="Constant">0x41</span>) != <span class="Constant">0x01</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; phys_addr &amp;= <span class="Constant">0xfffff000</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (phys_addr &gt;= <a href="#L52" title="mm/memory.c:52">HIGH_MEMORY</a> || phys_addr &lt; <a href="#L43" title="mm/memory.c:43">LOW_MEM</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; to = *(<span class="Type">unsigned</span> <span class="Type">long</span> *) to_page;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!(to &amp; <span class="Constant">1</span>))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (to = <a href="#L63" title="mm/memory.c:63">get_free_page</a>())<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *(<span class="Type">unsigned</span> <span class="Type">long</span> *) to_page = to | <span class="Constant">7</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L33" title="mm/memory.c:33">oom</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; to &amp;= <span class="Constant">0xfffff000</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; to_page = to + ((address&gt;&gt;<span class="Constant">10</span>) &amp; <span class="Constant">0xffc</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<span class="Constant">1</span> &amp; *(<span class="Type">unsigned</span> <span class="Type">long</span> *) to_page)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../kernel/panic.c.html#L16" title="kernel/panic.c:16">panic</a>(<span class="Constant">&quot;<a href="#L292" title="mm/memory.c:292">try_to_share</a>: to_page already exists&quot;</span>);<br/></li>
<li><span class="Comment">/* share them: write-protect */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; *(<span class="Type">unsigned</span> <span class="Type">long</span> *) from_page &amp;= ~<span class="Constant">2</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *(<span class="Type">unsigned</span> <span class="Type">long</span> *) to_page = *(<span class="Type">unsigned</span> <span class="Type">long</span> *) from_page;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L39" title="mm/memory.c:39">invalidate</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; phys_addr -= <a href="#L43" title="mm/memory.c:43">LOW_MEM</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; phys_addr &gt;&gt;= <span class="Constant">12</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L57" title="mm/memory.c:57">mem_map</a>[phys_addr]++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">1</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L344" title="mm/memory.c:344">share_page</a>() tries to find a process that could share a page with<br/></li>
<li></span><span class="Comment"> * the <a href="../kernel/sched.c.html#L62" title="kernel/sched.c:62">current</a> one. Address is the address of the wanted page relative<br/></li>
<li></span><span class="Comment"> * to the <a href="../kernel/sched.c.html#L62" title="kernel/sched.c:62">current</a> data space.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * We first check if it is at all feasible by checking executable-&gt;i_count.<br/></li>
<li></span><span class="Comment"> * It should be &gt;1 if there are other tasks sharing this inode.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li><a id="L344">&#x200c;</a></span><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">share_page</span>(<span class="Type">unsigned</span> <span class="Type">long</span> address)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">struct</span> <a href="../include/linux/sched.h.html#L78" title="include/linux/sched.h:78">task_struct</a> ** p;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!<a href="../kernel/sched.c.html#L62" title="kernel/sched.c:62">current</a>-&gt;executable)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../kernel/sched.c.html#L62" title="kernel/sched.c:62">current</a>-&gt;executable-&gt;i_count &lt; <span class="Constant">2</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (p = &amp;<a href="../include/linux/sched.h.html#L8" title="include/linux/sched.h:8">LAST_TASK</a> ; p &gt; &amp;<a href="../include/linux/sched.h.html#L7" title="include/linux/sched.h:7">FIRST_TASK</a> ; --p) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!*p)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../kernel/sched.c.html#L62" title="kernel/sched.c:62">current</a> == *p)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((*p)-&gt;executable != <a href="../kernel/sched.c.html#L62" title="kernel/sched.c:62">current</a>-&gt;executable)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L292" title="mm/memory.c:292">try_to_share</a>(address,*p))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L365">&#x200c;</a><span class="Type">void</span> <span class="linkable">do_no_page</span>(<span class="Type">unsigned</span> <span class="Type">long</span> error_code,<span class="Type">unsigned</span> <span class="Type">long</span> address)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> nr[<span class="Constant">4</span>];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">unsigned</span> <span class="Type">long</span> tmp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">unsigned</span> <span class="Type">long</span> page;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> block,i;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; address &amp;= <span class="Constant">0xfffff000</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; tmp = address - <a href="../kernel/sched.c.html#L62" title="kernel/sched.c:62">current</a>-&gt;start_code;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!<a href="../kernel/sched.c.html#L62" title="kernel/sched.c:62">current</a>-&gt;executable || tmp &gt;= <a href="../kernel/sched.c.html#L62" title="kernel/sched.c:62">current</a>-&gt;end_data) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L274" title="mm/memory.c:274">get_empty_page</a>(address);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L344" title="mm/memory.c:344">share_page</a>(tmp))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!(page = <a href="#L63" title="mm/memory.c:63">get_free_page</a>()))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L33" title="mm/memory.c:33">oom</a>();<br/></li>
<li><span class="Comment">/* remember that 1 block is used for header */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; block = <span class="Constant">1</span> + tmp/<a href="../include/linux/fs.h.html#L49" title="include/linux/fs.h:49">BLOCK_SIZE</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (i=<span class="Constant">0</span> ; i&lt;<span class="Constant">4</span> ; block++,i++)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; nr[i] = <a href="../fs/inode.c.html#L140" title="fs/inode.c:140">bmap</a>(<a href="../kernel/sched.c.html#L62" title="kernel/sched.c:62">current</a>-&gt;executable,block);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../fs/buffer.c.html#L296" title="fs/buffer.c:296">bread_page</a>(page,<a href="../kernel/sched.c.html#L62" title="kernel/sched.c:62">current</a>-&gt;executable-&gt;i_dev,nr);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; i = tmp + <span class="Constant">4096</span> - <a href="../kernel/sched.c.html#L62" title="kernel/sched.c:62">current</a>-&gt;end_data;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; tmp = page + <span class="Constant">4096</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">while</span> (i-- &gt; <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tmp--;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *(<span class="Type">char</span> *)tmp = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L197" title="mm/memory.c:197">put_page</a>(page,address))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L89" title="mm/memory.c:89">free_page</a>(page);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L33" title="mm/memory.c:33">oom</a>();<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L399">&#x200c;</a><span class="Type">void</span> <span class="linkable">mem_init</span>(<span class="Type">long</span> start_mem, <span class="Type">long</span> end_mem)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> i;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L52" title="mm/memory.c:52">HIGH_MEMORY</a> = end_mem;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (i=<span class="Constant">0</span> ; i&lt;<a href="#L45" title="mm/memory.c:45">PAGING_PAGES</a> ; i++)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L57" title="mm/memory.c:57">mem_map</a>[i] = <a href="#L47" title="mm/memory.c:47">USED</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; i = <a href="#L46" title="mm/memory.c:46">MAP_NR</a>(start_mem);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; end_mem -= start_mem;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; end_mem &gt;&gt;= <span class="Constant">12</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">while</span> (end_mem--&gt;<span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L57" title="mm/memory.c:57">mem_map</a>[i++]=<span class="Constant">0</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L413">&#x200c;</a><span class="Type">void</span> <span class="linkable">calc_mem</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> i,j,k,<a href="../include/linux/kernel.h.html#L12" title="include/linux/kernel.h:12">free</a>=<span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">long</span> * pg_tbl;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span>(i=<span class="Constant">0</span> ; i&lt;<a href="#L45" title="mm/memory.c:45">PAGING_PAGES</a> ; i++)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!<a href="#L57" title="mm/memory.c:57">mem_map</a>[i]) <a href="../include/linux/kernel.h.html#L12" title="include/linux/kernel.h:12">free</a>++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../kernel/printk.c.html#L21" title="kernel/printk.c:21">printk</a>(<span class="Constant">&quot;</span><span class="Special">%d</span><span class="Constant"> pages <a href="../include/linux/kernel.h.html#L12" title="include/linux/kernel.h:12">free</a> (of </span><span class="Special">%d</span><span class="Constant">)</span><span class="Special">\n\r</span><span class="Constant">&quot;</span>,<a href="../include/linux/kernel.h.html#L12" title="include/linux/kernel.h:12">free</a>,<a href="#L45" title="mm/memory.c:45">PAGING_PAGES</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span>(i=<span class="Constant">2</span> ; i&lt;<span class="Constant">1024</span> ; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<span class="Constant">1</span>&amp;pg_dir[i]) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pg_tbl=(<span class="Type">long</span> *) (<span class="Constant">0xfffff000</span> &amp; pg_dir[i]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span>(j=k=<span class="Constant">0</span> ; j&lt;<span class="Constant">1024</span> ; j++)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (pg_tbl[j]&amp;<span class="Constant">1</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; k++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../kernel/printk.c.html#L21" title="kernel/printk.c:21">printk</a>(<span class="Constant">&quot;Pg-dir[</span><span class="Special">%d</span><span class="Constant">] uses </span><span class="Special">%d</span><span class="Constant"> pages</span><span class="Special">\n</span><span class="Constant">&quot;</span>,i,k);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
</ol></code>
 </body>
</html>
