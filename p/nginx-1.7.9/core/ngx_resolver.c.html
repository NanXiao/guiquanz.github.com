<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>core/ngx_resolver.c - src</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

code {
    font-family: consolas, monospace;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
  <h3>core/ngx_resolver.c - src</h3>
   <a href="../index.html"> Table of Contents </a>
 <h4>Data types defined</h4>
 <ul>
<li><a href="#L48">ngx_resolver_an_t</a></li>
<li><a href="#L29">ngx_resolver_hdr_t</a></li>
<li><a href="#L37">ngx_resolver_qs_t</a></li>
</ul>
 <h4>Functions defined</h4>
 <ul>
<li><a href="#L714">ngx_resolve_addr</a></li>
<li><a href="#L918">ngx_resolve_addr_done</a></li>
<li><a href="#L357">ngx_resolve_name</a></li>
<li><a href="#L403">ngx_resolve_name_done</a></li>
<li><a href="#L470">ngx_resolve_name_locked</a></li>
<li><a href="#L318">ngx_resolve_start</a></li>
<li><a href="#L2850">ngx_resolver_alloc</a></li>
<li><a href="#L2865">ngx_resolver_calloc</a></li>
<li><a href="#L251">ngx_resolver_cleanup</a></li>
<li><a href="#L289">ngx_resolver_cleanup_tree</a></li>
<li><a href="#L2702">ngx_resolver_copy</a></li>
<li><a href="#L110">ngx_resolver_create</a></li>
<li><a href="#L2607">ngx_resolver_create_addr_query</a></li>
<li><a href="#L2479">ngx_resolver_create_name_query</a></li>
<li><a href="#L2898">ngx_resolver_dup</a></li>
<li><a href="#L1023">ngx_resolver_expire</a></li>
<li><a href="#L2915">ngx_resolver_export</a></li>
<li><a href="#L2880">ngx_resolver_free</a></li>
<li><a href="#L2891">ngx_resolver_free_locked</a></li>
<li><a href="#L2817">ngx_resolver_free_node</a></li>
<li><a href="#L3021">ngx_resolver_log_error</a></li>
<li><a href="#L2316">ngx_resolver_lookup_addr</a></li>
<li><a href="#L2349">ngx_resolver_lookup_addr6</a></li>
<li><a href="#L2275">ngx_resolver_lookup_name</a></li>
<li><a href="#L1421">ngx_resolver_process_a</a></li>
<li><a href="#L2005">ngx_resolver_process_ptr</a></li>
<li><a href="#L1251">ngx_resolver_process_response</a></li>
<li><a href="#L2436">ngx_resolver_rbtree_insert_addr6_value</a></li>
<li><a href="#L2393">ngx_resolver_rbtree_insert_value</a></li>
<li><a href="#L1229">ngx_resolver_read_response</a></li>
<li><a href="#L1183">ngx_resolver_resend</a></li>
<li><a href="#L1121">ngx_resolver_resend_handler</a></li>
<li><a href="#L1060">ngx_resolver_send_query</a></li>
<li><a href="#L2998">ngx_resolver_strerror</a></li>
<li><a href="#L2796">ngx_resolver_timeout_handler</a></li>
<li><a href="#L3044">ngx_udp_connect</a></li>
</ul>
 <h4>Macros defined</h4>
 <ul>
<li><a href="#L13">NGX_RESOLVER_UDP_SIZE</a></li>
<li><a href="#L51">ngx_resolver_node</a></li>
</ul>
 <h4>Source code</h4>

  <code><ol><li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Copyright (C) Igor Sysoev<br/></li>
<li></span><span class="Comment"> * Copyright (C) Nginx, Inc.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;ngx_config.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;ngx_core.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;ngx_event.h&gt;<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><a id="L13">&#x200c;</a><span class="PreProc">#define <span class="linkable">NGX_RESOLVER_UDP_SIZE</span>&nbsp;&nbsp; </span><span class="Constant">4096<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Type">typedef</span> <span class="Type">struct</span> {<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; ident_hi;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; ident_lo;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; flags_hi;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; flags_lo;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; nqs_hi;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; nqs_lo;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; nan_hi;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; nan_lo;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; nns_hi;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; nns_lo;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; nar_hi;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; nar_lo;<br/></li>
<li><a id="L29">&#x200c;</a>} <span class="linkable">ngx_resolver_hdr_t</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">typedef</span> <span class="Type">struct</span> {<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; type_hi;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; type_lo;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; class_hi;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; class_lo;<br/></li>
<li><a id="L37">&#x200c;</a>} <span class="linkable">ngx_resolver_qs_t</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">typedef</span> <span class="Type">struct</span> {<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; type_hi;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; type_lo;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; class_hi;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; class_lo;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; ttl[<span class="Constant">4</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; len_hi;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; len_lo;<br/></li>
<li><a id="L48">&#x200c;</a>} <span class="linkable">ngx_resolver_an_t</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L51">&#x200c;</a><span class="PreProc">#define <span class="linkable">ngx_resolver_node</span>(n)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; (<a href="ngx_resolver.h.html#L101" title="core/ngx_resolver.h:101">ngx_resolver_node_t</a> *)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; &nbsp; &nbsp; ((u_char *) (n) - offsetof(<a href="ngx_resolver.h.html#L101" title="core/ngx_resolver.h:101">ngx_resolver_node_t</a>, node))<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><a href="ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L3044" title="core/ngx_resolver.c:3044">ngx_udp_connect</a>(<a href="ngx_resolver.h.html#L45" title="core/ngx_resolver.h:45">ngx_udp_connection_t</a> *uc);<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L251" title="core/ngx_resolver.c:251">ngx_resolver_cleanup</a>(<span class="Type">void</span> *data);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L289" title="core/ngx_resolver.c:289">ngx_resolver_cleanup_tree</a>(<a href="ngx_resolver.h.html#L142" title="core/ngx_resolver.h:142">ngx_resolver_t</a> *r, <a href="ngx_rbtree.h.html#L32" title="core/ngx_rbtree.h:32">ngx_rbtree_t</a> *tree);<br/></li>
<li><span class="Type">static</span> <a href="ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L470" title="core/ngx_resolver.c:470">ngx_resolve_name_locked</a>(<a href="ngx_resolver.h.html#L142" title="core/ngx_resolver.h:142">ngx_resolver_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L48" title="core/ngx_resolver.h:48">ngx_resolver_ctx_t</a> *ctx);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L1023" title="core/ngx_resolver.c:1023">ngx_resolver_expire</a>(<a href="ngx_resolver.h.html#L142" title="core/ngx_resolver.h:142">ngx_resolver_t</a> *r, <a href="ngx_rbtree.h.html#L32" title="core/ngx_rbtree.h:32">ngx_rbtree_t</a> *tree,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_queue.h.html#L16" title="core/ngx_queue.h:16">ngx_queue_t</a> *queue);<br/></li>
<li><span class="Type">static</span> <a href="ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L1060" title="core/ngx_resolver.c:1060">ngx_resolver_send_query</a>(<a href="ngx_resolver.h.html#L142" title="core/ngx_resolver.h:142">ngx_resolver_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L101" title="core/ngx_resolver.h:101">ngx_resolver_node_t</a> *rn);<br/></li>
<li><span class="Type">static</span> <a href="ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L2479" title="core/ngx_resolver.c:2479">ngx_resolver_create_name_query</a>(<a href="ngx_resolver.h.html#L101" title="core/ngx_resolver.h:101">ngx_resolver_node_t</a> *rn,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L48" title="core/ngx_resolver.h:48">ngx_resolver_ctx_t</a> *ctx);<br/></li>
<li><span class="Type">static</span> <a href="ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L2607" title="core/ngx_resolver.c:2607">ngx_resolver_create_addr_query</a>(<a href="ngx_resolver.h.html#L101" title="core/ngx_resolver.h:101">ngx_resolver_node_t</a> *rn,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L48" title="core/ngx_resolver.h:48">ngx_resolver_ctx_t</a> *ctx);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L1121" title="core/ngx_resolver.c:1121">ngx_resolver_resend_handler</a>(<a href="ngx_core.h.html#L21" title="core/ngx_core.h:21">ngx_event_t</a> *ev);<br/></li>
<li><span class="Type">static</span> <span class="Type">time_t</span> <a href="#L1183" title="core/ngx_resolver.c:1183">ngx_resolver_resend</a>(<a href="ngx_resolver.h.html#L142" title="core/ngx_resolver.h:142">ngx_resolver_t</a> *r, <a href="ngx_rbtree.h.html#L32" title="core/ngx_rbtree.h:32">ngx_rbtree_t</a> *tree,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_queue.h.html#L16" title="core/ngx_queue.h:16">ngx_queue_t</a> *queue);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L1229" title="core/ngx_resolver.c:1229">ngx_resolver_read_response</a>(<a href="ngx_core.h.html#L21" title="core/ngx_core.h:21">ngx_event_t</a> *rev);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L1251" title="core/ngx_resolver.c:1251">ngx_resolver_process_response</a>(<a href="ngx_resolver.h.html#L142" title="core/ngx_resolver.h:142">ngx_resolver_t</a> *r, u_char *buf,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span> n);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L1421" title="core/ngx_resolver.c:1421">ngx_resolver_process_a</a>(<a href="ngx_resolver.h.html#L142" title="core/ngx_resolver.h:142">ngx_resolver_t</a> *r, u_char *buf, <span class="Type">size_t</span> n,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> ident, <a href="ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> code, <a href="ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> qtype,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> nan, <a href="ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> ans);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L2005" title="core/ngx_resolver.c:2005">ngx_resolver_process_ptr</a>(<a href="ngx_resolver.h.html#L142" title="core/ngx_resolver.h:142">ngx_resolver_t</a> *r, u_char *buf, <span class="Type">size_t</span> n,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> ident, <a href="ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> code, <a href="ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> nan);<br/></li>
<li><span class="Type">static</span> <a href="ngx_resolver.h.html#L101" title="core/ngx_resolver.h:101">ngx_resolver_node_t</a> *<a href="#L2275" title="core/ngx_resolver.c:2275">ngx_resolver_lookup_name</a>(<a href="ngx_resolver.h.html#L142" title="core/ngx_resolver.h:142">ngx_resolver_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a> *name, <span class="Type">uint32_t</span> hash);<br/></li>
<li><span class="Type">static</span> <a href="ngx_resolver.h.html#L101" title="core/ngx_resolver.h:101">ngx_resolver_node_t</a> *<a href="#L2316" title="core/ngx_resolver.c:2316">ngx_resolver_lookup_addr</a>(<a href="ngx_resolver.h.html#L142" title="core/ngx_resolver.h:142">ngx_resolver_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; in_addr_t addr);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L2393" title="core/ngx_resolver.c:2393">ngx_resolver_rbtree_insert_value</a>(<a href="ngx_rbtree.h.html#L20" title="core/ngx_rbtree.h:20">ngx_rbtree_node_t</a> *temp,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_rbtree.h.html#L20" title="core/ngx_rbtree.h:20">ngx_rbtree_node_t</a> *node, <a href="ngx_rbtree.h.html#L20" title="core/ngx_rbtree.h:20">ngx_rbtree_node_t</a> *sentinel);<br/></li>
<li><span class="Type">static</span> <a href="ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L2702" title="core/ngx_resolver.c:2702">ngx_resolver_copy</a>(<a href="ngx_resolver.h.html#L142" title="core/ngx_resolver.h:142">ngx_resolver_t</a> *r, <a href="ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a> *name,<br/></li>
<li>&nbsp; &nbsp; u_char *buf, u_char *src, u_char *last);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L2796" title="core/ngx_resolver.c:2796">ngx_resolver_timeout_handler</a>(<a href="ngx_core.h.html#L21" title="core/ngx_core.h:21">ngx_event_t</a> *ev);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L2817" title="core/ngx_resolver.c:2817">ngx_resolver_free_node</a>(<a href="ngx_resolver.h.html#L142" title="core/ngx_resolver.h:142">ngx_resolver_t</a> *r, <a href="ngx_resolver.h.html#L101" title="core/ngx_resolver.h:101">ngx_resolver_node_t</a> *rn);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> *<a href="#L2850" title="core/ngx_resolver.c:2850">ngx_resolver_alloc</a>(<a href="ngx_resolver.h.html#L142" title="core/ngx_resolver.h:142">ngx_resolver_t</a> *r, <span class="Type">size_t</span> size);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> *<a href="#L2865" title="core/ngx_resolver.c:2865">ngx_resolver_calloc</a>(<a href="ngx_resolver.h.html#L142" title="core/ngx_resolver.h:142">ngx_resolver_t</a> *r, <span class="Type">size_t</span> size);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L2880" title="core/ngx_resolver.c:2880">ngx_resolver_free</a>(<a href="ngx_resolver.h.html#L142" title="core/ngx_resolver.h:142">ngx_resolver_t</a> *r, <span class="Type">void</span> *p);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L2891" title="core/ngx_resolver.c:2891">ngx_resolver_free_locked</a>(<a href="ngx_resolver.h.html#L142" title="core/ngx_resolver.h:142">ngx_resolver_t</a> *r, <span class="Type">void</span> *p);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> *<a href="#L2898" title="core/ngx_resolver.c:2898">ngx_resolver_dup</a>(<a href="ngx_resolver.h.html#L142" title="core/ngx_resolver.h:142">ngx_resolver_t</a> *r, <span class="Type">void</span> *src, <span class="Type">size_t</span> size);<br/></li>
<li><span class="Type">static</span> <a href="ngx_inet.h.html#L74" title="core/ngx_inet.h:74">ngx_addr_t</a> *<a href="#L2915" title="core/ngx_resolver.c:2915">ngx_resolver_export</a>(<a href="ngx_resolver.h.html#L142" title="core/ngx_resolver.h:142">ngx_resolver_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L101" title="core/ngx_resolver.h:101">ngx_resolver_node_t</a> *rn, <a href="ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> rotate);<br/></li>
<li><span class="Type">static</span> u_char *<a href="#L3021" title="core/ngx_resolver.c:3021">ngx_resolver_log_error</a>(<a href="ngx_core.h.html#L17" title="core/ngx_core.h:17">ngx_log_t</a> *log, u_char *buf, <span class="Type">size_t</span> len);<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span><span class="Type">static</span> <span class="Type">void</span> <a href="#L2436" title="core/ngx_resolver.c:2436">ngx_resolver_rbtree_insert_addr6_value</a>(<a href="ngx_rbtree.h.html#L20" title="core/ngx_rbtree.h:20">ngx_rbtree_node_t</a> *temp,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_rbtree.h.html#L20" title="core/ngx_rbtree.h:20">ngx_rbtree_node_t</a> *node, <a href="ngx_rbtree.h.html#L20" title="core/ngx_rbtree.h:20">ngx_rbtree_node_t</a> *sentinel);<br/></li>
<li><span class="Type">static</span> <a href="ngx_resolver.h.html#L101" title="core/ngx_resolver.h:101">ngx_resolver_node_t</a> *<a href="#L2349" title="core/ngx_resolver.c:2349">ngx_resolver_lookup_addr6</a>(<a href="ngx_resolver.h.html#L142" title="core/ngx_resolver.h:142">ngx_resolver_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">struct</span> in6_addr *addr, <span class="Type">uint32_t</span> hash);<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><a href="ngx_resolver.h.html#L142" title="core/ngx_resolver.h:142">ngx_resolver_t</a> *<br/></li>
<li><a id="L110">&#x200c;</a><span class="linkable">ngx_resolver_create</span>(<a href="ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a> *names, <a href="ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> n)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; s;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_inet.h.html#L102" title="core/ngx_inet.h:102">ngx_url_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; u;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; i, j;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L142" title="core/ngx_resolver.h:142">ngx_resolver_t</a>&nbsp; &nbsp; &nbsp; &nbsp; *r;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_palloc.h.html#L32" title="core/ngx_palloc.h:32">ngx_pool_cleanup_t</a>&nbsp; &nbsp; *cln;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L45" title="core/ngx_resolver.h:45">ngx_udp_connection_t</a>&nbsp; *uc;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cln = <a href="ngx_palloc.c.html#L314" title="core/ngx_palloc.c:314">ngx_pool_cleanup_add</a>(cf-&gt;pool, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cln == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cln-&gt;handler = <a href="#L251" title="core/ngx_resolver.c:251">ngx_resolver_cleanup</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r = <a href="../os/unix/ngx_alloc.c.html#L35" title="os/unix/ngx_alloc.c:35">ngx_calloc</a>(<span class="Statement">sizeof</span>(<a href="ngx_resolver.h.html#L142" title="core/ngx_resolver.h:142">ngx_resolver_t</a>), cf-&gt;log);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cln-&gt;data = r;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;event = <a href="../os/unix/ngx_alloc.c.html#L35" title="os/unix/ngx_alloc.c:35">ngx_calloc</a>(<span class="Statement">sizeof</span>(<a href="ngx_core.h.html#L21" title="core/ngx_core.h:21">ngx_event_t</a>), cf-&gt;log);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;event == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_rbtree.h.html#L44" title="core/ngx_rbtree.h:44">ngx_rbtree_init</a>(&amp;r-&gt;name_rbtree, &amp;r-&gt;name_sentinel,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2393" title="core/ngx_resolver.c:2393">ngx_resolver_rbtree_insert_value</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_rbtree.h.html#L44" title="core/ngx_rbtree.h:44">ngx_rbtree_init</a>(&amp;r-&gt;addr_rbtree, &amp;r-&gt;addr_sentinel,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_rbtree.c.html#L97" title="core/ngx_rbtree.c:97">ngx_rbtree_insert_value</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_queue.h.html#L24" title="core/ngx_queue.h:24">ngx_queue_init</a>(&amp;r-&gt;name_resend_queue);<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_queue.h.html#L24" title="core/ngx_queue.h:24">ngx_queue_init</a>(&amp;r-&gt;addr_resend_queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_queue.h.html#L24" title="core/ngx_queue.h:24">ngx_queue_init</a>(&amp;r-&gt;name_expire_queue);<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_queue.h.html#L24" title="core/ngx_queue.h:24">ngx_queue_init</a>(&amp;r-&gt;addr_expire_queue);<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; r-&gt;ipv6 = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_rbtree.h.html#L44" title="core/ngx_rbtree.h:44">ngx_rbtree_init</a>(&amp;r-&gt;addr6_rbtree, &amp;r-&gt;addr6_sentinel,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2436" title="core/ngx_resolver.c:2436">ngx_resolver_rbtree_insert_addr6_value</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_queue.h.html#L24" title="core/ngx_queue.h:24">ngx_queue_init</a>(&amp;r-&gt;addr6_resend_queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_queue.h.html#L24" title="core/ngx_queue.h:24">ngx_queue_init</a>(&amp;r-&gt;addr6_expire_queue);<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; r-&gt;event-&gt;handler = <a href="#L1121" title="core/ngx_resolver.c:1121">ngx_resolver_resend_handler</a>;<br/></li>
<li>&nbsp; &nbsp; r-&gt;event-&gt;data = r;<br/></li>
<li>&nbsp; &nbsp; r-&gt;event-&gt;log = &amp;cf-&gt;cycle-&gt;new_log;<br/></li>
<li>&nbsp; &nbsp; r-&gt;ident = -<span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;resend_timeout = <span class="Constant">5</span>;<br/></li>
<li>&nbsp; &nbsp; r-&gt;expire = <span class="Constant">30</span>;<br/></li>
<li>&nbsp; &nbsp; r-&gt;valid = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;log = &amp;cf-&gt;cycle-&gt;new_log;<br/></li>
<li>&nbsp; &nbsp; r-&gt;log_level = <a href="ngx_log.h.html#L20" title="core/ngx_log.h:20">NGX_LOG_ERR</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (n) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="ngx_array.h.html#L32" title="core/ngx_array.h:32">ngx_array_init</a>(&amp;r-&gt;udp_connections, cf-&gt;pool, n,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Statement">sizeof</span>(<a href="ngx_resolver.h.html#L45" title="core/ngx_resolver.h:45">ngx_udp_connection_t</a>))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; != <a href="ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; n; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="ngx_string.h.html#L53" title="core/ngx_string.h:53">ngx_strncmp</a>(names[i].data, <span class="Constant">&quot;valid=&quot;</span>, <span class="Constant">6</span>) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; s.len = names[i].len - <span class="Constant">6</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; s.data = names[i].data + <span class="Constant">6</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;valid = <a href="ngx_parse.c.html#L97" title="core/ngx_parse.c:97">ngx_parse_time</a>(&amp;s, <span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;valid == (<span class="Type">time_t</span>) <a href="ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;invalid parameter: %V&quot;</span>, &amp;names[i]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="ngx_string.h.html#L53" title="core/ngx_string.h:53">ngx_strncmp</a>(names[i].data, <span class="Constant">&quot;ipv6=&quot;</span>, <span class="Constant">5</span>) == <span class="Constant">0</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="ngx_string.h.html#L57" title="core/ngx_string.h:57">ngx_strcmp</a>(&amp;names[i].data[<span class="Constant">5</span>], <span class="Constant">&quot;on&quot;</span>) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;ipv6 = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (<a href="ngx_string.h.html#L57" title="core/ngx_string.h:57">ngx_strcmp</a>(&amp;names[i].data[<span class="Constant">5</span>], <span class="Constant">&quot;off&quot;</span>) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;ipv6 = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;invalid parameter: %V&quot;</span>, &amp;names[i]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_string.h.html#L86" title="core/ngx_string.h:86">ngx_memzero</a>(&amp;u, <span class="Statement">sizeof</span>(<a href="ngx_inet.h.html#L102" title="core/ngx_inet.h:102">ngx_url_t</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u.url = names[i];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u.default_port = <span class="Constant">53</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="ngx_inet.c.html#L525" title="core/ngx_inet.c:525">ngx_parse_url</a>(cf-&gt;pool, &amp;u) != <a href="ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (u.err) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;</span><span class="Special">%s</span><span class="Constant"> in resolver </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; u.err, &amp;u.url);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; uc = <a href="ngx_array.c.html#L95" title="core/ngx_array.c:95">ngx_array_push_n</a>(&amp;r-&gt;udp_connections, u.naddrs);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (uc == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_string.h.html#L86" title="core/ngx_string.h:86">ngx_memzero</a>(uc, u.naddrs * <span class="Statement">sizeof</span>(<a href="ngx_resolver.h.html#L45" title="core/ngx_resolver.h:45">ngx_udp_connection_t</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (j = <span class="Constant">0</span>; j &lt; u.naddrs; j++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; uc[j].sockaddr = u.addrs[j].sockaddr;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; uc[j].socklen = u.addrs[j].socklen;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; uc[j].server = u.addrs[j].name;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> r;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L251">&#x200c;</a></span><span class="linkable">ngx_resolver_cleanup</span>(<span class="Type">void</span> *data)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L142" title="core/ngx_resolver.h:142">ngx_resolver_t</a>&nbsp; *r = data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; i;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L45" title="core/ngx_resolver.h:45">ngx_udp_connection_t</a>&nbsp; *uc;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.h.html#L132" title="core/ngx_log.h:132">ngx_log_debug0</a>(<a href="ngx_log.h.html#L26" title="core/ngx_log.h:26">NGX_LOG_DEBUG_CORE</a>, <a href="ngx_cycle.c.html#L20" title="core/ngx_cycle.c:20">ngx_cycle</a>-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;cleanup resolver&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L289" title="core/ngx_resolver.c:289">ngx_resolver_cleanup_tree</a>(r, &amp;r-&gt;name_rbtree);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L289" title="core/ngx_resolver.c:289">ngx_resolver_cleanup_tree</a>(r, &amp;r-&gt;addr_rbtree);<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L289" title="core/ngx_resolver.c:289">ngx_resolver_cleanup_tree</a>(r, &amp;r-&gt;addr6_rbtree);<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;event) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../os/unix/ngx_alloc.h.html#L19" title="os/unix/ngx_alloc.h:19">ngx_free</a>(r-&gt;event);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; uc = r-&gt;udp_connections.elts;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; r-&gt;udp_connections.nelts; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (uc[i].connection) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_connection.c.html#L914" title="core/ngx_connection.c:914">ngx_close_connection</a>(uc[i].connection);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../os/unix/ngx_alloc.h.html#L19" title="os/unix/ngx_alloc.h:19">ngx_free</a>(r);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L289">&#x200c;</a></span><span class="linkable">ngx_resolver_cleanup_tree</span>(<a href="ngx_resolver.h.html#L142" title="core/ngx_resolver.h:142">ngx_resolver_t</a> *r, <a href="ngx_rbtree.h.html#L32" title="core/ngx_rbtree.h:32">ngx_rbtree_t</a> *tree)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L48" title="core/ngx_resolver.h:48">ngx_resolver_ctx_t</a>&nbsp;&nbsp; *ctx, *next;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L101" title="core/ngx_resolver.h:101">ngx_resolver_node_t</a>&nbsp; *rn;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (tree-&gt;root != tree-&gt;sentinel) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn = <a href="#L51" title="core/ngx_resolver.c:51">ngx_resolver_node</a>(<a href="ngx_rbtree.h.html#L72" title="core/ngx_rbtree.h:72">ngx_rbtree_min</a>(tree-&gt;root, tree-&gt;sentinel));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_queue.h.html#L72" title="core/ngx_queue.h:72">ngx_queue_remove</a>(&amp;rn-&gt;queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (ctx = rn-&gt;waiting; ctx; ctx = next) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; next = ctx-&gt;next;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;event) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2880" title="core/ngx_resolver.c:2880">ngx_resolver_free</a>(r, ctx-&gt;event);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2880" title="core/ngx_resolver.c:2880">ngx_resolver_free</a>(r, ctx);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_rbtree.c.html#L157" title="core/ngx_rbtree.c:157">ngx_rbtree_delete</a>(tree, &amp;rn-&gt;node);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2817" title="core/ngx_resolver.c:2817">ngx_resolver_free_node</a>(r, rn);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a href="ngx_resolver.h.html#L48" title="core/ngx_resolver.h:48">ngx_resolver_ctx_t</a> *<br/></li>
<li><a id="L318">&#x200c;</a><span class="linkable">ngx_resolve_start</span>(<a href="ngx_resolver.h.html#L142" title="core/ngx_resolver.h:142">ngx_resolver_t</a> *r, <a href="ngx_resolver.h.html#L48" title="core/ngx_resolver.h:48">ngx_resolver_ctx_t</a> *temp)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; in_addr_t&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; addr;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L48" title="core/ngx_resolver.h:48">ngx_resolver_ctx_t</a>&nbsp; *ctx;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (temp) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; addr = <a href="ngx_inet.c.html#L18" title="core/ngx_inet.c:18">ngx_inet_addr</a>(temp-&gt;name.data, temp-&gt;name.len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (addr != <a href="ngx_config.h.html#L115" title="core/ngx_config.h:115">INADDR_NONE</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; temp-&gt;resolver = r;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; temp-&gt;state = <a href="ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; temp-&gt;naddrs = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; temp-&gt;addrs = &amp;temp-&gt;addr;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; temp-&gt;addr.sockaddr = (<span class="Type">struct</span> sockaddr *) &amp;temp-&gt;sin;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; temp-&gt;addr.socklen = <span class="Statement">sizeof</span>(<span class="Type">struct</span> sockaddr_in);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_string.h.html#L86" title="core/ngx_string.h:86">ngx_memzero</a>(&amp;temp-&gt;sin, <span class="Statement">sizeof</span>(<span class="Type">struct</span> sockaddr_in));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; temp-&gt;sin.sin_family = AF_INET;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; temp-&gt;sin.sin_addr.s_addr = addr;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; temp-&gt;quick = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> temp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;udp_connections.nelts == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_resolver.h.html#L34" title="core/ngx_resolver.h:34">NGX_NO_RESOLVER</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx = <a href="#L2865" title="core/ngx_resolver.c:2865">ngx_resolver_calloc</a>(r, <span class="Statement">sizeof</span>(<a href="ngx_resolver.h.html#L48" title="core/ngx_resolver.h:48">ngx_resolver_ctx_t</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;resolver = r;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> ctx;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a href="ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L357">&#x200c;</a><span class="linkable">ngx_resolve_name</span>(<a href="ngx_resolver.h.html#L48" title="core/ngx_resolver.h:48">ngx_resolver_ctx_t</a> *ctx)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; rc;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L142" title="core/ngx_resolver.h:142">ngx_resolver_t</a>&nbsp; *r;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r = ctx-&gt;resolver;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;name.len &gt; <span class="Constant">0</span> &amp;&amp; ctx-&gt;name.data[ctx-&gt;name.len - <span class="Constant">1</span>] == <span class="Constant">'.'</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;name.len--;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="ngx_log.h.html#L26" title="core/ngx_log.h:26">NGX_LOG_DEBUG_CORE</a>, r-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;resolve: </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, &amp;ctx-&gt;name);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;quick) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;handler(ctx);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* lock name mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; rc = <a href="#L470" title="core/ngx_resolver.c:470">ngx_resolve_name_locked</a>(r, ctx);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* unlock name mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="ngx_core.h.html#L31" title="core/ngx_core.h:31">NGX_AGAIN</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* <a href="ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a> */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;event) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2880" title="core/ngx_resolver.c:2880">ngx_resolver_free</a>(r, ctx-&gt;event);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L2880" title="core/ngx_resolver.c:2880">ngx_resolver_free</a>(r, ctx);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">void<br/></li>
<li><a id="L403">&#x200c;</a></span><span class="linkable">ngx_resolve_name_done</span>(<a href="ngx_resolver.h.html#L48" title="core/ngx_resolver.h:48">ngx_resolver_ctx_t</a> *ctx)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uint32_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; hash;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L142" title="core/ngx_resolver.h:142">ngx_resolver_t</a>&nbsp; &nbsp; &nbsp;&nbsp; *r;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L48" title="core/ngx_resolver.h:48">ngx_resolver_ctx_t</a>&nbsp;&nbsp; *w, **p;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L101" title="core/ngx_resolver.h:101">ngx_resolver_node_t</a>&nbsp; *rn;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r = ctx-&gt;resolver;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="ngx_log.h.html#L26" title="core/ngx_log.h:26">NGX_LOG_DEBUG_CORE</a>, r-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;resolve name done: </span><span class="Special">%i</span><span class="Constant">&quot;</span>, ctx-&gt;state);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;quick) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;event &amp;&amp; ctx-&gt;event-&gt;timer_set) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event.h.html#L428" title="event/ngx_event.h:428">ngx_del_timer</a>(ctx-&gt;event);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* lock name mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;state == <a href="ngx_core.h.html#L31" title="core/ngx_core.h:31">NGX_AGAIN</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; hash = <a href="ngx_crc32.h.html#L21" title="core/ngx_crc32.h:21">ngx_crc32_short</a>(ctx-&gt;name.data, ctx-&gt;name.len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn = <a href="#L2275" title="core/ngx_resolver.c:2275">ngx_resolver_lookup_name</a>(r, &amp;ctx-&gt;name, hash);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rn) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = &amp;rn-&gt;waiting;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; w = rn-&gt;waiting;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">while</span> (w) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (w == ctx) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *p = w-&gt;next;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = &amp;w-&gt;next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; w = w-&gt;next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="ngx_log.h.html#L18" title="core/ngx_log.h:18">NGX_LOG_ALERT</a>, r-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;could not cancel %V resolving&quot;</span>, &amp;ctx-&gt;name);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="Statement">done</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="#L1023" title="core/ngx_resolver.c:1023">ngx_resolver_expire</a>(r, &amp;r-&gt;name_rbtree, &amp;r-&gt;name_expire_queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* unlock name mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* lock alloc mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;event) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2891" title="core/ngx_resolver.c:2891">ngx_resolver_free_locked</a>(r, ctx-&gt;event);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L2891" title="core/ngx_resolver.c:2891">ngx_resolver_free_locked</a>(r, ctx);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* unlock alloc mutex */<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L470">&#x200c;</a><span class="linkable">ngx_resolve_name_locked</span>(<a href="ngx_resolver.h.html#L142" title="core/ngx_resolver.h:142">ngx_resolver_t</a> *r, <a href="ngx_resolver.h.html#L48" title="core/ngx_resolver.h:48">ngx_resolver_ctx_t</a> *ctx)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uint32_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; hash;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; rc;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; naddrs;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_inet.h.html#L74" title="core/ngx_inet.h:74">ngx_addr_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *addrs;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L48" title="core/ngx_resolver.h:48">ngx_resolver_ctx_t</a>&nbsp;&nbsp; *next;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L101" title="core/ngx_resolver.h:101">ngx_resolver_node_t</a>&nbsp; *rn;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_string.c.html#L21" title="core/ngx_string.c:21">ngx_strlow</a>(ctx-&gt;name.data, ctx-&gt;name.data, ctx-&gt;name.len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; hash = <a href="ngx_crc32.h.html#L21" title="core/ngx_crc32.h:21">ngx_crc32_short</a>(ctx-&gt;name.data, ctx-&gt;name.len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rn = <a href="#L2275" title="core/ngx_resolver.c:2275">ngx_resolver_lookup_name</a>(r, &amp;ctx-&gt;name, hash);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rn) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;valid &gt;= <a href="ngx_times.h.html#L36" title="core/ngx_times.h:36">ngx_time</a>()) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.h.html#L132" title="core/ngx_log.h:132">ngx_log_debug0</a>(<a href="ngx_log.h.html#L26" title="core/ngx_log.h:26">NGX_LOG_DEBUG_CORE</a>, r-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;resolve cached&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_queue.h.html#L72" title="core/ngx_queue.h:72">ngx_queue_remove</a>(&amp;rn-&gt;queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;expire = <a href="ngx_times.h.html#L36" title="core/ngx_times.h:36">ngx_time</a>() + r-&gt;expire;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_queue.h.html#L33" title="core/ngx_queue.h:33">ngx_queue_insert_head</a>(&amp;r-&gt;name_expire_queue, &amp;rn-&gt;queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; naddrs = (rn-&gt;naddrs == (u_short) -<span class="Constant">1</span>) ? <span class="Constant">0</span> : rn-&gt;naddrs;<br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; naddrs += (rn-&gt;naddrs6 == (u_short) -<span class="Constant">1</span>) ? <span class="Constant">0</span> : rn-&gt;naddrs6;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (naddrs) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (naddrs == <span class="Constant">1</span> &amp;&amp; rn-&gt;naddrs == <span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; addrs = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; addrs = <a href="#L2915" title="core/ngx_resolver.c:2915">ngx_resolver_export</a>(r, rn, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (addrs == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;next = rn-&gt;waiting;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;waiting = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* unlock name mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">do</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;state = <a href="ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;naddrs = naddrs;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (addrs == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;addrs = &amp;ctx-&gt;addr;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;addr.sockaddr = (<span class="Type">struct</span> sockaddr *) &amp;ctx-&gt;sin;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;addr.socklen = <span class="Statement">sizeof</span>(<span class="Type">struct</span> sockaddr_in);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_string.h.html#L86" title="core/ngx_string.h:86">ngx_memzero</a>(&amp;ctx-&gt;sin, <span class="Statement">sizeof</span>(<span class="Type">struct</span> sockaddr_in));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;sin.sin_family = AF_INET;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;sin.sin_addr.s_addr = rn-&gt;u.addr;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;addrs = addrs;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; next = ctx-&gt;next;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;handler(ctx);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx = next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">while</span> (ctx);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (addrs != <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2880" title="core/ngx_resolver.c:2880">ngx_resolver_free</a>(r, addrs-&gt;sockaddr);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2880" title="core/ngx_resolver.c:2880">ngx_resolver_free</a>(r, addrs);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* <a href="ngx_resolver.h.html#L17" title="core/ngx_resolver.h:17">NGX_RESOLVE_CNAME</a> */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;recursion++ &lt; <a href="ngx_resolver.h.html#L36" title="core/ngx_resolver.h:36">NGX_RESOLVER_MAX_RECURSION</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;name.len = rn-&gt;cnlen;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;name.data = rn-&gt;u.cname;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L470" title="core/ngx_resolver.c:470">ngx_resolve_name_locked</a>(r, ctx);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;next = rn-&gt;waiting;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;waiting = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* unlock name mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">do</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;state = <a href="ngx_resolver.h.html#L28" title="core/ngx_resolver.h:28">NGX_RESOLVE_NXDOMAIN</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; next = ctx-&gt;next;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;handler(ctx);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx = next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">while</span> (ctx);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;waiting) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;next = rn-&gt;waiting;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;waiting = ctx;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;state = <a href="ngx_core.h.html#L31" title="core/ngx_core.h:31">NGX_AGAIN</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L31" title="core/ngx_core.h:31">NGX_AGAIN</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_queue.h.html#L72" title="core/ngx_queue.h:72">ngx_queue_remove</a>(&amp;rn-&gt;queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* lock alloc mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;query) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2891" title="core/ngx_resolver.c:2891">ngx_resolver_free_locked</a>(r, rn-&gt;query);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;query = <span class="Constant">NULL</span>;<br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;query6 = <span class="Constant">NULL</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;cnlen) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2891" title="core/ngx_resolver.c:2891">ngx_resolver_free_locked</a>(r, rn-&gt;u.cname);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;naddrs &gt; <span class="Constant">1</span> &amp;&amp; rn-&gt;naddrs != (u_short) -<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2891" title="core/ngx_resolver.c:2891">ngx_resolver_free_locked</a>(r, rn-&gt;u.addrs);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;naddrs6 &gt; <span class="Constant">1</span> &amp;&amp; rn-&gt;naddrs6 != (u_short) -<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2891" title="core/ngx_resolver.c:2891">ngx_resolver_free_locked</a>(r, rn-&gt;u6.addrs6);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* unlock alloc mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn = <a href="#L2850" title="core/ngx_resolver.c:2850">ngx_resolver_alloc</a>(r, <span class="Statement">sizeof</span>(<a href="ngx_resolver.h.html#L101" title="core/ngx_resolver.h:101">ngx_resolver_node_t</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rn == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;name = <a href="#L2898" title="core/ngx_resolver.c:2898">ngx_resolver_dup</a>(r, ctx-&gt;name.data, ctx-&gt;name.len);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;name == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2880" title="core/ngx_resolver.c:2880">ngx_resolver_free</a>(r, rn);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;node.key = hash;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;nlen = (u_short) ctx-&gt;name.len;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;query = <span class="Constant">NULL</span>;<br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;query6 = <span class="Constant">NULL</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_rbtree.c.html#L25" title="core/ngx_rbtree.c:25">ngx_rbtree_insert</a>(&amp;r-&gt;name_rbtree, &amp;rn-&gt;node);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rc = <a href="#L2479" title="core/ngx_resolver.c:2479">ngx_resolver_create_name_query</a>(rn, ctx);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="ngx_core.h.html#L34" title="core/ngx_core.h:34">NGX_DECLINED</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_rbtree.c.html#L157" title="core/ngx_rbtree.c:157">ngx_rbtree_delete</a>(&amp;r-&gt;name_rbtree, &amp;rn-&gt;node);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2880" title="core/ngx_resolver.c:2880">ngx_resolver_free</a>(r, rn-&gt;query);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2880" title="core/ngx_resolver.c:2880">ngx_resolver_free</a>(r, rn-&gt;name);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2880" title="core/ngx_resolver.c:2880">ngx_resolver_free</a>(r, rn);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;state = <a href="ngx_resolver.h.html#L28" title="core/ngx_resolver.h:28">NGX_RESOLVE_NXDOMAIN</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;handler(ctx);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rn-&gt;naddrs = (u_short) -<span class="Constant">1</span>;<br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; rn-&gt;naddrs6 = r-&gt;ipv6 ? (u_short) -<span class="Constant">1</span> : <span class="Constant">0</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L1060" title="core/ngx_resolver.c:1060">ngx_resolver_send_query</a>(r, rn) != <a href="ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;event == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;event = <a href="#L2865" title="core/ngx_resolver.c:2865">ngx_resolver_calloc</a>(r, <span class="Statement">sizeof</span>(<a href="ngx_core.h.html#L21" title="core/ngx_core.h:21">ngx_event_t</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;event == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;event-&gt;handler = <a href="#L2796" title="core/ngx_resolver.c:2796">ngx_resolver_timeout_handler</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;event-&gt;data = rn;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;event-&gt;log = r-&gt;log;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;ident = -<span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event.h.html#L427" title="event/ngx_event.h:427">ngx_add_timer</a>(ctx-&gt;event, ctx-&gt;timeout);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="ngx_queue.h.html#L29" title="core/ngx_queue.h:29">ngx_queue_empty</a>(&amp;r-&gt;name_resend_queue)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event.h.html#L427" title="event/ngx_event.h:427">ngx_add_timer</a>(r-&gt;event, (<a href="../os/unix/ngx_time.h.html#L16" title="os/unix/ngx_time.h:16">ngx_msec_t</a>) (r-&gt;resend_timeout * <span class="Constant">1000</span>));<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rn-&gt;expire = <a href="ngx_times.h.html#L36" title="core/ngx_times.h:36">ngx_time</a>() + r-&gt;resend_timeout;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_queue.h.html#L33" title="core/ngx_queue.h:33">ngx_queue_insert_head</a>(&amp;r-&gt;name_resend_queue, &amp;rn-&gt;queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rn-&gt;code = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; rn-&gt;cnlen = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; rn-&gt;valid = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; rn-&gt;ttl = <a href="ngx_config.h.html#L126" title="core/ngx_config.h:126">NGX_MAX_UINT32_VALUE</a>;<br/></li>
<li>&nbsp; &nbsp; rn-&gt;waiting = ctx;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx-&gt;state = <a href="ngx_core.h.html#L31" title="core/ngx_core.h:31">NGX_AGAIN</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L31" title="core/ngx_core.h:31">NGX_AGAIN</a>;<br/></li>
<li><br/></li>
<li><span class="Statement">failed</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_rbtree.c.html#L157" title="core/ngx_rbtree.c:157">ngx_rbtree_delete</a>(&amp;r-&gt;name_rbtree, &amp;rn-&gt;node);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;query) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2880" title="core/ngx_resolver.c:2880">ngx_resolver_free</a>(r, rn-&gt;query);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L2880" title="core/ngx_resolver.c:2880">ngx_resolver_free</a>(r, rn-&gt;name);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L2880" title="core/ngx_resolver.c:2880">ngx_resolver_free</a>(r, rn);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a href="ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L714">&#x200c;</a><span class="linkable">ngx_resolve_addr</span>(<a href="ngx_resolver.h.html#L48" title="core/ngx_resolver.h:48">ngx_resolver_ctx_t</a> *ctx)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *name;<br/></li>
<li>&nbsp; &nbsp; in_addr_t&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; addr;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_queue.h.html#L16" title="core/ngx_queue.h:16">ngx_queue_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *resend_queue, *expire_queue;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_rbtree.h.html#L32" title="core/ngx_rbtree.h:32">ngx_rbtree_t</a>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *tree;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L142" title="core/ngx_resolver.h:142">ngx_resolver_t</a>&nbsp; &nbsp; &nbsp;&nbsp; *r;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">struct</span> sockaddr_in&nbsp;&nbsp; *sin;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L101" title="core/ngx_resolver.h:101">ngx_resolver_node_t</a>&nbsp; *rn;<br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">uint32_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; hash;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">struct</span> sockaddr_in6&nbsp; *sin6;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#if (NGX_SUPPRESS_WARN)<br/></li>
<li></span>&nbsp; &nbsp; addr = <span class="Constant">0</span>;<br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; hash = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; sin6 = <span class="Constant">NULL</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; r = ctx-&gt;resolver;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">switch</span> (ctx-&gt;addr.sockaddr-&gt;sa_family) {<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">case</span> AF_INET6:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; sin6 = (<span class="Type">struct</span> sockaddr_in6 *) ctx-&gt;addr.sockaddr;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; hash = <a href="ngx_crc32.h.html#L21" title="core/ngx_crc32.h:21">ngx_crc32_short</a>(sin6-&gt;sin6_addr.s6_addr, <span class="Constant">16</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* lock addr mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn = <a href="#L2349" title="core/ngx_resolver.c:2349">ngx_resolver_lookup_addr6</a>(r, &amp;sin6-&gt;sin6_addr, hash);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; tree = &amp;r-&gt;addr6_rbtree;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; resend_queue = &amp;r-&gt;addr6_resend_queue;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; expire_queue = &amp;r-&gt;addr6_expire_queue;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:</span> <span class="Comment">/* AF_INET */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; sin = (<span class="Type">struct</span> sockaddr_in *) ctx-&gt;addr.sockaddr;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; addr = ntohl(sin-&gt;sin_addr.s_addr);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* lock addr mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn = <a href="#L2316" title="core/ngx_resolver.c:2316">ngx_resolver_lookup_addr</a>(r, addr);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; tree = &amp;r-&gt;addr_rbtree;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; resend_queue = &amp;r-&gt;addr_resend_queue;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; expire_queue = &amp;r-&gt;addr_expire_queue;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rn) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;valid &gt;= <a href="ngx_times.h.html#L36" title="core/ngx_times.h:36">ngx_time</a>()) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.h.html#L132" title="core/ngx_log.h:132">ngx_log_debug0</a>(<a href="ngx_log.h.html#L26" title="core/ngx_log.h:26">NGX_LOG_DEBUG_CORE</a>, r-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;resolve cached&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_queue.h.html#L72" title="core/ngx_queue.h:72">ngx_queue_remove</a>(&amp;rn-&gt;queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;expire = <a href="ngx_times.h.html#L36" title="core/ngx_times.h:36">ngx_time</a>() + r-&gt;expire;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_queue.h.html#L33" title="core/ngx_queue.h:33">ngx_queue_insert_head</a>(expire_queue, &amp;rn-&gt;queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; name = <a href="#L2898" title="core/ngx_resolver.c:2898">ngx_resolver_dup</a>(r, rn-&gt;name, rn-&gt;nlen);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (name == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;name.len = rn-&gt;nlen;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;name.data = name;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* unlock addr mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;state = <a href="ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;handler(ctx);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2880" title="core/ngx_resolver.c:2880">ngx_resolver_free</a>(r, name);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;waiting) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;next = rn-&gt;waiting;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;waiting = ctx;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;state = <a href="ngx_core.h.html#L31" title="core/ngx_core.h:31">NGX_AGAIN</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* unlock addr mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_queue.h.html#L72" title="core/ngx_queue.h:72">ngx_queue_remove</a>(&amp;rn-&gt;queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2880" title="core/ngx_resolver.c:2880">ngx_resolver_free</a>(r, rn-&gt;query);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;query = <span class="Constant">NULL</span>;<br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;query6 = <span class="Constant">NULL</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn = <a href="#L2850" title="core/ngx_resolver.c:2850">ngx_resolver_alloc</a>(r, <span class="Statement">sizeof</span>(<a href="ngx_resolver.h.html#L101" title="core/ngx_resolver.h:101">ngx_resolver_node_t</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rn == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (ctx-&gt;addr.sockaddr-&gt;sa_family) {<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> AF_INET6:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;addr6 = sin6-&gt;sin6_addr;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;node.key = hash;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:</span> <span class="Comment">/* AF_INET */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;node.key = addr;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;query = <span class="Constant">NULL</span>;<br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;query6 = <span class="Constant">NULL</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_rbtree.c.html#L25" title="core/ngx_rbtree.c:25">ngx_rbtree_insert</a>(tree, &amp;rn-&gt;node);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L2607" title="core/ngx_resolver.c:2607">ngx_resolver_create_addr_query</a>(rn, ctx) != <a href="ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rn-&gt;naddrs = (u_short) -<span class="Constant">1</span>;<br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; rn-&gt;naddrs6 = (u_short) -<span class="Constant">1</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L1060" title="core/ngx_resolver.c:1060">ngx_resolver_send_query</a>(r, rn) != <a href="ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx-&gt;event = <a href="#L2865" title="core/ngx_resolver.c:2865">ngx_resolver_calloc</a>(r, <span class="Statement">sizeof</span>(<a href="ngx_core.h.html#L21" title="core/ngx_core.h:21">ngx_event_t</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;event == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx-&gt;event-&gt;handler = <a href="#L2796" title="core/ngx_resolver.c:2796">ngx_resolver_timeout_handler</a>;<br/></li>
<li>&nbsp; &nbsp; ctx-&gt;event-&gt;data = rn;<br/></li>
<li>&nbsp; &nbsp; ctx-&gt;event-&gt;log = r-&gt;log;<br/></li>
<li>&nbsp; &nbsp; rn-&gt;ident = -<span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../event/ngx_event.h.html#L427" title="event/ngx_event.h:427">ngx_add_timer</a>(ctx-&gt;event, ctx-&gt;timeout);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="ngx_queue.h.html#L29" title="core/ngx_queue.h:29">ngx_queue_empty</a>(resend_queue)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event.h.html#L427" title="event/ngx_event.h:427">ngx_add_timer</a>(r-&gt;event, (<a href="../os/unix/ngx_time.h.html#L16" title="os/unix/ngx_time.h:16">ngx_msec_t</a>) (r-&gt;resend_timeout * <span class="Constant">1000</span>));<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rn-&gt;expire = <a href="ngx_times.h.html#L36" title="core/ngx_times.h:36">ngx_time</a>() + r-&gt;resend_timeout;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_queue.h.html#L33" title="core/ngx_queue.h:33">ngx_queue_insert_head</a>(resend_queue, &amp;rn-&gt;queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rn-&gt;code = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; rn-&gt;cnlen = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; rn-&gt;name = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; rn-&gt;nlen = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; rn-&gt;valid = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; rn-&gt;ttl = <a href="ngx_config.h.html#L126" title="core/ngx_config.h:126">NGX_MAX_UINT32_VALUE</a>;<br/></li>
<li>&nbsp; &nbsp; rn-&gt;waiting = ctx;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* unlock addr mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; ctx-&gt;state = <a href="ngx_core.h.html#L31" title="core/ngx_core.h:31">NGX_AGAIN</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li><br/></li>
<li><span class="Statement">failed</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rn) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_rbtree.c.html#L157" title="core/ngx_rbtree.c:157">ngx_rbtree_delete</a>(tree, &amp;rn-&gt;node);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;query) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2880" title="core/ngx_resolver.c:2880">ngx_resolver_free</a>(r, rn-&gt;query);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2880" title="core/ngx_resolver.c:2880">ngx_resolver_free</a>(r, rn);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* unlock addr mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;event) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2880" title="core/ngx_resolver.c:2880">ngx_resolver_free</a>(r, ctx-&gt;event);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L2880" title="core/ngx_resolver.c:2880">ngx_resolver_free</a>(r, ctx);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">void<br/></li>
<li><a id="L918">&#x200c;</a></span><span class="linkable">ngx_resolve_addr_done</span>(<a href="ngx_resolver.h.html#L48" title="core/ngx_resolver.h:48">ngx_resolver_ctx_t</a> *ctx)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; in_addr_t&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; addr;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_queue.h.html#L16" title="core/ngx_queue.h:16">ngx_queue_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *expire_queue;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_rbtree.h.html#L32" title="core/ngx_rbtree.h:32">ngx_rbtree_t</a>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *tree;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L142" title="core/ngx_resolver.h:142">ngx_resolver_t</a>&nbsp; &nbsp; &nbsp;&nbsp; *r;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L48" title="core/ngx_resolver.h:48">ngx_resolver_ctx_t</a>&nbsp;&nbsp; *w, **p;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">struct</span> sockaddr_in&nbsp;&nbsp; *sin;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L101" title="core/ngx_resolver.h:101">ngx_resolver_node_t</a>&nbsp; *rn;<br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">uint32_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; hash;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">struct</span> sockaddr_in6&nbsp; *sin6;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; r = ctx-&gt;resolver;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">switch</span> (ctx-&gt;addr.sockaddr-&gt;sa_family) {<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">case</span> AF_INET6:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; tree = &amp;r-&gt;addr6_rbtree;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; expire_queue = &amp;r-&gt;addr6_expire_queue;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:</span> <span class="Comment">/* AF_INET */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; tree = &amp;r-&gt;addr_rbtree;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; expire_queue = &amp;r-&gt;addr_expire_queue;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="ngx_log.h.html#L26" title="core/ngx_log.h:26">NGX_LOG_DEBUG_CORE</a>, r-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;resolve addr done: </span><span class="Special">%i</span><span class="Constant">&quot;</span>, ctx-&gt;state);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;event &amp;&amp; ctx-&gt;event-&gt;timer_set) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event.h.html#L428" title="event/ngx_event.h:428">ngx_del_timer</a>(ctx-&gt;event);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* lock addr mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;state == <a href="ngx_core.h.html#L31" title="core/ngx_core.h:31">NGX_AGAIN</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (ctx-&gt;addr.sockaddr-&gt;sa_family) {<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> AF_INET6:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sin6 = (<span class="Type">struct</span> sockaddr_in6 *) ctx-&gt;addr.sockaddr;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; hash = <a href="ngx_crc32.h.html#L21" title="core/ngx_crc32.h:21">ngx_crc32_short</a>(sin6-&gt;sin6_addr.s6_addr, <span class="Constant">16</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rn = <a href="#L2349" title="core/ngx_resolver.c:2349">ngx_resolver_lookup_addr6</a>(r, &amp;sin6-&gt;sin6_addr, hash);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:</span> <span class="Comment">/* AF_INET */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sin = (<span class="Type">struct</span> sockaddr_in *) ctx-&gt;addr.sockaddr;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; addr = ntohl(sin-&gt;sin_addr.s_addr);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rn = <a href="#L2316" title="core/ngx_resolver.c:2316">ngx_resolver_lookup_addr</a>(r, addr);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rn) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = &amp;rn-&gt;waiting;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; w = rn-&gt;waiting;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">while</span> (w) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (w == ctx) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *p = w-&gt;next;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = &amp;w-&gt;next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; w = w-&gt;next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; u_char&nbsp; &nbsp;&nbsp; text[<a href="ngx_inet.h.html#L31" title="core/ngx_inet.h:31">NGX_SOCKADDR_STRLEN</a>];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a>&nbsp; addrtext;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; addrtext.data = text;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; addrtext.len = <a href="ngx_inet.c.html#L177" title="core/ngx_inet.c:177">ngx_sock_ntop</a>(ctx-&gt;addr.sockaddr, ctx-&gt;addr.socklen,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; text, <a href="ngx_inet.h.html#L31" title="core/ngx_inet.h:31">NGX_SOCKADDR_STRLEN</a>, <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="ngx_log.h.html#L18" title="core/ngx_log.h:18">NGX_LOG_ALERT</a>, r-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;could not cancel %V resolving&quot;</span>, &amp;addrtext);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="Statement">done</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="#L1023" title="core/ngx_resolver.c:1023">ngx_resolver_expire</a>(r, tree, expire_queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* unlock addr mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* lock alloc mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;event) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2891" title="core/ngx_resolver.c:2891">ngx_resolver_free_locked</a>(r, ctx-&gt;event);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L2891" title="core/ngx_resolver.c:2891">ngx_resolver_free_locked</a>(r, ctx);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* unlock alloc mutex */<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L1023">&#x200c;</a></span><span class="linkable">ngx_resolver_expire</span>(<a href="ngx_resolver.h.html#L142" title="core/ngx_resolver.h:142">ngx_resolver_t</a> *r, <a href="ngx_rbtree.h.html#L32" title="core/ngx_rbtree.h:32">ngx_rbtree_t</a> *tree, <a href="ngx_queue.h.html#L16" title="core/ngx_queue.h:16">ngx_queue_t</a> *queue)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">time_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; now;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_queue.h.html#L16" title="core/ngx_queue.h:16">ngx_queue_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *q;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L101" title="core/ngx_resolver.h:101">ngx_resolver_node_t</a>&nbsp; *rn;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_log.h.html#L132" title="core/ngx_log.h:132">ngx_log_debug0</a>(<a href="ngx_log.h.html#L26" title="core/ngx_log.h:26">NGX_LOG_DEBUG_CORE</a>, r-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;resolver expire&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; now = <a href="ngx_times.h.html#L36" title="core/ngx_times.h:36">ngx_time</a>();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; <span class="Constant">2</span>; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="ngx_queue.h.html#L29" title="core/ngx_queue.h:29">ngx_queue_empty</a>(queue)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; q = <a href="ngx_queue.h.html#L54" title="core/ngx_queue.h:54">ngx_queue_last</a>(queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn = <a href="ngx_queue.h.html#L103" title="core/ngx_queue.h:103">ngx_queue_data</a>(q, <a href="ngx_resolver.h.html#L101" title="core/ngx_resolver.h:101">ngx_resolver_node_t</a>, queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (now &lt;= rn-&gt;expire) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.h.html#L138" title="core/ngx_log.h:138">ngx_log_debug2</a>(<a href="ngx_log.h.html#L26" title="core/ngx_log.h:26">NGX_LOG_DEBUG_CORE</a>, r-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;resolver expire </span><span class="Special">\&quot;%*s\&quot;</span><span class="Constant">&quot;</span>, (<span class="Type">size_t</span>) rn-&gt;nlen, rn-&gt;name);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_queue.h.html#L72" title="core/ngx_queue.h:72">ngx_queue_remove</a>(q);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_rbtree.c.html#L157" title="core/ngx_rbtree.c:157">ngx_rbtree_delete</a>(tree, &amp;rn-&gt;node);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2817" title="core/ngx_resolver.c:2817">ngx_resolver_free_node</a>(r, rn);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L1060">&#x200c;</a><span class="linkable">ngx_resolver_send_query</span>(<a href="ngx_resolver.h.html#L142" title="core/ngx_resolver.h:142">ngx_resolver_t</a> *r, <a href="ngx_resolver.h.html#L101" title="core/ngx_resolver.h:101">ngx_resolver_node_t</a> *rn)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">ssize_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L45" title="core/ngx_resolver.h:45">ngx_udp_connection_t</a>&nbsp; *uc;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; uc = r-&gt;udp_connections.elts;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; uc = &amp;uc[r-&gt;last_connection++];<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;last_connection == r-&gt;udp_connections.nelts) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;last_connection = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (uc-&gt;connection == <span class="Constant">NULL</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; uc-&gt;log = *r-&gt;log;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; uc-&gt;log.handler = <a href="#L3021" title="core/ngx_resolver.c:3021">ngx_resolver_log_error</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; uc-&gt;log.data = uc;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; uc-&gt;log.action = <span class="Constant">&quot;resolving&quot;</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L3044" title="core/ngx_resolver.c:3044">ngx_udp_connect</a>(uc) != <a href="ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; uc-&gt;connection-&gt;data = r;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; uc-&gt;connection-&gt;read-&gt;handler = <a href="#L1229" title="core/ngx_resolver.c:1229">ngx_resolver_read_response</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; uc-&gt;connection-&gt;read-&gt;resolver = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;naddrs == (u_short) -<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; n = <a href="../event/ngx_event.h.html#L436" title="event/ngx_event.h:436">ngx_send</a>(uc-&gt;connection, rn-&gt;query, rn-&gt;qlen);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n == -<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((<span class="Type">size_t</span>) n != (<span class="Type">size_t</span>) rn-&gt;qlen) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="ngx_log.h.html#L19" title="core/ngx_log.h:19">NGX_LOG_CRIT</a>, &amp;uc-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;send() incomplete&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;query6 &amp;&amp; rn-&gt;naddrs6 == (u_short) -<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; n = <a href="../event/ngx_event.h.html#L436" title="event/ngx_event.h:436">ngx_send</a>(uc-&gt;connection, rn-&gt;query6, rn-&gt;qlen);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n == -<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((<span class="Type">size_t</span>) n != (<span class="Type">size_t</span>) rn-&gt;qlen) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="ngx_log.h.html#L19" title="core/ngx_log.h:19">NGX_LOG_CRIT</a>, &amp;uc-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;send() incomplete&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L1121">&#x200c;</a></span><span class="linkable">ngx_resolver_resend_handler</span>(<a href="ngx_core.h.html#L21" title="core/ngx_core.h:21">ngx_event_t</a> *ev)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">time_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; timer, atimer, ntimer;<br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">time_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; a6timer;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L142" title="core/ngx_resolver.h:142">ngx_resolver_t</a>&nbsp; *r;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r = ev-&gt;data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_log.h.html#L132" title="core/ngx_log.h:132">ngx_log_debug0</a>(<a href="ngx_log.h.html#L26" title="core/ngx_log.h:26">NGX_LOG_DEBUG_CORE</a>, r-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;resolver resend handler&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* lock name mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; ntimer = <a href="#L1183" title="core/ngx_resolver.c:1183">ngx_resolver_resend</a>(r, &amp;r-&gt;name_rbtree, &amp;r-&gt;name_resend_queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* unlock name mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* lock addr mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; atimer = <a href="#L1183" title="core/ngx_resolver.c:1183">ngx_resolver_resend</a>(r, &amp;r-&gt;addr_rbtree, &amp;r-&gt;addr_resend_queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* unlock addr mutex */<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* lock addr6 mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; a6timer = <a href="#L1183" title="core/ngx_resolver.c:1183">ngx_resolver_resend</a>(r, &amp;r-&gt;addr6_rbtree, &amp;r-&gt;addr6_resend_queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* unlock addr6 mutex */<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; timer = ntimer;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (timer == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; timer = atimer;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (atimer) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; timer = <a href="ngx_core.h.html#L91" title="core/ngx_core.h:91">ngx_min</a>(timer, atimer);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (timer == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; timer = a6timer;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (a6timer) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; timer = <a href="ngx_core.h.html#L91" title="core/ngx_core.h:91">ngx_min</a>(timer, a6timer);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (timer) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event.h.html#L427" title="event/ngx_event.h:427">ngx_add_timer</a>(r-&gt;event, (<a href="../os/unix/ngx_time.h.html#L16" title="os/unix/ngx_time.h:16">ngx_msec_t</a>) (timer * <span class="Constant">1000</span>));<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">time_t<br/></li>
<li><a id="L1183">&#x200c;</a></span><span class="linkable">ngx_resolver_resend</span>(<a href="ngx_resolver.h.html#L142" title="core/ngx_resolver.h:142">ngx_resolver_t</a> *r, <a href="ngx_rbtree.h.html#L32" title="core/ngx_rbtree.h:32">ngx_rbtree_t</a> *tree, <a href="ngx_queue.h.html#L16" title="core/ngx_queue.h:16">ngx_queue_t</a> *queue)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">time_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; now;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_queue.h.html#L16" title="core/ngx_queue.h:16">ngx_queue_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *q;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L101" title="core/ngx_resolver.h:101">ngx_resolver_node_t</a>&nbsp; *rn;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; now = <a href="ngx_times.h.html#L36" title="core/ngx_times.h:36">ngx_time</a>();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> ( ;; ) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="ngx_queue.h.html#L29" title="core/ngx_queue.h:29">ngx_queue_empty</a>(queue)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; q = <a href="ngx_queue.h.html#L54" title="core/ngx_queue.h:54">ngx_queue_last</a>(queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn = <a href="ngx_queue.h.html#L103" title="core/ngx_queue.h:103">ngx_queue_data</a>(q, <a href="ngx_resolver.h.html#L101" title="core/ngx_resolver.h:101">ngx_resolver_node_t</a>, queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (now &lt; rn-&gt;expire) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> rn-&gt;expire - now;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.h.html#L141" title="core/ngx_log.h:141">ngx_log_debug3</a>(<a href="ngx_log.h.html#L26" title="core/ngx_log.h:26">NGX_LOG_DEBUG_CORE</a>, r-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;resolver resend </span><span class="Special">\&quot;%*s\&quot;</span><span class="Constant"> </span><span class="Special">%p</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (<span class="Type">size_t</span>) rn-&gt;nlen, rn-&gt;name, rn-&gt;waiting);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_queue.h.html#L72" title="core/ngx_queue.h:72">ngx_queue_remove</a>(q);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;waiting) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<span class="Type">void</span>) <a href="#L1060" title="core/ngx_resolver.c:1060">ngx_resolver_send_query</a>(r, rn);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;expire = now + r-&gt;resend_timeout;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_queue.h.html#L33" title="core/ngx_queue.h:33">ngx_queue_insert_head</a>(queue, q);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_rbtree.c.html#L157" title="core/ngx_rbtree.c:157">ngx_rbtree_delete</a>(tree, &amp;rn-&gt;node);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2817" title="core/ngx_resolver.c:2817">ngx_resolver_free_node</a>(r, rn);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L1229">&#x200c;</a></span><span class="linkable">ngx_resolver_read_response</span>(<a href="ngx_core.h.html#L21" title="core/ngx_core.h:21">ngx_event_t</a> *rev)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">ssize_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_core.h.html#L23" title="core/ngx_core.h:23">ngx_connection_t</a>&nbsp; *c;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; buf[<a href="#L13" title="core/ngx_resolver.c:13">NGX_RESOLVER_UDP_SIZE</a>];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c = rev-&gt;data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">do</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; n = <a href="../event/ngx_event.h.html#L435" title="event/ngx_event.h:435">ngx_udp_recv</a>(c, buf, <a href="#L13" title="core/ngx_resolver.c:13">NGX_RESOLVER_UDP_SIZE</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n &lt; <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1251" title="core/ngx_resolver.c:1251">ngx_resolver_process_response</a>(c-&gt;data, buf, n);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">while</span> (rev-&gt;ready);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L1251">&#x200c;</a></span><span class="linkable">ngx_resolver_process_response</span>(<a href="ngx_resolver.h.html#L142" title="core/ngx_resolver.h:142">ngx_resolver_t</a> *r, u_char *buf, <span class="Type">size_t</span> n)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *err;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i, times, ident, qident, flags, code, nqs, nan,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; qtype, qclass;<br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; <a href="ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; qident6;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; <a href="ngx_queue.h.html#L16" title="core/ngx_queue.h:16">ngx_queue_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *q;<br/></li>
<li>&nbsp; &nbsp; <a href="#L37" title="core/ngx_resolver.c:37">ngx_resolver_qs_t</a>&nbsp; &nbsp; *qs;<br/></li>
<li>&nbsp; &nbsp; <a href="#L29" title="core/ngx_resolver.c:29">ngx_resolver_hdr_t</a>&nbsp;&nbsp; *response;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L101" title="core/ngx_resolver.h:101">ngx_resolver_node_t</a>&nbsp; *rn;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (n &lt; <span class="Statement">sizeof</span>(<a href="#L29" title="core/ngx_resolver.c:29">ngx_resolver_hdr_t</a>)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> short_response;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; response = (<a href="#L29" title="core/ngx_resolver.c:29">ngx_resolver_hdr_t</a> *) buf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ident = (response-&gt;ident_hi &lt;&lt; <span class="Constant">8</span>) + response-&gt;ident_lo;<br/></li>
<li>&nbsp; &nbsp; flags = (response-&gt;flags_hi &lt;&lt; <span class="Constant">8</span>) + response-&gt;flags_lo;<br/></li>
<li>&nbsp; &nbsp; nqs = (response-&gt;nqs_hi &lt;&lt; <span class="Constant">8</span>) + response-&gt;nqs_lo;<br/></li>
<li>&nbsp; &nbsp; nan = (response-&gt;nan_hi &lt;&lt; <span class="Constant">8</span>) + response-&gt;nan_lo;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_log.h.html#L150" title="core/ngx_log.h:150">ngx_log_debug6</a>(<a href="ngx_log.h.html#L26" title="core/ngx_log.h:26">NGX_LOG_DEBUG_CORE</a>, r-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;resolver DNS response </span><span class="Special">%u</span><span class="Constant">i fl:</span><span class="Special">%04X</span><span class="Constant">ui </span><span class="Special">%u</span><span class="Constant">i/</span><span class="Special">%u</span><span class="Constant">i/</span><span class="Special">%u</span><span class="Constant">d/</span><span class="Special">%u</span><span class="Constant">d&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ident, flags, nqs, nan,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (response-&gt;nns_hi &lt;&lt; <span class="Constant">8</span>) + response-&gt;nns_lo,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (response-&gt;nar_hi &lt;&lt; <span class="Constant">8</span>) + response-&gt;nar_lo);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* response to a standard query */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> ((flags &amp; <span class="Constant">0xf870</span>) != <span class="Constant">0x8000</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(r-&gt;log_level, r-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;invalid DNS response </span><span class="Special">%u</span><span class="Constant">i fl:</span><span class="Special">%04X</span><span class="Constant">ui&quot;</span>, ident, flags);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; code = flags &amp; <span class="Constant">0xf</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (code == <a href="ngx_resolver.h.html#L26" title="core/ngx_resolver.h:26">NGX_RESOLVE_FORMERR</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; times = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (q = <a href="ngx_queue.h.html#L50" title="core/ngx_queue.h:50">ngx_queue_head</a>(&amp;r-&gt;name_resend_queue);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; q != <a href="ngx_queue.h.html#L58" title="core/ngx_queue.h:58">ngx_queue_sentinel</a>(&amp;r-&gt;name_resend_queue) || times++ &lt; <span class="Constant">100</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; q = <a href="ngx_queue.h.html#L62" title="core/ngx_queue.h:62">ngx_queue_next</a>(q))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rn = <a href="ngx_queue.h.html#L103" title="core/ngx_queue.h:103">ngx_queue_data</a>(q, <a href="ngx_resolver.h.html#L101" title="core/ngx_resolver.h:101">ngx_resolver_node_t</a>, queue);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; qident = (rn-&gt;query[<span class="Constant">0</span>] &lt;&lt; <span class="Constant">8</span>) + rn-&gt;query[<span class="Constant">1</span>];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (qident == ident) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> dns_error_name;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;query6) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; qident6 = (rn-&gt;query6[<span class="Constant">0</span>] &lt;&lt; <span class="Constant">8</span>) + rn-&gt;query6[<span class="Constant">1</span>];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (qident6 == ident) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> dns_error_name;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> dns_error;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (code &gt; <a href="ngx_resolver.h.html#L30" title="core/ngx_resolver.h:30">NGX_RESOLVE_REFUSED</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> dns_error;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (nqs != <span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; err = <span class="Constant">&quot;invalid number of questions in DNS response&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; i = <span class="Statement">sizeof</span>(<a href="#L29" title="core/ngx_resolver.c:29">ngx_resolver_hdr_t</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (i &lt; (<a href="ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>) n) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (buf[i] == <span class="Special">'\0'</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> found;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; i += <span class="Constant">1</span> + buf[i];<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">goto</span> short_response;<br/></li>
<li><br/></li>
<li><span class="Statement">found</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (i++ == <span class="Statement">sizeof</span>(<a href="#L29" title="core/ngx_resolver.c:29">ngx_resolver_hdr_t</a>)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; err = <span class="Constant">&quot;zero-length domain name in DNS response&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (i + <span class="Statement">sizeof</span>(<a href="#L37" title="core/ngx_resolver.c:37">ngx_resolver_qs_t</a>) + nan * (<span class="Constant">2</span> + <span class="Statement">sizeof</span>(<a href="#L48" title="core/ngx_resolver.c:48">ngx_resolver_an_t</a>))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &gt; (<a href="ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>) n)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> short_response;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; qs = (<a href="#L37" title="core/ngx_resolver.c:37">ngx_resolver_qs_t</a> *) &amp;buf[i];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; qtype = (qs-&gt;type_hi &lt;&lt; <span class="Constant">8</span>) + qs-&gt;type_lo;<br/></li>
<li>&nbsp; &nbsp; qclass = (qs-&gt;class_hi &lt;&lt; <span class="Constant">8</span>) + qs-&gt;class_lo;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_log.h.html#L138" title="core/ngx_log.h:138">ngx_log_debug2</a>(<a href="ngx_log.h.html#L26" title="core/ngx_log.h:26">NGX_LOG_DEBUG_CORE</a>, r-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;resolver DNS response qt:</span><span class="Special">%u</span><span class="Constant">i cl:</span><span class="Special">%u</span><span class="Constant">i&quot;</span>, qtype, qclass);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (qclass != <span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(r-&gt;log_level, r-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;unknown query class </span><span class="Special">%u</span><span class="Constant">i in DNS response&quot;</span>, qclass);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">switch</span> (qtype) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="ngx_resolver.h.html#L16" title="core/ngx_resolver.h:16">NGX_RESOLVE_A</a>:<br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">case</span> <a href="ngx_resolver.h.html#L22" title="core/ngx_resolver.h:22">NGX_RESOLVE_AAAA</a>:<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1421" title="core/ngx_resolver.c:1421">ngx_resolver_process_a</a>(r, buf, n, ident, code, qtype, nan,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; i + <span class="Statement">sizeof</span>(<a href="#L37" title="core/ngx_resolver.c:37">ngx_resolver_qs_t</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="ngx_resolver.h.html#L18" title="core/ngx_resolver.h:18">NGX_RESOLVE_PTR</a>:<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2005" title="core/ngx_resolver.c:2005">ngx_resolver_process_ptr</a>(r, buf, n, ident, code, nan);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(r-&gt;log_level, r-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;unknown query type </span><span class="Special">%u</span><span class="Constant">i in DNS response&quot;</span>, qtype);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li><br/></li>
<li><span class="Statement">short_response</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; err = <span class="Constant">&quot;short DNS response&quot;</span>;<br/></li>
<li><br/></li>
<li><span class="Statement">done</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(r-&gt;log_level, r-&gt;log, <span class="Constant">0</span>, err);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li><br/></li>
<li><span class="Statement">dns_error_name</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(r-&gt;log_level, r-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;DNS error (</span><span class="Special">%u</span><span class="Constant">i: </span><span class="Special">%s</span><span class="Constant">), query id:</span><span class="Special">%u</span><span class="Constant">i, name:</span><span class="Special">\&quot;%*s\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; code, <a href="#L2998" title="core/ngx_resolver.c:2998">ngx_resolver_strerror</a>(code), ident,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;nlen, rn-&gt;name);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li><br/></li>
<li><span class="Statement">dns_error</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(r-&gt;log_level, r-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;DNS error (</span><span class="Special">%u</span><span class="Constant">i: </span><span class="Special">%s</span><span class="Constant">), query id:</span><span class="Special">%u</span><span class="Constant">i&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; code, <a href="#L2998" title="core/ngx_resolver.c:2998">ngx_resolver_strerror</a>(code), ident);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L1421">&#x200c;</a></span><span class="linkable">ngx_resolver_process_a</span>(<a href="ngx_resolver.h.html#L142" title="core/ngx_resolver.h:142">ngx_resolver_t</a> *r, u_char *buf, <span class="Type">size_t</span> last,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> ident, <a href="ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> code, <a href="ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> qtype,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> nan, <a href="ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> ans)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *err;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *cname;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int32_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ttl;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uint32_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; hash;<br/></li>
<li>&nbsp; &nbsp; in_addr_t&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *addr;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; name;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_inet.h.html#L74" title="core/ngx_inet.h:74">ngx_addr_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *addrs;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; type, class, qident, naddrs, a, i, n, start;<br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">struct</span> in6_addr&nbsp; &nbsp; &nbsp; *addr6;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L48" title="core/ngx_resolver.c:48">ngx_resolver_an_t</a>&nbsp; &nbsp; *an;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L48" title="core/ngx_resolver.h:48">ngx_resolver_ctx_t</a>&nbsp;&nbsp; *ctx, *next;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L101" title="core/ngx_resolver.h:101">ngx_resolver_node_t</a>&nbsp; *rn;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L2702" title="core/ngx_resolver.c:2702">ngx_resolver_copy</a>(r, &amp;name, buf,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; buf + <span class="Statement">sizeof</span>(<a href="#L29" title="core/ngx_resolver.c:29">ngx_resolver_hdr_t</a>), buf + last)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; != <a href="ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="ngx_log.h.html#L26" title="core/ngx_log.h:26">NGX_LOG_DEBUG_CORE</a>, r-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;resolver qs:%V&quot;</span>, &amp;name);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; hash = <a href="ngx_crc32.h.html#L21" title="core/ngx_crc32.h:21">ngx_crc32_short</a>(name.data, name.len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* lock name mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; rn = <a href="#L2275" title="core/ngx_resolver.c:2275">ngx_resolver_lookup_name</a>(r, &amp;name, hash);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rn == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(r-&gt;log_level, r-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;unexpected response for %V&quot;</span>, &amp;name);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2880" title="core/ngx_resolver.c:2880">ngx_resolver_free</a>(r, name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">switch</span> (qtype) {<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">case</span> <a href="ngx_resolver.h.html#L22" title="core/ngx_resolver.h:22">NGX_RESOLVE_AAAA</a>:<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;query6 == <span class="Constant">NULL</span> || rn-&gt;naddrs6 != (u_short) -<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(r-&gt;log_level, r-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;unexpected response for %V&quot;</span>, &amp;name);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2880" title="core/ngx_resolver.c:2880">ngx_resolver_free</a>(r, name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; qident = (rn-&gt;query6[<span class="Constant">0</span>] &lt;&lt; <span class="Constant">8</span>) + rn-&gt;query6[<span class="Constant">1</span>];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:</span> <span class="Comment">/* <a href="ngx_resolver.h.html#L16" title="core/ngx_resolver.h:16">NGX_RESOLVE_A</a> */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;query == <span class="Constant">NULL</span> || rn-&gt;naddrs != (u_short) -<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(r-&gt;log_level, r-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;unexpected response for %V&quot;</span>, &amp;name);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2880" title="core/ngx_resolver.c:2880">ngx_resolver_free</a>(r, name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; qident = (rn-&gt;query[<span class="Constant">0</span>] &lt;&lt; <span class="Constant">8</span>) + rn-&gt;query[<span class="Constant">1</span>];<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ident != qident) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(r-&gt;log_level, r-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;wrong ident </span><span class="Special">%u</span><span class="Constant">i response for %V, expect </span><span class="Special">%u</span><span class="Constant">i&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ident, &amp;name, qident);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2880" title="core/ngx_resolver.c:2880">ngx_resolver_free</a>(r, name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L2880" title="core/ngx_resolver.c:2880">ngx_resolver_free</a>(r, name.data);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (code == <span class="Constant">0</span> &amp;&amp; rn-&gt;code) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; code = rn-&gt;code;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (code == <span class="Constant">0</span> &amp;&amp; nan == <span class="Constant">0</span>) {<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (qtype) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="ngx_resolver.h.html#L22" title="core/ngx_resolver.h:22">NGX_RESOLVE_AAAA</a>:<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;naddrs6 = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;naddrs == (u_short) -<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;naddrs) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> export;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:</span> <span class="Comment">/* <a href="ngx_resolver.h.html#L16" title="core/ngx_resolver.h:16">NGX_RESOLVE_A</a> */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;naddrs = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;naddrs6 == (u_short) -<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;naddrs6) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> export;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; code = <a href="ngx_resolver.h.html#L28" title="core/ngx_resolver.h:28">NGX_RESOLVE_NXDOMAIN</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (code) {<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (qtype) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="ngx_resolver.h.html#L22" title="core/ngx_resolver.h:22">NGX_RESOLVE_AAAA</a>:<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;naddrs6 = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;naddrs == (u_short) -<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;code = (u_char) code;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:</span> <span class="Comment">/* <a href="ngx_resolver.h.html#L16" title="core/ngx_resolver.h:16">NGX_RESOLVE_A</a> */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;naddrs = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;naddrs6 == (u_short) -<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;code = (u_char) code;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; next = rn-&gt;waiting;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;waiting = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_queue.h.html#L72" title="core/ngx_queue.h:72">ngx_queue_remove</a>(&amp;rn-&gt;queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_rbtree.c.html#L157" title="core/ngx_rbtree.c:157">ngx_rbtree_delete</a>(&amp;r-&gt;name_rbtree, &amp;rn-&gt;node);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* unlock name mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">while</span> (next) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx = next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;state = code;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; next = ctx-&gt;next;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;handler(ctx);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2817" title="core/ngx_resolver.c:2817">ngx_resolver_free_node</a>(r, rn);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; i = ans;<br/></li>
<li>&nbsp; &nbsp; naddrs = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; cname = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (a = <span class="Constant">0</span>; a &lt; nan; a++) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; start = i;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">while</span> (i &lt; last) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (buf[i] &amp; <span class="Constant">0xc0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i += <span class="Constant">2</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> found;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (buf[i] == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> test_length;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i += <span class="Constant">1</span> + buf[i];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> short_response;<br/></li>
<li><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; </span><span class="Statement">test_length</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (i - start &lt; <span class="Constant">2</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; err = <span class="Constant">&quot;invalid name in DNS response&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> invalid;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; </span><span class="Statement">found</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (i + <span class="Statement">sizeof</span>(<a href="#L48" title="core/ngx_resolver.c:48">ngx_resolver_an_t</a>) &gt;= last) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> short_response;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; an = (<a href="#L48" title="core/ngx_resolver.c:48">ngx_resolver_an_t</a> *) &amp;buf[i];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; type = (an-&gt;type_hi &lt;&lt; <span class="Constant">8</span>) + an-&gt;type_lo;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; class = (an-&gt;class_hi &lt;&lt; <span class="Constant">8</span>) + an-&gt;class_lo;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; len = (an-&gt;len_hi &lt;&lt; <span class="Constant">8</span>) + an-&gt;len_lo;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ttl = (an-&gt;ttl[<span class="Constant">0</span>] &lt;&lt; <span class="Constant">24</span>) + (an-&gt;ttl[<span class="Constant">1</span>] &lt;&lt; <span class="Constant">16</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; + (an-&gt;ttl[<span class="Constant">2</span>] &lt;&lt; <span class="Constant">8</span>) + (an-&gt;ttl[<span class="Constant">3</span>]);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (class != <span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(r-&gt;log_level, r-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;unexpected RR class </span><span class="Special">%u</span><span class="Constant">i&quot;</span>, class);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ttl &lt; <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ttl = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;ttl = <a href="ngx_core.h.html#L91" title="core/ngx_core.h:91">ngx_min</a>(rn-&gt;ttl, (<span class="Type">uint32_t</span>) ttl);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; i += <span class="Statement">sizeof</span>(<a href="#L48" title="core/ngx_resolver.c:48">ngx_resolver_an_t</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (type) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="ngx_resolver.h.html#L16" title="core/ngx_resolver.h:16">NGX_RESOLVE_A</a>:<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (qtype != <a href="ngx_resolver.h.html#L16" title="core/ngx_resolver.h:16">NGX_RESOLVE_A</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; err = <span class="Constant">&quot;unexpected A record in DNS response&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> invalid;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (len != <span class="Constant">4</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; err = <span class="Constant">&quot;invalid A record in DNS response&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> invalid;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (i + <span class="Constant">4</span> &gt; last) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> short_response;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; naddrs++;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="ngx_resolver.h.html#L22" title="core/ngx_resolver.h:22">NGX_RESOLVE_AAAA</a>:<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (qtype != <a href="ngx_resolver.h.html#L22" title="core/ngx_resolver.h:22">NGX_RESOLVE_AAAA</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; err = <span class="Constant">&quot;unexpected AAAA record in DNS response&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> invalid;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (len != <span class="Constant">16</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; err = <span class="Constant">&quot;invalid AAAA record in DNS response&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> invalid;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (i + <span class="Constant">16</span> &gt; last) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> short_response;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; naddrs++;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="ngx_resolver.h.html#L17" title="core/ngx_resolver.h:17">NGX_RESOLVE_CNAME</a>:<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cname = &amp;buf[i];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="ngx_resolver.h.html#L24" title="core/ngx_resolver.h:24">NGX_RESOLVE_DNAME</a>:<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(r-&gt;log_level, r-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;unexpected RR type </span><span class="Special">%u</span><span class="Constant">i&quot;</span>, type);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; i += len;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_log.h.html#L141" title="core/ngx_log.h:141">ngx_log_debug3</a>(<a href="ngx_log.h.html#L26" title="core/ngx_log.h:26">NGX_LOG_DEBUG_CORE</a>, r-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;resolver naddrs:</span><span class="Special">%u</span><span class="Constant">i cname:</span><span class="Special">%p</span><span class="Constant"> ttl:</span><span class="Special">%u</span><span class="Constant">D&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; naddrs, cname, rn-&gt;ttl);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (naddrs) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (qtype) {<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="ngx_resolver.h.html#L22" title="core/ngx_resolver.h:22">NGX_RESOLVE_AAAA</a>:<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (naddrs == <span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; addr6 = &amp;rn-&gt;u6.addr6;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;naddrs6 = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; addr6 = <a href="#L2850" title="core/ngx_resolver.c:2850">ngx_resolver_alloc</a>(r, naddrs * <span class="Statement">sizeof</span>(<span class="Type">struct</span> in6_addr));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (addr6 == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;u6.addrs6 = addr6;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;naddrs6 = (u_short) naddrs;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_SUPPRESS_WARN)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; addr = <span class="Constant">NULL</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:</span> <span class="Comment">/* <a href="ngx_resolver.h.html#L16" title="core/ngx_resolver.h:16">NGX_RESOLVE_A</a> */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (naddrs == <span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; addr = &amp;rn-&gt;u.addr;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;naddrs = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; addr = <a href="#L2850" title="core/ngx_resolver.c:2850">ngx_resolver_alloc</a>(r, naddrs * <span class="Statement">sizeof</span>(in_addr_t));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (addr == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;u.addrs = addr;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;naddrs = (u_short) naddrs;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6 &amp;&amp; NGX_SUPPRESS_WARN)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; addr6 = <span class="Constant">NULL</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; n = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; i = ans;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (a = <span class="Constant">0</span>; a &lt; nan; a++) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> ( ;; ) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (buf[i] &amp; <span class="Constant">0xc0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i += <span class="Constant">2</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (buf[i] == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i += <span class="Constant">1</span> + buf[i];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; an = (<a href="#L48" title="core/ngx_resolver.c:48">ngx_resolver_an_t</a> *) &amp;buf[i];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; type = (an-&gt;type_hi &lt;&lt; <span class="Constant">8</span>) + an-&gt;type_lo;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len = (an-&gt;len_hi &lt;&lt; <span class="Constant">8</span>) + an-&gt;len_lo;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i += <span class="Statement">sizeof</span>(<a href="#L48" title="core/ngx_resolver.c:48">ngx_resolver_an_t</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (type == <a href="ngx_resolver.h.html#L16" title="core/ngx_resolver.h:16">NGX_RESOLVE_A</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; addr[n] = htonl((buf[i] &lt;&lt; <span class="Constant">24</span>) + (buf[i + <span class="Constant">1</span>] &lt;&lt; <span class="Constant">16</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; + (buf[i + <span class="Constant">2</span>] &lt;&lt; <span class="Constant">8</span>) + (buf[i + <span class="Constant">3</span>]));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (++n == naddrs) {<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;naddrs6 == (u_short) -<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (type == <a href="ngx_resolver.h.html#L22" title="core/ngx_resolver.h:22">NGX_RESOLVE_AAAA</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_string.c.html#L1947" title="core/ngx_string.c:1947">ngx_memcpy</a>(addr6[n].s6_addr, &amp;buf[i], <span class="Constant">16</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (++n == naddrs) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;naddrs == (u_short) -<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i += len;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">switch</span> (qtype) {<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">case</span> <a href="ngx_resolver.h.html#L22" title="core/ngx_resolver.h:22">NGX_RESOLVE_AAAA</a>:<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;naddrs6 == (u_short) -<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;naddrs6 = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:</span> <span class="Comment">/* <a href="ngx_resolver.h.html#L16" title="core/ngx_resolver.h:16">NGX_RESOLVE_A</a> */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;naddrs == (u_short) -<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;naddrs = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;naddrs != (u_short) -<span class="Constant">1<br/></li>
<li></span><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; rn-&gt;naddrs6 != (u_short) -<span class="Constant">1<br/></li>
<li></span><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; rn-&gt;naddrs<br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; + rn-&gt;naddrs6<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &gt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span><span class="cUserCont">&nbsp; &nbsp; </span><span class="Statement">export</span><span class="cUserCont">:<br/></li>
<li></span><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; naddrs = rn-&gt;naddrs;<br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; naddrs += rn-&gt;naddrs6;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (naddrs == <span class="Constant">1</span> &amp;&amp; rn-&gt;naddrs == <span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; addrs = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; addrs = <a href="#L2915" title="core/ngx_resolver.c:2915">ngx_resolver_export</a>(r, rn, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (addrs == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_queue.h.html#L72" title="core/ngx_queue.h:72">ngx_queue_remove</a>(&amp;rn-&gt;queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;valid = <a href="ngx_times.h.html#L36" title="core/ngx_times.h:36">ngx_time</a>() + (r-&gt;valid ? r-&gt;valid : (<span class="Type">time_t</span>) rn-&gt;ttl);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;expire = <a href="ngx_times.h.html#L36" title="core/ngx_times.h:36">ngx_time</a>() + r-&gt;expire;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_queue.h.html#L33" title="core/ngx_queue.h:33">ngx_queue_insert_head</a>(&amp;r-&gt;name_expire_queue, &amp;rn-&gt;queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; next = rn-&gt;waiting;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;waiting = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* unlock name mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">while</span> (next) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx = next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;state = <a href="ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;naddrs = naddrs;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (addrs == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;addrs = &amp;ctx-&gt;addr;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;addr.sockaddr = (<span class="Type">struct</span> sockaddr *) &amp;ctx-&gt;sin;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;addr.socklen = <span class="Statement">sizeof</span>(<span class="Type">struct</span> sockaddr_in);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_string.h.html#L86" title="core/ngx_string.h:86">ngx_memzero</a>(&amp;ctx-&gt;sin, <span class="Statement">sizeof</span>(<span class="Type">struct</span> sockaddr_in));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;sin.sin_family = AF_INET;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;sin.sin_addr.s_addr = rn-&gt;u.addr;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;addrs = addrs;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; next = ctx-&gt;next;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;handler(ctx);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (addrs != <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2880" title="core/ngx_resolver.c:2880">ngx_resolver_free</a>(r, addrs-&gt;sockaddr);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2880" title="core/ngx_resolver.c:2880">ngx_resolver_free</a>(r, addrs);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2880" title="core/ngx_resolver.c:2880">ngx_resolver_free</a>(r, rn-&gt;query);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;query = <span class="Constant">NULL</span>;<br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;query6 = <span class="Constant">NULL</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cname) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* CNAME only */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;naddrs == (u_short) -<span class="Constant">1<br/></li>
<li></span><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || rn-&gt;naddrs6 == (u_short) -<span class="Constant">1<br/></li>
<li></span><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; )<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L2702" title="core/ngx_resolver.c:2702">ngx_resolver_copy</a>(r, &amp;name, buf, cname, buf + last) != <a href="ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="ngx_log.h.html#L26" title="core/ngx_log.h:26">NGX_LOG_DEBUG_CORE</a>, r-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;resolver cname:</span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, &amp;name);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_queue.h.html#L72" title="core/ngx_queue.h:72">ngx_queue_remove</a>(&amp;rn-&gt;queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;cnlen = (u_short) name.len;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;u.cname = name.data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;valid = <a href="ngx_times.h.html#L36" title="core/ngx_times.h:36">ngx_time</a>() + (r-&gt;valid ? r-&gt;valid : (<span class="Type">time_t</span>) rn-&gt;ttl);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;expire = <a href="ngx_times.h.html#L36" title="core/ngx_times.h:36">ngx_time</a>() + r-&gt;expire;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_queue.h.html#L33" title="core/ngx_queue.h:33">ngx_queue_insert_head</a>(&amp;r-&gt;name_expire_queue, &amp;rn-&gt;queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx = rn-&gt;waiting;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;waiting = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ctx) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;name = name;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<span class="Type">void</span>) <a href="#L470" title="core/ngx_resolver.c:470">ngx_resolve_name_locked</a>(r, ctx);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2880" title="core/ngx_resolver.c:2880">ngx_resolver_free</a>(r, rn-&gt;query);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;query = <span class="Constant">NULL</span>;<br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;query6 = <span class="Constant">NULL</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* unlock name mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(r-&gt;log_level, r-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;no A or CNAME types in DNS response&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li><br/></li>
<li><span class="Statement">short_response</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; err = <span class="Constant">&quot;short DNS response&quot;</span>;<br/></li>
<li><br/></li>
<li><span class="Statement">invalid</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* unlock name mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(r-&gt;log_level, r-&gt;log, <span class="Constant">0</span>, err);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li><br/></li>
<li><span class="Statement">failed</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li><span class="Statement">next</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* unlock name mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L2005">&#x200c;</a></span><span class="linkable">ngx_resolver_process_ptr</span>(<a href="ngx_resolver.h.html#L142" title="core/ngx_resolver.h:142">ngx_resolver_t</a> *r, u_char *buf, <span class="Type">size_t</span> n,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> ident, <a href="ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> code, <a href="ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> nan)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *err;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; text[<a href="ngx_inet.h.html#L31" title="core/ngx_inet.h:31">NGX_SOCKADDR_STRLEN</a>];<br/></li>
<li>&nbsp; &nbsp; in_addr_t&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; addr;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int32_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ttl;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; octet;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; name;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i, mask, qident, class;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_queue.h.html#L16" title="core/ngx_queue.h:16">ngx_queue_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *expire_queue;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_rbtree.h.html#L32" title="core/ngx_rbtree.h:32">ngx_rbtree_t</a>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *tree;<br/></li>
<li>&nbsp; &nbsp; <a href="#L48" title="core/ngx_resolver.c:48">ngx_resolver_an_t</a>&nbsp; &nbsp; *an;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L48" title="core/ngx_resolver.h:48">ngx_resolver_ctx_t</a>&nbsp;&nbsp; *ctx, *next;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L101" title="core/ngx_resolver.h:101">ngx_resolver_node_t</a>&nbsp; *rn;<br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">uint32_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; hash;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; digit;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">struct</span> in6_addr&nbsp; &nbsp; &nbsp;&nbsp; addr6;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L2702" title="core/ngx_resolver.c:2702">ngx_resolver_copy</a>(r, <span class="Constant">NULL</span>, buf,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; buf + <span class="Statement">sizeof</span>(<a href="#L29" title="core/ngx_resolver.c:29">ngx_resolver_hdr_t</a>), buf + n)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; != <a href="ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* AF_INET */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; addr = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; i = <span class="Statement">sizeof</span>(<a href="#L29" title="core/ngx_resolver.c:29">ngx_resolver_hdr_t</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (mask = <span class="Constant">0</span>; mask &lt; <span class="Constant">32</span>; mask += <span class="Constant">8</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; len = buf[i++];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; octet = <a href="ngx_string.c.html#L898" title="core/ngx_string.c:898">ngx_atoi</a>(&amp;buf[i], len);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (octet == <a href="ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a> || octet &gt; <span class="Constant">255</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> invalid_in_addr_arpa;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; addr += octet &lt;&lt; mask;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; i += len;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="ngx_string.c.html#L567" title="core/ngx_string.c:567">ngx_strcasecmp</a>(&amp;buf[i], (u_char *) <span class="Constant">&quot;</span><span class="Special">\7</span><span class="Constant">in-addr</span><span class="Special">\4</span><span class="Constant">arpa&quot;</span>) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; i += <span class="Statement">sizeof</span>(<span class="Constant">&quot;</span><span class="Special">\7</span><span class="Constant">in-addr</span><span class="Special">\4</span><span class="Constant">arpa&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* lock addr mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn = <a href="#L2316" title="core/ngx_resolver.c:2316">ngx_resolver_lookup_addr</a>(r, addr);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; tree = &amp;r-&gt;addr_rbtree;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; expire_queue = &amp;r-&gt;addr_expire_queue;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; addr = htonl(addr);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; name.len = <a href="ngx_inet.c.html#L256" title="core/ngx_inet.c:256">ngx_inet_ntop</a>(AF_INET, &amp;addr, text, <a href="ngx_inet.h.html#L31" title="core/ngx_inet.h:31">NGX_SOCKADDR_STRLEN</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; name.data = text;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> valid;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="Statement">invalid_in_addr_arpa</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; i = <span class="Statement">sizeof</span>(<a href="#L29" title="core/ngx_resolver.c:29">ngx_resolver_hdr_t</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (octet = <span class="Constant">15</span>; octet &gt;= <span class="Constant">0</span>; octet--) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (buf[i++] != <span class="Special">'\1'</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> invalid_ip6_arpa;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; digit = <a href="ngx_string.c.html#L1052" title="core/ngx_string.c:1052">ngx_hextoi</a>(&amp;buf[i++], <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (digit == <a href="ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> invalid_ip6_arpa;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; addr6.s6_addr[octet] = (u_char) digit;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (buf[i++] != <span class="Special">'\1'</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> invalid_ip6_arpa;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; digit = <a href="ngx_string.c.html#L1052" title="core/ngx_string.c:1052">ngx_hextoi</a>(&amp;buf[i++], <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (digit == <a href="ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> invalid_ip6_arpa;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; addr6.s6_addr[octet] += (u_char) (digit * <span class="Constant">16</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="ngx_string.c.html#L567" title="core/ngx_string.c:567">ngx_strcasecmp</a>(&amp;buf[i], (u_char *) <span class="Constant">&quot;</span><span class="Special">\3</span><span class="Constant">ip6</span><span class="Special">\4</span><span class="Constant">arpa&quot;</span>) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; i += <span class="Statement">sizeof</span>(<span class="Constant">&quot;</span><span class="Special">\3</span><span class="Constant">ip6</span><span class="Special">\4</span><span class="Constant">arpa&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* lock addr mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; hash = <a href="ngx_crc32.h.html#L21" title="core/ngx_crc32.h:21">ngx_crc32_short</a>(addr6.s6_addr, <span class="Constant">16</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn = <a href="#L2349" title="core/ngx_resolver.c:2349">ngx_resolver_lookup_addr6</a>(r, &amp;addr6, hash);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; tree = &amp;r-&gt;addr6_rbtree;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; expire_queue = &amp;r-&gt;addr6_expire_queue;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; name.len = <a href="ngx_inet.c.html#L286" title="core/ngx_inet.c:286">ngx_inet6_ntop</a>(addr6.s6_addr, text, <a href="ngx_inet.h.html#L31" title="core/ngx_inet.h:31">NGX_SOCKADDR_STRLEN</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; name.data = text;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> valid;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="Statement">invalid_ip6_arpa</span><span class="cUserCont">:<br/></li>
<li></span><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(r-&gt;log_level, r-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;invalid in-addr.arpa or ip6.arpa name in DNS response&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li><br/></li>
<li><span class="Statement">valid</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rn == <span class="Constant">NULL</span> || rn-&gt;query == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(r-&gt;log_level, r-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;unexpected response for %V&quot;</span>, &amp;name);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; qident = (rn-&gt;query[<span class="Constant">0</span>] &lt;&lt; <span class="Constant">8</span>) + rn-&gt;query[<span class="Constant">1</span>];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ident != qident) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(r-&gt;log_level, r-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;wrong ident </span><span class="Special">%u</span><span class="Constant">i response for %V, expect </span><span class="Special">%u</span><span class="Constant">i&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ident, &amp;name, qident);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (code == <span class="Constant">0</span> &amp;&amp; nan == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; code = <a href="ngx_resolver.h.html#L28" title="core/ngx_resolver.h:28">NGX_RESOLVE_NXDOMAIN</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (code) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; next = rn-&gt;waiting;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;waiting = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_queue.h.html#L72" title="core/ngx_queue.h:72">ngx_queue_remove</a>(&amp;rn-&gt;queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_rbtree.c.html#L157" title="core/ngx_rbtree.c:157">ngx_rbtree_delete</a>(tree, &amp;rn-&gt;node);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* unlock addr mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">while</span> (next) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx = next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;state = code;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; next = ctx-&gt;next;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;handler(ctx);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2817" title="core/ngx_resolver.c:2817">ngx_resolver_free_node</a>(r, rn);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; i += <span class="Statement">sizeof</span>(<a href="#L37" title="core/ngx_resolver.c:37">ngx_resolver_qs_t</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (i + <span class="Constant">2</span> + <span class="Statement">sizeof</span>(<a href="#L48" title="core/ngx_resolver.c:48">ngx_resolver_an_t</a>) &gt;= n) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> short_response;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* compression pointer to *.arpa */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (buf[i] != <span class="Constant">0xc0</span> || buf[i + <span class="Constant">1</span>] != <span class="Statement">sizeof</span>(<a href="#L29" title="core/ngx_resolver.c:29">ngx_resolver_hdr_t</a>)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; err = <span class="Constant">&quot;invalid in-addr.arpa or ip6.arpa name in DNS response&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> invalid;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; an = (<a href="#L48" title="core/ngx_resolver.c:48">ngx_resolver_an_t</a> *) &amp;buf[i + <span class="Constant">2</span>];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; class = (an-&gt;class_hi &lt;&lt; <span class="Constant">8</span>) + an-&gt;class_lo;<br/></li>
<li>&nbsp; &nbsp; len = (an-&gt;len_hi &lt;&lt; <span class="Constant">8</span>) + an-&gt;len_lo;<br/></li>
<li>&nbsp; &nbsp; ttl = (an-&gt;ttl[<span class="Constant">0</span>] &lt;&lt; <span class="Constant">24</span>) + (an-&gt;ttl[<span class="Constant">1</span>] &lt;&lt; <span class="Constant">16</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; + (an-&gt;ttl[<span class="Constant">2</span>] &lt;&lt; <span class="Constant">8</span>) + (an-&gt;ttl[<span class="Constant">3</span>]);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (class != <span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(r-&gt;log_level, r-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;unexpected RR class </span><span class="Special">%u</span><span class="Constant">i&quot;</span>, class);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ttl &lt; <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ttl = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_log.h.html#L141" title="core/ngx_log.h:141">ngx_log_debug3</a>(<a href="ngx_log.h.html#L26" title="core/ngx_log.h:26">NGX_LOG_DEBUG_CORE</a>, r-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;resolver qt:</span><span class="Special">%u</span><span class="Constant">i cl:</span><span class="Special">%u</span><span class="Constant">i len:</span><span class="Special">%u</span><span class="Constant">z&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (an-&gt;type_hi &lt;&lt; <span class="Constant">8</span>) + an-&gt;type_lo,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; class, len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; i += <span class="Constant">2</span> + <span class="Statement">sizeof</span>(<a href="#L48" title="core/ngx_resolver.c:48">ngx_resolver_an_t</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (i + len &gt; n) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> short_response;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L2702" title="core/ngx_resolver.c:2702">ngx_resolver_copy</a>(r, &amp;name, buf, buf + i, buf + n) != <a href="ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="ngx_log.h.html#L26" title="core/ngx_log.h:26">NGX_LOG_DEBUG_CORE</a>, r-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;resolver an:%V&quot;</span>, &amp;name);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (name.len != (<span class="Type">size_t</span>) rn-&gt;nlen<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; || <a href="ngx_string.h.html#L53" title="core/ngx_string.h:53">ngx_strncmp</a>(name.data, rn-&gt;name, name.len) != <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;nlen) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2880" title="core/ngx_resolver.c:2880">ngx_resolver_free</a>(r, rn-&gt;name);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;nlen = (u_short) name.len;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;name = name.data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; name.data = <a href="#L2898" title="core/ngx_resolver.c:2898">ngx_resolver_dup</a>(r, rn-&gt;name, name.len);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (name.data == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_queue.h.html#L72" title="core/ngx_queue.h:72">ngx_queue_remove</a>(&amp;rn-&gt;queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rn-&gt;valid = <a href="ngx_times.h.html#L36" title="core/ngx_times.h:36">ngx_time</a>() + (r-&gt;valid ? r-&gt;valid : ttl);<br/></li>
<li>&nbsp; &nbsp; rn-&gt;expire = <a href="ngx_times.h.html#L36" title="core/ngx_times.h:36">ngx_time</a>() + r-&gt;expire;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_queue.h.html#L33" title="core/ngx_queue.h:33">ngx_queue_insert_head</a>(expire_queue, &amp;rn-&gt;queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; next = rn-&gt;waiting;<br/></li>
<li>&nbsp; &nbsp; rn-&gt;waiting = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* unlock addr mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (next) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx = next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;state = <a href="ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;name = name;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; next = ctx-&gt;next;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;handler(ctx);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L2880" title="core/ngx_resolver.c:2880">ngx_resolver_free</a>(r, name.data);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li><br/></li>
<li><span class="Statement">short_response</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; err = <span class="Constant">&quot;short DNS response&quot;</span>;<br/></li>
<li><br/></li>
<li><span class="Statement">invalid</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* unlock addr mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(r-&gt;log_level, r-&gt;log, <span class="Constant">0</span>, err);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li><br/></li>
<li><span class="Statement">failed</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* unlock addr mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="ngx_resolver.h.html#L101" title="core/ngx_resolver.h:101">ngx_resolver_node_t</a> *<br/></li>
<li><a id="L2275">&#x200c;</a><span class="linkable">ngx_resolver_lookup_name</span>(<a href="ngx_resolver.h.html#L142" title="core/ngx_resolver.h:142">ngx_resolver_t</a> *r, <a href="ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a> *name, <span class="Type">uint32_t</span> hash)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; rc;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_rbtree.h.html#L20" title="core/ngx_rbtree.h:20">ngx_rbtree_node_t</a>&nbsp; &nbsp; *node, *sentinel;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L101" title="core/ngx_resolver.h:101">ngx_resolver_node_t</a>&nbsp; *rn;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; node = r-&gt;name_rbtree.root;<br/></li>
<li>&nbsp; &nbsp; sentinel = r-&gt;name_rbtree.sentinel;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (node != sentinel) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (hash &lt; node-&gt;key) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; node = node-&gt;left;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (hash &gt; node-&gt;key) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; node = node-&gt;right;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* hash == node-&gt;key */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn = <a href="#L51" title="core/ngx_resolver.c:51">ngx_resolver_node</a>(node);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="ngx_string.c.html#L802" title="core/ngx_string.c:802">ngx_memn2cmp</a>(name-&gt;data, rn-&gt;name, name-&gt;len, rn-&gt;nlen);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> rn;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; node = (rc &lt; <span class="Constant">0</span>) ? node-&gt;left : node-&gt;right;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* not found */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="ngx_resolver.h.html#L101" title="core/ngx_resolver.h:101">ngx_resolver_node_t</a> *<br/></li>
<li><a id="L2316">&#x200c;</a><span class="linkable">ngx_resolver_lookup_addr</span>(<a href="ngx_resolver.h.html#L142" title="core/ngx_resolver.h:142">ngx_resolver_t</a> *r, in_addr_t addr)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_rbtree.h.html#L20" title="core/ngx_rbtree.h:20">ngx_rbtree_node_t</a>&nbsp; *node, *sentinel;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; node = r-&gt;addr_rbtree.root;<br/></li>
<li>&nbsp; &nbsp; sentinel = r-&gt;addr_rbtree.sentinel;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (node != sentinel) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (addr &lt; node-&gt;key) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; node = node-&gt;left;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (addr &gt; node-&gt;key) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; node = node-&gt;right;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* addr == node-&gt;key */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L51" title="core/ngx_resolver.c:51">ngx_resolver_node</a>(node);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* not found */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span><br/></li>
<li><span class="Type">static</span> <a href="ngx_resolver.h.html#L101" title="core/ngx_resolver.h:101">ngx_resolver_node_t</a> *<br/></li>
<li><a id="L2349">&#x200c;</a><span class="linkable">ngx_resolver_lookup_addr6</span>(<a href="ngx_resolver.h.html#L142" title="core/ngx_resolver.h:142">ngx_resolver_t</a> *r, <span class="Type">struct</span> in6_addr *addr,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uint32_t</span> hash)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; rc;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_rbtree.h.html#L20" title="core/ngx_rbtree.h:20">ngx_rbtree_node_t</a>&nbsp; &nbsp; *node, *sentinel;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L101" title="core/ngx_resolver.h:101">ngx_resolver_node_t</a>&nbsp; *rn;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; node = r-&gt;addr6_rbtree.root;<br/></li>
<li>&nbsp; &nbsp; sentinel = r-&gt;addr6_rbtree.sentinel;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (node != sentinel) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (hash &lt; node-&gt;key) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; node = node-&gt;left;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (hash &gt; node-&gt;key) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; node = node-&gt;right;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* hash == node-&gt;key */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn = <a href="#L51" title="core/ngx_resolver.c:51">ngx_resolver_node</a>(node);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="ngx_string.h.html#L144" title="core/ngx_string.h:144">ngx_memcmp</a>(addr, &amp;rn-&gt;addr6, <span class="Constant">16</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> rn;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; node = (rc &lt; <span class="Constant">0</span>) ? node-&gt;left : node-&gt;right;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* not found */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L2393">&#x200c;</a></span><span class="linkable">ngx_resolver_rbtree_insert_value</span>(<a href="ngx_rbtree.h.html#L20" title="core/ngx_rbtree.h:20">ngx_rbtree_node_t</a> *temp,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_rbtree.h.html#L20" title="core/ngx_rbtree.h:20">ngx_rbtree_node_t</a> *node, <a href="ngx_rbtree.h.html#L20" title="core/ngx_rbtree.h:20">ngx_rbtree_node_t</a> *sentinel)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_rbtree.h.html#L20" title="core/ngx_rbtree.h:20">ngx_rbtree_node_t</a>&nbsp; &nbsp; **p;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L101" title="core/ngx_resolver.h:101">ngx_resolver_node_t</a>&nbsp;&nbsp; *rn, *rn_temp;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> ( ;; ) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (node-&gt;key &lt; temp-&gt;key) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = &amp;temp-&gt;left;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (node-&gt;key &gt; temp-&gt;key) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = &amp;temp-&gt;right;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> { <span class="Comment">/* node-&gt;key == temp-&gt;key */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rn = <a href="#L51" title="core/ngx_resolver.c:51">ngx_resolver_node</a>(node);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rn_temp = <a href="#L51" title="core/ngx_resolver.c:51">ngx_resolver_node</a>(temp);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = (<a href="ngx_string.c.html#L802" title="core/ngx_string.c:802">ngx_memn2cmp</a>(rn-&gt;name, rn_temp-&gt;name, rn-&gt;nlen, rn_temp-&gt;nlen)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &lt; <span class="Constant">0</span>) ? &amp;temp-&gt;left : &amp;temp-&gt;right;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (*p == sentinel) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; temp = *p;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; *p = node;<br/></li>
<li>&nbsp; &nbsp; node-&gt;parent = temp;<br/></li>
<li>&nbsp; &nbsp; node-&gt;left = sentinel;<br/></li>
<li>&nbsp; &nbsp; node-&gt;right = sentinel;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_rbtree.h.html#L59" title="core/ngx_rbtree.h:59">ngx_rbt_red</a>(node);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L2436">&#x200c;</a></span><span class="linkable">ngx_resolver_rbtree_insert_addr6_value</span>(<a href="ngx_rbtree.h.html#L20" title="core/ngx_rbtree.h:20">ngx_rbtree_node_t</a> *temp,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_rbtree.h.html#L20" title="core/ngx_rbtree.h:20">ngx_rbtree_node_t</a> *node, <a href="ngx_rbtree.h.html#L20" title="core/ngx_rbtree.h:20">ngx_rbtree_node_t</a> *sentinel)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_rbtree.h.html#L20" title="core/ngx_rbtree.h:20">ngx_rbtree_node_t</a>&nbsp; &nbsp; **p;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L101" title="core/ngx_resolver.h:101">ngx_resolver_node_t</a>&nbsp;&nbsp; *rn, *rn_temp;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> ( ;; ) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (node-&gt;key &lt; temp-&gt;key) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = &amp;temp-&gt;left;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (node-&gt;key &gt; temp-&gt;key) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = &amp;temp-&gt;right;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> { <span class="Comment">/* node-&gt;key == temp-&gt;key */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rn = <a href="#L51" title="core/ngx_resolver.c:51">ngx_resolver_node</a>(node);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rn_temp = <a href="#L51" title="core/ngx_resolver.c:51">ngx_resolver_node</a>(temp);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = (<a href="ngx_string.h.html#L144" title="core/ngx_string.h:144">ngx_memcmp</a>(&amp;rn-&gt;addr6, &amp;rn_temp-&gt;addr6, <span class="Constant">16</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &lt; <span class="Constant">0</span>) ? &amp;temp-&gt;left : &amp;temp-&gt;right;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (*p == sentinel) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; temp = *p;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; *p = node;<br/></li>
<li>&nbsp; &nbsp; node-&gt;parent = temp;<br/></li>
<li>&nbsp; &nbsp; node-&gt;left = sentinel;<br/></li>
<li>&nbsp; &nbsp; node-&gt;right = sentinel;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_rbtree.h.html#L59" title="core/ngx_rbtree.h:59">ngx_rbt_red</a>(node);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L2479">&#x200c;</a><span class="linkable">ngx_resolver_create_name_query</span>(<a href="ngx_resolver.h.html#L101" title="core/ngx_resolver.h:101">ngx_resolver_node_t</a> *rn, <a href="ngx_resolver.h.html#L48" title="core/ngx_resolver.h:48">ngx_resolver_ctx_t</a> *ctx)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *p, *s;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; len, nlen;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ident;<br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L142" title="core/ngx_resolver.h:142">ngx_resolver_t</a>&nbsp; &nbsp; &nbsp; *r;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L37" title="core/ngx_resolver.c:37">ngx_resolver_qs_t</a>&nbsp;&nbsp; *qs;<br/></li>
<li>&nbsp; &nbsp; <a href="#L29" title="core/ngx_resolver.c:29">ngx_resolver_hdr_t</a>&nbsp; *query;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; nlen = ctx-&gt;name.len ? (<span class="Constant">1</span> + ctx-&gt;name.len + <span class="Constant">1</span>) : <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; len = <span class="Statement">sizeof</span>(<a href="#L29" title="core/ngx_resolver.c:29">ngx_resolver_hdr_t</a>) + nlen + <span class="Statement">sizeof</span>(<a href="#L37" title="core/ngx_resolver.c:37">ngx_resolver_qs_t</a>);<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; r = ctx-&gt;resolver;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p = <a href="#L2850" title="core/ngx_resolver.c:2850">ngx_resolver_alloc</a>(ctx-&gt;resolver, r-&gt;ipv6 ? len * <span class="Constant">2</span> : len);<br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span>&nbsp; &nbsp; p = <a href="#L2850" title="core/ngx_resolver.c:2850">ngx_resolver_alloc</a>(ctx-&gt;resolver, len);<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (p == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rn-&gt;qlen = (u_short) len;<br/></li>
<li>&nbsp; &nbsp; rn-&gt;query = p;<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;ipv6) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;query6 = p + len;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; query = (<a href="#L29" title="core/ngx_resolver.c:29">ngx_resolver_hdr_t</a> *) p;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ident = <a href="ngx_config.h.html#L57" title="core/ngx_config.h:57">ngx_random</a>();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_log.h.html#L138" title="core/ngx_log.h:138">ngx_log_debug2</a>(<a href="ngx_log.h.html#L26" title="core/ngx_log.h:26">NGX_LOG_DEBUG_CORE</a>, ctx-&gt;resolver-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;resolve: </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant"> A </span><span class="Special">%i</span><span class="Constant">&quot;</span>, &amp;ctx-&gt;name, ident &amp; <span class="Constant">0xffff</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; query-&gt;ident_hi = (u_char) ((ident &gt;&gt; <span class="Constant">8</span>) &amp; <span class="Constant">0xff</span>);<br/></li>
<li>&nbsp; &nbsp; query-&gt;ident_lo = (u_char) (ident &amp; <span class="Constant">0xff</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* recursion query */<br/></li>
<li></span>&nbsp; &nbsp; query-&gt;flags_hi = <span class="Constant">1</span>; query-&gt;flags_lo = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* one question */<br/></li>
<li></span>&nbsp; &nbsp; query-&gt;nqs_hi = <span class="Constant">0</span>; query-&gt;nqs_lo = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; query-&gt;nan_hi = <span class="Constant">0</span>; query-&gt;nan_lo = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; query-&gt;nns_hi = <span class="Constant">0</span>; query-&gt;nns_lo = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; query-&gt;nar_hi = <span class="Constant">0</span>; query-&gt;nar_lo = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p += <span class="Statement">sizeof</span>(<a href="#L29" title="core/ngx_resolver.c:29">ngx_resolver_hdr_t</a>) + nlen;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; qs = (<a href="#L37" title="core/ngx_resolver.c:37">ngx_resolver_qs_t</a> *) p;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* query type */<br/></li>
<li></span>&nbsp; &nbsp; qs-&gt;type_hi = <span class="Constant">0</span>; qs-&gt;type_lo = <a href="ngx_resolver.h.html#L16" title="core/ngx_resolver.h:16">NGX_RESOLVE_A</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* IN query class */<br/></li>
<li></span>&nbsp; &nbsp; qs-&gt;class_hi = <span class="Constant">0</span>; qs-&gt;class_lo = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* convert &quot;www.example.com&quot; to &quot;\3www\7example\3com\0&quot; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; len = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; p--;<br/></li>
<li>&nbsp; &nbsp; *p-- = <span class="Special">'\0'</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;name.len == <span class="Constant">0</span>)&nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L34" title="core/ngx_core.h:34">NGX_DECLINED</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (s = ctx-&gt;name.data + ctx-&gt;name.len - <span class="Constant">1</span>; s &gt;= ctx-&gt;name.data; s--) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (*s != <span class="Constant">'.'</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *p = *s;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len++;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (len == <span class="Constant">0</span> || len &gt; <span class="Constant">255</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L34" title="core/ngx_core.h:34">NGX_DECLINED</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *p = (u_char) len;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p--;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (len == <span class="Constant">0</span> || len &gt; <span class="Constant">255</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L34" title="core/ngx_core.h:34">NGX_DECLINED</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; *p = (u_char) len;<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (!r-&gt;ipv6) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p = rn-&gt;query6;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_string.c.html#L1947" title="core/ngx_string.c:1947">ngx_memcpy</a>(p, rn-&gt;query, rn-&gt;qlen);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; query = (<a href="#L29" title="core/ngx_resolver.c:29">ngx_resolver_hdr_t</a> *) p;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ident = <a href="ngx_config.h.html#L57" title="core/ngx_config.h:57">ngx_random</a>();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_log.h.html#L138" title="core/ngx_log.h:138">ngx_log_debug2</a>(<a href="ngx_log.h.html#L26" title="core/ngx_log.h:26">NGX_LOG_DEBUG_CORE</a>, ctx-&gt;resolver-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;resolve: </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant"> AAAA </span><span class="Special">%i</span><span class="Constant">&quot;</span>, &amp;ctx-&gt;name, ident &amp; <span class="Constant">0xffff</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; query-&gt;ident_hi = (u_char) ((ident &gt;&gt; <span class="Constant">8</span>) &amp; <span class="Constant">0xff</span>);<br/></li>
<li>&nbsp; &nbsp; query-&gt;ident_lo = (u_char) (ident &amp; <span class="Constant">0xff</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p += <span class="Statement">sizeof</span>(<a href="#L29" title="core/ngx_resolver.c:29">ngx_resolver_hdr_t</a>) + nlen;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; qs = (<a href="#L37" title="core/ngx_resolver.c:37">ngx_resolver_qs_t</a> *) p;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; qs-&gt;type_lo = <a href="ngx_resolver.h.html#L22" title="core/ngx_resolver.h:22">NGX_RESOLVE_AAAA</a>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L2607">&#x200c;</a><span class="linkable">ngx_resolver_create_addr_query</span>(<a href="ngx_resolver.h.html#L101" title="core/ngx_resolver.h:101">ngx_resolver_node_t</a> *rn, <a href="ngx_resolver.h.html#L48" title="core/ngx_resolver.h:48">ngx_resolver_ctx_t</a> *ctx)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *p, *d;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len;<br/></li>
<li>&nbsp; &nbsp; in_addr_t&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; addr;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; n;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ident;<br/></li>
<li>&nbsp; &nbsp; <a href="#L29" title="core/ngx_resolver.c:29">ngx_resolver_hdr_t</a>&nbsp;&nbsp; *query;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">struct</span> sockaddr_in&nbsp;&nbsp; *sin;<br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">struct</span> sockaddr_in6&nbsp; *sin6;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">switch</span> (ctx-&gt;addr.sockaddr-&gt;sa_family) {<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">case</span> AF_INET6:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; len = <span class="Statement">sizeof</span>(<a href="#L29" title="core/ngx_resolver.c:29">ngx_resolver_hdr_t</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; + <span class="Constant">64</span> + <span class="Statement">sizeof</span>(<span class="Constant">&quot;.ip6.arpa.&quot;</span>) - <span class="Constant">1<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; + <span class="Statement">sizeof</span>(<a href="#L37" title="core/ngx_resolver.c:37">ngx_resolver_qs_t</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:</span> <span class="Comment">/* AF_INET */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; len = <span class="Statement">sizeof</span>(<a href="#L29" title="core/ngx_resolver.c:29">ngx_resolver_hdr_t</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; + <span class="Statement">sizeof</span>(<span class="Constant">&quot;.255.255.255.255.in-addr.arpa.&quot;</span>) - <span class="Constant">1<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; + <span class="Statement">sizeof</span>(<a href="#L37" title="core/ngx_resolver.c:37">ngx_resolver_qs_t</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p = <a href="#L2850" title="core/ngx_resolver.c:2850">ngx_resolver_alloc</a>(ctx-&gt;resolver, len);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (p == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rn-&gt;query = p;<br/></li>
<li>&nbsp; &nbsp; query = (<a href="#L29" title="core/ngx_resolver.c:29">ngx_resolver_hdr_t</a> *) p;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ident = <a href="ngx_config.h.html#L57" title="core/ngx_config.h:57">ngx_random</a>();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; query-&gt;ident_hi = (u_char) ((ident &gt;&gt; <span class="Constant">8</span>) &amp; <span class="Constant">0xff</span>);<br/></li>
<li>&nbsp; &nbsp; query-&gt;ident_lo = (u_char) (ident &amp; <span class="Constant">0xff</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* recursion query */<br/></li>
<li></span>&nbsp; &nbsp; query-&gt;flags_hi = <span class="Constant">1</span>; query-&gt;flags_lo = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* one question */<br/></li>
<li></span>&nbsp; &nbsp; query-&gt;nqs_hi = <span class="Constant">0</span>; query-&gt;nqs_lo = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; query-&gt;nan_hi = <span class="Constant">0</span>; query-&gt;nan_lo = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; query-&gt;nns_hi = <span class="Constant">0</span>; query-&gt;nns_lo = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; query-&gt;nar_hi = <span class="Constant">0</span>; query-&gt;nar_lo = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p += <span class="Statement">sizeof</span>(<a href="#L29" title="core/ngx_resolver.c:29">ngx_resolver_hdr_t</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">switch</span> (ctx-&gt;addr.sockaddr-&gt;sa_family) {<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">case</span> AF_INET6:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; sin6 = (<span class="Type">struct</span> sockaddr_in6 *) ctx-&gt;addr.sockaddr;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (n = <span class="Constant">15</span>; n &gt;= <span class="Constant">0</span>; n--) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = <a href="ngx_string.c.html#L105" title="core/ngx_string.c:105">ngx_sprintf</a>(p, <span class="Constant">&quot;</span><span class="Special">\1%x</span><span class="Constant">d</span><span class="Special">\1%x</span><span class="Constant">d&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sin6-&gt;sin6_addr.s6_addr[n] &amp; <span class="Constant">0xf</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (sin6-&gt;sin6_addr.s6_addr[n] &gt;&gt; <span class="Constant">4</span>) &amp; <span class="Constant">0xf</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p = <a href="ngx_string.h.html#L93" title="core/ngx_string.h:93">ngx_cpymem</a>(p, <span class="Constant">&quot;</span><span class="Special">\3</span><span class="Constant">ip6</span><span class="Special">\4</span><span class="Constant">arpa</span><span class="Special">\0</span><span class="Constant">&quot;</span>, <span class="Constant">10</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:</span> <span class="Comment">/* AF_INET */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; sin = (<span class="Type">struct</span> sockaddr_in *) ctx-&gt;addr.sockaddr;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; addr = ntohl(sin-&gt;sin_addr.s_addr);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (n = <span class="Constant">0</span>; n &lt; <span class="Constant">32</span>; n += <span class="Constant">8</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; d = <a href="ngx_string.c.html#L105" title="core/ngx_string.c:105">ngx_sprintf</a>(&amp;p[<span class="Constant">1</span>], <span class="Constant">&quot;</span><span class="Special">%u</span><span class="Constant">d&quot;</span>, (addr &gt;&gt; n) &amp; <span class="Constant">0xff</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *p = (u_char) (d - &amp;p[<span class="Constant">1</span>]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = d;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p = <a href="ngx_string.h.html#L93" title="core/ngx_string.h:93">ngx_cpymem</a>(p, <span class="Constant">&quot;</span><span class="Special">\7</span><span class="Constant">in-addr</span><span class="Special">\4</span><span class="Constant">arpa</span><span class="Special">\0</span><span class="Constant">&quot;</span>, <span class="Constant">14</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* query type &quot;PTR&quot;, IN query class */<br/></li>
<li></span>&nbsp; &nbsp; p = <a href="ngx_string.h.html#L93" title="core/ngx_string.h:93">ngx_cpymem</a>(p, <span class="Constant">&quot;</span><span class="Special">\0\14\0\1</span><span class="Constant">&quot;</span>, <span class="Constant">4</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rn-&gt;qlen = (u_short) (p - rn-&gt;query);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L2702">&#x200c;</a><span class="linkable">ngx_resolver_copy</span>(<a href="ngx_resolver.h.html#L142" title="core/ngx_resolver.h:142">ngx_resolver_t</a> *r, <a href="ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a> *name, u_char *buf, u_char *src,<br/></li>
<li>&nbsp; &nbsp; u_char *last)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp; &nbsp; *err;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; *p, *dst;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">ssize_t</span>&nbsp; &nbsp; &nbsp; len;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp;&nbsp; i, n;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p = src;<br/></li>
<li>&nbsp; &nbsp; len = -<span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * compression pointers allow to create endless loop, so we <a href="../event/modules/ngx_rtsig_module.c.html#L75" title="event/modules/ngx_rtsig_module.c:75">set</a> limit;<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * 128 pointers should be enough to store 255-byte name<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; <span class="Constant">128</span>; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; n = *p++;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n &amp; <span class="Constant">0xc0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n = ((n &amp; <span class="Constant">0x3f</span>) &lt;&lt; <span class="Constant">8</span>) + *p;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = &amp;buf[n];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len += <span class="Constant">1</span> + n;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = &amp;p[n];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (p &gt;= last) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; err = <span class="Constant">&quot;name is out of response&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> invalid;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; err = <span class="Constant">&quot;compression pointers loop&quot;</span>;<br/></li>
<li><br/></li>
<li><span class="Statement">invalid</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(r-&gt;log_level, r-&gt;log, <span class="Constant">0</span>, err);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li><br/></li>
<li><span class="Statement">done</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (name == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (len == -<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_string.h.html#L44" title="core/ngx_string.h:44">ngx_str_null</a>(name);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; dst = <a href="#L2850" title="core/ngx_resolver.c:2850">ngx_resolver_alloc</a>(r, len);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (dst == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; name-&gt;data = dst;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; n = *src++;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> ( ;; ) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n &amp; <span class="Constant">0xc0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n = ((n &amp; <span class="Constant">0x3f</span>) &lt;&lt; <span class="Constant">8</span>) + *src;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; src = &amp;buf[n];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n = *src++;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_string.c.html#L21" title="core/ngx_string.c:21">ngx_strlow</a>(dst, src, n);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dst += n;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; src += n;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n = *src++;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n != <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *dst++ = <span class="Constant">'.'</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; name-&gt;len = dst - name-&gt;data;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L2796">&#x200c;</a></span><span class="linkable">ngx_resolver_timeout_handler</span>(<a href="ngx_core.h.html#L21" title="core/ngx_core.h:21">ngx_event_t</a> *ev)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L48" title="core/ngx_resolver.h:48">ngx_resolver_ctx_t</a>&nbsp;&nbsp; *ctx, *next;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L101" title="core/ngx_resolver.h:101">ngx_resolver_node_t</a>&nbsp; *rn;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rn = ev-&gt;data;<br/></li>
<li>&nbsp; &nbsp; ctx = rn-&gt;waiting;<br/></li>
<li>&nbsp; &nbsp; rn-&gt;waiting = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">do</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;state = <a href="ngx_resolver.h.html#L31" title="core/ngx_resolver.h:31">NGX_RESOLVE_TIMEDOUT</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; next = ctx-&gt;next;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;handler(ctx);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx = next;<br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">while</span> (ctx);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L2817">&#x200c;</a></span><span class="linkable">ngx_resolver_free_node</span>(<a href="ngx_resolver.h.html#L142" title="core/ngx_resolver.h:142">ngx_resolver_t</a> *r, <a href="ngx_resolver.h.html#L101" title="core/ngx_resolver.h:101">ngx_resolver_node_t</a> *rn)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* lock alloc mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;query) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2891" title="core/ngx_resolver.c:2891">ngx_resolver_free_locked</a>(r, rn-&gt;query);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;name) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2891" title="core/ngx_resolver.c:2891">ngx_resolver_free_locked</a>(r, rn-&gt;name);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;cnlen) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2891" title="core/ngx_resolver.c:2891">ngx_resolver_free_locked</a>(r, rn-&gt;u.cname);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;naddrs &gt; <span class="Constant">1</span> &amp;&amp; rn-&gt;naddrs != (u_short) -<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2891" title="core/ngx_resolver.c:2891">ngx_resolver_free_locked</a>(r, rn-&gt;u.addrs);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;naddrs6 &gt; <span class="Constant">1</span> &amp;&amp; rn-&gt;naddrs6 != (u_short) -<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2891" title="core/ngx_resolver.c:2891">ngx_resolver_free_locked</a>(r, rn-&gt;u6.addrs6);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="#L2891" title="core/ngx_resolver.c:2891">ngx_resolver_free_locked</a>(r, rn);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* unlock alloc mutex */<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> *<br/></li>
<li><a id="L2850">&#x200c;</a><span class="linkable">ngx_resolver_alloc</span>(<a href="ngx_resolver.h.html#L142" title="core/ngx_resolver.h:142">ngx_resolver_t</a> *r, <span class="Type">size_t</span> size)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; *p;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* lock alloc mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; p = <a href="../os/unix/ngx_alloc.c.html#L18" title="os/unix/ngx_alloc.c:18">ngx_alloc</a>(size, r-&gt;log);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* unlock alloc mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> p;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> *<br/></li>
<li><a id="L2865">&#x200c;</a><span class="linkable">ngx_resolver_calloc</span>(<a href="ngx_resolver.h.html#L142" title="core/ngx_resolver.h:142">ngx_resolver_t</a> *r, <span class="Type">size_t</span> size)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; *p;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p = <a href="#L2850" title="core/ngx_resolver.c:2850">ngx_resolver_alloc</a>(r, size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (p) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_string.h.html#L86" title="core/ngx_string.h:86">ngx_memzero</a>(p, size);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> p;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L2880">&#x200c;</a></span><span class="linkable">ngx_resolver_free</span>(<a href="ngx_resolver.h.html#L142" title="core/ngx_resolver.h:142">ngx_resolver_t</a> *r, <span class="Type">void</span> *p)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* lock alloc mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="../os/unix/ngx_alloc.h.html#L19" title="os/unix/ngx_alloc.h:19">ngx_free</a>(p);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* unlock alloc mutex */<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L2891">&#x200c;</a></span><span class="linkable">ngx_resolver_free_locked</span>(<a href="ngx_resolver.h.html#L142" title="core/ngx_resolver.h:142">ngx_resolver_t</a> *r, <span class="Type">void</span> *p)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../os/unix/ngx_alloc.h.html#L19" title="os/unix/ngx_alloc.h:19">ngx_free</a>(p);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> *<br/></li>
<li><a id="L2898">&#x200c;</a><span class="linkable">ngx_resolver_dup</span>(<a href="ngx_resolver.h.html#L142" title="core/ngx_resolver.h:142">ngx_resolver_t</a> *r, <span class="Type">void</span> *src, <span class="Type">size_t</span> size)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">void</span>&nbsp; *dst;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; dst = <a href="#L2850" title="core/ngx_resolver.c:2850">ngx_resolver_alloc</a>(r, size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (dst == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> dst;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_string.c.html#L1947" title="core/ngx_string.c:1947">ngx_memcpy</a>(dst, src, size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> dst;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="ngx_inet.h.html#L74" title="core/ngx_inet.h:74">ngx_addr_t</a> *<br/></li>
<li><a id="L2915">&#x200c;</a><span class="linkable">ngx_resolver_export</span>(<a href="ngx_resolver.h.html#L142" title="core/ngx_resolver.h:142">ngx_resolver_t</a> *r, <a href="ngx_resolver.h.html#L101" title="core/ngx_resolver.h:101">ngx_resolver_node_t</a> *rn,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> rotate)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_inet.h.html#L74" title="core/ngx_inet.h:74">ngx_addr_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *dst;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; d, i, j, n;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (*sockaddr)[<a href="ngx_inet.h.html#L37" title="core/ngx_inet.h:37">NGX_SOCKADDRLEN</a>];<br/></li>
<li>&nbsp; &nbsp; in_addr_t&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *addr;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">struct</span> sockaddr_in&nbsp; &nbsp; *sin;<br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">struct</span> in6_addr&nbsp; &nbsp; &nbsp;&nbsp; *addr6;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">struct</span> sockaddr_in6&nbsp;&nbsp; *sin6;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; n = rn-&gt;naddrs;<br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; n += rn-&gt;naddrs6;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; dst = <a href="#L2865" title="core/ngx_resolver.c:2865">ngx_resolver_calloc</a>(r, n * <span class="Statement">sizeof</span>(<a href="ngx_inet.h.html#L74" title="core/ngx_inet.h:74">ngx_addr_t</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (dst == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; sockaddr = <a href="#L2865" title="core/ngx_resolver.c:2865">ngx_resolver_calloc</a>(r, n * <a href="ngx_inet.h.html#L37" title="core/ngx_inet.h:37">NGX_SOCKADDRLEN</a>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (sockaddr == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2880" title="core/ngx_resolver.c:2880">ngx_resolver_free</a>(r, dst);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; i = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; d = rotate ? <a href="ngx_config.h.html#L57" title="core/ngx_config.h:57">ngx_random</a>() % n : <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;naddrs) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; j = rotate ? <a href="ngx_config.h.html#L57" title="core/ngx_config.h:57">ngx_random</a>() % rn-&gt;naddrs : <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; addr = (rn-&gt;naddrs == <span class="Constant">1</span>) ? &amp;rn-&gt;u.addr : rn-&gt;u.addrs;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">do</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sin = (<span class="Type">struct</span> sockaddr_in *) sockaddr[d];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sin-&gt;sin_family = AF_INET;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sin-&gt;sin_addr.s_addr = addr[j++];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dst[d].sockaddr = (<span class="Type">struct</span> sockaddr *) sin;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dst[d++].socklen = <span class="Statement">sizeof</span>(<span class="Type">struct</span> sockaddr_in);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (d == n) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; d = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (j == rn-&gt;naddrs) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; j = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">while</span> (++i &lt; rn-&gt;naddrs);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;naddrs6) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; j = rotate ? <a href="ngx_config.h.html#L57" title="core/ngx_config.h:57">ngx_random</a>() % rn-&gt;naddrs6 : <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; addr6 = (rn-&gt;naddrs6 == <span class="Constant">1</span>) ? &amp;rn-&gt;u6.addr6 : rn-&gt;u6.addrs6;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">do</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sin6 = (<span class="Type">struct</span> sockaddr_in6 *) sockaddr[d];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sin6-&gt;sin6_family = AF_INET6;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_string.c.html#L1947" title="core/ngx_string.c:1947">ngx_memcpy</a>(sin6-&gt;sin6_addr.s6_addr, addr6[j++].s6_addr, <span class="Constant">16</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dst[d].sockaddr = (<span class="Type">struct</span> sockaddr *) sin6;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dst[d++].socklen = <span class="Statement">sizeof</span>(<span class="Type">struct</span> sockaddr_in6);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (d == n) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; d = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (j == rn-&gt;naddrs6) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; j = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">while</span> (++i &lt; n);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> dst;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">char</span> *<br/></li>
<li><a id="L2998">&#x200c;</a><span class="linkable">ngx_resolver_strerror</span>(<a href="ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> err)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">static</span> <span class="Type">char</span> *errors[] = {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;Format error&quot;</span>,&nbsp; &nbsp;&nbsp; <span class="Comment">/* FORMERR */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;Server failure&quot;</span>,&nbsp;&nbsp; <span class="Comment">/* SERVFAIL */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;Host not found&quot;</span>,&nbsp;&nbsp; <span class="Comment">/* NXDOMAIN */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;Unimplemented&quot;</span>,&nbsp; &nbsp; <span class="Comment">/* NOTIMP */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;Operation refused&quot;</span> <span class="Comment">/* REFUSED */<br/></li>
<li></span>&nbsp; &nbsp; };<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (err &gt; <span class="Constant">0</span> &amp;&amp; err &lt; <span class="Constant">6</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> errors[err - <span class="Constant">1</span>];<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (err == <a href="ngx_resolver.h.html#L31" title="core/ngx_resolver.h:31">NGX_RESOLVE_TIMEDOUT</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">&quot;Operation timed out&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">&quot;Unknown error&quot;</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> u_char *<br/></li>
<li><a id="L3021">&#x200c;</a><span class="linkable">ngx_resolver_log_error</span>(<a href="ngx_core.h.html#L17" title="core/ngx_core.h:17">ngx_log_t</a> *log, u_char *buf, <span class="Type">size_t</span> len)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *p;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L45" title="core/ngx_resolver.h:45">ngx_udp_connection_t</a>&nbsp; *uc;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p = buf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (log-&gt;action) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p = <a href="ngx_string.c.html#L119" title="core/ngx_string.c:119">ngx_snprintf</a>(buf, len, <span class="Constant">&quot; while </span><span class="Special">%s</span><span class="Constant">&quot;</span>, log-&gt;action);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; len -= p - buf;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; uc = log-&gt;data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (uc) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p = <a href="ngx_string.c.html#L119" title="core/ngx_string.c:119">ngx_snprintf</a>(p, len, <span class="Constant">&quot;, resolver: %V&quot;</span>, &amp;uc-&gt;server);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> p;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a href="ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L3044">&#x200c;</a><span class="linkable">ngx_udp_connect</span>(<a href="ngx_resolver.h.html#L45" title="core/ngx_resolver.h:45">ngx_udp_connection_t</a> *uc)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; event;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_core.h.html#L21" title="core/ngx_core.h:21">ngx_event_t</a>&nbsp; &nbsp; &nbsp;&nbsp; *rev, *wev;<br/></li>
<li>&nbsp; &nbsp; <a href="../os/unix/ngx_socket.h.html#L17" title="os/unix/ngx_socket.h:17">ngx_socket_t</a>&nbsp; &nbsp; &nbsp;&nbsp; s;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_core.h.html#L23" title="core/ngx_core.h:23">ngx_connection_t</a>&nbsp; *c;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; s = <a href="../os/unix/ngx_socket.h.html#L19" title="os/unix/ngx_socket.h:19">ngx_socket</a>(uc-&gt;sockaddr-&gt;sa_family, SOCK_DGRAM, <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="ngx_log.h.html#L29" title="core/ngx_log.h:29">NGX_LOG_DEBUG_EVENT</a>, &amp;uc-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;UDP socket </span><span class="Special">%d</span><span class="Constant">&quot;</span>, s);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (s == (<a href="../os/unix/ngx_socket.h.html#L17" title="os/unix/ngx_socket.h:17">ngx_socket_t</a>) -<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="ngx_log.h.html#L18" title="core/ngx_log.h:18">NGX_LOG_ALERT</a>, &amp;uc-&gt;log, <a href="../os/unix/ngx_errno.h.html#L69" title="os/unix/ngx_errno.h:69">ngx_socket_errno</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../os/unix/ngx_socket.h.html#L20" title="os/unix/ngx_socket.h:20">ngx_socket_n</a> <span class="Constant">&quot; failed&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c = <a href="ngx_connection.c.html#L822" title="core/ngx_connection.c:822">ngx_get_connection</a>(s, &amp;uc-&gt;log);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../os/unix/ngx_socket.h.html#L60" title="os/unix/ngx_socket.h:60">ngx_close_socket</a>(s) == -<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="ngx_log.h.html#L18" title="core/ngx_log.h:18">NGX_LOG_ALERT</a>, &amp;uc-&gt;log, <a href="../os/unix/ngx_errno.h.html#L69" title="os/unix/ngx_errno.h:69">ngx_socket_errno</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../os/unix/ngx_socket.h.html#L61" title="os/unix/ngx_socket.h:61">ngx_close_socket_n</a> <span class="Constant">&quot;failed&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../os/unix/ngx_socket.c.html#L27" title="os/unix/ngx_socket.c:27">ngx_nonblocking</a>(s) == -<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="ngx_log.h.html#L18" title="core/ngx_log.h:18">NGX_LOG_ALERT</a>, &amp;uc-&gt;log, <a href="../os/unix/ngx_errno.h.html#L69" title="os/unix/ngx_errno.h:69">ngx_socket_errno</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../os/unix/ngx_socket.h.html#L28" title="os/unix/ngx_socket.h:28">ngx_nonblocking_n</a> <span class="Constant">&quot; failed&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rev = c-&gt;read;<br/></li>
<li>&nbsp; &nbsp; wev = c-&gt;write;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rev-&gt;log = &amp;uc-&gt;log;<br/></li>
<li>&nbsp; &nbsp; wev-&gt;log = &amp;uc-&gt;log;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; uc-&gt;connection = c;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c-&gt;number = <a href="../os/unix/ngx_gcc_atomic_amd64.h.html#L67" title="os/unix/ngx_gcc_atomic_amd64.h:67">ngx_atomic_fetch_add</a>(<a href="../event/ngx_event.c.html#L49" title="event/ngx_event.c:49">ngx_connection_counter</a>, <span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_log.h.html#L141" title="core/ngx_log.h:141">ngx_log_debug3</a>(<a href="ngx_log.h.html#L29" title="core/ngx_log.h:29">NGX_LOG_DEBUG_EVENT</a>, &amp;uc-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;connect to %V, fd:</span><span class="Special">%d</span><span class="Constant"> #</span><span class="Special">%u</span><span class="Constant">A&quot;</span>, &amp;uc-&gt;server, s, c-&gt;number);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rc = connect(s, uc-&gt;sockaddr, uc-&gt;socklen);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* </span><span class="Todo">TODO</span><span class="Comment">: aio, iocp */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc == -<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="ngx_log.h.html#L19" title="core/ngx_log.h:19">NGX_LOG_CRIT</a>, &amp;uc-&gt;log, <a href="../os/unix/ngx_errno.h.html#L69" title="os/unix/ngx_errno.h:69">ngx_socket_errno</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;connect() failed&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* UDP sockets are always ready to write */<br/></li>
<li></span>&nbsp; &nbsp; wev-&gt;ready = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../event/ngx_event.h.html#L422" title="event/ngx_event.h:422">ngx_add_event</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; event = (<a href="../event/ngx_event.c.html#L44" title="event/ngx_event.c:44">ngx_event_flags</a> &amp; <a href="../event/ngx_event.h.html#L233" title="event/ngx_event.h:233">NGX_USE_CLEAR_EVENT</a>) ?<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* kqueue, epoll */</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../event/ngx_event.h.html#L358" title="event/ngx_event.h:358">NGX_CLEAR_EVENT</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* select, poll, /dev/poll */</span>&nbsp; &nbsp; &nbsp;&nbsp; <a href="../event/ngx_event.h.html#L356" title="event/ngx_event.h:356">NGX_LEVEL_EVENT</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* eventport event type has no meaning: oneshot only */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../event/ngx_event.h.html#L422" title="event/ngx_event.h:422">ngx_add_event</a>(rev, <a href="../event/ngx_event.h.html#L334" title="event/ngx_event.h:334">NGX_READ_EVENT</a>, event) != <a href="ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* rtsig */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../event/ngx_event.h.html#L424" title="event/ngx_event.h:424">ngx_add_conn</a>(c) == <a href="ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li><br/></li>
<li><span class="Statement">failed</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_connection.c.html#L914" title="core/ngx_connection.c:914">ngx_close_connection</a>(c);<br/></li>
<li>&nbsp; &nbsp; uc-&gt;connection = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>}<br/></li>
</ol></code>
 </body>
</html>
