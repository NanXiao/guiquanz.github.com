<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>http/ngx_http_spdy_filter_module.c - src</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

code {
    font-family: consolas, monospace;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
  <h3>http/ngx_http_spdy_filter_module.c - src</h3>
   <a href="../index.html"> Table of Contents </a>
 <h4>Global variables defined</h4>
 <ul>
<li><a href="#L92">ngx_http_next_header_filter</a></li>
<li><a href="#L76">ngx_http_spdy_filter_module</a></li>
<li><a href="#L61">ngx_http_spdy_filter_module_ctx</a></li>
</ul>
 <h4>Functions defined</h4>
 <ul>
<li><a href="#L1023">ngx_http_spdy_data_frame_handler</a></li>
<li><a href="#L1163">ngx_http_spdy_filter_cleanup</a></li>
<li><a href="#L839">ngx_http_spdy_filter_get_data_frame</a></li>
<li><a href="#L806">ngx_http_spdy_filter_get_shadow</a></li>
<li><a href="#L1216">ngx_http_spdy_filter_init</a></li>
<li><a href="#L922">ngx_http_spdy_filter_send</a></li>
<li><a href="#L946">ngx_http_spdy_flow_control</a></li>
<li><a href="#L1116">ngx_http_spdy_handle_frame</a></li>
<li><a href="#L1137">ngx_http_spdy_handle_stream</a></li>
<li><a href="#L96">ngx_http_spdy_header_filter</a></li>
<li><a href="#L617">ngx_http_spdy_send_chain</a></li>
<li><a href="#L995">ngx_http_spdy_syn_frame_handler</a></li>
<li><a href="#L964">ngx_http_spdy_waiting_queue</a></li>
</ul>
 <h4>Macros defined</h4>
 <ul>
<li><a href="#L17">ngx_http_spdy_nv_nsize</a></li>
<li><a href="#L18">ngx_http_spdy_nv_vsize</a></li>
<li><a href="#L24">ngx_http_spdy_nv_write_name</a></li>
<li><a href="#L21">ngx_http_spdy_nv_write_nlen</a></li>
<li><a href="#L20">ngx_http_spdy_nv_write_num</a></li>
<li><a href="#L27">ngx_http_spdy_nv_write_val</a></li>
<li><a href="#L22">ngx_http_spdy_nv_write_vlen</a></li>
</ul>
 <h4>Source code</h4>

  <code><ol><li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Copyright (C) Nginx, Inc.<br/></li>
<li></span><span class="Comment"> * Copyright (C) Valentin V. Bartenev<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;ngx_config.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;ngx_core.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;ngx_http.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;<a href="modules/perl/ngx_http_perl_module.h.html#L21" title="http/modules/perl/ngx_http_perl_module.h:21">nginx</a>.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;<a href="ngx_http_spdy_module.c.html#L131" title="http/ngx_http_spdy_module.c:131">ngx_http_spdy_module</a>.h&gt;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;zlib.h&gt;<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><a id="L17">&#x200c;</a><span class="PreProc">#define <span class="linkable">ngx_http_spdy_nv_nsize</span>(h)&nbsp; (<a href="ngx_http_spdy.h.html#L48" title="http/ngx_http_spdy.h:48">NGX_SPDY_NV_NLEN_SIZE</a> + </span><span class="Statement">sizeof</span><span class="PreProc">(h) - </span><span class="Constant">1</span><span class="PreProc">)<br/></li>
<li><a id="L18">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">ngx_http_spdy_nv_vsize</span>(h)&nbsp; (<a href="ngx_http_spdy.h.html#L49" title="http/ngx_http_spdy.h:49">NGX_SPDY_NV_VLEN_SIZE</a> + </span><span class="Statement">sizeof</span><span class="PreProc">(h) - </span><span class="Constant">1</span><span class="PreProc">)<br/></li>
<li></span><br/></li>
<li><a id="L20">&#x200c;</a><span class="PreProc">#define <span class="linkable">ngx_http_spdy_nv_write_num</span>&nbsp;&nbsp; <a href="ngx_http_spdy.h.html#L228" title="http/ngx_http_spdy.h:228">ngx_spdy_frame_write_uint32</a><br/></li>
<li><a id="L21">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">ngx_http_spdy_nv_write_nlen</span>&nbsp; <a href="ngx_http_spdy.h.html#L228" title="http/ngx_http_spdy.h:228">ngx_spdy_frame_write_uint32</a><br/></li>
<li><a id="L22">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">ngx_http_spdy_nv_write_vlen</span>&nbsp; <a href="ngx_http_spdy.h.html#L228" title="http/ngx_http_spdy.h:228">ngx_spdy_frame_write_uint32</a><br/></li>
<li></span><br/></li>
<li><a id="L24">&#x200c;</a><span class="PreProc">#define <span class="linkable">ngx_http_spdy_nv_write_name</span>(p, h)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L93" title="core/ngx_string.h:93">ngx_cpymem</a>(<a href="#L21" title="http/ngx_http_spdy_filter_module.c:21">ngx_http_spdy_nv_write_nlen</a>(p, </span><span class="Statement">sizeof</span><span class="PreProc">(h) - </span><span class="Constant">1</span><span class="PreProc">), h, </span><span class="Statement">sizeof</span><span class="PreProc">(h) - </span><span class="Constant">1</span><span class="PreProc">)<br/></li>
<li></span><br/></li>
<li><a id="L27">&#x200c;</a><span class="PreProc">#define <span class="linkable">ngx_http_spdy_nv_write_val</span>(p, h)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L93" title="core/ngx_string.h:93">ngx_cpymem</a>(<a href="#L22" title="http/ngx_http_spdy_filter_module.c:22">ngx_http_spdy_nv_write_vlen</a>(p, </span><span class="Statement">sizeof</span><span class="PreProc">(h) - </span><span class="Constant">1</span><span class="PreProc">), h, </span><span class="Statement">sizeof</span><span class="PreProc">(h) - </span><span class="Constant">1</span><span class="PreProc">)<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_core.h.html#L16" title="core/ngx_core.h:16">ngx_chain_t</a> *<a href="#L617" title="http/ngx_http_spdy_filter_module.c:617">ngx_http_spdy_send_chain</a>(<a href="../core/ngx_core.h.html#L23" title="core/ngx_core.h:23">ngx_connection_t</a> *fc,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L16" title="core/ngx_core.h:16">ngx_chain_t</a> *in, <span class="Type">off_t</span> limit);<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L111" title="core/ngx_config.h:111">ngx_inline</a> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L922" title="http/ngx_http_spdy_filter_module.c:922">ngx_http_spdy_filter_send</a>(<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L23" title="core/ngx_core.h:23">ngx_connection_t</a> *fc, <a href="ngx_http.h.html#L24" title="http/ngx_http.h:24">ngx_http_spdy_stream_t</a> *stream);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L111" title="core/ngx_config.h:111">ngx_inline</a> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L946" title="http/ngx_http_spdy_filter_module.c:946">ngx_http_spdy_flow_control</a>(<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_spdy.h.html#L71" title="http/ngx_http_spdy.h:71">ngx_http_spdy_connection_t</a> *sc, <a href="ngx_http.h.html#L24" title="http/ngx_http.h:24">ngx_http_spdy_stream_t</a> *stream);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L964" title="http/ngx_http_spdy_filter_module.c:964">ngx_http_spdy_waiting_queue</a>(<a href="ngx_http_spdy.h.html#L71" title="http/ngx_http_spdy.h:71">ngx_http_spdy_connection_t</a> *sc,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L24" title="http/ngx_http.h:24">ngx_http_spdy_stream_t</a> *stream);<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_core.h.html#L16" title="core/ngx_core.h:16">ngx_chain_t</a> *<a href="#L806" title="http/ngx_http_spdy_filter_module.c:806">ngx_http_spdy_filter_get_shadow</a>(<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L24" title="http/ngx_http.h:24">ngx_http_spdy_stream_t</a> *stream, <a href="../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a> *buf, <span class="Type">off_t</span> offset, <span class="Type">off_t</span> size);<br/></li>
<li><span class="Type">static</span> <a href="ngx_http_spdy.h.html#L72" title="http/ngx_http_spdy.h:72">ngx_http_spdy_out_frame_t</a> *<a href="#L839" title="http/ngx_http_spdy_filter_module.c:839">ngx_http_spdy_filter_get_data_frame</a>(<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L24" title="http/ngx_http.h:24">ngx_http_spdy_stream_t</a> *stream, <span class="Type">size_t</span> len, <a href="../core/ngx_core.h.html#L16" title="core/ngx_core.h:16">ngx_chain_t</a> *first,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L16" title="core/ngx_core.h:16">ngx_chain_t</a> *last);<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L995" title="http/ngx_http_spdy_filter_module.c:995">ngx_http_spdy_syn_frame_handler</a>(<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_spdy.h.html#L71" title="http/ngx_http_spdy.h:71">ngx_http_spdy_connection_t</a> *sc, <a href="ngx_http_spdy.h.html#L72" title="http/ngx_http_spdy.h:72">ngx_http_spdy_out_frame_t</a> *frame);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L1023" title="http/ngx_http_spdy_filter_module.c:1023">ngx_http_spdy_data_frame_handler</a>(<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_spdy.h.html#L71" title="http/ngx_http_spdy.h:71">ngx_http_spdy_connection_t</a> *sc, <a href="ngx_http_spdy.h.html#L72" title="http/ngx_http_spdy.h:72">ngx_http_spdy_out_frame_t</a> *frame);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L111" title="core/ngx_config.h:111">ngx_inline</a> <span class="Type">void</span> <a href="#L1116" title="http/ngx_http_spdy_filter_module.c:1116">ngx_http_spdy_handle_frame</a>(<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L24" title="http/ngx_http.h:24">ngx_http_spdy_stream_t</a> *stream, <a href="ngx_http_spdy.h.html#L72" title="http/ngx_http_spdy.h:72">ngx_http_spdy_out_frame_t</a> *frame);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L111" title="core/ngx_config.h:111">ngx_inline</a> <span class="Type">void</span> <a href="#L1137" title="http/ngx_http_spdy_filter_module.c:1137">ngx_http_spdy_handle_stream</a>(<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_spdy.h.html#L71" title="http/ngx_http_spdy.h:71">ngx_http_spdy_connection_t</a> *sc, <a href="ngx_http.h.html#L24" title="http/ngx_http.h:24">ngx_http_spdy_stream_t</a> *stream);<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L1163" title="http/ngx_http_spdy_filter_module.c:1163">ngx_http_spdy_filter_cleanup</a>(<span class="Type">void</span> *data);<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L1216" title="http/ngx_http_spdy_filter_module.c:1216">ngx_http_spdy_filter_init</a>(<a href="../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf);<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L61">&#x200c;</a><span class="Type">static</span> <a href="ngx_http_config.h.html#L36" title="http/ngx_http_config.h:36">ngx_http_module_t</a>&nbsp; <span class="linkable">ngx_http_spdy_filter_module_ctx</span> = {<br/></li>
<li>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* preconfiguration */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L1216" title="http/ngx_http_spdy_filter_module.c:1216">ngx_http_spdy_filter_init</a>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">/* postconfiguration */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* create <a href="../core/nginx.c.html#L202" title="core/nginx.c:202">main</a> configuration */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* init <a href="../core/nginx.c.html#L202" title="core/nginx.c:202">main</a> configuration */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* create server configuration */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* merge server configuration */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* create location configuration */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">/* merge location configuration */<br/></li>
<li></span>};<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L76">&#x200c;</a><a href="../core/ngx_core.h.html#L12" title="core/ngx_core.h:12">ngx_module_t</a>&nbsp; <span class="linkable">ngx_http_spdy_filter_module</span> = {<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_conf_file.h.html#L99" title="core/ngx_conf_file.h:99">NGX_MODULE_V1</a>,<br/></li>
<li>&nbsp; &nbsp; &amp;<a href="#L61" title="http/ngx_http_spdy_filter_module.c:61">ngx_http_spdy_filter_module_ctx</a>,&nbsp; &nbsp; &nbsp; <span class="Comment">/* module context */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* module directives */<br/></li>
<li></span>&nbsp; &nbsp; <a href="ngx_http_config.h.html#L39" title="http/ngx_http_config.h:39">NGX_HTTP_MODULE</a>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">/* module type */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* init master */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* init module */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* init process */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* init thread */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* exit thread */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* exit process */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* exit master */<br/></li>
<li></span>&nbsp; &nbsp; <a href="../core/ngx_conf_file.h.html#L100" title="core/ngx_conf_file.h:100">NGX_MODULE_V1_PADDING</a><br/></li>
<li>};<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L92">&#x200c;</a><span class="Type">static</span> <a href="ngx_http_core_module.h.html#L526" title="http/ngx_http_core_module.h:526">ngx_http_output_header_filter_pt</a>&nbsp; <span class="linkable">ngx_http_next_header_filter</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L96">&#x200c;</a><span class="linkable">ngx_http_spdy_header_filter</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; rc;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *p, *buf, *last;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *b;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; host;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i, j, count, port;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L16" title="core/ngx_core.h:16">ngx_chain_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *cl;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_list.h.html#L16" title="core/ngx_list.h:16">ngx_list_part_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *part, *pt;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_hash.h.html#L97" title="core/ngx_hash.h:97">ngx_table_elt_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *header, *h;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L23" title="core/ngx_core.h:23">ngx_connection_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *c;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_request.h.html#L320" title="http/ngx_http_request.h:320">ngx_http_cleanup_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *cln;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L53" title="http/ngx_http_core_module.h:53">ngx_http_core_loc_conf_t</a>&nbsp; &nbsp;&nbsp; *clcf;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L212" title="http/ngx_http_core_module.h:212">ngx_http_core_srv_conf_t</a>&nbsp; &nbsp;&nbsp; *cscf;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L24" title="http/ngx_http.h:24">ngx_http_spdy_stream_t</a>&nbsp; &nbsp; &nbsp;&nbsp; *stream;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_spdy.h.html#L72" title="http/ngx_http_spdy.h:72">ngx_http_spdy_out_frame_t</a>&nbsp; &nbsp; *frame;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_spdy.h.html#L71" title="http/ngx_http_spdy.h:71">ngx_http_spdy_connection_t</a>&nbsp;&nbsp; *sc;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">struct</span> sockaddr_in&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *sin;<br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">struct</span> sockaddr_in6&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *sin6;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; addr[<a href="../core/ngx_inet.h.html#L31" title="core/ngx_inet.h:31">NGX_SOCKADDR_STRLEN</a>];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!r-&gt;spdy_stream) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="modules/ngx_http_gunzip_filter_module.c.html#L116" title="http/modules/ngx_http_gunzip_filter_module.c:116">ngx_http_next_header_filter</a>(r);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L132" title="core/ngx_log.h:132">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;spdy header filter&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;header_sent) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;header_sent = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r != r-&gt;<a href="../core/nginx.c.html#L202" title="core/nginx.c:202">main</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c = r-&gt;connection;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;method == <a href="ngx_http_request.h.html#L29" title="http/ngx_http_request.h:29">NGX_HTTP_HEAD</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;header_only = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">switch</span> (r-&gt;headers_out.status) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="ngx_http_request.h.html#L71" title="http/ngx_http_request.h:71">NGX_HTTP_OK</a>:<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="ngx_http_request.h.html#L75" title="http/ngx_http_request.h:75">NGX_HTTP_PARTIAL_CONTENT</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="ngx_http_request.h.html#L81" title="http/ngx_http_request.h:81">NGX_HTTP_NOT_MODIFIED</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;header_only = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="ngx_http_request.h.html#L74" title="http/ngx_http_request.h:74">NGX_HTTP_NO_CONTENT</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;header_only = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_string.h.html#L44" title="core/ngx_string.h:44">ngx_str_null</a>(&amp;r-&gt;headers_out.content_type);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;headers_out.content_length = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;headers_out.content_length_n = -<span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* fall through */<br/></li>
<li></span><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;headers_out.last_modified_time = -<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;headers_out.last_modified = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; len = <a href="ngx_http_spdy.h.html#L47" title="http/ngx_http_spdy.h:47">NGX_SPDY_NV_NUM_SIZE</a><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; + <a href="#L17" title="http/ngx_http_spdy_filter_module.c:17">ngx_http_spdy_nv_nsize</a>(<span class="Constant">&quot;:version&quot;</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; + <a href="#L18" title="http/ngx_http_spdy_filter_module.c:18">ngx_http_spdy_nv_vsize</a>(<span class="Constant">&quot;HTTP/1.1&quot;</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; + <a href="#L17" title="http/ngx_http_spdy_filter_module.c:17">ngx_http_spdy_nv_nsize</a>(<span class="Constant">&quot;:status&quot;</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; + (r-&gt;headers_out.status_line.len<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ? <a href="ngx_http_spdy.h.html#L49" title="http/ngx_http_spdy.h:49">NGX_SPDY_NV_VLEN_SIZE</a> + r-&gt;headers_out.status_line.len<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; : <a href="#L18" title="http/ngx_http_spdy_filter_module.c:18">ngx_http_spdy_nv_vsize</a>(<span class="Constant">&quot;418&quot;</span>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; clcf = <a href="ngx_http_config.h.html#L58" title="http/ngx_http_config.h:58">ngx_http_get_module_loc_conf</a>(r, <a href="ngx_http_core_module.c.html#L811" title="http/ngx_http_core_module.c:811">ngx_http_core_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;headers_out.server == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; len += <a href="#L17" title="http/ngx_http_spdy_filter_module.c:17">ngx_http_spdy_nv_nsize</a>(<span class="Constant">&quot;server&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; len += clcf-&gt;server_tokens ? <a href="#L18" title="http/ngx_http_spdy_filter_module.c:18">ngx_http_spdy_nv_vsize</a>(<a href="../core/nginx.h.html#L14" title="core/nginx.h:14">NGINX_VER</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; : <a href="#L18" title="http/ngx_http_spdy_filter_module.c:18">ngx_http_spdy_nv_vsize</a>(<span class="Constant">&quot;<a href="modules/perl/ngx_http_perl_module.h.html#L21" title="http/modules/perl/ngx_http_perl_module.h:21">nginx</a>&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;headers_out.date == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; len += <a href="#L17" title="http/ngx_http_spdy_filter_module.c:17">ngx_http_spdy_nv_nsize</a>(<span class="Constant">&quot;date&quot;</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; + <a href="#L18" title="http/ngx_http_spdy_filter_module.c:18">ngx_http_spdy_nv_vsize</a>(<span class="Constant">&quot;Wed, 31 Dec 1986 10:00:00 GMT&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;headers_out.content_type.len) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; len += <a href="#L17" title="http/ngx_http_spdy_filter_module.c:17">ngx_http_spdy_nv_nsize</a>(<span class="Constant">&quot;content-type&quot;</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; + <a href="ngx_http_spdy.h.html#L49" title="http/ngx_http_spdy.h:49">NGX_SPDY_NV_VLEN_SIZE</a> + r-&gt;headers_out.content_type.len;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;headers_out.content_type_len == r-&gt;headers_out.content_type.len<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; r-&gt;headers_out.charset.len)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len += <span class="Statement">sizeof</span>(<span class="Constant">&quot;; charset=&quot;</span>) - <span class="Constant">1</span> + r-&gt;headers_out.charset.len;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;headers_out.content_length == <span class="Constant">NULL<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; r-&gt;headers_out.content_length_n &gt;= <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; len += <a href="#L17" title="http/ngx_http_spdy_filter_module.c:17">ngx_http_spdy_nv_nsize</a>(<span class="Constant">&quot;content-length&quot;</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; + <a href="ngx_http_spdy.h.html#L49" title="http/ngx_http_spdy.h:49">NGX_SPDY_NV_VLEN_SIZE</a> + NGX_OFF_T_LEN;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;headers_out.last_modified == <span class="Constant">NULL<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; r-&gt;headers_out.last_modified_time != -<span class="Constant">1</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; len += <a href="#L17" title="http/ngx_http_spdy_filter_module.c:17">ngx_http_spdy_nv_nsize</a>(<span class="Constant">&quot;last-modified&quot;</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; + <a href="#L18" title="http/ngx_http_spdy_filter_module.c:18">ngx_http_spdy_nv_vsize</a>(<span class="Constant">&quot;Wed, 31 Dec 1986 10:00:00 GMT&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;headers_out.location<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; r-&gt;headers_out.location-&gt;value.len<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; r-&gt;headers_out.location-&gt;value.data[<span class="Constant">0</span>] == <span class="Constant">'/'</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;headers_out.location-&gt;hash = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (clcf-&gt;server_name_in_redirect) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cscf = <a href="ngx_http_config.h.html#L57" title="http/ngx_http_config.h:57">ngx_http_get_module_srv_conf</a>(r, <a href="ngx_http_core_module.c.html#L811" title="http/ngx_http_core_module.c:811">ngx_http_core_module</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; host = cscf-&gt;server_name;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (r-&gt;headers_in.server.len) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; host = r-&gt;headers_in.server;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; host.len = <a href="../core/ngx_inet.h.html#L31" title="core/ngx_inet.h:31">NGX_SOCKADDR_STRLEN</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; host.data = addr;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_connection.c.html#L1064" title="core/ngx_connection.c:1064">ngx_connection_local_sockaddr</a>(c, &amp;host, <span class="Constant">0</span>) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (c-&gt;local_sockaddr-&gt;sa_family) {<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> AF_INET6:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sin6 = (<span class="Type">struct</span> sockaddr_in6 *) c-&gt;local_sockaddr;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; port = ntohs(sin6-&gt;sin6_port);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><span class="PreProc">#if (NGX_HAVE_UNIX_DOMAIN)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> AF_UNIX:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; port = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><span class="cUserCont">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:</span> <span class="Comment">/* AF_INET */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sin = (<span class="Type">struct</span> sockaddr_in *) c-&gt;local_sockaddr;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; port = ntohs(sin-&gt;sin_port);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; len += <a href="#L17" title="http/ngx_http_spdy_filter_module.c:17">ngx_http_spdy_nv_nsize</a>(<span class="Constant">&quot;location&quot;</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; + <a href="#L18" title="http/ngx_http_spdy_filter_module.c:18">ngx_http_spdy_nv_vsize</a>(<span class="Constant">&quot;https://&quot;</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; + host.len<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; + r-&gt;headers_out.location-&gt;value.len;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (clcf-&gt;port_in_redirect) {<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HTTP_SSL)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;ssl)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; port = (port == <span class="Constant">443</span>) ? <span class="Constant">0</span> : port;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; port = (port == <span class="Constant">80</span>) ? <span class="Constant">0</span> : port;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; port = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (port) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len += <span class="Statement">sizeof</span>(<span class="Constant">&quot;:65535&quot;</span>) - <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_string.h.html#L44" title="core/ngx_string.h:44">ngx_str_null</a>(&amp;host);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; port = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; part = &amp;r-&gt;headers_out.headers.part;<br/></li>
<li>&nbsp; &nbsp; header = part-&gt;elts;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; <span class="Comment">/* void */</span>; i++) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (i &gt;= part-&gt;nelts) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (part-&gt;next == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; part = part-&gt;next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; header = part-&gt;elts;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (header[i].hash == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; len += <a href="ngx_http_spdy.h.html#L48" title="http/ngx_http_spdy.h:48">NGX_SPDY_NV_NLEN_SIZE</a> + header[i].key.len<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; + <a href="ngx_http_spdy.h.html#L49" title="http/ngx_http_spdy.h:49">NGX_SPDY_NV_VLEN_SIZE</a>&nbsp; + header[i].value.len;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; buf = <a href="../os/unix/ngx_alloc.c.html#L18" title="os/unix/ngx_alloc.c:18">ngx_alloc</a>(len, r-&gt;pool-&gt;log);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (buf == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; last = buf + <a href="ngx_http_spdy.h.html#L47" title="http/ngx_http_spdy.h:47">NGX_SPDY_NV_NUM_SIZE</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; last = <a href="#L24" title="http/ngx_http_spdy_filter_module.c:24">ngx_http_spdy_nv_write_name</a>(last, <span class="Constant">&quot;:version&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; last = <a href="#L27" title="http/ngx_http_spdy_filter_module.c:27">ngx_http_spdy_nv_write_val</a>(last, <span class="Constant">&quot;HTTP/1.1&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; last = <a href="#L24" title="http/ngx_http_spdy_filter_module.c:24">ngx_http_spdy_nv_write_name</a>(last, <span class="Constant">&quot;:status&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;headers_out.status_line.len) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; last = <a href="#L22" title="http/ngx_http_spdy_filter_module.c:22">ngx_http_spdy_nv_write_vlen</a>(last,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; r-&gt;headers_out.status_line.len);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; last = <a href="../core/ngx_string.h.html#L93" title="core/ngx_string.h:93">ngx_cpymem</a>(last, r-&gt;headers_out.status_line.data,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;headers_out.status_line.len);<br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; last = <a href="#L22" title="http/ngx_http_spdy_filter_module.c:22">ngx_http_spdy_nv_write_vlen</a>(last, <span class="Constant">3</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; last = <a href="../core/ngx_string.c.html#L105" title="core/ngx_string.c:105">ngx_sprintf</a>(last, <span class="Constant">&quot;</span><span class="Special">%03u</span><span class="Constant">i&quot;</span>, r-&gt;headers_out.status);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; count = <span class="Constant">2</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;headers_out.server == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; last = <a href="#L24" title="http/ngx_http_spdy_filter_module.c:24">ngx_http_spdy_nv_write_name</a>(last, <span class="Constant">&quot;server&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; last = clcf-&gt;server_tokens<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ? <a href="#L27" title="http/ngx_http_spdy_filter_module.c:27">ngx_http_spdy_nv_write_val</a>(last, <a href="../core/nginx.h.html#L14" title="core/nginx.h:14">NGINX_VER</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; : <a href="#L27" title="http/ngx_http_spdy_filter_module.c:27">ngx_http_spdy_nv_write_val</a>(last, <span class="Constant">&quot;<a href="modules/perl/ngx_http_perl_module.h.html#L21" title="http/modules/perl/ngx_http_perl_module.h:21">nginx</a>&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; count++;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;headers_out.date == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; last = <a href="#L24" title="http/ngx_http_spdy_filter_module.c:24">ngx_http_spdy_nv_write_name</a>(last, <span class="Constant">&quot;date&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; last = <a href="#L22" title="http/ngx_http_spdy_filter_module.c:22">ngx_http_spdy_nv_write_vlen</a>(last, <a href="../core/ngx_times.c.html#L29" title="core/ngx_times.c:29">ngx_cached_http_time</a>.len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; last = <a href="../core/ngx_string.h.html#L93" title="core/ngx_string.h:93">ngx_cpymem</a>(last, <a href="../core/ngx_times.c.html#L29" title="core/ngx_times.c:29">ngx_cached_http_time</a>.data,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_times.c.html#L29" title="core/ngx_times.c:29">ngx_cached_http_time</a>.len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; count++;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;headers_out.content_type.len) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; last = <a href="#L24" title="http/ngx_http_spdy_filter_module.c:24">ngx_http_spdy_nv_write_name</a>(last, <span class="Constant">&quot;content-type&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p = last + <a href="ngx_http_spdy.h.html#L49" title="http/ngx_http_spdy.h:49">NGX_SPDY_NV_VLEN_SIZE</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; last = <a href="../core/ngx_string.h.html#L93" title="core/ngx_string.h:93">ngx_cpymem</a>(p, r-&gt;headers_out.content_type.data,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;headers_out.content_type.len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;headers_out.content_type_len == r-&gt;headers_out.content_type.len<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; r-&gt;headers_out.charset.len)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; last = <a href="../core/ngx_string.h.html#L93" title="core/ngx_string.h:93">ngx_cpymem</a>(last, <span class="Constant">&quot;; charset=&quot;</span>, <span class="Statement">sizeof</span>(<span class="Constant">&quot;; charset=&quot;</span>) - <span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; last = <a href="../core/ngx_string.h.html#L93" title="core/ngx_string.h:93">ngx_cpymem</a>(last, r-&gt;headers_out.charset.data,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;headers_out.charset.len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* update r-&gt;headers_out.content_type for possible logging */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;headers_out.content_type.len = last - p;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;headers_out.content_type.data = p;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; (<span class="Type">void</span>) <a href="#L22" title="http/ngx_http_spdy_filter_module.c:22">ngx_http_spdy_nv_write_vlen</a>(p - <a href="ngx_http_spdy.h.html#L49" title="http/ngx_http_spdy.h:49">NGX_SPDY_NV_VLEN_SIZE</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; r-&gt;headers_out.content_type.len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; count++;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;headers_out.content_length == <span class="Constant">NULL<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; r-&gt;headers_out.content_length_n &gt;= <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; last = <a href="#L24" title="http/ngx_http_spdy_filter_module.c:24">ngx_http_spdy_nv_write_name</a>(last, <span class="Constant">&quot;content-length&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p = last + <a href="ngx_http_spdy.h.html#L49" title="http/ngx_http_spdy.h:49">NGX_SPDY_NV_VLEN_SIZE</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; last = <a href="../core/ngx_string.c.html#L105" title="core/ngx_string.c:105">ngx_sprintf</a>(p, <span class="Constant">&quot;</span><span class="Special">%O</span><span class="Constant">&quot;</span>, r-&gt;headers_out.content_length_n);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; (<span class="Type">void</span>) <a href="#L22" title="http/ngx_http_spdy_filter_module.c:22">ngx_http_spdy_nv_write_vlen</a>(p - <a href="ngx_http_spdy.h.html#L49" title="http/ngx_http_spdy.h:49">NGX_SPDY_NV_VLEN_SIZE</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; last - p);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; count++;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;headers_out.last_modified == <span class="Constant">NULL<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; r-&gt;headers_out.last_modified_time != -<span class="Constant">1</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; last = <a href="#L24" title="http/ngx_http_spdy_filter_module.c:24">ngx_http_spdy_nv_write_name</a>(last, <span class="Constant">&quot;last-modified&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p = last + <a href="ngx_http_spdy.h.html#L49" title="http/ngx_http_spdy.h:49">NGX_SPDY_NV_VLEN_SIZE</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; last = <a href="../core/ngx_times.c.html#L255" title="core/ngx_times.c:255">ngx_http_time</a>(p, r-&gt;headers_out.last_modified_time);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; (<span class="Type">void</span>) <a href="#L22" title="http/ngx_http_spdy_filter_module.c:22">ngx_http_spdy_nv_write_vlen</a>(p - <a href="ngx_http_spdy.h.html#L49" title="http/ngx_http_spdy.h:49">NGX_SPDY_NV_VLEN_SIZE</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; last - p);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; count++;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (host.data) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; last = <a href="#L24" title="http/ngx_http_spdy_filter_module.c:24">ngx_http_spdy_nv_write_name</a>(last, <span class="Constant">&quot;location&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p = last + <a href="ngx_http_spdy.h.html#L49" title="http/ngx_http_spdy.h:49">NGX_SPDY_NV_VLEN_SIZE</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; last = <a href="../core/ngx_string.h.html#L93" title="core/ngx_string.h:93">ngx_cpymem</a>(p, <span class="Constant">&quot;http&quot;</span>, <span class="Statement">sizeof</span>(<span class="Constant">&quot;http&quot;</span>) - <span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HTTP_SSL)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;ssl) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *last++ =<span class="Constant">'s'</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *last++ = <span class="Constant">':'</span>; *last++ = <span class="Constant">'/'</span>; *last++ = <span class="Constant">'/'</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; last = <a href="../core/ngx_string.h.html#L93" title="core/ngx_string.h:93">ngx_cpymem</a>(last, host.data, host.len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (port) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; last = <a href="../core/ngx_string.c.html#L105" title="core/ngx_string.c:105">ngx_sprintf</a>(last, <span class="Constant">&quot;:</span><span class="Special">%u</span><span class="Constant">i&quot;</span>, port);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; last = <a href="../core/ngx_string.h.html#L93" title="core/ngx_string.h:93">ngx_cpymem</a>(last, r-&gt;headers_out.location-&gt;value.data,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;headers_out.location-&gt;value.len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* update r-&gt;headers_out.location-&gt;value for possible logging */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;headers_out.location-&gt;value.len = last - p;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;headers_out.location-&gt;value.data = p;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_string.h.html#L42" title="core/ngx_string.h:42">ngx_str_set</a>(&amp;r-&gt;headers_out.location-&gt;key, <span class="Constant">&quot;location&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; (<span class="Type">void</span>) <a href="#L22" title="http/ngx_http_spdy_filter_module.c:22">ngx_http_spdy_nv_write_vlen</a>(p - <a href="ngx_http_spdy.h.html#L49" title="http/ngx_http_spdy.h:49">NGX_SPDY_NV_VLEN_SIZE</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; r-&gt;headers_out.location-&gt;value.len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; count++;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; part = &amp;r-&gt;headers_out.headers.part;<br/></li>
<li>&nbsp; &nbsp; header = part-&gt;elts;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; <span class="Comment">/* void */</span>; i++) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (i &gt;= part-&gt;nelts) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (part-&gt;next == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; part = part-&gt;next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; header = part-&gt;elts;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (header[i].hash == <span class="Constant">0</span> || header[i].hash == <span class="Constant">2</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; last = <a href="#L21" title="http/ngx_http_spdy_filter_module.c:21">ngx_http_spdy_nv_write_nlen</a>(last, header[i].key.len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_string.c.html#L21" title="core/ngx_string.c:21">ngx_strlow</a>(last, header[i].key.data, header[i].key.len);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; last += header[i].key.len;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p = last + <a href="ngx_http_spdy.h.html#L49" title="http/ngx_http_spdy.h:49">NGX_SPDY_NV_VLEN_SIZE</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; last = <a href="../core/ngx_string.h.html#L93" title="core/ngx_string.h:93">ngx_cpymem</a>(p, header[i].value.data, header[i].value.len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; pt = part;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; h = header;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (j = i + <span class="Constant">1</span>; <span class="Comment">/* void */</span>; j++) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (j &gt;= pt-&gt;nelts) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (pt-&gt;next == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pt = pt-&gt;next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; h = pt-&gt;elts;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; j = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (h[j].hash == <span class="Constant">0</span> || h[j].hash == <span class="Constant">2<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || h[j].key.len != header[i].key.len<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || <a href="../core/ngx_string.c.html#L593" title="core/ngx_string.c:593">ngx_strncasecmp</a>(header[i].key.data, h[j].key.data,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; header[i].key.len))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (h[j].value.len) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (last != p) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *last++ = <span class="Special">'\0'</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; last = <a href="../core/ngx_string.h.html#L93" title="core/ngx_string.h:93">ngx_cpymem</a>(last, h[j].value.data, h[j].value.len);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; h[j].hash = <span class="Constant">2</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; (<span class="Type">void</span>) <a href="#L22" title="http/ngx_http_spdy_filter_module.c:22">ngx_http_spdy_nv_write_vlen</a>(p - <a href="ngx_http_spdy.h.html#L49" title="http/ngx_http_spdy.h:49">NGX_SPDY_NV_VLEN_SIZE</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; last - p);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; count++;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; (<span class="Type">void</span>) <a href="#L20" title="http/ngx_http_spdy_filter_module.c:20">ngx_http_spdy_nv_write_num</a>(buf, count);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; stream = r-&gt;spdy_stream;<br/></li>
<li>&nbsp; &nbsp; sc = stream-&gt;connection;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; len = last - buf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; b = <a href="../core/ngx_buf.c.html#L13" title="core/ngx_buf.c:13">ngx_create_temp_buf</a>(r-&gt;pool, <a href="ngx_http_spdy.h.html#L36" title="http/ngx_http_spdy.h:36">NGX_SPDY_FRAME_HEADER_SIZE</a><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; + <a href="ngx_http_spdy.h.html#L42" title="http/ngx_http_spdy.h:42">NGX_SPDY_SYN_REPLY_SIZE</a><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; + deflateBound(&amp;sc-&gt;zstream_out, len));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (b == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../os/unix/ngx_alloc.h.html#L19" title="os/unix/ngx_alloc.h:19">ngx_free</a>(buf);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; b-&gt;last += <a href="ngx_http_spdy.h.html#L36" title="http/ngx_http_spdy.h:36">NGX_SPDY_FRAME_HEADER_SIZE</a> + <a href="ngx_http_spdy.h.html#L42" title="http/ngx_http_spdy.h:42">NGX_SPDY_SYN_REPLY_SIZE</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; sc-&gt;zstream_out.next_in = buf;<br/></li>
<li>&nbsp; &nbsp; sc-&gt;zstream_out.avail_in = len;<br/></li>
<li>&nbsp; &nbsp; sc-&gt;zstream_out.next_out = b-&gt;last;<br/></li>
<li>&nbsp; &nbsp; sc-&gt;zstream_out.avail_out = b-&gt;end - b-&gt;last;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rc = deflate(&amp;sc-&gt;zstream_out, Z_SYNC_FLUSH);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../os/unix/ngx_alloc.h.html#L19" title="os/unix/ngx_alloc.h:19">ngx_free</a>(buf);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc != Z_OK) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L18" title="core/ngx_log.h:18">NGX_LOG_ALERT</a>, c-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;deflate() failed: </span><span class="Special">%d</span><span class="Constant">&quot;</span>, rc);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L147" title="core/ngx_log.h:147">ngx_log_debug5</a>(<a href="../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;spdy deflate out: ni:</span><span class="Special">%p</span><span class="Constant"> no:</span><span class="Special">%p</span><span class="Constant"> ai:</span><span class="Special">%u</span><span class="Constant">d ao:</span><span class="Special">%u</span><span class="Constant">d rc:</span><span class="Special">%d</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; sc-&gt;zstream_out.next_in, sc-&gt;zstream_out.next_out,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; sc-&gt;zstream_out.avail_in, sc-&gt;zstream_out.avail_out,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; rc);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; b-&gt;last = sc-&gt;zstream_out.next_out;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p = b-&gt;pos;<br/></li>
<li>&nbsp; &nbsp; p = <a href="ngx_http_spdy.h.html#L250" title="http/ngx_http_spdy.h:250">ngx_spdy_frame_write_head</a>(p, <a href="ngx_http_spdy.h.html#L28" title="http/ngx_http_spdy.h:28">NGX_SPDY_SYN_REPLY</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; len = b-&gt;last - b-&gt;pos;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;header_size = len;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; len -= <a href="ngx_http_spdy.h.html#L36" title="http/ngx_http_spdy.h:36">NGX_SPDY_FRAME_HEADER_SIZE</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;header_only) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; b-&gt;last_buf = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p = <a href="ngx_http_spdy.h.html#L253" title="http/ngx_http_spdy.h:253">ngx_spdy_frame_write_flags_and_len</a>(p, <a href="ngx_http_spdy.h.html#L60" title="http/ngx_http_spdy.h:60">NGX_SPDY_FLAG_FIN</a>, len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p = <a href="ngx_http_spdy.h.html#L253" title="http/ngx_http_spdy.h:253">ngx_spdy_frame_write_flags_and_len</a>(p, <span class="Constant">0</span>, len);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; (<span class="Type">void</span>) <a href="ngx_http_spdy.h.html#L258" title="http/ngx_http_spdy.h:258">ngx_spdy_frame_write_sid</a>(p, stream-&gt;id);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cl = <a href="../core/ngx_buf.c.html#L48" title="core/ngx_buf.c:48">ngx_alloc_chain_link</a>(r-&gt;pool);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cl == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cl-&gt;buf = b;<br/></li>
<li>&nbsp; &nbsp; cl-&gt;next = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; frame = <a href="../core/ngx_palloc.c.html#L120" title="core/ngx_palloc.c:120">ngx_palloc</a>(r-&gt;pool, <span class="Statement">sizeof</span>(<a href="ngx_http_spdy.h.html#L72" title="http/ngx_http_spdy.h:72">ngx_http_spdy_out_frame_t</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (frame == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; frame-&gt;first = cl;<br/></li>
<li>&nbsp; &nbsp; frame-&gt;last = cl;<br/></li>
<li>&nbsp; &nbsp; frame-&gt;handler = <a href="#L995" title="http/ngx_http_spdy_filter_module.c:995">ngx_http_spdy_syn_frame_handler</a>;<br/></li>
<li>&nbsp; &nbsp; frame-&gt;stream = stream;<br/></li>
<li>&nbsp; &nbsp; frame-&gt;length = len;<br/></li>
<li>&nbsp; &nbsp; frame-&gt;priority = stream-&gt;priority;<br/></li>
<li>&nbsp; &nbsp; frame-&gt;blocked = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; frame-&gt;fin = r-&gt;header_only;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L141" title="core/ngx_log.h:141">ngx_log_debug3</a>(<a href="../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, stream-&gt;request-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;spdy:</span><span class="Special">%u</span><span class="Constant">i create SYN_REPLY frame </span><span class="Special">%p</span><span class="Constant">: len:</span><span class="Special">%u</span><span class="Constant">z&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; stream-&gt;id, frame, frame-&gt;length);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_spdy.h.html#L191" title="http/ngx_http_spdy.h:191">ngx_http_spdy_queue_blocked_frame</a>(sc, frame);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cln = <a href="ngx_http_core_module.c.html#L2729" title="http/ngx_http_core_module.c:2729">ngx_http_cleanup_add</a>(r, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cln == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cln-&gt;handler = <a href="#L1163" title="http/ngx_http_spdy_filter_module.c:1163">ngx_http_spdy_filter_cleanup</a>;<br/></li>
<li>&nbsp; &nbsp; cln-&gt;data = stream;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; stream-&gt;queued = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c-&gt;send_chain = <a href="#L617" title="http/ngx_http_spdy_filter_module.c:617">ngx_http_spdy_send_chain</a>;<br/></li>
<li>&nbsp; &nbsp; c-&gt;need_last_buf = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L922" title="http/ngx_http_spdy_filter_module.c:922">ngx_http_spdy_filter_send</a>(c, stream);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_core.h.html#L16" title="core/ngx_core.h:16">ngx_chain_t</a> *<br/></li>
<li><a id="L617">&#x200c;</a><span class="linkable">ngx_http_spdy_send_chain</span>(<a href="../core/ngx_core.h.html#L23" title="core/ngx_core.h:23">ngx_connection_t</a> *fc, <a href="../core/ngx_core.h.html#L16" title="core/ngx_core.h:16">ngx_chain_t</a> *in, <span class="Type">off_t</span> limit)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">off_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; size, offset;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; rest, frame_size;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L16" title="core/ngx_core.h:16">ngx_chain_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *cl, *out, **ln;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *r;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L24" title="http/ngx_http.h:24">ngx_http_spdy_stream_t</a>&nbsp; &nbsp; &nbsp; *stream;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_spdy_module.h.html#L35" title="http/ngx_http_spdy_module.h:35">ngx_http_spdy_loc_conf_t</a>&nbsp; &nbsp; *slcf;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_spdy.h.html#L72" title="http/ngx_http_spdy.h:72">ngx_http_spdy_out_frame_t</a>&nbsp;&nbsp; *frame;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_spdy.h.html#L71" title="http/ngx_http_spdy.h:71">ngx_http_spdy_connection_t</a>&nbsp; *sc;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r = fc-&gt;data;<br/></li>
<li>&nbsp; &nbsp; stream = r-&gt;spdy_stream;<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_SUPPRESS_WARN)<br/></li>
<li></span>&nbsp; &nbsp; size = <span class="Constant">0</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (in) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; size = <a href="../core/ngx_buf.h.html#L134" title="core/ngx_buf.h:134">ngx_buf_size</a>(in-&gt;buf);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (size || in-&gt;buf-&gt;last_buf) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; in = in-&gt;next;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (in == <span class="Constant">NULL</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (stream-&gt;queued) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fc-&gt;write-&gt;delayed = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fc-&gt;buffered &amp;= ~<a href="../core/ngx_connection.h.html#L115" title="core/ngx_connection.h:115">NGX_SPDY_BUFFERED</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; sc = stream-&gt;connection;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (size &amp;&amp; <a href="#L946" title="http/ngx_http_spdy_filter_module.c:946">ngx_http_spdy_flow_control</a>(sc, stream) == <a href="../core/ngx_core.h.html#L34" title="core/ngx_core.h:34">NGX_DECLINED</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; fc-&gt;write-&gt;delayed = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> in;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (limit == <span class="Constant">0</span> || limit &gt; (<span class="Type">off_t</span>) sc-&gt;send_window) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; limit = sc-&gt;send_window;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (limit &gt; stream-&gt;send_window) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; limit = (stream-&gt;send_window &gt; <span class="Constant">0</span>) ? stream-&gt;send_window : <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (in-&gt;buf-&gt;tag == (<a href="../core/ngx_buf.h.html#L16" title="core/ngx_buf.h:16">ngx_buf_tag_t</a>) &amp;<a href="#L806" title="http/ngx_http_spdy_filter_module.c:806">ngx_http_spdy_filter_get_shadow</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cl = <a href="../core/ngx_buf.c.html#L48" title="core/ngx_buf.c:48">ngx_alloc_chain_link</a>(r-&gt;pool);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (cl == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_buf.h.html#L120" title="core/ngx_buf.h:120">NGX_CHAIN_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cl-&gt;buf = in-&gt;buf;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; in-&gt;buf = cl-&gt;buf-&gt;shadow;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; offset = <a href="../core/ngx_buf.h.html#L123" title="core/ngx_buf.h:123">ngx_buf_in_memory</a>(in-&gt;buf)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ? (cl-&gt;buf-&gt;pos - in-&gt;buf-&gt;pos)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; : (cl-&gt;buf-&gt;file_pos - in-&gt;buf-&gt;file_pos);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cl-&gt;next = stream-&gt;free_bufs;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; stream-&gt;free_bufs = cl;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; offset = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_SUPPRESS_WARN)<br/></li>
<li></span>&nbsp; &nbsp; cl = <span class="Constant">NULL</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; slcf = <a href="ngx_http_config.h.html#L58" title="http/ngx_http_config.h:58">ngx_http_get_module_loc_conf</a>(r, <a href="ngx_http_spdy_module.c.html#L131" title="http/ngx_http_spdy_module.c:131">ngx_http_spdy_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; frame_size = (limit &lt;= (<span class="Type">off_t</span>) slcf-&gt;chunk_size) ? (<span class="Type">size_t</span>) limit<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; : slcf-&gt;chunk_size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> ( ;; ) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ln = &amp;out;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rest = frame_size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">while</span> ((<span class="Type">off_t</span>) rest &gt;= size) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (offset) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cl = <a href="#L806" title="http/ngx_http_spdy_filter_module.c:806">ngx_http_spdy_filter_get_shadow</a>(stream, in-&gt;buf,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; offset, size);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (cl == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_buf.h.html#L120" title="core/ngx_buf.h:120">NGX_CHAIN_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; offset = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cl = <a href="../core/ngx_buf.c.html#L48" title="core/ngx_buf.c:48">ngx_alloc_chain_link</a>(r-&gt;pool);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (cl == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_buf.h.html#L120" title="core/ngx_buf.h:120">NGX_CHAIN_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cl-&gt;buf = in-&gt;buf;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *ln = cl;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ln = &amp;cl-&gt;next;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rest -= (<span class="Type">size_t</span>) size;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; in = in-&gt;next;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (in == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; frame_size -= rest;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rest = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; size = <a href="../core/ngx_buf.h.html#L134" title="core/ngx_buf.h:134">ngx_buf_size</a>(in-&gt;buf);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rest) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cl = <a href="#L806" title="http/ngx_http_spdy_filter_module.c:806">ngx_http_spdy_filter_get_shadow</a>(stream, in-&gt;buf,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; offset, rest);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (cl == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_buf.h.html#L120" title="core/ngx_buf.h:120">NGX_CHAIN_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cl-&gt;buf-&gt;flush = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cl-&gt;buf-&gt;last_buf = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *ln = cl;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; offset += rest;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; size -= rest;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; frame = <a href="#L839" title="http/ngx_http_spdy_filter_module.c:839">ngx_http_spdy_filter_get_data_frame</a>(stream, frame_size,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; out, cl);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (frame == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_buf.h.html#L120" title="core/ngx_buf.h:120">NGX_CHAIN_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_http_spdy.h.html#L170" title="http/ngx_http_spdy.h:170">ngx_http_spdy_queue_frame</a>(sc, frame);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; sc-&gt;send_window -= frame_size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; stream-&gt;send_window -= frame_size;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; stream-&gt;queued++;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (in == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; limit -= frame_size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (limit == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (limit &lt; (<span class="Type">off_t</span>) slcf-&gt;chunk_size) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; frame_size = (<span class="Type">size_t</span>) limit;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (offset) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cl = <a href="#L806" title="http/ngx_http_spdy_filter_module.c:806">ngx_http_spdy_filter_get_shadow</a>(stream, in-&gt;buf, offset, size);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (cl == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_buf.h.html#L120" title="core/ngx_buf.h:120">NGX_CHAIN_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; in-&gt;buf = cl-&gt;buf;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_buf.h.html#L146" title="core/ngx_buf.h:146">ngx_free_chain</a>(r-&gt;pool, cl);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L922" title="http/ngx_http_spdy_filter_module.c:922">ngx_http_spdy_filter_send</a>(fc, stream) == <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_buf.h.html#L120" title="core/ngx_buf.h:120">NGX_CHAIN_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (in &amp;&amp; <a href="#L946" title="http/ngx_http_spdy_filter_module.c:946">ngx_http_spdy_flow_control</a>(sc, stream) == <a href="../core/ngx_core.h.html#L34" title="core/ngx_core.h:34">NGX_DECLINED</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; fc-&gt;write-&gt;delayed = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> in;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_core.h.html#L16" title="core/ngx_core.h:16">ngx_chain_t</a> *<br/></li>
<li><a id="L806">&#x200c;</a><span class="linkable">ngx_http_spdy_filter_get_shadow</span>(<a href="ngx_http.h.html#L24" title="http/ngx_http.h:24">ngx_http_spdy_stream_t</a> *stream, <a href="../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a> *buf,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">off_t</span> offset, <span class="Type">off_t</span> size)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; *chunk;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L16" title="core/ngx_core.h:16">ngx_chain_t</a>&nbsp; *cl;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cl = <a href="../core/ngx_buf.c.html#L156" title="core/ngx_buf.c:156">ngx_chain_get_free_buf</a>(stream-&gt;request-&gt;pool, &amp;stream-&gt;free_bufs);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cl == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; chunk = cl-&gt;buf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.c.html#L1947" title="core/ngx_string.c:1947">ngx_memcpy</a>(chunk, buf, <span class="Statement">sizeof</span>(<a href="../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; chunk-&gt;tag = (<a href="../core/ngx_buf.h.html#L16" title="core/ngx_buf.h:16">ngx_buf_tag_t</a>) &amp;<a href="#L806" title="http/ngx_http_spdy_filter_module.c:806">ngx_http_spdy_filter_get_shadow</a>;<br/></li>
<li>&nbsp; &nbsp; chunk-&gt;shadow = buf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_buf.h.html#L123" title="core/ngx_buf.h:123">ngx_buf_in_memory</a>(chunk)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; chunk-&gt;pos += offset;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; chunk-&gt;last = chunk-&gt;pos + size;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (chunk-&gt;in_file) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; chunk-&gt;file_pos += offset;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; chunk-&gt;file_last = chunk-&gt;file_pos + size;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> cl;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="ngx_http_spdy.h.html#L72" title="http/ngx_http_spdy.h:72">ngx_http_spdy_out_frame_t</a> *<br/></li>
<li><a id="L839">&#x200c;</a><span class="linkable">ngx_http_spdy_filter_get_data_frame</span>(<a href="ngx_http.h.html#L24" title="http/ngx_http.h:24">ngx_http_spdy_stream_t</a> *stream,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span> len, <a href="../core/ngx_core.h.html#L16" title="core/ngx_core.h:16">ngx_chain_t</a> *first, <a href="../core/ngx_core.h.html#L16" title="core/ngx_core.h:16">ngx_chain_t</a> *last)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *p;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *buf;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; flags;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L16" title="core/ngx_core.h:16">ngx_chain_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *cl;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_spdy.h.html#L72" title="http/ngx_http_spdy.h:72">ngx_http_spdy_out_frame_t</a>&nbsp; *frame;<br/></li>
<li><br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; frame = stream-&gt;free_frames;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (frame) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; stream-&gt;free_frames = frame-&gt;next;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; frame = <a href="../core/ngx_palloc.c.html#L120" title="core/ngx_palloc.c:120">ngx_palloc</a>(stream-&gt;request-&gt;pool,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Statement">sizeof</span>(<a href="ngx_http_spdy.h.html#L72" title="http/ngx_http_spdy.h:72">ngx_http_spdy_out_frame_t</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (frame == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; flags = last-&gt;buf-&gt;last_buf ? <a href="ngx_http_spdy.h.html#L60" title="http/ngx_http_spdy.h:60">NGX_SPDY_FLAG_FIN</a> : <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L144" title="core/ngx_log.h:144">ngx_log_debug4</a>(<a href="../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, stream-&gt;request-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;spdy:</span><span class="Special">%u</span><span class="Constant">i create DATA frame </span><span class="Special">%p</span><span class="Constant">: len:</span><span class="Special">%u</span><span class="Constant">z flags:</span><span class="Special">%u</span><span class="Constant">i&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; stream-&gt;id, frame, len, flags);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cl = <a href="../core/ngx_buf.c.html#L156" title="core/ngx_buf.c:156">ngx_chain_get_free_buf</a>(stream-&gt;request-&gt;pool,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;stream-&gt;free_data_headers);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cl == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; buf = cl-&gt;buf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (buf-&gt;start) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p = buf-&gt;start;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; buf-&gt;pos = p;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p += <a href="ngx_http_spdy.h.html#L38" title="http/ngx_http_spdy.h:38">NGX_SPDY_SID_SIZE</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; (<span class="Type">void</span>) <a href="ngx_http_spdy.h.html#L253" title="http/ngx_http_spdy.h:253">ngx_spdy_frame_write_flags_and_len</a>(p, flags, len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p = <a href="../core/ngx_palloc.c.html#L120" title="core/ngx_palloc.c:120">ngx_palloc</a>(stream-&gt;request-&gt;pool, <a href="ngx_http_spdy.h.html#L36" title="http/ngx_http_spdy.h:36">NGX_SPDY_FRAME_HEADER_SIZE</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (p == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; buf-&gt;pos = p;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; buf-&gt;start = p;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p = <a href="ngx_http_spdy.h.html#L258" title="http/ngx_http_spdy.h:258">ngx_spdy_frame_write_sid</a>(p, stream-&gt;id);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p = <a href="ngx_http_spdy.h.html#L253" title="http/ngx_http_spdy.h:253">ngx_spdy_frame_write_flags_and_len</a>(p, flags, len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; buf-&gt;last = p;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; buf-&gt;end = p;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; buf-&gt;tag = (<a href="../core/ngx_buf.h.html#L16" title="core/ngx_buf.h:16">ngx_buf_tag_t</a>) &amp;<a href="#L839" title="http/ngx_http_spdy_filter_module.c:839">ngx_http_spdy_filter_get_data_frame</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; buf-&gt;memory = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cl-&gt;next = first;<br/></li>
<li>&nbsp; &nbsp; first = cl;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; last-&gt;buf-&gt;flush = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; frame-&gt;first = first;<br/></li>
<li>&nbsp; &nbsp; frame-&gt;last = last;<br/></li>
<li>&nbsp; &nbsp; frame-&gt;handler = <a href="#L1023" title="http/ngx_http_spdy_filter_module.c:1023">ngx_http_spdy_data_frame_handler</a>;<br/></li>
<li>&nbsp; &nbsp; frame-&gt;stream = stream;<br/></li>
<li>&nbsp; &nbsp; frame-&gt;length = len;<br/></li>
<li>&nbsp; &nbsp; frame-&gt;priority = stream-&gt;priority;<br/></li>
<li>&nbsp; &nbsp; frame-&gt;blocked = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; frame-&gt;fin = last-&gt;buf-&gt;last_buf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> frame;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L111" title="core/ngx_config.h:111">ngx_inline</a> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L922">&#x200c;</a><span class="linkable">ngx_http_spdy_filter_send</span>(<a href="../core/ngx_core.h.html#L23" title="core/ngx_core.h:23">ngx_connection_t</a> *fc, <a href="ngx_http.h.html#L24" title="http/ngx_http.h:24">ngx_http_spdy_stream_t</a> *stream)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; stream-&gt;blocked = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="ngx_http_spdy.c.html#L663" title="http/ngx_http_spdy.c:663">ngx_http_spdy_send_output_queue</a>(stream-&gt;connection) == <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; fc-&gt;error = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; stream-&gt;blocked = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (stream-&gt;queued) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; fc-&gt;buffered |= <a href="../core/ngx_connection.h.html#L115" title="core/ngx_connection.h:115">NGX_SPDY_BUFFERED</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; fc-&gt;write-&gt;delayed = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L31" title="core/ngx_core.h:31">NGX_AGAIN</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; fc-&gt;buffered &amp;= ~<a href="../core/ngx_connection.h.html#L115" title="core/ngx_connection.h:115">NGX_SPDY_BUFFERED</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L111" title="core/ngx_config.h:111">ngx_inline</a> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L946">&#x200c;</a><span class="linkable">ngx_http_spdy_flow_control</span>(<a href="ngx_http_spdy.h.html#L71" title="http/ngx_http_spdy.h:71">ngx_http_spdy_connection_t</a> *sc,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L24" title="http/ngx_http.h:24">ngx_http_spdy_stream_t</a> *stream)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (stream-&gt;send_window &lt;= <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; stream-&gt;exhausted = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L34" title="core/ngx_core.h:34">NGX_DECLINED</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (sc-&gt;send_window == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L964" title="http/ngx_http_spdy_filter_module.c:964">ngx_http_spdy_waiting_queue</a>(sc, stream);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L34" title="core/ngx_core.h:34">NGX_DECLINED</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L964">&#x200c;</a></span><span class="linkable">ngx_http_spdy_waiting_queue</span>(<a href="ngx_http_spdy.h.html#L71" title="http/ngx_http_spdy.h:71">ngx_http_spdy_connection_t</a> *sc,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L24" title="http/ngx_http.h:24">ngx_http_spdy_stream_t</a> *stream)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_queue.h.html#L16" title="core/ngx_queue.h:16">ngx_queue_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *q;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L24" title="http/ngx_http.h:24">ngx_http_spdy_stream_t</a>&nbsp; *s;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (stream-&gt;handled) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; stream-&gt;handled = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (q = <a href="../core/ngx_queue.h.html#L54" title="core/ngx_queue.h:54">ngx_queue_last</a>(&amp;sc-&gt;waiting);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; q != <a href="../core/ngx_queue.h.html#L58" title="core/ngx_queue.h:58">ngx_queue_sentinel</a>(&amp;sc-&gt;waiting);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; q = <a href="../core/ngx_queue.h.html#L66" title="core/ngx_queue.h:66">ngx_queue_prev</a>(q))<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; s = <a href="../core/ngx_queue.h.html#L103" title="core/ngx_queue.h:103">ngx_queue_data</a>(q, <a href="ngx_http.h.html#L24" title="http/ngx_http.h:24">ngx_http_spdy_stream_t</a>, queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * NB: higher values represent lower priorities.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (stream-&gt;priority &gt;= s-&gt;priority) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_queue.h.html#L40" title="core/ngx_queue.h:40">ngx_queue_insert_after</a>(q, &amp;stream-&gt;queue);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L995">&#x200c;</a><span class="linkable">ngx_http_spdy_syn_frame_handler</span>(<a href="ngx_http_spdy.h.html#L71" title="http/ngx_http_spdy.h:71">ngx_http_spdy_connection_t</a> *sc,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_spdy.h.html#L72" title="http/ngx_http_spdy.h:72">ngx_http_spdy_out_frame_t</a> *frame)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *buf;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L24" title="http/ngx_http.h:24">ngx_http_spdy_stream_t</a>&nbsp; *stream;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; buf = frame-&gt;first-&gt;buf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (buf-&gt;pos != buf-&gt;last) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L31" title="core/ngx_core.h:31">NGX_AGAIN</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; stream = frame-&gt;stream;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L138" title="core/ngx_log.h:138">ngx_log_debug2</a>(<a href="../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, sc-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;spdy:</span><span class="Special">%u</span><span class="Constant">i SYN_REPLY frame </span><span class="Special">%p</span><span class="Constant"> was sent&quot;</span>, stream-&gt;id, frame);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_buf.h.html#L146" title="core/ngx_buf.h:146">ngx_free_chain</a>(stream-&gt;request-&gt;pool, frame-&gt;first);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L1116" title="http/ngx_http_spdy_filter_module.c:1116">ngx_http_spdy_handle_frame</a>(stream, frame);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L1137" title="http/ngx_http_spdy_filter_module.c:1137">ngx_http_spdy_handle_stream</a>(sc, stream);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L1023">&#x200c;</a><span class="linkable">ngx_http_spdy_data_frame_handler</span>(<a href="ngx_http_spdy.h.html#L71" title="http/ngx_http_spdy.h:71">ngx_http_spdy_connection_t</a> *sc,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_spdy.h.html#L72" title="http/ngx_http_spdy.h:72">ngx_http_spdy_out_frame_t</a> *frame)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *buf;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L16" title="core/ngx_core.h:16">ngx_chain_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *cl, *ln;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L24" title="http/ngx_http.h:24">ngx_http_spdy_stream_t</a>&nbsp; *stream;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; stream = frame-&gt;stream;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cl = frame-&gt;first;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cl-&gt;buf-&gt;tag == (<a href="../core/ngx_buf.h.html#L16" title="core/ngx_buf.h:16">ngx_buf_tag_t</a>) &amp;<a href="#L839" title="http/ngx_http_spdy_filter_module.c:839">ngx_http_spdy_filter_get_data_frame</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (cl-&gt;buf-&gt;pos != cl-&gt;buf-&gt;last) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L138" title="core/ngx_log.h:138">ngx_log_debug2</a>(<a href="../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, sc-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;spdy:</span><span class="Special">%u</span><span class="Constant">i DATA frame </span><span class="Special">%p</span><span class="Constant"> was sent partially&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; stream-&gt;id, frame);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L31" title="core/ngx_core.h:31">NGX_AGAIN</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ln = cl-&gt;next;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cl-&gt;next = stream-&gt;free_data_headers;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; stream-&gt;free_data_headers = cl;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (cl == frame-&gt;last) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cl = ln;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> ( ;; ) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (cl-&gt;buf-&gt;tag == (<a href="../core/ngx_buf.h.html#L16" title="core/ngx_buf.h:16">ngx_buf_tag_t</a>) &amp;<a href="#L806" title="http/ngx_http_spdy_filter_module.c:806">ngx_http_spdy_filter_get_shadow</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; buf = cl-&gt;buf-&gt;shadow;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_buf.h.html#L123" title="core/ngx_buf.h:123">ngx_buf_in_memory</a>(buf)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; buf-&gt;pos = cl-&gt;buf-&gt;pos;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (buf-&gt;in_file) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; buf-&gt;file_pos = cl-&gt;buf-&gt;file_pos;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_buf.h.html#L134" title="core/ngx_buf.h:134">ngx_buf_size</a>(cl-&gt;buf) != <span class="Constant">0</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (cl != frame-&gt;first) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; frame-&gt;first = cl;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1137" title="http/ngx_http_spdy_filter_module.c:1137">ngx_http_spdy_handle_stream</a>(sc, stream);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L138" title="core/ngx_log.h:138">ngx_log_debug2</a>(<a href="../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, sc-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;spdy:</span><span class="Special">%u</span><span class="Constant">i DATA frame </span><span class="Special">%p</span><span class="Constant"> was sent partially&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; stream-&gt;id, frame);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L31" title="core/ngx_core.h:31">NGX_AGAIN</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ln = cl-&gt;next;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (cl-&gt;buf-&gt;tag == (<a href="../core/ngx_buf.h.html#L16" title="core/ngx_buf.h:16">ngx_buf_tag_t</a>) &amp;<a href="#L806" title="http/ngx_http_spdy_filter_module.c:806">ngx_http_spdy_filter_get_shadow</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cl-&gt;next = stream-&gt;free_bufs;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; stream-&gt;free_bufs = cl;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_buf.h.html#L146" title="core/ngx_buf.h:146">ngx_free_chain</a>(stream-&gt;request-&gt;pool, cl);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (cl == frame-&gt;last) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cl = ln;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="Statement">done</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L138" title="core/ngx_log.h:138">ngx_log_debug2</a>(<a href="../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, sc-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;spdy:</span><span class="Special">%u</span><span class="Constant">i DATA frame </span><span class="Special">%p</span><span class="Constant"> was sent&quot;</span>, stream-&gt;id, frame);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; stream-&gt;request-&gt;header_size += <a href="ngx_http_spdy.h.html#L36" title="http/ngx_http_spdy.h:36">NGX_SPDY_FRAME_HEADER_SIZE</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L1116" title="http/ngx_http_spdy_filter_module.c:1116">ngx_http_spdy_handle_frame</a>(stream, frame);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L1137" title="http/ngx_http_spdy_filter_module.c:1137">ngx_http_spdy_handle_stream</a>(sc, stream);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L111" title="core/ngx_config.h:111">ngx_inline</a> <span class="Type">void<br/></li>
<li><a id="L1116">&#x200c;</a></span><span class="linkable">ngx_http_spdy_handle_frame</span>(<a href="ngx_http.h.html#L24" title="http/ngx_http.h:24">ngx_http_spdy_stream_t</a> *stream,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_spdy.h.html#L72" title="http/ngx_http_spdy.h:72">ngx_http_spdy_out_frame_t</a> *frame)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a>&nbsp; *r;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r = stream-&gt;request;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;connection-&gt;sent += <a href="ngx_http_spdy.h.html#L36" title="http/ngx_http_spdy.h:36">NGX_SPDY_FRAME_HEADER_SIZE</a> + frame-&gt;length;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (frame-&gt;fin) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; stream-&gt;out_closed = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; frame-&gt;next = stream-&gt;free_frames;<br/></li>
<li>&nbsp; &nbsp; stream-&gt;free_frames = frame;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; stream-&gt;queued--;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L111" title="core/ngx_config.h:111">ngx_inline</a> <span class="Type">void<br/></li>
<li><a id="L1137">&#x200c;</a></span><span class="linkable">ngx_http_spdy_handle_stream</span>(<a href="ngx_http_spdy.h.html#L71" title="http/ngx_http_spdy.h:71">ngx_http_spdy_connection_t</a> *sc,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L24" title="http/ngx_http.h:24">ngx_http_spdy_stream_t</a> *stream)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L21" title="core/ngx_core.h:21">ngx_event_t</a>&nbsp; *wev;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (stream-&gt;handled || stream-&gt;blocked || stream-&gt;exhausted) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; wev = stream-&gt;request-&gt;connection-&gt;write;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * This timer can only be <a href="../event/modules/ngx_rtsig_module.c.html#L75" title="event/modules/ngx_rtsig_module.c:75">set</a> if the stream was delayed because of rate<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * limit.&nbsp; In that case the event should be triggered by the timer.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!wev-&gt;timer_set) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; wev-&gt;delayed = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; stream-&gt;handled = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_queue.h.html#L43" title="core/ngx_queue.h:43">ngx_queue_insert_tail</a>(&amp;sc-&gt;posted, &amp;stream-&gt;queue);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L1163">&#x200c;</a></span><span class="linkable">ngx_http_spdy_filter_cleanup</span>(<span class="Type">void</span> *data)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L24" title="http/ngx_http.h:24">ngx_http_spdy_stream_t</a> *stream = data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; delta;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_spdy.h.html#L72" title="http/ngx_http_spdy.h:72">ngx_http_spdy_out_frame_t</a>&nbsp;&nbsp; *frame, **fn;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_spdy.h.html#L71" title="http/ngx_http_spdy.h:71">ngx_http_spdy_connection_t</a>&nbsp; *sc;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (stream-&gt;handled) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; stream-&gt;handled = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_queue.h.html#L72" title="core/ngx_queue.h:72">ngx_queue_remove</a>(&amp;stream-&gt;queue);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (stream-&gt;queued == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; delta = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; sc = stream-&gt;connection;<br/></li>
<li>&nbsp; &nbsp; fn = &amp;sc-&gt;last_out;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> ( ;; ) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; frame = *fn;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (frame == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (frame-&gt;stream == stream &amp;&amp; !frame-&gt;blocked) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *fn = frame-&gt;next;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; delta += frame-&gt;length;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (--stream-&gt;queued == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; fn = &amp;frame-&gt;next;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (sc-&gt;send_window == <span class="Constant">0</span> &amp;&amp; delta &amp;&amp; !<a href="../core/ngx_queue.h.html#L29" title="core/ngx_queue.h:29">ngx_queue_empty</a>(&amp;sc-&gt;waiting)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_queue.h.html#L96" title="core/ngx_queue.h:96">ngx_queue_add</a>(&amp;sc-&gt;posted, &amp;sc-&gt;waiting);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_queue.h.html#L24" title="core/ngx_queue.h:24">ngx_queue_init</a>(&amp;sc-&gt;waiting);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; sc-&gt;send_window += delta;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L1216">&#x200c;</a><span class="linkable">ngx_http_spdy_filter_init</span>(<a href="../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="modules/ngx_http_gunzip_filter_module.c.html#L116" title="http/modules/ngx_http_gunzip_filter_module.c:116">ngx_http_next_header_filter</a> = <a href="ngx_http.c.html#L72" title="http/ngx_http.c:72">ngx_http_top_header_filter</a>;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.c.html#L72" title="http/ngx_http.c:72">ngx_http_top_header_filter</a> = <a href="#L96" title="http/ngx_http_spdy_filter_module.c:96">ngx_http_spdy_header_filter</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
</ol></code>
 </body>
</html>
