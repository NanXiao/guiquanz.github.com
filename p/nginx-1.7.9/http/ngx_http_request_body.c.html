<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>http/ngx_http_request_body.c - src</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

code {
    font-family: consolas, monospace;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
  <h3>http/ngx_http_request_body.c - src</h3>
   <a href="../index.html"> Table of Contents </a>
 <h4>Functions defined</h4>
 <ul>
<li><a href="#L492">ngx_http_discard_request_body</a></li>
<li><a href="#L693">ngx_http_discard_request_body_filter</a></li>
<li><a href="#L566">ngx_http_discarded_request_body_handler</a></li>
<li><a href="#L247">ngx_http_do_read_client_request_body</a></li>
<li><a href="#L32">ngx_http_read_client_request_body</a></li>
<li><a href="#L228">ngx_http_read_client_request_body_handler</a></li>
<li><a href="#L637">ngx_http_read_discarded_request_body</a></li>
<li><a href="#L905">ngx_http_request_body_chunked_filter</a></li>
<li><a href="#L824">ngx_http_request_body_filter</a></li>
<li><a href="#L836">ngx_http_request_body_length_filter</a></li>
<li><a href="#L1057">ngx_http_request_body_save_filter</a></li>
<li><a href="#L782">ngx_http_test_expect</a></li>
<li><a href="#L415">ngx_http_write_request_body</a></li>
</ul>
 <h4>Source code</h4>

  <code><ol><li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Copyright (C) Igor Sysoev<br/></li>
<li></span><span class="Comment"> * Copyright (C) Nginx, Inc.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;ngx_config.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;ngx_core.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;ngx_http.h&gt;<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L228" title="http/ngx_http_request_body.c:228">ngx_http_read_client_request_body_handler</a>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L247" title="http/ngx_http_request_body.c:247">ngx_http_do_read_client_request_body</a>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L415" title="http/ngx_http_request_body.c:415">ngx_http_write_request_body</a>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L637" title="http/ngx_http_request_body.c:637">ngx_http_read_discarded_request_body</a>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L693" title="http/ngx_http_request_body.c:693">ngx_http_discard_request_body_filter</a>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a> *b);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L782" title="http/ngx_http_request_body.c:782">ngx_http_test_expect</a>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r);<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L824" title="http/ngx_http_request_body.c:824">ngx_http_request_body_filter</a>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L16" title="core/ngx_core.h:16">ngx_chain_t</a> *in);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L836" title="http/ngx_http_request_body.c:836">ngx_http_request_body_length_filter</a>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L16" title="core/ngx_core.h:16">ngx_chain_t</a> *in);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L905" title="http/ngx_http_request_body.c:905">ngx_http_request_body_chunked_filter</a>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L16" title="core/ngx_core.h:16">ngx_chain_t</a> *in);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L1057" title="http/ngx_http_request_body.c:1057">ngx_http_request_body_save_filter</a>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L16" title="core/ngx_core.h:16">ngx_chain_t</a> *in);<br/></li>
<li><br/></li>
<li><br/></li>
<li><a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L32">&#x200c;</a><span class="linkable">ngx_http_read_client_request_body</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_request.h.html#L278" title="http/ngx_http_request.h:278">ngx_http_client_body_handler_pt</a> post_handler)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; preread;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">ssize_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; size;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *b;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L16" title="core/ngx_core.h:16">ngx_chain_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; out, *cl;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_request.h.html#L289" title="http/ngx_http_request.h:289">ngx_http_request_body_t</a>&nbsp;&nbsp; *rb;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L53" title="http/ngx_http_core_module.h:53">ngx_http_core_loc_conf_t</a>&nbsp; *clcf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;<a href="../core/nginx.c.html#L202" title="core/nginx.c:202">main</a>-&gt;count++;<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HTTP_SPDY)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;spdy_stream &amp;&amp; r == r-&gt;<a href="../core/nginx.c.html#L202" title="core/nginx.c:202">main</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="ngx_http_spdy.c.html#L3229" title="http/ngx_http_spdy.c:3229">ngx_http_spdy_read_request_body</a>(r, post_handler);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r != r-&gt;<a href="../core/nginx.c.html#L202" title="core/nginx.c:202">main</a> || r-&gt;request_body || r-&gt;discard_body) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; post_handler(r);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L782" title="http/ngx_http_request_body.c:782">ngx_http_test_expect</a>(r) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="ngx_http_request.h.html#L128" title="http/ngx_http_request.h:128">NGX_HTTP_INTERNAL_SERVER_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rb = <a href="../core/ngx_palloc.c.html#L300" title="core/ngx_palloc.c:300">ngx_pcalloc</a>(r-&gt;pool, <span class="Statement">sizeof</span>(<a href="ngx_http_request.h.html#L289" title="http/ngx_http_request.h:289">ngx_http_request_body_t</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rb == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="ngx_http_request.h.html#L128" title="http/ngx_http_request.h:128">NGX_HTTP_INTERNAL_SERVER_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * <a href="../event/modules/ngx_rtsig_module.c.html#L75" title="event/modules/ngx_rtsig_module.c:75">set</a> by <a href="../core/ngx_palloc.c.html#L300" title="core/ngx_palloc.c:300">ngx_pcalloc</a>():<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *&nbsp; &nbsp;&nbsp; rb-&gt;bufs = NULL;<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *&nbsp; &nbsp;&nbsp; rb-&gt;buf = NULL;<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *&nbsp; &nbsp;&nbsp; rb-&gt;free = NULL;<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *&nbsp; &nbsp;&nbsp; rb-&gt;busy = NULL;<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *&nbsp; &nbsp;&nbsp; rb-&gt;chunked = NULL;<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; rb-&gt;rest = -<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; rb-&gt;post_handler = post_handler;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;request_body = rb;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;headers_in.content_length_n &lt; <span class="Constant">0</span> &amp;&amp; !r-&gt;headers_in.chunked) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; post_handler(r);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; preread = r-&gt;header_in-&gt;last - r-&gt;header_in-&gt;pos;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (preread) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* there is the pre-read part of the request body */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http client request body preread </span><span class="Special">%u</span><span class="Constant">z&quot;</span>, preread);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; out.buf = r-&gt;header_in;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; out.next = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="#L824" title="http/ngx_http_request_body.c:824">ngx_http_request_body_filter</a>(r, &amp;out);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;request_length += preread - (r-&gt;header_in-&gt;last - r-&gt;header_in-&gt;pos);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!r-&gt;headers_in.chunked<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; rb-&gt;rest &gt; <span class="Constant">0<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; rb-&gt;rest &lt;= (<span class="Type">off_t</span>) (r-&gt;header_in-&gt;end - r-&gt;header_in-&gt;last))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* the whole request body may be placed in r-&gt;header_in */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b = <a href="../core/ngx_buf.h.html#L143" title="core/ngx_buf.h:143">ngx_calloc_buf</a>(r-&gt;pool);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (b == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="ngx_http_request.h.html#L128" title="http/ngx_http_request.h:128">NGX_HTTP_INTERNAL_SERVER_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b-&gt;temporary = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b-&gt;start = r-&gt;header_in-&gt;pos;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b-&gt;pos = r-&gt;header_in-&gt;pos;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b-&gt;last = r-&gt;header_in-&gt;last;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b-&gt;end = r-&gt;header_in-&gt;end;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rb-&gt;buf = b;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;read_event_handler = <a href="#L228" title="http/ngx_http_request_body.c:228">ngx_http_read_client_request_body_handler</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;write_event_handler = <a href="ngx_http_request.c.html#L3297" title="http/ngx_http_request.c:3297">ngx_http_request_empty_handler</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="#L247" title="http/ngx_http_request_body.c:247">ngx_http_do_read_client_request_body</a>(r);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* <a href="../event/modules/ngx_rtsig_module.c.html#L75" title="event/modules/ngx_rtsig_module.c:75">set</a> rb-&gt;rest */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L824" title="http/ngx_http_request_body.c:824">ngx_http_request_body_filter</a>(r, <span class="Constant">NULL</span>) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="ngx_http_request.h.html#L128" title="http/ngx_http_request.h:128">NGX_HTTP_INTERNAL_SERVER_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rb-&gt;rest == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* the whole request body was pre-read */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;request_body_in_file_only) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L415" title="http/ngx_http_request_body.c:415">ngx_http_write_request_body</a>(r) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="ngx_http_request.h.html#L128" title="http/ngx_http_request.h:128">NGX_HTTP_INTERNAL_SERVER_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rb-&gt;temp_file-&gt;file.offset != <span class="Constant">0</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cl = <a href="../core/ngx_buf.c.html#L156" title="core/ngx_buf.c:156">ngx_chain_get_free_buf</a>(r-&gt;pool, &amp;rb-&gt;free);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (cl == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="ngx_http_request.h.html#L128" title="http/ngx_http_request.h:128">NGX_HTTP_INTERNAL_SERVER_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b = cl-&gt;buf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_string.h.html#L86" title="core/ngx_string.h:86">ngx_memzero</a>(b, <span class="Statement">sizeof</span>(<a href="../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b-&gt;in_file = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b-&gt;file_last = rb-&gt;temp_file-&gt;file.offset;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b-&gt;file = &amp;rb-&gt;temp_file-&gt;file;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rb-&gt;bufs = cl;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rb-&gt;bufs = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; post_handler(r);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rb-&gt;rest &lt; <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L18" title="core/ngx_log.h:18">NGX_LOG_ALERT</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;negative request body rest&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="ngx_http_request.h.html#L128" title="http/ngx_http_request.h:128">NGX_HTTP_INTERNAL_SERVER_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; clcf = <a href="ngx_http_config.h.html#L58" title="http/ngx_http_config.h:58">ngx_http_get_module_loc_conf</a>(r, <a href="ngx_http_core_module.c.html#L811" title="http/ngx_http_core_module.c:811">ngx_http_core_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; size = clcf-&gt;client_body_buffer_size;<br/></li>
<li>&nbsp; &nbsp; size += size &gt;&gt; <span class="Constant">2</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* </span><span class="Todo">TODO</span><span class="Comment">: honor r-&gt;request_body_in_single_buf */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!r-&gt;headers_in.chunked &amp;&amp; rb-&gt;rest &lt; size) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; size = (<span class="Type">ssize_t</span>) rb-&gt;rest;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;request_body_in_single_buf) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; size += preread;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; size = clcf-&gt;client_body_buffer_size;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rb-&gt;buf = <a href="../core/ngx_buf.c.html#L13" title="core/ngx_buf.c:13">ngx_create_temp_buf</a>(r-&gt;pool, size);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rb-&gt;buf == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="ngx_http_request.h.html#L128" title="http/ngx_http_request.h:128">NGX_HTTP_INTERNAL_SERVER_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;read_event_handler = <a href="#L228" title="http/ngx_http_request_body.c:228">ngx_http_read_client_request_body_handler</a>;<br/></li>
<li>&nbsp; &nbsp; r-&gt;write_event_handler = <a href="ngx_http_request.c.html#L3297" title="http/ngx_http_request.c:3297">ngx_http_request_empty_handler</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rc = <a href="#L247" title="http/ngx_http_request_body.c:247">ngx_http_do_read_client_request_body</a>(r);<br/></li>
<li><br/></li>
<li><span class="Statement">done</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc &gt;= <a href="ngx_http_request.h.html#L77" title="http/ngx_http_request.h:77">NGX_HTTP_SPECIAL_RESPONSE</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;<a href="../core/nginx.c.html#L202" title="core/nginx.c:202">main</a>-&gt;count--;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> rc;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L228">&#x200c;</a></span><span class="linkable">ngx_http_read_client_request_body_handler</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a>&nbsp; rc;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;connection-&gt;read-&gt;timedout) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;connection-&gt;timedout = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_http_request.c.html#L2249" title="http/ngx_http_request.c:2249">ngx_http_finalize_request</a>(r, <a href="ngx_http_request.h.html#L89" title="http/ngx_http_request.h:89">NGX_HTTP_REQUEST_TIME_OUT</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rc = <a href="#L247" title="http/ngx_http_request_body.c:247">ngx_http_do_read_client_request_body</a>(r);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc &gt;= <a href="ngx_http_request.h.html#L77" title="http/ngx_http_request.h:77">NGX_HTTP_SPECIAL_RESPONSE</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_http_request.c.html#L2249" title="http/ngx_http_request.c:2249">ngx_http_finalize_request</a>(r, rc);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L247">&#x200c;</a><span class="linkable">ngx_http_do_read_client_request_body</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">off_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rest;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; size;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">ssize_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *b;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L16" title="core/ngx_core.h:16">ngx_chain_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *cl, out;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L23" title="core/ngx_core.h:23">ngx_connection_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *c;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_request.h.html#L289" title="http/ngx_http_request.h:289">ngx_http_request_body_t</a>&nbsp;&nbsp; *rb;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L53" title="http/ngx_http_core_module.h:53">ngx_http_core_loc_conf_t</a>&nbsp; *clcf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c = r-&gt;connection;<br/></li>
<li>&nbsp; &nbsp; rb = r-&gt;request_body;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L132" title="core/ngx_log.h:132">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http read client request body&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> ( ;; ) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> ( ;; ) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rb-&gt;buf-&gt;last == rb-&gt;buf-&gt;end) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* pass buffer to request body filter chain */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; out.buf = rb-&gt;buf;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; out.next = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="#L824" title="http/ngx_http_request_body.c:824">ngx_http_request_body_filter</a>(r, &amp;out);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> rc;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* write to file */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L415" title="http/ngx_http_request_body.c:415">ngx_http_write_request_body</a>(r) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_http_request.h.html#L128" title="http/ngx_http_request.h:128">NGX_HTTP_INTERNAL_SERVER_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* update chains */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="#L824" title="http/ngx_http_request_body.c:824">ngx_http_request_body_filter</a>(r, <span class="Constant">NULL</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> rc;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rb-&gt;busy != <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_http_request.h.html#L128" title="http/ngx_http_request.h:128">NGX_HTTP_INTERNAL_SERVER_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rb-&gt;buf-&gt;pos = rb-&gt;buf-&gt;start;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rb-&gt;buf-&gt;last = rb-&gt;buf-&gt;start;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; size = rb-&gt;buf-&gt;end - rb-&gt;buf-&gt;last;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rest = rb-&gt;rest - (rb-&gt;buf-&gt;last - rb-&gt;buf-&gt;pos);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((<span class="Type">off_t</span>) size &gt; rest) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; size = (<span class="Type">size_t</span>) rest;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n = c-&gt;recv(c, rb-&gt;buf-&gt;last, size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http client request body recv %z&quot;</span>, n);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n == <a href="../core/ngx_core.h.html#L31" title="core/ngx_core.h:31">NGX_AGAIN</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L23" title="core/ngx_log.h:23">NGX_LOG_INFO</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client prematurely closed connection&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n == <span class="Constant">0</span> || n == <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c-&gt;error = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_http_request.h.html#L84" title="http/ngx_http_request.h:84">NGX_HTTP_BAD_REQUEST</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rb-&gt;buf-&gt;last += n;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;request_length += n;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n == rest) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* pass buffer to request body filter chain */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; out.buf = rb-&gt;buf;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; out.next = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="#L824" title="http/ngx_http_request_body.c:824">ngx_http_request_body_filter</a>(r, &amp;out);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> rc;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rb-&gt;rest == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rb-&gt;buf-&gt;last &lt; rb-&gt;buf-&gt;end) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http client request body rest </span><span class="Special">%O</span><span class="Constant">&quot;</span>, rb-&gt;rest);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rb-&gt;rest == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!c-&gt;read-&gt;ready) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; clcf = <a href="ngx_http_config.h.html#L58" title="http/ngx_http_config.h:58">ngx_http_get_module_loc_conf</a>(r, <a href="ngx_http_core_module.c.html#L811" title="http/ngx_http_core_module.c:811">ngx_http_core_module</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event.h.html#L427" title="event/ngx_event.h:427">ngx_add_timer</a>(c-&gt;read, clcf-&gt;client_body_timeout);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../event/ngx_event.c.html#L270" title="event/ngx_event.c:270">ngx_handle_read_event</a>(c-&gt;read, <span class="Constant">0</span>) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_http_request.h.html#L128" title="http/ngx_http_request.h:128">NGX_HTTP_INTERNAL_SERVER_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L31" title="core/ngx_core.h:31">NGX_AGAIN</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;read-&gt;timer_set) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event.h.html#L428" title="event/ngx_event.h:428">ngx_del_timer</a>(c-&gt;read);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rb-&gt;temp_file || r-&gt;request_body_in_file_only) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* save the last part */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L415" title="http/ngx_http_request_body.c:415">ngx_http_write_request_body</a>(r) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_http_request.h.html#L128" title="http/ngx_http_request.h:128">NGX_HTTP_INTERNAL_SERVER_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rb-&gt;temp_file-&gt;file.offset != <span class="Constant">0</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cl = <a href="../core/ngx_buf.c.html#L156" title="core/ngx_buf.c:156">ngx_chain_get_free_buf</a>(r-&gt;pool, &amp;rb-&gt;free);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (cl == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_http_request.h.html#L128" title="http/ngx_http_request.h:128">NGX_HTTP_INTERNAL_SERVER_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b = cl-&gt;buf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_string.h.html#L86" title="core/ngx_string.h:86">ngx_memzero</a>(b, <span class="Statement">sizeof</span>(<a href="../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b-&gt;in_file = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b-&gt;file_last = rb-&gt;temp_file-&gt;file.offset;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b-&gt;file = &amp;rb-&gt;temp_file-&gt;file;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rb-&gt;bufs = cl;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rb-&gt;bufs = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;read_event_handler = <a href="ngx_http_request.c.html#L2691" title="http/ngx_http_request.c:2691">ngx_http_block_reading</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rb-&gt;post_handler(r);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L415">&#x200c;</a><span class="linkable">ngx_http_write_request_body</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">ssize_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L16" title="core/ngx_core.h:16">ngx_chain_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *cl;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_file.h.html#L74" title="core/ngx_file.h:74">ngx_temp_file_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *tf;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_request.h.html#L289" title="http/ngx_http_request.h:289">ngx_http_request_body_t</a>&nbsp;&nbsp; *rb;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L53" title="http/ngx_http_core_module.h:53">ngx_http_core_loc_conf_t</a>&nbsp; *clcf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rb = r-&gt;request_body;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http write client request body, bufs </span><span class="Special">%p</span><span class="Constant">&quot;</span>, rb-&gt;bufs);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rb-&gt;temp_file == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; tf = <a href="../core/ngx_palloc.c.html#L300" title="core/ngx_palloc.c:300">ngx_pcalloc</a>(r-&gt;pool, <span class="Statement">sizeof</span>(<a href="../core/ngx_file.h.html#L74" title="core/ngx_file.h:74">ngx_temp_file_t</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (tf == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; clcf = <a href="ngx_http_config.h.html#L58" title="http/ngx_http_config.h:58">ngx_http_get_module_loc_conf</a>(r, <a href="ngx_http_core_module.c.html#L811" title="http/ngx_http_core_module.c:811">ngx_http_core_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; tf-&gt;file.fd = <a href="../os/unix/ngx_files.h.html#L49" title="os/unix/ngx_files.h:49">NGX_INVALID_FILE</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; tf-&gt;file.log = r-&gt;connection-&gt;log;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; tf-&gt;path = clcf-&gt;client_body_temp_path;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; tf-&gt;pool = r-&gt;pool;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; tf-&gt;warn = <span class="Constant">&quot;a client request body is buffered to a temporary file&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; tf-&gt;log_level = r-&gt;request_body_file_log_level;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; tf-&gt;persistent = r-&gt;request_body_in_persistent_file;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; tf-&gt;clean = r-&gt;request_body_in_clean_file;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;request_body_file_group_access) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tf-&gt;access = <span class="PreProc">0</span><span class="Constant">660</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rb-&gt;temp_file = tf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rb-&gt;bufs == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* empty body with r-&gt;request_body_in_file_only */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_file.c.html#L132" title="core/ngx_file.c:132">ngx_create_temp_file</a>(&amp;tf-&gt;file, tf-&gt;path, tf-&gt;pool,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; tf-&gt;persistent, tf-&gt;clean, tf-&gt;access)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rb-&gt;bufs == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; n = <a href="../core/ngx_file.c.html#L109" title="core/ngx_file.c:109">ngx_write_chain_to_temp_file</a>(rb-&gt;temp_file, rb-&gt;bufs);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* </span><span class="Todo">TODO</span><span class="Comment">: n == 0 or not complete and level event */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (n == <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rb-&gt;temp_file-&gt;offset += n;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* mark all buffers as written */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (cl = rb-&gt;bufs; cl; cl = cl-&gt;next) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cl-&gt;buf-&gt;pos = cl-&gt;buf-&gt;last;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rb-&gt;bufs = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L492">&#x200c;</a><span class="linkable">ngx_http_discard_request_body</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">ssize_t</span>&nbsp; &nbsp; &nbsp;&nbsp; size;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp;&nbsp; rc;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L21" title="core/ngx_core.h:21">ngx_event_t</a>&nbsp; *rev;<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HTTP_SPDY)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;spdy_stream &amp;&amp; r == r-&gt;<a href="../core/nginx.c.html#L202" title="core/nginx.c:202">main</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;spdy_stream-&gt;skip_data = <a href="ngx_http_spdy.h.html#L66" title="http/ngx_http_spdy.h:66">NGX_SPDY_DATA_DISCARD</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r != r-&gt;<a href="../core/nginx.c.html#L202" title="core/nginx.c:202">main</a> || r-&gt;discard_body || r-&gt;request_body) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L782" title="http/ngx_http_request_body.c:782">ngx_http_test_expect</a>(r) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_http_request.h.html#L128" title="http/ngx_http_request.h:128">NGX_HTTP_INTERNAL_SERVER_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rev = r-&gt;connection-&gt;read;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L132" title="core/ngx_log.h:132">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, rev-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;http <a href="../event/modules/ngx_rtsig_module.c.html#L75" title="event/modules/ngx_rtsig_module.c:75">set</a> discard body&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rev-&gt;timer_set) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event.h.html#L428" title="event/ngx_event.h:428">ngx_del_timer</a>(rev);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;headers_in.content_length_n &lt;= <span class="Constant">0</span> &amp;&amp; !r-&gt;headers_in.chunked) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; size = r-&gt;header_in-&gt;last - r-&gt;header_in-&gt;pos;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (size || r-&gt;headers_in.chunked) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="#L693" title="http/ngx_http_request_body.c:693">ngx_http_discard_request_body_filter</a>(r, r-&gt;header_in);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> rc;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;headers_in.content_length_n == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rc = <a href="#L637" title="http/ngx_http_request_body.c:637">ngx_http_read_discarded_request_body</a>(r);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;lingering_close = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc &gt;= <a href="ngx_http_request.h.html#L77" title="http/ngx_http_request.h:77">NGX_HTTP_SPECIAL_RESPONSE</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> rc;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* rc == <a href="../core/ngx_core.h.html#L31" title="core/ngx_core.h:31">NGX_AGAIN</a> */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; r-&gt;read_event_handler = <a href="#L566" title="http/ngx_http_request_body.c:566">ngx_http_discarded_request_body_handler</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../event/ngx_event.c.html#L270" title="event/ngx_event.c:270">ngx_handle_read_event</a>(rev, <span class="Constant">0</span>) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_http_request.h.html#L128" title="http/ngx_http_request.h:128">NGX_HTTP_INTERNAL_SERVER_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;count++;<br/></li>
<li>&nbsp; &nbsp; r-&gt;discard_body = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">void<br/></li>
<li><a id="L566">&#x200c;</a></span><span class="linkable">ngx_http_discarded_request_body_handler</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc;<br/></li>
<li>&nbsp; &nbsp; <a href="../os/unix/ngx_time.h.html#L16" title="os/unix/ngx_time.h:16">ngx_msec_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; timer;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L21" title="core/ngx_core.h:21">ngx_event_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *rev;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L23" title="core/ngx_core.h:23">ngx_connection_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *c;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L53" title="http/ngx_http_core_module.h:53">ngx_http_core_loc_conf_t</a>&nbsp; *clcf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c = r-&gt;connection;<br/></li>
<li>&nbsp; &nbsp; rev = c-&gt;read;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rev-&gt;timedout) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;timedout = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;error = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_http_request.c.html#L2249" title="http/ngx_http_request.c:2249">ngx_http_finalize_request</a>(r, <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;lingering_time) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; timer = (<a href="../os/unix/ngx_time.h.html#L16" title="os/unix/ngx_time.h:16">ngx_msec_t</a>) r-&gt;lingering_time - (<a href="../os/unix/ngx_time.h.html#L16" title="os/unix/ngx_time.h:16">ngx_msec_t</a>) <a href="../core/ngx_times.h.html#L36" title="core/ngx_times.h:36">ngx_time</a>();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((<a href="../os/unix/ngx_time.h.html#L17" title="os/unix/ngx_time.h:17">ngx_msec_int_t</a>) timer &lt;= <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;discard_body = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;lingering_close = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_http_request.c.html#L2249" title="http/ngx_http_request.c:2249">ngx_http_finalize_request</a>(r, <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; timer = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rc = <a href="#L637" title="http/ngx_http_request_body.c:637">ngx_http_read_discarded_request_body</a>(r);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;discard_body = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;lingering_close = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_http_request.c.html#L2249" title="http/ngx_http_request.c:2249">ngx_http_finalize_request</a>(r, <a href="../core/ngx_core.h.html#L33" title="core/ngx_core.h:33">NGX_DONE</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc &gt;= <a href="ngx_http_request.h.html#L77" title="http/ngx_http_request.h:77">NGX_HTTP_SPECIAL_RESPONSE</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;error = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_http_request.c.html#L2249" title="http/ngx_http_request.c:2249">ngx_http_finalize_request</a>(r, <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* rc == <a href="../core/ngx_core.h.html#L31" title="core/ngx_core.h:31">NGX_AGAIN</a> */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../event/ngx_event.c.html#L270" title="event/ngx_event.c:270">ngx_handle_read_event</a>(rev, <span class="Constant">0</span>) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;error = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_http_request.c.html#L2249" title="http/ngx_http_request.c:2249">ngx_http_finalize_request</a>(r, <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (timer) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; clcf = <a href="ngx_http_config.h.html#L58" title="http/ngx_http_config.h:58">ngx_http_get_module_loc_conf</a>(r, <a href="ngx_http_core_module.c.html#L811" title="http/ngx_http_core_module.c:811">ngx_http_core_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; timer *= <span class="Constant">1000</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (timer &gt; clcf-&gt;lingering_timeout) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; timer = clcf-&gt;lingering_timeout;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event.h.html#L427" title="event/ngx_event.h:427">ngx_add_timer</a>(rev, timer);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L637">&#x200c;</a><span class="linkable">ngx_http_read_discarded_request_body</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp;&nbsp; size;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">ssize_t</span>&nbsp; &nbsp; n;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a>&nbsp; rc;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; b;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp;&nbsp; buffer[<a href="ngx_http_request.h.html#L19" title="http/ngx_http_request.h:19">NGX_HTTP_DISCARD_BUFFER_SIZE</a>];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L132" title="core/ngx_log.h:132">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http read discarded body&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L86" title="core/ngx_string.h:86">ngx_memzero</a>(&amp;b, <span class="Statement">sizeof</span>(<a href="../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; b.temporary = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> ( ;; ) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;headers_in.content_length_n == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;read_event_handler = <a href="ngx_http_request.c.html#L2691" title="http/ngx_http_request.c:2691">ngx_http_block_reading</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!r-&gt;connection-&gt;read-&gt;ready) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L31" title="core/ngx_core.h:31">NGX_AGAIN</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; size = (<span class="Type">size_t</span>) <a href="../core/ngx_core.h.html#L91" title="core/ngx_core.h:91">ngx_min</a>(r-&gt;headers_in.content_length_n,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_http_request.h.html#L19" title="http/ngx_http_request.h:19">NGX_HTTP_DISCARD_BUFFER_SIZE</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; n = r-&gt;connection-&gt;recv(r-&gt;connection, buffer, size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n == <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;connection-&gt;error = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n == <a href="../core/ngx_core.h.html#L31" title="core/ngx_core.h:31">NGX_AGAIN</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L31" title="core/ngx_core.h:31">NGX_AGAIN</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; b.pos = buffer;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; b.last = buffer + n;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="#L693" title="http/ngx_http_request_body.c:693">ngx_http_discard_request_body_filter</a>(r, &amp;b);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> rc;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L693">&#x200c;</a><span class="linkable">ngx_http_discard_request_body_filter</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a> *b)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; size;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; rc;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_request.h.html#L289" title="http/ngx_http_request.h:289">ngx_http_request_body_t</a>&nbsp; *rb;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;headers_in.chunked) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rb = r-&gt;request_body;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rb == <span class="Constant">NULL</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rb = <a href="../core/ngx_palloc.c.html#L300" title="core/ngx_palloc.c:300">ngx_pcalloc</a>(r-&gt;pool, <span class="Statement">sizeof</span>(<a href="ngx_http_request.h.html#L289" title="http/ngx_http_request.h:289">ngx_http_request_body_t</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rb == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_http_request.h.html#L128" title="http/ngx_http_request.h:128">NGX_HTTP_INTERNAL_SERVER_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rb-&gt;chunked = <a href="../core/ngx_palloc.c.html#L300" title="core/ngx_palloc.c:300">ngx_pcalloc</a>(r-&gt;pool, <span class="Statement">sizeof</span>(<a href="ngx_http.h.html#L21" title="http/ngx_http.h:21">ngx_http_chunked_t</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rb-&gt;chunked == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_http_request.h.html#L128" title="http/ngx_http_request.h:128">NGX_HTTP_INTERNAL_SERVER_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;request_body = rb;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> ( ;; ) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="ngx_http_parse.c.html#L2102" title="http/ngx_http_parse.c:2102">ngx_http_parse_chunked</a>(r, b, rb-&gt;chunked);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* a chunk has been parsed successfully */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; size = b-&gt;last - b-&gt;pos;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((<span class="Type">off_t</span>) size &gt; rb-&gt;chunked-&gt;size) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b-&gt;pos += (<span class="Type">size_t</span>) rb-&gt;chunked-&gt;size;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rb-&gt;chunked-&gt;size = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rb-&gt;chunked-&gt;size -= size;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b-&gt;pos = b-&gt;last;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../core/ngx_core.h.html#L33" title="core/ngx_core.h:33">NGX_DONE</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* a whole response has been parsed successfully */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;headers_in.content_length_n = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../core/ngx_core.h.html#L31" title="core/ngx_core.h:31">NGX_AGAIN</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* <a href="../event/modules/ngx_rtsig_module.c.html#L75" title="event/modules/ngx_rtsig_module.c:75">set</a> amount of data we want to see next time */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;headers_in.content_length_n = rb-&gt;chunked-&gt;length;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* invalid */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L20" title="core/ngx_log.h:20">NGX_LOG_ERR</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client sent invalid chunked body&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_http_request.h.html#L84" title="http/ngx_http_request.h:84">NGX_HTTP_BAD_REQUEST</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; size = b-&gt;last - b-&gt;pos;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((<span class="Type">off_t</span>) size &gt; r-&gt;headers_in.content_length_n) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b-&gt;pos += (<span class="Type">size_t</span>) r-&gt;headers_in.content_length_n;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;headers_in.content_length_n = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b-&gt;pos = b-&gt;last;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;headers_in.content_length_n -= size;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L782">&#x200c;</a><span class="linkable">ngx_http_test_expect</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a>&nbsp;&nbsp; n;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a>&nbsp; *expect;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;expect_tested<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; || r-&gt;headers_in.expect == <span class="Constant">NULL<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; || r-&gt;http_version &lt; <a href="ngx_http_request.h.html#L25" title="http/ngx_http_request.h:25">NGX_HTTP_VERSION_11</a>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;expect_tested = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; expect = &amp;r-&gt;headers_in.expect-&gt;value;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (expect-&gt;len != <span class="Statement">sizeof</span>(<span class="Constant">&quot;100-continue&quot;</span>) - <span class="Constant">1<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; || <a href="../core/ngx_string.c.html#L593" title="core/ngx_string.c:593">ngx_strncasecmp</a>(expect-&gt;data, (u_char *) <span class="Constant">&quot;100-continue&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Statement">sizeof</span>(<span class="Constant">&quot;100-continue&quot;</span>) - <span class="Constant">1</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; != <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L132" title="core/ngx_log.h:132">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;send 100 Continue&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; n = r-&gt;connection-&gt;send(r-&gt;connection,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (u_char *) <span class="Constant">&quot;HTTP/1.1 100 Continue&quot;</span> <a href="../core/ngx_core.h.html#L86" title="core/ngx_core.h:86">CRLF</a> <a href="../core/ngx_core.h.html#L86" title="core/ngx_core.h:86">CRLF</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">sizeof</span>(<span class="Constant">&quot;HTTP/1.1 100 Continue&quot;</span> <a href="../core/ngx_core.h.html#L86" title="core/ngx_core.h:86">CRLF</a> <a href="../core/ngx_core.h.html#L86" title="core/ngx_core.h:86">CRLF</a>) - <span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (n == <span class="Statement">sizeof</span>(<span class="Constant">&quot;HTTP/1.1 100 Continue&quot;</span> <a href="../core/ngx_core.h.html#L86" title="core/ngx_core.h:86">CRLF</a> <a href="../core/ngx_core.h.html#L86" title="core/ngx_core.h:86">CRLF</a>) - <span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* we assume that such small packet should be send successfully */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L824">&#x200c;</a><span class="linkable">ngx_http_request_body_filter</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="../core/ngx_core.h.html#L16" title="core/ngx_core.h:16">ngx_chain_t</a> *in)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;headers_in.chunked) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L905" title="http/ngx_http_request_body.c:905">ngx_http_request_body_chunked_filter</a>(r, in);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L836" title="http/ngx_http_request_body.c:836">ngx_http_request_body_length_filter</a>(r, in);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L836">&#x200c;</a><span class="linkable">ngx_http_request_body_length_filter</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="../core/ngx_core.h.html#L16" title="core/ngx_core.h:16">ngx_chain_t</a> *in)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; size;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *b;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L16" title="core/ngx_core.h:16">ngx_chain_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *cl, *tl, *out, **ll;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_request.h.html#L289" title="http/ngx_http_request.h:289">ngx_http_request_body_t</a>&nbsp;&nbsp; *rb;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rb = r-&gt;request_body;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rb-&gt;rest == -<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L132" title="core/ngx_log.h:132">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http request body content length filter&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rb-&gt;rest = r-&gt;headers_in.content_length_n;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; out = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; ll = &amp;out;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (cl = in; cl; cl = cl-&gt;next) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rb-&gt;rest == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; tl = <a href="../core/ngx_buf.c.html#L156" title="core/ngx_buf.c:156">ngx_chain_get_free_buf</a>(r-&gt;pool, &amp;rb-&gt;free);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (tl == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_http_request.h.html#L128" title="http/ngx_http_request.h:128">NGX_HTTP_INTERNAL_SERVER_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; b = tl-&gt;buf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_string.h.html#L86" title="core/ngx_string.h:86">ngx_memzero</a>(b, <span class="Statement">sizeof</span>(<a href="../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; b-&gt;temporary = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; b-&gt;tag = (<a href="../core/ngx_buf.h.html#L16" title="core/ngx_buf.h:16">ngx_buf_tag_t</a>) &amp;<a href="#L32" title="http/ngx_http_request_body.c:32">ngx_http_read_client_request_body</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; b-&gt;start = cl-&gt;buf-&gt;pos;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; b-&gt;pos = cl-&gt;buf-&gt;pos;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; b-&gt;last = cl-&gt;buf-&gt;last;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; b-&gt;end = cl-&gt;buf-&gt;end;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; size = cl-&gt;buf-&gt;last - cl-&gt;buf-&gt;pos;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((<span class="Type">off_t</span>) size &lt; rb-&gt;rest) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cl-&gt;buf-&gt;pos = cl-&gt;buf-&gt;last;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rb-&gt;rest -= size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cl-&gt;buf-&gt;pos += (<span class="Type">size_t</span>) rb-&gt;rest;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rb-&gt;rest = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b-&gt;last = cl-&gt;buf-&gt;pos;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b-&gt;last_buf = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *ll = tl;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ll = &amp;tl-&gt;next;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rc = <a href="#L1057" title="http/ngx_http_request_body.c:1057">ngx_http_request_body_save_filter</a>(r, out);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_buf.c.html#L184" title="core/ngx_buf.c:184">ngx_chain_update_chains</a>(r-&gt;pool, &amp;rb-&gt;free, &amp;rb-&gt;busy, &amp;out,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../core/ngx_buf.h.html#L16" title="core/ngx_buf.h:16">ngx_buf_tag_t</a>) &amp;<a href="#L32" title="http/ngx_http_request_body.c:32">ngx_http_read_client_request_body</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> rc;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L905">&#x200c;</a><span class="linkable">ngx_http_request_body_chunked_filter</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="../core/ngx_core.h.html#L16" title="core/ngx_core.h:16">ngx_chain_t</a> *in)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; size;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *b;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L16" title="core/ngx_core.h:16">ngx_chain_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *cl, *out, *tl, **ll;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_request.h.html#L289" title="http/ngx_http_request.h:289">ngx_http_request_body_t</a>&nbsp;&nbsp; *rb;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L53" title="http/ngx_http_core_module.h:53">ngx_http_core_loc_conf_t</a>&nbsp; *clcf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rb = r-&gt;request_body;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rb-&gt;rest == -<span class="Constant">1</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L132" title="core/ngx_log.h:132">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L30" title="core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http request body chunked filter&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rb-&gt;chunked = <a href="../core/ngx_palloc.c.html#L300" title="core/ngx_palloc.c:300">ngx_pcalloc</a>(r-&gt;pool, <span class="Statement">sizeof</span>(<a href="ngx_http.h.html#L21" title="http/ngx_http.h:21">ngx_http_chunked_t</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rb-&gt;chunked == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_http_request.h.html#L128" title="http/ngx_http_request.h:128">NGX_HTTP_INTERNAL_SERVER_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;headers_in.content_length_n = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rb-&gt;rest = <span class="Constant">3</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; out = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; ll = &amp;out;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (cl = in; cl; cl = cl-&gt;next) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> ( ;; ) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L155" title="core/ngx_log.h:155">ngx_log_debug7</a>(<a href="../core/ngx_log.h.html#L29" title="core/ngx_log.h:29">NGX_LOG_DEBUG_EVENT</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http body chunked buf &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;t:</span><span class="Special">%d</span><span class="Constant"> f:</span><span class="Special">%d</span><span class="Constant"> </span><span class="Special">%p</span><span class="Constant">, pos </span><span class="Special">%p</span><span class="Constant">, size: %z file: </span><span class="Special">%O</span><span class="Constant">, size: %z&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; cl-&gt;buf-&gt;temporary, cl-&gt;buf-&gt;in_file,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; cl-&gt;buf-&gt;start, cl-&gt;buf-&gt;pos,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; cl-&gt;buf-&gt;last - cl-&gt;buf-&gt;pos,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; cl-&gt;buf-&gt;file_pos,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; cl-&gt;buf-&gt;file_last - cl-&gt;buf-&gt;file_pos);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="ngx_http_parse.c.html#L2102" title="http/ngx_http_parse.c:2102">ngx_http_parse_chunked</a>(r, cl-&gt;buf, rb-&gt;chunked);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* a chunk has been parsed successfully */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; clcf = <a href="ngx_http_config.h.html#L58" title="http/ngx_http_config.h:58">ngx_http_get_module_loc_conf</a>(r, <a href="ngx_http_core_module.c.html#L811" title="http/ngx_http_core_module.c:811">ngx_http_core_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (clcf-&gt;client_max_body_size<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; clcf-&gt;client_max_body_size<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; - r-&gt;headers_in.content_length_n &lt; rb-&gt;chunked-&gt;size)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L20" title="core/ngx_log.h:20">NGX_LOG_ERR</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client intended to send too large chunked &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;body: </span><span class="Special">%O</span><span class="Constant">+</span><span class="Special">%O</span><span class="Constant"> bytes&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;headers_in.content_length_n,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rb-&gt;chunked-&gt;size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;lingering_close = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_http_request.h.html#L93" title="http/ngx_http_request.h:93">NGX_HTTP_REQUEST_ENTITY_TOO_LARGE</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tl = <a href="../core/ngx_buf.c.html#L156" title="core/ngx_buf.c:156">ngx_chain_get_free_buf</a>(r-&gt;pool, &amp;rb-&gt;free);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (tl == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_http_request.h.html#L128" title="http/ngx_http_request.h:128">NGX_HTTP_INTERNAL_SERVER_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b = tl-&gt;buf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_string.h.html#L86" title="core/ngx_string.h:86">ngx_memzero</a>(b, <span class="Statement">sizeof</span>(<a href="../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b-&gt;temporary = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b-&gt;tag = (<a href="../core/ngx_buf.h.html#L16" title="core/ngx_buf.h:16">ngx_buf_tag_t</a>) &amp;<a href="#L32" title="http/ngx_http_request_body.c:32">ngx_http_read_client_request_body</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b-&gt;start = cl-&gt;buf-&gt;pos;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b-&gt;pos = cl-&gt;buf-&gt;pos;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b-&gt;last = cl-&gt;buf-&gt;last;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b-&gt;end = cl-&gt;buf-&gt;end;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *ll = tl;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ll = &amp;tl-&gt;next;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; size = cl-&gt;buf-&gt;last - cl-&gt;buf-&gt;pos;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((<span class="Type">off_t</span>) size &gt; rb-&gt;chunked-&gt;size) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cl-&gt;buf-&gt;pos += (<span class="Type">size_t</span>) rb-&gt;chunked-&gt;size;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;headers_in.content_length_n += rb-&gt;chunked-&gt;size;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rb-&gt;chunked-&gt;size = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rb-&gt;chunked-&gt;size -= size;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;headers_in.content_length_n += size;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cl-&gt;buf-&gt;pos = cl-&gt;buf-&gt;last;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b-&gt;last = cl-&gt;buf-&gt;pos;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../core/ngx_core.h.html#L33" title="core/ngx_core.h:33">NGX_DONE</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* a whole response has been parsed successfully */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rb-&gt;rest = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tl = <a href="../core/ngx_buf.c.html#L156" title="core/ngx_buf.c:156">ngx_chain_get_free_buf</a>(r-&gt;pool, &amp;rb-&gt;free);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (tl == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_http_request.h.html#L128" title="http/ngx_http_request.h:128">NGX_HTTP_INTERNAL_SERVER_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b = tl-&gt;buf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_string.h.html#L86" title="core/ngx_string.h:86">ngx_memzero</a>(b, <span class="Statement">sizeof</span>(<a href="../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b-&gt;last_buf = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *ll = tl;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ll = &amp;tl-&gt;next;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../core/ngx_core.h.html#L31" title="core/ngx_core.h:31">NGX_AGAIN</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* <a href="../event/modules/ngx_rtsig_module.c.html#L75" title="event/modules/ngx_rtsig_module.c:75">set</a> rb-&gt;rest, amount of data we want to see next time */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rb-&gt;rest = rb-&gt;chunked-&gt;length;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* invalid */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L20" title="core/ngx_log.h:20">NGX_LOG_ERR</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client sent invalid chunked body&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_http_request.h.html#L84" title="http/ngx_http_request.h:84">NGX_HTTP_BAD_REQUEST</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rc = <a href="#L1057" title="http/ngx_http_request_body.c:1057">ngx_http_request_body_save_filter</a>(r, out);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_buf.c.html#L184" title="core/ngx_buf.c:184">ngx_chain_update_chains</a>(r-&gt;pool, &amp;rb-&gt;free, &amp;rb-&gt;busy, &amp;out,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../core/ngx_buf.h.html#L16" title="core/ngx_buf.h:16">ngx_buf_tag_t</a>) &amp;<a href="#L32" title="http/ngx_http_request_body.c:32">ngx_http_read_client_request_body</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> rc;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L1057">&#x200c;</a><span class="linkable">ngx_http_request_body_save_filter</span>(<a href="ngx_http.h.html#L16" title="http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="../core/ngx_core.h.html#L16" title="core/ngx_core.h:16">ngx_chain_t</a> *in)<br/></li>
<li>{<br/></li>
<li><span class="PreProc">#if (NGX_DEBUG)<br/></li>
<li></span>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L16" title="core/ngx_core.h:16">ngx_chain_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *cl;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; <a href="ngx_http_request.h.html#L289" title="http/ngx_http_request.h:289">ngx_http_request_body_t</a>&nbsp;&nbsp; *rb;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rb = r-&gt;request_body;<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_DEBUG)<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (cl = rb-&gt;bufs; cl; cl = cl-&gt;next) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L155" title="core/ngx_log.h:155">ngx_log_debug7</a>(<a href="../core/ngx_log.h.html#L29" title="core/ngx_log.h:29">NGX_LOG_DEBUG_EVENT</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http body old buf t:</span><span class="Special">%d</span><span class="Constant"> f:</span><span class="Special">%d</span><span class="Constant"> </span><span class="Special">%p</span><span class="Constant">, pos </span><span class="Special">%p</span><span class="Constant">, size: %z &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;file: </span><span class="Special">%O</span><span class="Constant">, size: %z&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; cl-&gt;buf-&gt;temporary, cl-&gt;buf-&gt;in_file,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; cl-&gt;buf-&gt;start, cl-&gt;buf-&gt;pos,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; cl-&gt;buf-&gt;last - cl-&gt;buf-&gt;pos,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; cl-&gt;buf-&gt;file_pos,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; cl-&gt;buf-&gt;file_last - cl-&gt;buf-&gt;file_pos);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (cl = in; cl; cl = cl-&gt;next) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L155" title="core/ngx_log.h:155">ngx_log_debug7</a>(<a href="../core/ngx_log.h.html#L29" title="core/ngx_log.h:29">NGX_LOG_DEBUG_EVENT</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http body new buf t:</span><span class="Special">%d</span><span class="Constant"> f:</span><span class="Special">%d</span><span class="Constant"> </span><span class="Special">%p</span><span class="Constant">, pos </span><span class="Special">%p</span><span class="Constant">, size: %z &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;file: </span><span class="Special">%O</span><span class="Constant">, size: %z&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; cl-&gt;buf-&gt;temporary, cl-&gt;buf-&gt;in_file,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; cl-&gt;buf-&gt;start, cl-&gt;buf-&gt;pos,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; cl-&gt;buf-&gt;last - cl-&gt;buf-&gt;pos,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; cl-&gt;buf-&gt;file_pos,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; cl-&gt;buf-&gt;file_last - cl-&gt;buf-&gt;file_pos);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* </span><span class="Todo">TODO</span><span class="Comment">: coalesce neighbouring buffers */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_buf.c.html#L127" title="core/ngx_buf.c:127">ngx_chain_add_copy</a>(r-&gt;pool, &amp;rb-&gt;bufs, in) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_http_request.h.html#L128" title="http/ngx_http_request.h:128">NGX_HTTP_INTERNAL_SERVER_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
</ol></code>
 </body>
</html>
