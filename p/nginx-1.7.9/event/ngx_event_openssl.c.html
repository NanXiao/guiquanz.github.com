<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>event/ngx_event_openssl.c - src</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

code {
    font-family: consolas, monospace;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
  <h3>event/ngx_event_openssl.c - src</h3>
   <a href="../index.html"> Table of Contents </a>
 <h4>Global variables defined</h4>
 <ul>
<li><a href="#L64">ngx_openssl_commands</a></li>
<li><a href="#L84">ngx_openssl_module</a></li>
<li><a href="#L77">ngx_openssl_module_ctx</a></li>
<li><a href="#L104">ngx_ssl_certificate_index</a></li>
<li><a href="#L100">ngx_ssl_connection_index</a></li>
<li><a href="#L101">ngx_ssl_server_conf_index</a></li>
<li><a href="#L102">ngx_ssl_session_cache_index</a></li>
<li><a href="#L103">ngx_ssl_session_ticket_keys_index</a></li>
<li><a href="#L105">ngx_ssl_stapling_index</a></li>
</ul>
 <h4>Data types defined</h4>
 <ul>
<li><a href="#L18">ngx_openssl_conf_t</a></li>
</ul>
 <h4>Functions defined</h4>
 <ul>
<li><a href="#L3449">ngx_openssl_create_conf</a></li>
<li><a href="#L3469">ngx_openssl_engine</a></li>
<li><a href="#L3517">ngx_openssl_exit</a></li>
<li><a href="#L289">ngx_ssl_certificate</a></li>
<li><a href="#L2916">ngx_ssl_check_host</a></li>
<li><a href="#L3045">ngx_ssl_check_name</a></li>
<li><a href="#L2907">ngx_ssl_cleanup_ctx</a></li>
<li><a href="#L1976">ngx_ssl_clear_error</a></li>
<li><a href="#L509">ngx_ssl_client_certificate</a></li>
<li><a href="#L1854">ngx_ssl_connection_error</a></li>
<li><a href="#L192">ngx_ssl_create</a></li>
<li><a href="#L1017">ngx_ssl_create_connection</a></li>
<li><a href="#L598">ngx_ssl_crl</a></li>
<li><a href="#L893">ngx_ssl_dhparam</a></li>
<li><a href="#L976">ngx_ssl_ecdh_curve</a></li>
<li><a href="#L1987">ngx_ssl_error</a></li>
<li><a href="#L2613">ngx_ssl_expire_sessions</a></li>
<li><a href="#L1738">ngx_ssl_free_buffer</a></li>
<li><a href="#L2416">ngx_ssl_get_cached_session</a></li>
<li><a href="#L3223">ngx_ssl_get_certificate</a></li>
<li><a href="#L3093">ngx_ssl_get_cipher_name</a></li>
<li><a href="#L3424">ngx_ssl_get_client_verify</a></li>
<li><a href="#L3390">ngx_ssl_get_fingerprint</a></li>
<li><a href="#L3309">ngx_ssl_get_issuer_dn</a></li>
<li><a href="#L3085">ngx_ssl_get_protocol</a></li>
<li><a href="#L3173">ngx_ssl_get_raw_certificate</a></li>
<li><a href="#L3351">ngx_ssl_get_serial_number</a></li>
<li><a href="#L3151">ngx_ssl_get_server_name</a></li>
<li><a href="#L3101">ngx_ssl_get_session_id</a></li>
<li><a href="#L3137">ngx_ssl_get_session_reused</a></li>
<li><a href="#L3267">ngx_ssl_get_subject_dn</a></li>
<li><a href="#L1379">ngx_ssl_handle_recv</a></li>
<li><a href="#L1074">ngx_ssl_handshake</a></li>
<li><a href="#L1219">ngx_ssl_handshake_handler</a></li>
<li><a href="#L687">ngx_ssl_info_callback</a></li>
<li><a href="#L109">ngx_ssl_init</a></li>
<li><a href="#L2267">ngx_ssl_new_session</a></li>
<li><a href="#L485">ngx_ssl_password_callback</a></li>
<li><a href="#L877">ngx_ssl_passwords_cleanup</a></li>
<li><a href="#L1727">ngx_ssl_read_handler</a></li>
<li><a href="#L751">ngx_ssl_read_password_file</a></li>
<li><a href="#L1301">ngx_ssl_recv</a></li>
<li><a href="#L1242">ngx_ssl_recv_chain</a></li>
<li><a href="#L2518">ngx_ssl_remove_cached_session</a></li>
<li><a href="#L2527">ngx_ssl_remove_session</a></li>
<li><a href="#L729">ngx_ssl_rsa512_key_callback</a></li>
<li><a href="#L1493">ngx_ssl_send_chain</a></li>
<li><a href="#L2039">ngx_ssl_session_cache</a></li>
<li><a href="#L2202">ngx_ssl_session_cache_init</a></li>
<li><a href="#L2112">ngx_ssl_session_id_context</a></li>
<li><a href="#L2653">ngx_ssl_session_rbtree_insert_value</a></li>
<li><a href="#L2818">ngx_ssl_session_ticket_key_callback</a></li>
<li><a href="#L2697">ngx_ssl_session_ticket_keys</a></li>
<li><a href="#L2893">ngx_ssl_session_ticket_keys</a></li>
<li><a href="#L1060">ngx_ssl_set_session</a></li>
<li><a href="#L1749">ngx_ssl_shutdown</a></li>
<li><a href="#L1831">ngx_ssl_shutdown_handler</a></li>
<li><a href="#L564">ngx_ssl_trusted_certificate</a></li>
<li><a href="#L643">ngx_ssl_verify_callback</a></li>
<li><a href="#L1650">ngx_ssl_write</a></li>
<li><a href="#L1474">ngx_ssl_write_handler</a></li>
</ul>
 <h4>Macros defined</h4>
 <ul>
<li><a href="#L13">NGX_SSL_PASSWORD_BUFFER_SIZE</a></li>
<li><a href="#L2811">ngx_ssl_session_ticket_md</a></li>
<li><a href="#L2813">ngx_ssl_session_ticket_md</a></li>
</ul>
 <h4>Source code</h4>

  <code><ol><li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Copyright (C) Igor Sysoev<br/></li>
<li></span><span class="Comment"> * Copyright (C) Nginx, Inc.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;ngx_config.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;ngx_core.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;ngx_event.h&gt;<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><a id="L13">&#x200c;</a><span class="PreProc">#define <span class="linkable">NGX_SSL_PASSWORD_BUFFER_SIZE</span>&nbsp; </span><span class="Constant">4096<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Type">typedef</span> <span class="Type">struct</span> {<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; engine;&nbsp;&nbsp; <span class="Comment">/* unsigned&nbsp; engine:1; */<br/></li>
<li><a id="L18">&#x200c;</a></span>} <span class="linkable">ngx_openssl_conf_t</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">int</span> <a href="#L485" title="event/ngx_event_openssl.c:485">ngx_ssl_password_callback</a>(<span class="Type">char</span> *buf, <span class="Type">int</span> size, <span class="Type">int</span> rwflag,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">void</span> *userdata);<br/></li>
<li><span class="Type">static</span> <span class="Type">int</span> <a href="#L643" title="event/ngx_event_openssl.c:643">ngx_ssl_verify_callback</a>(<span class="Type">int</span> ok, X509_STORE_CTX *x509_store);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L687" title="event/ngx_event_openssl.c:687">ngx_ssl_info_callback</a>(<span class="Type">const</span> <a href="ngx_event_openssl.h.html#L37" title="event/ngx_event_openssl.h:37">ngx_ssl_conn_t</a> *ssl_conn, <span class="Type">int</span> where,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span> ret);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L877" title="event/ngx_event_openssl.c:877">ngx_ssl_passwords_cleanup</a>(<span class="Type">void</span> *data);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L1219" title="event/ngx_event_openssl.c:1219">ngx_ssl_handshake_handler</a>(<a href="../core/ngx_core.h.html#L21" title="core/ngx_core.h:21">ngx_event_t</a> *ev);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L1379" title="event/ngx_event_openssl.c:1379">ngx_ssl_handle_recv</a>(<a href="../core/ngx_core.h.html#L23" title="core/ngx_core.h:23">ngx_connection_t</a> *c, <span class="Type">int</span> n);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L1474" title="event/ngx_event_openssl.c:1474">ngx_ssl_write_handler</a>(<a href="../core/ngx_core.h.html#L21" title="core/ngx_core.h:21">ngx_event_t</a> *wev);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L1727" title="event/ngx_event_openssl.c:1727">ngx_ssl_read_handler</a>(<a href="../core/ngx_core.h.html#L21" title="core/ngx_core.h:21">ngx_event_t</a> *rev);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L1831" title="event/ngx_event_openssl.c:1831">ngx_ssl_shutdown_handler</a>(<a href="../core/ngx_core.h.html#L21" title="core/ngx_core.h:21">ngx_event_t</a> *ev);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L1854" title="event/ngx_event_openssl.c:1854">ngx_ssl_connection_error</a>(<a href="../core/ngx_core.h.html#L23" title="core/ngx_core.h:23">ngx_connection_t</a> *c, <span class="Type">int</span> sslerr,<br/></li>
<li>&nbsp; &nbsp; <a href="../os/unix/ngx_errno.h.html#L16" title="os/unix/ngx_errno.h:16">ngx_err_t</a> err, <span class="Type">char</span> *text);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L1976" title="event/ngx_event_openssl.c:1976">ngx_ssl_clear_error</a>(<a href="../core/ngx_core.h.html#L17" title="core/ngx_core.h:17">ngx_log_t</a> *log);<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L2112" title="event/ngx_event_openssl.c:2112">ngx_ssl_session_id_context</a>(<a href="ngx_event_openssl.h.html#L44" title="event/ngx_event_openssl.h:44">ngx_ssl_t</a> *ssl,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a> *sess_ctx);<br/></li>
<li><a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L2202" title="event/ngx_event_openssl.c:2202">ngx_ssl_session_cache_init</a>(<a href="../core/ngx_cycle.h.html#L25" title="core/ngx_cycle.h:25">ngx_shm_zone_t</a> *shm_zone, <span class="Type">void</span> *data);<br/></li>
<li><span class="Type">static</span> <span class="Type">int</span> <a href="#L2267" title="event/ngx_event_openssl.c:2267">ngx_ssl_new_session</a>(<a href="ngx_event_openssl.h.html#L37" title="event/ngx_event_openssl.h:37">ngx_ssl_conn_t</a> *ssl_conn,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_event_openssl.h.html#L36" title="event/ngx_event_openssl.h:36">ngx_ssl_session_t</a> *sess);<br/></li>
<li><span class="Type">static</span> <a href="ngx_event_openssl.h.html#L36" title="event/ngx_event_openssl.h:36">ngx_ssl_session_t</a> *<a href="#L2416" title="event/ngx_event_openssl.c:2416">ngx_ssl_get_cached_session</a>(<a href="ngx_event_openssl.h.html#L37" title="event/ngx_event_openssl.h:37">ngx_ssl_conn_t</a> *ssl_conn,<br/></li>
<li>&nbsp; &nbsp; u_char *id, <span class="Type">int</span> len, <span class="Type">int</span> *copy);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L2527" title="event/ngx_event_openssl.c:2527">ngx_ssl_remove_session</a>(SSL_CTX *ssl, <a href="ngx_event_openssl.h.html#L36" title="event/ngx_event_openssl.h:36">ngx_ssl_session_t</a> *sess);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L2613" title="event/ngx_event_openssl.c:2613">ngx_ssl_expire_sessions</a>(<a href="ngx_event_openssl.h.html#L96" title="event/ngx_event_openssl.h:96">ngx_ssl_session_cache_t</a> *cache,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_slab.h.html#L47" title="core/ngx_slab.h:47">ngx_slab_pool_t</a> *shpool, <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> n);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L2653" title="event/ngx_event_openssl.c:2653">ngx_ssl_session_rbtree_insert_value</a>(<a href="../core/ngx_rbtree.h.html#L20" title="core/ngx_rbtree.h:20">ngx_rbtree_node_t</a> *temp,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_rbtree.h.html#L20" title="core/ngx_rbtree.h:20">ngx_rbtree_node_t</a> *node, <a href="../core/ngx_rbtree.h.html#L20" title="core/ngx_rbtree.h:20">ngx_rbtree_node_t</a> *sentinel);<br/></li>
<li><br/></li>
<li><span class="PreProc">#ifdef SSL_CTRL_SET_TLSEXT_TICKET_KEY_CB<br/></li>
<li></span><span class="Type">static</span> <span class="Type">int</span> <a href="#L2818" title="event/ngx_event_openssl.c:2818">ngx_ssl_session_ticket_key_callback</a>(<a href="ngx_event_openssl.h.html#L37" title="event/ngx_event_openssl.h:37">ngx_ssl_conn_t</a> *ssl_conn,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">unsigned</span> <span class="Type">char</span> *name, <span class="Type">unsigned</span> <span class="Type">char</span> *iv, EVP_CIPHER_CTX *ectx,<br/></li>
<li>&nbsp; &nbsp; HMAC_CTX *hctx, <span class="Type">int</span> enc);<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#if (OPENSSL_VERSION_NUMBER &lt; </span><span class="Constant">0x10002002L</span><span class="PreProc"> || defined LIBRESSL_VERSION_NUMBER)<br/></li>
<li></span><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> <a href="#L3045" title="event/ngx_event_openssl.c:3045">ngx_ssl_check_name</a>(<a href="../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a> *name, ASN1_STRING *str);<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> *<a href="#L3449" title="event/ngx_event_openssl.c:3449">ngx_openssl_create_conf</a>(<a href="../core/ngx_core.h.html#L14" title="core/ngx_core.h:14">ngx_cycle_t</a> *cycle);<br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<a href="#L3469" title="event/ngx_event_openssl.c:3469">ngx_openssl_engine</a>(<a href="../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="../core/ngx_core.h.html#L19" title="core/ngx_core.h:19">ngx_command_t</a> *cmd, <span class="Type">void</span> *conf);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L3517" title="event/ngx_event_openssl.c:3517">ngx_openssl_exit</a>(<a href="../core/ngx_core.h.html#L14" title="core/ngx_core.h:14">ngx_cycle_t</a> *cycle);<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L64">&#x200c;</a><span class="Type">static</span> <a href="../core/ngx_core.h.html#L19" title="core/ngx_core.h:19">ngx_command_t</a>&nbsp; <span class="linkable">ngx_openssl_commands</span>[] = {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;ssl_engine&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../core/ngx_conf_file.h.html#L52" title="core/ngx_conf_file.h:52">NGX_MAIN_CONF</a>|<a href="../core/ngx_conf_file.h.html#L50" title="core/ngx_conf_file.h:50">NGX_DIRECT_CONF</a>|<a href="../core/ngx_conf_file.h.html#L23" title="core/ngx_conf_file.h:23">NGX_CONF_TAKE1</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L3469" title="event/ngx_event_openssl.c:3469">ngx_openssl_engine</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">NULL</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../core/ngx_conf_file.h.html#L87" title="core/ngx_conf_file.h:87">ngx_null_command</a><br/></li>
<li>};<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L77">&#x200c;</a><span class="Type">static</span> <a href="../core/ngx_conf_file.h.html#L143" title="core/ngx_conf_file.h:143">ngx_core_module_t</a>&nbsp; <span class="linkable">ngx_openssl_module_ctx</span> = {<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L40" title="core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;openssl&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; <a href="#L3449" title="event/ngx_event_openssl.c:3449">ngx_openssl_create_conf</a>,<br/></li>
<li>&nbsp; &nbsp; <span class="Constant">NULL<br/></li>
<li></span>};<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L84">&#x200c;</a><a href="../core/ngx_core.h.html#L12" title="core/ngx_core.h:12">ngx_module_t</a>&nbsp; <span class="linkable">ngx_openssl_module</span> = {<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_conf_file.h.html#L99" title="core/ngx_conf_file.h:99">NGX_MODULE_V1</a>,<br/></li>
<li>&nbsp; &nbsp; &amp;<a href="#L77" title="event/ngx_event_openssl.c:77">ngx_openssl_module_ctx</a>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">/* module context */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L64" title="event/ngx_event_openssl.c:64">ngx_openssl_commands</a>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* module directives */<br/></li>
<li></span>&nbsp; &nbsp; <a href="../core/ngx_conf_file.h.html#L71" title="core/ngx_conf_file.h:71">NGX_CORE_MODULE</a>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">/* module type */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* init master */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* init module */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* init process */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* init thread */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* exit thread */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* exit process */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L3517" title="event/ngx_event_openssl.c:3517">ngx_openssl_exit</a>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* exit master */<br/></li>
<li></span>&nbsp; &nbsp; <a href="../core/ngx_conf_file.h.html#L100" title="core/ngx_conf_file.h:100">NGX_MODULE_V1_PADDING</a><br/></li>
<li>};<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L100">&#x200c;</a><span class="Type">int</span>&nbsp; <span class="linkable">ngx_ssl_connection_index</span>;<br/></li>
<li><a id="L101">&#x200c;</a><span class="Type">int</span>&nbsp; <span class="linkable">ngx_ssl_server_conf_index</span>;<br/></li>
<li><a id="L102">&#x200c;</a><span class="Type">int</span>&nbsp; <span class="linkable">ngx_ssl_session_cache_index</span>;<br/></li>
<li><a id="L103">&#x200c;</a><span class="Type">int</span>&nbsp; <span class="linkable">ngx_ssl_session_ticket_keys_index</span>;<br/></li>
<li><a id="L104">&#x200c;</a><span class="Type">int</span>&nbsp; <span class="linkable">ngx_ssl_certificate_index</span>;<br/></li>
<li><a id="L105">&#x200c;</a><span class="Type">int</span>&nbsp; <span class="linkable">ngx_ssl_stapling_index</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L109">&#x200c;</a><span class="linkable">ngx_ssl_init</span>(<a href="../core/ngx_core.h.html#L17" title="core/ngx_core.h:17">ngx_log_t</a> *log)<br/></li>
<li>{<br/></li>
<li><span class="PreProc">#ifndef OPENSSL_IS_BORINGSSL<br/></li>
<li></span>&nbsp; &nbsp; OPENSSL_config(<span class="Constant">NULL</span>);<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; SSL_library_init();<br/></li>
<li>&nbsp; &nbsp; SSL_load_error_strings();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; OpenSSL_add_all_algorithms();<br/></li>
<li><br/></li>
<li><span class="PreProc">#if OPENSSL_VERSION_NUMBER &gt;= </span><span class="Constant">0x0090800fL<br/></li>
<li></span><span class="PreProc">#ifndef SSL_OP_NO_COMPRESSION<br/></li>
<li></span>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Disable gzip compression in OpenSSL prior to 1.0.0 version,<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * this saves about 522K per connection.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n;<br/></li>
<li>&nbsp; &nbsp; STACK_OF(SSL_COMP)&nbsp; *ssl_comp_methods;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ssl_comp_methods = SSL_COMP_get_compression_methods();<br/></li>
<li>&nbsp; &nbsp; n = sk_SSL_COMP_num(ssl_comp_methods);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (n--) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; (<span class="Type">void</span>) sk_SSL_COMP_pop(ssl_comp_methods);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="#L100" title="event/ngx_event_openssl.c:100">ngx_ssl_connection_index</a> = SSL_get_ex_new_index(<span class="Constant">0</span>, <span class="Constant">NULL</span>, <span class="Constant">NULL</span>, <span class="Constant">NULL</span>, <span class="Constant">NULL</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L100" title="event/ngx_event_openssl.c:100">ngx_ssl_connection_index</a> == -<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1987" title="event/ngx_event_openssl.c:1987">ngx_ssl_error</a>(<a href="../core/ngx_log.h.html#L18" title="core/ngx_log.h:18">NGX_LOG_ALERT</a>, log, <span class="Constant">0</span>, <span class="Constant">&quot;SSL_get_ex_new_index() failed&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L101" title="event/ngx_event_openssl.c:101">ngx_ssl_server_conf_index</a> = SSL_CTX_get_ex_new_index(<span class="Constant">0</span>, <span class="Constant">NULL</span>, <span class="Constant">NULL</span>, <span class="Constant">NULL</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L101" title="event/ngx_event_openssl.c:101">ngx_ssl_server_conf_index</a> == -<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1987" title="event/ngx_event_openssl.c:1987">ngx_ssl_error</a>(<a href="../core/ngx_log.h.html#L18" title="core/ngx_log.h:18">NGX_LOG_ALERT</a>, log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;SSL_CTX_get_ex_new_index() failed&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L102" title="event/ngx_event_openssl.c:102">ngx_ssl_session_cache_index</a> = SSL_CTX_get_ex_new_index(<span class="Constant">0</span>, <span class="Constant">NULL</span>, <span class="Constant">NULL</span>, <span class="Constant">NULL</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L102" title="event/ngx_event_openssl.c:102">ngx_ssl_session_cache_index</a> == -<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1987" title="event/ngx_event_openssl.c:1987">ngx_ssl_error</a>(<a href="../core/ngx_log.h.html#L18" title="core/ngx_log.h:18">NGX_LOG_ALERT</a>, log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;SSL_CTX_get_ex_new_index() failed&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L103" title="event/ngx_event_openssl.c:103">ngx_ssl_session_ticket_keys_index</a> = SSL_CTX_get_ex_new_index(<span class="Constant">0</span>, <span class="Constant">NULL</span>, <span class="Constant">NULL</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">NULL</span>, <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L103" title="event/ngx_event_openssl.c:103">ngx_ssl_session_ticket_keys_index</a> == -<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1987" title="event/ngx_event_openssl.c:1987">ngx_ssl_error</a>(<a href="../core/ngx_log.h.html#L18" title="core/ngx_log.h:18">NGX_LOG_ALERT</a>, log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;SSL_CTX_get_ex_new_index() failed&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L104" title="event/ngx_event_openssl.c:104">ngx_ssl_certificate_index</a> = SSL_CTX_get_ex_new_index(<span class="Constant">0</span>, <span class="Constant">NULL</span>, <span class="Constant">NULL</span>, <span class="Constant">NULL</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L104" title="event/ngx_event_openssl.c:104">ngx_ssl_certificate_index</a> == -<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1987" title="event/ngx_event_openssl.c:1987">ngx_ssl_error</a>(<a href="../core/ngx_log.h.html#L18" title="core/ngx_log.h:18">NGX_LOG_ALERT</a>, log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;SSL_CTX_get_ex_new_index() failed&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L105" title="event/ngx_event_openssl.c:105">ngx_ssl_stapling_index</a> = SSL_CTX_get_ex_new_index(<span class="Constant">0</span>, <span class="Constant">NULL</span>, <span class="Constant">NULL</span>, <span class="Constant">NULL</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L105" title="event/ngx_event_openssl.c:105">ngx_ssl_stapling_index</a> == -<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1987" title="event/ngx_event_openssl.c:1987">ngx_ssl_error</a>(<a href="../core/ngx_log.h.html#L18" title="core/ngx_log.h:18">NGX_LOG_ALERT</a>, log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;SSL_CTX_get_ex_new_index() failed&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L192">&#x200c;</a><span class="linkable">ngx_ssl_create</span>(<a href="ngx_event_openssl.h.html#L44" title="event/ngx_event_openssl.h:44">ngx_ssl_t</a> *ssl, <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> protocols, <span class="Type">void</span> *data)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; ssl-&gt;ctx = SSL_CTX_new(SSLv23_method());<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ssl-&gt;ctx == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1987" title="event/ngx_event_openssl.c:1987">ngx_ssl_error</a>(<a href="../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, ssl-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;SSL_CTX_new() failed&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (SSL_CTX_set_ex_data(ssl-&gt;ctx, <a href="#L101" title="event/ngx_event_openssl.c:101">ngx_ssl_server_conf_index</a>, data) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1987" title="event/ngx_event_openssl.c:1987">ngx_ssl_error</a>(<a href="../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, ssl-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;SSL_CTX_set_ex_data() failed&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ssl-&gt;buffer_size = <a href="ngx_event_openssl.h.html#L120" title="event/ngx_event_openssl.h:120">NGX_SSL_BUFSIZE</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* client side options */<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#ifdef SSL_OP_MICROSOFT_SESS_ID_BUG<br/></li>
<li></span>&nbsp; &nbsp; SSL_CTX_set_options(ssl-&gt;ctx, SSL_OP_MICROSOFT_SESS_ID_BUG);<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#ifdef SSL_OP_NETSCAPE_CHALLENGE_BUG<br/></li>
<li></span>&nbsp; &nbsp; SSL_CTX_set_options(ssl-&gt;ctx, SSL_OP_NETSCAPE_CHALLENGE_BUG);<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* server side options */<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#ifdef SSL_OP_SSLREF2_REUSE_CERT_TYPE_BUG<br/></li>
<li></span>&nbsp; &nbsp; SSL_CTX_set_options(ssl-&gt;ctx, SSL_OP_SSLREF2_REUSE_CERT_TYPE_BUG);<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#ifdef SSL_OP_MICROSOFT_BIG_SSLV3_BUFFER<br/></li>
<li></span>&nbsp; &nbsp; SSL_CTX_set_options(ssl-&gt;ctx, SSL_OP_MICROSOFT_BIG_SSLV3_BUFFER);<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#ifdef SSL_OP_MSIE_SSLV2_RSA_PADDING<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">/* this option allow a potential SSL 2.0 rollback (CAN-2005-2969) */<br/></li>
<li></span>&nbsp; &nbsp; SSL_CTX_set_options(ssl-&gt;ctx, SSL_OP_MSIE_SSLV2_RSA_PADDING);<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#ifdef SSL_OP_SSLEAY_080_CLIENT_DH_BUG<br/></li>
<li></span>&nbsp; &nbsp; SSL_CTX_set_options(ssl-&gt;ctx, SSL_OP_SSLEAY_080_CLIENT_DH_BUG);<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#ifdef SSL_OP_TLS_D5_BUG<br/></li>
<li></span>&nbsp; &nbsp; SSL_CTX_set_options(ssl-&gt;ctx, SSL_OP_TLS_D5_BUG);<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#ifdef SSL_OP_TLS_BLOCK_PADDING_BUG<br/></li>
<li></span>&nbsp; &nbsp; SSL_CTX_set_options(ssl-&gt;ctx, SSL_OP_TLS_BLOCK_PADDING_BUG);<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#ifdef SSL_OP_DONT_INSERT_EMPTY_FRAGMENTS<br/></li>
<li></span>&nbsp; &nbsp; SSL_CTX_set_options(ssl-&gt;ctx, SSL_OP_DONT_INSERT_EMPTY_FRAGMENTS);<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; SSL_CTX_set_options(ssl-&gt;ctx, SSL_OP_SINGLE_DH_USE);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!(protocols &amp; <a href="ngx_event_openssl.h.html#L110" title="event/ngx_event_openssl.h:110">NGX_SSL_SSLv2</a>)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; SSL_CTX_set_options(ssl-&gt;ctx, SSL_OP_NO_SSLv2);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!(protocols &amp; <a href="ngx_event_openssl.h.html#L111" title="event/ngx_event_openssl.h:111">NGX_SSL_SSLv3</a>)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; SSL_CTX_set_options(ssl-&gt;ctx, SSL_OP_NO_SSLv3);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!(protocols &amp; <a href="ngx_event_openssl.h.html#L112" title="event/ngx_event_openssl.h:112">NGX_SSL_TLSv1</a>)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; SSL_CTX_set_options(ssl-&gt;ctx, SSL_OP_NO_TLSv1);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#ifdef SSL_OP_NO_TLSv1_1<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (!(protocols &amp; <a href="ngx_event_openssl.h.html#L113" title="event/ngx_event_openssl.h:113">NGX_SSL_TLSv1_1</a>)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; SSL_CTX_set_options(ssl-&gt;ctx, SSL_OP_NO_TLSv1_1);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><span class="PreProc">#ifdef SSL_OP_NO_TLSv1_2<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (!(protocols &amp; <a href="ngx_event_openssl.h.html#L114" title="event/ngx_event_openssl.h:114">NGX_SSL_TLSv1_2</a>)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; SSL_CTX_set_options(ssl-&gt;ctx, SSL_OP_NO_TLSv1_2);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#ifdef SSL_OP_NO_COMPRESSION<br/></li>
<li></span>&nbsp; &nbsp; SSL_CTX_set_options(ssl-&gt;ctx, SSL_OP_NO_COMPRESSION);<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#ifdef SSL_MODE_RELEASE_BUFFERS<br/></li>
<li></span>&nbsp; &nbsp; SSL_CTX_set_mode(ssl-&gt;ctx, SSL_MODE_RELEASE_BUFFERS);<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; SSL_CTX_set_read_ahead(ssl-&gt;ctx, <span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; SSL_CTX_set_info_callback(ssl-&gt;ctx, <a href="#L687" title="event/ngx_event_openssl.c:687">ngx_ssl_info_callback</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L289">&#x200c;</a><span class="linkable">ngx_ssl_certificate</span>(<a href="../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="ngx_event_openssl.h.html#L44" title="event/ngx_event_openssl.h:44">ngx_ssl_t</a> *ssl, <a href="../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a> *cert,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a> *key, <a href="../core/ngx_array.h.html#L22" title="core/ngx_array.h:22">ngx_array_t</a> *passwords)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; BIO&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *bio;<br/></li>
<li>&nbsp; &nbsp; X509&nbsp; &nbsp; &nbsp; &nbsp; *x509;<br/></li>
<li>&nbsp; &nbsp; u_long&nbsp; &nbsp; &nbsp;&nbsp; n;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a>&nbsp;&nbsp; *pwd;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp;&nbsp; tries;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_conf_file.c.html#L804" title="core/ngx_conf_file.c:804">ngx_conf_full_name</a>(cf-&gt;cycle, cert, <span class="Constant">1</span>) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * we can't use SSL_CTX_use_certificate_chain_file() as it doesn't<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * allow to access certificate later from SSL_CTX, so we reimplement<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * it here<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; bio = BIO_new_file((<span class="Type">char</span> *) cert-&gt;data, <span class="Constant">&quot;r&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (bio == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1987" title="event/ngx_event_openssl.c:1987">ngx_ssl_error</a>(<a href="../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, ssl-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;BIO_new_file(</span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">) failed&quot;</span>, cert-&gt;data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; x509 = PEM_read_bio_X509_AUX(bio, <span class="Constant">NULL</span>, <span class="Constant">NULL</span>, <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (x509 == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1987" title="event/ngx_event_openssl.c:1987">ngx_ssl_error</a>(<a href="../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, ssl-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;PEM_read_bio_X509_AUX(</span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">) failed&quot;</span>, cert-&gt;data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; BIO_free(bio);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (SSL_CTX_use_certificate(ssl-&gt;ctx, x509) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1987" title="event/ngx_event_openssl.c:1987">ngx_ssl_error</a>(<a href="../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, ssl-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;SSL_CTX_use_certificate(</span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">) failed&quot;</span>, cert-&gt;data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; X509_free(x509);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; BIO_free(bio);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (SSL_CTX_set_ex_data(ssl-&gt;ctx, <a href="#L104" title="event/ngx_event_openssl.c:104">ngx_ssl_certificate_index</a>, x509)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1987" title="event/ngx_event_openssl.c:1987">ngx_ssl_error</a>(<a href="../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, ssl-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;SSL_CTX_set_ex_data() failed&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; X509_free(x509);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; BIO_free(bio);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; X509_free(x509);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* read rest of the chain */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> ( ;; ) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; x509 = PEM_read_bio_X509(bio, <span class="Constant">NULL</span>, <span class="Constant">NULL</span>, <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (x509 == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n = ERR_peek_last_error();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ERR_GET_LIB(n) == ERR_LIB_PEM<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; ERR_GET_REASON(n) == PEM_R_NO_START_LINE)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* end of file */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ERR_clear_error();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* some real error */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1987" title="event/ngx_event_openssl.c:1987">ngx_ssl_error</a>(<a href="../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, ssl-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;PEM_read_bio_X509(</span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">) failed&quot;</span>, cert-&gt;data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; BIO_free(bio);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (SSL_CTX_add_extra_chain_cert(ssl-&gt;ctx, x509) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1987" title="event/ngx_event_openssl.c:1987">ngx_ssl_error</a>(<a href="../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, ssl-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;SSL_CTX_add_extra_chain_cert(</span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">) failed&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cert-&gt;data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; X509_free(x509);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; BIO_free(bio);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; BIO_free(bio);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_string.h.html#L53" title="core/ngx_string.h:53">ngx_strncmp</a>(key-&gt;data, <span class="Constant">&quot;engine:&quot;</span>, <span class="Statement">sizeof</span>(<span class="Constant">&quot;engine:&quot;</span>) - <span class="Constant">1</span>) == <span class="Constant">0</span>) {<br/></li>
<li><br/></li>
<li><span class="PreProc">#ifndef OPENSSL_NO_ENGINE<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; *p, *last;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ENGINE&nbsp; &nbsp; &nbsp; *engine;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; EVP_PKEY&nbsp; &nbsp; *pkey;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p = key-&gt;data + <span class="Statement">sizeof</span>(<span class="Constant">&quot;engine:&quot;</span>) - <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; last = (u_char *) <a href="../core/ngx_string.h.html#L63" title="core/ngx_string.h:63">ngx_strchr</a>(p, <span class="Constant">':'</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (last == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;invalid syntax in </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, key);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *last = <span class="Special">'\0'</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; engine = ENGINE_by_id((<span class="Type">char</span> *) p);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (engine == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1987" title="event/ngx_event_openssl.c:1987">ngx_ssl_error</a>(<a href="../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, ssl-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;ENGINE_by_id(</span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">) failed&quot;</span>, p);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *last++ = <span class="Constant">':'</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; pkey = ENGINE_load_private_key(engine, (<span class="Type">char</span> *) last, <span class="Constant">0</span>, <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (pkey == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1987" title="event/ngx_event_openssl.c:1987">ngx_ssl_error</a>(<a href="../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, ssl-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;ENGINE_load_private_key(</span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">) failed&quot;</span>, last);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ENGINE_free(engine);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ENGINE_free(engine);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (SSL_CTX_use_PrivateKey(ssl-&gt;ctx, pkey) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1987" title="event/ngx_event_openssl.c:1987">ngx_ssl_error</a>(<a href="../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, ssl-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;SSL_CTX_use_PrivateKey(</span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">) failed&quot;</span>, last);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; EVP_PKEY_free(pkey);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; EVP_PKEY_free(pkey);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li><br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;loading </span><span class="Special">\&quot;</span><span class="Constant">engine:...</span><span class="Special">\&quot;</span><span class="Constant"> certificate keys &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;is not supported&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_conf_file.c.html#L804" title="core/ngx_conf_file.c:804">ngx_conf_full_name</a>(cf-&gt;cycle, key, <span class="Constant">1</span>) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (passwords) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; tries = passwords-&gt;nelts;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; pwd = passwords-&gt;elts;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; SSL_CTX_set_default_passwd_cb(ssl-&gt;ctx, <a href="#L485" title="event/ngx_event_openssl.c:485">ngx_ssl_password_callback</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; SSL_CTX_set_default_passwd_cb_userdata(ssl-&gt;ctx, pwd);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; tries = <span class="Constant">1</span>;<br/></li>
<li><span class="PreProc">#if (NGX_SUPPRESS_WARN)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; pwd = <span class="Constant">NULL</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> ( ;; ) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (SSL_CTX_use_PrivateKey_file(ssl-&gt;ctx, (<span class="Type">char</span> *) key-&gt;data,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; SSL_FILETYPE_PEM)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; != <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (--tries) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ERR_clear_error();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; SSL_CTX_set_default_passwd_cb_userdata(ssl-&gt;ctx, ++pwd);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1987" title="event/ngx_event_openssl.c:1987">ngx_ssl_error</a>(<a href="../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, ssl-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;SSL_CTX_use_PrivateKey_file(</span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">) failed&quot;</span>, key-&gt;data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; SSL_CTX_set_default_passwd_cb(ssl-&gt;ctx, <span class="Constant">NULL</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">int<br/></li>
<li><a id="L485">&#x200c;</a></span><span class="linkable">ngx_ssl_password_callback</span>(<span class="Type">char</span> *buf, <span class="Type">int</span> size, <span class="Type">int</span> rwflag, <span class="Type">void</span> *userdata)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a> *pwd = userdata;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rwflag) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L18" title="core/ngx_log.h:18">NGX_LOG_ALERT</a>, <a href="../core/ngx_cycle.c.html#L20" title="core/ngx_cycle.c:20">ngx_cycle</a>-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;<a href="#L485" title="event/ngx_event_openssl.c:485">ngx_ssl_password_callback</a>() is called for encryption&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (pwd-&gt;len &gt; (<span class="Type">size_t</span>) size) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L20" title="core/ngx_log.h:20">NGX_LOG_ERR</a>, <a href="../core/ngx_cycle.c.html#L20" title="core/ngx_cycle.c:20">ngx_cycle</a>-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;password is truncated to </span><span class="Special">%d</span><span class="Constant"> bytes&quot;</span>, size);<br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; size = pwd-&gt;len;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.c.html#L1947" title="core/ngx_string.c:1947">ngx_memcpy</a>(buf, pwd-&gt;data, size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> size;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L509">&#x200c;</a><span class="linkable">ngx_ssl_client_certificate</span>(<a href="../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="ngx_event_openssl.h.html#L44" title="event/ngx_event_openssl.h:44">ngx_ssl_t</a> *ssl, <a href="../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a> *cert,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> depth)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; STACK_OF(X509_NAME)&nbsp; *list;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; SSL_CTX_set_verify(ssl-&gt;ctx, SSL_VERIFY_PEER, <a href="#L643" title="event/ngx_event_openssl.c:643">ngx_ssl_verify_callback</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; SSL_CTX_set_verify_depth(ssl-&gt;ctx, depth);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cert-&gt;len == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_conf_file.c.html#L804" title="core/ngx_conf_file.c:804">ngx_conf_full_name</a>(cf-&gt;cycle, cert, <span class="Constant">1</span>) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (SSL_CTX_load_verify_locations(ssl-&gt;ctx, (<span class="Type">char</span> *) cert-&gt;data, <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1987" title="event/ngx_event_openssl.c:1987">ngx_ssl_error</a>(<a href="../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, ssl-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;SSL_CTX_load_verify_locations(</span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">) failed&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cert-&gt;data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * SSL_CTX_load_verify_locations() may leave errors in the error queue<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * while returning success<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; ERR_clear_error();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; list = SSL_load_client_CA_file((<span class="Type">char</span> *) cert-&gt;data);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (list == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1987" title="event/ngx_event_openssl.c:1987">ngx_ssl_error</a>(<a href="../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, ssl-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;SSL_load_client_CA_file(</span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">) failed&quot;</span>, cert-&gt;data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * before 0.9.7h and 0.9.8 SSL_load_client_CA_file()<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * always leaved an error in the error queue<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; ERR_clear_error();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; SSL_CTX_set_client_CA_list(ssl-&gt;ctx, list);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L564">&#x200c;</a><span class="linkable">ngx_ssl_trusted_certificate</span>(<a href="../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="ngx_event_openssl.h.html#L44" title="event/ngx_event_openssl.h:44">ngx_ssl_t</a> *ssl, <a href="../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a> *cert,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a> depth)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; SSL_CTX_set_verify_depth(ssl-&gt;ctx, depth);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cert-&gt;len == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_conf_file.c.html#L804" title="core/ngx_conf_file.c:804">ngx_conf_full_name</a>(cf-&gt;cycle, cert, <span class="Constant">1</span>) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (SSL_CTX_load_verify_locations(ssl-&gt;ctx, (<span class="Type">char</span> *) cert-&gt;data, <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1987" title="event/ngx_event_openssl.c:1987">ngx_ssl_error</a>(<a href="../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, ssl-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;SSL_CTX_load_verify_locations(</span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">) failed&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cert-&gt;data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * SSL_CTX_load_verify_locations() may leave errors in the error queue<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * while returning success<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; ERR_clear_error();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L598">&#x200c;</a><span class="linkable">ngx_ssl_crl</span>(<a href="../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="ngx_event_openssl.h.html#L44" title="event/ngx_event_openssl.h:44">ngx_ssl_t</a> *ssl, <a href="../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a> *crl)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; X509_STORE&nbsp;&nbsp; *store;<br/></li>
<li>&nbsp; &nbsp; X509_LOOKUP&nbsp; *lookup;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (crl-&gt;len == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_conf_file.c.html#L804" title="core/ngx_conf_file.c:804">ngx_conf_full_name</a>(cf-&gt;cycle, crl, <span class="Constant">1</span>) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; store = SSL_CTX_get_cert_store(ssl-&gt;ctx);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (store == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1987" title="event/ngx_event_openssl.c:1987">ngx_ssl_error</a>(<a href="../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, ssl-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;SSL_CTX_get_cert_store() failed&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; lookup = X509_STORE_add_lookup(store, X509_LOOKUP_file());<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (lookup == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1987" title="event/ngx_event_openssl.c:1987">ngx_ssl_error</a>(<a href="../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, ssl-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;X509_STORE_add_lookup() failed&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (X509_LOOKUP_load_file(lookup, (<span class="Type">char</span> *) crl-&gt;data, X509_FILETYPE_PEM)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1987" title="event/ngx_event_openssl.c:1987">ngx_ssl_error</a>(<a href="../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, ssl-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;X509_LOOKUP_load_file(</span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">) failed&quot;</span>, crl-&gt;data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; X509_STORE_set_flags(store,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; X509_V_FLAG_CRL_CHECK|X509_V_FLAG_CRL_CHECK_ALL);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">int<br/></li>
<li><a id="L643">&#x200c;</a></span><span class="linkable">ngx_ssl_verify_callback</span>(<span class="Type">int</span> ok, X509_STORE_CTX *x509_store)<br/></li>
<li>{<br/></li>
<li><span class="PreProc">#if (NGX_DEBUG)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *subject, *issuer;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; err, depth;<br/></li>
<li>&nbsp; &nbsp; X509&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *cert;<br/></li>
<li>&nbsp; &nbsp; X509_NAME&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *sname, *iname;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L23" title="core/ngx_core.h:23">ngx_connection_t</a>&nbsp; *c;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_event_openssl.h.html#L37" title="event/ngx_event_openssl.h:37">ngx_ssl_conn_t</a>&nbsp; &nbsp; *ssl_conn;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ssl_conn = X509_STORE_CTX_get_ex_data(x509_store,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; SSL_get_ex_data_X509_STORE_CTX_idx());<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c = <a href="ngx_event_openssl.h.html#L153" title="event/ngx_event_openssl.h:153">ngx_ssl_get_connection</a>(ssl_conn);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cert = X509_STORE_CTX_get_current_cert(x509_store);<br/></li>
<li>&nbsp; &nbsp; err = X509_STORE_CTX_get_error(x509_store);<br/></li>
<li>&nbsp; &nbsp; depth = X509_STORE_CTX_get_error_depth(x509_store);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; sname = X509_get_subject_name(cert);<br/></li>
<li>&nbsp; &nbsp; subject = sname ? X509_NAME_oneline(sname, <span class="Constant">NULL</span>, <span class="Constant">0</span>) : <span class="Constant">&quot;(none)&quot;</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; iname = X509_get_issuer_name(cert);<br/></li>
<li>&nbsp; &nbsp; issuer = iname ? X509_NAME_oneline(iname, <span class="Constant">NULL</span>, <span class="Constant">0</span>) : <span class="Constant">&quot;(none)&quot;</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L147" title="core/ngx_log.h:147">ngx_log_debug5</a>(<a href="../core/ngx_log.h.html#L29" title="core/ngx_log.h:29">NGX_LOG_DEBUG_EVENT</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;verify:</span><span class="Special">%d</span><span class="Constant">, error:</span><span class="Special">%d</span><span class="Constant">, depth:</span><span class="Special">%d</span><span class="Constant">, &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;subject:</span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">, issuer:</span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ok, err, depth, subject, issuer);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (sname) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; OPENSSL_free(subject);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (iname) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; OPENSSL_free(issuer);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">1</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L687">&#x200c;</a></span><span class="linkable">ngx_ssl_info_callback</span>(<span class="Type">const</span> <a href="ngx_event_openssl.h.html#L37" title="event/ngx_event_openssl.h:37">ngx_ssl_conn_t</a> *ssl_conn, <span class="Type">int</span> where, <span class="Type">int</span> ret)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; BIO&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *rbio, *wbio;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L23" title="core/ngx_core.h:23">ngx_connection_t</a>&nbsp; *c;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (where &amp; SSL_CB_HANDSHAKE_START) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c = <a href="ngx_event_openssl.h.html#L153" title="event/ngx_event_openssl.h:153">ngx_ssl_get_connection</a>((<a href="ngx_event_openssl.h.html#L37" title="event/ngx_event_openssl.h:37">ngx_ssl_conn_t</a> *) ssl_conn);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;ssl-&gt;handshaked) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c-&gt;ssl-&gt;renegotiation = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L132" title="core/ngx_log.h:132">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L29" title="core/ngx_log.h:29">NGX_LOG_DEBUG_EVENT</a>, c-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;SSL renegotiation&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> ((where &amp; SSL_CB_ACCEPT_LOOP) == SSL_CB_ACCEPT_LOOP) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c = <a href="ngx_event_openssl.h.html#L153" title="event/ngx_event_openssl.h:153">ngx_ssl_get_connection</a>((<a href="ngx_event_openssl.h.html#L37" title="event/ngx_event_openssl.h:37">ngx_ssl_conn_t</a> *) ssl_conn);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!c-&gt;ssl-&gt;handshake_buffer_set) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * By default OpenSSL uses 4k buffer during a handshake,<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * which is too low for long certificate chains and might<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * result in extra round-trips.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * To adjust a buffer size we detect that buffering was added<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * to write side of the connection by comparing rbio and wbio.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * If they are different, we assume that it's due to buffering<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * added to wbio, and <a href="modules/ngx_rtsig_module.c.html#L75" title="event/modules/ngx_rtsig_module.c:75">set</a> buffer size.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rbio = SSL_get_rbio((<a href="ngx_event_openssl.h.html#L37" title="event/ngx_event_openssl.h:37">ngx_ssl_conn_t</a> *) ssl_conn);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; wbio = SSL_get_wbio((<a href="ngx_event_openssl.h.html#L37" title="event/ngx_event_openssl.h:37">ngx_ssl_conn_t</a> *) ssl_conn);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rbio != wbio) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<span class="Type">void</span>) BIO_set_write_buffer_size(wbio, <a href="ngx_event_openssl.h.html#L120" title="event/ngx_event_openssl.h:120">NGX_SSL_BUFSIZE</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c-&gt;ssl-&gt;handshake_buffer_set = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li>RSA *<br/></li>
<li><a id="L729">&#x200c;</a><span class="linkable">ngx_ssl_rsa512_key_callback</span>(<a href="ngx_event_openssl.h.html#L37" title="event/ngx_event_openssl.h:37">ngx_ssl_conn_t</a> *ssl_conn, <span class="Type">int</span> is_export,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span> key_length)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">static</span> RSA&nbsp; *key;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (key_length != <span class="Constant">512</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#ifndef OPENSSL_NO_DEPRECATED<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (key == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; key = RSA_generate_key(<span class="Constant">512</span>, RSA_F4, <span class="Constant">NULL</span>, <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> key;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a href="../core/ngx_array.h.html#L22" title="core/ngx_array.h:22">ngx_array_t</a> *<br/></li>
<li><a id="L751">&#x200c;</a><span class="linkable">ngx_ssl_read_password_file</span>(<a href="../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a> *file)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *p, *last, *end;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; len;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">ssize_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n;<br/></li>
<li>&nbsp; &nbsp; <a href="../os/unix/ngx_files.h.html#L16" title="os/unix/ngx_files.h:16">ngx_fd_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; fd;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *pwd;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_array.h.html#L22" title="core/ngx_array.h:22">ngx_array_t</a>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *passwords;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_palloc.h.html#L32" title="core/ngx_palloc.h:32">ngx_pool_cleanup_t</a>&nbsp; *cln;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; buf[<a href="#L13" title="event/ngx_event_openssl.c:13">NGX_SSL_PASSWORD_BUFFER_SIZE</a>];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_conf_file.c.html#L804" title="core/ngx_conf_file.c:804">ngx_conf_full_name</a>(cf-&gt;cycle, file, <span class="Constant">1</span>) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cln = <a href="../core/ngx_palloc.c.html#L314" title="core/ngx_palloc.c:314">ngx_pool_cleanup_add</a>(cf-&gt;temp_pool, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; passwords = <a href="../core/ngx_array.c.html#L13" title="core/ngx_array.c:13">ngx_array_create</a>(cf-&gt;temp_pool, <span class="Constant">4</span>, <span class="Statement">sizeof</span>(<a href="../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cln == <span class="Constant">NULL</span> || passwords == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cln-&gt;handler = <a href="#L877" title="event/ngx_event_openssl.c:877">ngx_ssl_passwords_cleanup</a>;<br/></li>
<li>&nbsp; &nbsp; cln-&gt;data = passwords;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; fd = <a href="../os/unix/ngx_files.h.html#L60" title="os/unix/ngx_files.h:60">ngx_open_file</a>(file-&gt;data, <a href="../os/unix/ngx_files.h.html#L72" title="os/unix/ngx_files.h:72">NGX_FILE_RDONLY</a>, <a href="../os/unix/ngx_files.h.html#L76" title="os/unix/ngx_files.h:76">NGX_FILE_OPEN</a>, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (fd == <a href="../os/unix/ngx_files.h.html#L49" title="os/unix/ngx_files.h:49">NGX_INVALID_FILE</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <a href="../os/unix/ngx_errno.h.html#L68" title="os/unix/ngx_errno.h:68">ngx_errno</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../os/unix/ngx_files.h.html#L70" title="os/unix/ngx_files.h:70">ngx_open_file_n</a> <span class="Constant">&quot; </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> failed&quot;</span>, file-&gt;data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; len = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; last = buf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">do</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; n = <a href="../os/unix/ngx_files.h.html#L136" title="os/unix/ngx_files.h:136">ngx_read_fd</a>(fd, last, <a href="#L13" title="event/ngx_event_openssl.c:13">NGX_SSL_PASSWORD_BUFFER_SIZE</a> - len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n == -<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <a href="../os/unix/ngx_errno.h.html#L68" title="os/unix/ngx_errno.h:68">ngx_errno</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../os/unix/ngx_files.h.html#L137" title="os/unix/ngx_files.h:137">ngx_read_fd_n</a> <span class="Constant">&quot; </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> failed&quot;</span>, file-&gt;data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; passwords = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> cleanup;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; end = last + n;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (len &amp;&amp; n == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *end++ = <a href="../core/ngx_core.h.html#L84" title="core/ngx_core.h:84">LF</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p = buf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> ( ;; ) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; last = <a href="../core/ngx_string.h.html#L66" title="core/ngx_string.h:66">ngx_strlchr</a>(last, end, <a href="../core/ngx_core.h.html#L84" title="core/ngx_core.h:84">LF</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (last == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len = last++ - p;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (len &amp;&amp; p[len - <span class="Constant">1</span>] == <a href="../core/ngx_core.h.html#L85" title="core/ngx_core.h:85">CR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len--;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (len) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pwd = <a href="../core/ngx_array.c.html#L48" title="core/ngx_array.c:48">ngx_array_push</a>(passwords);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (pwd == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; passwords = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> cleanup;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pwd-&gt;len = len;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pwd-&gt;data = <a href="../core/ngx_palloc.c.html#L150" title="core/ngx_palloc.c:150">ngx_pnalloc</a>(cf-&gt;temp_pool, len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (pwd-&gt;data == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; passwords-&gt;nelts--;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; passwords = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> cleanup;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_string.c.html#L1947" title="core/ngx_string.c:1947">ngx_memcpy</a>(pwd-&gt;data, p, len);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = last;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; len = end - p;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (len == <a href="#L13" title="event/ngx_event_openssl.c:13">NGX_SSL_PASSWORD_BUFFER_SIZE</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;too long line in </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">&quot;</span>, file-&gt;data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; passwords = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> cleanup;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_string.h.html#L139" title="core/ngx_string.h:139">ngx_memmove</a>(buf, p, len);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; last = buf + len;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">while</span> (n != <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (passwords-&gt;nelts == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; pwd = <a href="../core/ngx_array.c.html#L48" title="core/ngx_array.c:48">ngx_array_push</a>(passwords);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (pwd == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; passwords = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> cleanup;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_string.h.html#L86" title="core/ngx_string.h:86">ngx_memzero</a>(pwd, <span class="Statement">sizeof</span>(<a href="../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a>));<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="Statement">cleanup</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../os/unix/ngx_files.h.html#L109" title="os/unix/ngx_files.h:109">ngx_close_file</a>(fd) == <a href="../os/unix/ngx_files.h.html#L50" title="os/unix/ngx_files.h:50">NGX_FILE_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../core/ngx_log.h.html#L18" title="core/ngx_log.h:18">NGX_LOG_ALERT</a>, cf, <a href="../os/unix/ngx_errno.h.html#L68" title="os/unix/ngx_errno.h:68">ngx_errno</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../os/unix/ngx_files.h.html#L110" title="os/unix/ngx_files.h:110">ngx_close_file_n</a> <span class="Constant">&quot; </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> failed&quot;</span>, file-&gt;data);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L86" title="core/ngx_string.h:86">ngx_memzero</a>(buf, <a href="#L13" title="event/ngx_event_openssl.c:13">NGX_SSL_PASSWORD_BUFFER_SIZE</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> passwords;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L877">&#x200c;</a></span><span class="linkable">ngx_ssl_passwords_cleanup</span>(<span class="Type">void</span> *data)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_array.h.html#L22" title="core/ngx_array.h:22">ngx_array_t</a> *passwords = data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a>&nbsp;&nbsp; *pwd;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp;&nbsp; i;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; pwd = passwords-&gt;elts;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; passwords-&gt;nelts; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_string.h.html#L86" title="core/ngx_string.h:86">ngx_memzero</a>(pwd[i].data, pwd[i].len);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L893">&#x200c;</a><span class="linkable">ngx_ssl_dhparam</span>(<a href="../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="ngx_event_openssl.h.html#L44" title="event/ngx_event_openssl.h:44">ngx_ssl_t</a> *ssl, <a href="../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a> *file)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; DH&nbsp;&nbsp; *dh;<br/></li>
<li>&nbsp; &nbsp; BIO&nbsp; *bio;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * -----BEGIN DH PARAMETERS-----<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * MIGHAoGBALu8LcrYRnSQfEP89YDpz9vZWKP1aLQtSwju1OsPs1BMbAMCducQgAxc<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * y7qokiYUxb7spWWl/fHSh6K8BJvmd4Bg6RqSp1fjBI9osHb302zI8pul34HcLKcl<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * 7OZicMyaUDXYzs7vnqAnSmOrHlj6/UmI0PZdFGdX2gcd8EXP4WubAgEC<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * -----END DH PARAMETERS-----<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Type">static</span> <span class="Type">unsigned</span> <span class="Type">char</span> dh1024_p[] = {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">0xBB</span>, <span class="Constant">0xBC</span>, <span class="Constant">0x2D</span>, <span class="Constant">0xCA</span>, <span class="Constant">0xD8</span>, <span class="Constant">0x46</span>, <span class="Constant">0x74</span>, <span class="Constant">0x90</span>, <span class="Constant">0x7C</span>, <span class="Constant">0x43</span>, <span class="Constant">0xFC</span>, <span class="Constant">0xF5</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">0x80</span>, <span class="Constant">0xE9</span>, <span class="Constant">0xCF</span>, <span class="Constant">0xDB</span>, <span class="Constant">0xD9</span>, <span class="Constant">0x58</span>, <span class="Constant">0xA3</span>, <span class="Constant">0xF5</span>, <span class="Constant">0x68</span>, <span class="Constant">0xB4</span>, <span class="Constant">0x2D</span>, <span class="Constant">0x4B</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">0x08</span>, <span class="Constant">0xEE</span>, <span class="Constant">0xD4</span>, <span class="Constant">0xEB</span>, <span class="Constant">0x0F</span>, <span class="Constant">0xB3</span>, <span class="Constant">0x50</span>, <span class="Constant">0x4C</span>, <span class="Constant">0x6C</span>, <span class="Constant">0x03</span>, <span class="Constant">0x02</span>, <span class="Constant">0x76</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">0xE7</span>, <span class="Constant">0x10</span>, <span class="Constant">0x80</span>, <span class="Constant">0x0C</span>, <span class="Constant">0x5C</span>, <span class="Constant">0xCB</span>, <span class="Constant">0xBA</span>, <span class="Constant">0xA8</span>, <span class="Constant">0x92</span>, <span class="Constant">0x26</span>, <span class="Constant">0x14</span>, <span class="Constant">0xC5</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">0xBE</span>, <span class="Constant">0xEC</span>, <span class="Constant">0xA5</span>, <span class="Constant">0x65</span>, <span class="Constant">0xA5</span>, <span class="Constant">0xFD</span>, <span class="Constant">0xF1</span>, <span class="Constant">0xD2</span>, <span class="Constant">0x87</span>, <span class="Constant">0xA2</span>, <span class="Constant">0xBC</span>, <span class="Constant">0x04</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">0x9B</span>, <span class="Constant">0xE6</span>, <span class="Constant">0x77</span>, <span class="Constant">0x80</span>, <span class="Constant">0x60</span>, <span class="Constant">0xE9</span>, <span class="Constant">0x1A</span>, <span class="Constant">0x92</span>, <span class="Constant">0xA7</span>, <span class="Constant">0x57</span>, <span class="Constant">0xE3</span>, <span class="Constant">0x04</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">0x8F</span>, <span class="Constant">0x68</span>, <span class="Constant">0xB0</span>, <span class="Constant">0x76</span>, <span class="Constant">0xF7</span>, <span class="Constant">0xD3</span>, <span class="Constant">0x6C</span>, <span class="Constant">0xC8</span>, <span class="Constant">0xF2</span>, <span class="Constant">0x9B</span>, <span class="Constant">0xA5</span>, <span class="Constant">0xDF</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">0x81</span>, <span class="Constant">0xDC</span>, <span class="Constant">0x2C</span>, <span class="Constant">0xA7</span>, <span class="Constant">0x25</span>, <span class="Constant">0xEC</span>, <span class="Constant">0xE6</span>, <span class="Constant">0x62</span>, <span class="Constant">0x70</span>, <span class="Constant">0xCC</span>, <span class="Constant">0x9A</span>, <span class="Constant">0x50</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">0x35</span>, <span class="Constant">0xD8</span>, <span class="Constant">0xCE</span>, <span class="Constant">0xCE</span>, <span class="Constant">0xEF</span>, <span class="Constant">0x9E</span>, <span class="Constant">0xA0</span>, <span class="Constant">0x27</span>, <span class="Constant">0x4A</span>, <span class="Constant">0x63</span>, <span class="Constant">0xAB</span>, <span class="Constant">0x1E</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">0x58</span>, <span class="Constant">0xFA</span>, <span class="Constant">0xFD</span>, <span class="Constant">0x49</span>, <span class="Constant">0x88</span>, <span class="Constant">0xD0</span>, <span class="Constant">0xF6</span>, <span class="Constant">0x5D</span>, <span class="Constant">0x14</span>, <span class="Constant">0x67</span>, <span class="Constant">0x57</span>, <span class="Constant">0xDA</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">0x07</span>, <span class="Constant">0x1D</span>, <span class="Constant">0xF0</span>, <span class="Constant">0x45</span>, <span class="Constant">0xCF</span>, <span class="Constant">0xE1</span>, <span class="Constant">0x6B</span>, <span class="Constant">0x9B<br/></li>
<li></span>&nbsp; &nbsp; };<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Type">static</span> <span class="Type">unsigned</span> <span class="Type">char</span> dh1024_g[] = { <span class="Constant">0x02</span> };<br/></li>
<li><br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (file-&gt;len == <span class="Constant">0</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; dh = DH_new();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (dh == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1987" title="event/ngx_event_openssl.c:1987">ngx_ssl_error</a>(<a href="../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, ssl-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;DH_new() failed&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; dh-&gt;p = BN_bin2bn(dh1024_p, <span class="Statement">sizeof</span>(dh1024_p), <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; dh-&gt;g = BN_bin2bn(dh1024_g, <span class="Statement">sizeof</span>(dh1024_g), <span class="Constant">NULL</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (dh-&gt;p == <span class="Constant">NULL</span> || dh-&gt;g == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1987" title="event/ngx_event_openssl.c:1987">ngx_ssl_error</a>(<a href="../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, ssl-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;BN_bin2bn() failed&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; DH_free(dh);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; SSL_CTX_set_tmp_dh(ssl-&gt;ctx, dh);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; DH_free(dh);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_conf_file.c.html#L804" title="core/ngx_conf_file.c:804">ngx_conf_full_name</a>(cf-&gt;cycle, file, <span class="Constant">1</span>) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; bio = BIO_new_file((<span class="Type">char</span> *) file-&gt;data, <span class="Constant">&quot;r&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (bio == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1987" title="event/ngx_event_openssl.c:1987">ngx_ssl_error</a>(<a href="../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, ssl-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;BIO_new_file(</span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">) failed&quot;</span>, file-&gt;data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; dh = PEM_read_bio_DHparams(bio, <span class="Constant">NULL</span>, <span class="Constant">NULL</span>, <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (dh == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1987" title="event/ngx_event_openssl.c:1987">ngx_ssl_error</a>(<a href="../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, ssl-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;PEM_read_bio_DHparams(</span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">) failed&quot;</span>, file-&gt;data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; BIO_free(bio);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; SSL_CTX_set_tmp_dh(ssl-&gt;ctx, dh);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; DH_free(dh);<br/></li>
<li>&nbsp; &nbsp; BIO_free(bio);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L976">&#x200c;</a><span class="linkable">ngx_ssl_ecdh_curve</span>(<a href="../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="ngx_event_openssl.h.html#L44" title="event/ngx_event_openssl.h:44">ngx_ssl_t</a> *ssl, <a href="../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a> *name)<br/></li>
<li>{<br/></li>
<li><span class="PreProc">#if OPENSSL_VERSION_NUMBER &gt;= </span><span class="Constant">0x0090800fL<br/></li>
<li></span><span class="PreProc">#ifndef OPENSSL_NO_ECDH<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; nid;<br/></li>
<li>&nbsp; &nbsp; EC_KEY&nbsp; *ecdh;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Elliptic-Curve Diffie-Hellman parameters are either &quot;named curves&quot;<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * from RFC 4492 section 5.1.1, or explicitly described curves over<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * binary fields. OpenSSL only supports the &quot;named curves&quot;, which provide<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * maximum interoperability.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; nid = OBJ_sn2nid((<span class="Type">const</span> <span class="Type">char</span> *) name-&gt;data);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (nid == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1987" title="event/ngx_event_openssl.c:1987">ngx_ssl_error</a>(<a href="../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, ssl-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;Unknown curve name </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">&quot;</span>, name-&gt;data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ecdh = EC_KEY_new_by_curve_name(nid);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ecdh == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1987" title="event/ngx_event_openssl.c:1987">ngx_ssl_error</a>(<a href="../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, ssl-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;Unable to create curve </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">&quot;</span>, name-&gt;data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; SSL_CTX_set_options(ssl-&gt;ctx, SSL_OP_SINGLE_ECDH_USE);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; SSL_CTX_set_tmp_ecdh(ssl-&gt;ctx, ecdh);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; EC_KEY_free(ecdh);<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L1017">&#x200c;</a><span class="linkable">ngx_ssl_create_connection</span>(<a href="ngx_event_openssl.h.html#L44" title="event/ngx_event_openssl.h:44">ngx_ssl_t</a> *ssl, <a href="../core/ngx_core.h.html#L23" title="core/ngx_core.h:23">ngx_connection_t</a> *c, <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> flags)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_event_openssl.h.html#L65" title="event/ngx_event_openssl.h:65">ngx_ssl_connection_t</a>&nbsp; *sc;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; sc = <a href="../core/ngx_palloc.c.html#L300" title="core/ngx_palloc.c:300">ngx_pcalloc</a>(c-&gt;pool, <span class="Statement">sizeof</span>(<a href="ngx_event_openssl.h.html#L65" title="event/ngx_event_openssl.h:65">ngx_ssl_connection_t</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (sc == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; sc-&gt;buffer = ((flags &amp; <a href="ngx_event_openssl.h.html#L117" title="event/ngx_event_openssl.h:117">NGX_SSL_BUFFER</a>) != <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; sc-&gt;buffer_size = ssl-&gt;buffer_size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; sc-&gt;connection = SSL_new(ssl-&gt;ctx);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (sc-&gt;connection == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1987" title="event/ngx_event_openssl.c:1987">ngx_ssl_error</a>(<a href="../core/ngx_log.h.html#L18" title="core/ngx_log.h:18">NGX_LOG_ALERT</a>, c-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;SSL_new() failed&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (SSL_set_fd(sc-&gt;connection, c-&gt;fd) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1987" title="event/ngx_event_openssl.c:1987">ngx_ssl_error</a>(<a href="../core/ngx_log.h.html#L18" title="core/ngx_log.h:18">NGX_LOG_ALERT</a>, c-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;SSL_set_fd() failed&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (flags &amp; <a href="ngx_event_openssl.h.html#L118" title="event/ngx_event_openssl.h:118">NGX_SSL_CLIENT</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; SSL_set_connect_state(sc-&gt;connection);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; SSL_set_accept_state(sc-&gt;connection);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (SSL_set_ex_data(sc-&gt;connection, <a href="#L100" title="event/ngx_event_openssl.c:100">ngx_ssl_connection_index</a>, c) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1987" title="event/ngx_event_openssl.c:1987">ngx_ssl_error</a>(<a href="../core/ngx_log.h.html#L18" title="core/ngx_log.h:18">NGX_LOG_ALERT</a>, c-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;SSL_set_ex_data() failed&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c-&gt;ssl = sc;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L1060">&#x200c;</a><span class="linkable">ngx_ssl_set_session</span>(<a href="../core/ngx_core.h.html#L23" title="core/ngx_core.h:23">ngx_connection_t</a> *c, <a href="ngx_event_openssl.h.html#L36" title="event/ngx_event_openssl.h:36">ngx_ssl_session_t</a> *session)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (session) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (SSL_set_session(c-&gt;ssl-&gt;connection, session) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1987" title="event/ngx_event_openssl.c:1987">ngx_ssl_error</a>(<a href="../core/ngx_log.h.html#L18" title="core/ngx_log.h:18">NGX_LOG_ALERT</a>, c-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;SSL_set_session() failed&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L1074">&#x200c;</a><span class="linkable">ngx_ssl_handshake</span>(<a href="../core/ngx_core.h.html#L23" title="core/ngx_core.h:23">ngx_connection_t</a> *c)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; n, sslerr;<br/></li>
<li>&nbsp; &nbsp; <a href="../os/unix/ngx_errno.h.html#L16" title="os/unix/ngx_errno.h:16">ngx_err_t</a>&nbsp; err;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L1976" title="event/ngx_event_openssl.c:1976">ngx_ssl_clear_error</a>(c-&gt;log);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; n = SSL_do_handshake(c-&gt;ssl-&gt;connection);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="../core/ngx_log.h.html#L29" title="core/ngx_log.h:29">NGX_LOG_DEBUG_EVENT</a>, c-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;SSL_do_handshake: </span><span class="Special">%d</span><span class="Constant">&quot;</span>, n);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (n == <span class="Constant">1</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="ngx_event.c.html#L270" title="event/ngx_event.c:270">ngx_handle_read_event</a>(c-&gt;read, <span class="Constant">0</span>) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="ngx_event.c.html#L338" title="event/ngx_event.c:338">ngx_handle_write_event</a>(c-&gt;write, <span class="Constant">0</span>) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_DEBUG)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; buf[<span class="Constant">129</span>], *s, *d;<br/></li>
<li><span class="PreProc">#if OPENSSL_VERSION_NUMBER &gt;= </span><span class="Constant">0x10000000L<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">const<br/></li>
<li></span><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; SSL_CIPHER&nbsp; *cipher;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cipher = SSL_get_current_cipher(c-&gt;ssl-&gt;connection);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (cipher) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; SSL_CIPHER_description(cipher, &amp;buf[<span class="Constant">1</span>], <span class="Constant">128</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (s = &amp;buf[<span class="Constant">1</span>], d = buf; *s; s++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (*s == <span class="Constant">' '</span> &amp;&amp; *d == <span class="Constant">' '</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (*s == <a href="../core/ngx_core.h.html#L84" title="core/ngx_core.h:84">LF</a> || *s == <a href="../core/ngx_core.h.html#L85" title="core/ngx_core.h:85">CR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *++d = *s;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (*d != <span class="Constant">' '</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; d++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *d = <span class="Special">'\0'</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L138" title="core/ngx_log.h:138">ngx_log_debug2</a>(<a href="../core/ngx_log.h.html#L29" title="core/ngx_log.h:29">NGX_LOG_DEBUG_EVENT</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;SSL: </span><span class="Special">%s</span><span class="Constant">, cipher: </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; SSL_get_version(c-&gt;ssl-&gt;connection), &amp;buf[<span class="Constant">1</span>]);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (SSL_session_reused(c-&gt;ssl-&gt;connection)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L132" title="core/ngx_log.h:132">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L29" title="core/ngx_log.h:29">NGX_LOG_DEBUG_EVENT</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;SSL reused session&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L132" title="core/ngx_log.h:132">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L29" title="core/ngx_log.h:29">NGX_LOG_DEBUG_EVENT</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;SSL no shared ciphers&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;ssl-&gt;handshaked = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;recv = <a href="#L1301" title="event/ngx_event_openssl.c:1301">ngx_ssl_recv</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;send = <a href="#L1650" title="event/ngx_event_openssl.c:1650">ngx_ssl_write</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;recv_chain = <a href="#L1242" title="event/ngx_event_openssl.c:1242">ngx_ssl_recv_chain</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;send_chain = <a href="#L1493" title="event/ngx_event_openssl.c:1493">ngx_ssl_send_chain</a>;<br/></li>
<li><br/></li>
<li><span class="PreProc">#ifdef SSL3_FLAGS_NO_RENEGOTIATE_CIPHERS<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* initial handshake done, disable renegotiation (CVE-2009-3555) */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;ssl-&gt;connection-&gt;s3) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c-&gt;ssl-&gt;connection-&gt;s3-&gt;flags |= SSL3_FLAGS_NO_RENEGOTIATE_CIPHERS;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; sslerr = SSL_get_error(c-&gt;ssl-&gt;connection, n);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="../core/ngx_log.h.html#L29" title="core/ngx_log.h:29">NGX_LOG_DEBUG_EVENT</a>, c-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;SSL_get_error: </span><span class="Special">%d</span><span class="Constant">&quot;</span>, sslerr);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (sslerr == SSL_ERROR_WANT_READ) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;read-&gt;ready = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;read-&gt;handler = <a href="#L1219" title="event/ngx_event_openssl.c:1219">ngx_ssl_handshake_handler</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;write-&gt;handler = <a href="#L1219" title="event/ngx_event_openssl.c:1219">ngx_ssl_handshake_handler</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="ngx_event.c.html#L270" title="event/ngx_event.c:270">ngx_handle_read_event</a>(c-&gt;read, <span class="Constant">0</span>) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="ngx_event.c.html#L338" title="event/ngx_event.c:338">ngx_handle_write_event</a>(c-&gt;write, <span class="Constant">0</span>) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L31" title="core/ngx_core.h:31">NGX_AGAIN</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (sslerr == SSL_ERROR_WANT_WRITE) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;write-&gt;ready = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;read-&gt;handler = <a href="#L1219" title="event/ngx_event_openssl.c:1219">ngx_ssl_handshake_handler</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;write-&gt;handler = <a href="#L1219" title="event/ngx_event_openssl.c:1219">ngx_ssl_handshake_handler</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="ngx_event.c.html#L270" title="event/ngx_event.c:270">ngx_handle_read_event</a>(c-&gt;read, <span class="Constant">0</span>) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="ngx_event.c.html#L338" title="event/ngx_event.c:338">ngx_handle_write_event</a>(c-&gt;write, <span class="Constant">0</span>) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L31" title="core/ngx_core.h:31">NGX_AGAIN</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; err = (sslerr == SSL_ERROR_SYSCALL) ? <a href="../os/unix/ngx_errno.h.html#L68" title="os/unix/ngx_errno.h:68">ngx_errno</a> : <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c-&gt;ssl-&gt;no_wait_shutdown = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; c-&gt;ssl-&gt;no_send_shutdown = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; c-&gt;read-&gt;eof = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (sslerr == SSL_ERROR_ZERO_RETURN || ERR_peek_error() == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_connection.c.html#L1136" title="core/ngx_connection.c:1136">ngx_connection_error</a>(c, err,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;peer closed connection in SSL handshake&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c-&gt;read-&gt;error = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L1854" title="event/ngx_event_openssl.c:1854">ngx_ssl_connection_error</a>(c, sslerr, err, <span class="Constant">&quot;SSL_do_handshake() failed&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L1219">&#x200c;</a></span><span class="linkable">ngx_ssl_handshake_handler</span>(<a href="../core/ngx_core.h.html#L21" title="core/ngx_core.h:21">ngx_event_t</a> *ev)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L23" title="core/ngx_core.h:23">ngx_connection_t</a>&nbsp; *c;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c = ev-&gt;data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="../core/ngx_log.h.html#L29" title="core/ngx_log.h:29">NGX_LOG_DEBUG_EVENT</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;SSL handshake handler: </span><span class="Special">%d</span><span class="Constant">&quot;</span>, ev-&gt;write);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ev-&gt;timedout) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;ssl-&gt;handler(c);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L1074" title="event/ngx_event_openssl.c:1074">ngx_ssl_handshake</a>(c) == <a href="../core/ngx_core.h.html#L31" title="core/ngx_core.h:31">NGX_AGAIN</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c-&gt;ssl-&gt;handler(c);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">ssize_t<br/></li>
<li><a id="L1242">&#x200c;</a></span><span class="linkable">ngx_ssl_recv_chain</span>(<a href="../core/ngx_core.h.html#L23" title="core/ngx_core.h:23">ngx_connection_t</a> *c, <a href="../core/ngx_core.h.html#L16" title="core/ngx_core.h:16">ngx_chain_t</a> *cl, <span class="Type">off_t</span> limit)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp;&nbsp; *last;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">ssize_t</span>&nbsp; &nbsp;&nbsp; n, bytes, size;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; *b;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; bytes = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; b = cl-&gt;buf;<br/></li>
<li>&nbsp; &nbsp; last = b-&gt;last;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> ( ;; ) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; size = b-&gt;end - last;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (limit) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (bytes &gt;= limit) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> bytes;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (bytes + size &gt; limit) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; size = (<span class="Type">ssize_t</span>) (limit - bytes);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; n = <a href="#L1301" title="event/ngx_event_openssl.c:1301">ngx_ssl_recv</a>(c, last, size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n &gt; <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; last += n;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bytes += n;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (last == b-&gt;end) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cl = cl-&gt;next;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (cl == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> bytes;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b = cl-&gt;buf;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; last = b-&gt;last;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (bytes) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n == <span class="Constant">0</span> || n == <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c-&gt;read-&gt;ready = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> bytes;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> n;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">ssize_t<br/></li>
<li><a id="L1301">&#x200c;</a></span><span class="linkable">ngx_ssl_recv</span>(<a href="../core/ngx_core.h.html#L23" title="core/ngx_core.h:23">ngx_connection_t</a> *c, u_char *buf, <span class="Type">size_t</span> size)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; n, bytes;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;ssl-&gt;last == <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;read-&gt;error = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;ssl-&gt;last == <a href="../core/ngx_core.h.html#L33" title="core/ngx_core.h:33">NGX_DONE</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;read-&gt;ready = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;read-&gt;eof = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; bytes = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L1976" title="event/ngx_event_openssl.c:1976">ngx_ssl_clear_error</a>(c-&gt;log);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * SSL_read() may return data in parts, so try to read<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * until SSL_read() would return no data<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> ( ;; ) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; n = SSL_read(c-&gt;ssl-&gt;connection, buf, size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="../core/ngx_log.h.html#L29" title="core/ngx_log.h:29">NGX_LOG_DEBUG_EVENT</a>, c-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;SSL_read: </span><span class="Special">%d</span><span class="Constant">&quot;</span>, n);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n &gt; <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bytes += n;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;ssl-&gt;last = <a href="#L1379" title="event/ngx_event_openssl.c:1379">ngx_ssl_handle_recv</a>(c, n);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;ssl-&gt;last == <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; size -= n;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (size == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c-&gt;read-&gt;ready = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> bytes;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; buf += n;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (bytes) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;ssl-&gt;last != <a href="../core/ngx_core.h.html#L31" title="core/ngx_core.h:31">NGX_AGAIN</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c-&gt;read-&gt;ready = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> bytes;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (c-&gt;ssl-&gt;last) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="../core/ngx_core.h.html#L33" title="core/ngx_core.h:33">NGX_DONE</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c-&gt;read-&gt;ready = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c-&gt;read-&gt;eof = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c-&gt;read-&gt;error = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* fall through */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="../core/ngx_core.h.html#L31" title="core/ngx_core.h:31">NGX_AGAIN</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> c-&gt;ssl-&gt;last;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L1379">&#x200c;</a><span class="linkable">ngx_ssl_handle_recv</span>(<a href="../core/ngx_core.h.html#L23" title="core/ngx_core.h:23">ngx_connection_t</a> *c, <span class="Type">int</span> n)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; sslerr;<br/></li>
<li>&nbsp; &nbsp; <a href="../os/unix/ngx_errno.h.html#L16" title="os/unix/ngx_errno.h:16">ngx_err_t</a>&nbsp; err;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;ssl-&gt;renegotiation) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * disable renegotiation (CVE-2009-3555):<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * OpenSSL (at least up to 0.9.8l) does not handle disabled<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * renegotiation gracefully, so drop connection here<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L22" title="core/ngx_log.h:22">NGX_LOG_NOTICE</a>, c-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;SSL renegotiation disabled&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">while</span> (ERR_peek_error()) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1987" title="event/ngx_event_openssl.c:1987">ngx_ssl_error</a>(<a href="../core/ngx_log.h.html#L24" title="core/ngx_log.h:24">NGX_LOG_DEBUG</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;ignoring stale global SSL error&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ERR_clear_error();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;ssl-&gt;no_wait_shutdown = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;ssl-&gt;no_send_shutdown = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (n &gt; <span class="Constant">0</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;ssl-&gt;saved_write_handler) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c-&gt;write-&gt;handler = c-&gt;ssl-&gt;saved_write_handler;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c-&gt;ssl-&gt;saved_write_handler = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c-&gt;write-&gt;ready = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="ngx_event.c.html#L338" title="event/ngx_event.c:338">ngx_handle_write_event</a>(c-&gt;write, <span class="Constant">0</span>) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_event_posted.h.html#L17" title="event/ngx_event_posted.h:17">ngx_post_event</a>(c-&gt;write, &amp;<a href="ngx_event_posted.c.html#L14" title="event/ngx_event_posted.c:14">ngx_posted_events</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; sslerr = SSL_get_error(c-&gt;ssl-&gt;connection, n);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; err = (sslerr == SSL_ERROR_SYSCALL) ? <a href="../os/unix/ngx_errno.h.html#L68" title="os/unix/ngx_errno.h:68">ngx_errno</a> : <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="../core/ngx_log.h.html#L29" title="core/ngx_log.h:29">NGX_LOG_DEBUG_EVENT</a>, c-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;SSL_get_error: </span><span class="Special">%d</span><span class="Constant">&quot;</span>, sslerr);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (sslerr == SSL_ERROR_WANT_READ) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;read-&gt;ready = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L31" title="core/ngx_core.h:31">NGX_AGAIN</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (sslerr == SSL_ERROR_WANT_WRITE) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L23" title="core/ngx_log.h:23">NGX_LOG_INFO</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;peer started SSL renegotiation&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;write-&gt;ready = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="ngx_event.c.html#L338" title="event/ngx_event.c:338">ngx_handle_write_event</a>(c-&gt;write, <span class="Constant">0</span>) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * we do not <a href="modules/ngx_rtsig_module.c.html#L75" title="event/modules/ngx_rtsig_module.c:75">set</a> the timer because there is already the read event timer<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;ssl-&gt;saved_write_handler == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c-&gt;ssl-&gt;saved_write_handler = c-&gt;write-&gt;handler;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c-&gt;write-&gt;handler = <a href="#L1474" title="event/ngx_event_openssl.c:1474">ngx_ssl_write_handler</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L31" title="core/ngx_core.h:31">NGX_AGAIN</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c-&gt;ssl-&gt;no_wait_shutdown = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; c-&gt;ssl-&gt;no_send_shutdown = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (sslerr == SSL_ERROR_ZERO_RETURN || ERR_peek_error() == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L132" title="core/ngx_log.h:132">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L29" title="core/ngx_log.h:29">NGX_LOG_DEBUG_EVENT</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;peer shutdown SSL cleanly&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L33" title="core/ngx_core.h:33">NGX_DONE</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L1854" title="event/ngx_event_openssl.c:1854">ngx_ssl_connection_error</a>(c, sslerr, err, <span class="Constant">&quot;SSL_read() failed&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L1474">&#x200c;</a></span><span class="linkable">ngx_ssl_write_handler</span>(<a href="../core/ngx_core.h.html#L21" title="core/ngx_core.h:21">ngx_event_t</a> *wev)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L23" title="core/ngx_core.h:23">ngx_connection_t</a>&nbsp; *c;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c = wev-&gt;data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c-&gt;read-&gt;handler(c-&gt;read);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * OpenSSL has no SSL_writev() so we copy several bufs into our 16K buffer<br/></li>
<li></span><span class="Comment"> * before the SSL_write() call to decrease a SSL overhead.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Besides for protocols such as HTTP it is possible to always buffer<br/></li>
<li></span><span class="Comment"> * the output to decrease a SSL overhead some more.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><a href="../core/ngx_core.h.html#L16" title="core/ngx_core.h:16">ngx_chain_t</a> *<br/></li>
<li><a id="L1493">&#x200c;</a><span class="linkable">ngx_ssl_send_chain</span>(<a href="../core/ngx_core.h.html#L23" title="core/ngx_core.h:23">ngx_connection_t</a> *c, <a href="../core/ngx_core.h.html#L16" title="core/ngx_core.h:16">ngx_chain_t</a> *in, <span class="Type">off_t</span> limit)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp;&nbsp; flush;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">ssize_t</span>&nbsp; &nbsp; &nbsp; send, size;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_buf.h.html#L18" title="core/ngx_buf.h:18">ngx_buf_t</a>&nbsp;&nbsp; *buf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!c-&gt;ssl-&gt;buffer) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">while</span> (in) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_buf.h.html#L126" title="core/ngx_buf.h:126">ngx_buf_special</a>(in-&gt;buf)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; in = in-&gt;next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n = <a href="#L1650" title="event/ngx_event_openssl.c:1650">ngx_ssl_write</a>(c, in-&gt;buf-&gt;pos, in-&gt;buf-&gt;last - in-&gt;buf-&gt;pos);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n == <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_buf.h.html#L120" title="core/ngx_buf.h:120">NGX_CHAIN_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n == <a href="../core/ngx_core.h.html#L31" title="core/ngx_core.h:31">NGX_AGAIN</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> in;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; in-&gt;buf-&gt;pos += n;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c-&gt;sent += n;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (in-&gt;buf-&gt;pos == in-&gt;buf-&gt;last) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; in = in-&gt;next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> in;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* the maximum limit size is the maximum int32_t value - the page size */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (limit == <span class="Constant">0</span> || limit &gt; (<span class="Type">off_t</span>) (<a href="../core/ngx_config.h.html#L131" title="core/ngx_config.h:131">NGX_MAX_INT32_VALUE</a> - <a href="../os/unix/ngx_alloc.c.html#L12" title="os/unix/ngx_alloc.c:12">ngx_pagesize</a>)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; limit = <a href="../core/ngx_config.h.html#L131" title="core/ngx_config.h:131">NGX_MAX_INT32_VALUE</a> - <a href="../os/unix/ngx_alloc.c.html#L12" title="os/unix/ngx_alloc.c:12">ngx_pagesize</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; buf = c-&gt;ssl-&gt;buf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (buf == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; buf = <a href="../core/ngx_buf.c.html#L13" title="core/ngx_buf.c:13">ngx_create_temp_buf</a>(c-&gt;pool, c-&gt;ssl-&gt;buffer_size);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (buf == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_buf.h.html#L120" title="core/ngx_buf.h:120">NGX_CHAIN_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;ssl-&gt;buf = buf;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (buf-&gt;start == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; buf-&gt;start = <a href="../core/ngx_palloc.c.html#L120" title="core/ngx_palloc.c:120">ngx_palloc</a>(c-&gt;pool, c-&gt;ssl-&gt;buffer_size);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (buf-&gt;start == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_buf.h.html#L120" title="core/ngx_buf.h:120">NGX_CHAIN_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; buf-&gt;pos = buf-&gt;start;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; buf-&gt;last = buf-&gt;start;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; buf-&gt;end = buf-&gt;start + c-&gt;ssl-&gt;buffer_size;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; send = buf-&gt;last - buf-&gt;pos;<br/></li>
<li>&nbsp; &nbsp; flush = (in == <span class="Constant">NULL</span>) ? <span class="Constant">1</span> : buf-&gt;flush;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> ( ;; ) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">while</span> (in &amp;&amp; buf-&gt;last &lt; buf-&gt;end &amp;&amp; send &lt; limit) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (in-&gt;buf-&gt;last_buf || in-&gt;buf-&gt;flush) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; flush = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_buf.h.html#L126" title="core/ngx_buf.h:126">ngx_buf_special</a>(in-&gt;buf)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; in = in-&gt;next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; size = in-&gt;buf-&gt;last - in-&gt;buf-&gt;pos;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (size &gt; buf-&gt;end - buf-&gt;last) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; size = buf-&gt;end - buf-&gt;last;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (send + size &gt; limit) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; size = (<span class="Type">ssize_t</span>) (limit - send);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="../core/ngx_log.h.html#L29" title="core/ngx_log.h:29">NGX_LOG_DEBUG_EVENT</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;SSL buf copy: </span><span class="Special">%d</span><span class="Constant">&quot;</span>, size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_string.c.html#L1947" title="core/ngx_string.c:1947">ngx_memcpy</a>(buf-&gt;last, in-&gt;buf-&gt;pos, size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; buf-&gt;last += size;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; in-&gt;buf-&gt;pos += size;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; send += size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (in-&gt;buf-&gt;pos == in-&gt;buf-&gt;last) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; in = in-&gt;next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!flush &amp;&amp; send &lt; limit &amp;&amp; buf-&gt;last &lt; buf-&gt;end) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; size = buf-&gt;last - buf-&gt;pos;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (size == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; buf-&gt;flush = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c-&gt;buffered &amp;= ~<a href="../core/ngx_connection.h.html#L114" title="core/ngx_connection.h:114">NGX_SSL_BUFFERED</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> in;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; n = <a href="#L1650" title="event/ngx_event_openssl.c:1650">ngx_ssl_write</a>(c, buf-&gt;pos, size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n == <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_buf.h.html#L120" title="core/ngx_buf.h:120">NGX_CHAIN_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n == <a href="../core/ngx_core.h.html#L31" title="core/ngx_core.h:31">NGX_AGAIN</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; buf-&gt;pos += n;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;sent += n;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n &lt; size) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; flush = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; buf-&gt;pos = buf-&gt;start;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; buf-&gt;last = buf-&gt;start;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (in == <span class="Constant">NULL</span> || send == limit) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; buf-&gt;flush = flush;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (buf-&gt;pos &lt; buf-&gt;last) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;buffered |= <a href="../core/ngx_connection.h.html#L114" title="core/ngx_connection.h:114">NGX_SSL_BUFFERED</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;buffered &amp;= ~<a href="../core/ngx_connection.h.html#L114" title="core/ngx_connection.h:114">NGX_SSL_BUFFERED</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> in;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">ssize_t<br/></li>
<li><a id="L1650">&#x200c;</a></span><span class="linkable">ngx_ssl_write</span>(<a href="../core/ngx_core.h.html#L23" title="core/ngx_core.h:23">ngx_connection_t</a> *c, u_char *data, <span class="Type">size_t</span> size)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; n, sslerr;<br/></li>
<li>&nbsp; &nbsp; <a href="../os/unix/ngx_errno.h.html#L16" title="os/unix/ngx_errno.h:16">ngx_err_t</a>&nbsp; err;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L1976" title="event/ngx_event_openssl.c:1976">ngx_ssl_clear_error</a>(c-&gt;log);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="../core/ngx_log.h.html#L29" title="core/ngx_log.h:29">NGX_LOG_DEBUG_EVENT</a>, c-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;SSL to write: </span><span class="Special">%d</span><span class="Constant">&quot;</span>, size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; n = SSL_write(c-&gt;ssl-&gt;connection, data, size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="../core/ngx_log.h.html#L29" title="core/ngx_log.h:29">NGX_LOG_DEBUG_EVENT</a>, c-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;SSL_write: </span><span class="Special">%d</span><span class="Constant">&quot;</span>, n);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (n &gt; <span class="Constant">0</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;ssl-&gt;saved_read_handler) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c-&gt;read-&gt;handler = c-&gt;ssl-&gt;saved_read_handler;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c-&gt;ssl-&gt;saved_read_handler = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c-&gt;read-&gt;ready = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="ngx_event.c.html#L270" title="event/ngx_event.c:270">ngx_handle_read_event</a>(c-&gt;read, <span class="Constant">0</span>) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_event_posted.h.html#L17" title="event/ngx_event_posted.h:17">ngx_post_event</a>(c-&gt;read, &amp;<a href="ngx_event_posted.c.html#L14" title="event/ngx_event_posted.c:14">ngx_posted_events</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> n;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; sslerr = SSL_get_error(c-&gt;ssl-&gt;connection, n);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; err = (sslerr == SSL_ERROR_SYSCALL) ? <a href="../os/unix/ngx_errno.h.html#L68" title="os/unix/ngx_errno.h:68">ngx_errno</a> : <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="../core/ngx_log.h.html#L29" title="core/ngx_log.h:29">NGX_LOG_DEBUG_EVENT</a>, c-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;SSL_get_error: </span><span class="Special">%d</span><span class="Constant">&quot;</span>, sslerr);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (sslerr == SSL_ERROR_WANT_WRITE) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;write-&gt;ready = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L31" title="core/ngx_core.h:31">NGX_AGAIN</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (sslerr == SSL_ERROR_WANT_READ) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L23" title="core/ngx_log.h:23">NGX_LOG_INFO</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;peer started SSL renegotiation&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;read-&gt;ready = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="ngx_event.c.html#L270" title="event/ngx_event.c:270">ngx_handle_read_event</a>(c-&gt;read, <span class="Constant">0</span>) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * we do not <a href="modules/ngx_rtsig_module.c.html#L75" title="event/modules/ngx_rtsig_module.c:75">set</a> the timer because there is already<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * the write event timer<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;ssl-&gt;saved_read_handler == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c-&gt;ssl-&gt;saved_read_handler = c-&gt;read-&gt;handler;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c-&gt;read-&gt;handler = <a href="#L1727" title="event/ngx_event_openssl.c:1727">ngx_ssl_read_handler</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L31" title="core/ngx_core.h:31">NGX_AGAIN</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c-&gt;ssl-&gt;no_wait_shutdown = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; c-&gt;ssl-&gt;no_send_shutdown = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; c-&gt;write-&gt;error = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L1854" title="event/ngx_event_openssl.c:1854">ngx_ssl_connection_error</a>(c, sslerr, err, <span class="Constant">&quot;SSL_write() failed&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L1727">&#x200c;</a></span><span class="linkable">ngx_ssl_read_handler</span>(<a href="../core/ngx_core.h.html#L21" title="core/ngx_core.h:21">ngx_event_t</a> *rev)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L23" title="core/ngx_core.h:23">ngx_connection_t</a>&nbsp; *c;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c = rev-&gt;data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c-&gt;write-&gt;handler(c-&gt;write);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">void<br/></li>
<li><a id="L1738">&#x200c;</a></span><span class="linkable">ngx_ssl_free_buffer</span>(<a href="../core/ngx_core.h.html#L23" title="core/ngx_core.h:23">ngx_connection_t</a> *c)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;ssl-&gt;buf &amp;&amp; c-&gt;ssl-&gt;buf-&gt;start) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_palloc.c.html#L280" title="core/ngx_palloc.c:280">ngx_pfree</a>(c-&gt;pool, c-&gt;ssl-&gt;buf-&gt;start) == <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c-&gt;ssl-&gt;buf-&gt;start = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L1749">&#x200c;</a><span class="linkable">ngx_ssl_shutdown</span>(<a href="../core/ngx_core.h.html#L23" title="core/ngx_core.h:23">ngx_connection_t</a> *c)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; n, sslerr, mode;<br/></li>
<li>&nbsp; &nbsp; <a href="../os/unix/ngx_errno.h.html#L16" title="os/unix/ngx_errno.h:16">ngx_err_t</a>&nbsp; err;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;timedout) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; mode = SSL_RECEIVED_SHUTDOWN|SSL_SENT_SHUTDOWN;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; SSL_set_quiet_shutdown(c-&gt;ssl-&gt;connection, <span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; mode = SSL_get_shutdown(c-&gt;ssl-&gt;connection);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;ssl-&gt;no_wait_shutdown) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mode |= SSL_RECEIVED_SHUTDOWN;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;ssl-&gt;no_send_shutdown) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mode |= SSL_SENT_SHUTDOWN;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;ssl-&gt;no_wait_shutdown &amp;&amp; c-&gt;ssl-&gt;no_send_shutdown) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; SSL_set_quiet_shutdown(c-&gt;ssl-&gt;connection, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; SSL_set_shutdown(c-&gt;ssl-&gt;connection, mode);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L1976" title="event/ngx_event_openssl.c:1976">ngx_ssl_clear_error</a>(c-&gt;log);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; n = SSL_shutdown(c-&gt;ssl-&gt;connection);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="../core/ngx_log.h.html#L29" title="core/ngx_log.h:29">NGX_LOG_DEBUG_EVENT</a>, c-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;SSL_shutdown: </span><span class="Special">%d</span><span class="Constant">&quot;</span>, n);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; sslerr = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* SSL_shutdown() never returns -1, on error it returns 0 */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (n != <span class="Constant">1</span> &amp;&amp; ERR_peek_error()) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; sslerr = SSL_get_error(c-&gt;ssl-&gt;connection, n);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="../core/ngx_log.h.html#L29" title="core/ngx_log.h:29">NGX_LOG_DEBUG_EVENT</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;SSL_get_error: </span><span class="Special">%d</span><span class="Constant">&quot;</span>, sslerr);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (n == <span class="Constant">1</span> || sslerr == <span class="Constant">0</span> || sslerr == SSL_ERROR_ZERO_RETURN) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; SSL_free(c-&gt;ssl-&gt;connection);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;ssl = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (sslerr == SSL_ERROR_WANT_READ || sslerr == SSL_ERROR_WANT_WRITE) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;read-&gt;handler = <a href="#L1831" title="event/ngx_event_openssl.c:1831">ngx_ssl_shutdown_handler</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;write-&gt;handler = <a href="#L1831" title="event/ngx_event_openssl.c:1831">ngx_ssl_shutdown_handler</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="ngx_event.c.html#L270" title="event/ngx_event.c:270">ngx_handle_read_event</a>(c-&gt;read, <span class="Constant">0</span>) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="ngx_event.c.html#L338" title="event/ngx_event.c:338">ngx_handle_write_event</a>(c-&gt;write, <span class="Constant">0</span>) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (sslerr == SSL_ERROR_WANT_READ) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_event.h.html#L427" title="event/ngx_event.h:427">ngx_add_timer</a>(c-&gt;read, <span class="Constant">30000</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L31" title="core/ngx_core.h:31">NGX_AGAIN</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; err = (sslerr == SSL_ERROR_SYSCALL) ? <a href="../os/unix/ngx_errno.h.html#L68" title="os/unix/ngx_errno.h:68">ngx_errno</a> : <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L1854" title="event/ngx_event_openssl.c:1854">ngx_ssl_connection_error</a>(c, sslerr, err, <span class="Constant">&quot;SSL_shutdown() failed&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; SSL_free(c-&gt;ssl-&gt;connection);<br/></li>
<li>&nbsp; &nbsp; c-&gt;ssl = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L1831">&#x200c;</a></span><span class="linkable">ngx_ssl_shutdown_handler</span>(<a href="../core/ngx_core.h.html#L21" title="core/ngx_core.h:21">ngx_event_t</a> *ev)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L23" title="core/ngx_core.h:23">ngx_connection_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *c;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L26" title="core/ngx_core.h:26">ngx_connection_handler_pt</a>&nbsp;&nbsp; handler;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c = ev-&gt;data;<br/></li>
<li>&nbsp; &nbsp; handler = c-&gt;ssl-&gt;handler;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ev-&gt;timedout) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;timedout = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L132" title="core/ngx_log.h:132">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L29" title="core/ngx_log.h:29">NGX_LOG_DEBUG_EVENT</a>, ev-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;SSL shutdown handler&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L1749" title="event/ngx_event_openssl.c:1749">ngx_ssl_shutdown</a>(c) == <a href="../core/ngx_core.h.html#L31" title="core/ngx_core.h:31">NGX_AGAIN</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; handler(c);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L1854">&#x200c;</a></span><span class="linkable">ngx_ssl_connection_error</span>(<a href="../core/ngx_core.h.html#L23" title="core/ngx_core.h:23">ngx_connection_t</a> *c, <span class="Type">int</span> sslerr, <a href="../os/unix/ngx_errno.h.html#L16" title="os/unix/ngx_errno.h:16">ngx_err_t</a> err,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span> *text)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; n;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; level;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; level = <a href="../core/ngx_log.h.html#L19" title="core/ngx_log.h:19">NGX_LOG_CRIT</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (sslerr == SSL_ERROR_SYSCALL) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (err == <a href="../os/unix/ngx_errno.h.html#L41" title="os/unix/ngx_errno.h:41">NGX_ECONNRESET</a><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || err == <a href="../os/unix/ngx_errno.h.html#L35" title="os/unix/ngx_errno.h:35">NGX_EPIPE</a><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || err == <a href="../os/unix/ngx_errno.h.html#L42" title="os/unix/ngx_errno.h:42">NGX_ENOTCONN</a><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || err == <a href="../os/unix/ngx_errno.h.html#L43" title="os/unix/ngx_errno.h:43">NGX_ETIMEDOUT</a><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || err == <a href="../os/unix/ngx_errno.h.html#L44" title="os/unix/ngx_errno.h:44">NGX_ECONNREFUSED</a><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || err == <a href="../os/unix/ngx_errno.h.html#L46" title="os/unix/ngx_errno.h:46">NGX_ENETDOWN</a><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || err == <a href="../os/unix/ngx_errno.h.html#L47" title="os/unix/ngx_errno.h:47">NGX_ENETUNREACH</a><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || err == <a href="../os/unix/ngx_errno.h.html#L48" title="os/unix/ngx_errno.h:48">NGX_EHOSTDOWN</a><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || err == <a href="../os/unix/ngx_errno.h.html#L49" title="os/unix/ngx_errno.h:49">NGX_EHOSTUNREACH</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (c-&gt;log_error) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> NGX_ERROR_IGNORE_ECONNRESET:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> NGX_ERROR_INFO:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; level = <a href="../core/ngx_log.h.html#L23" title="core/ngx_log.h:23">NGX_LOG_INFO</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> NGX_ERROR_ERR:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; level = <a href="../core/ngx_log.h.html#L20" title="core/ngx_log.h:20">NGX_LOG_ERR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (sslerr == SSL_ERROR_SSL) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; n = ERR_GET_REASON(ERR_peek_error());<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* handshake failures */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n == SSL_R_BAD_CHANGE_CIPHER_SPEC&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*&nbsp; 103 */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || n == SSL_R_BLOCK_CIPHER_PAD_IS_WRONG&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*&nbsp; 129 */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || n == SSL_R_DIGEST_CHECK_FAILED&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*&nbsp; 149 */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || n == SSL_R_ERROR_IN_RECEIVED_CIPHER_LIST&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*&nbsp; 151 */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || n == SSL_R_EXCESSIVE_MESSAGE_SIZE&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">/*&nbsp; 152 */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || n == SSL_R_LENGTH_MISMATCH&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*&nbsp; 159 */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || n == SSL_R_NO_CIPHERS_PASSED&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*&nbsp; 182 */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || n == SSL_R_NO_CIPHERS_SPECIFIED&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">/*&nbsp; 183 */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || n == SSL_R_NO_COMPRESSION_SPECIFIED&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">/*&nbsp; 187 */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || n == SSL_R_NO_SHARED_CIPHER&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">/*&nbsp; 193 */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || n == SSL_R_RECORD_LENGTH_MISMATCH&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">/*&nbsp; 213 */<br/></li>
<li></span><span class="PreProc">#ifdef SSL_R_PARSE_TLSEXT<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || n == SSL_R_PARSE_TLSEXT&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">/*&nbsp; 227 */<br/></li>
<li></span><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || n == SSL_R_UNEXPECTED_MESSAGE&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">/*&nbsp; 244 */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || n == SSL_R_UNEXPECTED_RECORD&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*&nbsp; 245 */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || n == SSL_R_UNKNOWN_ALERT_TYPE&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">/*&nbsp; 246 */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || n == SSL_R_UNKNOWN_PROTOCOL&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">/*&nbsp; 252 */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || n == SSL_R_WRONG_VERSION_NUMBER&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">/*&nbsp; 267 */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || n == SSL_R_DECRYPTION_FAILED_OR_BAD_RECORD_MAC&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*&nbsp; 281 */<br/></li>
<li></span><span class="PreProc">#ifdef SSL_R_RENEGOTIATE_EXT_TOO_LONG<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || n == SSL_R_RENEGOTIATE_EXT_TOO_LONG&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">/*&nbsp; 335 */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || n == SSL_R_RENEGOTIATION_ENCODING_ERR&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">/*&nbsp; 336 */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || n == SSL_R_RENEGOTIATION_MISMATCH&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">/*&nbsp; 337 */<br/></li>
<li></span><span class="PreProc">#endif<br/></li>
<li></span><span class="PreProc">#ifdef SSL_R_UNSAFE_LEGACY_RENEGOTIATION_DISABLED<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || n == SSL_R_UNSAFE_LEGACY_RENEGOTIATION_DISABLED&nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">/*&nbsp; 338 */<br/></li>
<li></span><span class="PreProc">#endif<br/></li>
<li></span><span class="PreProc">#ifdef SSL_R_SCSV_RECEIVED_WHEN_RENEGOTIATING<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || n == SSL_R_SCSV_RECEIVED_WHEN_RENEGOTIATING&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">/*&nbsp; 345 */<br/></li>
<li></span><span class="PreProc">#endif<br/></li>
<li></span><span class="PreProc">#ifdef SSL_R_INAPPROPRIATE_FALLBACK<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || n == SSL_R_INAPPROPRIATE_FALLBACK&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">/*&nbsp; 373 */<br/></li>
<li></span><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || n == <span class="Constant">1000</span> <span class="Comment">/* SSL_R_SSLV3_ALERT_CLOSE_NOTIFY */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || n == SSL_R_SSLV3_ALERT_UNEXPECTED_MESSAGE&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">/* 1010 */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || n == SSL_R_SSLV3_ALERT_BAD_RECORD_MAC&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">/* 1020 */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || n == SSL_R_TLSV1_ALERT_DECRYPTION_FAILED&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* 1021 */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || n == SSL_R_TLSV1_ALERT_RECORD_OVERFLOW&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* 1022 */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || n == SSL_R_SSLV3_ALERT_DECOMPRESSION_FAILURE&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* 1030 */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || n == SSL_R_SSLV3_ALERT_HANDSHAKE_FAILURE&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* 1040 */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || n == SSL_R_SSLV3_ALERT_NO_CERTIFICATE&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">/* 1041 */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || n == SSL_R_SSLV3_ALERT_BAD_CERTIFICATE&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* 1042 */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || n == SSL_R_SSLV3_ALERT_UNSUPPORTED_CERTIFICATE&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* 1043 */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || n == SSL_R_SSLV3_ALERT_CERTIFICATE_REVOKED&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* 1044 */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || n == SSL_R_SSLV3_ALERT_CERTIFICATE_EXPIRED&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* 1045 */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || n == SSL_R_SSLV3_ALERT_CERTIFICATE_UNKNOWN&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* 1046 */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || n == SSL_R_SSLV3_ALERT_ILLEGAL_PARAMETER&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* 1047 */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || n == SSL_R_TLSV1_ALERT_UNKNOWN_CA&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">/* 1048 */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || n == SSL_R_TLSV1_ALERT_ACCESS_DENIED&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* 1049 */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || n == SSL_R_TLSV1_ALERT_DECODE_ERROR&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">/* 1050 */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || n == SSL_R_TLSV1_ALERT_DECRYPT_ERROR&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* 1051 */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || n == SSL_R_TLSV1_ALERT_EXPORT_RESTRICTION&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">/* 1060 */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || n == SSL_R_TLSV1_ALERT_PROTOCOL_VERSION&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">/* 1070 */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || n == SSL_R_TLSV1_ALERT_INSUFFICIENT_SECURITY&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* 1071 */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || n == SSL_R_TLSV1_ALERT_INTERNAL_ERROR&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">/* 1080 */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || n == SSL_R_TLSV1_ALERT_USER_CANCELLED&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">/* 1090 */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || n == SSL_R_TLSV1_ALERT_NO_RENEGOTIATION)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* 1100 */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (c-&gt;log_error) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> NGX_ERROR_IGNORE_ECONNRESET:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> NGX_ERROR_INFO:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; level = <a href="../core/ngx_log.h.html#L23" title="core/ngx_log.h:23">NGX_LOG_INFO</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> NGX_ERROR_ERR:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; level = <a href="../core/ngx_log.h.html#L20" title="core/ngx_log.h:20">NGX_LOG_ERR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L1987" title="event/ngx_event_openssl.c:1987">ngx_ssl_error</a>(level, c-&gt;log, err, text);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L1976">&#x200c;</a></span><span class="linkable">ngx_ssl_clear_error</span>(<a href="../core/ngx_core.h.html#L17" title="core/ngx_core.h:17">ngx_log_t</a> *log)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (ERR_peek_error()) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1987" title="event/ngx_event_openssl.c:1987">ngx_ssl_error</a>(<a href="../core/ngx_log.h.html#L18" title="core/ngx_log.h:18">NGX_LOG_ALERT</a>, log, <span class="Constant">0</span>, <span class="Constant">&quot;ignoring stale global SSL error&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ERR_clear_error();<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">void</span> <a href="../core/ngx_config.h.html#L73" title="core/ngx_config.h:73">ngx_cdecl</a><br/></li>
<li><a id="L1987">&#x200c;</a><span class="linkable">ngx_ssl_error</span>(<a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> level, <a href="../core/ngx_core.h.html#L17" title="core/ngx_core.h:17">ngx_log_t</a> *log, <a href="../os/unix/ngx_errno.h.html#L16" title="os/unix/ngx_errno.h:16">ngx_err_t</a> err, <span class="Type">char</span> *fmt, ...)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; flags;<br/></li>
<li>&nbsp; &nbsp; u_long&nbsp; &nbsp; &nbsp;&nbsp; n;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">va_list</span>&nbsp; &nbsp; &nbsp; args;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; *p, *last;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp;&nbsp; errstr[<a href="../core/ngx_conf_file.h.html#L75" title="core/ngx_conf_file.h:75">NGX_MAX_CONF_ERRSTR</a>];<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span>&nbsp; *data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; last = errstr + <a href="../core/ngx_conf_file.h.html#L75" title="core/ngx_conf_file.h:75">NGX_MAX_CONF_ERRSTR</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; va_start(args, fmt);<br/></li>
<li>&nbsp; &nbsp; p = <a href="../core/ngx_string.c.html#L147" title="core/ngx_string.c:147">ngx_vslprintf</a>(errstr, last - <span class="Constant">1</span>, fmt, args);<br/></li>
<li>&nbsp; &nbsp; va_end(args);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p = <a href="../core/ngx_string.c.html#L33" title="core/ngx_string.c:33">ngx_cpystrn</a>(p, (u_char *) <span class="Constant">&quot; (SSL:&quot;</span>, last - p);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> ( ;; ) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; n = ERR_peek_error_line_data(<span class="Constant">NULL</span>, <span class="Constant">NULL</span>, &amp;data, &amp;flags);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (p &gt;= last) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *p++ = <span class="Constant">' '</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ERR_error_string_n(n, (<span class="Type">char</span> *) p, last - p);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">while</span> (p &lt; last &amp;&amp; *p) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (p &lt; last &amp;&amp; *data &amp;&amp; (flags &amp; ERR_TXT_STRING)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *p++ = <span class="Constant">':'</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = <a href="../core/ngx_string.c.html#L33" title="core/ngx_string.c:33">ngx_cpystrn</a>(p, (u_char *) data, last - p);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; </span><span class="Statement">next</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; (<span class="Type">void</span>) ERR_get_error();<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(level, log, err, <span class="Constant">&quot;</span><span class="Special">%s</span><span class="Constant">)&quot;</span>, errstr);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L2039">&#x200c;</a><span class="linkable">ngx_ssl_session_cache</span>(<a href="ngx_event_openssl.h.html#L44" title="event/ngx_event_openssl.h:44">ngx_ssl_t</a> *ssl, <a href="../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a> *sess_ctx,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">ssize_t</span> builtin_session_cache, <a href="../core/ngx_cycle.h.html#L25" title="core/ngx_cycle.h:25">ngx_shm_zone_t</a> *shm_zone, <span class="Type">time_t</span> timeout)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">long</span>&nbsp; cache_mode;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; SSL_CTX_set_timeout(ssl-&gt;ctx, (<span class="Type">long</span>) timeout);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L2112" title="event/ngx_event_openssl.c:2112">ngx_ssl_session_id_context</a>(ssl, sess_ctx) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (builtin_session_cache == <a href="ngx_event_openssl.h.html#L68" title="event/ngx_event_openssl.h:68">NGX_SSL_NO_SCACHE</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; SSL_CTX_set_session_cache_mode(ssl-&gt;ctx, SSL_SESS_CACHE_OFF);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (builtin_session_cache == <a href="ngx_event_openssl.h.html#L69" title="event/ngx_event_openssl.h:69">NGX_SSL_NONE_SCACHE</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * If the server explicitly says that it does not support<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * session reuse (see SSL_SESS_CACHE_OFF above), then<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * Outlook Express fails to upload a sent email to<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * the Sent Items folder on the IMAP server via a separate IMAP<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * connection in the background. Therefore we have a special<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * mode (SSL_SESS_CACHE_SERVER|SSL_SESS_CACHE_NO_INTERNAL_STORE)<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * where the server pretends that it supports session reuse,<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * but it does not actually store any session.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; SSL_CTX_set_session_cache_mode(ssl-&gt;ctx,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; SSL_SESS_CACHE_SERVER<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; |SSL_SESS_CACHE_NO_AUTO_CLEAR<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; |SSL_SESS_CACHE_NO_INTERNAL_STORE);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; SSL_CTX_sess_set_cache_size(ssl-&gt;ctx, <span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cache_mode = SSL_SESS_CACHE_SERVER;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (shm_zone &amp;&amp; builtin_session_cache == <a href="ngx_event_openssl.h.html#L70" title="event/ngx_event_openssl.h:70">NGX_SSL_NO_BUILTIN_SCACHE</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cache_mode |= SSL_SESS_CACHE_NO_INTERNAL;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; SSL_CTX_set_session_cache_mode(ssl-&gt;ctx, cache_mode);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (builtin_session_cache != <a href="ngx_event_openssl.h.html#L70" title="event/ngx_event_openssl.h:70">NGX_SSL_NO_BUILTIN_SCACHE</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (builtin_session_cache != <a href="ngx_event_openssl.h.html#L71" title="event/ngx_event_openssl.h:71">NGX_SSL_DFLT_BUILTIN_SCACHE</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; SSL_CTX_sess_set_cache_size(ssl-&gt;ctx, builtin_session_cache);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (shm_zone) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; SSL_CTX_sess_set_new_cb(ssl-&gt;ctx, <a href="#L2267" title="event/ngx_event_openssl.c:2267">ngx_ssl_new_session</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; SSL_CTX_sess_set_get_cb(ssl-&gt;ctx, <a href="#L2416" title="event/ngx_event_openssl.c:2416">ngx_ssl_get_cached_session</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; SSL_CTX_sess_set_remove_cb(ssl-&gt;ctx, <a href="#L2527" title="event/ngx_event_openssl.c:2527">ngx_ssl_remove_session</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (SSL_CTX_set_ex_data(ssl-&gt;ctx, <a href="#L102" title="event/ngx_event_openssl.c:102">ngx_ssl_session_cache_index</a>, shm_zone)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1987" title="event/ngx_event_openssl.c:1987">ngx_ssl_error</a>(<a href="../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, ssl-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;SSL_CTX_set_ex_data() failed&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L2112">&#x200c;</a><span class="linkable">ngx_ssl_session_id_context</span>(<a href="ngx_event_openssl.h.html#L44" title="event/ngx_event_openssl.h:44">ngx_ssl_t</a> *ssl, <a href="../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a> *sess_ctx)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; n, i;<br/></li>
<li>&nbsp; &nbsp; X509&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *cert;<br/></li>
<li>&nbsp; &nbsp; X509_NAME&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *name;<br/></li>
<li>&nbsp; &nbsp; EVP_MD_CTX&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; md;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">unsigned</span> <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len;<br/></li>
<li>&nbsp; &nbsp; STACK_OF(X509_NAME)&nbsp; *list;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; buf[EVP_MAX_MD_SIZE];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Session ID context is <a href="modules/ngx_rtsig_module.c.html#L75" title="event/modules/ngx_rtsig_module.c:75">set</a> based on the string provided,<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * the server certificate, and the client CA list.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; EVP_MD_CTX_init(&amp;md);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (EVP_DigestInit_ex(&amp;md, EVP_sha1(), <span class="Constant">NULL</span>) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1987" title="event/ngx_event_openssl.c:1987">ngx_ssl_error</a>(<a href="../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, ssl-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;EVP_DigestInit_ex() failed&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (EVP_DigestUpdate(&amp;md, sess_ctx-&gt;data, sess_ctx-&gt;len) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1987" title="event/ngx_event_openssl.c:1987">ngx_ssl_error</a>(<a href="../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, ssl-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;EVP_DigestUpdate() failed&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cert = SSL_CTX_get_ex_data(ssl-&gt;ctx, <a href="#L104" title="event/ngx_event_openssl.c:104">ngx_ssl_certificate_index</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (X509_digest(cert, EVP_sha1(), buf, &amp;len) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1987" title="event/ngx_event_openssl.c:1987">ngx_ssl_error</a>(<a href="../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, ssl-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;X509_digest() failed&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (EVP_DigestUpdate(&amp;md, buf, len) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1987" title="event/ngx_event_openssl.c:1987">ngx_ssl_error</a>(<a href="../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, ssl-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;EVP_DigestUpdate() failed&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; list = SSL_CTX_get_client_CA_list(ssl-&gt;ctx);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (list != <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; n = sk_X509_NAME_num(list);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; n; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; name = sk_X509_NAME_value(list, i);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (X509_NAME_digest(name, EVP_sha1(), buf, &amp;len) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1987" title="event/ngx_event_openssl.c:1987">ngx_ssl_error</a>(<a href="../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, ssl-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;X509_NAME_digest() failed&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (EVP_DigestUpdate(&amp;md, buf, len) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1987" title="event/ngx_event_openssl.c:1987">ngx_ssl_error</a>(<a href="../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, ssl-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;EVP_DigestUpdate() failed&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (EVP_DigestFinal_ex(&amp;md, buf, &amp;len) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1987" title="event/ngx_event_openssl.c:1987">ngx_ssl_error</a>(<a href="../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, ssl-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;EVP_DigestUpdate() failed&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; EVP_MD_CTX_cleanup(&amp;md);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (SSL_CTX_set_session_id_context(ssl-&gt;ctx, buf, len) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1987" title="event/ngx_event_openssl.c:1987">ngx_ssl_error</a>(<a href="../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, ssl-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;SSL_CTX_set_session_id_context() failed&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li><br/></li>
<li><span class="Statement">failed</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; EVP_MD_CTX_cleanup(&amp;md);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L2202">&#x200c;</a><span class="linkable">ngx_ssl_session_cache_init</span>(<a href="../core/ngx_cycle.h.html#L25" title="core/ngx_cycle.h:25">ngx_shm_zone_t</a> *shm_zone, <span class="Type">void</span> *data)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_slab.h.html#L47" title="core/ngx_slab.h:47">ngx_slab_pool_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *shpool;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_event_openssl.h.html#L96" title="event/ngx_event_openssl.h:96">ngx_ssl_session_cache_t</a>&nbsp; *cache;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (data) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; shm_zone-&gt;data = data;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; shpool = (<a href="../core/ngx_slab.h.html#L47" title="core/ngx_slab.h:47">ngx_slab_pool_t</a> *) shm_zone-&gt;shm.addr;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (shm_zone-&gt;shm.exists) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; shm_zone-&gt;data = shpool-&gt;data;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cache = <a href="../core/ngx_slab.c.html#L141" title="core/ngx_slab.c:141">ngx_slab_alloc</a>(shpool, <span class="Statement">sizeof</span>(<a href="ngx_event_openssl.h.html#L96" title="event/ngx_event_openssl.h:96">ngx_ssl_session_cache_t</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cache == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; shpool-&gt;data = cache;<br/></li>
<li>&nbsp; &nbsp; shm_zone-&gt;data = cache;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_rbtree.h.html#L44" title="core/ngx_rbtree.h:44">ngx_rbtree_init</a>(&amp;cache-&gt;session_rbtree, &amp;cache-&gt;sentinel,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2653" title="event/ngx_event_openssl.c:2653">ngx_ssl_session_rbtree_insert_value</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_queue.h.html#L24" title="core/ngx_queue.h:24">ngx_queue_init</a>(&amp;cache-&gt;expire_queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; len = <span class="Statement">sizeof</span>(<span class="Constant">&quot; in SSL session shared cache </span><span class="Special">\&quot;\&quot;</span><span class="Constant">&quot;</span>) + shm_zone-&gt;shm.name.len;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; shpool-&gt;log_ctx = <a href="../core/ngx_slab.c.html#L141" title="core/ngx_slab.c:141">ngx_slab_alloc</a>(shpool, len);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (shpool-&gt;log_ctx == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.c.html#L105" title="core/ngx_string.c:105">ngx_sprintf</a>(shpool-&gt;log_ctx, <span class="Constant">&quot; in SSL session shared cache </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">%Z&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;shm_zone-&gt;shm.name);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; shpool-&gt;log_nomem = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * The length of the session id is 16 bytes for SSLv2 sessions and<br/></li>
<li></span><span class="Comment"> * between 1 and 32 bytes for SSLv3/TLSv1, typically 32 bytes.<br/></li>
<li></span><span class="Comment"> * It seems that the typical length of the external ASN1 representation<br/></li>
<li></span><span class="Comment"> * of a session is 118 or 119 bytes for SSLv3/TSLv1.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Thus on 32-bit platforms we allocate separately an rbtree node,<br/></li>
<li></span><span class="Comment"> * a session id, and an ASN1 representation, they take accordingly<br/></li>
<li></span><span class="Comment"> * 64, 32, and 128 bytes.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * On 64-bit platforms we allocate separately an rbtree node + session_id,<br/></li>
<li></span><span class="Comment"> * and an ASN1 representation, they take accordingly 128 and 128 bytes.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * OpenSSL's i2d_SSL_SESSION() and d2i_SSL_SESSION are slow,<br/></li>
<li></span><span class="Comment"> * so they are outside the code locked by shared pool mutex<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><span class="Type">static</span> <span class="Type">int<br/></li>
<li><a id="L2267">&#x200c;</a></span><span class="linkable">ngx_ssl_new_session</span>(<a href="ngx_event_openssl.h.html#L37" title="event/ngx_event_openssl.h:37">ngx_ssl_conn_t</a> *ssl_conn, <a href="ngx_event_openssl.h.html#L36" title="event/ngx_event_openssl.h:36">ngx_ssl_session_t</a> *sess)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; len;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *p, *id, *cached_sess, *session_id;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uint32_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; hash;<br/></li>
<li>&nbsp; &nbsp; SSL_CTX&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *ssl_ctx;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">unsigned</span> <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; session_id_length;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_cycle.h.html#L25" title="core/ngx_cycle.h:25">ngx_shm_zone_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *shm_zone;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L23" title="core/ngx_core.h:23">ngx_connection_t</a>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *c;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_slab.h.html#L47" title="core/ngx_slab.h:47">ngx_slab_pool_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *shpool;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_event_openssl.h.html#L76" title="event/ngx_event_openssl.h:76">ngx_ssl_sess_id_t</a>&nbsp; &nbsp; &nbsp; &nbsp; *sess_id;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_event_openssl.h.html#L96" title="event/ngx_event_openssl.h:96">ngx_ssl_session_cache_t</a>&nbsp; *cache;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; buf[<a href="ngx_event_openssl.h.html#L74" title="event/ngx_event_openssl.h:74">NGX_SSL_MAX_SESSION_SIZE</a>];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; len = i2d_SSL_SESSION(sess, <span class="Constant">NULL</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* do not cache too big session */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (len &gt; (<span class="Type">int</span>) <a href="ngx_event_openssl.h.html#L74" title="event/ngx_event_openssl.h:74">NGX_SSL_MAX_SESSION_SIZE</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p = buf;<br/></li>
<li>&nbsp; &nbsp; i2d_SSL_SESSION(sess, &amp;p);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c = <a href="ngx_event_openssl.h.html#L153" title="event/ngx_event_openssl.h:153">ngx_ssl_get_connection</a>(ssl_conn);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ssl_ctx = SSL_get_SSL_CTX(ssl_conn);<br/></li>
<li>&nbsp; &nbsp; shm_zone = SSL_CTX_get_ex_data(ssl_ctx, <a href="#L102" title="event/ngx_event_openssl.c:102">ngx_ssl_session_cache_index</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cache = shm_zone-&gt;data;<br/></li>
<li>&nbsp; &nbsp; shpool = (<a href="../core/ngx_slab.h.html#L47" title="core/ngx_slab.h:47">ngx_slab_pool_t</a> *) shm_zone-&gt;shm.addr;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_shmtx.c.html#L70" title="core/ngx_shmtx.c:70">ngx_shmtx_lock</a>(&amp;shpool-&gt;mutex);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* drop one or two expired sessions */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L2613" title="event/ngx_event_openssl.c:2613">ngx_ssl_expire_sessions</a>(cache, shpool, <span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cached_sess = <a href="../core/ngx_slab.c.html#L156" title="core/ngx_slab.c:156">ngx_slab_alloc_locked</a>(shpool, len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cached_sess == <span class="Constant">NULL</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* drop the oldest non-expired session and try once more */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2613" title="event/ngx_event_openssl.c:2613">ngx_ssl_expire_sessions</a>(cache, shpool, <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cached_sess = <a href="../core/ngx_slab.c.html#L156" title="core/ngx_slab.c:156">ngx_slab_alloc_locked</a>(shpool, len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (cached_sess == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sess_id = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; sess_id = <a href="../core/ngx_slab.c.html#L156" title="core/ngx_slab.c:156">ngx_slab_alloc_locked</a>(shpool, <span class="Statement">sizeof</span>(<a href="ngx_event_openssl.h.html#L76" title="event/ngx_event_openssl.h:76">ngx_ssl_sess_id_t</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (sess_id == <span class="Constant">NULL</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* drop the oldest non-expired session and try once more */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2613" title="event/ngx_event_openssl.c:2613">ngx_ssl_expire_sessions</a>(cache, shpool, <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; sess_id = <a href="../core/ngx_slab.c.html#L156" title="core/ngx_slab.c:156">ngx_slab_alloc_locked</a>(shpool, <span class="Statement">sizeof</span>(<a href="ngx_event_openssl.h.html#L76" title="event/ngx_event_openssl.h:76">ngx_ssl_sess_id_t</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (sess_id == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#if OPENSSL_VERSION_NUMBER &gt;= </span><span class="Constant">0x0090800fL<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; session_id = (u_char *) SSL_SESSION_get_id(sess, &amp;session_id_length);<br/></li>
<li><br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; session_id = sess-&gt;session_id;<br/></li>
<li>&nbsp; &nbsp; session_id_length = sess-&gt;session_id_length;<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#if (NGX_PTR_SIZE == </span><span class="Constant">8</span><span class="PreProc">)<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; id = sess_id-&gt;sess_id;<br/></li>
<li><br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; id = <a href="../core/ngx_slab.c.html#L156" title="core/ngx_slab.c:156">ngx_slab_alloc_locked</a>(shpool, session_id_length);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (id == <span class="Constant">NULL</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* drop the oldest non-expired session and try once more */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2613" title="event/ngx_event_openssl.c:2613">ngx_ssl_expire_sessions</a>(cache, shpool, <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; id = <a href="../core/ngx_slab.c.html#L156" title="core/ngx_slab.c:156">ngx_slab_alloc_locked</a>(shpool, session_id_length);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (id == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.c.html#L1947" title="core/ngx_string.c:1947">ngx_memcpy</a>(cached_sess, buf, len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.c.html#L1947" title="core/ngx_string.c:1947">ngx_memcpy</a>(id, session_id, session_id_length);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; hash = <a href="../core/ngx_crc32.h.html#L21" title="core/ngx_crc32.h:21">ngx_crc32_short</a>(session_id, session_id_length);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L141" title="core/ngx_log.h:141">ngx_log_debug3</a>(<a href="../core/ngx_log.h.html#L29" title="core/ngx_log.h:29">NGX_LOG_DEBUG_EVENT</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;ssl new session: </span><span class="Special">%08X</span><span class="Constant">D:</span><span class="Special">%u</span><span class="Constant">d:</span><span class="Special">%d</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; hash, session_id_length, len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; sess_id-&gt;node.key = hash;<br/></li>
<li>&nbsp; &nbsp; sess_id-&gt;node.data = (u_char) session_id_length;<br/></li>
<li>&nbsp; &nbsp; sess_id-&gt;id = id;<br/></li>
<li>&nbsp; &nbsp; sess_id-&gt;len = len;<br/></li>
<li>&nbsp; &nbsp; sess_id-&gt;session = cached_sess;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; sess_id-&gt;expire = <a href="../core/ngx_times.h.html#L36" title="core/ngx_times.h:36">ngx_time</a>() + SSL_CTX_get_timeout(ssl_ctx);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_queue.h.html#L33" title="core/ngx_queue.h:33">ngx_queue_insert_head</a>(&amp;cache-&gt;expire_queue, &amp;sess_id-&gt;queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_rbtree.c.html#L25" title="core/ngx_rbtree.c:25">ngx_rbtree_insert</a>(&amp;cache-&gt;session_rbtree, &amp;sess_id-&gt;node);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_shmtx.c.html#L136" title="core/ngx_shmtx.c:136">ngx_shmtx_unlock</a>(&amp;shpool-&gt;mutex);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li><span class="Statement">failed</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cached_sess) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_slab.c.html#L442" title="core/ngx_slab.c:442">ngx_slab_free_locked</a>(shpool, cached_sess);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (sess_id) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_slab.c.html#L442" title="core/ngx_slab.c:442">ngx_slab_free_locked</a>(shpool, sess_id);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_shmtx.c.html#L136" title="core/ngx_shmtx.c:136">ngx_shmtx_unlock</a>(&amp;shpool-&gt;mutex);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L18" title="core/ngx_log.h:18">NGX_LOG_ALERT</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;could not allocate new session</span><span class="Special">%s</span><span class="Constant">&quot;</span>, shpool-&gt;log_ctx);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="ngx_event_openssl.h.html#L36" title="event/ngx_event_openssl.h:36">ngx_ssl_session_t</a> *<br/></li>
<li><a id="L2416">&#x200c;</a><span class="linkable">ngx_ssl_get_cached_session</span>(<a href="ngx_event_openssl.h.html#L37" title="event/ngx_event_openssl.h:37">ngx_ssl_conn_t</a> *ssl_conn, u_char *id, <span class="Type">int</span> len,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span> *copy)<br/></li>
<li>{<br/></li>
<li><span class="PreProc">#if OPENSSL_VERSION_NUMBER &gt;= </span><span class="Constant">0x0090707fL<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">const<br/></li>
<li></span><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *p;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uint32_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; hash;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; rc;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_cycle.h.html#L25" title="core/ngx_cycle.h:25">ngx_shm_zone_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *shm_zone;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_slab.h.html#L47" title="core/ngx_slab.h:47">ngx_slab_pool_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *shpool;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_rbtree.h.html#L20" title="core/ngx_rbtree.h:20">ngx_rbtree_node_t</a>&nbsp; &nbsp; &nbsp; &nbsp; *node, *sentinel;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_event_openssl.h.html#L36" title="event/ngx_event_openssl.h:36">ngx_ssl_session_t</a>&nbsp; &nbsp; &nbsp; &nbsp; *sess;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_event_openssl.h.html#L76" title="event/ngx_event_openssl.h:76">ngx_ssl_sess_id_t</a>&nbsp; &nbsp; &nbsp; &nbsp; *sess_id;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_event_openssl.h.html#L96" title="event/ngx_event_openssl.h:96">ngx_ssl_session_cache_t</a>&nbsp; *cache;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; buf[<a href="ngx_event_openssl.h.html#L74" title="event/ngx_event_openssl.h:74">NGX_SSL_MAX_SESSION_SIZE</a>];<br/></li>
<li><span class="PreProc">#if (NGX_DEBUG)<br/></li>
<li></span>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L23" title="core/ngx_core.h:23">ngx_connection_t</a>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *c;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; hash = <a href="../core/ngx_crc32.h.html#L21" title="core/ngx_crc32.h:21">ngx_crc32_short</a>(id, (<span class="Type">size_t</span>) len);<br/></li>
<li>&nbsp; &nbsp; *copy = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_DEBUG)<br/></li>
<li></span>&nbsp; &nbsp; c = <a href="ngx_event_openssl.h.html#L153" title="event/ngx_event_openssl.h:153">ngx_ssl_get_connection</a>(ssl_conn);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L138" title="core/ngx_log.h:138">ngx_log_debug2</a>(<a href="../core/ngx_log.h.html#L29" title="core/ngx_log.h:29">NGX_LOG_DEBUG_EVENT</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;ssl get session: </span><span class="Special">%08X</span><span class="Constant">D:</span><span class="Special">%d</span><span class="Constant">&quot;</span>, hash, len);<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; shm_zone = SSL_CTX_get_ex_data(SSL_get_SSL_CTX(ssl_conn),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L102" title="event/ngx_event_openssl.c:102">ngx_ssl_session_cache_index</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cache = shm_zone-&gt;data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; sess = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; shpool = (<a href="../core/ngx_slab.h.html#L47" title="core/ngx_slab.h:47">ngx_slab_pool_t</a> *) shm_zone-&gt;shm.addr;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_shmtx.c.html#L70" title="core/ngx_shmtx.c:70">ngx_shmtx_lock</a>(&amp;shpool-&gt;mutex);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; node = cache-&gt;session_rbtree.root;<br/></li>
<li>&nbsp; &nbsp; sentinel = cache-&gt;session_rbtree.sentinel;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (node != sentinel) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (hash &lt; node-&gt;key) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; node = node-&gt;left;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (hash &gt; node-&gt;key) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; node = node-&gt;right;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* hash == node-&gt;key */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; sess_id = (<a href="ngx_event_openssl.h.html#L76" title="event/ngx_event_openssl.h:76">ngx_ssl_sess_id_t</a> *) node;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="../core/ngx_string.c.html#L802" title="core/ngx_string.c:802">ngx_memn2cmp</a>(id, sess_id-&gt;id, (<span class="Type">size_t</span>) len, (<span class="Type">size_t</span>) node-&gt;data);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc == <span class="Constant">0</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (sess_id-&gt;expire &gt; <a href="../core/ngx_times.h.html#L36" title="core/ngx_times.h:36">ngx_time</a>()) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_string.c.html#L1947" title="core/ngx_string.c:1947">ngx_memcpy</a>(buf, sess_id-&gt;session, sess_id-&gt;len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_shmtx.c.html#L136" title="core/ngx_shmtx.c:136">ngx_shmtx_unlock</a>(&amp;shpool-&gt;mutex);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = buf;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sess = d2i_SSL_SESSION(<span class="Constant">NULL</span>, &amp;p, sess_id-&gt;len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> sess;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_queue.h.html#L72" title="core/ngx_queue.h:72">ngx_queue_remove</a>(&amp;sess_id-&gt;queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_rbtree.c.html#L157" title="core/ngx_rbtree.c:157">ngx_rbtree_delete</a>(&amp;cache-&gt;session_rbtree, node);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_slab.c.html#L442" title="core/ngx_slab.c:442">ngx_slab_free_locked</a>(shpool, sess_id-&gt;session);<br/></li>
<li><span class="PreProc">#if (NGX_PTR_SIZE == </span><span class="Constant">4</span><span class="PreProc">)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_slab.c.html#L442" title="core/ngx_slab.c:442">ngx_slab_free_locked</a>(shpool, sess_id-&gt;id);<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_slab.c.html#L442" title="core/ngx_slab.c:442">ngx_slab_free_locked</a>(shpool, sess_id);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sess = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; node = (rc &lt; <span class="Constant">0</span>) ? node-&gt;left : node-&gt;right;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="Statement">done</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_shmtx.c.html#L136" title="core/ngx_shmtx.c:136">ngx_shmtx_unlock</a>(&amp;shpool-&gt;mutex);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> sess;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">void<br/></li>
<li><a id="L2518">&#x200c;</a></span><span class="linkable">ngx_ssl_remove_cached_session</span>(SSL_CTX *ssl, <a href="ngx_event_openssl.h.html#L36" title="event/ngx_event_openssl.h:36">ngx_ssl_session_t</a> *sess)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp;&nbsp; SSL_CTX_remove_session(ssl, sess);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp;&nbsp; <a href="#L2527" title="event/ngx_event_openssl.c:2527">ngx_ssl_remove_session</a>(ssl, sess);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L2527">&#x200c;</a></span><span class="linkable">ngx_ssl_remove_session</span>(SSL_CTX *ssl, <a href="ngx_event_openssl.h.html#L36" title="event/ngx_event_openssl.h:36">ngx_ssl_session_t</a> *sess)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *id;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">uint32_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; hash;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; rc;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">unsigned</span> <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_cycle.h.html#L25" title="core/ngx_cycle.h:25">ngx_shm_zone_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *shm_zone;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_slab.h.html#L47" title="core/ngx_slab.h:47">ngx_slab_pool_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *shpool;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_rbtree.h.html#L20" title="core/ngx_rbtree.h:20">ngx_rbtree_node_t</a>&nbsp; &nbsp; &nbsp; &nbsp; *node, *sentinel;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_event_openssl.h.html#L76" title="event/ngx_event_openssl.h:76">ngx_ssl_sess_id_t</a>&nbsp; &nbsp; &nbsp; &nbsp; *sess_id;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_event_openssl.h.html#L96" title="event/ngx_event_openssl.h:96">ngx_ssl_session_cache_t</a>&nbsp; *cache;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; shm_zone = SSL_CTX_get_ex_data(ssl, <a href="#L102" title="event/ngx_event_openssl.c:102">ngx_ssl_session_cache_index</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (shm_zone == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cache = shm_zone-&gt;data;<br/></li>
<li><br/></li>
<li><span class="PreProc">#if OPENSSL_VERSION_NUMBER &gt;= </span><span class="Constant">0x0090800fL<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; id = (u_char *) SSL_SESSION_get_id(sess, &amp;len);<br/></li>
<li><br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; id = sess-&gt;session_id;<br/></li>
<li>&nbsp; &nbsp; len = sess-&gt;session_id_length;<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; hash = <a href="../core/ngx_crc32.h.html#L21" title="core/ngx_crc32.h:21">ngx_crc32_short</a>(id, len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L138" title="core/ngx_log.h:138">ngx_log_debug2</a>(<a href="../core/ngx_log.h.html#L29" title="core/ngx_log.h:29">NGX_LOG_DEBUG_EVENT</a>, <a href="../core/ngx_cycle.c.html#L20" title="core/ngx_cycle.c:20">ngx_cycle</a>-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;ssl remove session: </span><span class="Special">%08X</span><span class="Constant">D:</span><span class="Special">%u</span><span class="Constant">d&quot;</span>, hash, len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; shpool = (<a href="../core/ngx_slab.h.html#L47" title="core/ngx_slab.h:47">ngx_slab_pool_t</a> *) shm_zone-&gt;shm.addr;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_shmtx.c.html#L70" title="core/ngx_shmtx.c:70">ngx_shmtx_lock</a>(&amp;shpool-&gt;mutex);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; node = cache-&gt;session_rbtree.root;<br/></li>
<li>&nbsp; &nbsp; sentinel = cache-&gt;session_rbtree.sentinel;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (node != sentinel) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (hash &lt; node-&gt;key) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; node = node-&gt;left;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (hash &gt; node-&gt;key) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; node = node-&gt;right;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* hash == node-&gt;key */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; sess_id = (<a href="ngx_event_openssl.h.html#L76" title="event/ngx_event_openssl.h:76">ngx_ssl_sess_id_t</a> *) node;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="../core/ngx_string.c.html#L802" title="core/ngx_string.c:802">ngx_memn2cmp</a>(id, sess_id-&gt;id, len, (<span class="Type">size_t</span>) node-&gt;data);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc == <span class="Constant">0</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_queue.h.html#L72" title="core/ngx_queue.h:72">ngx_queue_remove</a>(&amp;sess_id-&gt;queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_rbtree.c.html#L157" title="core/ngx_rbtree.c:157">ngx_rbtree_delete</a>(&amp;cache-&gt;session_rbtree, node);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_slab.c.html#L442" title="core/ngx_slab.c:442">ngx_slab_free_locked</a>(shpool, sess_id-&gt;session);<br/></li>
<li><span class="PreProc">#if (NGX_PTR_SIZE == </span><span class="Constant">4</span><span class="PreProc">)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_slab.c.html#L442" title="core/ngx_slab.c:442">ngx_slab_free_locked</a>(shpool, sess_id-&gt;id);<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_slab.c.html#L442" title="core/ngx_slab.c:442">ngx_slab_free_locked</a>(shpool, sess_id);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; node = (rc &lt; <span class="Constant">0</span>) ? node-&gt;left : node-&gt;right;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="Statement">done</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_shmtx.c.html#L136" title="core/ngx_shmtx.c:136">ngx_shmtx_unlock</a>(&amp;shpool-&gt;mutex);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L2613">&#x200c;</a></span><span class="linkable">ngx_ssl_expire_sessions</span>(<a href="ngx_event_openssl.h.html#L96" title="event/ngx_event_openssl.h:96">ngx_ssl_session_cache_t</a> *cache,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_slab.h.html#L47" title="core/ngx_slab.h:47">ngx_slab_pool_t</a> *shpool, <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a> n)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">time_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; now;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_queue.h.html#L16" title="core/ngx_queue.h:16">ngx_queue_t</a>&nbsp; &nbsp; &nbsp; &nbsp; *q;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_event_openssl.h.html#L76" title="event/ngx_event_openssl.h:76">ngx_ssl_sess_id_t</a>&nbsp; *sess_id;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; now = <a href="../core/ngx_times.h.html#L36" title="core/ngx_times.h:36">ngx_time</a>();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (n &lt; <span class="Constant">3</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_queue.h.html#L29" title="core/ngx_queue.h:29">ngx_queue_empty</a>(&amp;cache-&gt;expire_queue)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; q = <a href="../core/ngx_queue.h.html#L54" title="core/ngx_queue.h:54">ngx_queue_last</a>(&amp;cache-&gt;expire_queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; sess_id = <a href="../core/ngx_queue.h.html#L103" title="core/ngx_queue.h:103">ngx_queue_data</a>(q, <a href="ngx_event_openssl.h.html#L76" title="event/ngx_event_openssl.h:76">ngx_ssl_sess_id_t</a>, queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n++ != <span class="Constant">0</span> &amp;&amp; sess_id-&gt;expire &gt; now) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_queue.h.html#L72" title="core/ngx_queue.h:72">ngx_queue_remove</a>(q);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L135" title="core/ngx_log.h:135">ngx_log_debug1</a>(<a href="../core/ngx_log.h.html#L29" title="core/ngx_log.h:29">NGX_LOG_DEBUG_EVENT</a>, <a href="../core/ngx_cycle.c.html#L20" title="core/ngx_cycle.c:20">ngx_cycle</a>-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;expire session: </span><span class="Special">%08X</span><span class="Constant">i&quot;</span>, sess_id-&gt;node.key);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_rbtree.c.html#L157" title="core/ngx_rbtree.c:157">ngx_rbtree_delete</a>(&amp;cache-&gt;session_rbtree, &amp;sess_id-&gt;node);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_slab.c.html#L442" title="core/ngx_slab.c:442">ngx_slab_free_locked</a>(shpool, sess_id-&gt;session);<br/></li>
<li><span class="PreProc">#if (NGX_PTR_SIZE == </span><span class="Constant">4</span><span class="PreProc">)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_slab.c.html#L442" title="core/ngx_slab.c:442">ngx_slab_free_locked</a>(shpool, sess_id-&gt;id);<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_slab.c.html#L442" title="core/ngx_slab.c:442">ngx_slab_free_locked</a>(shpool, sess_id);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L2653">&#x200c;</a></span><span class="linkable">ngx_ssl_session_rbtree_insert_value</span>(<a href="../core/ngx_rbtree.h.html#L20" title="core/ngx_rbtree.h:20">ngx_rbtree_node_t</a> *temp,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_rbtree.h.html#L20" title="core/ngx_rbtree.h:20">ngx_rbtree_node_t</a> *node, <a href="../core/ngx_rbtree.h.html#L20" title="core/ngx_rbtree.h:20">ngx_rbtree_node_t</a> *sentinel)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_rbtree.h.html#L20" title="core/ngx_rbtree.h:20">ngx_rbtree_node_t</a>&nbsp; **p;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_event_openssl.h.html#L76" title="event/ngx_event_openssl.h:76">ngx_ssl_sess_id_t</a>&nbsp;&nbsp; *sess_id, *sess_id_temp;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> ( ;; ) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (node-&gt;key &lt; temp-&gt;key) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = &amp;temp-&gt;left;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (node-&gt;key &gt; temp-&gt;key) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = &amp;temp-&gt;right;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> { <span class="Comment">/* node-&gt;key == temp-&gt;key */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sess_id = (<a href="ngx_event_openssl.h.html#L76" title="event/ngx_event_openssl.h:76">ngx_ssl_sess_id_t</a> *) node;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sess_id_temp = (<a href="ngx_event_openssl.h.html#L76" title="event/ngx_event_openssl.h:76">ngx_ssl_sess_id_t</a> *) temp;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = (<a href="../core/ngx_string.c.html#L802" title="core/ngx_string.c:802">ngx_memn2cmp</a>(sess_id-&gt;id, sess_id_temp-&gt;id,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<span class="Type">size_t</span>) node-&gt;data, (<span class="Type">size_t</span>) temp-&gt;data)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &lt; <span class="Constant">0</span>) ? &amp;temp-&gt;left : &amp;temp-&gt;right;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (*p == sentinel) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; temp = *p;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; *p = node;<br/></li>
<li>&nbsp; &nbsp; node-&gt;parent = temp;<br/></li>
<li>&nbsp; &nbsp; node-&gt;left = sentinel;<br/></li>
<li>&nbsp; &nbsp; node-&gt;right = sentinel;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_rbtree.h.html#L59" title="core/ngx_rbtree.h:59">ngx_rbt_red</a>(node);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="PreProc">#ifdef SSL_CTRL_SET_TLSEXT_TICKET_KEY_CB<br/></li>
<li></span><br/></li>
<li><a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L2697">&#x200c;</a><span class="linkable">ngx_ssl_session_ticket_keys</span>(<a href="../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="ngx_event_openssl.h.html#L44" title="event/ngx_event_openssl.h:44">ngx_ssl_t</a> *ssl, <a href="../core/ngx_array.h.html#L22" title="core/ngx_array.h:22">ngx_array_t</a> *paths)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; buf[<span class="Constant">48</span>];<br/></li>
<li>&nbsp; &nbsp; <span class="Type">ssize_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *path;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L20" title="core/ngx_core.h:20">ngx_file_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; file;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; i;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_array.h.html#L22" title="core/ngx_array.h:22">ngx_array_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *keys;<br/></li>
<li>&nbsp; &nbsp; <a href="../os/unix/ngx_files.h.html#L17" title="os/unix/ngx_files.h:17">ngx_file_info_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fi;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_event_openssl.h.html#L105" title="event/ngx_event_openssl.h:105">ngx_ssl_session_ticket_key_t</a>&nbsp; *key;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (paths == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; keys = <a href="../core/ngx_array.c.html#L13" title="core/ngx_array.c:13">ngx_array_create</a>(cf-&gt;pool, paths-&gt;nelts,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">sizeof</span>(<a href="ngx_event_openssl.h.html#L105" title="event/ngx_event_openssl.h:105">ngx_ssl_session_ticket_key_t</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (keys == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; path = paths-&gt;elts;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; paths-&gt;nelts; i++) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_conf_file.c.html#L804" title="core/ngx_conf_file.c:804">ngx_conf_full_name</a>(cf-&gt;cycle, &amp;path[i], <span class="Constant">1</span>) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_string.h.html#L86" title="core/ngx_string.h:86">ngx_memzero</a>(&amp;file, <span class="Statement">sizeof</span>(<a href="../core/ngx_core.h.html#L20" title="core/ngx_core.h:20">ngx_file_t</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; file.name = path[i];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; file.log = cf-&gt;log;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; file.fd = <a href="../os/unix/ngx_files.h.html#L60" title="os/unix/ngx_files.h:60">ngx_open_file</a>(file.name.data, <a href="../os/unix/ngx_files.h.html#L72" title="os/unix/ngx_files.h:72">NGX_FILE_RDONLY</a>, <span class="Constant">0</span>, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (file.fd == <a href="../os/unix/ngx_files.h.html#L49" title="os/unix/ngx_files.h:49">NGX_INVALID_FILE</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <a href="../os/unix/ngx_errno.h.html#L68" title="os/unix/ngx_errno.h:68">ngx_errno</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../os/unix/ngx_files.h.html#L70" title="os/unix/ngx_files.h:70">ngx_open_file_n</a> <span class="Constant">&quot; </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant"> failed&quot;</span>, &amp;file.name);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../os/unix/ngx_files.h.html#L176" title="os/unix/ngx_files.h:176">ngx_fd_info</a>(file.fd, &amp;fi) == <a href="../os/unix/ngx_files.h.html#L50" title="os/unix/ngx_files.h:50">NGX_FILE_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../core/ngx_log.h.html#L19" title="core/ngx_log.h:19">NGX_LOG_CRIT</a>, cf, <a href="../os/unix/ngx_errno.h.html#L68" title="os/unix/ngx_errno.h:68">ngx_errno</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../os/unix/ngx_files.h.html#L177" title="os/unix/ngx_files.h:177">ngx_fd_info_n</a> <span class="Constant">&quot; </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant"> failed&quot;</span>, &amp;file.name);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../os/unix/ngx_files.h.html#L187" title="os/unix/ngx_files.h:187">ngx_file_size</a>(&amp;fi) != <span class="Constant">48</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;</span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant"> must be 48 bytes&quot;</span>, &amp;file.name);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; n = <a href="../os/unix/ngx_files.c.html#L20" title="os/unix/ngx_files.c:20">ngx_read_file</a>(&amp;file, buf, <span class="Constant">48</span>, <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n == <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../core/ngx_log.h.html#L19" title="core/ngx_log.h:19">NGX_LOG_CRIT</a>, cf, <a href="../os/unix/ngx_errno.h.html#L68" title="os/unix/ngx_errno.h:68">ngx_errno</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../os/unix/ngx_files.h.html#L124" title="os/unix/ngx_files.h:124">ngx_read_file_n</a> <span class="Constant">&quot; </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant"> failed&quot;</span>, &amp;file.name);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n != <span class="Constant">48</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_conf_file.c.html#L909" title="core/ngx_conf_file.c:909">ngx_conf_log_error</a>(<a href="../core/ngx_log.h.html#L19" title="core/ngx_log.h:19">NGX_LOG_CRIT</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../os/unix/ngx_files.h.html#L124" title="os/unix/ngx_files.h:124">ngx_read_file_n</a> <span class="Constant">&quot; </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant"> returned only &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;%z bytes instead of 48&quot;</span>, &amp;file.name, n);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; key = <a href="../core/ngx_array.c.html#L48" title="core/ngx_array.c:48">ngx_array_push</a>(keys);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (key == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_string.c.html#L1947" title="core/ngx_string.c:1947">ngx_memcpy</a>(key-&gt;name, buf, <span class="Constant">16</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_string.c.html#L1947" title="core/ngx_string.c:1947">ngx_memcpy</a>(key-&gt;aes_key, buf + <span class="Constant">16</span>, <span class="Constant">16</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_string.c.html#L1947" title="core/ngx_string.c:1947">ngx_memcpy</a>(key-&gt;hmac_key, buf + <span class="Constant">32</span>, <span class="Constant">16</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../os/unix/ngx_files.h.html#L109" title="os/unix/ngx_files.h:109">ngx_close_file</a>(file.fd) == <a href="../os/unix/ngx_files.h.html#L50" title="os/unix/ngx_files.h:50">NGX_FILE_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L18" title="core/ngx_log.h:18">NGX_LOG_ALERT</a>, cf-&gt;log, <a href="../os/unix/ngx_errno.h.html#L68" title="os/unix/ngx_errno.h:68">ngx_errno</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../os/unix/ngx_files.h.html#L110" title="os/unix/ngx_files.h:110">ngx_close_file_n</a> <span class="Constant">&quot; </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant"> failed&quot;</span>, &amp;file.name);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (SSL_CTX_set_ex_data(ssl-&gt;ctx, <a href="#L103" title="event/ngx_event_openssl.c:103">ngx_ssl_session_ticket_keys_index</a>, keys)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1987" title="event/ngx_event_openssl.c:1987">ngx_ssl_error</a>(<a href="../core/ngx_log.h.html#L17" title="core/ngx_log.h:17">NGX_LOG_EMERG</a>, ssl-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;SSL_CTX_set_ex_data() failed&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (SSL_CTX_set_tlsext_ticket_key_cb(ssl-&gt;ctx,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L2818" title="event/ngx_event_openssl.c:2818">ngx_ssl_session_ticket_key_callback</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L21" title="core/ngx_log.h:21">NGX_LOG_WARN</a>, cf-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;<a href="../http/modules/perl/ngx_http_perl_module.h.html#L21" title="http/modules/perl/ngx_http_perl_module.h:21">nginx</a> was built with Session Tickets support, however, &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;now it is linked dynamically to an OpenSSL library &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;which has no tlsext support, therefore Session Tickets &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;are not available&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li><br/></li>
<li><span class="Statement">failed</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../os/unix/ngx_files.h.html#L109" title="os/unix/ngx_files.h:109">ngx_close_file</a>(file.fd) == <a href="../os/unix/ngx_files.h.html#L50" title="os/unix/ngx_files.h:50">NGX_FILE_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L18" title="core/ngx_log.h:18">NGX_LOG_ALERT</a>, cf-&gt;log, <a href="../os/unix/ngx_errno.h.html#L68" title="os/unix/ngx_errno.h:68">ngx_errno</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../os/unix/ngx_files.h.html#L110" title="os/unix/ngx_files.h:110">ngx_close_file_n</a> <span class="Constant">&quot; </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant"> failed&quot;</span>, &amp;file.name);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="PreProc">#ifdef OPENSSL_NO_SHA256<br/></li>
<li><a id="L2811">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">ngx_ssl_session_ticket_md</span>&nbsp; EVP_sha1<br/></li>
<li></span><span class="PreProc">#else<br/></li>
<li><a id="L2813">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">ngx_ssl_session_ticket_md</span>&nbsp; EVP_sha256<br/></li>
<li></span><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">int<br/></li>
<li><a id="L2818">&#x200c;</a></span><span class="linkable">ngx_ssl_session_ticket_key_callback</span>(<a href="ngx_event_openssl.h.html#L37" title="event/ngx_event_openssl.h:37">ngx_ssl_conn_t</a> *ssl_conn,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">unsigned</span> <span class="Type">char</span> *name, <span class="Type">unsigned</span> <span class="Type">char</span> *iv, EVP_CIPHER_CTX *ectx,<br/></li>
<li>&nbsp; &nbsp; HMAC_CTX *hctx, <span class="Type">int</span> enc)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; SSL_CTX&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *ssl_ctx;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; i;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_array.h.html#L22" title="core/ngx_array.h:22">ngx_array_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *keys;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_event_openssl.h.html#L105" title="event/ngx_event_openssl.h:105">ngx_ssl_session_ticket_key_t</a>&nbsp; *key;<br/></li>
<li><span class="PreProc">#if (NGX_DEBUG)<br/></li>
<li></span>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; buf[<span class="Constant">32</span>];<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L23" title="core/ngx_core.h:23">ngx_connection_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *c;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; ssl_ctx = SSL_get_SSL_CTX(ssl_conn);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; keys = SSL_CTX_get_ex_data(ssl_ctx, <a href="#L103" title="event/ngx_event_openssl.c:103">ngx_ssl_session_ticket_keys_index</a>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (keys == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; key = keys-&gt;elts;<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_DEBUG)<br/></li>
<li></span>&nbsp; &nbsp; c = <a href="ngx_event_openssl.h.html#L153" title="event/ngx_event_openssl.h:153">ngx_ssl_get_connection</a>(ssl_conn);<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (enc == <span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* encrypt session ticket */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L141" title="core/ngx_log.h:141">ngx_log_debug3</a>(<a href="../core/ngx_log.h.html#L29" title="core/ngx_log.h:29">NGX_LOG_DEBUG_EVENT</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;ssl session ticket encrypt, key: </span><span class="Special">\&quot;%*s\&quot;</span><span class="Constant"> (</span><span class="Special">%s</span><span class="Constant"> session)&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../core/ngx_string.c.html#L1089" title="core/ngx_string.c:1089">ngx_hex_dump</a>(buf, key[<span class="Constant">0</span>].name, <span class="Constant">16</span>) - buf, buf,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; SSL_session_reused(ssl_conn) ? <span class="Constant">&quot;reused&quot;</span> : <span class="Constant">&quot;new&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; RAND_pseudo_bytes(iv, <span class="Constant">16</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; EVP_EncryptInit_ex(ectx, EVP_aes_128_cbc(), <span class="Constant">NULL</span>, key[<span class="Constant">0</span>].aes_key, iv);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; HMAC_Init_ex(hctx, key[<span class="Constant">0</span>].hmac_key, <span class="Constant">16</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L2811" title="event/ngx_event_openssl.c:2811">ngx_ssl_session_ticket_md</a>(), <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_string.c.html#L1947" title="core/ngx_string.c:1947">ngx_memcpy</a>(name, key[<span class="Constant">0</span>].name, <span class="Constant">16</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* decrypt session ticket */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; keys-&gt;nelts; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_string.h.html#L144" title="core/ngx_string.h:144">ngx_memcmp</a>(name, key[i].name, <span class="Constant">16</span>) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> found;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L138" title="core/ngx_log.h:138">ngx_log_debug2</a>(<a href="../core/ngx_log.h.html#L29" title="core/ngx_log.h:29">NGX_LOG_DEBUG_EVENT</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;ssl session ticket decrypt, key: </span><span class="Special">\&quot;%*s\&quot;</span><span class="Constant"> not found&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../core/ngx_string.c.html#L1089" title="core/ngx_string.c:1089">ngx_hex_dump</a>(buf, name, <span class="Constant">16</span>) - buf, buf);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; </span><span class="Statement">found</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L141" title="core/ngx_log.h:141">ngx_log_debug3</a>(<a href="../core/ngx_log.h.html#L29" title="core/ngx_log.h:29">NGX_LOG_DEBUG_EVENT</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;ssl session ticket decrypt, key: </span><span class="Special">\&quot;%*s\&quot;%s</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../core/ngx_string.c.html#L1089" title="core/ngx_string.c:1089">ngx_hex_dump</a>(buf, key[i].name, <span class="Constant">16</span>) - buf, buf,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (i == <span class="Constant">0</span>) ? <span class="Constant">&quot; (default)&quot;</span> : <span class="Constant">&quot;&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; HMAC_Init_ex(hctx, key[i].hmac_key, <span class="Constant">16</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L2811" title="event/ngx_event_openssl.c:2811">ngx_ssl_session_ticket_md</a>(), <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; EVP_DecryptInit_ex(ectx, EVP_aes_128_cbc(), <span class="Constant">NULL</span>, key[i].aes_key, iv);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> (i == <span class="Constant">0</span>) ? <span class="Constant">1</span> : <span class="Constant">2</span> <span class="Comment">/* renew */</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span><br/></li>
<li><a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L2893">&#x200c;</a><span class="linkable">ngx_ssl_session_ticket_keys</span>(<a href="../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="ngx_event_openssl.h.html#L44" title="event/ngx_event_openssl.h:44">ngx_ssl_t</a> *ssl, <a href="../core/ngx_array.h.html#L22" title="core/ngx_array.h:22">ngx_array_t</a> *paths)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (paths) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L83" title="core/ngx_log.h:83">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L21" title="core/ngx_log.h:21">NGX_LOG_WARN</a>, ssl-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;</span><span class="Special">\&quot;</span><span class="Constant">ssl_session_ticket_keys</span><span class="Special">\&quot;</span><span class="Constant"> ignored, not supported&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Type">void<br/></li>
<li><a id="L2907">&#x200c;</a></span><span class="linkable">ngx_ssl_cleanup_ctx</span>(<span class="Type">void</span> *data)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_event_openssl.h.html#L44" title="event/ngx_event_openssl.h:44">ngx_ssl_t</a>&nbsp; *ssl = data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; SSL_CTX_free(ssl-&gt;ctx);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L2916">&#x200c;</a><span class="linkable">ngx_ssl_check_host</span>(<a href="../core/ngx_core.h.html#L23" title="core/ngx_core.h:23">ngx_connection_t</a> *c, <a href="../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a> *name)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; X509&nbsp;&nbsp; *cert;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cert = SSL_get_peer_certificate(c-&gt;ssl-&gt;connection);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cert == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (OPENSSL_VERSION_NUMBER &gt;= </span><span class="Constant">0x10002002L</span><span class="PreProc"> &amp;&amp; !defined LIBRESSL_VERSION_NUMBER)<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* X509_check_host() is only available in OpenSSL 1.0.2+ */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (name-&gt;len == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (X509_check_host(cert, (<span class="Type">char</span> *) name-&gt;data, name-&gt;len, <span class="Constant">0</span>, <span class="Constant">NULL</span>) != <span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L132" title="core/ngx_log.h:132">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L29" title="core/ngx_log.h:29">NGX_LOG_DEBUG_EVENT</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;X509_check_host(): no match&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L132" title="core/ngx_log.h:132">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L29" title="core/ngx_log.h:29">NGX_LOG_DEBUG_EVENT</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;X509_check_host(): match&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">goto</span> found;<br/></li>
<li><br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n, i;<br/></li>
<li>&nbsp; &nbsp; X509_NAME&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *sname;<br/></li>
<li>&nbsp; &nbsp; ASN1_STRING&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *str;<br/></li>
<li>&nbsp; &nbsp; X509_NAME_ENTRY&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *entry;<br/></li>
<li>&nbsp; &nbsp; GENERAL_NAME&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *altname;<br/></li>
<li>&nbsp; &nbsp; STACK_OF(GENERAL_NAME)&nbsp; *altnames;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * As per RFC6125 and RFC2818, we check subjectAltName extension,<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * and if it's not present - commonName in Subject is checked.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; altnames = X509_get_ext_d2i(cert, NID_subject_alt_name, <span class="Constant">NULL</span>, <span class="Constant">NULL</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (altnames) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; n = sk_GENERAL_NAME_num(altnames);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; n; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; altname = sk_GENERAL_NAME_value(altnames, i);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (altname-&gt;type != GEN_DNS) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; str = altname-&gt;d.dNSName;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L138" title="core/ngx_log.h:138">ngx_log_debug2</a>(<a href="../core/ngx_log.h.html#L29" title="core/ngx_log.h:29">NGX_LOG_DEBUG_EVENT</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;SSL subjectAltName: </span><span class="Special">\&quot;%*s\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ASN1_STRING_length(str), ASN1_STRING_data(str));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L3045" title="event/ngx_event_openssl.c:3045">ngx_ssl_check_name</a>(name, str) == <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L132" title="core/ngx_log.h:132">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L29" title="core/ngx_log.h:29">NGX_LOG_DEBUG_EVENT</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;SSL subjectAltName: match&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; GENERAL_NAMES_free(altnames);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> found;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L132" title="core/ngx_log.h:132">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L29" title="core/ngx_log.h:29">NGX_LOG_DEBUG_EVENT</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;SSL subjectAltName: no match&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; GENERAL_NAMES_free(altnames);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * If there is no subjectAltName extension, check commonName<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * in Subject.&nbsp; While RFC2818 requires to only check &quot;most specific&quot;<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * CN, both Apache and OpenSSL check all CNs, and so do we.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; sname = X509_get_subject_name(cert);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (sname == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; i = -<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> ( ;; ) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; i = X509_NAME_get_index_by_NID(sname, NID_commonName, i);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (i &lt; <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; entry = X509_NAME_get_entry(sname, i);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; str = X509_NAME_ENTRY_get_data(entry);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L138" title="core/ngx_log.h:138">ngx_log_debug2</a>(<a href="../core/ngx_log.h.html#L29" title="core/ngx_log.h:29">NGX_LOG_DEBUG_EVENT</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;SSL commonName: </span><span class="Special">\&quot;%*s\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ASN1_STRING_length(str), ASN1_STRING_data(str));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L3045" title="event/ngx_event_openssl.c:3045">ngx_ssl_check_name</a>(name, str) == <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L132" title="core/ngx_log.h:132">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L29" title="core/ngx_log.h:29">NGX_LOG_DEBUG_EVENT</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;SSL commonName: match&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> found;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L132" title="core/ngx_log.h:132">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L29" title="core/ngx_log.h:29">NGX_LOG_DEBUG_EVENT</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;SSL commonName: no match&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="Statement">failed</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; X509_free(cert);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li><br/></li>
<li><span class="Statement">found</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; X509_free(cert);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="PreProc">#if (OPENSSL_VERSION_NUMBER &lt; </span><span class="Constant">0x10002002L</span><span class="PreProc"> || defined LIBRESSL_VERSION_NUMBER)<br/></li>
<li></span><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L3045">&#x200c;</a><span class="linkable">ngx_ssl_check_name</span>(<a href="../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a> *name, ASN1_STRING *pattern)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; *s, *p, *end;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp;&nbsp; slen, plen;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; s = name-&gt;data;<br/></li>
<li>&nbsp; &nbsp; slen = name-&gt;len;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p = ASN1_STRING_data(pattern);<br/></li>
<li>&nbsp; &nbsp; plen = ASN1_STRING_length(pattern);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (slen == plen &amp;&amp; <a href="../core/ngx_string.c.html#L593" title="core/ngx_string.c:593">ngx_strncasecmp</a>(s, p, plen) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (plen &gt; <span class="Constant">2</span> &amp;&amp; p[<span class="Constant">0</span>] == <span class="Constant">'*'</span> &amp;&amp; p[<span class="Constant">1</span>] == <span class="Constant">'.'</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; plen -= <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p += <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; end = s + slen;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; s = <a href="../core/ngx_string.h.html#L66" title="core/ngx_string.h:66">ngx_strlchr</a>(s, end, <span class="Constant">'.'</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (s == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; slen = end - s;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (plen == slen &amp;&amp; <a href="../core/ngx_string.c.html#L593" title="core/ngx_string.c:593">ngx_strncasecmp</a>(s, p, plen) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L3085">&#x200c;</a><span class="linkable">ngx_ssl_get_protocol</span>(<a href="../core/ngx_core.h.html#L23" title="core/ngx_core.h:23">ngx_connection_t</a> *c, <a href="../core/ngx_core.h.html#L15" title="core/ngx_core.h:15">ngx_pool_t</a> *pool, <a href="../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a> *s)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; s-&gt;data = (u_char *) SSL_get_version(c-&gt;ssl-&gt;connection);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L3093">&#x200c;</a><span class="linkable">ngx_ssl_get_cipher_name</span>(<a href="../core/ngx_core.h.html#L23" title="core/ngx_core.h:23">ngx_connection_t</a> *c, <a href="../core/ngx_core.h.html#L15" title="core/ngx_core.h:15">ngx_pool_t</a> *pool, <a href="../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a> *s)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; s-&gt;data = (u_char *) SSL_get_cipher_name(c-&gt;ssl-&gt;connection);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L3101">&#x200c;</a><span class="linkable">ngx_ssl_get_session_id</span>(<a href="../core/ngx_core.h.html#L23" title="core/ngx_core.h:23">ngx_connection_t</a> *c, <a href="../core/ngx_core.h.html#L15" title="core/ngx_core.h:15">ngx_pool_t</a> *pool, <a href="../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a> *s)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; *buf;<br/></li>
<li>&nbsp; &nbsp; SSL_SESSION&nbsp;&nbsp; *sess;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">unsigned</span> <span class="Type">int</span>&nbsp;&nbsp; len;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; sess = SSL_get0_session(c-&gt;ssl-&gt;connection);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (sess == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; s-&gt;len = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#if OPENSSL_VERSION_NUMBER &gt;= </span><span class="Constant">0x0090800fL<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; buf = (u_char *) SSL_SESSION_get_id(sess, &amp;len);<br/></li>
<li><br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; buf = sess-&gt;session_id;<br/></li>
<li>&nbsp; &nbsp; len = sess-&gt;session_id_length;<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; s-&gt;len = <span class="Constant">2</span> * len;<br/></li>
<li>&nbsp; &nbsp; s-&gt;data = <a href="../core/ngx_palloc.c.html#L150" title="core/ngx_palloc.c:150">ngx_pnalloc</a>(pool, <span class="Constant">2</span> * len);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (s-&gt;data == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.c.html#L1089" title="core/ngx_string.c:1089">ngx_hex_dump</a>(s-&gt;data, buf, len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L3137">&#x200c;</a><span class="linkable">ngx_ssl_get_session_reused</span>(<a href="../core/ngx_core.h.html#L23" title="core/ngx_core.h:23">ngx_connection_t</a> *c, <a href="../core/ngx_core.h.html#L15" title="core/ngx_core.h:15">ngx_pool_t</a> *pool, <a href="../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a> *s)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (SSL_session_reused(c-&gt;ssl-&gt;connection)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_string.h.html#L42" title="core/ngx_string.h:42">ngx_str_set</a>(s, <span class="Constant">&quot;r&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_string.h.html#L42" title="core/ngx_string.h:42">ngx_str_set</a>(s, <span class="Constant">&quot;.&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L3151">&#x200c;</a><span class="linkable">ngx_ssl_get_server_name</span>(<a href="../core/ngx_core.h.html#L23" title="core/ngx_core.h:23">ngx_connection_t</a> *c, <a href="../core/ngx_core.h.html#L15" title="core/ngx_core.h:15">ngx_pool_t</a> *pool, <a href="../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a> *s)<br/></li>
<li>{<br/></li>
<li><span class="PreProc">#ifdef SSL_CTRL_SET_TLSEXT_HOSTNAME<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span>&nbsp; *servername;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; servername = SSL_get_servername(c-&gt;ssl-&gt;connection,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TLSEXT_NAMETYPE_host_name);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (servername) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; s-&gt;data = (u_char *) servername;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; s-&gt;len = <a href="../core/ngx_string.h.html#L61" title="core/ngx_string.h:61">ngx_strlen</a>(servername);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; s-&gt;len = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L3173">&#x200c;</a><span class="linkable">ngx_ssl_get_raw_certificate</span>(<a href="../core/ngx_core.h.html#L23" title="core/ngx_core.h:23">ngx_connection_t</a> *c, <a href="../core/ngx_core.h.html#L15" title="core/ngx_core.h:15">ngx_pool_t</a> *pool, <a href="../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a> *s)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp;&nbsp; len;<br/></li>
<li>&nbsp; &nbsp; BIO&nbsp; &nbsp;&nbsp; *bio;<br/></li>
<li>&nbsp; &nbsp; X509&nbsp; &nbsp; *cert;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; s-&gt;len = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cert = SSL_get_peer_certificate(c-&gt;ssl-&gt;connection);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cert == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; bio = BIO_new(BIO_s_mem());<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (bio == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1987" title="event/ngx_event_openssl.c:1987">ngx_ssl_error</a>(<a href="../core/ngx_log.h.html#L18" title="core/ngx_log.h:18">NGX_LOG_ALERT</a>, c-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;BIO_new() failed&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; X509_free(cert);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (PEM_write_bio_X509(bio, cert) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1987" title="event/ngx_event_openssl.c:1987">ngx_ssl_error</a>(<a href="../core/ngx_log.h.html#L18" title="core/ngx_log.h:18">NGX_LOG_ALERT</a>, c-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;PEM_write_bio_X509() failed&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; len = BIO_pending(bio);<br/></li>
<li>&nbsp; &nbsp; s-&gt;len = len;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; s-&gt;data = <a href="../core/ngx_palloc.c.html#L150" title="core/ngx_palloc.c:150">ngx_pnalloc</a>(pool, len);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (s-&gt;data == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; BIO_read(bio, s-&gt;data, len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; BIO_free(bio);<br/></li>
<li>&nbsp; &nbsp; X509_free(cert);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li><br/></li>
<li><span class="Statement">failed</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; BIO_free(bio);<br/></li>
<li>&nbsp; &nbsp; X509_free(cert);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L3223">&#x200c;</a><span class="linkable">ngx_ssl_get_certificate</span>(<a href="../core/ngx_core.h.html#L23" title="core/ngx_core.h:23">ngx_connection_t</a> *c, <a href="../core/ngx_core.h.html#L15" title="core/ngx_core.h:15">ngx_pool_t</a> *pool, <a href="../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a> *s)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; *p;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp;&nbsp; len;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="core/ngx_config.h:79">ngx_uint_t</a>&nbsp;&nbsp; i;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; cert;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L3173" title="event/ngx_event_openssl.c:3173">ngx_ssl_get_raw_certificate</a>(c, pool, &amp;cert) != <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cert.len == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; s-&gt;len = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; len = cert.len - <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; cert.len - <span class="Constant">1</span>; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (cert.data[i] == <a href="../core/ngx_core.h.html#L84" title="core/ngx_core.h:84">LF</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; s-&gt;len = len;<br/></li>
<li>&nbsp; &nbsp; s-&gt;data = <a href="../core/ngx_palloc.c.html#L150" title="core/ngx_palloc.c:150">ngx_pnalloc</a>(pool, len);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (s-&gt;data == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p = s-&gt;data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; cert.len - <span class="Constant">1</span>; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *p++ = cert.data[i];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (cert.data[i] == <a href="../core/ngx_core.h.html#L84" title="core/ngx_core.h:84">LF</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *p++ = <span class="Special">'\t'</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L3267">&#x200c;</a><span class="linkable">ngx_ssl_get_subject_dn</span>(<a href="../core/ngx_core.h.html#L23" title="core/ngx_core.h:23">ngx_connection_t</a> *c, <a href="../core/ngx_core.h.html#L15" title="core/ngx_core.h:15">ngx_pool_t</a> *pool, <a href="../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a> *s)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp;&nbsp; *p;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; len;<br/></li>
<li>&nbsp; &nbsp; X509&nbsp; &nbsp; &nbsp;&nbsp; *cert;<br/></li>
<li>&nbsp; &nbsp; X509_NAME&nbsp; *name;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; s-&gt;len = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cert = SSL_get_peer_certificate(c-&gt;ssl-&gt;connection);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cert == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; name = X509_get_subject_name(cert);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (name == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; X509_free(cert);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p = X509_NAME_oneline(name, <span class="Constant">NULL</span>, <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (len = <span class="Constant">0</span>; p[len]; len++) { <span class="Comment">/* void */</span> }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; s-&gt;len = len;<br/></li>
<li>&nbsp; &nbsp; s-&gt;data = <a href="../core/ngx_palloc.c.html#L150" title="core/ngx_palloc.c:150">ngx_pnalloc</a>(pool, len);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (s-&gt;data == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; OPENSSL_free(p);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; X509_free(cert);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.c.html#L1947" title="core/ngx_string.c:1947">ngx_memcpy</a>(s-&gt;data, p, len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; OPENSSL_free(p);<br/></li>
<li>&nbsp; &nbsp; X509_free(cert);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L3309">&#x200c;</a><span class="linkable">ngx_ssl_get_issuer_dn</span>(<a href="../core/ngx_core.h.html#L23" title="core/ngx_core.h:23">ngx_connection_t</a> *c, <a href="../core/ngx_core.h.html#L15" title="core/ngx_core.h:15">ngx_pool_t</a> *pool, <a href="../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a> *s)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp;&nbsp; *p;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; len;<br/></li>
<li>&nbsp; &nbsp; X509&nbsp; &nbsp; &nbsp;&nbsp; *cert;<br/></li>
<li>&nbsp; &nbsp; X509_NAME&nbsp; *name;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; s-&gt;len = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cert = SSL_get_peer_certificate(c-&gt;ssl-&gt;connection);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cert == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; name = X509_get_issuer_name(cert);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (name == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; X509_free(cert);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p = X509_NAME_oneline(name, <span class="Constant">NULL</span>, <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (len = <span class="Constant">0</span>; p[len]; len++) { <span class="Comment">/* void */</span> }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; s-&gt;len = len;<br/></li>
<li>&nbsp; &nbsp; s-&gt;data = <a href="../core/ngx_palloc.c.html#L150" title="core/ngx_palloc.c:150">ngx_pnalloc</a>(pool, len);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (s-&gt;data == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; OPENSSL_free(p);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; X509_free(cert);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.c.html#L1947" title="core/ngx_string.c:1947">ngx_memcpy</a>(s-&gt;data, p, len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; OPENSSL_free(p);<br/></li>
<li>&nbsp; &nbsp; X509_free(cert);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L3351">&#x200c;</a><span class="linkable">ngx_ssl_get_serial_number</span>(<a href="../core/ngx_core.h.html#L23" title="core/ngx_core.h:23">ngx_connection_t</a> *c, <a href="../core/ngx_core.h.html#L15" title="core/ngx_core.h:15">ngx_pool_t</a> *pool, <a href="../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a> *s)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp;&nbsp; len;<br/></li>
<li>&nbsp; &nbsp; X509&nbsp; &nbsp; *cert;<br/></li>
<li>&nbsp; &nbsp; BIO&nbsp; &nbsp;&nbsp; *bio;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; s-&gt;len = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cert = SSL_get_peer_certificate(c-&gt;ssl-&gt;connection);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cert == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; bio = BIO_new(BIO_s_mem());<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (bio == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; X509_free(cert);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; i2a_ASN1_INTEGER(bio, X509_get_serialNumber(cert));<br/></li>
<li>&nbsp; &nbsp; len = BIO_pending(bio);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; s-&gt;len = len;<br/></li>
<li>&nbsp; &nbsp; s-&gt;data = <a href="../core/ngx_palloc.c.html#L150" title="core/ngx_palloc.c:150">ngx_pnalloc</a>(pool, len);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (s-&gt;data == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; BIO_free(bio);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; X509_free(cert);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; BIO_read(bio, s-&gt;data, len);<br/></li>
<li>&nbsp; &nbsp; BIO_free(bio);<br/></li>
<li>&nbsp; &nbsp; X509_free(cert);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L3390">&#x200c;</a><span class="linkable">ngx_ssl_get_fingerprint</span>(<a href="../core/ngx_core.h.html#L23" title="core/ngx_core.h:23">ngx_connection_t</a> *c, <a href="../core/ngx_core.h.html#L15" title="core/ngx_core.h:15">ngx_pool_t</a> *pool, <a href="../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a> *s)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; X509&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *cert;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">unsigned</span> <span class="Type">int</span>&nbsp;&nbsp; len;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; buf[EVP_MAX_MD_SIZE];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; s-&gt;len = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cert = SSL_get_peer_certificate(c-&gt;ssl-&gt;connection);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cert == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!X509_digest(cert, EVP_sha1(), buf, &amp;len)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; X509_free(cert);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; s-&gt;len = <span class="Constant">2</span> * len;<br/></li>
<li>&nbsp; &nbsp; s-&gt;data = <a href="../core/ngx_palloc.c.html#L150" title="core/ngx_palloc.c:150">ngx_pnalloc</a>(pool, <span class="Constant">2</span> * len);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (s-&gt;data == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; X509_free(cert);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L30" title="core/ngx_core.h:30">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.c.html#L1089" title="core/ngx_string.c:1089">ngx_hex_dump</a>(s-&gt;data, buf, len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; X509_free(cert);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a href="../core/ngx_config.h.html#L78" title="core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L3424">&#x200c;</a><span class="linkable">ngx_ssl_get_client_verify</span>(<a href="../core/ngx_core.h.html#L23" title="core/ngx_core.h:23">ngx_connection_t</a> *c, <a href="../core/ngx_core.h.html#L15" title="core/ngx_core.h:15">ngx_pool_t</a> *pool, <a href="../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a> *s)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; X509&nbsp; *cert;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (SSL_get_verify_result(c-&gt;ssl-&gt;connection) != X509_V_OK) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_string.h.html#L42" title="core/ngx_string.h:42">ngx_str_set</a>(s, <span class="Constant">&quot;FAILED&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cert = SSL_get_peer_certificate(c-&gt;ssl-&gt;connection);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cert) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_string.h.html#L42" title="core/ngx_string.h:42">ngx_str_set</a>(s, <span class="Constant">&quot;SUCCESS&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_string.h.html#L42" title="core/ngx_string.h:42">ngx_str_set</a>(s, <span class="Constant">&quot;NONE&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; X509_free(cert);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L29" title="core/ngx_core.h:29">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> *<br/></li>
<li><a id="L3449">&#x200c;</a><span class="linkable">ngx_openssl_create_conf</span>(<a href="../core/ngx_core.h.html#L14" title="core/ngx_core.h:14">ngx_cycle_t</a> *cycle)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L18" title="event/ngx_event_openssl.c:18">ngx_openssl_conf_t</a>&nbsp; *oscf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; oscf = <a href="../core/ngx_palloc.c.html#L300" title="core/ngx_palloc.c:300">ngx_pcalloc</a>(cycle-&gt;pool, <span class="Statement">sizeof</span>(<a href="#L18" title="event/ngx_event_openssl.c:18">ngx_openssl_conf_t</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (oscf == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * <a href="modules/ngx_rtsig_module.c.html#L75" title="event/modules/ngx_rtsig_module.c:75">set</a> by <a href="../core/ngx_palloc.c.html#L300" title="core/ngx_palloc.c:300">ngx_pcalloc</a>():<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *&nbsp; &nbsp;&nbsp; oscf-&gt;engine = 0;<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> oscf;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<br/></li>
<li><a id="L3469">&#x200c;</a><span class="linkable">ngx_openssl_engine</span>(<a href="../core/ngx_core.h.html#L13" title="core/ngx_core.h:13">ngx_conf_t</a> *cf, <a href="../core/ngx_core.h.html#L19" title="core/ngx_core.h:19">ngx_command_t</a> *cmd, <span class="Type">void</span> *conf)<br/></li>
<li>{<br/></li>
<li><span class="PreProc">#ifndef OPENSSL_NO_ENGINE<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="#L18" title="event/ngx_event_openssl.c:18">ngx_openssl_conf_t</a> *oscf = conf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ENGINE&nbsp; &nbsp;&nbsp; *engine;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L19" title="core/ngx_string.h:19">ngx_str_t</a>&nbsp; *value;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (oscf-&gt;engine) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">&quot;is duplicate&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; oscf-&gt;engine = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; value = cf-&gt;args-&gt;elts;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; engine = ENGINE_by_id((<span class="Type">const</span> <span class="Type">char</span> *) value[<span class="Constant">1</span>].data);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (engine == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1987" title="event/ngx_event_openssl.c:1987">ngx_ssl_error</a>(<a href="../core/ngx_log.h.html#L21" title="core/ngx_log.h:21">NGX_LOG_WARN</a>, cf-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;ENGINE_by_id(</span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">) failed&quot;</span>, &amp;value[<span class="Constant">1</span>]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ENGINE_set_default(engine, ENGINE_METHOD_ALL) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1987" title="event/ngx_event_openssl.c:1987">ngx_ssl_error</a>(<a href="../core/ngx_log.h.html#L21" title="core/ngx_log.h:21">NGX_LOG_WARN</a>, cf-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;ENGINE_set_default(</span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">, ENGINE_METHOD_ALL) failed&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;value[<span class="Constant">1</span>]);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ENGINE_free(engine);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L65" title="core/ngx_conf_file.h:65">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ENGINE_free(engine);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L64" title="core/ngx_conf_file.h:64">NGX_CONF_OK</a>;<br/></li>
<li><br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">&quot;is not supported&quot;</span>;<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L3517">&#x200c;</a></span><span class="linkable">ngx_openssl_exit</span>(<a href="../core/ngx_core.h.html#L14" title="core/ngx_core.h:14">ngx_cycle_t</a> *cycle)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; EVP_cleanup();<br/></li>
<li><span class="PreProc">#ifndef OPENSSL_NO_ENGINE<br/></li>
<li></span>&nbsp; &nbsp; ENGINE_cleanup();<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>}<br/></li>
</ol></code>
 </body>
</html>
