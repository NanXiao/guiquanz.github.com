<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>lobject.c - src</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

code {
    font-family: consolas, monospace;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
  <h3>lobject.c - src</h3>
   <a href="../index.html"> Table of Contents </a>
 <h4>Global variables defined</h4>
 <ul>
<li><a href="#L31">luaO_nilobject_</a></li>
</ul>
 <h4>Functions defined</h4>
 <ul>
<li><a href="#L76">intarith</a></li>
<li><a href="#L162">isneg</a></li>
<li><a href="#L239">l_str2d</a></li>
<li><a href="#L253">l_str2int</a></li>
<li><a href="#L116">luaO_arith</a></li>
<li><a href="#L58">luaO_ceillog2</a></li>
<li><a href="#L435">luaO_chunkid</a></li>
<li><a href="#L51">luaO_fb2int</a></li>
<li><a href="#L156">luaO_hexavalue</a></li>
<li><a href="#L39">luaO_int2fb</a></li>
<li><a href="#L416">luaO_pushfstring</a></li>
<li><a href="#L348">luaO_pushvfstring</a></li>
<li><a href="#L282">luaO_str2num</a></li>
<li><a href="#L322">luaO_tostring</a></li>
<li><a href="#L297">luaO_utf8esc</a></li>
<li><a href="#L187">lua_strx2number</a></li>
<li><a href="#L96">numarith</a></li>
<li><a href="#L341">pushstr</a></li>
</ul>
 <h4>Macros defined</h4>
 <ul>
<li><a href="#L427">LL</a></li>
<li><a href="#L8">LUA_CORE</a></li>
<li><a href="#L316">MAXNUMBER2STR</a></li>
<li><a href="#L181">MAXSIGDIG</a></li>
<li><a href="#L431">POS</a></li>
<li><a href="#L430">PRE</a></li>
<li><a href="#L429">RETS</a></li>
<li><a href="#L433">addstr</a></li>
<li><a href="#L7">lobject_c</a></li>
</ul>
 <h4>Source code</h4>

  <code><ol><li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** $Id: lobject.c,v 2.101 2014/12/26 14:43:45 roberto Exp $<br/></li>
<li></span><span class="Comment">** Some generic functions over Lua objects<br/></li>
<li></span><span class="Comment">** See Copyright Notice in lua.h<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li></span><br/></li>
<li><a id="L7">&#x200c;</a><span class="PreProc">#define <span class="linkable">lobject_c</span><br/></li>
<li><a id="L8">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">LUA_CORE</span><br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;lprefix.h&quot;<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;stdarg.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;stdio.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;stdlib.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;string.h&gt;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;lua.h&quot;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;lctype.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;ldebug.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;ldo.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;lmem.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;lobject.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;lstate.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;lstring.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;lvm.h&quot;<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L31">&#x200c;</a><a href="luaconf.h.html#L261" title="luaconf.h:261">LUAI_DDEF</a> <span class="Type">const</span> <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> <span class="linkable">luaO_nilobject_</span> = {<a href="lobject.h.html#L112" title="lobject.h:112">NILCONSTANT</a>};<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** converts an integer to a &quot;floating point byte&quot;, represented as<br/></li>
<li></span><span class="Comment">** (eeeeexxx), where the real value is (1xxx) * 2^(eeeee - 1) if<br/></li>
<li></span><span class="Comment">** eeeee != 0 and (xxx) otherwise.<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L39">&#x200c;</a></span><span class="Type">int</span> <span class="linkable">luaO_int2fb</span> (<span class="Type">unsigned</span> <span class="Type">int</span> x) {<br/></li>
<li>&nbsp; <span class="Type">int</span> e = <span class="Constant">0</span>;&nbsp; <span class="Comment">/* exponent */<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (x &lt; <span class="Constant">8</span>) <span class="Statement">return</span> x;<br/></li>
<li>&nbsp; <span class="Statement">while</span> (x &gt;= <span class="Constant">0x10</span>) {<br/></li>
<li>&nbsp; &nbsp; x = (x+<span class="Constant">1</span>) &gt;&gt; <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; e++;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> ((e+<span class="Constant">1</span>) &lt;&lt; <span class="Constant">3</span>) | (<a href="llimits.h.html#L112" title="llimits.h:112">cast_int</a>(x) - <span class="Constant">8</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/* converts back */<br/></li>
<li><a id="L51">&#x200c;</a></span><span class="Type">int</span> <span class="linkable">luaO_fb2int</span> (<span class="Type">int</span> x) {<br/></li>
<li>&nbsp; <span class="Type">int</span> e = (x &gt;&gt; <span class="Constant">3</span>) &amp; <span class="Constant">0x1f</span>;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (e == <span class="Constant">0</span>) <span class="Statement">return</span> x;<br/></li>
<li>&nbsp; <span class="Statement">else</span> <span class="Statement">return</span> ((x &amp; <span class="Constant">7</span>) + <span class="Constant">8</span>) &lt;&lt; (e - <span class="Constant">1</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L58">&#x200c;</a><span class="Type">int</span> <span class="linkable">luaO_ceillog2</span> (<span class="Type">unsigned</span> <span class="Type">int</span> x) {<br/></li>
<li>&nbsp; <span class="Type">static</span> <span class="Type">const</span> <a href="llimits.h.html#L35" title="llimits.h:35">lu_byte</a> log_2[<span class="Constant">256</span>] = {<br/></li>
<li>&nbsp; &nbsp; <span class="Constant">0</span>,<span class="Constant">1</span>,<span class="Constant">2</span>,<span class="Constant">2</span>,<span class="Constant">3</span>,<span class="Constant">3</span>,<span class="Constant">3</span>,<span class="Constant">3</span>,<span class="Constant">4</span>,<span class="Constant">4</span>,<span class="Constant">4</span>,<span class="Constant">4</span>,<span class="Constant">4</span>,<span class="Constant">4</span>,<span class="Constant">4</span>,<span class="Constant">4</span>,<span class="Constant">5</span>,<span class="Constant">5</span>,<span class="Constant">5</span>,<span class="Constant">5</span>,<span class="Constant">5</span>,<span class="Constant">5</span>,<span class="Constant">5</span>,<span class="Constant">5</span>,<span class="Constant">5</span>,<span class="Constant">5</span>,<span class="Constant">5</span>,<span class="Constant">5</span>,<span class="Constant">5</span>,<span class="Constant">5</span>,<span class="Constant">5</span>,<span class="Constant">5</span>,<br/></li>
<li>&nbsp; &nbsp; <span class="Constant">6</span>,<span class="Constant">6</span>,<span class="Constant">6</span>,<span class="Constant">6</span>,<span class="Constant">6</span>,<span class="Constant">6</span>,<span class="Constant">6</span>,<span class="Constant">6</span>,<span class="Constant">6</span>,<span class="Constant">6</span>,<span class="Constant">6</span>,<span class="Constant">6</span>,<span class="Constant">6</span>,<span class="Constant">6</span>,<span class="Constant">6</span>,<span class="Constant">6</span>,<span class="Constant">6</span>,<span class="Constant">6</span>,<span class="Constant">6</span>,<span class="Constant">6</span>,<span class="Constant">6</span>,<span class="Constant">6</span>,<span class="Constant">6</span>,<span class="Constant">6</span>,<span class="Constant">6</span>,<span class="Constant">6</span>,<span class="Constant">6</span>,<span class="Constant">6</span>,<span class="Constant">6</span>,<span class="Constant">6</span>,<span class="Constant">6</span>,<span class="Constant">6</span>,<br/></li>
<li>&nbsp; &nbsp; <span class="Constant">7</span>,<span class="Constant">7</span>,<span class="Constant">7</span>,<span class="Constant">7</span>,<span class="Constant">7</span>,<span class="Constant">7</span>,<span class="Constant">7</span>,<span class="Constant">7</span>,<span class="Constant">7</span>,<span class="Constant">7</span>,<span class="Constant">7</span>,<span class="Constant">7</span>,<span class="Constant">7</span>,<span class="Constant">7</span>,<span class="Constant">7</span>,<span class="Constant">7</span>,<span class="Constant">7</span>,<span class="Constant">7</span>,<span class="Constant">7</span>,<span class="Constant">7</span>,<span class="Constant">7</span>,<span class="Constant">7</span>,<span class="Constant">7</span>,<span class="Constant">7</span>,<span class="Constant">7</span>,<span class="Constant">7</span>,<span class="Constant">7</span>,<span class="Constant">7</span>,<span class="Constant">7</span>,<span class="Constant">7</span>,<span class="Constant">7</span>,<span class="Constant">7</span>,<br/></li>
<li>&nbsp; &nbsp; <span class="Constant">7</span>,<span class="Constant">7</span>,<span class="Constant">7</span>,<span class="Constant">7</span>,<span class="Constant">7</span>,<span class="Constant">7</span>,<span class="Constant">7</span>,<span class="Constant">7</span>,<span class="Constant">7</span>,<span class="Constant">7</span>,<span class="Constant">7</span>,<span class="Constant">7</span>,<span class="Constant">7</span>,<span class="Constant">7</span>,<span class="Constant">7</span>,<span class="Constant">7</span>,<span class="Constant">7</span>,<span class="Constant">7</span>,<span class="Constant">7</span>,<span class="Constant">7</span>,<span class="Constant">7</span>,<span class="Constant">7</span>,<span class="Constant">7</span>,<span class="Constant">7</span>,<span class="Constant">7</span>,<span class="Constant">7</span>,<span class="Constant">7</span>,<span class="Constant">7</span>,<span class="Constant">7</span>,<span class="Constant">7</span>,<span class="Constant">7</span>,<span class="Constant">7</span>,<br/></li>
<li>&nbsp; &nbsp; <span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<br/></li>
<li>&nbsp; &nbsp; <span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<br/></li>
<li>&nbsp; &nbsp; <span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<br/></li>
<li>&nbsp; &nbsp; <span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8</span>,<span class="Constant">8<br/></li>
<li></span>&nbsp; };<br/></li>
<li>&nbsp; <span class="Type">int</span> l = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; x--;<br/></li>
<li>&nbsp; <span class="Statement">while</span> (x &gt;= <span class="Constant">256</span>) { l += <span class="Constant">8</span>; x &gt;&gt;= <span class="Constant">8</span>; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> l + log_2[x];<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L76">&#x200c;</a><span class="Type">static</span> <a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a> <span class="linkable">intarith</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">int</span> op, <a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a> v1,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a> v2) {<br/></li>
<li>&nbsp; <span class="Statement">switch</span> (op) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="lua.h.html#L194" title="lua.h:194">LUA_OPADD</a>: <span class="Statement">return</span> <a href="lvm.h.html#L36" title="lvm.h:36">intop</a>(+, v1, v2);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="lua.h.html#L195" title="lua.h:195">LUA_OPSUB</a>:<span class="Statement">return</span> <a href="lvm.h.html#L36" title="lvm.h:36">intop</a>(-, v1, v2);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="lua.h.html#L196" title="lua.h:196">LUA_OPMUL</a>:<span class="Statement">return</span> <a href="lvm.h.html#L36" title="lvm.h:36">intop</a>(*, v1, v2);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="lua.h.html#L197" title="lua.h:197">LUA_OPMOD</a>: <span class="Statement">return</span> <a href="lvm.c.html#L455" title="lvm.c:455">luaV_mod</a>(L, v1, v2);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="lua.h.html#L200" title="lua.h:200">LUA_OPIDIV</a>: <span class="Statement">return</span> <a href="lvm.c.html#L435" title="lvm.c:435">luaV_div</a>(L, v1, v2);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="lua.h.html#L201" title="lua.h:201">LUA_OPBAND</a>: <span class="Statement">return</span> <a href="lvm.h.html#L36" title="lvm.h:36">intop</a>(&amp;, v1, v2);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="lua.h.html#L202" title="lua.h:202">LUA_OPBOR</a>: <span class="Statement">return</span> <a href="lvm.h.html#L36" title="lvm.h:36">intop</a>(|, v1, v2);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="lua.h.html#L203" title="lua.h:203">LUA_OPBXOR</a>: <span class="Statement">return</span> <a href="lvm.h.html#L36" title="lvm.h:36">intop</a>(^, v1, v2);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="lua.h.html#L204" title="lua.h:204">LUA_OPSHL</a>: <span class="Statement">return</span> <a href="lvm.c.html#L476" title="lvm.c:476">luaV_shiftl</a>(v1, v2);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="lua.h.html#L205" title="lua.h:205">LUA_OPSHR</a>: <span class="Statement">return</span> <a href="lvm.c.html#L476" title="lvm.c:476">luaV_shiftl</a>(v1, -v2);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="lua.h.html#L206" title="lua.h:206">LUA_OPUNM</a>: <span class="Statement">return</span> <a href="lvm.h.html#L36" title="lvm.h:36">intop</a>(-, <span class="Constant">0</span>, v1);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="lua.h.html#L207" title="lua.h:207">LUA_OPBNOT</a>: <span class="Statement">return</span> <a href="lvm.h.html#L36" title="lvm.h:36">intop</a>(^, ~<a href="llimits.h.html#L118" title="llimits.h:118">l_castS2U</a>(<span class="Constant">0</span>), v1);<br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:</span> <a href="lualib.h.html#L54" title="lualib.h:54">lua_assert</a>(<span class="Constant">0</span>); <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L96">&#x200c;</a><span class="Type">static</span> <a href="lua.h.html#L87" title="lua.h:87">lua_Number</a> <span class="linkable">numarith</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">int</span> op, <a href="lua.h.html#L87" title="lua.h:87">lua_Number</a> v1,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lua.h.html#L87" title="lua.h:87">lua_Number</a> v2) {<br/></li>
<li>&nbsp; <span class="Statement">switch</span> (op) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="lua.h.html#L194" title="lua.h:194">LUA_OPADD</a>: <span class="Statement">return</span> <a href="luaconf.h.html#L498" title="luaconf.h:498">luai_numadd</a>(L, v1, v2);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="lua.h.html#L195" title="lua.h:195">LUA_OPSUB</a>: <span class="Statement">return</span> <a href="luaconf.h.html#L499" title="luaconf.h:499">luai_numsub</a>(L, v1, v2);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="lua.h.html#L196" title="lua.h:196">LUA_OPMUL</a>: <span class="Statement">return</span> <a href="luaconf.h.html#L500" title="luaconf.h:500">luai_nummul</a>(L, v1, v2);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="lua.h.html#L199" title="lua.h:199">LUA_OPDIV</a>: <span class="Statement">return</span> <a href="luaconf.h.html#L501" title="luaconf.h:501">luai_numdiv</a>(L, v1, v2);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="lua.h.html#L198" title="lua.h:198">LUA_OPPOW</a>: <span class="Statement">return</span> <a href="luaconf.h.html#L492" title="luaconf.h:492">luai_numpow</a>(L, v1, v2);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="lua.h.html#L200" title="lua.h:200">LUA_OPIDIV</a>: <span class="Statement">return</span> <a href="luaconf.h.html#L479" title="luaconf.h:479">luai_numidiv</a>(L, v1, v2);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="lua.h.html#L206" title="lua.h:206">LUA_OPUNM</a>: <span class="Statement">return</span> <a href="luaconf.h.html#L502" title="luaconf.h:502">luai_numunm</a>(L, v1);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="lua.h.html#L197" title="lua.h:197">LUA_OPMOD</a>: {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="lua.h.html#L87" title="lua.h:87">lua_Number</a> m;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="luaconf.h.html#L488" title="luaconf.h:488">luai_nummod</a>(L, v1, v2, m);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span> m;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:</span> <a href="lualib.h.html#L54" title="lualib.h:54">lua_assert</a>(<span class="Constant">0</span>); <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L116">&#x200c;</a><span class="Type">void</span> <span class="linkable">luaO_arith</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">int</span> op, <span class="Type">const</span> <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> *p1, <span class="Type">const</span> <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> *p2,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> *res) {<br/></li>
<li>&nbsp; <span class="Statement">switch</span> (op) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="lua.h.html#L201" title="lua.h:201">LUA_OPBAND</a>: <span class="Statement">case</span> <a href="lua.h.html#L202" title="lua.h:202">LUA_OPBOR</a>: <span class="Statement">case</span> <a href="lua.h.html#L203" title="lua.h:203">LUA_OPBXOR</a>:<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="lua.h.html#L204" title="lua.h:204">LUA_OPSHL</a>: <span class="Statement">case</span> <a href="lua.h.html#L205" title="lua.h:205">LUA_OPSHR</a>:<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="lua.h.html#L207" title="lua.h:207">LUA_OPBNOT</a>: {&nbsp; <span class="Comment">/* operate only on integers */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a> i1; <a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a> i2;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="lvm.h.html#L33" title="lvm.h:33">tointeger</a>(p1, &amp;i1) &amp;&amp; <a href="lvm.h.html#L33" title="lvm.h:33">tointeger</a>(p2, &amp;i2)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L193" title="lobject.h:193">setivalue</a>(res, <a href="#L76" title="lobject.c:76">intarith</a>(L, op, i1, i2));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">break</span>;&nbsp; <span class="Comment">/* go to the end */<br/></li>
<li></span>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="lua.h.html#L199" title="lua.h:199">LUA_OPDIV</a>: <span class="Statement">case</span> <a href="lua.h.html#L198" title="lua.h:198">LUA_OPPOW</a>: {&nbsp; <span class="Comment">/* operate only on floats */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <a href="lua.h.html#L87" title="lua.h:87">lua_Number</a> n1; <a href="lua.h.html#L87" title="lua.h:87">lua_Number</a> n2;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="lvm.h.html#L30" title="lvm.h:30">tonumber</a>(p1, &amp;n1) &amp;&amp; <a href="lvm.h.html#L30" title="lvm.h:30">tonumber</a>(p2, &amp;n2)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L190" title="lobject.h:190">setfltvalue</a>(res, <a href="#L96" title="lobject.c:96">numarith</a>(L, op, n1, n2));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">break</span>;&nbsp; <span class="Comment">/* go to the end */<br/></li>
<li></span>&nbsp; &nbsp; }<br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:</span> {&nbsp; <span class="Comment">/* other operations */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <a href="lua.h.html#L87" title="lua.h:87">lua_Number</a> n1; <a href="lua.h.html#L87" title="lua.h:87">lua_Number</a> n2;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="lobject.h.html#L136" title="lobject.h:136">ttisinteger</a>(p1) &amp;&amp; <a href="lobject.h.html#L136" title="lobject.h:136">ttisinteger</a>(p2)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L193" title="lobject.h:193">setivalue</a>(res, <a href="#L76" title="lobject.c:76">intarith</a>(L, op, <a href="lobject.h.html#L155" title="lobject.h:155">ivalue</a>(p1), <a href="lobject.h.html#L155" title="lobject.h:155">ivalue</a>(p2)));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (<a href="lvm.h.html#L30" title="lvm.h:30">tonumber</a>(p1, &amp;n1) &amp;&amp; <a href="lvm.h.html#L30" title="lvm.h:30">tonumber</a>(p2, &amp;n2)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L190" title="lobject.h:190">setfltvalue</a>(res, <a href="#L96" title="lobject.c:96">numarith</a>(L, op, n1, n2));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">break</span>;&nbsp; <span class="Comment">/* go to the end */<br/></li>
<li></span>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Comment">/* could not perform raw operation; try metamethod */<br/></li>
<li></span>&nbsp; <a href="lualib.h.html#L54" title="lualib.h:54">lua_assert</a>(L != <span class="Constant">NULL</span>);&nbsp; <span class="Comment">/* should not fail when folding (compile time) */<br/></li>
<li></span>&nbsp; <a href="ltm.c.html#L114" title="ltm.c:114">luaT_trybinTM</a>(L, p1, p2, res, <a href="llimits.h.html#L107" title="llimits.h:107">cast</a>(<a href="ltm.h.html#L44" title="ltm.h:44">TMS</a>, op - <a href="lua.h.html#L194" title="lua.h:194">LUA_OPADD</a> + TM_ADD));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L156">&#x200c;</a><span class="Type">int</span> <span class="linkable">luaO_hexavalue</span> (<span class="Type">int</span> c) {<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="lctype.h.html#L59" title="lctype.h:59">lisdigit</a>(c)) <span class="Statement">return</span> c - <span class="Constant">'0'</span>;<br/></li>
<li>&nbsp; <span class="Statement">else</span> <span class="Statement">return</span> <a href="lctype.h.html#L67" title="lctype.h:67">ltolower</a>(c) - <span class="Constant">'a'</span> + <span class="Constant">10</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L162">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">isneg</span> (<span class="Type">const</span> <span class="Type">char</span> **s) {<br/></li>
<li>&nbsp; <span class="Statement">if</span> (**s == <span class="Constant">'-'</span>) { (*s)++; <span class="Statement">return</span> <span class="Constant">1</span>; }<br/></li>
<li>&nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (**s == <span class="Constant">'+'</span>) (*s)++;<br/></li>
<li>&nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** {==================================================================<br/></li>
<li></span><span class="Comment">** Lua's implementation for '<a href="#L187" title="lobject.c:187">lua_strx2number</a>'<br/></li>
<li></span><span class="Comment">** ===================================================================<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li></span><span class="PreProc">#if !defined(<a href="#L187" title="lobject.c:187">lua_strx2number</a>)<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;math.h&gt;<br/></li>
<li></span><br/></li>
<li><span class="Comment">/* maximum number of significant digits to read (to avoid overflows<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; even with single floats) */<br/></li>
<li><a id="L181">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">MAXSIGDIG</span>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">30<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** convert an hexadecimal numeric string to a number, following<br/></li>
<li></span><span class="Comment">** C99 specification for 'strtod'<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L187">&#x200c;</a></span><span class="Type">static</span> <a href="lua.h.html#L87" title="lua.h:87">lua_Number</a> <span class="linkable">lua_strx2number</span> (<span class="Type">const</span> <span class="Type">char</span> *s, <span class="Type">char</span> **endptr) {<br/></li>
<li>&nbsp; <a href="lua.h.html#L87" title="lua.h:87">lua_Number</a> r = <span class="Constant">0.0</span>;&nbsp; <span class="Comment">/* result (accumulator) */<br/></li>
<li></span>&nbsp; <span class="Type">int</span> sigdig = <span class="Constant">0</span>;&nbsp; <span class="Comment">/* number of significant digits */<br/></li>
<li></span>&nbsp; <span class="Type">int</span> nosigdig = <span class="Constant">0</span>;&nbsp; <span class="Comment">/* number of non-significant digits */<br/></li>
<li></span>&nbsp; <span class="Type">int</span> e = <span class="Constant">0</span>;&nbsp; <span class="Comment">/* exponent correction */<br/></li>
<li></span>&nbsp; <span class="Type">int</span> neg;&nbsp; <span class="Comment">/* 1 if number is negative */<br/></li>
<li></span>&nbsp; <span class="Type">int</span> dot = <span class="Constant">0</span>;&nbsp; <span class="Comment">/* true after seen a dot */<br/></li>
<li></span>&nbsp; *endptr = <a href="llimits.h.html#L107" title="llimits.h:107">cast</a>(<span class="Type">char</span> *, s);&nbsp; <span class="Comment">/* nothing is valid yet */<br/></li>
<li></span>&nbsp; <span class="Statement">while</span> (<a href="lctype.h.html#L60" title="lctype.h:60">lisspace</a>(<a href="llimits.h.html#L113" title="llimits.h:113">cast_uchar</a>(*s))) s++;&nbsp; <span class="Comment">/* skip initial spaces */<br/></li>
<li></span>&nbsp; neg = <a href="#L162" title="lobject.c:162">isneg</a>(&amp;s);&nbsp; <span class="Comment">/* <a href="lparser.c.html#L106" title="lparser.c:106">check</a> signal */<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (!(*s == <span class="Constant">'0'</span> &amp;&amp; (*(s + <span class="Constant">1</span>) == <span class="Constant">'x'</span> || *(s + <span class="Constant">1</span>) == <span class="Constant">'X'</span>)))&nbsp; <span class="Comment">/* <a href="lparser.c.html#L106" title="lparser.c:106">check</a> '0x' */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0.0</span>;&nbsp; <span class="Comment">/* invalid format (no '0x') */<br/></li>
<li></span>&nbsp; <span class="Statement">for</span> (s += <span class="Constant">2</span>; ; s++) {&nbsp; <span class="Comment">/* skip '0x' and read numeral */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (*s == <span class="Constant">'.'</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (dot) <span class="Statement">break</span>;&nbsp; <span class="Comment">/* second dot? stop loop */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">else</span> dot = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (<a href="lctype.h.html#L62" title="lctype.h:62">lisxdigit</a>(<a href="llimits.h.html#L113" title="llimits.h:113">cast_uchar</a>(*s))) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (sigdig == <span class="Constant">0</span> &amp;&amp; *s == <span class="Constant">'0'</span>)&nbsp; <span class="Comment">/* non-significant <a href="lstrlib.c.html#L1029" title="lstrlib.c:1029">digit</a> (zero)? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; nosigdig++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (++sigdig &lt;= <a href="#L181" title="lobject.c:181">MAXSIGDIG</a>)&nbsp; <span class="Comment">/* can read it without overflow? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r = (r * <a href="llimits.h.html#L111" title="llimits.h:111">cast_num</a>(<span class="Constant">16.0</span>)) + <a href="#L156" title="lobject.c:156">luaO_hexavalue</a>(*s);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">else</span> e++; <span class="Comment">/* too many digits; ignore, but still count for exponent */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (dot) e--;&nbsp; <span class="Comment">/* decimal <a href="lstrlib.c.html#L1029" title="lstrlib.c:1029">digit</a>? correct exponent */<br/></li>
<li></span>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">break</span>;&nbsp; <span class="Comment">/* neither a dot nor a <a href="lstrlib.c.html#L1029" title="lstrlib.c:1029">digit</a> */<br/></li>
<li></span>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">if</span> (nosigdig + sigdig == <span class="Constant">0</span>)&nbsp; <span class="Comment">/* no digits? */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0.0</span>;&nbsp; <span class="Comment">/* invalid format */<br/></li>
<li></span>&nbsp; *endptr = <a href="llimits.h.html#L107" title="llimits.h:107">cast</a>(<span class="Type">char</span> *, s);&nbsp; <span class="Comment">/* valid up to here */<br/></li>
<li></span>&nbsp; e *= <span class="Constant">4</span>;&nbsp; <span class="Comment">/* each <a href="lstrlib.c.html#L1029" title="lstrlib.c:1029">digit</a> multiplies/divides value by 2^4 */<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (*s == <span class="Constant">'p'</span> || *s == <span class="Constant">'P'</span>) {&nbsp; <span class="Comment">/* exponent part? */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">int</span> <a href="lparser.c.html#L1277" title="lparser.c:1277">exp1</a> = <span class="Constant">0</span>;&nbsp; <span class="Comment">/* exponent value */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">int</span> neg1;&nbsp; <span class="Comment">/* exponent signal */<br/></li>
<li></span>&nbsp; &nbsp; s++;&nbsp; <span class="Comment">/* skip 'p' */<br/></li>
<li></span>&nbsp; &nbsp; neg1 = <a href="#L162" title="lobject.c:162">isneg</a>(&amp;s);&nbsp; <span class="Comment">/* signal */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (!<a href="lctype.h.html#L59" title="lctype.h:59">lisdigit</a>(<a href="llimits.h.html#L113" title="llimits.h:113">cast_uchar</a>(*s)))<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0.0</span>;&nbsp; <span class="Comment">/* invalid; must have at least one <a href="lstrlib.c.html#L1029" title="lstrlib.c:1029">digit</a> */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">while</span> (<a href="lctype.h.html#L59" title="lctype.h:59">lisdigit</a>(<a href="llimits.h.html#L113" title="llimits.h:113">cast_uchar</a>(*s)))&nbsp; <span class="Comment">/* read exponent */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <a href="lparser.c.html#L1277" title="lparser.c:1277">exp1</a> = <a href="lparser.c.html#L1277" title="lparser.c:1277">exp1</a> * <span class="Constant">10</span> + *(s++) - <span class="Constant">'0'</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (neg1) <a href="lparser.c.html#L1277" title="lparser.c:1277">exp1</a> = -<a href="lparser.c.html#L1277" title="lparser.c:1277">exp1</a>;<br/></li>
<li>&nbsp; &nbsp; e += <a href="lparser.c.html#L1277" title="lparser.c:1277">exp1</a>;<br/></li>
<li>&nbsp; &nbsp; *endptr = <a href="llimits.h.html#L107" title="llimits.h:107">cast</a>(<span class="Type">char</span> *, s);&nbsp; <span class="Comment">/* valid up to here */<br/></li>
<li></span>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">if</span> (neg) r = -r;<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="luaconf.h.html#L412" title="luaconf.h:412">l_mathop</a>(ldexp)(r, e);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><span class="Comment">/* }====================================================== */<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><a id="L239">&#x200c;</a><span class="Type">static</span> <span class="Type">const</span> <span class="Type">char</span> *<span class="linkable">l_str2d</span> (<span class="Type">const</span> <span class="Type">char</span> *s, <a href="lua.h.html#L87" title="lua.h:87">lua_Number</a> *result) {<br/></li>
<li>&nbsp; <span class="Type">char</span> *endptr;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (strpbrk(s, <span class="Constant">&quot;nN&quot;</span>))&nbsp; <span class="Comment">/* reject 'inf' and 'nan' */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (strpbrk(s, <span class="Constant">&quot;xX&quot;</span>))&nbsp; <span class="Comment">/* hex? */<br/></li>
<li></span>&nbsp; &nbsp; *result = <a href="#L187" title="lobject.c:187">lua_strx2number</a>(s, &amp;endptr);<br/></li>
<li>&nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; *result = <a href="luaconf.h.html#L414" title="luaconf.h:414">lua_str2number</a>(s, &amp;endptr);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (endptr == s) <span class="Statement">return</span> <span class="Constant">0</span>;&nbsp; <span class="Comment">/* nothing recognized */<br/></li>
<li></span>&nbsp; <span class="Statement">while</span> (<a href="lctype.h.html#L60" title="lctype.h:60">lisspace</a>(<a href="llimits.h.html#L113" title="llimits.h:113">cast_uchar</a>(*endptr))) endptr++;<br/></li>
<li>&nbsp; <span class="Statement">return</span> (*endptr == <span class="Special">'\0'</span> ? endptr : <span class="Constant">NULL</span>);&nbsp; <span class="Comment">/* OK if no trailing characters */<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L253">&#x200c;</a><span class="Type">static</span> <span class="Type">const</span> <span class="Type">char</span> *<span class="linkable">l_str2int</span> (<span class="Type">const</span> <span class="Type">char</span> *s, <a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a> *result) {<br/></li>
<li>&nbsp; <a href="lua.h.html#L94" title="lua.h:94">lua_Unsigned</a> a = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; <span class="Type">int</span> empty = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; <span class="Type">int</span> neg;<br/></li>
<li>&nbsp; <span class="Statement">while</span> (<a href="lctype.h.html#L60" title="lctype.h:60">lisspace</a>(<a href="llimits.h.html#L113" title="llimits.h:113">cast_uchar</a>(*s))) s++;&nbsp; <span class="Comment">/* skip initial spaces */<br/></li>
<li></span>&nbsp; neg = <a href="#L162" title="lobject.c:162">isneg</a>(&amp;s);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (s[<span class="Constant">0</span>] == <span class="Constant">'0'</span> &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; (s[<span class="Constant">1</span>] == <span class="Constant">'x'</span> || s[<span class="Constant">1</span>] == <span class="Constant">'X'</span>)) {&nbsp; <span class="Comment">/* hex? */<br/></li>
<li></span>&nbsp; &nbsp; s += <span class="Constant">2</span>;&nbsp; <span class="Comment">/* skip '0x' */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">for</span> (; <a href="lctype.h.html#L62" title="lctype.h:62">lisxdigit</a>(<a href="llimits.h.html#L113" title="llimits.h:113">cast_uchar</a>(*s)); s++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; a = a * <span class="Constant">16</span> + <a href="#L156" title="lobject.c:156">luaO_hexavalue</a>(*s);<br/></li>
<li>&nbsp; &nbsp; &nbsp; empty = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">else</span> {&nbsp; <span class="Comment">/* decimal */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">for</span> (; <a href="lctype.h.html#L59" title="lctype.h:59">lisdigit</a>(<a href="llimits.h.html#L113" title="llimits.h:113">cast_uchar</a>(*s)); s++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; a = a * <span class="Constant">10</span> + *s - <span class="Constant">'0'</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; empty = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">while</span> (<a href="lctype.h.html#L60" title="lctype.h:60">lisspace</a>(<a href="llimits.h.html#L113" title="llimits.h:113">cast_uchar</a>(*s))) s++;&nbsp; <span class="Comment">/* skip trailing spaces */<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (empty || *s != <span class="Special">'\0'</span>) <span class="Statement">return</span> <span class="Constant">NULL</span>;&nbsp; <span class="Comment">/* something wrong in the numeral */<br/></li>
<li></span>&nbsp; <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; *result = <a href="llimits.h.html#L127" title="llimits.h:127">l_castU2S</a>((neg) ? <span class="Constant">0u</span> - a : a);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> s;<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L282">&#x200c;</a><span class="Type">size_t</span> <span class="linkable">luaO_str2num</span> (<span class="Type">const</span> <span class="Type">char</span> *s, <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> *o) {<br/></li>
<li>&nbsp; <a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a> i; <a href="lua.h.html#L87" title="lua.h:87">lua_Number</a> n;<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">char</span> *e;<br/></li>
<li>&nbsp; <span class="Statement">if</span> ((e = <a href="#L253" title="lobject.c:253">l_str2int</a>(s, &amp;i)) != <span class="Constant">NULL</span>) {&nbsp; <span class="Comment">/* try as an integer */<br/></li>
<li></span>&nbsp; &nbsp; <a href="lobject.h.html#L193" title="lobject.h:193">setivalue</a>(o, i);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">else</span> <span class="Statement">if</span> ((e = <a href="#L239" title="lobject.c:239">l_str2d</a>(s, &amp;n)) != <span class="Constant">NULL</span>) {&nbsp; <span class="Comment">/* else try as a float */<br/></li>
<li></span>&nbsp; &nbsp; <a href="lobject.h.html#L190" title="lobject.h:190">setfltvalue</a>(o, n);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;&nbsp; <span class="Comment">/* conversion failed */<br/></li>
<li></span>&nbsp; <span class="Statement">return</span> (e - s + <span class="Constant">1</span>);&nbsp; <span class="Comment">/* success; return string size */<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L297">&#x200c;</a><span class="Type">int</span> <span class="linkable">luaO_utf8esc</span> (<span class="Type">char</span> *buff, <span class="Type">unsigned</span> <span class="Type">long</span> x) {<br/></li>
<li>&nbsp; <span class="Type">int</span> n = <span class="Constant">1</span>;&nbsp; <span class="Comment">/* number of bytes put in buffer (backwards) */<br/></li>
<li></span>&nbsp; <a href="lualib.h.html#L54" title="lualib.h:54">lua_assert</a>(x &lt;= <span class="Constant">0x10FFFF</span>);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (x &lt; <span class="Constant">0x80</span>)&nbsp; <span class="Comment">/* ascii? */<br/></li>
<li></span>&nbsp; &nbsp; buff[<a href="lobject.h.html#L522" title="lobject.h:522">UTF8BUFFSZ</a> - <span class="Constant">1</span>] = <a href="llimits.h.html#L107" title="llimits.h:107">cast</a>(<span class="Type">char</span>, x);<br/></li>
<li>&nbsp; <span class="Statement">else</span> {&nbsp; <span class="Comment">/* need continuation bytes */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">unsigned</span> <span class="Type">int</span> mfb = <span class="Constant">0x3f</span>;&nbsp; <span class="Comment">/* maximum that fits in first byte */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">do</span> {&nbsp; <span class="Comment">/* add continuation bytes */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; buff[<a href="lobject.h.html#L522" title="lobject.h:522">UTF8BUFFSZ</a> - (n++)] = <a href="llimits.h.html#L107" title="llimits.h:107">cast</a>(<span class="Type">char</span>, <span class="Constant">0x80</span> | (x &amp; <span class="Constant">0x3f</span>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; x &gt;&gt;= <span class="Constant">6</span>;&nbsp; <span class="Comment">/* remove added bits */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; mfb &gt;&gt;= <span class="Constant">1</span>;&nbsp; <span class="Comment">/* now there is one less bit available in first byte */<br/></li>
<li></span>&nbsp; &nbsp; } <span class="Statement">while</span> (x &gt; mfb);&nbsp; <span class="Comment">/* still needs continuation byte? */<br/></li>
<li></span>&nbsp; &nbsp; buff[<a href="lobject.h.html#L522" title="lobject.h:522">UTF8BUFFSZ</a> - n] = <a href="llimits.h.html#L107" title="llimits.h:107">cast</a>(<span class="Type">char</span>, (~mfb &lt;&lt; <span class="Constant">1</span>) | x);&nbsp; <span class="Comment">/* add first byte */<br/></li>
<li></span>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> n;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/* maximum length of the conversion of a number to a string */<br/></li>
<li><a id="L316">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">MAXNUMBER2STR</span>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">50<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** Convert a number object to a string<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L322">&#x200c;</a></span><span class="Type">void</span> <span class="linkable">luaO_tostring</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <a href="lobject.h.html#L294" title="lobject.h:294">StkId</a> obj) {<br/></li>
<li>&nbsp; <span class="Type">char</span> buff[<a href="#L316" title="lobject.c:316">MAXNUMBER2STR</a>];<br/></li>
<li>&nbsp; <span class="Type">size_t</span> len;<br/></li>
<li>&nbsp; <a href="lualib.h.html#L54" title="lualib.h:54">lua_assert</a>(<a href="lobject.h.html#L134" title="lobject.h:134">ttisnumber</a>(obj));<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="lobject.h.html#L136" title="lobject.h:136">ttisinteger</a>(obj))<br/></li>
<li>&nbsp; &nbsp; len = <a href="luaconf.h.html#L528" title="luaconf.h:528">lua_integer2str</a>(buff, <a href="lobject.h.html#L155" title="lobject.h:155">ivalue</a>(obj));<br/></li>
<li>&nbsp; <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; len = <a href="luaconf.h.html#L452" title="luaconf.h:452">lua_number2str</a>(buff, <a href="lobject.h.html#L156" title="lobject.h:156">fltvalue</a>(obj));<br/></li>
<li><span class="PreProc">#if !defined(LUA_COMPAT_FLOATSTRING)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (buff[strspn(buff, <span class="Constant">&quot;-0123456789&quot;</span>)] == <span class="Special">'\0'</span>) {&nbsp; <span class="Comment">/* looks like an int? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; buff[len++] = <span class="Constant">'.'</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; buff[len++] = <span class="Constant">'0'</span>;&nbsp; <span class="Comment">/* adds '.0' to result */<br/></li>
<li></span>&nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; }<br/></li>
<li>&nbsp; <a href="lobject.h.html#L258" title="lobject.h:258">setsvalue2s</a>(L, obj, <a href="lstring.c.html#L151" title="lstring.c:151">luaS_newlstr</a>(L, buff, len));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L341">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">pushstr</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">const</span> <span class="Type">char</span> *str, <span class="Type">size_t</span> l) {<br/></li>
<li>&nbsp; <a href="lobject.h.html#L258" title="lobject.h:258">setsvalue2s</a>(L, L-&gt;top++, <a href="lstring.c.html#L151" title="lstring.c:151">luaS_newlstr</a>(L, str, l));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/* this function handles only '%d', '%c', '%f', '%p', and '%s'<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; conventional formats, plus Lua-specific '%I' and '%U' */<br/></li>
<li><a id="L348">&#x200c;</a></span><span class="Type">const</span> <span class="Type">char</span> *<span class="linkable">luaO_pushvfstring</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">const</span> <span class="Type">char</span> *fmt, <span class="Type">va_list</span> argp) {<br/></li>
<li>&nbsp; <span class="Type">int</span> n = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; <span class="Statement">for</span> (;;) {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span> *e = strchr(fmt, <span class="Constant">'%'</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (e == <span class="Constant">NULL</span>) <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; <a href="ldo.h.html#L16" title="ldo.h:16">luaD_checkstack</a>(L, <span class="Constant">2</span>);&nbsp; <span class="Comment">/* fmt + item */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L341" title="lobject.c:341">pushstr</a>(L, fmt, e - fmt);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">switch</span> (*(e+<span class="Constant">1</span>)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'s'</span>: {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span> *s = va_arg(argp, <span class="Type">char</span> *);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (s == <span class="Constant">NULL</span>) s = <span class="Constant">&quot;(null)&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L341" title="lobject.c:341">pushstr</a>(L, s, strlen(s));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'c'</span>: {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">char</span> buff = <a href="llimits.h.html#L107" title="llimits.h:107">cast</a>(<span class="Type">char</span>, va_arg(argp, <span class="Type">int</span>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="lctype.h.html#L61" title="lctype.h:61">lisprint</a>(<a href="llimits.h.html#L113" title="llimits.h:113">cast_uchar</a>(buff)))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L341" title="lobject.c:341">pushstr</a>(L, &amp;buff, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else</span>&nbsp; <span class="Comment">/* non-printable character; print its code */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L416" title="lobject.c:416">luaO_pushfstring</a>(L, <span class="Constant">&quot;&lt;</span><span class="Special">\\%d</span><span class="Constant">&gt;&quot;</span>, <a href="llimits.h.html#L113" title="llimits.h:113">cast_uchar</a>(buff));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'d'</span>: {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L193" title="lobject.h:193">setivalue</a>(L-&gt;top++, va_arg(argp, <span class="Type">int</span>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L322" title="lobject.c:322">luaO_tostring</a>(L, L-&gt;top - <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'I'</span>: {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L193" title="lobject.h:193">setivalue</a>(L-&gt;top++, <a href="llimits.h.html#L107" title="llimits.h:107">cast</a>(<a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a>, va_arg(argp, <a href="llimits.h.html#L74" title="llimits.h:74">l_uacInt</a>)));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L322" title="lobject.c:322">luaO_tostring</a>(L, L-&gt;top - <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'f'</span>: {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L190" title="lobject.h:190">setfltvalue</a>(L-&gt;top++, <a href="llimits.h.html#L111" title="llimits.h:111">cast_num</a>(va_arg(argp, <a href="llimits.h.html#L73" title="llimits.h:73">l_uacNumber</a>)));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L322" title="lobject.c:322">luaO_tostring</a>(L, L-&gt;top - <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'p'</span>: {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">char</span> buff[<span class="Constant">4</span>*<span class="Statement">sizeof</span>(<span class="Type">void</span> *) + <span class="Constant">8</span>]; <span class="Comment">/* should be enough space for a '%p' */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> l = sprintf(buff, <span class="Constant">&quot;</span><span class="Special">%p</span><span class="Constant">&quot;</span>, va_arg(argp, <span class="Type">void</span> *));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L341" title="lobject.c:341">pushstr</a>(L, buff, l);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'U'</span>: {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">char</span> buff[<a href="lobject.h.html#L522" title="lobject.h:522">UTF8BUFFSZ</a>];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> l = <a href="#L297" title="lobject.c:297">luaO_utf8esc</a>(buff, <a href="llimits.h.html#L107" title="llimits.h:107">cast</a>(<span class="Type">long</span>, va_arg(argp, <span class="Type">long</span>)));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L341" title="lobject.c:341">pushstr</a>(L, buff + <a href="lobject.h.html#L522" title="lobject.h:522">UTF8BUFFSZ</a> - l, l);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'%'</span>: {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L341" title="lobject.c:341">pushstr</a>(L, <span class="Constant">&quot;%&quot;</span>, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ldebug.c.html#L603" title="ldebug.c:603">luaG_runerror</a>(L, <span class="Constant">&quot;invalid option '</span><span class="Special">%%%c</span><span class="Constant">' to '<a href="lapi.c.html#L513" title="lapi.c:513">lua_pushfstring</a>'&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *(e + <span class="Constant">1</span>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; n += <span class="Constant">2</span>;<br/></li>
<li>&nbsp; &nbsp; fmt = e+<span class="Constant">2</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <a href="ldo.h.html#L16" title="ldo.h:16">luaD_checkstack</a>(L, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; <a href="#L341" title="lobject.c:341">pushstr</a>(L, fmt, strlen(fmt));<br/></li>
<li>&nbsp; <span class="Statement">if</span> (n &gt; <span class="Constant">0</span>) <a href="lvm.c.html#L361" title="lvm.c:361">luaV_concat</a>(L, n + <span class="Constant">1</span>);<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="lobject.h.html#L330" title="lobject.h:330">svalue</a>(L-&gt;top - <span class="Constant">1</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L416">&#x200c;</a><span class="Type">const</span> <span class="Type">char</span> *<span class="linkable">luaO_pushfstring</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">const</span> <span class="Type">char</span> *fmt, ...) {<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">char</span> *msg;<br/></li>
<li>&nbsp; <span class="Type">va_list</span> argp;<br/></li>
<li>&nbsp; va_start(argp, fmt);<br/></li>
<li>&nbsp; msg = <a href="#L348" title="lobject.c:348">luaO_pushvfstring</a>(L, fmt, argp);<br/></li>
<li>&nbsp; va_end(argp);<br/></li>
<li>&nbsp; <span class="Statement">return</span> msg;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/* number of chars of a literal string without the ending \0 */<br/></li>
<li><a id="L427">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">LL</span>(x)&nbsp; &nbsp; &nbsp; &nbsp; (</span><span class="Statement">sizeof</span><span class="PreProc">(x)/</span><span class="Statement">sizeof</span><span class="PreProc">(</span><span class="Type">char</span><span class="PreProc">) - </span><span class="Constant">1</span><span class="PreProc">)<br/></li>
<li></span><br/></li>
<li><a id="L429">&#x200c;</a><span class="PreProc">#define <span class="linkable">RETS</span>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">&quot;...&quot;<br/></li>
<li><a id="L430">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">PRE</span>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">&quot;[string </span><span class="Special">\&quot;</span><span class="Constant">&quot;<br/></li>
<li><a id="L431">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">POS</span>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">&quot;</span><span class="Special">\&quot;</span><span class="Constant">]&quot;<br/></li>
<li></span><br/></li>
<li><a id="L433">&#x200c;</a><span class="PreProc">#define <span class="linkable">addstr</span>(a,b,l)&nbsp; &nbsp; &nbsp; &nbsp; ( memcpy(a,b,(l) * </span><span class="Statement">sizeof</span><span class="PreProc">(</span><span class="Type">char</span><span class="PreProc">)), a += (l) )<br/></li>
<li></span><br/></li>
<li><a id="L435">&#x200c;</a><span class="Type">void</span> <span class="linkable">luaO_chunkid</span> (<span class="Type">char</span> *out, <span class="Type">const</span> <span class="Type">char</span> *source, <span class="Type">size_t</span> bufflen) {<br/></li>
<li>&nbsp; <span class="Type">size_t</span> l = strlen(source);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (*source == <span class="Constant">'='</span>) {&nbsp; <span class="Comment">/* 'literal' source */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (l &lt;= bufflen)&nbsp; <span class="Comment">/* small enough? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; memcpy(out, source + <span class="Constant">1</span>, l * <span class="Statement">sizeof</span>(<span class="Type">char</span>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else</span> {&nbsp; <span class="Comment">/* truncate it */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <a href="#L433" title="lobject.c:433">addstr</a>(out, source + <span class="Constant">1</span>, bufflen - <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; *out = <span class="Special">'\0'</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (*source == <span class="Constant">'@'</span>) {&nbsp; <span class="Comment">/* file name */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (l &lt;= bufflen)&nbsp; <span class="Comment">/* small enough? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; memcpy(out, source + <span class="Constant">1</span>, l * <span class="Statement">sizeof</span>(<span class="Type">char</span>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else</span> {&nbsp; <span class="Comment">/* add '...' before rest of name */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <a href="#L433" title="lobject.c:433">addstr</a>(out, <a href="#L429" title="lobject.c:429">RETS</a>, <a href="#L427" title="lobject.c:427">LL</a>(<a href="#L429" title="lobject.c:429">RETS</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; bufflen -= <a href="#L427" title="lobject.c:427">LL</a>(<a href="#L429" title="lobject.c:429">RETS</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; memcpy(out, source + <span class="Constant">1</span> + l - bufflen, bufflen * <span class="Statement">sizeof</span>(<span class="Type">char</span>));<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">else</span> {&nbsp; <span class="Comment">/* string; format as [string &quot;source&quot;] */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span> *nl = strchr(source, <span class="Special">'\n'</span>);&nbsp; <span class="Comment">/* find first new line (if any) */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L433" title="lobject.c:433">addstr</a>(out, <a href="#L430" title="lobject.c:430">PRE</a>, <a href="#L427" title="lobject.c:427">LL</a>(<a href="#L430" title="lobject.c:430">PRE</a>));&nbsp; <span class="Comment">/* add prefix */<br/></li>
<li></span>&nbsp; &nbsp; bufflen -= <a href="#L427" title="lobject.c:427">LL</a>(<a href="#L430" title="lobject.c:430">PRE</a> <a href="#L429" title="lobject.c:429">RETS</a> <a href="#L431" title="lobject.c:431">POS</a>) + <span class="Constant">1</span>;&nbsp; <span class="Comment">/* <a href="llex.c.html#L56" title="llex.c:56">save</a> space for prefix+suffix+'\0' */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (l &lt; bufflen &amp;&amp; nl == <span class="Constant">NULL</span>) {&nbsp; <span class="Comment">/* small one-line source? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <a href="#L433" title="lobject.c:433">addstr</a>(out, source, l);&nbsp; <span class="Comment">/* keep it */<br/></li>
<li></span>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (nl != <span class="Constant">NULL</span>) l = nl - source;&nbsp; <span class="Comment">/* stop at first newline */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (l &gt; bufflen) l = bufflen;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L433" title="lobject.c:433">addstr</a>(out, source, l);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L433" title="lobject.c:433">addstr</a>(out, <a href="#L429" title="lobject.c:429">RETS</a>, <a href="#L427" title="lobject.c:427">LL</a>(<a href="#L429" title="lobject.c:429">RETS</a>));<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; memcpy(out, <a href="#L431" title="lobject.c:431">POS</a>, (<a href="#L427" title="lobject.c:427">LL</a>(<a href="#L431" title="lobject.c:431">POS</a>) + <span class="Constant">1</span>) * <span class="Statement">sizeof</span>(<span class="Type">char</span>));<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
</ol></code>
 </body>
</html>
