<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>lstate.c - src</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

code {
    font-family: consolas, monospace;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
  <h3>lstate.c - src</h3>
   <a href="../index.html"> Table of Contents </a>
 <h4>Data types defined</h4>
 <ul>
<li><a href="#L66">LG</a></li>
<li><a href="#L69">LG</a></li>
<li><a href="#L57">LX</a></li>
<li><a href="#L60">LX</a></li>
</ul>
 <h4>Functions defined</h4>
 <ul>
<li><a href="#L239">close_state</a></li>
<li><a href="#L198">f_luaopen</a></li>
<li><a href="#L167">freestack</a></li>
<li><a href="#L179">init_registry</a></li>
<li><a href="#L107">luaE_extendCI</a></li>
<li><a href="#L120">luaE_freeCI</a></li>
<li><a href="#L283">luaE_freethread</a></li>
<li><a href="#L101">luaE_setdebt</a></li>
<li><a href="#L134">luaE_shrinkCI</a></li>
<li><a href="#L340">lua_close</a></li>
<li><a href="#L293">lua_newstate</a></li>
<li><a href="#L253">lua_newthread</a></li>
<li><a href="#L84">makeseed</a></li>
<li><a href="#L219">preinit_thread</a></li>
<li><a href="#L147">stack_init</a></li>
</ul>
 <h4>Macros defined</h4>
 <ul>
<li><a href="#L36">LUAI_GCMUL</a></li>
<li><a href="#L32">LUAI_GCPAUSE</a></li>
<li><a href="#L8">LUA_CORE</a></li>
<li><a href="#L40">MEMERRMSG</a></li>
<li><a href="#L80">addbuff</a></li>
<li><a href="#L73">fromstate</a></li>
<li><a href="#L7">lstate_c</a></li>
<li><a href="#L49">luai_makeseed</a></li>
</ul>
 <h4>Source code</h4>

  <code><ol><li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** $Id: lstate.c,v 2.127 2014/11/02 19:33:33 roberto Exp $<br/></li>
<li></span><span class="Comment">** Global State<br/></li>
<li></span><span class="Comment">** See Copyright Notice in lua.h<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li></span><br/></li>
<li><a id="L7">&#x200c;</a><span class="PreProc">#define <span class="linkable">lstate_c</span><br/></li>
<li><a id="L8">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">LUA_CORE</span><br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;lprefix.h&quot;<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;stddef.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;string.h&gt;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;lua.h&quot;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;lapi.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;ldebug.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;ldo.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;lfunc.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;lgc.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;<a href="llex.c.html#L467" title="llex.c:467">llex</a>.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;lmem.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;lstate.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;lstring.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;ltable.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;ltm.h&quot;<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="PreProc">#if !defined(<a href="#L32" title="lstate.c:32">LUAI_GCPAUSE</a>)<br/></li>
<li><a id="L32">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">LUAI_GCPAUSE</span>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">200</span><span class="PreProc">&nbsp; </span><span class="Comment">/* 200% */<br/></li>
<li></span><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#if !defined(<a href="#L36" title="lstate.c:36">LUAI_GCMUL</a>)<br/></li>
<li><a id="L36">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">LUAI_GCMUL</span>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">200</span><span class="PreProc"> </span><span class="Comment">/* GC runs 'twice the speed' of memory allocation */<br/></li>
<li></span><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><a id="L40">&#x200c;</a><span class="PreProc">#define <span class="linkable">MEMERRMSG</span>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">&quot;not enough memory&quot;<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** a macro to help the creation of a unique random seed when a state is<br/></li>
<li></span><span class="Comment">** created; the seed is used to randomize hashes.<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li></span><span class="PreProc">#if !defined(<a href="#L49" title="lstate.c:49">luai_makeseed</a>)<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;time.h&gt;<br/></li>
<li><a id="L49">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">luai_makeseed</span>()&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="llimits.h.html#L107" title="llimits.h:107">cast</a>(</span><span class="Type">unsigned</span><span class="PreProc"> </span><span class="Type">int</span><span class="PreProc">, time(</span><span class="Constant">NULL</span><span class="PreProc">))<br/></li>
<li></span><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** thread state + extra space<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L57">&#x200c;</a></span><span class="Type">typedef</span> <span class="Type">struct</span> <span class="linkable">LX</span> {<br/></li>
<li>&nbsp; <a href="llimits.h.html#L35" title="llimits.h:35">lu_byte</a> extra_[<a href="luaconf.h.html#L683" title="luaconf.h:683">LUA_EXTRASPACE</a>];<br/></li>
<li>&nbsp; <a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> l;<br/></li>
<li><a id="L60">&#x200c;</a>} <span class="linkable">LX</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** Main thread combines a thread state and the global state<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L66">&#x200c;</a></span><span class="Type">typedef</span> <span class="Type">struct</span> <span class="linkable">LG</span> {<br/></li>
<li>&nbsp; <a href="#L57" title="lstate.c:57">LX</a> l;<br/></li>
<li>&nbsp; <a href="lstate.h.html#L108" title="lstate.h:108">global_State</a> g;<br/></li>
<li><a id="L69">&#x200c;</a>} <span class="linkable">LG</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L73">&#x200c;</a><span class="PreProc">#define <span class="linkable">fromstate</span>(L)&nbsp; &nbsp; &nbsp; &nbsp; (<a href="llimits.h.html#L107" title="llimits.h:107">cast</a>(<a href="#L57" title="lstate.c:57">LX</a> *, <a href="llimits.h.html#L107" title="llimits.h:107">cast</a>(<a href="llimits.h.html#L35" title="llimits.h:35">lu_byte</a> *, (L)) - offsetof(<a href="#L57" title="lstate.c:57">LX</a>, l)))<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** Compute an initial seed as random as possible. Rely on Address Space<br/></li>
<li></span><span class="Comment">** Layout Randomization (if present) to increase randomness..<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L80">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">addbuff</span>(b,p,e) \<br/></li>
<li></span><span class="PreProc">&nbsp; { </span><span class="Type">size_t</span><span class="PreProc"> t = <a href="llimits.h.html#L107" title="llimits.h:107">cast</a>(</span><span class="Type">size_t</span><span class="PreProc">, e); \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; memcpy(buff + p, &amp;t, </span><span class="Statement">sizeof</span><span class="PreProc">(t)); p += </span><span class="Statement">sizeof</span><span class="PreProc">(t); }<br/></li>
<li></span><br/></li>
<li><a id="L84">&#x200c;</a><span class="Type">static</span> <span class="Type">unsigned</span> <span class="Type">int</span> <span class="linkable">makeseed</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <span class="Type">char</span> buff[<span class="Constant">4</span> * <span class="Statement">sizeof</span>(<span class="Type">size_t</span>)];<br/></li>
<li>&nbsp; <span class="Type">unsigned</span> <span class="Type">int</span> h = <a href="#L49" title="lstate.c:49">luai_makeseed</a>();<br/></li>
<li>&nbsp; <span class="Type">int</span> p = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; <a href="#L80" title="lstate.c:80">addbuff</a>(buff, p, L);&nbsp; <span class="Comment">/* heap variable */<br/></li>
<li></span>&nbsp; <a href="#L80" title="lstate.c:80">addbuff</a>(buff, p, &amp;h);&nbsp; <span class="Comment">/* local variable */<br/></li>
<li></span>&nbsp; <a href="#L80" title="lstate.c:80">addbuff</a>(buff, p, <a href="lobject.h.html#L516" title="lobject.h:516">luaO_nilobject</a>);&nbsp; <span class="Comment">/* global variable */<br/></li>
<li></span>&nbsp; <a href="#L80" title="lstate.c:80">addbuff</a>(buff, p, &amp;<a href="#L293" title="lstate.c:293">lua_newstate</a>);&nbsp; <span class="Comment">/* public function */<br/></li>
<li></span>&nbsp; <a href="lualib.h.html#L54" title="lualib.h:54">lua_assert</a>(p == <span class="Statement">sizeof</span>(buff));<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="lstring.c.html#L47" title="lstring.c:47">luaS_hash</a>(buff, p, h);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** set GCdebt to a new value keeping the value (totalbytes + GCdebt)<br/></li>
<li></span><span class="Comment">** invariant<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L101">&#x200c;</a></span><span class="Type">void</span> <span class="linkable">luaE_setdebt</span> (<a href="lstate.h.html#L108" title="lstate.h:108">global_State</a> *g, <a href="llimits.h.html#L24" title="llimits.h:24">l_mem</a> debt) {<br/></li>
<li>&nbsp; g-&gt;totalbytes -= (debt - g-&gt;GCdebt);<br/></li>
<li>&nbsp; g-&gt;GCdebt = debt;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L107">&#x200c;</a><a href="lstate.h.html#L65" title="lstate.h:65">CallInfo</a> *<span class="linkable">luaE_extendCI</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <a href="lstate.h.html#L65" title="lstate.h:65">CallInfo</a> *ci = <a href="lmem.h.html#L46" title="lmem.h:46">luaM_new</a>(L, <a href="lstate.h.html#L65" title="lstate.h:65">CallInfo</a>);<br/></li>
<li>&nbsp; <a href="lualib.h.html#L54" title="lualib.h:54">lua_assert</a>(L-&gt;ci-&gt;<a href="llex.c.html#L31" title="llex.c:31">next</a> == <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; L-&gt;ci-&gt;<a href="llex.c.html#L31" title="llex.c:31">next</a> = ci;<br/></li>
<li>&nbsp; ci-&gt;previous = L-&gt;ci;<br/></li>
<li>&nbsp; ci-&gt;<a href="llex.c.html#L31" title="llex.c:31">next</a> = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; <span class="Statement">return</span> ci;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** free all <a href="lstate.h.html#L65" title="lstate.h:65">CallInfo</a> structures not in use by a thread<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L120">&#x200c;</a></span><span class="Type">void</span> <span class="linkable">luaE_freeCI</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <a href="lstate.h.html#L65" title="lstate.h:65">CallInfo</a> *ci = L-&gt;ci;<br/></li>
<li>&nbsp; <a href="lstate.h.html#L65" title="lstate.h:65">CallInfo</a> *<a href="llex.c.html#L31" title="llex.c:31">next</a> = ci-&gt;<a href="llex.c.html#L31" title="llex.c:31">next</a>;<br/></li>
<li>&nbsp; ci-&gt;<a href="llex.c.html#L31" title="llex.c:31">next</a> = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; <span class="Statement">while</span> ((ci = <a href="llex.c.html#L31" title="llex.c:31">next</a>) != <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; <a href="llex.c.html#L31" title="llex.c:31">next</a> = ci-&gt;<a href="llex.c.html#L31" title="llex.c:31">next</a>;<br/></li>
<li>&nbsp; &nbsp; <a href="lmem.h.html#L42" title="lmem.h:42">luaM_free</a>(L, ci);<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** free half of the <a href="lstate.h.html#L65" title="lstate.h:65">CallInfo</a> structures not in use by a thread<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L134">&#x200c;</a></span><span class="Type">void</span> <span class="linkable">luaE_shrinkCI</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <a href="lstate.h.html#L65" title="lstate.h:65">CallInfo</a> *ci = L-&gt;ci;<br/></li>
<li>&nbsp; <span class="Statement">while</span> (ci-&gt;<a href="llex.c.html#L31" title="llex.c:31">next</a> != <span class="Constant">NULL</span>) {&nbsp; <span class="Comment">/* while there is '<a href="llex.c.html#L31" title="llex.c:31">next</a>' */<br/></li>
<li></span>&nbsp; &nbsp; <a href="lstate.h.html#L65" title="lstate.h:65">CallInfo</a> *next2 = ci-&gt;<a href="llex.c.html#L31" title="llex.c:31">next</a>-&gt;<a href="llex.c.html#L31" title="llex.c:31">next</a>;&nbsp; <span class="Comment">/* <a href="llex.c.html#L31" title="llex.c:31">next</a>'s <a href="llex.c.html#L31" title="llex.c:31">next</a> */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (next2 == <span class="Constant">NULL</span>) <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; <a href="lmem.h.html#L42" title="lmem.h:42">luaM_free</a>(L, ci-&gt;<a href="llex.c.html#L31" title="llex.c:31">next</a>);&nbsp; <span class="Comment">/* remove <a href="llex.c.html#L31" title="llex.c:31">next</a> */<br/></li>
<li></span>&nbsp; &nbsp; ci-&gt;<a href="llex.c.html#L31" title="llex.c:31">next</a> = next2;&nbsp; <span class="Comment">/* remove '<a href="llex.c.html#L31" title="llex.c:31">next</a>' from the list */<br/></li>
<li></span>&nbsp; &nbsp; next2-&gt;previous = ci;<br/></li>
<li>&nbsp; &nbsp; ci = next2;<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L147">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">stack_init</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L1, <a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <span class="Type">int</span> i; <a href="lstate.h.html#L65" title="lstate.h:65">CallInfo</a> *ci;<br/></li>
<li>&nbsp; <span class="Comment">/* initialize stack array */<br/></li>
<li></span>&nbsp; L1-&gt;stack = <a href="lmem.h.html#L47" title="lmem.h:47">luaM_newvector</a>(L, <a href="lstate.h.html#L41" title="lstate.h:41">BASIC_STACK_SIZE</a>, <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a>);<br/></li>
<li>&nbsp; L1-&gt;stacksize = <a href="lstate.h.html#L41" title="lstate.h:41">BASIC_STACK_SIZE</a>;<br/></li>
<li>&nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; <a href="lstate.h.html#L41" title="lstate.h:41">BASIC_STACK_SIZE</a>; i++)<br/></li>
<li>&nbsp; &nbsp; <a href="lobject.h.html#L196" title="lobject.h:196">setnilvalue</a>(L1-&gt;stack + i);&nbsp; <span class="Comment">/* erase new stack */<br/></li>
<li></span>&nbsp; L1-&gt;top = L1-&gt;stack;<br/></li>
<li>&nbsp; L1-&gt;stack_last = L1-&gt;stack + L1-&gt;stacksize - <a href="lstate.h.html#L38" title="lstate.h:38">EXTRA_STACK</a>;<br/></li>
<li>&nbsp; <span class="Comment">/* initialize first ci */<br/></li>
<li></span>&nbsp; ci = &amp;L1-&gt;base_ci;<br/></li>
<li>&nbsp; ci-&gt;<a href="llex.c.html#L31" title="llex.c:31">next</a> = ci-&gt;previous = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; ci-&gt;callstatus = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; ci-&gt;func = L1-&gt;top;<br/></li>
<li>&nbsp; <a href="lobject.h.html#L196" title="lobject.h:196">setnilvalue</a>(L1-&gt;top++);&nbsp; <span class="Comment">/* 'function' entry for this 'ci' */<br/></li>
<li></span>&nbsp; ci-&gt;top = L1-&gt;top + <a href="lua.h.html#L77" title="lua.h:77">LUA_MINSTACK</a>;<br/></li>
<li>&nbsp; L1-&gt;ci = ci;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L167">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">freestack</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <span class="Statement">if</span> (L-&gt;stack == <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span>;&nbsp; <span class="Comment">/* stack not completely built yet */<br/></li>
<li></span>&nbsp; L-&gt;ci = &amp;L-&gt;base_ci;&nbsp; <span class="Comment">/* free the entire 'ci' list */<br/></li>
<li></span>&nbsp; <a href="#L120" title="lstate.c:120">luaE_freeCI</a>(L);<br/></li>
<li>&nbsp; <a href="lmem.h.html#L43" title="lmem.h:43">luaM_freearray</a>(L, L-&gt;stack, L-&gt;stacksize);&nbsp; <span class="Comment">/* free stack array */<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** Create registry table and its predefined values<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L179">&#x200c;</a></span><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">init_registry</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <a href="lstate.h.html#L108" title="lstate.h:108">global_State</a> *g) {<br/></li>
<li>&nbsp; <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> temp;<br/></li>
<li>&nbsp; <span class="Comment">/* create registry */<br/></li>
<li></span>&nbsp; <a href="lobject.h.html#L488" title="lobject.h:488">Table</a> *registry = <a href="ltable.c.html#L403" title="ltable.c:403">luaH_new</a>(L);<br/></li>
<li>&nbsp; <a href="lobject.h.html#L236" title="lobject.h:236">sethvalue</a>(L, &amp;g-&gt;l_registry, registry);<br/></li>
<li>&nbsp; <a href="ltable.c.html#L335" title="ltable.c:335">luaH_resize</a>(L, registry, <a href="lua.h.html#L83" title="lua.h:83">LUA_RIDX_LAST</a>, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; <span class="Comment">/* registry[<a href="lua.h.html#L81" title="lua.h:81">LUA_RIDX_MAINTHREAD</a>] = L */<br/></li>
<li></span>&nbsp; <a href="lobject.h.html#L221" title="lobject.h:221">setthvalue</a>(L, &amp;temp, L);&nbsp; <span class="Comment">/* temp = L */<br/></li>
<li></span>&nbsp; <a href="ltable.c.html#L580" title="ltable.c:580">luaH_setint</a>(L, registry, <a href="lua.h.html#L81" title="lua.h:81">LUA_RIDX_MAINTHREAD</a>, &amp;temp);<br/></li>
<li>&nbsp; <span class="Comment">/* registry[<a href="lua.h.html#L82" title="lua.h:82">LUA_RIDX_GLOBALS</a>] = table of globals */<br/></li>
<li></span>&nbsp; <a href="lobject.h.html#L236" title="lobject.h:236">sethvalue</a>(L, &amp;temp, <a href="ltable.c.html#L403" title="ltable.c:403">luaH_new</a>(L));&nbsp; <span class="Comment">/* temp = new table (global table) */<br/></li>
<li></span>&nbsp; <a href="ltable.c.html#L580" title="ltable.c:580">luaH_setint</a>(L, registry, <a href="lua.h.html#L82" title="lua.h:82">LUA_RIDX_GLOBALS</a>, &amp;temp);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** open parts of the state that may cause memory-allocation errors.<br/></li>
<li></span><span class="Comment">** ('g-&gt;version' != NULL flags that the state was completely build)<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L198">&#x200c;</a></span><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">f_luaopen</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">void</span> *ud) {<br/></li>
<li>&nbsp; <a href="lstate.h.html#L108" title="lstate.h:108">global_State</a> *g = <a href="lstate.h.html#L175" title="lstate.h:175">G</a>(L);<br/></li>
<li>&nbsp; <a href="llimits.h.html#L103" title="llimits.h:103">UNUSED</a>(ud);<br/></li>
<li>&nbsp; <a href="#L147" title="lstate.c:147">stack_init</a>(L, L);&nbsp; <span class="Comment">/* init stack */<br/></li>
<li></span>&nbsp; <a href="#L179" title="lstate.c:179">init_registry</a>(L, g);<br/></li>
<li>&nbsp; <a href="lstring.c.html#L60" title="lstring.c:60">luaS_resize</a>(L, <a href="llimits.h.html#L174" title="llimits.h:174">MINSTRTABSIZE</a>);&nbsp; <span class="Comment">/* initial size of string table */<br/></li>
<li></span>&nbsp; <a href="ltm.c.html#L37" title="ltm.c:37">luaT_init</a>(L);<br/></li>
<li>&nbsp; <a href="llex.c.html#L69" title="llex.c:69">luaX_init</a>(L);<br/></li>
<li>&nbsp; <span class="Comment">/* pre-create memory-<a href="lundump.c.html#L40" title="lundump.c:40">error</a> message */<br/></li>
<li></span>&nbsp; g-&gt;memerrmsg = <a href="lstring.h.html#L21" title="lstring.h:21">luaS_newliteral</a>(L, <a href="#L40" title="lstate.c:40">MEMERRMSG</a>);<br/></li>
<li>&nbsp; <a href="lgc.c.html#L184" title="lgc.c:184">luaC_fix</a>(L, <a href="lstate.h.html#L208" title="lstate.h:208">obj2gco</a>(g-&gt;memerrmsg));&nbsp; <span class="Comment">/* it should never be collected */<br/></li>
<li></span>&nbsp; g-&gt;gcrunning = <span class="Constant">1</span>;&nbsp; <span class="Comment">/* allow gc */<br/></li>
<li></span>&nbsp; g-&gt;version = <a href="lapi.c.html#L143" title="lapi.c:143">lua_version</a>(<span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; <a href="llimits.h.html#L200" title="llimits.h:200">luai_userstateopen</a>(L);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** preinitialize a thread with consistent values without allocating<br/></li>
<li></span><span class="Comment">** any memory (to avoid errors)<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L219">&#x200c;</a></span><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">preinit_thread</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <a href="lstate.h.html#L108" title="lstate.h:108">global_State</a> *g) {<br/></li>
<li>&nbsp; <a href="lstate.h.html#L175" title="lstate.h:175">G</a>(L) = g;<br/></li>
<li>&nbsp; L-&gt;stack = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; L-&gt;ci = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; L-&gt;stacksize = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; L-&gt;twups = L;&nbsp; <span class="Comment">/* thread has no upvalues */<br/></li>
<li></span>&nbsp; L-&gt;errorJmp = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; L-&gt;nCcalls = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; L-&gt;hook = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; L-&gt;hookmask = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; L-&gt;basehookcount = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; L-&gt;allowhook = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; <a href="ldebug.h.html#L18" title="ldebug.h:18">resethookcount</a>(L);<br/></li>
<li>&nbsp; L-&gt;openupval = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; L-&gt;nny = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; L-&gt;status = <a href="lua.h.html#L45" title="lua.h:45">LUA_OK</a>;<br/></li>
<li>&nbsp; L-&gt;errfunc = <span class="Constant">0</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L239">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">close_state</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <a href="lstate.h.html#L108" title="lstate.h:108">global_State</a> *g = <a href="lstate.h.html#L175" title="lstate.h:175">G</a>(L);<br/></li>
<li>&nbsp; <a href="lfunc.c.html#L83" title="lfunc.c:83">luaF_close</a>(L, L-&gt;stack);&nbsp; <span class="Comment">/* close all upvalues for this thread */<br/></li>
<li></span>&nbsp; <a href="lgc.c.html#L950" title="lgc.c:950">luaC_freeallobjects</a>(L);&nbsp; <span class="Comment">/* collect all objects */<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (g-&gt;version)&nbsp; <span class="Comment">/* closing a fully built state? */<br/></li>
<li></span>&nbsp; &nbsp; <a href="llimits.h.html#L204" title="llimits.h:204">luai_userstateclose</a>(L);<br/></li>
<li>&nbsp; <a href="lmem.h.html#L43" title="lmem.h:43">luaM_freearray</a>(L, <a href="lstate.h.html#L175" title="lstate.h:175">G</a>(L)-&gt;strt.hash, <a href="lstate.h.html#L175" title="lstate.h:175">G</a>(L)-&gt;strt.size);<br/></li>
<li>&nbsp; <a href="lzio.h.html#L44" title="lzio.h:44">luaZ_freebuffer</a>(L, &amp;g-&gt;buff);<br/></li>
<li>&nbsp; <a href="#L167" title="lstate.c:167">freestack</a>(L);<br/></li>
<li>&nbsp; <a href="lualib.h.html#L54" title="lualib.h:54">lua_assert</a>(<a href="lstate.h.html#L213" title="lstate.h:213">gettotalbytes</a>(g) == <span class="Statement">sizeof</span>(<a href="#L66" title="lstate.c:66">LG</a>));<br/></li>
<li>&nbsp; (*g-&gt;frealloc)(g-&gt;ud, <a href="#L73" title="lstate.c:73">fromstate</a>(L), <span class="Statement">sizeof</span>(<a href="#L66" title="lstate.c:66">LG</a>), <span class="Constant">0</span>);&nbsp; <span class="Comment">/* free <a href="lua.c.html#L595" title="lua.c:595">main</a> <a href="lparser.c.html#L1087" title="lparser.c:1087">block</a> */<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L253">&#x200c;</a><a href="luaconf.h.html#L222" title="luaconf.h:222">LUA_API</a> <a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *<span class="linkable">lua_newthread</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <a href="lstate.h.html#L108" title="lstate.h:108">global_State</a> *g = <a href="lstate.h.html#L175" title="lstate.h:175">G</a>(L);<br/></li>
<li>&nbsp; <a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L1;<br/></li>
<li>&nbsp; <a href="llimits.h.html#L185" title="llimits.h:185">lua_lock</a>(L);<br/></li>
<li>&nbsp; <a href="lgc.h.html#L106" title="lgc.h:106">luaC_checkGC</a>(L);<br/></li>
<li>&nbsp; <span class="Comment">/* create new thread */<br/></li>
<li></span>&nbsp; L1 = &amp;<a href="llimits.h.html#L107" title="llimits.h:107">cast</a>(<a href="#L57" title="lstate.c:57">LX</a> *, <a href="lmem.h.html#L50" title="lmem.h:50">luaM_newobject</a>(L, <a href="lua.h.html#L70" title="lua.h:70">LUA_TTHREAD</a>, <span class="Statement">sizeof</span>(<a href="#L57" title="lstate.c:57">LX</a>)))-&gt;l;<br/></li>
<li>&nbsp; L1-&gt;marked = <a href="lgc.h.html#L101" title="lgc.h:101">luaC_white</a>(g);<br/></li>
<li>&nbsp; L1-&gt;tt = <a href="lua.h.html#L70" title="lua.h:70">LUA_TTHREAD</a>;<br/></li>
<li>&nbsp; <span class="Comment">/* link it on list 'allgc' */<br/></li>
<li></span>&nbsp; L1-&gt;<a href="llex.c.html#L31" title="llex.c:31">next</a> = g-&gt;allgc;<br/></li>
<li>&nbsp; g-&gt;allgc = <a href="lstate.h.html#L208" title="lstate.h:208">obj2gco</a>(L1);<br/></li>
<li>&nbsp; <span class="Comment">/* anchor it on L stack */<br/></li>
<li></span>&nbsp; <a href="lobject.h.html#L221" title="lobject.h:221">setthvalue</a>(L, L-&gt;top, L1);<br/></li>
<li>&nbsp; <a href="lapi.h.html#L14" title="lapi.h:14">api_incr_top</a>(L);<br/></li>
<li>&nbsp; <a href="#L219" title="lstate.c:219">preinit_thread</a>(L1, g);<br/></li>
<li>&nbsp; L1-&gt;hookmask = L-&gt;hookmask;<br/></li>
<li>&nbsp; L1-&gt;basehookcount = L-&gt;basehookcount;<br/></li>
<li>&nbsp; L1-&gt;hook = L-&gt;hook;<br/></li>
<li>&nbsp; <a href="ldebug.h.html#L18" title="ldebug.h:18">resethookcount</a>(L1);<br/></li>
<li>&nbsp; <span class="Comment">/* initialize L1 extra space */<br/></li>
<li></span>&nbsp; memcpy(<a href="lua.h.html#L337" title="lua.h:337">lua_getextraspace</a>(L1), <a href="lua.h.html#L337" title="lua.h:337">lua_getextraspace</a>(g-&gt;mainthread),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="luaconf.h.html#L683" title="luaconf.h:683">LUA_EXTRASPACE</a>);<br/></li>
<li>&nbsp; <a href="llimits.h.html#L208" title="llimits.h:208">luai_userstatethread</a>(L, L1);<br/></li>
<li>&nbsp; <a href="#L147" title="lstate.c:147">stack_init</a>(L1, L);&nbsp; <span class="Comment">/* init stack */<br/></li>
<li></span>&nbsp; <a href="llimits.h.html#L186" title="llimits.h:186">lua_unlock</a>(L);<br/></li>
<li>&nbsp; <span class="Statement">return</span> L1;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L283">&#x200c;</a><span class="Type">void</span> <span class="linkable">luaE_freethread</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L1) {<br/></li>
<li>&nbsp; <a href="#L57" title="lstate.c:57">LX</a> *l = <a href="#L73" title="lstate.c:73">fromstate</a>(L1);<br/></li>
<li>&nbsp; <a href="lfunc.c.html#L83" title="lfunc.c:83">luaF_close</a>(L1, L1-&gt;stack);&nbsp; <span class="Comment">/* close all upvalues for this thread */<br/></li>
<li></span>&nbsp; <a href="lualib.h.html#L54" title="lualib.h:54">lua_assert</a>(L1-&gt;openupval == <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; <a href="llimits.h.html#L212" title="llimits.h:212">luai_userstatefree</a>(L, L1);<br/></li>
<li>&nbsp; <a href="#L167" title="lstate.c:167">freestack</a>(L1);<br/></li>
<li>&nbsp; <a href="lmem.h.html#L42" title="lmem.h:42">luaM_free</a>(L, l);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L293">&#x200c;</a><a href="luaconf.h.html#L222" title="luaconf.h:222">LUA_API</a> <a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *<span class="linkable">lua_newstate</span> (<a href="lua.h.html#L122" title="lua.h:122">lua_Alloc</a> f, <span class="Type">void</span> *ud) {<br/></li>
<li>&nbsp; <span class="Type">int</span> i;<br/></li>
<li>&nbsp; <a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L;<br/></li>
<li>&nbsp; <a href="lstate.h.html#L108" title="lstate.h:108">global_State</a> *g;<br/></li>
<li>&nbsp; <a href="#L66" title="lstate.c:66">LG</a> *l = <a href="llimits.h.html#L107" title="llimits.h:107">cast</a>(<a href="#L66" title="lstate.c:66">LG</a> *, (*f)(ud, <span class="Constant">NULL</span>, <a href="lua.h.html#L70" title="lua.h:70">LUA_TTHREAD</a>, <span class="Statement">sizeof</span>(<a href="#L66" title="lstate.c:66">LG</a>)));<br/></li>
<li>&nbsp; <span class="Statement">if</span> (l == <span class="Constant">NULL</span>) <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; L = &amp;l-&gt;l.l;<br/></li>
<li>&nbsp; g = &amp;l-&gt;g;<br/></li>
<li>&nbsp; L-&gt;<a href="llex.c.html#L31" title="llex.c:31">next</a> = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; L-&gt;tt = <a href="lua.h.html#L70" title="lua.h:70">LUA_TTHREAD</a>;<br/></li>
<li>&nbsp; g-&gt;currentwhite = <a href="lgc.h.html#L70" title="lgc.h:70">bitmask</a>(<a href="lgc.h.html#L78" title="lgc.h:78">WHITE0BIT</a>);<br/></li>
<li>&nbsp; L-&gt;marked = <a href="lgc.h.html#L101" title="lgc.h:101">luaC_white</a>(g);<br/></li>
<li>&nbsp; <a href="#L219" title="lstate.c:219">preinit_thread</a>(L, g);<br/></li>
<li>&nbsp; g-&gt;frealloc = f;<br/></li>
<li>&nbsp; g-&gt;ud = ud;<br/></li>
<li>&nbsp; g-&gt;mainthread = L;<br/></li>
<li>&nbsp; g-&gt;seed = <a href="#L84" title="lstate.c:84">makeseed</a>(L);<br/></li>
<li>&nbsp; g-&gt;gcrunning = <span class="Constant">0</span>;&nbsp; <span class="Comment">/* no GC while building state */<br/></li>
<li></span>&nbsp; g-&gt;GCestimate = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; g-&gt;strt.size = g-&gt;strt.nuse = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; g-&gt;strt.hash = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; <a href="lobject.h.html#L196" title="lobject.h:196">setnilvalue</a>(&amp;g-&gt;l_registry);<br/></li>
<li>&nbsp; <a href="lzio.h.html#L29" title="lzio.h:29">luaZ_initbuffer</a>(L, &amp;g-&gt;buff);<br/></li>
<li>&nbsp; g-&gt;<a href="lauxlib.c.html#L948" title="lauxlib.c:948">panic</a> = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; g-&gt;version = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; g-&gt;gcstate = <a href="lgc.h.html#L46" title="lgc.h:46">GCSpause</a>;<br/></li>
<li>&nbsp; g-&gt;gckind = <a href="lstate.h.html#L45" title="lstate.h:45">KGC_NORMAL</a>;<br/></li>
<li>&nbsp; g-&gt;allgc = g-&gt;finobj = g-&gt;tobefnz = g-&gt;fixedgc = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; g-&gt;sweepgc = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; g-&gt;gray = g-&gt;grayagain = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; g-&gt;weak = g-&gt;ephemeron = g-&gt;allweak = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; g-&gt;twups = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; g-&gt;totalbytes = <span class="Statement">sizeof</span>(<a href="#L66" title="lstate.c:66">LG</a>);<br/></li>
<li>&nbsp; g-&gt;GCdebt = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; g-&gt;gcfinnum = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; g-&gt;gcpause = <a href="#L32" title="lstate.c:32">LUAI_GCPAUSE</a>;<br/></li>
<li>&nbsp; g-&gt;gcstepmul = <a href="#L36" title="lstate.c:36">LUAI_GCMUL</a>;<br/></li>
<li>&nbsp; <span class="Statement">for</span> (i=<span class="Constant">0</span>; i &lt; <a href="lua.h.html#L72" title="lua.h:72">LUA_NUMTAGS</a>; i++) g-&gt;mt[i] = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="ldo.c.html#L136" title="ldo.c:136">luaD_rawrunprotected</a>(L, <a href="#L198" title="lstate.c:198">f_luaopen</a>, <span class="Constant">NULL</span>) != <a href="lua.h.html#L45" title="lua.h:45">LUA_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* memory allocation <a href="lundump.c.html#L40" title="lundump.c:40">error</a>: free partial state */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L239" title="lstate.c:239">close_state</a>(L);<br/></li>
<li>&nbsp; &nbsp; L = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> L;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L340">&#x200c;</a><a href="luaconf.h.html#L222" title="luaconf.h:222">LUA_API</a> <span class="Type">void</span> <span class="linkable">lua_close</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; L = <a href="lstate.h.html#L175" title="lstate.h:175">G</a>(L)-&gt;mainthread;&nbsp; <span class="Comment">/* only the <a href="lua.c.html#L595" title="lua.c:595">main</a> thread can be closed */<br/></li>
<li></span>&nbsp; <a href="llimits.h.html#L185" title="llimits.h:185">lua_lock</a>(L);<br/></li>
<li>&nbsp; <a href="#L239" title="lstate.c:239">close_state</a>(L);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
</ol></code>
 </body>
</html>
