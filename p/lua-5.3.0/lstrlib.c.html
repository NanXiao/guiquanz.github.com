<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>lstrlib.c - src</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

code {
    font-family: consolas, monospace;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
  <h3>lstrlib.c - src</h3>
   <a href="../index.html"> Table of Contents </a>
 <h4>Global variables defined</h4>
 <ul>
<li><a href="#L976">nativeendian</a></li>
<li><a href="#L1388">strlib</a></li>
</ul>
 <h4>Data types defined</h4>
 <ul>
<li><a href="#L991">Ftypes</a></li>
<li><a href="#L996">Ftypes</a></li>
<li><a href="#L1002">Header</a></li>
<li><a href="#L1006">Header</a></li>
<li><a href="#L1012">KOption</a></li>
<li><a href="#L1022">KOption</a></li>
<li><a href="#L209">MatchState</a></li>
<li><a href="#L220">MatchState</a></li>
<li><a href="#L980">cD</a></li>
</ul>
 <h4>Functions defined</h4>
 <ul>
<li><a href="#L687">add_s</a></li>
<li><a href="#L715">add_value</a></li>
<li><a href="#L862">addlenmod</a></li>
<li><a href="#L813">addquoted</a></li>
<li><a href="#L245">capture_to_close</a></li>
<li><a href="#L237">check_capture</a></li>
<li><a href="#L253">classend</a></li>
<li><a href="#L1165">copywithendian</a></li>
<li><a href="#L1410">createmetatable</a></li>
<li><a href="#L1029">digit</a></li>
<li><a href="#L398">end_capture</a></li>
<li><a href="#L1117">getdetails</a></li>
<li><a href="#L1031">getnum</a></li>
<li><a href="#L1048">getnumlimit</a></li>
<li><a href="#L1070">getoption</a></li>
<li><a href="#L677">gmatch</a></li>
<li><a href="#L648">gmatch_aux</a></li>
<li><a href="#L1060">initheader</a></li>
<li><a href="#L523">lmemfind</a></li>
<li><a href="#L1425">luaopen_string</a></li>
<li><a href="#L420">match</a></li>
<li><a href="#L409">match_capture</a></li>
<li><a href="#L277">match_class</a></li>
<li><a href="#L336">matchbalance</a></li>
<li><a href="#L297">matchbracketclass</a></li>
<li><a href="#L356">max_expand</a></li>
<li><a href="#L371">min_expand</a></li>
<li><a href="#L575">nospecials</a></li>
<li><a href="#L1144">packint</a></li>
<li><a href="#L58">posrelat</a></li>
<li><a href="#L564">push_captures</a></li>
<li><a href="#L545">push_onecapture</a></li>
<li><a href="#L837">scanformat</a></li>
<li><a href="#L320">singlematch</a></li>
<li><a href="#L384">start_capture</a></li>
<li><a href="#L143">str_byte</a></li>
<li><a href="#L162">str_char</a></li>
<li><a href="#L184">str_dump</a></li>
<li><a href="#L638">str_find</a></li>
<li><a href="#L586">str_find_aux</a></li>
<li><a href="#L872">str_format</a></li>
<li><a href="#L746">str_gsub</a></li>
<li><a href="#L49">str_len</a></li>
<li><a href="#L91">str_lower</a></li>
<li><a href="#L643">str_match</a></li>
<li><a href="#L1179">str_pack</a></li>
<li><a href="#L1263">str_packsize</a></li>
<li><a href="#L117">str_rep</a></li>
<li><a href="#L79">str_reverse</a></li>
<li><a href="#L65">str_sub</a></li>
<li><a href="#L1322">str_unpack</a></li>
<li><a href="#L104">str_upper</a></li>
<li><a href="#L1296">unpackint</a></li>
<li><a href="#L177">writer</a></li>
</ul>
 <h4>Macros defined</h4>
 <ul>
<li><a href="#L206">CAP_POSITION</a></li>
<li><a href="#L205">CAP_UNFINISHED</a></li>
<li><a href="#L804">FLAGS</a></li>
<li><a href="#L8">LUA_LIB</a></li>
<li><a href="#L31">LUA_MAXCAPTURES</a></li>
<li><a href="#L956">LUA_PACKPADBYTE</a></li>
<li><a href="#L233">L_ESC</a></li>
<li><a href="#L985">MAXALIGN</a></li>
<li><a href="#L229">MAXCCALLS</a></li>
<li><a href="#L960">MAXINTSIZE</a></li>
<li><a href="#L43">MAXSIZE</a></li>
<li><a href="#L810">MAX_FORMAT</a></li>
<li><a href="#L801">MAX_ITEM</a></li>
<li><a href="#L966">MC</a></li>
<li><a href="#L963">NB</a></li>
<li><a href="#L234">SPECIALS</a></li>
<li><a href="#L969">SZINT</a></li>
<li><a href="#L7">lstrlib_c</a></li>
<li><a href="#L36">uchar</a></li>
</ul>
 <h4>Source code</h4>

  <code><ol><li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** $Id: lstrlib.c,v 1.221 2014/12/11 14:03:07 roberto Exp $<br/></li>
<li></span><span class="Comment">** Standard library for string operations and pattern-matching<br/></li>
<li></span><span class="Comment">** See Copyright Notice in lua.h<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li></span><br/></li>
<li><a id="L7">&#x200c;</a><span class="PreProc">#define <span class="linkable">lstrlib_c</span><br/></li>
<li><a id="L8">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">LUA_LIB</span><br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;lprefix.h&quot;<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;ctype.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;limits.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;stddef.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;stdio.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;stdlib.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;string.h&gt;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;lua.h&quot;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;lauxlib.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;lualib.h&quot;<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** maximum number of captures that a pattern can do during<br/></li>
<li></span><span class="Comment">** pattern-matching. This limit is arbitrary.<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li></span><span class="PreProc">#if !defined(<a href="#L31" title="lstrlib.c:31">LUA_MAXCAPTURES</a>)<br/></li>
<li><a id="L31">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">LUA_MAXCAPTURES</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">32<br/></li>
<li></span><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Comment">/* macro to 'unsign' a character */<br/></li>
<li><a id="L36">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">uchar</span>(c)&nbsp; &nbsp; &nbsp; &nbsp; ((</span><span class="Type">unsigned</span><span class="PreProc"> </span><span class="Type">char</span><span class="PreProc">)(c))<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** Some sizes are better limited to fit in 'int', but must also fit in<br/></li>
<li></span><span class="Comment">** 'size_t'. (We assume that '<a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a>' <a href="luac.c.html#L44" title="luac.c:44">cannot</a> be smaller than 'int'.)<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L43">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">MAXSIZE</span>&nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; &nbsp; &nbsp; (</span><span class="Statement">sizeof</span><span class="PreProc">(</span><span class="Type">size_t</span><span class="PreProc">) &lt; </span><span class="Statement">sizeof</span><span class="PreProc">(</span><span class="Type">int</span><span class="PreProc">) ? (~(</span><span class="Type">size_t</span><span class="PreProc">)</span><span class="Constant">0</span><span class="PreProc">) : (</span><span class="Type">size_t</span><span class="PreProc">)(</span><span class="Constant">INT_MAX</span><span class="PreProc">))<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L49">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">str_len</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <span class="Type">size_t</span> l;<br/></li>
<li>&nbsp; <a href="lauxlib.c.html#L374" title="lauxlib.c:374">luaL_checklstring</a>(L, <span class="Constant">1</span>, &amp;l);<br/></li>
<li>&nbsp; <a href="lapi.c.html#L464" title="lapi.c:464">lua_pushinteger</a>(L, (<a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a>)l);<br/></li>
<li>&nbsp; <span class="Statement">return</span> <span class="Constant">1</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/* translate a relative string position: negative means back from end */<br/></li>
<li><a id="L58">&#x200c;</a></span><span class="Type">static</span> <a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a> <span class="linkable">posrelat</span> (<a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a> pos, <span class="Type">size_t</span> len) {<br/></li>
<li>&nbsp; <span class="Statement">if</span> (pos &gt;= <span class="Constant">0</span>) <span class="Statement">return</span> pos;<br/></li>
<li>&nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (<span class="Constant">0u</span> - (<span class="Type">size_t</span>)pos &gt; len) <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>&nbsp; <span class="Statement">else</span> <span class="Statement">return</span> (<a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a>)len + pos + <span class="Constant">1</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L65">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">str_sub</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <span class="Type">size_t</span> l;<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">char</span> *s = <a href="lauxlib.c.html#L374" title="lauxlib.c:374">luaL_checklstring</a>(L, <span class="Constant">1</span>, &amp;l);<br/></li>
<li>&nbsp; <a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a> start = <a href="#L58" title="lstrlib.c:58">posrelat</a>(<a href="lauxlib.c.html#L414" title="lauxlib.c:414">luaL_checkinteger</a>(L, <span class="Constant">2</span>), l);<br/></li>
<li>&nbsp; <a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a> end = <a href="#L58" title="lstrlib.c:58">posrelat</a>(<a href="lauxlib.c.html#L424" title="lauxlib.c:424">luaL_optinteger</a>(L, <span class="Constant">3</span>, -<span class="Constant">1</span>), l);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (start &lt; <span class="Constant">1</span>) start = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (end &gt; (<a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a>)l) end = l;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (start &lt;= end)<br/></li>
<li>&nbsp; &nbsp; <a href="lapi.c.html#L472" title="lapi.c:472">lua_pushlstring</a>(L, s + start - <span class="Constant">1</span>, (<span class="Type">size_t</span>)(end - start + <span class="Constant">1</span>));<br/></li>
<li>&nbsp; <span class="Statement">else</span> <a href="lua.h.html#L359" title="lua.h:359">lua_pushliteral</a>(L, <span class="Constant">&quot;&quot;</span>);<br/></li>
<li>&nbsp; <span class="Statement">return</span> <span class="Constant">1</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L79">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">str_reverse</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <span class="Type">size_t</span> l, i;<br/></li>
<li>&nbsp; <a href="lauxlib.h.html#L140" title="lauxlib.h:140">luaL_Buffer</a> b;<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">char</span> *s = <a href="lauxlib.c.html#L374" title="lauxlib.c:374">luaL_checklstring</a>(L, <span class="Constant">1</span>, &amp;l);<br/></li>
<li>&nbsp; <span class="Type">char</span> *p = <a href="lauxlib.c.html#L515" title="lauxlib.c:515">luaL_buffinitsize</a>(L, &amp;b, l);<br/></li>
<li>&nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; l; i++)<br/></li>
<li>&nbsp; &nbsp; p[i] = s[l - i - <span class="Constant">1</span>];<br/></li>
<li>&nbsp; <a href="lauxlib.c.html#L490" title="lauxlib.c:490">luaL_pushresultsize</a>(&amp;b, l);<br/></li>
<li>&nbsp; <span class="Statement">return</span> <span class="Constant">1</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L91">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">str_lower</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <span class="Type">size_t</span> l;<br/></li>
<li>&nbsp; <span class="Type">size_t</span> i;<br/></li>
<li>&nbsp; <a href="lauxlib.h.html#L140" title="lauxlib.h:140">luaL_Buffer</a> b;<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">char</span> *s = <a href="lauxlib.c.html#L374" title="lauxlib.c:374">luaL_checklstring</a>(L, <span class="Constant">1</span>, &amp;l);<br/></li>
<li>&nbsp; <span class="Type">char</span> *p = <a href="lauxlib.c.html#L515" title="lauxlib.c:515">luaL_buffinitsize</a>(L, &amp;b, l);<br/></li>
<li>&nbsp; <span class="Statement">for</span> (i=<span class="Constant">0</span>; i&lt;l; i++)<br/></li>
<li>&nbsp; &nbsp; p[i] = tolower(<a href="#L36" title="lstrlib.c:36">uchar</a>(s[i]));<br/></li>
<li>&nbsp; <a href="lauxlib.c.html#L490" title="lauxlib.c:490">luaL_pushresultsize</a>(&amp;b, l);<br/></li>
<li>&nbsp; <span class="Statement">return</span> <span class="Constant">1</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L104">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">str_upper</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <span class="Type">size_t</span> l;<br/></li>
<li>&nbsp; <span class="Type">size_t</span> i;<br/></li>
<li>&nbsp; <a href="lauxlib.h.html#L140" title="lauxlib.h:140">luaL_Buffer</a> b;<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">char</span> *s = <a href="lauxlib.c.html#L374" title="lauxlib.c:374">luaL_checklstring</a>(L, <span class="Constant">1</span>, &amp;l);<br/></li>
<li>&nbsp; <span class="Type">char</span> *p = <a href="lauxlib.c.html#L515" title="lauxlib.c:515">luaL_buffinitsize</a>(L, &amp;b, l);<br/></li>
<li>&nbsp; <span class="Statement">for</span> (i=<span class="Constant">0</span>; i&lt;l; i++)<br/></li>
<li>&nbsp; &nbsp; p[i] = toupper(<a href="#L36" title="lstrlib.c:36">uchar</a>(s[i]));<br/></li>
<li>&nbsp; <a href="lauxlib.c.html#L490" title="lauxlib.c:490">luaL_pushresultsize</a>(&amp;b, l);<br/></li>
<li>&nbsp; <span class="Statement">return</span> <span class="Constant">1</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L117">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">str_rep</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <span class="Type">size_t</span> l, lsep;<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">char</span> *s = <a href="lauxlib.c.html#L374" title="lauxlib.c:374">luaL_checklstring</a>(L, <span class="Constant">1</span>, &amp;l);<br/></li>
<li>&nbsp; <a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a> n = <a href="lauxlib.c.html#L414" title="lauxlib.c:414">luaL_checkinteger</a>(L, <span class="Constant">2</span>);<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">char</span> *sep = <a href="lauxlib.c.html#L381" title="lauxlib.c:381">luaL_optlstring</a>(L, <span class="Constant">3</span>, <span class="Constant">&quot;&quot;</span>, &amp;lsep);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (n &lt;= <span class="Constant">0</span>) <a href="lua.h.html#L359" title="lua.h:359">lua_pushliteral</a>(L, <span class="Constant">&quot;&quot;</span>);<br/></li>
<li>&nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (l + lsep &lt; l || l + lsep &gt; <a href="#L43" title="lstrlib.c:43">MAXSIZE</a> / n)&nbsp; <span class="Comment">/* may overflow? */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">return</span> <a href="lauxlib.c.html#L212" title="lauxlib.c:212">luaL_error</a>(L, <span class="Constant">&quot;resulting string too large&quot;</span>);<br/></li>
<li>&nbsp; <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span> totallen = (<span class="Type">size_t</span>)n * l + (<span class="Type">size_t</span>)(n - <span class="Constant">1</span>) * lsep;<br/></li>
<li>&nbsp; &nbsp; <a href="lauxlib.h.html#L140" title="lauxlib.h:140">luaL_Buffer</a> b;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span> *p = <a href="lauxlib.c.html#L515" title="lauxlib.c:515">luaL_buffinitsize</a>(L, &amp;b, totallen);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (n-- &gt; <span class="Constant">1</span>) {&nbsp; <span class="Comment">/* first n-1 copies (followed by separator) */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; memcpy(p, s, l * <span class="Statement">sizeof</span>(<span class="Type">char</span>)); p += l;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (lsep &gt; <span class="Constant">0</span>) {&nbsp; <span class="Comment">/* empty 'memcpy' is not that cheap */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; memcpy(p, sep, lsep * <span class="Statement">sizeof</span>(<span class="Type">char</span>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p += lsep;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; memcpy(p, s, l * <span class="Statement">sizeof</span>(<span class="Type">char</span>));&nbsp; <span class="Comment">/* last copy (not followed by separator) */<br/></li>
<li></span>&nbsp; &nbsp; <a href="lauxlib.c.html#L490" title="lauxlib.c:490">luaL_pushresultsize</a>(&amp;b, totallen);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> <span class="Constant">1</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L143">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">str_byte</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <span class="Type">size_t</span> l;<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">char</span> *s = <a href="lauxlib.c.html#L374" title="lauxlib.c:374">luaL_checklstring</a>(L, <span class="Constant">1</span>, &amp;l);<br/></li>
<li>&nbsp; <a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a> posi = <a href="#L58" title="lstrlib.c:58">posrelat</a>(<a href="lauxlib.c.html#L424" title="lauxlib.c:424">luaL_optinteger</a>(L, <span class="Constant">2</span>, <span class="Constant">1</span>), l);<br/></li>
<li>&nbsp; <a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a> pose = <a href="#L58" title="lstrlib.c:58">posrelat</a>(<a href="lauxlib.c.html#L424" title="lauxlib.c:424">luaL_optinteger</a>(L, <span class="Constant">3</span>, posi), l);<br/></li>
<li>&nbsp; <span class="Type">int</span> n, i;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (posi &lt; <span class="Constant">1</span>) posi = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (pose &gt; (<a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a>)l) pose = l;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (posi &gt; pose) <span class="Statement">return</span> <span class="Constant">0</span>;&nbsp; <span class="Comment">/* empty interval; return no values */<br/></li>
<li></span>&nbsp; n = (<span class="Type">int</span>)(pose -&nbsp; posi + <span class="Constant">1</span>);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (posi + n &lt;= pose)&nbsp; <span class="Comment">/* arithmetic overflow? */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">return</span> <a href="lauxlib.c.html#L212" title="lauxlib.c:212">luaL_error</a>(L, <span class="Constant">&quot;string slice too long&quot;</span>);<br/></li>
<li>&nbsp; <a href="lauxlib.c.html#L350" title="lauxlib.c:350">luaL_checkstack</a>(L, n, <span class="Constant">&quot;string slice too long&quot;</span>);<br/></li>
<li>&nbsp; <span class="Statement">for</span> (i=<span class="Constant">0</span>; i&lt;n; i++)<br/></li>
<li>&nbsp; &nbsp; <a href="lapi.c.html#L464" title="lapi.c:464">lua_pushinteger</a>(L, <a href="#L36" title="lstrlib.c:36">uchar</a>(s[posi+i-<span class="Constant">1</span>]));<br/></li>
<li>&nbsp; <span class="Statement">return</span> n;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L162">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">str_char</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <span class="Type">int</span> n = <a href="lapi.c.html#L166" title="lapi.c:166">lua_gettop</a>(L);&nbsp; <span class="Comment">/* number of arguments */<br/></li>
<li></span>&nbsp; <span class="Type">int</span> i;<br/></li>
<li>&nbsp; <a href="lauxlib.h.html#L140" title="lauxlib.h:140">luaL_Buffer</a> b;<br/></li>
<li>&nbsp; <span class="Type">char</span> *p = <a href="lauxlib.c.html#L515" title="lauxlib.c:515">luaL_buffinitsize</a>(L, &amp;b, n);<br/></li>
<li>&nbsp; <span class="Statement">for</span> (i=<span class="Constant">1</span>; i&lt;=n; i++) {<br/></li>
<li>&nbsp; &nbsp; <a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a> c = <a href="lauxlib.c.html#L414" title="lauxlib.c:414">luaL_checkinteger</a>(L, i);<br/></li>
<li>&nbsp; &nbsp; <a href="lauxlib.h.html#L114" title="lauxlib.h:114">luaL_argcheck</a>(L, <a href="#L36" title="lstrlib.c:36">uchar</a>(c) == c, i, <span class="Constant">&quot;value out of range&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; p[i - <span class="Constant">1</span>] = <a href="#L36" title="lstrlib.c:36">uchar</a>(c);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <a href="lauxlib.c.html#L490" title="lauxlib.c:490">luaL_pushresultsize</a>(&amp;b, n);<br/></li>
<li>&nbsp; <span class="Statement">return</span> <span class="Constant">1</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L177">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">writer</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">const</span> <span class="Type">void</span> *b, <span class="Type">size_t</span> size, <span class="Type">void</span> *B) {<br/></li>
<li>&nbsp; (<span class="Type">void</span>)L;<br/></li>
<li>&nbsp; <a href="lauxlib.c.html#L470" title="lauxlib.c:470">luaL_addlstring</a>((<a href="lauxlib.h.html#L140" title="lauxlib.h:140">luaL_Buffer</a> *) B, (<span class="Type">const</span> <span class="Type">char</span> *)b, size);<br/></li>
<li>&nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L184">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">str_dump</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <a href="lauxlib.h.html#L140" title="lauxlib.h:140">luaL_Buffer</a> b;<br/></li>
<li>&nbsp; <span class="Type">int</span> strip = <a href="lapi.c.html#L366" title="lapi.c:366">lua_toboolean</a>(L, <span class="Constant">2</span>);<br/></li>
<li>&nbsp; <a href="lauxlib.c.html#L362" title="lauxlib.c:362">luaL_checktype</a>(L, <span class="Constant">1</span>, <a href="lua.h.html#L68" title="lua.h:68">LUA_TFUNCTION</a>);<br/></li>
<li>&nbsp; <a href="lapi.c.html#L171" title="lapi.c:171">lua_settop</a>(L, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; <a href="lauxlib.c.html#L507" title="lauxlib.c:507">luaL_buffinit</a>(L,&amp;b);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="lapi.c.html#L987" title="lapi.c:987">lua_dump</a>(L, <a href="#L177" title="lstrlib.c:177">writer</a>, &amp;b, strip) != <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="lauxlib.c.html#L212" title="lauxlib.c:212">luaL_error</a>(L, <span class="Constant">&quot;unable to dump given function&quot;</span>);<br/></li>
<li>&nbsp; <a href="lauxlib.c.html#L482" title="lauxlib.c:482">luaL_pushresult</a>(&amp;b);<br/></li>
<li>&nbsp; <span class="Statement">return</span> <span class="Constant">1</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** {======================================================<br/></li>
<li></span><span class="Comment">** PATTERN MATCHING<br/></li>
<li></span><span class="Comment">** =======================================================<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><a id="L205">&#x200c;</a><span class="PreProc">#define <span class="linkable">CAP_UNFINISHED</span>&nbsp; &nbsp; &nbsp; &nbsp; (-</span><span class="Constant">1</span><span class="PreProc">)<br/></li>
<li><a id="L206">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">CAP_POSITION</span>&nbsp; &nbsp; &nbsp; &nbsp; (-</span><span class="Constant">2</span><span class="PreProc">)<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><a id="L209">&#x200c;</a><span class="Type">typedef</span> <span class="Type">struct</span> <span class="linkable">MatchState</span> {<br/></li>
<li>&nbsp; <span class="Type">int</span> matchdepth;&nbsp; <span class="Comment">/* control for recursive depth (to avoid C stack overflow) */<br/></li>
<li></span>&nbsp; <span class="Type">const</span> <span class="Type">char</span> *src_init;&nbsp; <span class="Comment">/* init of source string */<br/></li>
<li></span>&nbsp; <span class="Type">const</span> <span class="Type">char</span> *src_end;&nbsp; <span class="Comment">/* end ('\0') of source string */<br/></li>
<li></span>&nbsp; <span class="Type">const</span> <span class="Type">char</span> *p_end;&nbsp; <span class="Comment">/* end ('\0') of pattern */<br/></li>
<li></span>&nbsp; <a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L;<br/></li>
<li>&nbsp; <span class="Type">int</span> level;&nbsp; <span class="Comment">/* total number of captures (finished or unfinished) */<br/></li>
<li></span>&nbsp; <span class="Type">struct</span> {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span> *init;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">ptrdiff_t</span> len;<br/></li>
<li>&nbsp; } capture[<a href="#L31" title="lstrlib.c:31">LUA_MAXCAPTURES</a>];<br/></li>
<li><a id="L220">&#x200c;</a>} <span class="linkable">MatchState</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/* recursive function */<br/></li>
<li></span><span class="Type">static</span> <span class="Type">const</span> <span class="Type">char</span> *<a href="#L420" title="lstrlib.c:420">match</a> (<a href="#L209" title="lstrlib.c:209">MatchState</a> *ms, <span class="Type">const</span> <span class="Type">char</span> *s, <span class="Type">const</span> <span class="Type">char</span> *p);<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/* maximum recursion depth for '<a href="#L420" title="lstrlib.c:420">match</a>' */<br/></li>
<li></span><span class="PreProc">#if !defined(<a href="#L229" title="lstrlib.c:229">MAXCCALLS</a>)<br/></li>
<li><a id="L229">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">MAXCCALLS</span>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">200<br/></li>
<li></span><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><a id="L233">&#x200c;</a><span class="PreProc">#define <span class="linkable">L_ESC</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">'%'<br/></li>
<li><a id="L234">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">SPECIALS</span>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">&quot;^$*+?.([%-&quot;<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><a id="L237">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">check_capture</span> (<a href="#L209" title="lstrlib.c:209">MatchState</a> *ms, <span class="Type">int</span> l) {<br/></li>
<li>&nbsp; l -= <span class="Constant">'1'</span>;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (l &lt; <span class="Constant">0</span> || l &gt;= ms-&gt;level || ms-&gt;capture[l].len == <a href="#L205" title="lstrlib.c:205">CAP_UNFINISHED</a>)<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="lauxlib.c.html#L212" title="lauxlib.c:212">luaL_error</a>(ms-&gt;L, <span class="Constant">&quot;invalid capture index </span><span class="Special">%%%d</span><span class="Constant">&quot;</span>, l + <span class="Constant">1</span>);<br/></li>
<li>&nbsp; <span class="Statement">return</span> l;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L245">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">capture_to_close</span> (<a href="#L209" title="lstrlib.c:209">MatchState</a> *ms) {<br/></li>
<li>&nbsp; <span class="Type">int</span> level = ms-&gt;level;<br/></li>
<li>&nbsp; <span class="Statement">for</span> (level--; level&gt;=<span class="Constant">0</span>; level--)<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ms-&gt;capture[level].len == <a href="#L205" title="lstrlib.c:205">CAP_UNFINISHED</a>) <span class="Statement">return</span> level;<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="lauxlib.c.html#L212" title="lauxlib.c:212">luaL_error</a>(ms-&gt;L, <span class="Constant">&quot;invalid pattern capture&quot;</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L253">&#x200c;</a><span class="Type">static</span> <span class="Type">const</span> <span class="Type">char</span> *<span class="linkable">classend</span> (<a href="#L209" title="lstrlib.c:209">MatchState</a> *ms, <span class="Type">const</span> <span class="Type">char</span> *p) {<br/></li>
<li>&nbsp; <span class="Statement">switch</span> (*p++) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="#L233" title="lstrlib.c:233">L_ESC</a>: {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (p == ms-&gt;p_end)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lauxlib.c.html#L212" title="lauxlib.c:212">luaL_error</a>(ms-&gt;L, <span class="Constant">&quot;malformed pattern (ends with '</span><span class="Special">%%</span><span class="Constant">')&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span> p+<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'['</span>: {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (*p == <span class="Constant">'^'</span>) p++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">do</span> {&nbsp; <span class="Comment">/* look for a ']' */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (p == ms-&gt;p_end)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lauxlib.c.html#L212" title="lauxlib.c:212">luaL_error</a>(ms-&gt;L, <span class="Constant">&quot;malformed pattern (missing ']')&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (*(p++) == <a href="#L233" title="lstrlib.c:233">L_ESC</a> &amp;&amp; p &lt; ms-&gt;p_end)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p++;&nbsp; <span class="Comment">/* skip escapes (e.g. '%]') */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; } <span class="Statement">while</span> (*p != <span class="Constant">']'</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span> p+<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span> p;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L277">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">match_class</span> (<span class="Type">int</span> c, <span class="Type">int</span> cl) {<br/></li>
<li>&nbsp; <span class="Type">int</span> res;<br/></li>
<li>&nbsp; <span class="Statement">switch</span> (tolower(cl)) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'a'</span> : res = isalpha(c); <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'c'</span> : res = iscntrl(c); <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'d'</span> : res = isdigit(c); <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'g'</span> : res = isgraph(c); <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'l'</span> : res = islower(c); <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'p'</span> : res = ispunct(c); <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'s'</span> : res = isspace(c); <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'u'</span> : res = isupper(c); <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'w'</span> : res = isalnum(c); <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'x'</span> : res = isxdigit(c); <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'z'</span> : res = (c == <span class="Constant">0</span>); <span class="Statement">break</span>;&nbsp; <span class="Comment">/* deprecated option */<br/></li>
<li></span><span class="cUserCont">&nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:</span> <span class="Statement">return</span> (cl == c);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> (islower(cl) ? res : !res);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L297">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">matchbracketclass</span> (<span class="Type">int</span> c, <span class="Type">const</span> <span class="Type">char</span> *p, <span class="Type">const</span> <span class="Type">char</span> *ec) {<br/></li>
<li>&nbsp; <span class="Type">int</span> sig = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (*(p+<span class="Constant">1</span>) == <span class="Constant">'^'</span>) {<br/></li>
<li>&nbsp; &nbsp; sig = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; p++;&nbsp; <span class="Comment">/* skip the '^' */<br/></li>
<li></span>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">while</span> (++p &lt; ec) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (*p == <a href="#L233" title="lstrlib.c:233">L_ESC</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; p++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L277" title="lstrlib.c:277">match_class</a>(c, <a href="#L36" title="lstrlib.c:36">uchar</a>(*p)))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> sig;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">if</span> ((*(p+<span class="Constant">1</span>) == <span class="Constant">'-'</span>) &amp;&amp; (p+<span class="Constant">2</span> &lt; ec)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; p+=<span class="Constant">2</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L36" title="lstrlib.c:36">uchar</a>(*(p-<span class="Constant">2</span>)) &lt;= c &amp;&amp; c &lt;= <a href="#L36" title="lstrlib.c:36">uchar</a>(*p))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> sig;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (<a href="#L36" title="lstrlib.c:36">uchar</a>(*p) == c) <span class="Statement">return</span> sig;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> !sig;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L320">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">singlematch</span> (<a href="#L209" title="lstrlib.c:209">MatchState</a> *ms, <span class="Type">const</span> <span class="Type">char</span> *s, <span class="Type">const</span> <span class="Type">char</span> *p,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span> *ep) {<br/></li>
<li>&nbsp; <span class="Statement">if</span> (s &gt;= ms-&gt;src_end)<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>&nbsp; <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span> c = <a href="#L36" title="lstrlib.c:36">uchar</a>(*s);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">switch</span> (*p) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'.'</span>: <span class="Statement">return</span> <span class="Constant">1</span>;&nbsp; <span class="Comment">/* matches any char */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="#L233" title="lstrlib.c:233">L_ESC</a>: <span class="Statement">return</span> <a href="#L277" title="lstrlib.c:277">match_class</a>(c, <a href="#L36" title="lstrlib.c:36">uchar</a>(*(p+<span class="Constant">1</span>)));<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'['</span>: <span class="Statement">return</span> <a href="#L297" title="lstrlib.c:297">matchbracketclass</a>(c, p, ep-<span class="Constant">1</span>);<br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:</span>&nbsp; <span class="Statement">return</span> (<a href="#L36" title="lstrlib.c:36">uchar</a>(*p) == c);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L336">&#x200c;</a><span class="Type">static</span> <span class="Type">const</span> <span class="Type">char</span> *<span class="linkable">matchbalance</span> (<a href="#L209" title="lstrlib.c:209">MatchState</a> *ms, <span class="Type">const</span> <span class="Type">char</span> *s,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type">const</span> <span class="Type">char</span> *p) {<br/></li>
<li>&nbsp; <span class="Statement">if</span> (p &gt;= ms-&gt;p_end - <span class="Constant">1</span>)<br/></li>
<li>&nbsp; &nbsp; <a href="lauxlib.c.html#L212" title="lauxlib.c:212">luaL_error</a>(ms-&gt;L, <span class="Constant">&quot;malformed pattern (missing arguments to '</span><span class="Special">%%</span><span class="Constant">b')&quot;</span>);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (*s != *p) <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span> b = *p;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span> e = *(p+<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span> cont = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (++s &lt; ms-&gt;src_end) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (*s == e) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (--cont == <span class="Constant">0</span>) <span class="Statement">return</span> s+<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (*s == b) cont++;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;&nbsp; <span class="Comment">/* string ends out of balance */<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L356">&#x200c;</a><span class="Type">static</span> <span class="Type">const</span> <span class="Type">char</span> *<span class="linkable">max_expand</span> (<a href="#L209" title="lstrlib.c:209">MatchState</a> *ms, <span class="Type">const</span> <span class="Type">char</span> *s,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type">const</span> <span class="Type">char</span> *p, <span class="Type">const</span> <span class="Type">char</span> *ep) {<br/></li>
<li>&nbsp; <span class="Type">ptrdiff_t</span> i = <span class="Constant">0</span>;&nbsp; <span class="Comment">/* counts maximum expand for item */<br/></li>
<li></span>&nbsp; <span class="Statement">while</span> (<a href="#L320" title="lstrlib.c:320">singlematch</a>(ms, s + i, p, ep))<br/></li>
<li>&nbsp; &nbsp; i++;<br/></li>
<li>&nbsp; <span class="Comment">/* keeps trying to <a href="#L420" title="lstrlib.c:420">match</a> with the maximum repetitions */<br/></li>
<li></span>&nbsp; <span class="Statement">while</span> (i&gt;=<span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span> *res = <a href="#L420" title="lstrlib.c:420">match</a>(ms, (s+i), ep+<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (res) <span class="Statement">return</span> res;<br/></li>
<li>&nbsp; &nbsp; i--;&nbsp; <span class="Comment">/* else didn't <a href="#L420" title="lstrlib.c:420">match</a>; reduce 1 repetition to try again */<br/></li>
<li></span>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L371">&#x200c;</a><span class="Type">static</span> <span class="Type">const</span> <span class="Type">char</span> *<span class="linkable">min_expand</span> (<a href="#L209" title="lstrlib.c:209">MatchState</a> *ms, <span class="Type">const</span> <span class="Type">char</span> *s,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type">const</span> <span class="Type">char</span> *p, <span class="Type">const</span> <span class="Type">char</span> *ep) {<br/></li>
<li>&nbsp; <span class="Statement">for</span> (;;) {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span> *res = <a href="#L420" title="lstrlib.c:420">match</a>(ms, s, ep+<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (res != <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span> res;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (<a href="#L320" title="lstrlib.c:320">singlematch</a>(ms, s, p, ep))<br/></li>
<li>&nbsp; &nbsp; &nbsp; s++;&nbsp; <span class="Comment">/* try with one more repetition */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L384">&#x200c;</a><span class="Type">static</span> <span class="Type">const</span> <span class="Type">char</span> *<span class="linkable">start_capture</span> (<a href="#L209" title="lstrlib.c:209">MatchState</a> *ms, <span class="Type">const</span> <span class="Type">char</span> *s,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span> *p, <span class="Type">int</span> what) {<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">char</span> *res;<br/></li>
<li>&nbsp; <span class="Type">int</span> level = ms-&gt;level;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (level &gt;= <a href="#L31" title="lstrlib.c:31">LUA_MAXCAPTURES</a>) <a href="lauxlib.c.html#L212" title="lauxlib.c:212">luaL_error</a>(ms-&gt;L, <span class="Constant">&quot;too many captures&quot;</span>);<br/></li>
<li>&nbsp; ms-&gt;capture[level].init = s;<br/></li>
<li>&nbsp; ms-&gt;capture[level].len = what;<br/></li>
<li>&nbsp; ms-&gt;level = level+<span class="Constant">1</span>;<br/></li>
<li>&nbsp; <span class="Statement">if</span> ((res=<a href="#L420" title="lstrlib.c:420">match</a>(ms, s, p)) == <span class="Constant">NULL</span>)&nbsp; <span class="Comment">/* <a href="#L420" title="lstrlib.c:420">match</a> failed? */<br/></li>
<li></span>&nbsp; &nbsp; ms-&gt;level--;&nbsp; <span class="Comment">/* undo capture */<br/></li>
<li></span>&nbsp; <span class="Statement">return</span> res;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L398">&#x200c;</a><span class="Type">static</span> <span class="Type">const</span> <span class="Type">char</span> *<span class="linkable">end_capture</span> (<a href="#L209" title="lstrlib.c:209">MatchState</a> *ms, <span class="Type">const</span> <span class="Type">char</span> *s,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span> *p) {<br/></li>
<li>&nbsp; <span class="Type">int</span> l = <a href="#L245" title="lstrlib.c:245">capture_to_close</a>(ms);<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">char</span> *res;<br/></li>
<li>&nbsp; ms-&gt;capture[l].len = s - ms-&gt;capture[l].init;&nbsp; <span class="Comment">/* close capture */<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> ((res = <a href="#L420" title="lstrlib.c:420">match</a>(ms, s, p)) == <span class="Constant">NULL</span>)&nbsp; <span class="Comment">/* <a href="#L420" title="lstrlib.c:420">match</a> failed? */<br/></li>
<li></span>&nbsp; &nbsp; ms-&gt;capture[l].len = <a href="#L205" title="lstrlib.c:205">CAP_UNFINISHED</a>;&nbsp; <span class="Comment">/* undo capture */<br/></li>
<li></span>&nbsp; <span class="Statement">return</span> res;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L409">&#x200c;</a><span class="Type">static</span> <span class="Type">const</span> <span class="Type">char</span> *<span class="linkable">match_capture</span> (<a href="#L209" title="lstrlib.c:209">MatchState</a> *ms, <span class="Type">const</span> <span class="Type">char</span> *s, <span class="Type">int</span> l) {<br/></li>
<li>&nbsp; <span class="Type">size_t</span> len;<br/></li>
<li>&nbsp; l = <a href="#L237" title="lstrlib.c:237">check_capture</a>(ms, l);<br/></li>
<li>&nbsp; len = ms-&gt;capture[l].len;<br/></li>
<li>&nbsp; <span class="Statement">if</span> ((<span class="Type">size_t</span>)(ms-&gt;src_end-s) &gt;= len &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; memcmp(ms-&gt;capture[l].init, s, len) == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> s+len;<br/></li>
<li>&nbsp; <span class="Statement">else</span> <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L420">&#x200c;</a><span class="Type">static</span> <span class="Type">const</span> <span class="Type">char</span> *<span class="linkable">match</span> (<a href="#L209" title="lstrlib.c:209">MatchState</a> *ms, <span class="Type">const</span> <span class="Type">char</span> *s, <span class="Type">const</span> <span class="Type">char</span> *p) {<br/></li>
<li>&nbsp; <span class="Statement">if</span> (ms-&gt;matchdepth-- == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; <a href="lauxlib.c.html#L212" title="lauxlib.c:212">luaL_error</a>(ms-&gt;L, <span class="Constant">&quot;pattern too complex&quot;</span>);<br/></li>
<li><span class="cUserCont">&nbsp; </span><span class="Statement">init</span><span class="cUserCont">:</span> <span class="Comment">/* using goto's to optimize tail recursion */<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (p != ms-&gt;p_end) {&nbsp; <span class="Comment">/* end of pattern? */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">switch</span> (*p) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'('</span>: {&nbsp; <span class="Comment">/* start capture */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (*(p + <span class="Constant">1</span>) == <span class="Constant">')'</span>)&nbsp; <span class="Comment">/* position capture? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; s = <a href="#L384" title="lstrlib.c:384">start_capture</a>(ms, s, p + <span class="Constant">2</span>, <a href="#L206" title="lstrlib.c:206">CAP_POSITION</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; s = <a href="#L384" title="lstrlib.c:384">start_capture</a>(ms, s, p + <span class="Constant">1</span>, <a href="#L205" title="lstrlib.c:205">CAP_UNFINISHED</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">')'</span>: {&nbsp; <span class="Comment">/* end capture */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; s = <a href="#L398" title="lstrlib.c:398">end_capture</a>(ms, s, p + <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'$'</span>: {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((p + <span class="Constant">1</span>) != ms-&gt;p_end)&nbsp; <span class="Comment">/* is the '$' the last char in pattern? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> dflt;&nbsp; <span class="Comment">/* no; go to default */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; s = (s == ms-&gt;src_end) ? s : <span class="Constant">NULL</span>;&nbsp; <span class="Comment">/* <a href="lparser.c.html#L106" title="lparser.c:106">check</a> end of string */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="#L233" title="lstrlib.c:233">L_ESC</a>: {&nbsp; <span class="Comment">/* escaped sequences not in the format class[*+?-]? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (*(p + <span class="Constant">1</span>)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'b'</span>: {&nbsp; <span class="Comment">/* balanced string? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; s = <a href="#L336" title="lstrlib.c:336">matchbalance</a>(ms, s, p + <span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (s != <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p += <span class="Constant">4</span>; <span class="Statement">goto</span> init;&nbsp; <span class="Comment">/* return <a href="#L420" title="lstrlib.c:420">match</a>(ms, s, p + 4); */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }&nbsp; <span class="Comment">/* else fail (s == NULL) */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'f'</span>: {&nbsp; <span class="Comment">/* frontier? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span> *ep; <span class="Type">char</span> previous;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p += <span class="Constant">2</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (*p != <span class="Constant">'['</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lauxlib.c.html#L212" title="lauxlib.c:212">luaL_error</a>(ms-&gt;L, <span class="Constant">&quot;missing '[' after '</span><span class="Special">%%</span><span class="Constant">f' in pattern&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ep = <a href="#L253" title="lstrlib.c:253">classend</a>(ms, p);&nbsp; <span class="Comment">/* points to what is <a href="llex.c.html#L31" title="llex.c:31">next</a> */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; previous = (s == ms-&gt;src_init) ? <span class="Special">'\0'</span> : *(s - <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!<a href="#L297" title="lstrlib.c:297">matchbracketclass</a>(<a href="#L36" title="lstrlib.c:36">uchar</a>(previous), p, ep - <span class="Constant">1</span>) &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L297" title="lstrlib.c:297">matchbracketclass</a>(<a href="#L36" title="lstrlib.c:36">uchar</a>(*s), p, ep - <span class="Constant">1</span>)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = ep; <span class="Statement">goto</span> init;&nbsp; <span class="Comment">/* return <a href="#L420" title="lstrlib.c:420">match</a>(ms, s, ep); */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; s = <span class="Constant">NULL</span>;&nbsp; <span class="Comment">/* <a href="#L420" title="lstrlib.c:420">match</a> failed */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'0'</span>: <span class="Statement">case</span> <span class="Constant">'1'</span>: <span class="Statement">case</span> <span class="Constant">'2'</span>: <span class="Statement">case</span> <span class="Constant">'3'</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'4'</span>: <span class="Statement">case</span> <span class="Constant">'5'</span>: <span class="Statement">case</span> <span class="Constant">'6'</span>: <span class="Statement">case</span> <span class="Constant">'7'</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'8'</span>: <span class="Statement">case</span> <span class="Constant">'9'</span>: {&nbsp; <span class="Comment">/* capture results (%0-%9)? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; s = <a href="#L409" title="lstrlib.c:409">match_capture</a>(ms, s, <a href="#L36" title="lstrlib.c:36">uchar</a>(*(p + <span class="Constant">1</span>)));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (s != <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p += <span class="Constant">2</span>; <span class="Statement">goto</span> init;&nbsp; <span class="Comment">/* return <a href="#L420" title="lstrlib.c:420">match</a>(ms, s, p + 2) */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:</span> <span class="Statement">goto</span> dflt;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:</span> dflt: {&nbsp; <span class="Comment">/* pattern class plus optional suffix */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span> *ep = <a href="#L253" title="lstrlib.c:253">classend</a>(ms, p);&nbsp; <span class="Comment">/* points to optional suffix */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* does not <a href="#L420" title="lstrlib.c:420">match</a> at least once? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!<a href="#L320" title="lstrlib.c:320">singlematch</a>(ms, s, p, ep)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (*ep == <span class="Constant">'*'</span> || *ep == <span class="Constant">'?'</span> || *ep == <span class="Constant">'-'</span>) {&nbsp; <span class="Comment">/* accept empty? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = ep + <span class="Constant">1</span>; <span class="Statement">goto</span> init;&nbsp; <span class="Comment">/* return <a href="#L420" title="lstrlib.c:420">match</a>(ms, s, ep + 1); */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else</span>&nbsp; <span class="Comment">/* '+' or no suffix */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; s = <span class="Constant">NULL</span>;&nbsp; <span class="Comment">/* fail */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else</span> {&nbsp; <span class="Comment">/* matched once */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (*ep) {&nbsp; <span class="Comment">/* handle optional suffix */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'?'</span>: {&nbsp; <span class="Comment">/* optional */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span> *res;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((res = <a href="#L420" title="lstrlib.c:420">match</a>(ms, s + <span class="Constant">1</span>, ep + <span class="Constant">1</span>)) != <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; s = res;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = ep + <span class="Constant">1</span>; <span class="Statement">goto</span> init;&nbsp; <span class="Comment">/* else return <a href="#L420" title="lstrlib.c:420">match</a>(ms, s, ep + 1); */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'+'</span>:&nbsp; <span class="Comment">/* 1 or more repetitions */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; s++;&nbsp; <span class="Comment">/* 1 <a href="#L420" title="lstrlib.c:420">match</a> already done */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* go through */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'*'</span>:&nbsp; <span class="Comment">/* 0 or more repetitions */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; s = <a href="#L356" title="lstrlib.c:356">max_expand</a>(ms, s, p, ep);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'-'</span>:&nbsp; <span class="Comment">/* 0 or more repetitions (minimum) */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; s = <a href="#L371" title="lstrlib.c:371">min_expand</a>(ms, s, p, ep);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:</span>&nbsp; <span class="Comment">/* no suffix */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; s++; p = ep; <span class="Statement">goto</span> init;&nbsp; <span class="Comment">/* return <a href="#L420" title="lstrlib.c:420">match</a>(ms, s + 1, ep); */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; ms-&gt;matchdepth++;<br/></li>
<li>&nbsp; <span class="Statement">return</span> s;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L523">&#x200c;</a><span class="Type">static</span> <span class="Type">const</span> <span class="Type">char</span> *<span class="linkable">lmemfind</span> (<span class="Type">const</span> <span class="Type">char</span> *s1, <span class="Type">size_t</span> l1,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type">const</span> <span class="Type">char</span> *s2, <span class="Type">size_t</span> l2) {<br/></li>
<li>&nbsp; <span class="Statement">if</span> (l2 == <span class="Constant">0</span>) <span class="Statement">return</span> s1;&nbsp; <span class="Comment">/* empty strings are everywhere */<br/></li>
<li></span>&nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (l2 &gt; l1) <span class="Statement">return</span> <span class="Constant">NULL</span>;&nbsp; <span class="Comment">/* avoids a negative 'l1' */<br/></li>
<li></span>&nbsp; <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span> *init;&nbsp; <span class="Comment">/* to search for a '*s2' inside 's1' */<br/></li>
<li></span>&nbsp; &nbsp; l2--;&nbsp; <span class="Comment">/* 1st char will be checked by 'memchr' */<br/></li>
<li></span>&nbsp; &nbsp; l1 = l1-l2;&nbsp; <span class="Comment">/* 's2' <a href="luac.c.html#L44" title="luac.c:44">cannot</a> be found after that */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">while</span> (l1 &gt; <span class="Constant">0</span> &amp;&amp; (init = (<span class="Type">const</span> <span class="Type">char</span> *)memchr(s1, *s2, l1)) != <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; init++;&nbsp;&nbsp; <span class="Comment">/* 1st char is already checked */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (memcmp(init, s2+<span class="Constant">1</span>, l2) == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> init-<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">else</span> {&nbsp; <span class="Comment">/* correct 'l1' and 's1' to try again */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; l1 -= init-s1;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; s1 = init;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;&nbsp; <span class="Comment">/* not found */<br/></li>
<li></span>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L545">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">push_onecapture</span> (<a href="#L209" title="lstrlib.c:209">MatchState</a> *ms, <span class="Type">int</span> i, <span class="Type">const</span> <span class="Type">char</span> *s,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span> *e) {<br/></li>
<li>&nbsp; <span class="Statement">if</span> (i &gt;= ms-&gt;level) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (i == <span class="Constant">0</span>)&nbsp; <span class="Comment">/* ms-&gt;level == 0, too */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <a href="lapi.c.html#L472" title="lapi.c:472">lua_pushlstring</a>(ms-&gt;L, s, e - s);&nbsp; <span class="Comment">/* add whole <a href="#L420" title="lstrlib.c:420">match</a> */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <a href="lauxlib.c.html#L212" title="lauxlib.c:212">luaL_error</a>(ms-&gt;L, <span class="Constant">&quot;invalid capture index </span><span class="Special">%%%d</span><span class="Constant">&quot;</span>, i + <span class="Constant">1</span>);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">ptrdiff_t</span> l = ms-&gt;capture[i].len;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (l == <a href="#L205" title="lstrlib.c:205">CAP_UNFINISHED</a>) <a href="lauxlib.c.html#L212" title="lauxlib.c:212">luaL_error</a>(ms-&gt;L, <span class="Constant">&quot;unfinished capture&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (l == <a href="#L206" title="lstrlib.c:206">CAP_POSITION</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="lapi.c.html#L464" title="lapi.c:464">lua_pushinteger</a>(ms-&gt;L, ms-&gt;capture[i].init - ms-&gt;src_init + <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <a href="lapi.c.html#L472" title="lapi.c:472">lua_pushlstring</a>(ms-&gt;L, ms-&gt;capture[i].init, l);<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L564">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">push_captures</span> (<a href="#L209" title="lstrlib.c:209">MatchState</a> *ms, <span class="Type">const</span> <span class="Type">char</span> *s, <span class="Type">const</span> <span class="Type">char</span> *e) {<br/></li>
<li>&nbsp; <span class="Type">int</span> i;<br/></li>
<li>&nbsp; <span class="Type">int</span> nlevels = (ms-&gt;level == <span class="Constant">0</span> &amp;&amp; s) ? <span class="Constant">1</span> : ms-&gt;level;<br/></li>
<li>&nbsp; <a href="lauxlib.c.html#L350" title="lauxlib.c:350">luaL_checkstack</a>(ms-&gt;L, nlevels, <span class="Constant">&quot;too many captures&quot;</span>);<br/></li>
<li>&nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; nlevels; i++)<br/></li>
<li>&nbsp; &nbsp; <a href="#L545" title="lstrlib.c:545">push_onecapture</a>(ms, i, s, e);<br/></li>
<li>&nbsp; <span class="Statement">return</span> nlevels;&nbsp; <span class="Comment">/* number of strings pushed */<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/* <a href="lparser.c.html#L106" title="lparser.c:106">check</a> whether pattern has no special characters */<br/></li>
<li><a id="L575">&#x200c;</a></span><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">nospecials</span> (<span class="Type">const</span> <span class="Type">char</span> *p, <span class="Type">size_t</span> l) {<br/></li>
<li>&nbsp; <span class="Type">size_t</span> upto = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; <span class="Statement">do</span> {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (strpbrk(p + upto, <a href="#L234" title="lstrlib.c:234">SPECIALS</a>))<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;&nbsp; <span class="Comment">/* pattern has a special character */<br/></li>
<li></span>&nbsp; &nbsp; upto += strlen(p + upto) + <span class="Constant">1</span>;&nbsp; <span class="Comment">/* may have more after \0 */<br/></li>
<li></span>&nbsp; } <span class="Statement">while</span> (upto &lt;= l);<br/></li>
<li>&nbsp; <span class="Statement">return</span> <span class="Constant">1</span>;&nbsp; <span class="Comment">/* no special chars found */<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L586">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">str_find_aux</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">int</span> find) {<br/></li>
<li>&nbsp; <span class="Type">size_t</span> ls, lp;<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">char</span> *s = <a href="lauxlib.c.html#L374" title="lauxlib.c:374">luaL_checklstring</a>(L, <span class="Constant">1</span>, &amp;ls);<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">char</span> *p = <a href="lauxlib.c.html#L374" title="lauxlib.c:374">luaL_checklstring</a>(L, <span class="Constant">2</span>, &amp;lp);<br/></li>
<li>&nbsp; <a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a> init = <a href="#L58" title="lstrlib.c:58">posrelat</a>(<a href="lauxlib.c.html#L424" title="lauxlib.c:424">luaL_optinteger</a>(L, <span class="Constant">3</span>, <span class="Constant">1</span>), ls);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (init &lt; <span class="Constant">1</span>) init = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (init &gt; (<a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a>)ls + <span class="Constant">1</span>) {&nbsp; <span class="Comment">/* start after string's end? */<br/></li>
<li></span>&nbsp; &nbsp; <a href="lapi.c.html#L448" title="lapi.c:448">lua_pushnil</a>(L);&nbsp; <span class="Comment">/* <a href="luac.c.html#L44" title="luac.c:44">cannot</a> find anything */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">1</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Comment">/* explicit request or no special characters? */<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (find &amp;&amp; (<a href="lapi.c.html#L366" title="lapi.c:366">lua_toboolean</a>(L, <span class="Constant">4</span>) || <a href="#L575" title="lstrlib.c:575">nospecials</a>(p, lp))) {<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* do a plain search */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span> *s2 = <a href="#L523" title="lstrlib.c:523">lmemfind</a>(s + init - <span class="Constant">1</span>, ls - (<span class="Type">size_t</span>)init + <span class="Constant">1</span>, p, lp);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (s2) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="lapi.c.html#L464" title="lapi.c:464">lua_pushinteger</a>(L, s2 - s + <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="lapi.c.html#L464" title="lapi.c:464">lua_pushinteger</a>(L, s2 - s + lp);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">2</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; <a href="#L209" title="lstrlib.c:209">MatchState</a> ms;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span> *s1 = s + init - <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span> anchor = (*p == <span class="Constant">'^'</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (anchor) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; p++; lp--;&nbsp; <span class="Comment">/* skip anchor character */<br/></li>
<li></span>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; ms.L = L;<br/></li>
<li>&nbsp; &nbsp; ms.matchdepth = <a href="#L229" title="lstrlib.c:229">MAXCCALLS</a>;<br/></li>
<li>&nbsp; &nbsp; ms.src_init = s;<br/></li>
<li>&nbsp; &nbsp; ms.src_end = s + ls;<br/></li>
<li>&nbsp; &nbsp; ms.p_end = p + lp;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">do</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span> *res;<br/></li>
<li>&nbsp; &nbsp; &nbsp; ms.level = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="lualib.h.html#L54" title="lualib.h:54">lua_assert</a>(ms.matchdepth == <a href="#L229" title="lstrlib.c:229">MAXCCALLS</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((res=<a href="#L420" title="lstrlib.c:420">match</a>(&amp;ms, s1, p)) != <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (find) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lapi.c.html#L464" title="lapi.c:464">lua_pushinteger</a>(L, s1 - s + <span class="Constant">1</span>);&nbsp; <span class="Comment">/* start */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lapi.c.html#L464" title="lapi.c:464">lua_pushinteger</a>(L, res - s);&nbsp;&nbsp; <span class="Comment">/* end */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L564" title="lstrlib.c:564">push_captures</a>(&amp;ms, <span class="Constant">NULL</span>, <span class="Constant">0</span>) + <span class="Constant">2</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L564" title="lstrlib.c:564">push_captures</a>(&amp;ms, s1, res);<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">while</span> (s1++ &lt; ms.src_end &amp;&amp; !anchor);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <a href="lapi.c.html#L448" title="lapi.c:448">lua_pushnil</a>(L);&nbsp; <span class="Comment">/* not found */<br/></li>
<li></span>&nbsp; <span class="Statement">return</span> <span class="Constant">1</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L638">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">str_find</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="#L586" title="lstrlib.c:586">str_find_aux</a>(L, <span class="Constant">1</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L643">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">str_match</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="#L586" title="lstrlib.c:586">str_find_aux</a>(L, <span class="Constant">0</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L648">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">gmatch_aux</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <a href="#L209" title="lstrlib.c:209">MatchState</a> ms;<br/></li>
<li>&nbsp; <span class="Type">size_t</span> ls, lp;<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">char</span> *s = <a href="lapi.c.html#L372" title="lapi.c:372">lua_tolstring</a>(L, <a href="lua.h.html#L41" title="lua.h:41">lua_upvalueindex</a>(<span class="Constant">1</span>), &amp;ls);<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">char</span> *p = <a href="lapi.c.html#L372" title="lapi.c:372">lua_tolstring</a>(L, <a href="lua.h.html#L41" title="lua.h:41">lua_upvalueindex</a>(<span class="Constant">2</span>), &amp;lp);<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">char</span> *src;<br/></li>
<li>&nbsp; ms.L = L;<br/></li>
<li>&nbsp; ms.matchdepth = <a href="#L229" title="lstrlib.c:229">MAXCCALLS</a>;<br/></li>
<li>&nbsp; ms.src_init = s;<br/></li>
<li>&nbsp; ms.src_end = s+ls;<br/></li>
<li>&nbsp; ms.p_end = p + lp;<br/></li>
<li>&nbsp; <span class="Statement">for</span> (src = s + (<span class="Type">size_t</span>)<a href="lua.h.html#L340" title="lua.h:340">lua_tointeger</a>(L, <a href="lua.h.html#L41" title="lua.h:41">lua_upvalueindex</a>(<span class="Constant">3</span>));<br/></li>
<li>&nbsp; &nbsp; &nbsp;&nbsp; src &lt;= ms.src_end;<br/></li>
<li>&nbsp; &nbsp; &nbsp;&nbsp; src++) {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span> *e;<br/></li>
<li>&nbsp; &nbsp; ms.level = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; <a href="lualib.h.html#L54" title="lualib.h:54">lua_assert</a>(ms.matchdepth == <a href="#L229" title="lstrlib.c:229">MAXCCALLS</a>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> ((e = <a href="#L420" title="lstrlib.c:420">match</a>(&amp;ms, src, p)) != <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a> newstart = e-s;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (e == src) newstart++;&nbsp; <span class="Comment">/* empty <a href="#L420" title="lstrlib.c:420">match</a>? go at least one position */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <a href="lapi.c.html#L464" title="lapi.c:464">lua_pushinteger</a>(L, newstart);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="lua.h.html#L372" title="lua.h:372">lua_replace</a>(L, <a href="lua.h.html#L41" title="lua.h:41">lua_upvalueindex</a>(<span class="Constant">3</span>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L564" title="lstrlib.c:564">push_captures</a>(&amp;ms, src, e);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;&nbsp; <span class="Comment">/* not found */<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L677">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">gmatch</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <a href="lauxlib.h.html#L116" title="lauxlib.h:116">luaL_checkstring</a>(L, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; <a href="lauxlib.h.html#L116" title="lauxlib.h:116">luaL_checkstring</a>(L, <span class="Constant">2</span>);<br/></li>
<li>&nbsp; <a href="lapi.c.html#L171" title="lapi.c:171">lua_settop</a>(L, <span class="Constant">2</span>);<br/></li>
<li>&nbsp; <a href="lapi.c.html#L464" title="lapi.c:464">lua_pushinteger</a>(L, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; <a href="lapi.c.html#L526" title="lapi.c:526">lua_pushcclosure</a>(L, <a href="#L648" title="lstrlib.c:648">gmatch_aux</a>, <span class="Constant">3</span>);<br/></li>
<li>&nbsp; <span class="Statement">return</span> <span class="Constant">1</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L687">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">add_s</span> (<a href="#L209" title="lstrlib.c:209">MatchState</a> *ms, <a href="lauxlib.h.html#L140" title="lauxlib.h:140">luaL_Buffer</a> *b, <span class="Type">const</span> <span class="Type">char</span> *s,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type">const</span> <span class="Type">char</span> *e) {<br/></li>
<li>&nbsp; <span class="Type">size_t</span> l, i;<br/></li>
<li>&nbsp; <a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L = ms-&gt;L;<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">char</span> *news = <a href="lapi.c.html#L372" title="lapi.c:372">lua_tolstring</a>(L, <span class="Constant">3</span>, &amp;l);<br/></li>
<li>&nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; l; i++) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (news[i] != <a href="#L233" title="lstrlib.c:233">L_ESC</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="lauxlib.h.html#L149" title="lauxlib.h:149">luaL_addchar</a>(b, news[i]);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; i++;&nbsp; <span class="Comment">/* skip ESC */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!isdigit(<a href="#L36" title="lstrlib.c:36">uchar</a>(news[i]))) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (news[i] != <a href="#L233" title="lstrlib.c:233">L_ESC</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lauxlib.c.html#L212" title="lauxlib.c:212">luaL_error</a>(L, <span class="Constant">&quot;invalid use of '</span><span class="Special">%c</span><span class="Constant">' in replacement string&quot;</span>, <a href="#L233" title="lstrlib.c:233">L_ESC</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lauxlib.h.html#L149" title="lauxlib.h:149">luaL_addchar</a>(b, news[i]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (news[i] == <span class="Constant">'0'</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lauxlib.c.html#L470" title="lauxlib.c:470">luaL_addlstring</a>(b, s, e - s);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L545" title="lstrlib.c:545">push_onecapture</a>(ms, news[i] - <span class="Constant">'1'</span>, s, e);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lauxlib.c.html#L748" title="lauxlib.c:748">luaL_tolstring</a>(L, -<span class="Constant">1</span>, <span class="Constant">NULL</span>);&nbsp; <span class="Comment">/* if number, convert it to string */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lua.h.html#L370" title="lua.h:370">lua_remove</a>(L, -<span class="Constant">2</span>);&nbsp; <span class="Comment">/* remove original value */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lauxlib.c.html#L496" title="lauxlib.c:496">luaL_addvalue</a>(b);&nbsp; <span class="Comment">/* add capture to accumulated result */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L715">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">add_value</span> (<a href="#L209" title="lstrlib.c:209">MatchState</a> *ms, <a href="lauxlib.h.html#L140" title="lauxlib.h:140">luaL_Buffer</a> *b, <span class="Type">const</span> <span class="Type">char</span> *s,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type">const</span> <span class="Type">char</span> *e, <span class="Type">int</span> tr) {<br/></li>
<li>&nbsp; <a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L = ms-&gt;L;<br/></li>
<li>&nbsp; <span class="Statement">switch</span> (tr) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="lua.h.html#L68" title="lua.h:68">LUA_TFUNCTION</a>: {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Type">int</span> n;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="lapi.c.html#L236" title="lapi.c:236">lua_pushvalue</a>(L, <span class="Constant">3</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; n = <a href="#L564" title="lstrlib.c:564">push_captures</a>(ms, s, e);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="lua.h.html#L272" title="lua.h:272">lua_call</a>(L, n, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="lua.h.html#L67" title="lua.h:67">LUA_TTABLE</a>: {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L545" title="lstrlib.c:545">push_onecapture</a>(ms, <span class="Constant">0</span>, s, e);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="lapi.c.html#L593" title="lapi.c:593">lua_gettable</a>(L, <span class="Constant">3</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:</span> {&nbsp; <span class="Comment">/* <a href="lua.h.html#L65" title="lua.h:65">LUA_TNUMBER</a> or <a href="lua.h.html#L66" title="lua.h:66">LUA_TSTRING</a> */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <a href="#L687" title="lstrlib.c:687">add_s</a>(ms, b, s, e);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">if</span> (!<a href="lapi.c.html#L366" title="lapi.c:366">lua_toboolean</a>(L, -<span class="Constant">1</span>)) {&nbsp; <span class="Comment">/* nil or false? */<br/></li>
<li></span>&nbsp; &nbsp; <a href="lua.h.html#L342" title="lua.h:342">lua_pop</a>(L, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="lapi.c.html#L472" title="lapi.c:472">lua_pushlstring</a>(L, s, e - s);&nbsp; <span class="Comment">/* keep original text */<br/></li>
<li></span>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (!<a href="lapi.c.html#L282" title="lapi.c:282">lua_isstring</a>(L, -<span class="Constant">1</span>))<br/></li>
<li>&nbsp; &nbsp; <a href="lauxlib.c.html#L212" title="lauxlib.c:212">luaL_error</a>(L, <span class="Constant">&quot;invalid replacement value (a </span><span class="Special">%s</span><span class="Constant">)&quot;</span>, <a href="lauxlib.h.html#L119" title="lauxlib.h:119">luaL_typename</a>(L, -<span class="Constant">1</span>));<br/></li>
<li>&nbsp; <a href="lauxlib.c.html#L496" title="lauxlib.c:496">luaL_addvalue</a>(b);&nbsp; <span class="Comment">/* add result to accumulator */<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L746">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">str_gsub</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <span class="Type">size_t</span> srcl, lp;<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">char</span> *src = <a href="lauxlib.c.html#L374" title="lauxlib.c:374">luaL_checklstring</a>(L, <span class="Constant">1</span>, &amp;srcl);<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">char</span> *p = <a href="lauxlib.c.html#L374" title="lauxlib.c:374">luaL_checklstring</a>(L, <span class="Constant">2</span>, &amp;lp);<br/></li>
<li>&nbsp; <span class="Type">int</span> tr = <a href="lapi.c.html#L250" title="lapi.c:250">lua_type</a>(L, <span class="Constant">3</span>);<br/></li>
<li>&nbsp; <a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a> max_s = <a href="lauxlib.c.html#L424" title="lauxlib.c:424">luaL_optinteger</a>(L, <span class="Constant">4</span>, srcl + <span class="Constant">1</span>);<br/></li>
<li>&nbsp; <span class="Type">int</span> anchor = (*p == <span class="Constant">'^'</span>);<br/></li>
<li>&nbsp; <a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a> n = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; <a href="#L209" title="lstrlib.c:209">MatchState</a> ms;<br/></li>
<li>&nbsp; <a href="lauxlib.h.html#L140" title="lauxlib.h:140">luaL_Buffer</a> b;<br/></li>
<li>&nbsp; <a href="lauxlib.h.html#L114" title="lauxlib.h:114">luaL_argcheck</a>(L, tr == <a href="lua.h.html#L65" title="lua.h:65">LUA_TNUMBER</a> || tr == <a href="lua.h.html#L66" title="lua.h:66">LUA_TSTRING</a> ||<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; tr == <a href="lua.h.html#L68" title="lua.h:68">LUA_TFUNCTION</a> || tr == <a href="lua.h.html#L67" title="lua.h:67">LUA_TTABLE</a>, <span class="Constant">3</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;string/function/table expected&quot;</span>);<br/></li>
<li>&nbsp; <a href="lauxlib.c.html#L507" title="lauxlib.c:507">luaL_buffinit</a>(L, &amp;b);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (anchor) {<br/></li>
<li>&nbsp; &nbsp; p++; lp--;&nbsp; <span class="Comment">/* skip anchor character */<br/></li>
<li></span>&nbsp; }<br/></li>
<li>&nbsp; ms.L = L;<br/></li>
<li>&nbsp; ms.matchdepth = <a href="#L229" title="lstrlib.c:229">MAXCCALLS</a>;<br/></li>
<li>&nbsp; ms.src_init = src;<br/></li>
<li>&nbsp; ms.src_end = src+srcl;<br/></li>
<li>&nbsp; ms.p_end = p + lp;<br/></li>
<li>&nbsp; <span class="Statement">while</span> (n &lt; max_s) {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span> *e;<br/></li>
<li>&nbsp; &nbsp; ms.level = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; <a href="lualib.h.html#L54" title="lualib.h:54">lua_assert</a>(ms.matchdepth == <a href="#L229" title="lstrlib.c:229">MAXCCALLS</a>);<br/></li>
<li>&nbsp; &nbsp; e = <a href="#L420" title="lstrlib.c:420">match</a>(&amp;ms, src, p);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (e) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; n++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L715" title="lstrlib.c:715">add_value</a>(&amp;ms, &amp;b, src, e, tr);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (e &amp;&amp; e&gt;src) <span class="Comment">/* non empty <a href="#L420" title="lstrlib.c:420">match</a>? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; src = e;&nbsp; <span class="Comment">/* skip it */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (src &lt; ms.src_end)<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="lauxlib.h.html#L149" title="lauxlib.h:149">luaL_addchar</a>(&amp;b, *src++);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (anchor) <span class="Statement">break</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <a href="lauxlib.c.html#L470" title="lauxlib.c:470">luaL_addlstring</a>(&amp;b, src, ms.src_end-src);<br/></li>
<li>&nbsp; <a href="lauxlib.c.html#L482" title="lauxlib.c:482">luaL_pushresult</a>(&amp;b);<br/></li>
<li>&nbsp; <a href="lapi.c.html#L464" title="lapi.c:464">lua_pushinteger</a>(L, n);&nbsp; <span class="Comment">/* number of substitutions */<br/></li>
<li></span>&nbsp; <span class="Statement">return</span> <span class="Constant">2</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* }====================================================== */<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** {======================================================<br/></li>
<li></span><span class="Comment">** STRING FORMAT<br/></li>
<li></span><span class="Comment">** =======================================================<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li></span><br/></li>
<li><span class="Comment">/* maximum size of each formatted item (&gt; len(format('%99.99f', -1e308))) */<br/></li>
<li><a id="L801">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">MAX_ITEM</span>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">512<br/></li>
<li></span><br/></li>
<li><span class="Comment">/* valid flags in a format specification */<br/></li>
<li><a id="L804">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">FLAGS</span>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">&quot;-+ #0&quot;<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** maximum size of each format specification (such as &quot;%-099.99d&quot;)<br/></li>
<li></span><span class="Comment">** (+2 for length modifiers; +10 accounts for %99.99x plus margin of <a href="lundump.c.html#L40" title="lundump.c:40">error</a>)<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L810">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">MAX_FORMAT</span>&nbsp; &nbsp; &nbsp; &nbsp; (</span><span class="Statement">sizeof</span><span class="PreProc">(<a href="#L804" title="lstrlib.c:804">FLAGS</a>) + </span><span class="Constant">2</span><span class="PreProc"> + </span><span class="Constant">10</span><span class="PreProc">)<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><a id="L813">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">addquoted</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <a href="lauxlib.h.html#L140" title="lauxlib.h:140">luaL_Buffer</a> *b, <span class="Type">int</span> arg) {<br/></li>
<li>&nbsp; <span class="Type">size_t</span> l;<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">char</span> *s = <a href="lauxlib.c.html#L374" title="lauxlib.c:374">luaL_checklstring</a>(L, arg, &amp;l);<br/></li>
<li>&nbsp; <a href="lauxlib.h.html#L149" title="lauxlib.h:149">luaL_addchar</a>(b, <span class="Constant">'&quot;'</span>);<br/></li>
<li>&nbsp; <span class="Statement">while</span> (l--) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (*s == <span class="Constant">'&quot;'</span> || *s == <span class="Special">'\\'</span> || *s == <span class="Special">'\n'</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="lauxlib.h.html#L149" title="lauxlib.h:149">luaL_addchar</a>(b, <span class="Special">'\\'</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="lauxlib.h.html#L149" title="lauxlib.h:149">luaL_addchar</a>(b, *s);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (*s == <span class="Special">'\0'</span> || iscntrl(<a href="#L36" title="lstrlib.c:36">uchar</a>(*s))) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Type">char</span> buff[<span class="Constant">10</span>];<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!isdigit(<a href="#L36" title="lstrlib.c:36">uchar</a>(*(s+<span class="Constant">1</span>))))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; sprintf(buff, <span class="Constant">&quot;</span><span class="Special">\\%d</span><span class="Constant">&quot;</span>, (<span class="Type">int</span>)<a href="#L36" title="lstrlib.c:36">uchar</a>(*s));<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; sprintf(buff, <span class="Constant">&quot;</span><span class="Special">\\%03d</span><span class="Constant">&quot;</span>, (<span class="Type">int</span>)<a href="#L36" title="lstrlib.c:36">uchar</a>(*s));<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="lauxlib.c.html#L477" title="lauxlib.c:477">luaL_addstring</a>(b, buff);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <a href="lauxlib.h.html#L149" title="lauxlib.h:149">luaL_addchar</a>(b, *s);<br/></li>
<li>&nbsp; &nbsp; s++;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <a href="lauxlib.h.html#L149" title="lauxlib.h:149">luaL_addchar</a>(b, <span class="Constant">'&quot;'</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L837">&#x200c;</a><span class="Type">static</span> <span class="Type">const</span> <span class="Type">char</span> *<span class="linkable">scanformat</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">const</span> <span class="Type">char</span> *strfrmt, <span class="Type">char</span> *form) {<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">char</span> *p = strfrmt;<br/></li>
<li>&nbsp; <span class="Statement">while</span> (*p != <span class="Special">'\0'</span> &amp;&amp; strchr(<a href="#L804" title="lstrlib.c:804">FLAGS</a>, *p) != <span class="Constant">NULL</span>) p++;&nbsp; <span class="Comment">/* skip flags */<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> ((<span class="Type">size_t</span>)(p - strfrmt) &gt;= <span class="Statement">sizeof</span>(<a href="#L804" title="lstrlib.c:804">FLAGS</a>)/<span class="Statement">sizeof</span>(<span class="Type">char</span>))<br/></li>
<li>&nbsp; &nbsp; <a href="lauxlib.c.html#L212" title="lauxlib.c:212">luaL_error</a>(L, <span class="Constant">&quot;invalid format (repeated flags)&quot;</span>);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (isdigit(<a href="#L36" title="lstrlib.c:36">uchar</a>(*p))) p++;&nbsp; <span class="Comment">/* skip width */<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (isdigit(<a href="#L36" title="lstrlib.c:36">uchar</a>(*p))) p++;&nbsp; <span class="Comment">/* (2 digits at most) */<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (*p == <span class="Constant">'.'</span>) {<br/></li>
<li>&nbsp; &nbsp; p++;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (isdigit(<a href="#L36" title="lstrlib.c:36">uchar</a>(*p))) p++;&nbsp; <span class="Comment">/* skip precision */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (isdigit(<a href="#L36" title="lstrlib.c:36">uchar</a>(*p))) p++;&nbsp; <span class="Comment">/* (2 digits at most) */<br/></li>
<li></span>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">if</span> (isdigit(<a href="#L36" title="lstrlib.c:36">uchar</a>(*p)))<br/></li>
<li>&nbsp; &nbsp; <a href="lauxlib.c.html#L212" title="lauxlib.c:212">luaL_error</a>(L, <span class="Constant">&quot;invalid format (width or precision too long)&quot;</span>);<br/></li>
<li>&nbsp; *(form++) = <span class="Constant">'%'</span>;<br/></li>
<li>&nbsp; memcpy(form, strfrmt, (p - strfrmt + <span class="Constant">1</span>) * <span class="Statement">sizeof</span>(<span class="Type">char</span>));<br/></li>
<li>&nbsp; form += p - strfrmt + <span class="Constant">1</span>;<br/></li>
<li>&nbsp; *form = <span class="Special">'\0'</span>;<br/></li>
<li>&nbsp; <span class="Statement">return</span> p;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** add length modifier into formats<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L862">&#x200c;</a></span><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">addlenmod</span> (<span class="Type">char</span> *form, <span class="Type">const</span> <span class="Type">char</span> *lenmod) {<br/></li>
<li>&nbsp; <span class="Type">size_t</span> l = strlen(form);<br/></li>
<li>&nbsp; <span class="Type">size_t</span> lm = strlen(lenmod);<br/></li>
<li>&nbsp; <span class="Type">char</span> spec = form[l - <span class="Constant">1</span>];<br/></li>
<li>&nbsp; strcpy(form + l - <span class="Constant">1</span>, lenmod);<br/></li>
<li>&nbsp; form[l + lm - <span class="Constant">1</span>] = spec;<br/></li>
<li>&nbsp; form[l + lm] = <span class="Special">'\0'</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L872">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">str_format</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <span class="Type">int</span> top = <a href="lapi.c.html#L166" title="lapi.c:166">lua_gettop</a>(L);<br/></li>
<li>&nbsp; <span class="Type">int</span> arg = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; <span class="Type">size_t</span> sfl;<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">char</span> *strfrmt = <a href="lauxlib.c.html#L374" title="lauxlib.c:374">luaL_checklstring</a>(L, arg, &amp;sfl);<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">char</span> *strfrmt_end = strfrmt+sfl;<br/></li>
<li>&nbsp; <a href="lauxlib.h.html#L140" title="lauxlib.h:140">luaL_Buffer</a> b;<br/></li>
<li>&nbsp; <a href="lauxlib.c.html#L507" title="lauxlib.c:507">luaL_buffinit</a>(L, &amp;b);<br/></li>
<li>&nbsp; <span class="Statement">while</span> (strfrmt &lt; strfrmt_end) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (*strfrmt != <a href="#L233" title="lstrlib.c:233">L_ESC</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="lauxlib.h.html#L149" title="lauxlib.h:149">luaL_addchar</a>(&amp;b, *strfrmt++);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (*++strfrmt == <a href="#L233" title="lstrlib.c:233">L_ESC</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="lauxlib.h.html#L149" title="lauxlib.h:149">luaL_addchar</a>(&amp;b, *strfrmt++);&nbsp; <span class="Comment">/* %% */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">else</span> { <span class="Comment">/* format item */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Type">char</span> form[<a href="#L810" title="lstrlib.c:810">MAX_FORMAT</a>];&nbsp; <span class="Comment">/* to store the format ('%...') */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Type">char</span> *buff = <a href="lauxlib.c.html#L448" title="lauxlib.c:448">luaL_prepbuffsize</a>(&amp;b, <a href="#L801" title="lstrlib.c:801">MAX_ITEM</a>);&nbsp; <span class="Comment">/* to put formatted item */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Type">int</span> nb = <span class="Constant">0</span>;&nbsp; <span class="Comment">/* number of bytes in added item */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (++arg &gt; top)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lauxlib.c.html#L162" title="lauxlib.c:162">luaL_argerror</a>(L, arg, <span class="Constant">&quot;no value&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; strfrmt = <a href="#L837" title="lstrlib.c:837">scanformat</a>(L, strfrmt, form);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (*strfrmt++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'c'</span>: {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; nb = sprintf(buff, form, (<span class="Type">int</span>)<a href="lauxlib.c.html#L414" title="lauxlib.c:414">luaL_checkinteger</a>(L, arg));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'d'</span>: <span class="Statement">case</span> <span class="Constant">'i'</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'o'</span>: <span class="Statement">case</span> <span class="Constant">'u'</span>: <span class="Statement">case</span> <span class="Constant">'x'</span>: <span class="Statement">case</span> <span class="Constant">'X'</span>: {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a> n = <a href="lauxlib.c.html#L414" title="lauxlib.c:414">luaL_checkinteger</a>(L, arg);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L862" title="lstrlib.c:862">addlenmod</a>(form, <a href="luaconf.h.html#L544" title="luaconf.h:544">LUA_INTEGER_FRMLEN</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; nb = sprintf(buff, form, n);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#if defined(<a href="luaconf.h.html#L616" title="luaconf.h:616">LUA_USE_AFORMAT</a>)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'a'</span>: <span class="Statement">case</span> <span class="Constant">'A'</span>:<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'e'</span>: <span class="Statement">case</span> <span class="Constant">'E'</span>: <span class="Statement">case</span> <span class="Constant">'f'</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'g'</span>: <span class="Statement">case</span> <span class="Constant">'<a href="lstate.h.html#L175" title="lstate.h:175">G</a>'</span>: {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L862" title="lstrlib.c:862">addlenmod</a>(form, <a href="luaconf.h.html#L409" title="luaconf.h:409">LUA_NUMBER_FRMLEN</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; nb = sprintf(buff, form, <a href="lauxlib.c.html#L392" title="lauxlib.c:392">luaL_checknumber</a>(L, arg));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'q'</span>: {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L813" title="lstrlib.c:813">addquoted</a>(L, &amp;b, arg);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'s'</span>: {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">size_t</span> l;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span> *s = <a href="lauxlib.c.html#L748" title="lauxlib.c:748">luaL_tolstring</a>(L, arg, &amp;l);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!strchr(form, <span class="Constant">'.'</span>) &amp;&amp; l &gt;= <span class="Constant">100</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* no precision and string is too long to be formatted;<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; keep original string */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lauxlib.c.html#L496" title="lauxlib.c:496">luaL_addvalue</a>(&amp;b);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; nb = sprintf(buff, form, s);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lua.h.html#L342" title="lua.h:342">lua_pop</a>(L, <span class="Constant">1</span>);&nbsp; <span class="Comment">/* remove result from '<a href="lauxlib.c.html#L748" title="lauxlib.c:748">luaL_tolstring</a>' */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:</span> {&nbsp; <span class="Comment">/* also treat cases 'pnLlh' */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="lauxlib.c.html#L212" title="lauxlib.c:212">luaL_error</a>(L, <span class="Constant">&quot;invalid option '</span><span class="Special">%%%c</span><span class="Constant">' to 'format'&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *(strfrmt - <span class="Constant">1</span>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="lauxlib.h.html#L153" title="lauxlib.h:153">luaL_addsize</a>(&amp;b, nb);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <a href="lauxlib.c.html#L482" title="lauxlib.c:482">luaL_pushresult</a>(&amp;b);<br/></li>
<li>&nbsp; <span class="Statement">return</span> <span class="Constant">1</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* }====================================================== */<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** {======================================================<br/></li>
<li></span><span class="Comment">** PACK/UNPACK<br/></li>
<li></span><span class="Comment">** =======================================================<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Comment">/* value used for padding */<br/></li>
<li></span><span class="PreProc">#if !defined(<a href="#L956" title="lstrlib.c:956">LUA_PACKPADBYTE</a>)<br/></li>
<li><a id="L956">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">LUA_PACKPADBYTE</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">0x00<br/></li>
<li></span><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="Comment">/* maximum size for the binary representation of an integer */<br/></li>
<li><a id="L960">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">MAXINTSIZE</span>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">16<br/></li>
<li></span><br/></li>
<li><span class="Comment">/* number of bits in a character */<br/></li>
<li><a id="L963">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NB</span>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">CHAR_BIT<br/></li>
<li></span><br/></li>
<li><span class="Comment">/* <a href="lbitlib.c.html#L41" title="lbitlib.c:41">mask</a> for one character (<a href="#L963" title="lstrlib.c:963">NB</a> 1's) */<br/></li>
<li><a id="L966">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">MC</span>&nbsp; &nbsp; &nbsp; &nbsp; ((</span><span class="Constant">1</span><span class="PreProc"> &lt;&lt; <a href="#L963" title="lstrlib.c:963">NB</a>) - </span><span class="Constant">1</span><span class="PreProc">)<br/></li>
<li></span><br/></li>
<li><span class="Comment">/* size of a <a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a> */<br/></li>
<li><a id="L969">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">SZINT</span>&nbsp; &nbsp; &nbsp; &nbsp; ((</span><span class="Type">int</span><span class="PreProc">)</span><span class="Statement">sizeof</span><span class="PreProc">(<a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a>))<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Comment">/* dummy union to get native endianness */<br/></li>
<li></span><span class="Type">static</span> <span class="Type">const</span> <span class="Type">union</span> {<br/></li>
<li>&nbsp; <span class="Type">int</span> dummy;<br/></li>
<li>&nbsp; <span class="Type">char</span> little;&nbsp; <span class="Comment">/* true iff machine is little endian */<br/></li>
<li><a id="L976">&#x200c;</a></span>} <span class="linkable">nativeendian</span> = {<span class="Constant">1</span>};<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/* dummy structure to get native alignment requirements */<br/></li>
<li><a id="L980">&#x200c;</a></span><span class="Type">struct</span> <span class="linkable">cD</span> {<br/></li>
<li>&nbsp; <span class="Type">char</span> c;<br/></li>
<li>&nbsp; <span class="Type">union</span> { <span class="Type">double</span> d; <span class="Type">void</span> *p; <a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a> i; <a href="lua.h.html#L87" title="lua.h:87">lua_Number</a> n; } u;<br/></li>
<li>};<br/></li>
<li><br/></li>
<li><a id="L985">&#x200c;</a><span class="PreProc">#define <span class="linkable">MAXALIGN</span>&nbsp; &nbsp; &nbsp; &nbsp; (offsetof(</span><span class="Type">struct</span><span class="PreProc"> <a href="#L980" title="lstrlib.c:980">cD</a>, u))<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** Union for serializing floats<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L991">&#x200c;</a></span><span class="Type">typedef</span> <span class="Type">union</span> <span class="linkable">Ftypes</span> {<br/></li>
<li>&nbsp; <span class="Type">float</span> f;<br/></li>
<li>&nbsp; <span class="Type">double</span> d;<br/></li>
<li>&nbsp; <a href="lua.h.html#L87" title="lua.h:87">lua_Number</a> n;<br/></li>
<li>&nbsp; <span class="Type">char</span> buff[<span class="Constant">5</span> * <span class="Statement">sizeof</span>(<a href="lua.h.html#L87" title="lua.h:87">lua_Number</a>)];&nbsp; <span class="Comment">/* enough for any float type */<br/></li>
<li><a id="L996">&#x200c;</a></span>} <span class="linkable">Ftypes</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** information to <a href="ltablib.c.html#L192" title="ltablib.c:192">pack</a>/<a href="ltablib.c.html#L205" title="ltablib.c:205">unpack</a> stuff<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L1002">&#x200c;</a></span><span class="Type">typedef</span> <span class="Type">struct</span> <span class="linkable">Header</span> {<br/></li>
<li>&nbsp; <a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L;<br/></li>
<li>&nbsp; <span class="Type">int</span> islittle;<br/></li>
<li>&nbsp; <span class="Type">int</span> maxalign;<br/></li>
<li><a id="L1006">&#x200c;</a>} <span class="linkable">Header</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** options for <a href="ltablib.c.html#L192" title="ltablib.c:192">pack</a>/<a href="ltablib.c.html#L205" title="ltablib.c:205">unpack</a><br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L1012">&#x200c;</a></span><span class="Type">typedef</span> <span class="Type">enum</span> <span class="linkable">KOption</span> {<br/></li>
<li>&nbsp; Kint,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* signed integers */<br/></li>
<li></span>&nbsp; Kuint,&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* unsigned integers */<br/></li>
<li></span>&nbsp; Kfloat,&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* floating-point numbers */<br/></li>
<li></span>&nbsp; Kchar,&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* fixed-length strings */<br/></li>
<li></span>&nbsp; Kstring,&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* strings with prefixed length */<br/></li>
<li></span>&nbsp; Kzstr,&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* zero-terminated strings */<br/></li>
<li></span>&nbsp; Kpadding,&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* padding */<br/></li>
<li></span>&nbsp; Kpaddalign,&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* padding for alignment */<br/></li>
<li></span>&nbsp; Knop&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* no-op (configuration or spaces) */<br/></li>
<li><a id="L1022">&#x200c;</a></span>} <span class="linkable">KOption</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** Read an integer numeral from string 'fmt' or return 'df' if<br/></li>
<li></span><span class="Comment">** there is no numeral<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L1029">&#x200c;</a></span><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">digit</span> (<span class="Type">int</span> c) { <span class="Statement">return</span> <span class="Constant">'0'</span> &lt;= c &amp;&amp; c &lt;= <span class="Constant">'9'</span>; }<br/></li>
<li><br/></li>
<li><a id="L1031">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">getnum</span> (<span class="Type">const</span> <span class="Type">char</span> **fmt, <span class="Type">int</span> df) {<br/></li>
<li>&nbsp; <span class="Statement">if</span> (!<a href="#L1029" title="lstrlib.c:1029">digit</a>(**fmt))&nbsp; <span class="Comment">/* no number? */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">return</span> df;&nbsp; <span class="Comment">/* return default value */<br/></li>
<li></span>&nbsp; <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span> a = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">do</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; a = a*<span class="Constant">10</span> + (*((*fmt)++) - <span class="Constant">'0'</span>);<br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">while</span> (<a href="#L1029" title="lstrlib.c:1029">digit</a>(**fmt) &amp;&amp; a &lt;= ((<span class="Type">int</span>)<a href="#L43" title="lstrlib.c:43">MAXSIZE</a> - <span class="Constant">9</span>)/<span class="Constant">10</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> a;<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** Read an integer numeral and raises an <a href="lundump.c.html#L40" title="lundump.c:40">error</a> if it is larger<br/></li>
<li></span><span class="Comment">** than the maximum size for integers.<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L1048">&#x200c;</a></span><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">getnumlimit</span> (<a href="#L1002" title="lstrlib.c:1002">Header</a> *h, <span class="Type">const</span> <span class="Type">char</span> **fmt, <span class="Type">int</span> df) {<br/></li>
<li>&nbsp; <span class="Type">int</span> sz = <a href="#L1031" title="lstrlib.c:1031">getnum</a>(fmt, df);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (sz &gt; <a href="#L960" title="lstrlib.c:960">MAXINTSIZE</a> || sz &lt;= <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; <a href="lauxlib.c.html#L212" title="lauxlib.c:212">luaL_error</a>(h-&gt;L, <span class="Constant">&quot;integral size (</span><span class="Special">%d</span><span class="Constant">) out of limits [1,</span><span class="Special">%d</span><span class="Constant">]&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; sz, <a href="#L960" title="lstrlib.c:960">MAXINTSIZE</a>);<br/></li>
<li>&nbsp; <span class="Statement">return</span> sz;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** Initialize <a href="#L1002" title="lstrlib.c:1002">Header</a><br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L1060">&#x200c;</a></span><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">initheader</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <a href="#L1002" title="lstrlib.c:1002">Header</a> *h) {<br/></li>
<li>&nbsp; h-&gt;L = L;<br/></li>
<li>&nbsp; h-&gt;islittle = <a href="#L976" title="lstrlib.c:976">nativeendian</a>.little;<br/></li>
<li>&nbsp; h-&gt;maxalign = <span class="Constant">1</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** Read and classify <a href="llex.c.html#L31" title="llex.c:31">next</a> option. 'size' is filled with option's size.<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L1070">&#x200c;</a></span><span class="Type">static</span> <a href="#L1012" title="lstrlib.c:1012">KOption</a> <span class="linkable">getoption</span> (<a href="#L1002" title="lstrlib.c:1002">Header</a> *h, <span class="Type">const</span> <span class="Type">char</span> **fmt, <span class="Type">int</span> *size) {<br/></li>
<li>&nbsp; <span class="Type">int</span> opt = *((*fmt)++);<br/></li>
<li>&nbsp; *size = <span class="Constant">0</span>;&nbsp; <span class="Comment">/* default */<br/></li>
<li></span>&nbsp; <span class="Statement">switch</span> (opt) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'b'</span>: *size = <span class="Statement">sizeof</span>(<span class="Type">char</span>); <span class="Statement">return</span> Kint;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'B'</span>: *size = <span class="Statement">sizeof</span>(<span class="Type">char</span>); <span class="Statement">return</span> Kuint;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'h'</span>: *size = <span class="Statement">sizeof</span>(<span class="Type">short</span>); <span class="Statement">return</span> Kint;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'H'</span>: *size = <span class="Statement">sizeof</span>(<span class="Type">short</span>); <span class="Statement">return</span> Kuint;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'l'</span>: *size = <span class="Statement">sizeof</span>(<span class="Type">long</span>); <span class="Statement">return</span> Kint;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'L'</span>: *size = <span class="Statement">sizeof</span>(<span class="Type">long</span>); <span class="Statement">return</span> Kuint;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'j'</span>: *size = <span class="Statement">sizeof</span>(<a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a>); <span class="Statement">return</span> Kint;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'J'</span>: *size = <span class="Statement">sizeof</span>(<a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a>); <span class="Statement">return</span> Kuint;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'T'</span>: *size = <span class="Statement">sizeof</span>(<span class="Type">size_t</span>); <span class="Statement">return</span> Kuint;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'f'</span>: *size = <span class="Statement">sizeof</span>(<span class="Type">float</span>); <span class="Statement">return</span> Kfloat;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'d'</span>: *size = <span class="Statement">sizeof</span>(<span class="Type">double</span>); <span class="Statement">return</span> Kfloat;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'n'</span>: *size = <span class="Statement">sizeof</span>(<a href="lua.h.html#L87" title="lua.h:87">lua_Number</a>); <span class="Statement">return</span> Kfloat;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'i'</span>: *size = <a href="#L1048" title="lstrlib.c:1048">getnumlimit</a>(h, fmt, <span class="Statement">sizeof</span>(<span class="Type">int</span>)); <span class="Statement">return</span> Kint;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'I'</span>: *size = <a href="#L1048" title="lstrlib.c:1048">getnumlimit</a>(h, fmt, <span class="Statement">sizeof</span>(<span class="Type">int</span>)); <span class="Statement">return</span> Kuint;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'s'</span>: *size = <a href="#L1048" title="lstrlib.c:1048">getnumlimit</a>(h, fmt, <span class="Statement">sizeof</span>(<span class="Type">size_t</span>)); <span class="Statement">return</span> Kstring;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'c'</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; *size = <a href="#L1031" title="lstrlib.c:1031">getnum</a>(fmt, -<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (*size == -<span class="Constant">1</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lauxlib.c.html#L212" title="lauxlib.c:212">luaL_error</a>(h-&gt;L, <span class="Constant">&quot;missing size for format option 'c'&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span> Kchar;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'z'</span>: <span class="Statement">return</span> Kzstr;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'x'</span>: *size = <span class="Constant">1</span>; <span class="Statement">return</span> Kpadding;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'X'</span>: <span class="Statement">return</span> Kpaddalign;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">' '</span>: <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'&lt;'</span>: h-&gt;islittle = <span class="Constant">1</span>; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'&gt;'</span>: h-&gt;islittle = <span class="Constant">0</span>; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'='</span>: h-&gt;islittle = <a href="#L976" title="lstrlib.c:976">nativeendian</a>.little; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'!'</span>: h-&gt;maxalign = <a href="#L1048" title="lstrlib.c:1048">getnumlimit</a>(h, fmt, <a href="#L985" title="lstrlib.c:985">MAXALIGN</a>); <span class="Statement">break</span>;<br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:</span> <a href="lauxlib.c.html#L212" title="lauxlib.c:212">luaL_error</a>(h-&gt;L, <span class="Constant">&quot;invalid format option '</span><span class="Special">%c</span><span class="Constant">'&quot;</span>, opt);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> Knop;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** Read, classify, and fill other details about the <a href="llex.c.html#L31" title="llex.c:31">next</a> option.<br/></li>
<li></span><span class="Comment">** 'psize' is filled with option's size, 'notoalign' with its<br/></li>
<li></span><span class="Comment">** alignment requirements.<br/></li>
<li></span><span class="Comment">** Local variable 'size' gets the size to be aligned. (Kpadal option<br/></li>
<li></span><span class="Comment">** always gets its full alignment, other options are limited by<br/></li>
<li></span><span class="Comment">** the maximum alignment ('maxalign'). Kchar option needs no alignment<br/></li>
<li></span><span class="Comment">** despite its size.<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L1117">&#x200c;</a></span><span class="Type">static</span> <a href="#L1012" title="lstrlib.c:1012">KOption</a> <span class="linkable">getdetails</span> (<a href="#L1002" title="lstrlib.c:1002">Header</a> *h, <span class="Type">size_t</span> totalsize,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type">const</span> <span class="Type">char</span> **fmt, <span class="Type">int</span> *psize, <span class="Type">int</span> *ntoalign) {<br/></li>
<li>&nbsp; <a href="#L1012" title="lstrlib.c:1012">KOption</a> opt = <a href="#L1070" title="lstrlib.c:1070">getoption</a>(h, fmt, psize);<br/></li>
<li>&nbsp; <span class="Type">int</span> align = *psize;&nbsp; <span class="Comment">/* usually, alignment follows size */<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (opt == Kpaddalign) {&nbsp; <span class="Comment">/* 'X' gets alignment from following option */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (**fmt == <span class="Special">'\0'</span> || <a href="#L1070" title="lstrlib.c:1070">getoption</a>(h, fmt, &amp;align) == Kchar || align == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="lauxlib.c.html#L162" title="lauxlib.c:162">luaL_argerror</a>(h-&gt;L, <span class="Constant">1</span>, <span class="Constant">&quot;invalid <a href="llex.c.html#L31" title="llex.c:31">next</a> option for option 'X'&quot;</span>);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">if</span> (align &lt;= <span class="Constant">1</span> || opt == Kchar)&nbsp; <span class="Comment">/* need no alignment? */<br/></li>
<li></span>&nbsp; &nbsp; *ntoalign = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (align &gt; h-&gt;maxalign)&nbsp; <span class="Comment">/* enforce maximum alignment */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; align = h-&gt;maxalign;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> ((align &amp; (align - <span class="Constant">1</span>)) != <span class="Constant">0</span>)&nbsp; <span class="Comment">/* is 'align' not a power of 2? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <a href="lauxlib.c.html#L162" title="lauxlib.c:162">luaL_argerror</a>(h-&gt;L, <span class="Constant">1</span>, <span class="Constant">&quot;format asks for alignment not power of 2&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; *ntoalign = (align - (<span class="Type">int</span>)(totalsize &amp; (align - <span class="Constant">1</span>))) &amp; (align - <span class="Constant">1</span>);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> opt;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** Pack integer 'n' with 'size' bytes and 'islittle' endianness.<br/></li>
<li></span><span class="Comment">** The final 'if' handles the case when 'size' is larger than<br/></li>
<li></span><span class="Comment">** the size of a Lua integer, correcting the extra sign-extension<br/></li>
<li></span><span class="Comment">** bytes if necessary (by default they would be zeros).<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L1144">&#x200c;</a></span><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">packint</span> (<a href="lauxlib.h.html#L140" title="lauxlib.h:140">luaL_Buffer</a> *b, <a href="lua.h.html#L94" title="lua.h:94">lua_Unsigned</a> n,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type">int</span> islittle, <span class="Type">int</span> size, <span class="Type">int</span> neg) {<br/></li>
<li>&nbsp; <span class="Type">char</span> *buff = <a href="lauxlib.c.html#L448" title="lauxlib.c:448">luaL_prepbuffsize</a>(b, size);<br/></li>
<li>&nbsp; <span class="Type">int</span> i;<br/></li>
<li>&nbsp; buff[islittle ? <span class="Constant">0</span> : size - <span class="Constant">1</span>] = (<span class="Type">char</span>)(n &amp; <a href="#L966" title="lstrlib.c:966">MC</a>);&nbsp; <span class="Comment">/* first byte */<br/></li>
<li></span>&nbsp; <span class="Statement">for</span> (i = <span class="Constant">1</span>; i &lt; size; i++) {<br/></li>
<li>&nbsp; &nbsp; n &gt;&gt;= <a href="#L963" title="lstrlib.c:963">NB</a>;<br/></li>
<li>&nbsp; &nbsp; buff[islittle ? i : size - <span class="Constant">1</span> - i] = (<span class="Type">char</span>)(n &amp; <a href="#L966" title="lstrlib.c:966">MC</a>);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">if</span> (neg &amp;&amp; size &gt; <a href="#L969" title="lstrlib.c:969">SZINT</a>) {&nbsp; <span class="Comment">/* negative number need sign extension? */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">for</span> (i = <a href="#L969" title="lstrlib.c:969">SZINT</a>; i &lt; size; i++)&nbsp; <span class="Comment">/* correct extra bytes */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; buff[islittle ? i : size - <span class="Constant">1</span> - i] = (<span class="Type">char</span>)<a href="#L966" title="lstrlib.c:966">MC</a>;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <a href="lauxlib.h.html#L153" title="lauxlib.h:153">luaL_addsize</a>(b, size);&nbsp; <span class="Comment">/* add result to buffer */<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** Copy 'size' bytes from 'src' to 'dest', correcting endianness if<br/></li>
<li></span><span class="Comment">** given 'islittle' is different from native endianness.<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L1165">&#x200c;</a></span><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">copywithendian</span> (<span class="Type">volatile</span> <span class="Type">char</span> *dest, <span class="Type">volatile</span> <span class="Type">const</span> <span class="Type">char</span> *src,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> size, <span class="Type">int</span> islittle) {<br/></li>
<li>&nbsp; <span class="Statement">if</span> (islittle == <a href="#L976" title="lstrlib.c:976">nativeendian</a>.little) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (size-- != <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; *(dest++) = *(src++);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; dest += size - <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (size-- != <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; *(dest--) = *(src++);<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L1179">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">str_pack</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <a href="lauxlib.h.html#L140" title="lauxlib.h:140">luaL_Buffer</a> b;<br/></li>
<li>&nbsp; <a href="#L1002" title="lstrlib.c:1002">Header</a> h;<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">char</span> *fmt = <a href="lauxlib.h.html#L116" title="lauxlib.h:116">luaL_checkstring</a>(L, <span class="Constant">1</span>);&nbsp; <span class="Comment">/* format string */<br/></li>
<li></span>&nbsp; <span class="Type">int</span> arg = <span class="Constant">1</span>;&nbsp; <span class="Comment">/* current argument to <a href="ltablib.c.html#L192" title="ltablib.c:192">pack</a> */<br/></li>
<li></span>&nbsp; <span class="Type">size_t</span> totalsize = <span class="Constant">0</span>;&nbsp; <span class="Comment">/* accumulate total size of result */<br/></li>
<li></span>&nbsp; <a href="#L1060" title="lstrlib.c:1060">initheader</a>(L, &amp;h);<br/></li>
<li>&nbsp; <a href="lapi.c.html#L448" title="lapi.c:448">lua_pushnil</a>(L);&nbsp; <span class="Comment">/* mark to separate arguments from string buffer */<br/></li>
<li></span>&nbsp; <a href="lauxlib.c.html#L507" title="lauxlib.c:507">luaL_buffinit</a>(L, &amp;b);<br/></li>
<li>&nbsp; <span class="Statement">while</span> (*fmt != <span class="Special">'\0'</span>) {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span> size, ntoalign;<br/></li>
<li>&nbsp; &nbsp; <a href="#L1012" title="lstrlib.c:1012">KOption</a> opt = <a href="#L1117" title="lstrlib.c:1117">getdetails</a>(&amp;h, totalsize, &amp;fmt, &amp;size, &amp;ntoalign);<br/></li>
<li>&nbsp; &nbsp; totalsize += ntoalign + size;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (ntoalign-- &gt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp;&nbsp; <a href="lauxlib.h.html#L149" title="lauxlib.h:149">luaL_addchar</a>(&amp;b, <a href="#L956" title="lstrlib.c:956">LUA_PACKPADBYTE</a>);&nbsp; <span class="Comment">/* fill alignment */<br/></li>
<li></span>&nbsp; &nbsp; arg++;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">switch</span> (opt) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> Kint: {&nbsp; <span class="Comment">/* signed integers */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a> n = <a href="lauxlib.c.html#L414" title="lauxlib.c:414">luaL_checkinteger</a>(L, arg);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (size &lt; <a href="#L969" title="lstrlib.c:969">SZINT</a>) {&nbsp; <span class="Comment">/* need overflow <a href="lparser.c.html#L106" title="lparser.c:106">check</a>? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a> lim = (<a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a>)<span class="Constant">1</span> &lt;&lt; ((size * <a href="#L963" title="lstrlib.c:963">NB</a>) - <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lauxlib.h.html#L114" title="lauxlib.h:114">luaL_argcheck</a>(L, -lim &lt;= n &amp;&amp; n &lt; lim, arg, <span class="Constant">&quot;integer overflow&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1144" title="lstrlib.c:1144">packint</a>(&amp;b, (<a href="lua.h.html#L94" title="lua.h:94">lua_Unsigned</a>)n, h.islittle, size, (n &lt; <span class="Constant">0</span>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> Kuint: {&nbsp; <span class="Comment">/* unsigned integers */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a> n = <a href="lauxlib.c.html#L414" title="lauxlib.c:414">luaL_checkinteger</a>(L, arg);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (size &lt; <a href="#L969" title="lstrlib.c:969">SZINT</a>)&nbsp; <span class="Comment">/* need overflow <a href="lparser.c.html#L106" title="lparser.c:106">check</a>? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lauxlib.h.html#L114" title="lauxlib.h:114">luaL_argcheck</a>(L, (<a href="lua.h.html#L94" title="lua.h:94">lua_Unsigned</a>)n &lt; ((<a href="lua.h.html#L94" title="lua.h:94">lua_Unsigned</a>)<span class="Constant">1</span> &lt;&lt; (size * <a href="#L963" title="lstrlib.c:963">NB</a>)),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; arg, <span class="Constant">&quot;unsigned overflow&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1144" title="lstrlib.c:1144">packint</a>(&amp;b, (<a href="lua.h.html#L94" title="lua.h:94">lua_Unsigned</a>)n, h.islittle, size, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> Kfloat: {&nbsp; <span class="Comment">/* floating-point options */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">volatile</span> <a href="#L991" title="lstrlib.c:991">Ftypes</a> u;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">char</span> *buff = <a href="lauxlib.c.html#L448" title="lauxlib.c:448">luaL_prepbuffsize</a>(&amp;b, size);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lua.h.html#L87" title="lua.h:87">lua_Number</a> n = <a href="lauxlib.c.html#L392" title="lauxlib.c:392">luaL_checknumber</a>(L, arg);&nbsp; <span class="Comment">/* get argument */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (size == <span class="Statement">sizeof</span>(u.f)) u.f = (<span class="Type">float</span>)n;&nbsp; <span class="Comment">/* copy it into 'u' */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (size == <span class="Statement">sizeof</span>(u.d)) u.d = (<span class="Type">double</span>)n;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else</span> u.n = n;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* move 'u' to final result, correcting endianness if needed */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1165" title="lstrlib.c:1165">copywithendian</a>(buff, u.buff, size, h.islittle);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lauxlib.h.html#L153" title="lauxlib.h:153">luaL_addsize</a>(&amp;b, size);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> Kchar: {&nbsp; <span class="Comment">/* fixed-size string */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">size_t</span> len;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span> *s = <a href="lauxlib.c.html#L374" title="lauxlib.c:374">luaL_checklstring</a>(L, arg, &amp;len);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lauxlib.h.html#L114" title="lauxlib.h:114">luaL_argcheck</a>(L, len == (<span class="Type">size_t</span>)size, arg, <span class="Constant">&quot;wrong length&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lauxlib.c.html#L470" title="lauxlib.c:470">luaL_addlstring</a>(&amp;b, s, size);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> Kstring: {&nbsp; <span class="Comment">/* strings with length count */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">size_t</span> len;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span> *s = <a href="lauxlib.c.html#L374" title="lauxlib.c:374">luaL_checklstring</a>(L, arg, &amp;len);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lauxlib.h.html#L114" title="lauxlib.h:114">luaL_argcheck</a>(L, size &gt;= (<span class="Type">int</span>)<span class="Statement">sizeof</span>(<span class="Type">size_t</span>) ||<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; len &lt; ((<span class="Type">size_t</span>)<span class="Constant">1</span> &lt;&lt; (size * <a href="#L963" title="lstrlib.c:963">NB</a>)),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; arg, <span class="Constant">&quot;string length does not fit in given size&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1144" title="lstrlib.c:1144">packint</a>(&amp;b, (<a href="lua.h.html#L94" title="lua.h:94">lua_Unsigned</a>)len, h.islittle, size, <span class="Constant">0</span>);&nbsp; <span class="Comment">/* <a href="ltablib.c.html#L192" title="ltablib.c:192">pack</a> length */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lauxlib.c.html#L470" title="lauxlib.c:470">luaL_addlstring</a>(&amp;b, s, len);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; totalsize += len;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> Kzstr: {&nbsp; <span class="Comment">/* zero-terminated string */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">size_t</span> len;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span> *s = <a href="lauxlib.c.html#L374" title="lauxlib.c:374">luaL_checklstring</a>(L, arg, &amp;len);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lauxlib.h.html#L114" title="lauxlib.h:114">luaL_argcheck</a>(L, strlen(s) == len, arg, <span class="Constant">&quot;string contains zeros&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lauxlib.c.html#L470" title="lauxlib.c:470">luaL_addlstring</a>(&amp;b, s, len);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lauxlib.h.html#L149" title="lauxlib.h:149">luaL_addchar</a>(&amp;b, <span class="Special">'\0'</span>);&nbsp; <span class="Comment">/* add zero at the end */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; totalsize += len + <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> Kpadding: <a href="lauxlib.h.html#L149" title="lauxlib.h:149">luaL_addchar</a>(&amp;b, <a href="#L956" title="lstrlib.c:956">LUA_PACKPADBYTE</a>);&nbsp; <span class="Comment">/* go through */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> Kpaddalign: <span class="Statement">case</span> Knop:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; arg--;&nbsp; <span class="Comment">/* undo increment */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <a href="lauxlib.c.html#L482" title="lauxlib.c:482">luaL_pushresult</a>(&amp;b);<br/></li>
<li>&nbsp; <span class="Statement">return</span> <span class="Constant">1</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L1263">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">str_packsize</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <a href="#L1002" title="lstrlib.c:1002">Header</a> h;<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">char</span> *fmt = <a href="lauxlib.h.html#L116" title="lauxlib.h:116">luaL_checkstring</a>(L, <span class="Constant">1</span>);&nbsp; <span class="Comment">/* format string */<br/></li>
<li></span>&nbsp; <span class="Type">size_t</span> totalsize = <span class="Constant">0</span>;&nbsp; <span class="Comment">/* accumulate total size of result */<br/></li>
<li></span>&nbsp; <a href="#L1060" title="lstrlib.c:1060">initheader</a>(L, &amp;h);<br/></li>
<li>&nbsp; <span class="Statement">while</span> (*fmt != <span class="Special">'\0'</span>) {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span> size, ntoalign;<br/></li>
<li>&nbsp; &nbsp; <a href="#L1012" title="lstrlib.c:1012">KOption</a> opt = <a href="#L1117" title="lstrlib.c:1117">getdetails</a>(&amp;h, totalsize, &amp;fmt, &amp;size, &amp;ntoalign);<br/></li>
<li>&nbsp; &nbsp; size += ntoalign;&nbsp; <span class="Comment">/* total space used by option */<br/></li>
<li></span>&nbsp; &nbsp; <a href="lauxlib.h.html#L114" title="lauxlib.h:114">luaL_argcheck</a>(L, totalsize &lt;= <a href="#L43" title="lstrlib.c:43">MAXSIZE</a> - size, <span class="Constant">1</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;format result too large&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; totalsize += size;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">switch</span> (opt) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> Kstring:&nbsp; <span class="Comment">/* strings with length count */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> Kzstr:&nbsp; &nbsp; <span class="Comment">/* zero-terminated string */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lauxlib.c.html#L162" title="lauxlib.c:162">luaL_argerror</a>(L, <span class="Constant">1</span>, <span class="Constant">&quot;variable-length format&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:</span>&nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <a href="lapi.c.html#L464" title="lapi.c:464">lua_pushinteger</a>(L, (<a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a>)totalsize);<br/></li>
<li>&nbsp; <span class="Statement">return</span> <span class="Constant">1</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** Unpack an integer with 'size' bytes and 'islittle' endianness.<br/></li>
<li></span><span class="Comment">** If size is smaller than the size of a Lua integer and integer<br/></li>
<li></span><span class="Comment">** is signed, must do sign extension (propagating the sign to the<br/></li>
<li></span><span class="Comment">** higher bits); if size is larger than the size of a Lua integer,<br/></li>
<li></span><span class="Comment">** it must <a href="lparser.c.html#L106" title="lparser.c:106">check</a> the unread bytes to see whether they do not cause an<br/></li>
<li></span><span class="Comment">** overflow.<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L1296">&#x200c;</a></span><span class="Type">static</span> <a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a> <span class="linkable">unpackint</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">const</span> <span class="Type">char</span> *str,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> islittle, <span class="Type">int</span> size, <span class="Type">int</span> issigned) {<br/></li>
<li>&nbsp; <a href="lua.h.html#L94" title="lua.h:94">lua_Unsigned</a> res = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; <span class="Type">int</span> i;<br/></li>
<li>&nbsp; <span class="Type">int</span> limit = (size&nbsp; &lt;= <a href="#L969" title="lstrlib.c:969">SZINT</a>) ? size : <a href="#L969" title="lstrlib.c:969">SZINT</a>;<br/></li>
<li>&nbsp; <span class="Statement">for</span> (i = limit - <span class="Constant">1</span>; i &gt;= <span class="Constant">0</span>; i--) {<br/></li>
<li>&nbsp; &nbsp; res &lt;&lt;= <a href="#L963" title="lstrlib.c:963">NB</a>;<br/></li>
<li>&nbsp; &nbsp; res |= (<a href="lua.h.html#L94" title="lua.h:94">lua_Unsigned</a>)(<span class="Type">unsigned</span> <span class="Type">char</span>)str[islittle ? i : size - <span class="Constant">1</span> - i];<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">if</span> (size &lt; <a href="#L969" title="lstrlib.c:969">SZINT</a>) {&nbsp; <span class="Comment">/* real size smaller than <a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a>? */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (issigned) {&nbsp; <span class="Comment">/* needs sign extension? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <a href="lua.h.html#L94" title="lua.h:94">lua_Unsigned</a> <a href="lbitlib.c.html#L41" title="lbitlib.c:41">mask</a> = (<a href="lua.h.html#L94" title="lua.h:94">lua_Unsigned</a>)<span class="Constant">1</span> &lt;&lt; (size*<a href="#L963" title="lstrlib.c:963">NB</a> - <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; res = ((res ^ <a href="lbitlib.c.html#L41" title="lbitlib.c:41">mask</a>) - <a href="lbitlib.c.html#L41" title="lbitlib.c:41">mask</a>);&nbsp; <span class="Comment">/* do sign extension */<br/></li>
<li></span>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (size &gt; <a href="#L969" title="lstrlib.c:969">SZINT</a>) {&nbsp; <span class="Comment">/* must <a href="lparser.c.html#L106" title="lparser.c:106">check</a> unread bytes */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">int</span> <a href="lbitlib.c.html#L41" title="lbitlib.c:41">mask</a> = (!issigned || (<a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a>)res &gt;= <span class="Constant">0</span>) ? <span class="Constant">0</span> : <a href="#L966" title="lstrlib.c:966">MC</a>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = limit; i &lt; size; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((<span class="Type">unsigned</span> <span class="Type">char</span>)str[islittle ? i : size - <span class="Constant">1</span> - i] != <a href="lbitlib.c.html#L41" title="lbitlib.c:41">mask</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lauxlib.c.html#L212" title="lauxlib.c:212">luaL_error</a>(L, <span class="Constant">&quot;</span><span class="Special">%d</span><span class="Constant">-byte integer does not fit into Lua Integer&quot;</span>, size);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> (<a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a>)res;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L1322">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">str_unpack</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <a href="#L1002" title="lstrlib.c:1002">Header</a> h;<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">char</span> *fmt = <a href="lauxlib.h.html#L116" title="lauxlib.h:116">luaL_checkstring</a>(L, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; <span class="Type">size_t</span> ld;<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">char</span> *data = <a href="lauxlib.c.html#L374" title="lauxlib.c:374">luaL_checklstring</a>(L, <span class="Constant">2</span>, &amp;ld);<br/></li>
<li>&nbsp; <span class="Type">size_t</span> pos = (<span class="Type">size_t</span>)<a href="#L58" title="lstrlib.c:58">posrelat</a>(<a href="lauxlib.c.html#L424" title="lauxlib.c:424">luaL_optinteger</a>(L, <span class="Constant">3</span>, <span class="Constant">1</span>), ld) - <span class="Constant">1</span>;<br/></li>
<li>&nbsp; <span class="Type">int</span> n = <span class="Constant">0</span>;&nbsp; <span class="Comment">/* number of results */<br/></li>
<li></span>&nbsp; <a href="lauxlib.h.html#L114" title="lauxlib.h:114">luaL_argcheck</a>(L, pos &lt;= ld, <span class="Constant">3</span>, <span class="Constant">&quot;initial position out of string&quot;</span>);<br/></li>
<li>&nbsp; <a href="#L1060" title="lstrlib.c:1060">initheader</a>(L, &amp;h);<br/></li>
<li>&nbsp; <span class="Statement">while</span> (*fmt != <span class="Special">'\0'</span>) {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span> size, ntoalign;<br/></li>
<li>&nbsp; &nbsp; <a href="#L1012" title="lstrlib.c:1012">KOption</a> opt = <a href="#L1117" title="lstrlib.c:1117">getdetails</a>(&amp;h, pos, &amp;fmt, &amp;size, &amp;ntoalign);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> ((<span class="Type">size_t</span>)ntoalign + size &gt; ~pos || pos + ntoalign + size &gt; ld)<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="lauxlib.c.html#L162" title="lauxlib.c:162">luaL_argerror</a>(L, <span class="Constant">2</span>, <span class="Constant">&quot;data string too short&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; pos += ntoalign;&nbsp; <span class="Comment">/* skip alignment */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">/* stack space for item + <a href="llex.c.html#L31" title="llex.c:31">next</a> position */<br/></li>
<li></span>&nbsp; &nbsp; <a href="lauxlib.c.html#L350" title="lauxlib.c:350">luaL_checkstack</a>(L, <span class="Constant">2</span>, <span class="Constant">&quot;too many results&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; n++;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">switch</span> (opt) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> Kint:<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> Kuint: {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a> res = <a href="#L1296" title="lstrlib.c:1296">unpackint</a>(L, data + pos, h.islittle, size,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (opt == Kint));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lapi.c.html#L464" title="lapi.c:464">lua_pushinteger</a>(L, res);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> Kfloat: {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">volatile</span> <a href="#L991" title="lstrlib.c:991">Ftypes</a> u;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lua.h.html#L87" title="lua.h:87">lua_Number</a> num;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1165" title="lstrlib.c:1165">copywithendian</a>(u.buff, data + pos, size, h.islittle);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (size == <span class="Statement">sizeof</span>(u.f)) num = (<a href="lua.h.html#L87" title="lua.h:87">lua_Number</a>)u.f;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (size == <span class="Statement">sizeof</span>(u.d)) num = (<a href="lua.h.html#L87" title="lua.h:87">lua_Number</a>)u.d;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else</span> num = u.n;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lapi.c.html#L456" title="lapi.c:456">lua_pushnumber</a>(L, num);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> Kchar: {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lapi.c.html#L472" title="lapi.c:472">lua_pushlstring</a>(L, data + pos, size);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> Kstring: {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">size_t</span> len = (<span class="Type">size_t</span>)<a href="#L1296" title="lstrlib.c:1296">unpackint</a>(L, data + pos, h.islittle, size, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lauxlib.h.html#L114" title="lauxlib.h:114">luaL_argcheck</a>(L, pos + len + size &lt;= ld, <span class="Constant">2</span>, <span class="Constant">&quot;data string too short&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lapi.c.html#L472" title="lapi.c:472">lua_pushlstring</a>(L, data + pos + size, len);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; pos += len;&nbsp; <span class="Comment">/* skip string */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> Kzstr: {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">size_t</span> len = (<span class="Type">int</span>)strlen(data + pos);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lapi.c.html#L472" title="lapi.c:472">lua_pushlstring</a>(L, data + pos, len);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; pos += len + <span class="Constant">1</span>;&nbsp; <span class="Comment">/* skip string plus final '\0' */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> Kpaddalign: <span class="Statement">case</span> Kpadding: <span class="Statement">case</span> Knop:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; n--;&nbsp; <span class="Comment">/* undo increment */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; pos += size;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <a href="lapi.c.html#L464" title="lapi.c:464">lua_pushinteger</a>(L, pos + <span class="Constant">1</span>);&nbsp; <span class="Comment">/* <a href="llex.c.html#L31" title="llex.c:31">next</a> position */<br/></li>
<li></span>&nbsp; <span class="Statement">return</span> n + <span class="Constant">1</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* }====================================================== */<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><a id="L1388">&#x200c;</a><span class="Type">static</span> <span class="Type">const</span> <a href="lauxlib.h.html#L23" title="lauxlib.h:23">luaL_Reg</a> <span class="linkable">strlib</span>[] = {<br/></li>
<li>&nbsp; {<span class="Constant">&quot;byte&quot;</span>, <a href="#L143" title="lstrlib.c:143">str_byte</a>},<br/></li>
<li>&nbsp; {<span class="Constant">&quot;char&quot;</span>, <a href="#L162" title="lstrlib.c:162">str_char</a>},<br/></li>
<li>&nbsp; {<span class="Constant">&quot;dump&quot;</span>, <a href="#L184" title="lstrlib.c:184">str_dump</a>},<br/></li>
<li>&nbsp; {<span class="Constant">&quot;find&quot;</span>, <a href="#L638" title="lstrlib.c:638">str_find</a>},<br/></li>
<li>&nbsp; {<span class="Constant">&quot;format&quot;</span>, <a href="#L872" title="lstrlib.c:872">str_format</a>},<br/></li>
<li>&nbsp; {<span class="Constant">&quot;<a href="#L677" title="lstrlib.c:677">gmatch</a>&quot;</span>, <a href="#L677" title="lstrlib.c:677">gmatch</a>},<br/></li>
<li>&nbsp; {<span class="Constant">&quot;gsub&quot;</span>, <a href="#L746" title="lstrlib.c:746">str_gsub</a>},<br/></li>
<li>&nbsp; {<span class="Constant">&quot;len&quot;</span>, <a href="#L49" title="lstrlib.c:49">str_len</a>},<br/></li>
<li>&nbsp; {<span class="Constant">&quot;lower&quot;</span>, <a href="#L91" title="lstrlib.c:91">str_lower</a>},<br/></li>
<li>&nbsp; {<span class="Constant">&quot;<a href="#L420" title="lstrlib.c:420">match</a>&quot;</span>, <a href="#L643" title="lstrlib.c:643">str_match</a>},<br/></li>
<li>&nbsp; {<span class="Constant">&quot;rep&quot;</span>, <a href="#L117" title="lstrlib.c:117">str_rep</a>},<br/></li>
<li>&nbsp; {<span class="Constant">&quot;<a href="lapi.c.html#L192" title="lapi.c:192">reverse</a>&quot;</span>, <a href="#L79" title="lstrlib.c:79">str_reverse</a>},<br/></li>
<li>&nbsp; {<span class="Constant">&quot;sub&quot;</span>, <a href="#L65" title="lstrlib.c:65">str_sub</a>},<br/></li>
<li>&nbsp; {<span class="Constant">&quot;upper&quot;</span>, <a href="#L104" title="lstrlib.c:104">str_upper</a>},<br/></li>
<li>&nbsp; {<span class="Constant">&quot;<a href="ltablib.c.html#L192" title="ltablib.c:192">pack</a>&quot;</span>, <a href="#L1179" title="lstrlib.c:1179">str_pack</a>},<br/></li>
<li>&nbsp; {<span class="Constant">&quot;packsize&quot;</span>, <a href="#L1263" title="lstrlib.c:1263">str_packsize</a>},<br/></li>
<li>&nbsp; {<span class="Constant">&quot;<a href="ltablib.c.html#L205" title="ltablib.c:205">unpack</a>&quot;</span>, <a href="#L1322" title="lstrlib.c:1322">str_unpack</a>},<br/></li>
<li>&nbsp; {<span class="Constant">NULL</span>, <span class="Constant">NULL</span>}<br/></li>
<li>};<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L1410">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">createmetatable</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <a href="lapi.c.html#L664" title="lapi.c:664">lua_createtable</a>(L, <span class="Constant">0</span>, <span class="Constant">1</span>);&nbsp; <span class="Comment">/* table to be metatable for strings */<br/></li>
<li></span>&nbsp; <a href="lua.h.html#L359" title="lua.h:359">lua_pushliteral</a>(L, <span class="Constant">&quot;&quot;</span>);&nbsp; <span class="Comment">/* dummy string */<br/></li>
<li></span>&nbsp; <a href="lapi.c.html#L236" title="lapi.c:236">lua_pushvalue</a>(L, -<span class="Constant">2</span>);&nbsp; <span class="Comment">/* copy table */<br/></li>
<li></span>&nbsp; <a href="lapi.c.html#L817" title="lapi.c:817">lua_setmetatable</a>(L, -<span class="Constant">2</span>);&nbsp; <span class="Comment">/* set table as metatable for strings */<br/></li>
<li></span>&nbsp; <a href="lua.h.html#L342" title="lua.h:342">lua_pop</a>(L, <span class="Constant">1</span>);&nbsp; <span class="Comment">/* pop dummy string */<br/></li>
<li></span>&nbsp; <a href="lapi.c.html#L236" title="lapi.c:236">lua_pushvalue</a>(L, -<span class="Constant">2</span>);&nbsp; <span class="Comment">/* get string library */<br/></li>
<li></span>&nbsp; <a href="lapi.c.html#L745" title="lapi.c:745">lua_setfield</a>(L, -<span class="Constant">2</span>, <span class="Constant">&quot;__index&quot;</span>);&nbsp; <span class="Comment">/* metatable.__index = string */<br/></li>
<li></span>&nbsp; <a href="lua.h.html#L342" title="lua.h:342">lua_pop</a>(L, <span class="Constant">1</span>);&nbsp; <span class="Comment">/* pop metatable */<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** Open string library<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L1425">&#x200c;</a></span><a href="luaconf.h.html#L236" title="luaconf.h:236">LUAMOD_API</a> <span class="Type">int</span> <span class="linkable">luaopen_string</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <a href="lauxlib.h.html#L111" title="lauxlib.h:111">luaL_newlib</a>(L, <a href="#L1388" title="lstrlib.c:1388">strlib</a>);<br/></li>
<li>&nbsp; <a href="#L1410" title="lstrlib.c:1410">createmetatable</a>(L);<br/></li>
<li>&nbsp; <span class="Statement">return</span> <span class="Constant">1</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
</ol></code>
 </body>
</html>
