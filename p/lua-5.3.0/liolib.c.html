<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>liolib.c - src</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

code {
    font-family: consolas, monospace;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
  <h3>liolib.c - src</h3>
   <a href="../index.html"> Table of Contents </a>
 <h4>Global variables defined</h4>
 <ul>
<li><a href="#L700">flib</a></li>
<li><a href="#L681">iolib</a></li>
</ul>
 <h4>Data types defined</h4>
 <ul>
<li><a href="#L135">LStream</a></li>
<li><a href="#L373">RN</a></li>
</ul>
 <h4>Functions defined</h4>
 <ul>
<li><a href="#L194">aux_close</a></li>
<li><a href="#L321">aux_lines</a></li>
<li><a href="#L714">createmeta</a></li>
<li><a href="#L735">createstdfile</a></li>
<li><a href="#L673">f_flush</a></li>
<li><a href="#L210">f_gc</a></li>
<li><a href="#L330">f_lines</a></li>
<li><a href="#L567">f_read</a></li>
<li><a href="#L637">f_seek</a></li>
<li><a href="#L656">f_setvbuf</a></li>
<li><a href="#L157">f_tostring</a></li>
<li><a href="#L630">f_write</a></li>
<li><a href="#L291">g_iofile</a></li>
<li><a href="#L512">g_read</a></li>
<li><a href="#L603">g_write</a></li>
<li><a href="#L281">getiofile</a></li>
<li><a href="#L202">io_close</a></li>
<li><a href="#L221">io_fclose</a></li>
<li><a href="#L668">io_flush</a></li>
<li><a href="#L308">io_input</a></li>
<li><a href="#L337">io_lines</a></li>
<li><a href="#L726">io_noclose</a></li>
<li><a href="#L244">io_open</a></li>
<li><a href="#L313">io_output</a></li>
<li><a href="#L258">io_pclose</a></li>
<li><a href="#L264">io_popen</a></li>
<li><a href="#L562">io_read</a></li>
<li><a href="#L572">io_readline</a></li>
<li><a href="#L274">io_tmpfile</a></li>
<li><a href="#L143">io_type</a></li>
<li><a href="#L625">io_write</a></li>
<li><a href="#L748">luaopen_io</a></li>
<li><a href="#L228">newfile</a></li>
<li><a href="#L181">newprefile</a></li>
<li><a href="#L379">nextc</a></li>
<li><a href="#L236">opencheck</a></li>
<li><a href="#L486">read_all</a></li>
<li><a href="#L499">read_chars</a></li>
<li><a href="#L465">read_line</a></li>
<li><a href="#L424">read_number</a></li>
<li><a href="#L405">readdigits</a></li>
<li><a href="#L395">test2</a></li>
<li><a href="#L457">test_eof</a></li>
<li><a href="#L167">tofile</a></li>
</ul>
 <h4>Macros defined</h4>
 <ul>
<li><a href="#L130">IOPREF_LEN</a></li>
<li><a href="#L131">IO_INPUT</a></li>
<li><a href="#L132">IO_OUTPUT</a></li>
<li><a href="#L129">IO_PREFIX</a></li>
<li><a href="#L8">LUA_LIB</a></li>
<li><a href="#L365">MAXRN</a></li>
<li><a href="#L140">isclosed</a></li>
<li><a href="#L33">l_checkmode</a></li>
<li><a href="#L103">l_fseek</a></li>
<li><a href="#L111">l_fseek</a></li>
<li><a href="#L118">l_fseek</a></li>
<li><a href="#L104">l_ftell</a></li>
<li><a href="#L112">l_ftell</a></li>
<li><a href="#L119">l_ftell</a></li>
<li><a href="#L79">l_getc</a></li>
<li><a href="#L83">l_getc</a></li>
<li><a href="#L415">l_getlocaledecpoint</a></li>
<li><a href="#L80">l_lockfile</a></li>
<li><a href="#L84">l_lockfile</a></li>
<li><a href="#L53">l_pclose</a></li>
<li><a href="#L58">l_pclose</a></li>
<li><a href="#L67">l_pclose</a></li>
<li><a href="#L52">l_popen</a></li>
<li><a href="#L57">l_popen</a></li>
<li><a href="#L63">l_popen</a></li>
<li><a href="#L105">l_seeknum</a></li>
<li><a href="#L113">l_seeknum</a></li>
<li><a href="#L120">l_seeknum</a></li>
<li><a href="#L81">l_unlockfile</a></li>
<li><a href="#L85">l_unlockfile</a></li>
<li><a href="#L7">liolib_c</a></li>
<li><a href="#L138">tolstream</a></li>
</ul>
 <h4>Source code</h4>

  <code><ol><li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** $Id: liolib.c,v 2.142 2015/01/02 12:50:28 roberto Exp $<br/></li>
<li></span><span class="Comment">** Standard I/O (and system) library<br/></li>
<li></span><span class="Comment">** See Copyright Notice in lua.h<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li></span><br/></li>
<li><a id="L7">&#x200c;</a><span class="PreProc">#define <span class="linkable">liolib_c</span><br/></li>
<li><a id="L8">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">LUA_LIB</span><br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;lprefix.h&quot;<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;ctype.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;errno.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;locale.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;stdio.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;stdlib.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;string.h&gt;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;lua.h&quot;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;lauxlib.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;lualib.h&quot;<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="PreProc">#if !defined(<a href="#L33" title="liolib.c:33">l_checkmode</a>)<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** Check whether 'mode' matches '[rwa]%+?b?'.<br/></li>
<li></span><span class="Comment">** Change this macro to accept other modes for 'fopen' besides<br/></li>
<li></span><span class="Comment">** the standard ones.<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L33">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">l_checkmode</span>(mode) \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; &nbsp; &nbsp; (*mode != </span><span class="Special">'\0'</span><span class="PreProc"> &amp;&amp; strchr(</span><span class="Constant">&quot;rwa&quot;</span><span class="PreProc">, *(mode++)) != </span><span class="Constant">NULL</span><span class="PreProc"> &amp;&amp;&nbsp; &nbsp; &nbsp; &nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; &nbsp; &nbsp; (*mode != </span><span class="Constant">'+'</span><span class="PreProc"> || ++mode) &amp;&amp;&nbsp; </span><span class="Comment">/* skip if char is '+' */</span><span class="PreProc">&nbsp; &nbsp; &nbsp; &nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; &nbsp; &nbsp; (*mode != </span><span class="Constant">'b'</span><span class="PreProc"> || ++mode) &amp;&amp;&nbsp; </span><span class="Comment">/* skip if char is 'b' */</span><span class="PreProc">&nbsp; &nbsp; &nbsp; &nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; &nbsp; &nbsp; (*mode == </span><span class="Special">'\0'</span><span class="PreProc">))<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** {======================================================<br/></li>
<li></span><span class="Comment">** <a href="#L52" title="liolib.c:52">l_popen</a> spawns a new process connected to the current<br/></li>
<li></span><span class="Comment">** one through the file streams.<br/></li>
<li></span><span class="Comment">** =======================================================<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#if !defined(<a href="#L52" title="liolib.c:52">l_popen</a>)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Comment">/* { */<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#if defined(<a href="luaconf.h.html#L62" title="luaconf.h:62">LUA_USE_POSIX</a>)&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Comment">/* { */<br/></li>
<li></span><br/></li>
<li><a id="L52">&#x200c;</a><span class="PreProc">#define <span class="linkable">l_popen</span>(L,c,m)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (fflush(</span><span class="Constant">NULL</span><span class="PreProc">), popen(c,m))<br/></li>
<li><a id="L53">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">l_pclose</span>(L,file)&nbsp; &nbsp; &nbsp; &nbsp; (pclose(file))<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#elif defined(<a href="luaconf.h.html#L51" title="luaconf.h:51">LUA_USE_WINDOWS</a>)&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Comment">/* }{ */<br/></li>
<li></span><br/></li>
<li><a id="L57">&#x200c;</a><span class="PreProc">#define <span class="linkable">l_popen</span>(L,c,m)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (_popen(c,m))<br/></li>
<li><a id="L58">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">l_pclose</span>(L,file)&nbsp; &nbsp; &nbsp; &nbsp; (_pclose(file))<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#else</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* }{ */<br/></li>
<li></span><br/></li>
<li><span class="Comment">/* ISO C definitions */<br/></li>
<li><a id="L63">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">l_popen</span>(L,c,m)&nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ((</span><span class="Type">void</span><span class="PreProc">)((</span><span class="Type">void</span><span class="PreProc">)c, m), \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lauxlib.c.html#L212" title="lauxlib.c:212">luaL_error</a>(L, </span><span class="Constant">&quot;'popen' not supported&quot;</span><span class="PreProc">), \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (</span><span class="Type">FILE</span><span class="PreProc">*)</span><span class="Constant">0</span><span class="PreProc">)<br/></li>
<li><a id="L67">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">l_pclose</span>(L,file)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ((</span><span class="Type">void</span><span class="PreProc">)L, (</span><span class="Type">void</span><span class="PreProc">)file, -</span><span class="Constant">1</span><span class="PreProc">)<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#endif</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* } */<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#endif</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* } */<br/></li>
<li></span><br/></li>
<li><span class="Comment">/* }====================================================== */<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="PreProc">#if !defined(<a href="#L79" title="liolib.c:79">l_getc</a>)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Comment">/* { */<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#if defined(<a href="luaconf.h.html#L62" title="luaconf.h:62">LUA_USE_POSIX</a>)<br/></li>
<li><a id="L79">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">l_getc</span>(f)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; getc_unlocked(f)<br/></li>
<li><a id="L80">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">l_lockfile</span>(f)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; flockfile(f)<br/></li>
<li><a id="L81">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">l_unlockfile</span>(f)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; funlockfile(f)<br/></li>
<li></span><span class="PreProc">#else<br/></li>
<li><a id="L83">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">l_getc</span>(f)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; getc(f)<br/></li>
<li><a id="L84">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">l_lockfile</span>(f)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ((</span><span class="Type">void</span><span class="PreProc">)</span><span class="Constant">0</span><span class="PreProc">)<br/></li>
<li><a id="L85">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">l_unlockfile</span>(f)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ((</span><span class="Type">void</span><span class="PreProc">)</span><span class="Constant">0</span><span class="PreProc">)<br/></li>
<li></span><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#endif</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* } */<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** {======================================================<br/></li>
<li></span><span class="Comment">** <a href="#L103" title="liolib.c:103">l_fseek</a>: configuration for longer offsets<br/></li>
<li></span><span class="Comment">** =======================================================<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#if !defined(<a href="#L103" title="liolib.c:103">l_fseek</a>)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Comment">/* { */<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#if defined(<a href="luaconf.h.html#L62" title="luaconf.h:62">LUA_USE_POSIX</a>)&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Comment">/* { */<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;sys/types.h&gt;<br/></li>
<li></span><br/></li>
<li><a id="L103">&#x200c;</a><span class="PreProc">#define <span class="linkable">l_fseek</span>(f,o,w)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fseeko(f,o,w)<br/></li>
<li><a id="L104">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">l_ftell</span>(f)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ftello(f)<br/></li>
<li><a id="L105">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">l_seeknum</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Type">off_t<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#elif defined(<a href="luaconf.h.html#L51" title="luaconf.h:51">LUA_USE_WINDOWS</a>) &amp;&amp; !defined(_CRTIMP_TYPEINFO) \<br/></li>
<li></span><span class="PreProc">&nbsp;&nbsp; &amp;&amp; defined(_MSC_VER) &amp;&amp; (_MSC_VER &gt;= </span><span class="Constant">1400</span><span class="PreProc">)&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Comment">/* }{ */<br/></li>
<li></span><br/></li>
<li><span class="Comment">/* Windows (but not DDK) and Visual C++ 2005 or higher */<br/></li>
<li><a id="L111">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">l_fseek</span>(f,o,w)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; _fseeki64(f,o,w)<br/></li>
<li><a id="L112">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">l_ftell</span>(f)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; _ftelli64(f)<br/></li>
<li><a id="L113">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">l_seeknum</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; __int64<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#else</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* }{ */<br/></li>
<li></span><br/></li>
<li><span class="Comment">/* ISO C definitions */<br/></li>
<li><a id="L118">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">l_fseek</span>(f,o,w)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fseek(f,o,w)<br/></li>
<li><a id="L119">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">l_ftell</span>(f)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ftell(f)<br/></li>
<li><a id="L120">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">l_seeknum</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Type">long<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#endif</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* } */<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#endif</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* } */<br/></li>
<li></span><br/></li>
<li><span class="Comment">/* }====================================================== */<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><a id="L129">&#x200c;</a><span class="PreProc">#define <span class="linkable">IO_PREFIX</span>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">&quot;_IO_&quot;<br/></li>
<li><a id="L130">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">IOPREF_LEN</span>&nbsp; &nbsp; &nbsp; &nbsp; (</span><span class="Statement">sizeof</span><span class="PreProc">(<a href="#L129" title="liolib.c:129">IO_PREFIX</a>)/</span><span class="Statement">sizeof</span><span class="PreProc">(</span><span class="Type">char</span><span class="PreProc">) - </span><span class="Constant">1</span><span class="PreProc">)<br/></li>
<li><a id="L131">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">IO_INPUT</span>&nbsp; &nbsp; &nbsp; &nbsp; (<a href="#L129" title="liolib.c:129">IO_PREFIX</a> </span><span class="Constant">&quot;input&quot;</span><span class="PreProc">)<br/></li>
<li><a id="L132">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">IO_OUTPUT</span>&nbsp; &nbsp; &nbsp; &nbsp; (<a href="#L129" title="liolib.c:129">IO_PREFIX</a> </span><span class="Constant">&quot;<a href="luac.c.html#L35" title="luac.c:35">output</a>&quot;</span><span class="PreProc">)<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><a id="L135">&#x200c;</a><span class="Type">typedef</span> <a href="lauxlib.h.html#L185" title="lauxlib.h:185">luaL_Stream</a> <span class="linkable">LStream</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L138">&#x200c;</a><span class="PreProc">#define <span class="linkable">tolstream</span>(L)&nbsp; &nbsp; &nbsp; &nbsp; ((<a href="#L135" title="liolib.c:135">LStream</a> *)<a href="lauxlib.c.html#L322" title="lauxlib.c:322">luaL_checkudata</a>(L, </span><span class="Constant">1</span><span class="PreProc">, <a href="lauxlib.h.html#L182" title="lauxlib.h:182">LUA_FILEHANDLE</a>))<br/></li>
<li></span><br/></li>
<li><a id="L140">&#x200c;</a><span class="PreProc">#define <span class="linkable">isclosed</span>(p)&nbsp; &nbsp; &nbsp; &nbsp; ((p)-&gt;closef == </span><span class="Constant">NULL</span><span class="PreProc">)<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><a id="L143">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">io_type</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <a href="#L135" title="liolib.c:135">LStream</a> *p;<br/></li>
<li>&nbsp; <a href="lauxlib.c.html#L368" title="lauxlib.c:368">luaL_checkany</a>(L, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; p = (<a href="#L135" title="liolib.c:135">LStream</a> *)<a href="lauxlib.c.html#L307" title="lauxlib.c:307">luaL_testudata</a>(L, <span class="Constant">1</span>, <a href="lauxlib.h.html#L182" title="lauxlib.h:182">LUA_FILEHANDLE</a>);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (p == <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; <a href="lapi.c.html#L448" title="lapi.c:448">lua_pushnil</a>(L);&nbsp; <span class="Comment">/* not a file */<br/></li>
<li></span>&nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (<a href="#L140" title="liolib.c:140">isclosed</a>(p))<br/></li>
<li>&nbsp; &nbsp; <a href="lua.h.html#L359" title="lua.h:359">lua_pushliteral</a>(L, <span class="Constant">&quot;closed file&quot;</span>);<br/></li>
<li>&nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; <a href="lua.h.html#L359" title="lua.h:359">lua_pushliteral</a>(L, <span class="Constant">&quot;file&quot;</span>);<br/></li>
<li>&nbsp; <span class="Statement">return</span> <span class="Constant">1</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L157">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">f_tostring</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <a href="#L135" title="liolib.c:135">LStream</a> *p = <a href="#L138" title="liolib.c:138">tolstream</a>(L);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="#L140" title="liolib.c:140">isclosed</a>(p))<br/></li>
<li>&nbsp; &nbsp; <a href="lua.h.html#L359" title="lua.h:359">lua_pushliteral</a>(L, <span class="Constant">&quot;file (closed)&quot;</span>);<br/></li>
<li>&nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; <a href="lapi.c.html#L513" title="lapi.c:513">lua_pushfstring</a>(L, <span class="Constant">&quot;file (</span><span class="Special">%p</span><span class="Constant">)&quot;</span>, p-&gt;f);<br/></li>
<li>&nbsp; <span class="Statement">return</span> <span class="Constant">1</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L167">&#x200c;</a><span class="Type">static</span> <span class="Type">FILE</span> *<span class="linkable">tofile</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <a href="#L135" title="liolib.c:135">LStream</a> *p = <a href="#L138" title="liolib.c:138">tolstream</a>(L);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="#L140" title="liolib.c:140">isclosed</a>(p))<br/></li>
<li>&nbsp; &nbsp; <a href="lauxlib.c.html#L212" title="lauxlib.c:212">luaL_error</a>(L, <span class="Constant">&quot;attempt to use a closed file&quot;</span>);<br/></li>
<li>&nbsp; <a href="lualib.h.html#L54" title="lualib.h:54">lua_assert</a>(p-&gt;f);<br/></li>
<li>&nbsp; <span class="Statement">return</span> p-&gt;f;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** When creating file handles, always creates a 'closed' file handle<br/></li>
<li></span><span class="Comment">** before opening the actual file; so, if there is a memory <a href="lundump.c.html#L40" title="lundump.c:40">error</a>, the<br/></li>
<li></span><span class="Comment">** file is not left opened.<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L181">&#x200c;</a></span><span class="Type">static</span> <a href="#L135" title="liolib.c:135">LStream</a> *<span class="linkable">newprefile</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <a href="#L135" title="liolib.c:135">LStream</a> *p = (<a href="#L135" title="liolib.c:135">LStream</a> *)<a href="lapi.c.html#L1155" title="lapi.c:1155">lua_newuserdata</a>(L, <span class="Statement">sizeof</span>(<a href="#L135" title="liolib.c:135">LStream</a>));<br/></li>
<li>&nbsp; p-&gt;closef = <span class="Constant">NULL</span>;&nbsp; <span class="Comment">/* mark file handle as 'closed' */<br/></li>
<li></span>&nbsp; <a href="lauxlib.c.html#L301" title="lauxlib.c:301">luaL_setmetatable</a>(L, <a href="lauxlib.h.html#L182" title="lauxlib.h:182">LUA_FILEHANDLE</a>);<br/></li>
<li>&nbsp; <span class="Statement">return</span> p;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** Calls the 'close' function from a file handle. The 'volatile' avoids<br/></li>
<li></span><span class="Comment">** a bug in some versions of the Clang compiler (e.g., clang 3.0 for<br/></li>
<li></span><span class="Comment">** 32 bits).<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L194">&#x200c;</a></span><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">aux_close</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <a href="#L135" title="liolib.c:135">LStream</a> *p = <a href="#L138" title="liolib.c:138">tolstream</a>(L);<br/></li>
<li>&nbsp; <span class="Type">volatile</span> <a href="lua.h.html#L103" title="lua.h:103">lua_CFunction</a> cf = p-&gt;closef;<br/></li>
<li>&nbsp; p-&gt;closef = <span class="Constant">NULL</span>;&nbsp; <span class="Comment">/* mark stream as closed */<br/></li>
<li></span>&nbsp; <span class="Statement">return</span> (*cf)(L);&nbsp; <span class="Comment">/* close it */<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L202">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">io_close</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="lua.h.html#L356" title="lua.h:356">lua_isnone</a>(L, <span class="Constant">1</span>))&nbsp; <span class="Comment">/* no argument? */<br/></li>
<li></span>&nbsp; &nbsp; <a href="lapi.c.html#L603" title="lapi.c:603">lua_getfield</a>(L, <a href="lua.h.html#L40" title="lua.h:40">LUA_REGISTRYINDEX</a>, <a href="#L132" title="liolib.c:132">IO_OUTPUT</a>);&nbsp; <span class="Comment">/* use standard <a href="luac.c.html#L35" title="luac.c:35">output</a> */<br/></li>
<li></span>&nbsp; <a href="#L167" title="liolib.c:167">tofile</a>(L);&nbsp; <span class="Comment">/* make sure argument is an open stream */<br/></li>
<li></span>&nbsp; <span class="Statement">return</span> <a href="#L194" title="liolib.c:194">aux_close</a>(L);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L210">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">f_gc</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <a href="#L135" title="liolib.c:135">LStream</a> *p = <a href="#L138" title="liolib.c:138">tolstream</a>(L);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (!<a href="#L140" title="liolib.c:140">isclosed</a>(p) &amp;&amp; p-&gt;f != <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; <a href="#L194" title="liolib.c:194">aux_close</a>(L);&nbsp; <span class="Comment">/* ignore closed and incompletely open files */<br/></li>
<li></span>&nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** function to close regular files<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L221">&#x200c;</a></span><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">io_fclose</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <a href="#L135" title="liolib.c:135">LStream</a> *p = <a href="#L138" title="liolib.c:138">tolstream</a>(L);<br/></li>
<li>&nbsp; <span class="Type">int</span> res = fclose(p-&gt;f);<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="lauxlib.c.html#L223" title="lauxlib.c:223">luaL_fileresult</a>(L, (res == <span class="Constant">0</span>), <span class="Constant">NULL</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L228">&#x200c;</a><span class="Type">static</span> <a href="#L135" title="liolib.c:135">LStream</a> *<span class="linkable">newfile</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <a href="#L135" title="liolib.c:135">LStream</a> *p = <a href="#L181" title="liolib.c:181">newprefile</a>(L);<br/></li>
<li>&nbsp; p-&gt;f = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; p-&gt;closef = &amp;<a href="#L221" title="liolib.c:221">io_fclose</a>;<br/></li>
<li>&nbsp; <span class="Statement">return</span> p;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L236">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">opencheck</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">const</span> <span class="Type">char</span> *fname, <span class="Type">const</span> <span class="Type">char</span> *mode) {<br/></li>
<li>&nbsp; <a href="#L135" title="liolib.c:135">LStream</a> *p = <a href="#L228" title="liolib.c:228">newfile</a>(L);<br/></li>
<li>&nbsp; p-&gt;f = fopen(fname, mode);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (p-&gt;f == <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; <a href="lauxlib.c.html#L212" title="lauxlib.c:212">luaL_error</a>(L, <span class="Constant">&quot;<a href="luac.c.html#L44" title="luac.c:44">cannot</a> open file '</span><span class="Special">%s</span><span class="Constant">' (</span><span class="Special">%s</span><span class="Constant">)&quot;</span>, fname, strerror(errno));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L244">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">io_open</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">char</span> *filename = <a href="lauxlib.h.html#L116" title="lauxlib.h:116">luaL_checkstring</a>(L, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">char</span> *mode = <a href="lauxlib.h.html#L117" title="lauxlib.h:117">luaL_optstring</a>(L, <span class="Constant">2</span>, <span class="Constant">&quot;r&quot;</span>);<br/></li>
<li>&nbsp; <a href="#L135" title="liolib.c:135">LStream</a> *p = <a href="#L228" title="liolib.c:228">newfile</a>(L);<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">char</span> *md = mode;&nbsp; <span class="Comment">/* to traverse/<a href="lparser.c.html#L106" title="lparser.c:106">check</a> mode */<br/></li>
<li></span>&nbsp; <a href="lauxlib.h.html#L114" title="lauxlib.h:114">luaL_argcheck</a>(L, <a href="#L33" title="liolib.c:33">l_checkmode</a>(md), <span class="Constant">2</span>, <span class="Constant">&quot;invalid mode&quot;</span>);<br/></li>
<li>&nbsp; p-&gt;f = fopen(filename, mode);<br/></li>
<li>&nbsp; <span class="Statement">return</span> (p-&gt;f == <span class="Constant">NULL</span>) ? <a href="lauxlib.c.html#L223" title="lauxlib.c:223">luaL_fileresult</a>(L, <span class="Constant">0</span>, filename) : <span class="Constant">1</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** function to close 'popen' files<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L258">&#x200c;</a></span><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">io_pclose</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <a href="#L135" title="liolib.c:135">LStream</a> *p = <a href="#L138" title="liolib.c:138">tolstream</a>(L);<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="lauxlib.c.html#L263" title="lauxlib.c:263">luaL_execresult</a>(L, <a href="#L53" title="liolib.c:53">l_pclose</a>(L, p-&gt;f));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L264">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">io_popen</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">char</span> *filename = <a href="lauxlib.h.html#L116" title="lauxlib.h:116">luaL_checkstring</a>(L, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">char</span> *mode = <a href="lauxlib.h.html#L117" title="lauxlib.h:117">luaL_optstring</a>(L, <span class="Constant">2</span>, <span class="Constant">&quot;r&quot;</span>);<br/></li>
<li>&nbsp; <a href="#L135" title="liolib.c:135">LStream</a> *p = <a href="#L181" title="liolib.c:181">newprefile</a>(L);<br/></li>
<li>&nbsp; p-&gt;f = <a href="#L52" title="liolib.c:52">l_popen</a>(L, filename, mode);<br/></li>
<li>&nbsp; p-&gt;closef = &amp;<a href="#L258" title="liolib.c:258">io_pclose</a>;<br/></li>
<li>&nbsp; <span class="Statement">return</span> (p-&gt;f == <span class="Constant">NULL</span>) ? <a href="lauxlib.c.html#L223" title="lauxlib.c:223">luaL_fileresult</a>(L, <span class="Constant">0</span>, filename) : <span class="Constant">1</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L274">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">io_tmpfile</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <a href="#L135" title="liolib.c:135">LStream</a> *p = <a href="#L228" title="liolib.c:228">newfile</a>(L);<br/></li>
<li>&nbsp; p-&gt;f = tmpfile();<br/></li>
<li>&nbsp; <span class="Statement">return</span> (p-&gt;f == <span class="Constant">NULL</span>) ? <a href="lauxlib.c.html#L223" title="lauxlib.c:223">luaL_fileresult</a>(L, <span class="Constant">0</span>, <span class="Constant">NULL</span>) : <span class="Constant">1</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L281">&#x200c;</a><span class="Type">static</span> <span class="Type">FILE</span> *<span class="linkable">getiofile</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">const</span> <span class="Type">char</span> *findex) {<br/></li>
<li>&nbsp; <a href="#L135" title="liolib.c:135">LStream</a> *p;<br/></li>
<li>&nbsp; <a href="lapi.c.html#L603" title="lapi.c:603">lua_getfield</a>(L, <a href="lua.h.html#L40" title="lua.h:40">LUA_REGISTRYINDEX</a>, findex);<br/></li>
<li>&nbsp; p = (<a href="#L135" title="liolib.c:135">LStream</a> *)<a href="lapi.c.html#L410" title="lapi.c:410">lua_touserdata</a>(L, -<span class="Constant">1</span>);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="#L140" title="liolib.c:140">isclosed</a>(p))<br/></li>
<li>&nbsp; &nbsp; <a href="lauxlib.c.html#L212" title="lauxlib.c:212">luaL_error</a>(L, <span class="Constant">&quot;standard </span><span class="Special">%s</span><span class="Constant"> file is closed&quot;</span>, findex + <a href="#L130" title="liolib.c:130">IOPREF_LEN</a>);<br/></li>
<li>&nbsp; <span class="Statement">return</span> p-&gt;f;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L291">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">g_iofile</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">const</span> <span class="Type">char</span> *f, <span class="Type">const</span> <span class="Type">char</span> *mode) {<br/></li>
<li>&nbsp; <span class="Statement">if</span> (!<a href="lua.h.html#L357" title="lua.h:357">lua_isnoneornil</a>(L, <span class="Constant">1</span>)) {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span> *filename = <a href="lua.h.html#L365" title="lua.h:365">lua_tostring</a>(L, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (filename)<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L236" title="liolib.c:236">opencheck</a>(L, filename, mode);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L167" title="liolib.c:167">tofile</a>(L);&nbsp; <span class="Comment">/* <a href="lparser.c.html#L106" title="lparser.c:106">check</a> that it's a valid file handle */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <a href="lapi.c.html#L236" title="lapi.c:236">lua_pushvalue</a>(L, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <a href="lapi.c.html#L745" title="lapi.c:745">lua_setfield</a>(L, <a href="lua.h.html#L40" title="lua.h:40">LUA_REGISTRYINDEX</a>, f);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Comment">/* return current value */<br/></li>
<li></span>&nbsp; <a href="lapi.c.html#L603" title="lapi.c:603">lua_getfield</a>(L, <a href="lua.h.html#L40" title="lua.h:40">LUA_REGISTRYINDEX</a>, f);<br/></li>
<li>&nbsp; <span class="Statement">return</span> <span class="Constant">1</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L308">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">io_input</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="#L291" title="liolib.c:291">g_iofile</a>(L, <a href="#L131" title="liolib.c:131">IO_INPUT</a>, <span class="Constant">&quot;r&quot;</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L313">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">io_output</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="#L291" title="liolib.c:291">g_iofile</a>(L, <a href="#L132" title="liolib.c:132">IO_OUTPUT</a>, <span class="Constant">&quot;w&quot;</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">int</span> <a href="#L572" title="liolib.c:572">io_readline</a> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L);<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L321">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">aux_lines</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">int</span> toclose) {<br/></li>
<li>&nbsp; <span class="Type">int</span> n = <a href="lapi.c.html#L166" title="lapi.c:166">lua_gettop</a>(L) - <span class="Constant">1</span>;&nbsp; <span class="Comment">/* number of arguments to read */<br/></li>
<li></span>&nbsp; <a href="lapi.c.html#L464" title="lapi.c:464">lua_pushinteger</a>(L, n);&nbsp; <span class="Comment">/* number of arguments to read */<br/></li>
<li></span>&nbsp; <a href="lapi.c.html#L550" title="lapi.c:550">lua_pushboolean</a>(L, toclose);&nbsp; <span class="Comment">/* close/not close file when finished */<br/></li>
<li></span>&nbsp; <a href="lapi.c.html#L206" title="lapi.c:206">lua_rotate</a>(L, <span class="Constant">2</span>, <span class="Constant">2</span>);&nbsp; <span class="Comment">/* move 'n' and 'toclose' to their positions */<br/></li>
<li></span>&nbsp; <a href="lapi.c.html#L526" title="lapi.c:526">lua_pushcclosure</a>(L, <a href="#L572" title="liolib.c:572">io_readline</a>, <span class="Constant">3</span> + n);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L330">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">f_lines</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <a href="#L167" title="liolib.c:167">tofile</a>(L);&nbsp; <span class="Comment">/* <a href="lparser.c.html#L106" title="lparser.c:106">check</a> that it's a valid file handle */<br/></li>
<li></span>&nbsp; <a href="#L321" title="liolib.c:321">aux_lines</a>(L, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; <span class="Statement">return</span> <span class="Constant">1</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L337">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">io_lines</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <span class="Type">int</span> toclose;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="lua.h.html#L356" title="lua.h:356">lua_isnone</a>(L, <span class="Constant">1</span>)) <a href="lapi.c.html#L448" title="lapi.c:448">lua_pushnil</a>(L);&nbsp; <span class="Comment">/* at least one argument */<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (<a href="lua.h.html#L353" title="lua.h:353">lua_isnil</a>(L, <span class="Constant">1</span>)) {&nbsp; <span class="Comment">/* no file name? */<br/></li>
<li></span>&nbsp; &nbsp; <a href="lapi.c.html#L603" title="lapi.c:603">lua_getfield</a>(L, <a href="lua.h.html#L40" title="lua.h:40">LUA_REGISTRYINDEX</a>, <a href="#L131" title="liolib.c:131">IO_INPUT</a>);&nbsp; <span class="Comment">/* get default input */<br/></li>
<li></span>&nbsp; &nbsp; <a href="lua.h.html#L372" title="lua.h:372">lua_replace</a>(L, <span class="Constant">1</span>);&nbsp; <span class="Comment">/* put it at index 1 */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L167" title="liolib.c:167">tofile</a>(L);&nbsp; <span class="Comment">/* <a href="lparser.c.html#L106" title="lparser.c:106">check</a> that it's a valid file handle */<br/></li>
<li></span>&nbsp; &nbsp; toclose = <span class="Constant">0</span>;&nbsp; <span class="Comment">/* do not close it after iteration */<br/></li>
<li></span>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">else</span> {&nbsp; <span class="Comment">/* open a new file */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span> *filename = <a href="lauxlib.h.html#L116" title="lauxlib.h:116">luaL_checkstring</a>(L, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="#L236" title="liolib.c:236">opencheck</a>(L, filename, <span class="Constant">&quot;r&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="lua.h.html#L372" title="lua.h:372">lua_replace</a>(L, <span class="Constant">1</span>);&nbsp; <span class="Comment">/* put file at index 1 */<br/></li>
<li></span>&nbsp; &nbsp; toclose = <span class="Constant">1</span>;&nbsp; <span class="Comment">/* close it after iteration */<br/></li>
<li></span>&nbsp; }<br/></li>
<li>&nbsp; <a href="#L321" title="liolib.c:321">aux_lines</a>(L, toclose);<br/></li>
<li>&nbsp; <span class="Statement">return</span> <span class="Constant">1</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** {======================================================<br/></li>
<li></span><span class="Comment">** READ<br/></li>
<li></span><span class="Comment">** =======================================================<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Comment">/* maximum length of a numeral */<br/></li>
<li><a id="L365">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">MAXRN</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">200<br/></li>
<li></span><br/></li>
<li><span class="Comment">/* auxiliary structure used by '<a href="#L424" title="liolib.c:424">read_number</a>' */<br/></li>
<li></span><span class="Type">typedef</span> <span class="Type">struct</span> {<br/></li>
<li>&nbsp; <span class="Type">FILE</span> *f;&nbsp; <span class="Comment">/* file being read */<br/></li>
<li></span>&nbsp; <span class="Type">int</span> c;&nbsp; <span class="Comment">/* current character (look ahead) */<br/></li>
<li></span>&nbsp; <span class="Type">int</span> n;&nbsp; <span class="Comment">/* number of elements in buffer 'buff' */<br/></li>
<li></span>&nbsp; <span class="Type">char</span> buff[<a href="#L365" title="liolib.c:365">MAXRN</a> + <span class="Constant">1</span>];&nbsp; <span class="Comment">/* +1 for ending '\0' */<br/></li>
<li><a id="L373">&#x200c;</a></span>} <span class="linkable">RN</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** Add current char to buffer (if not out of space) and read <a href="llex.c.html#L31" title="llex.c:31">next</a> one<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L379">&#x200c;</a></span><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">nextc</span> (<a href="#L373" title="liolib.c:373">RN</a> *rn) {<br/></li>
<li>&nbsp; <span class="Statement">if</span> (rn-&gt;n &gt;= <a href="#L365" title="liolib.c:365">MAXRN</a>) {&nbsp; <span class="Comment">/* buffer overflow? */<br/></li>
<li></span>&nbsp; &nbsp; rn-&gt;buff[<span class="Constant">0</span>] = <span class="Special">'\0'</span>;&nbsp; <span class="Comment">/* invalidate result */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;&nbsp; <span class="Comment">/* fail */<br/></li>
<li></span>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; rn-&gt;buff[rn-&gt;n++] = rn-&gt;c;&nbsp; <span class="Comment">/* <a href="llex.c.html#L56" title="llex.c:56">save</a> current char */<br/></li>
<li></span>&nbsp; &nbsp; rn-&gt;c = <a href="#L79" title="liolib.c:79">l_getc</a>(rn-&gt;f);&nbsp; <span class="Comment">/* read <a href="llex.c.html#L31" title="llex.c:31">next</a> one */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">1</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** Accept current char if it is in 'set' (of size 1 or 2)<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L395">&#x200c;</a></span><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">test2</span> (<a href="#L373" title="liolib.c:373">RN</a> *rn, <span class="Type">const</span> <span class="Type">char</span> *set) {<br/></li>
<li>&nbsp; <span class="Statement">if</span> (rn-&gt;c == set[<span class="Constant">0</span>] || (rn-&gt;c == set[<span class="Constant">1</span>] &amp;&amp; rn-&gt;c != <span class="Special">'\0'</span>))<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L379" title="liolib.c:379">nextc</a>(rn);<br/></li>
<li>&nbsp; <span class="Statement">else</span> <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** Read a sequence of (hex)digits<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L405">&#x200c;</a></span><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">readdigits</span> (<a href="#L373" title="liolib.c:373">RN</a> *rn, <span class="Type">int</span> hex) {<br/></li>
<li>&nbsp; <span class="Type">int</span> count = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; <span class="Statement">while</span> ((hex ? isxdigit(rn-&gt;c) : isdigit(rn-&gt;c)) &amp;&amp; <a href="#L379" title="liolib.c:379">nextc</a>(rn))<br/></li>
<li>&nbsp; &nbsp; count++;<br/></li>
<li>&nbsp; <span class="Statement">return</span> count;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/* access to locale &quot;radix character&quot; (decimal point) */<br/></li>
<li></span><span class="PreProc">#if !defined(<a href="llex.c.html#L225" title="llex.c:225">l_getlocaledecpoint</a>)<br/></li>
<li><a id="L415">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">l_getlocaledecpoint</span>()&nbsp; &nbsp;&nbsp; (localeconv()-&gt;decimal_point[</span><span class="Constant">0</span><span class="PreProc">])<br/></li>
<li></span><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** Read a number: first reads a valid prefix of a numeral into a buffer.<br/></li>
<li></span><span class="Comment">** Then it calls '<a href="lapi.c.html#L336" title="lapi.c:336">lua_stringtonumber</a>' to <a href="lparser.c.html#L106" title="lparser.c:106">check</a> whether the format is<br/></li>
<li></span><span class="Comment">** correct and to convert it to a Lua number<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L424">&#x200c;</a></span><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">read_number</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">FILE</span> *f) {<br/></li>
<li>&nbsp; <a href="#L373" title="liolib.c:373">RN</a> rn;<br/></li>
<li>&nbsp; <span class="Type">int</span> count = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; <span class="Type">int</span> hex = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; <span class="Type">char</span> decp[<span class="Constant">2</span>] = <span class="Constant">&quot;.&quot;</span>;<br/></li>
<li>&nbsp; rn.f = f; rn.n = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; decp[<span class="Constant">0</span>] = <a href="llex.c.html#L225" title="llex.c:225">l_getlocaledecpoint</a>();&nbsp; <span class="Comment">/* get decimal point from locale */<br/></li>
<li></span>&nbsp; <a href="#L80" title="liolib.c:80">l_lockfile</a>(rn.f);<br/></li>
<li>&nbsp; <span class="Statement">do</span> { rn.c = <a href="#L79" title="liolib.c:79">l_getc</a>(rn.f); } <span class="Statement">while</span> (isspace(rn.c));&nbsp; <span class="Comment">/* skip spaces */<br/></li>
<li></span>&nbsp; <a href="#L395" title="liolib.c:395">test2</a>(&amp;rn, <span class="Constant">&quot;-+&quot;</span>);&nbsp; <span class="Comment">/* optional signal */<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (<a href="#L395" title="liolib.c:395">test2</a>(&amp;rn, <span class="Constant">&quot;0&quot;</span>)) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L395" title="liolib.c:395">test2</a>(&amp;rn, <span class="Constant">&quot;xX&quot;</span>)) hex = <span class="Constant">1</span>;&nbsp; <span class="Comment">/* numeral is hexadecimal */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">else</span> count = <span class="Constant">1</span>;&nbsp; <span class="Comment">/* count initial '0' as a valid <a href="lstrlib.c.html#L1029" title="lstrlib.c:1029">digit</a> */<br/></li>
<li></span>&nbsp; }<br/></li>
<li>&nbsp; count += <a href="#L405" title="liolib.c:405">readdigits</a>(&amp;rn, hex);&nbsp; <span class="Comment">/* integral part */<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (<a href="#L395" title="liolib.c:395">test2</a>(&amp;rn, decp))&nbsp; <span class="Comment">/* decimal point? */<br/></li>
<li></span>&nbsp; &nbsp; count += <a href="#L405" title="liolib.c:405">readdigits</a>(&amp;rn, hex);&nbsp; <span class="Comment">/* fractional part */<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (count &gt; <span class="Constant">0</span> &amp;&amp; <a href="#L395" title="liolib.c:395">test2</a>(&amp;rn, (hex ? <span class="Constant">&quot;pP&quot;</span> : <span class="Constant">&quot;eE&quot;</span>))) {&nbsp; <span class="Comment">/* exponent mark? */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L395" title="liolib.c:395">test2</a>(&amp;rn, <span class="Constant">&quot;-+&quot;</span>);&nbsp; <span class="Comment">/* exponent signal */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L405" title="liolib.c:405">readdigits</a>(&amp;rn, <span class="Constant">0</span>);&nbsp; <span class="Comment">/* exponent digits */<br/></li>
<li></span>&nbsp; }<br/></li>
<li>&nbsp; ungetc(rn.c, rn.f);&nbsp; <span class="Comment">/* unread look-ahead char */<br/></li>
<li></span>&nbsp; <a href="#L81" title="liolib.c:81">l_unlockfile</a>(rn.f);<br/></li>
<li>&nbsp; rn.buff[rn.n] = <span class="Special">'\0'</span>;&nbsp; <span class="Comment">/* finish string */<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (<a href="lapi.c.html#L336" title="lapi.c:336">lua_stringtonumber</a>(L, rn.buff))&nbsp; <span class="Comment">/* is this a valid number? */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">1</span>;&nbsp; <span class="Comment">/* ok */<br/></li>
<li></span>&nbsp; <span class="Statement">else</span> {&nbsp; <span class="Comment">/* invalid format */<br/></li>
<li></span>&nbsp;&nbsp; <a href="lapi.c.html#L448" title="lapi.c:448">lua_pushnil</a>(L);&nbsp; <span class="Comment">/* &quot;result&quot; to be removed */<br/></li>
<li></span>&nbsp;&nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;&nbsp; <span class="Comment">/* read fails */<br/></li>
<li></span>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L457">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">test_eof</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">FILE</span> *f) {<br/></li>
<li>&nbsp; <span class="Type">int</span> c = getc(f);<br/></li>
<li>&nbsp; ungetc(c, f);&nbsp; <span class="Comment">/* no-op when c == EOF */<br/></li>
<li></span>&nbsp; <a href="lapi.c.html#L472" title="lapi.c:472">lua_pushlstring</a>(L, <span class="Constant">NULL</span>, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; <span class="Statement">return</span> (c != <span class="Constant">EOF</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L465">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">read_line</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">FILE</span> *f, <span class="Type">int</span> chop) {<br/></li>
<li>&nbsp; <a href="lauxlib.h.html#L140" title="lauxlib.h:140">luaL_Buffer</a> b;<br/></li>
<li>&nbsp; <span class="Type">int</span> c = <span class="Special">'\0'</span>;<br/></li>
<li>&nbsp; <a href="lauxlib.c.html#L507" title="lauxlib.c:507">luaL_buffinit</a>(L, &amp;b);<br/></li>
<li>&nbsp; <span class="Statement">while</span> (c != <span class="Constant">EOF</span> &amp;&amp; c != <span class="Special">'\n'</span>) {&nbsp; <span class="Comment">/* repeat until end of line */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">char</span> *buff = <a href="lauxlib.h.html#L164" title="lauxlib.h:164">luaL_prepbuffer</a>(&amp;b);&nbsp; <span class="Comment">/* pre-allocate buffer */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">int</span> i = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; <a href="#L80" title="liolib.c:80">l_lockfile</a>(f);&nbsp; <span class="Comment">/* no memory errors can happen inside the lock */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">while</span> (i &lt; <a href="luaconf.h.html#L707" title="luaconf.h:707">LUAL_BUFFERSIZE</a> &amp;&amp; (c = <a href="#L79" title="liolib.c:79">l_getc</a>(f)) != <span class="Constant">EOF</span> &amp;&amp; c != <span class="Special">'\n'</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; buff[i++] = c;<br/></li>
<li>&nbsp; &nbsp; <a href="#L81" title="liolib.c:81">l_unlockfile</a>(f);<br/></li>
<li>&nbsp; &nbsp; <a href="lauxlib.h.html#L153" title="lauxlib.h:153">luaL_addsize</a>(&amp;b, i);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">if</span> (!chop &amp;&amp; c == <span class="Special">'\n'</span>)&nbsp; <span class="Comment">/* want a newline and have one? */<br/></li>
<li></span>&nbsp; &nbsp; <a href="lauxlib.h.html#L149" title="lauxlib.h:149">luaL_addchar</a>(&amp;b, c);&nbsp; <span class="Comment">/* add ending newline to result */<br/></li>
<li></span>&nbsp; <a href="lauxlib.c.html#L482" title="lauxlib.c:482">luaL_pushresult</a>(&amp;b);&nbsp; <span class="Comment">/* close buffer */<br/></li>
<li></span>&nbsp; <span class="Comment">/* return ok if read something (either a newline or something else) */<br/></li>
<li></span>&nbsp; <span class="Statement">return</span> (c == <span class="Special">'\n'</span> || <a href="lapi.c.html#L390" title="lapi.c:390">lua_rawlen</a>(L, -<span class="Constant">1</span>) &gt; <span class="Constant">0</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L486">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">read_all</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">FILE</span> *f) {<br/></li>
<li>&nbsp; <span class="Type">size_t</span> nr;<br/></li>
<li>&nbsp; <a href="lauxlib.h.html#L140" title="lauxlib.h:140">luaL_Buffer</a> b;<br/></li>
<li>&nbsp; <a href="lauxlib.c.html#L507" title="lauxlib.c:507">luaL_buffinit</a>(L, &amp;b);<br/></li>
<li>&nbsp; <span class="Statement">do</span> {&nbsp; <span class="Comment">/* read file in chunks of <a href="luaconf.h.html#L707" title="luaconf.h:707">LUAL_BUFFERSIZE</a> bytes */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">char</span> *p = <a href="lauxlib.c.html#L448" title="lauxlib.c:448">luaL_prepbuffsize</a>(&amp;b, <a href="luaconf.h.html#L707" title="luaconf.h:707">LUAL_BUFFERSIZE</a>);<br/></li>
<li>&nbsp; &nbsp; nr = fread(p, <span class="Statement">sizeof</span>(<span class="Type">char</span>), <a href="luaconf.h.html#L707" title="luaconf.h:707">LUAL_BUFFERSIZE</a>, f);<br/></li>
<li>&nbsp; &nbsp; <a href="lauxlib.h.html#L153" title="lauxlib.h:153">luaL_addsize</a>(&amp;b, nr);<br/></li>
<li>&nbsp; } <span class="Statement">while</span> (nr == <a href="luaconf.h.html#L707" title="luaconf.h:707">LUAL_BUFFERSIZE</a>);<br/></li>
<li>&nbsp; <a href="lauxlib.c.html#L482" title="lauxlib.c:482">luaL_pushresult</a>(&amp;b);&nbsp; <span class="Comment">/* close buffer */<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L499">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">read_chars</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">FILE</span> *f, <span class="Type">size_t</span> n) {<br/></li>
<li>&nbsp; <span class="Type">size_t</span> nr;&nbsp; <span class="Comment">/* number of chars actually read */<br/></li>
<li></span>&nbsp; <span class="Type">char</span> *p;<br/></li>
<li>&nbsp; <a href="lauxlib.h.html#L140" title="lauxlib.h:140">luaL_Buffer</a> b;<br/></li>
<li>&nbsp; <a href="lauxlib.c.html#L507" title="lauxlib.c:507">luaL_buffinit</a>(L, &amp;b);<br/></li>
<li>&nbsp; p = <a href="lauxlib.c.html#L448" title="lauxlib.c:448">luaL_prepbuffsize</a>(&amp;b, n);&nbsp; <span class="Comment">/* prepare buffer to read whole <a href="lparser.c.html#L1087" title="lparser.c:1087">block</a> */<br/></li>
<li></span>&nbsp; nr = fread(p, <span class="Statement">sizeof</span>(<span class="Type">char</span>), n, f);&nbsp; <span class="Comment">/* try to read 'n' chars */<br/></li>
<li></span>&nbsp; <a href="lauxlib.h.html#L153" title="lauxlib.h:153">luaL_addsize</a>(&amp;b, nr);<br/></li>
<li>&nbsp; <a href="lauxlib.c.html#L482" title="lauxlib.c:482">luaL_pushresult</a>(&amp;b);&nbsp; <span class="Comment">/* close buffer */<br/></li>
<li></span>&nbsp; <span class="Statement">return</span> (nr &gt; <span class="Constant">0</span>);&nbsp; <span class="Comment">/* true iff read something */<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L512">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">g_read</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">FILE</span> *f, <span class="Type">int</span> first) {<br/></li>
<li>&nbsp; <span class="Type">int</span> nargs = <a href="lapi.c.html#L166" title="lapi.c:166">lua_gettop</a>(L) - <span class="Constant">1</span>;<br/></li>
<li>&nbsp; <span class="Type">int</span> success;<br/></li>
<li>&nbsp; <span class="Type">int</span> n;<br/></li>
<li>&nbsp; clearerr(f);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (nargs == <span class="Constant">0</span>) {&nbsp; <span class="Comment">/* no arguments? */<br/></li>
<li></span>&nbsp; &nbsp; success = <a href="#L465" title="liolib.c:465">read_line</a>(L, f, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; n = first+<span class="Constant">1</span>;&nbsp; <span class="Comment">/* to return 1 result */<br/></li>
<li></span>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">else</span> {&nbsp; <span class="Comment">/* ensure stack space for all results and for auxlib's buffer */<br/></li>
<li></span>&nbsp; &nbsp; <a href="lauxlib.c.html#L350" title="lauxlib.c:350">luaL_checkstack</a>(L, nargs+<a href="lua.h.html#L77" title="lua.h:77">LUA_MINSTACK</a>, <span class="Constant">&quot;too many arguments&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; success = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (n = first; nargs-- &amp;&amp; success; n++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="lapi.c.html#L250" title="lapi.c:250">lua_type</a>(L, n) == <a href="lua.h.html#L65" title="lua.h:65">LUA_TNUMBER</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">size_t</span> l = (<span class="Type">size_t</span>)<a href="lauxlib.c.html#L414" title="lauxlib.c:414">luaL_checkinteger</a>(L, n);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; success = (l == <span class="Constant">0</span>) ? <a href="#L457" title="liolib.c:457">test_eof</a>(L, f) : <a href="#L499" title="liolib.c:499">read_chars</a>(L, f, l);<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span> *p = <a href="lauxlib.h.html#L116" title="lauxlib.h:116">luaL_checkstring</a>(L, n);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (*p == <span class="Constant">'*'</span>) p++;&nbsp; <span class="Comment">/* skip optional '*' (for compatibility) */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (*p) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'n'</span>:&nbsp; <span class="Comment">/* number */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; success = <a href="#L424" title="liolib.c:424">read_number</a>(L, f);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'l'</span>:&nbsp; <span class="Comment">/* line */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; success = <a href="#L465" title="liolib.c:465">read_line</a>(L, f, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'L'</span>:&nbsp; <span class="Comment">/* line with end-of-line */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; success = <a href="#L465" title="liolib.c:465">read_line</a>(L, f, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'a'</span>:&nbsp; <span class="Comment">/* file */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L486" title="liolib.c:486">read_all</a>(L, f);&nbsp; <span class="Comment">/* read entire file */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; success = <span class="Constant">1</span>; <span class="Comment">/* always success */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="lauxlib.c.html#L162" title="lauxlib.c:162">luaL_argerror</a>(L, n, <span class="Constant">&quot;invalid format&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">if</span> (ferror(f))<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="lauxlib.c.html#L223" title="lauxlib.c:223">luaL_fileresult</a>(L, <span class="Constant">0</span>, <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (!success) {<br/></li>
<li>&nbsp; &nbsp; <a href="lua.h.html#L342" title="lua.h:342">lua_pop</a>(L, <span class="Constant">1</span>);&nbsp; <span class="Comment">/* remove last result */<br/></li>
<li></span>&nbsp; &nbsp; <a href="lapi.c.html#L448" title="lapi.c:448">lua_pushnil</a>(L);&nbsp; <span class="Comment">/* push nil instead */<br/></li>
<li></span>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> n - first;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L562">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">io_read</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="#L512" title="liolib.c:512">g_read</a>(L, <a href="#L281" title="liolib.c:281">getiofile</a>(L, <a href="#L131" title="liolib.c:131">IO_INPUT</a>), <span class="Constant">1</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L567">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">f_read</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="#L512" title="liolib.c:512">g_read</a>(L, <a href="#L167" title="liolib.c:167">tofile</a>(L), <span class="Constant">2</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L572">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">io_readline</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <a href="#L135" title="liolib.c:135">LStream</a> *p = (<a href="#L135" title="liolib.c:135">LStream</a> *)<a href="lapi.c.html#L410" title="lapi.c:410">lua_touserdata</a>(L, <a href="lua.h.html#L41" title="lua.h:41">lua_upvalueindex</a>(<span class="Constant">1</span>));<br/></li>
<li>&nbsp; <span class="Type">int</span> i;<br/></li>
<li>&nbsp; <span class="Type">int</span> n = (<span class="Type">int</span>)<a href="lua.h.html#L340" title="lua.h:340">lua_tointeger</a>(L, <a href="lua.h.html#L41" title="lua.h:41">lua_upvalueindex</a>(<span class="Constant">2</span>));<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="#L140" title="liolib.c:140">isclosed</a>(p))&nbsp; <span class="Comment">/* file is already closed? */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">return</span> <a href="lauxlib.c.html#L212" title="lauxlib.c:212">luaL_error</a>(L, <span class="Constant">&quot;file is already closed&quot;</span>);<br/></li>
<li>&nbsp; <a href="lapi.c.html#L171" title="lapi.c:171">lua_settop</a>(L , <span class="Constant">1</span>);<br/></li>
<li>&nbsp; <a href="lauxlib.c.html#L350" title="lauxlib.c:350">luaL_checkstack</a>(L, n, <span class="Constant">&quot;too many arguments&quot;</span>);<br/></li>
<li>&nbsp; <span class="Statement">for</span> (i = <span class="Constant">1</span>; i &lt;= n; i++)&nbsp; <span class="Comment">/* push arguments to '<a href="#L512" title="liolib.c:512">g_read</a>' */<br/></li>
<li></span>&nbsp; &nbsp; <a href="lapi.c.html#L236" title="lapi.c:236">lua_pushvalue</a>(L, <a href="lua.h.html#L41" title="lua.h:41">lua_upvalueindex</a>(<span class="Constant">3</span> + i));<br/></li>
<li>&nbsp; n = <a href="#L512" title="liolib.c:512">g_read</a>(L, p-&gt;f, <span class="Constant">2</span>);&nbsp; <span class="Comment">/* 'n' is number of results */<br/></li>
<li></span>&nbsp; <a href="lualib.h.html#L54" title="lualib.h:54">lua_assert</a>(n &gt; <span class="Constant">0</span>);&nbsp; <span class="Comment">/* should return at least a nil */<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (<a href="lapi.c.html#L366" title="lapi.c:366">lua_toboolean</a>(L, -n))&nbsp; <span class="Comment">/* read at least one value? */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">return</span> n;&nbsp; <span class="Comment">/* return them */<br/></li>
<li></span>&nbsp; <span class="Statement">else</span> {&nbsp; <span class="Comment">/* first result is nil: EOF or <a href="lundump.c.html#L40" title="lundump.c:40">error</a> */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (n &gt; <span class="Constant">1</span>) {&nbsp; <span class="Comment">/* is there <a href="lundump.c.html#L40" title="lundump.c:40">error</a> information? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Comment">/* 2nd result is <a href="lundump.c.html#L40" title="lundump.c:40">error</a> message */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="lauxlib.c.html#L212" title="lauxlib.c:212">luaL_error</a>(L, <span class="Constant">&quot;</span><span class="Special">%s</span><span class="Constant">&quot;</span>, <a href="lua.h.html#L365" title="lua.h:365">lua_tostring</a>(L, -n + <span class="Constant">1</span>));<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="lapi.c.html#L366" title="lapi.c:366">lua_toboolean</a>(L, <a href="lua.h.html#L41" title="lua.h:41">lua_upvalueindex</a>(<span class="Constant">3</span>))) {&nbsp; <span class="Comment">/* generator created file? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <a href="lapi.c.html#L171" title="lapi.c:171">lua_settop</a>(L, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="lapi.c.html#L236" title="lapi.c:236">lua_pushvalue</a>(L, <a href="lua.h.html#L41" title="lua.h:41">lua_upvalueindex</a>(<span class="Constant">1</span>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L194" title="liolib.c:194">aux_close</a>(L);&nbsp; <span class="Comment">/* close it */<br/></li>
<li></span>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* }====================================================== */<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><a id="L603">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">g_write</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">FILE</span> *f, <span class="Type">int</span> arg) {<br/></li>
<li>&nbsp; <span class="Type">int</span> nargs = <a href="lapi.c.html#L166" title="lapi.c:166">lua_gettop</a>(L) - arg;<br/></li>
<li>&nbsp; <span class="Type">int</span> status = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; <span class="Statement">for</span> (; nargs--; arg++) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="lapi.c.html#L250" title="lapi.c:250">lua_type</a>(L, arg) == <a href="lua.h.html#L65" title="lua.h:65">LUA_TNUMBER</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Comment">/* optimization: could be done exactly as for strings */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Type">int</span> len = <a href="lapi.c.html#L269" title="lapi.c:269">lua_isinteger</a>(L, arg)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ? fprintf(f, <a href="luaconf.h.html#L527" title="luaconf.h:527">LUA_INTEGER_FMT</a>, <a href="lua.h.html#L340" title="lua.h:340">lua_tointeger</a>(L, arg))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : fprintf(f, <a href="luaconf.h.html#L410" title="luaconf.h:410">LUA_NUMBER_FMT</a>, <a href="lua.h.html#L339" title="lua.h:339">lua_tonumber</a>(L, arg));<br/></li>
<li>&nbsp; &nbsp; &nbsp; status = status &amp;&amp; (len &gt; <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Type">size_t</span> l;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span> *s = <a href="lauxlib.c.html#L374" title="lauxlib.c:374">luaL_checklstring</a>(L, arg, &amp;l);<br/></li>
<li>&nbsp; &nbsp; &nbsp; status = status &amp;&amp; (fwrite(s, <span class="Statement">sizeof</span>(<span class="Type">char</span>), l, f) == l);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">if</span> (status) <span class="Statement">return</span> <span class="Constant">1</span>;&nbsp; <span class="Comment">/* file handle already on stack top */<br/></li>
<li></span>&nbsp; <span class="Statement">else</span> <span class="Statement">return</span> <a href="lauxlib.c.html#L223" title="lauxlib.c:223">luaL_fileresult</a>(L, status, <span class="Constant">NULL</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L625">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">io_write</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="#L603" title="liolib.c:603">g_write</a>(L, <a href="#L281" title="liolib.c:281">getiofile</a>(L, <a href="#L132" title="liolib.c:132">IO_OUTPUT</a>), <span class="Constant">1</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L630">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">f_write</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <span class="Type">FILE</span> *f = <a href="#L167" title="liolib.c:167">tofile</a>(L);<br/></li>
<li>&nbsp; <a href="lapi.c.html#L236" title="lapi.c:236">lua_pushvalue</a>(L, <span class="Constant">1</span>);&nbsp; <span class="Comment">/* push file at the stack top (to be returned) */<br/></li>
<li></span>&nbsp; <span class="Statement">return</span> <a href="#L603" title="liolib.c:603">g_write</a>(L, f, <span class="Constant">2</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L637">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">f_seek</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <span class="Type">static</span> <span class="Type">const</span> <span class="Type">int</span> mode[] = {<span class="Constant">SEEK_SET</span>, <span class="Constant">SEEK_CUR</span>, <span class="Constant">SEEK_END</span>};<br/></li>
<li>&nbsp; <span class="Type">static</span> <span class="Type">const</span> <span class="Type">char</span> *<span class="Type">const</span> modenames[] = {<span class="Constant">&quot;set&quot;</span>, <span class="Constant">&quot;cur&quot;</span>, <span class="Constant">&quot;end&quot;</span>, <span class="Constant">NULL</span>};<br/></li>
<li>&nbsp; <span class="Type">FILE</span> *f = <a href="#L167" title="liolib.c:167">tofile</a>(L);<br/></li>
<li>&nbsp; <span class="Type">int</span> op = <a href="lauxlib.c.html#L337" title="lauxlib.c:337">luaL_checkoption</a>(L, <span class="Constant">2</span>, <span class="Constant">&quot;cur&quot;</span>, modenames);<br/></li>
<li>&nbsp; <a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a> p3 = <a href="lauxlib.c.html#L424" title="lauxlib.c:424">luaL_optinteger</a>(L, <span class="Constant">3</span>, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; <a href="#L105" title="liolib.c:105">l_seeknum</a> offset = (<a href="#L105" title="liolib.c:105">l_seeknum</a>)p3;<br/></li>
<li>&nbsp; <a href="lauxlib.h.html#L114" title="lauxlib.h:114">luaL_argcheck</a>(L, (<a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a>)offset == p3, <span class="Constant">3</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;not an integer in proper range&quot;</span>);<br/></li>
<li>&nbsp; op = <a href="#L103" title="liolib.c:103">l_fseek</a>(f, offset, mode[op]);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (op)<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="lauxlib.c.html#L223" title="lauxlib.c:223">luaL_fileresult</a>(L, <span class="Constant">0</span>, <span class="Constant">NULL</span>);&nbsp; <span class="Comment">/* <a href="lundump.c.html#L40" title="lundump.c:40">error</a> */<br/></li>
<li></span>&nbsp; <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; <a href="lapi.c.html#L464" title="lapi.c:464">lua_pushinteger</a>(L, (<a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a>)<a href="#L104" title="liolib.c:104">l_ftell</a>(f));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">1</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L656">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">f_setvbuf</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <span class="Type">static</span> <span class="Type">const</span> <span class="Type">int</span> mode[] = {<span class="Constant">_IONBF</span>, <span class="Constant">_IOFBF</span>, <span class="Constant">_IOLBF</span>};<br/></li>
<li>&nbsp; <span class="Type">static</span> <span class="Type">const</span> <span class="Type">char</span> *<span class="Type">const</span> modenames[] = {<span class="Constant">&quot;no&quot;</span>, <span class="Constant">&quot;full&quot;</span>, <span class="Constant">&quot;line&quot;</span>, <span class="Constant">NULL</span>};<br/></li>
<li>&nbsp; <span class="Type">FILE</span> *f = <a href="#L167" title="liolib.c:167">tofile</a>(L);<br/></li>
<li>&nbsp; <span class="Type">int</span> op = <a href="lauxlib.c.html#L337" title="lauxlib.c:337">luaL_checkoption</a>(L, <span class="Constant">2</span>, <span class="Constant">NULL</span>, modenames);<br/></li>
<li>&nbsp; <a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a> sz = <a href="lauxlib.c.html#L424" title="lauxlib.c:424">luaL_optinteger</a>(L, <span class="Constant">3</span>, <a href="luaconf.h.html#L707" title="luaconf.h:707">LUAL_BUFFERSIZE</a>);<br/></li>
<li>&nbsp; <span class="Type">int</span> res = setvbuf(f, <span class="Constant">NULL</span>, mode[op], (<span class="Type">size_t</span>)sz);<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="lauxlib.c.html#L223" title="lauxlib.c:223">luaL_fileresult</a>(L, res == <span class="Constant">0</span>, <span class="Constant">NULL</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L668">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">io_flush</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="lauxlib.c.html#L223" title="lauxlib.c:223">luaL_fileresult</a>(L, fflush(<a href="#L281" title="liolib.c:281">getiofile</a>(L, <a href="#L132" title="liolib.c:132">IO_OUTPUT</a>)) == <span class="Constant">0</span>, <span class="Constant">NULL</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L673">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">f_flush</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="lauxlib.c.html#L223" title="lauxlib.c:223">luaL_fileresult</a>(L, fflush(<a href="#L167" title="liolib.c:167">tofile</a>(L)) == <span class="Constant">0</span>, <span class="Constant">NULL</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** functions for 'io' library<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L681">&#x200c;</a></span><span class="Type">static</span> <span class="Type">const</span> <a href="lauxlib.h.html#L23" title="lauxlib.h:23">luaL_Reg</a> <span class="linkable">iolib</span>[] = {<br/></li>
<li>&nbsp; {<span class="Constant">&quot;close&quot;</span>, <a href="#L202" title="liolib.c:202">io_close</a>},<br/></li>
<li>&nbsp; {<span class="Constant">&quot;flush&quot;</span>, <a href="#L668" title="liolib.c:668">io_flush</a>},<br/></li>
<li>&nbsp; {<span class="Constant">&quot;input&quot;</span>, <a href="#L308" title="liolib.c:308">io_input</a>},<br/></li>
<li>&nbsp; {<span class="Constant">&quot;lines&quot;</span>, <a href="#L337" title="liolib.c:337">io_lines</a>},<br/></li>
<li>&nbsp; {<span class="Constant">&quot;open&quot;</span>, <a href="#L244" title="liolib.c:244">io_open</a>},<br/></li>
<li>&nbsp; {<span class="Constant">&quot;<a href="luac.c.html#L35" title="luac.c:35">output</a>&quot;</span>, <a href="#L313" title="liolib.c:313">io_output</a>},<br/></li>
<li>&nbsp; {<span class="Constant">&quot;popen&quot;</span>, <a href="#L264" title="liolib.c:264">io_popen</a>},<br/></li>
<li>&nbsp; {<span class="Constant">&quot;read&quot;</span>, <a href="#L562" title="liolib.c:562">io_read</a>},<br/></li>
<li>&nbsp; {<span class="Constant">&quot;tmpfile&quot;</span>, <a href="#L274" title="liolib.c:274">io_tmpfile</a>},<br/></li>
<li>&nbsp; {<span class="Constant">&quot;type&quot;</span>, <a href="#L143" title="liolib.c:143">io_type</a>},<br/></li>
<li>&nbsp; {<span class="Constant">&quot;write&quot;</span>, <a href="#L625" title="liolib.c:625">io_write</a>},<br/></li>
<li>&nbsp; {<span class="Constant">NULL</span>, <span class="Constant">NULL</span>}<br/></li>
<li>};<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** methods for file handles<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L700">&#x200c;</a></span><span class="Type">static</span> <span class="Type">const</span> <a href="lauxlib.h.html#L23" title="lauxlib.h:23">luaL_Reg</a> <span class="linkable">flib</span>[] = {<br/></li>
<li>&nbsp; {<span class="Constant">&quot;close&quot;</span>, <a href="#L202" title="liolib.c:202">io_close</a>},<br/></li>
<li>&nbsp; {<span class="Constant">&quot;flush&quot;</span>, <a href="#L673" title="liolib.c:673">f_flush</a>},<br/></li>
<li>&nbsp; {<span class="Constant">&quot;lines&quot;</span>, <a href="#L330" title="liolib.c:330">f_lines</a>},<br/></li>
<li>&nbsp; {<span class="Constant">&quot;read&quot;</span>, <a href="#L567" title="liolib.c:567">f_read</a>},<br/></li>
<li>&nbsp; {<span class="Constant">&quot;seek&quot;</span>, <a href="#L637" title="liolib.c:637">f_seek</a>},<br/></li>
<li>&nbsp; {<span class="Constant">&quot;setvbuf&quot;</span>, <a href="#L656" title="liolib.c:656">f_setvbuf</a>},<br/></li>
<li>&nbsp; {<span class="Constant">&quot;write&quot;</span>, <a href="#L630" title="liolib.c:630">f_write</a>},<br/></li>
<li>&nbsp; {<span class="Constant">&quot;__gc&quot;</span>, <a href="#L210" title="liolib.c:210">f_gc</a>},<br/></li>
<li>&nbsp; {<span class="Constant">&quot;__tostring&quot;</span>, <a href="#L157" title="liolib.c:157">f_tostring</a>},<br/></li>
<li>&nbsp; {<span class="Constant">NULL</span>, <span class="Constant">NULL</span>}<br/></li>
<li>};<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L714">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">createmeta</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <a href="lauxlib.c.html#L288" title="lauxlib.c:288">luaL_newmetatable</a>(L, <a href="lauxlib.h.html#L182" title="lauxlib.h:182">LUA_FILEHANDLE</a>);&nbsp; <span class="Comment">/* create metatable for file handles */<br/></li>
<li></span>&nbsp; <a href="lapi.c.html#L236" title="lapi.c:236">lua_pushvalue</a>(L, -<span class="Constant">1</span>);&nbsp; <span class="Comment">/* push metatable */<br/></li>
<li></span>&nbsp; <a href="lapi.c.html#L745" title="lapi.c:745">lua_setfield</a>(L, -<span class="Constant">2</span>, <span class="Constant">&quot;__index&quot;</span>);&nbsp; <span class="Comment">/* metatable.__index = metatable */<br/></li>
<li></span>&nbsp; <a href="lauxlib.c.html#L863" title="lauxlib.c:863">luaL_setfuncs</a>(L, <a href="#L700" title="liolib.c:700">flib</a>, <span class="Constant">0</span>);&nbsp; <span class="Comment">/* add file methods to new metatable */<br/></li>
<li></span>&nbsp; <a href="lua.h.html#L342" title="lua.h:342">lua_pop</a>(L, <span class="Constant">1</span>);&nbsp; <span class="Comment">/* pop new metatable */<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** function to (not) close the standard files stdin, stdout, and stderr<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L726">&#x200c;</a></span><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">io_noclose</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <a href="#L135" title="liolib.c:135">LStream</a> *p = <a href="#L138" title="liolib.c:138">tolstream</a>(L);<br/></li>
<li>&nbsp; p-&gt;closef = &amp;<a href="#L726" title="liolib.c:726">io_noclose</a>;&nbsp; <span class="Comment">/* keep file opened */<br/></li>
<li></span>&nbsp; <a href="lapi.c.html#L448" title="lapi.c:448">lua_pushnil</a>(L);<br/></li>
<li>&nbsp; <a href="lua.h.html#L359" title="lua.h:359">lua_pushliteral</a>(L, <span class="Constant">&quot;<a href="luac.c.html#L44" title="luac.c:44">cannot</a> close standard file&quot;</span>);<br/></li>
<li>&nbsp; <span class="Statement">return</span> <span class="Constant">2</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L735">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">createstdfile</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">FILE</span> *f, <span class="Type">const</span> <span class="Type">char</span> *k,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type">const</span> <span class="Type">char</span> *fname) {<br/></li>
<li>&nbsp; <a href="#L135" title="liolib.c:135">LStream</a> *p = <a href="#L181" title="liolib.c:181">newprefile</a>(L);<br/></li>
<li>&nbsp; p-&gt;f = f;<br/></li>
<li>&nbsp; p-&gt;closef = &amp;<a href="#L726" title="liolib.c:726">io_noclose</a>;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (k != <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; <a href="lapi.c.html#L236" title="lapi.c:236">lua_pushvalue</a>(L, -<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="lapi.c.html#L745" title="lapi.c:745">lua_setfield</a>(L, <a href="lua.h.html#L40" title="lua.h:40">LUA_REGISTRYINDEX</a>, k);&nbsp; <span class="Comment">/* add file to registry */<br/></li>
<li></span>&nbsp; }<br/></li>
<li>&nbsp; <a href="lapi.c.html#L745" title="lapi.c:745">lua_setfield</a>(L, -<span class="Constant">2</span>, fname);&nbsp; <span class="Comment">/* add file to module */<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L748">&#x200c;</a><a href="luaconf.h.html#L236" title="luaconf.h:236">LUAMOD_API</a> <span class="Type">int</span> <span class="linkable">luaopen_io</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <a href="lauxlib.h.html#L111" title="lauxlib.h:111">luaL_newlib</a>(L, <a href="#L681" title="liolib.c:681">iolib</a>);&nbsp; <span class="Comment">/* new module */<br/></li>
<li></span>&nbsp; <a href="#L714" title="liolib.c:714">createmeta</a>(L);<br/></li>
<li>&nbsp; <span class="Comment">/* create (and set) default files */<br/></li>
<li></span>&nbsp; <a href="#L735" title="liolib.c:735">createstdfile</a>(L, <span class="Constant">stdin</span>, <a href="#L131" title="liolib.c:131">IO_INPUT</a>, <span class="Constant">&quot;stdin&quot;</span>);<br/></li>
<li>&nbsp; <a href="#L735" title="liolib.c:735">createstdfile</a>(L, <span class="Constant">stdout</span>, <a href="#L132" title="liolib.c:132">IO_OUTPUT</a>, <span class="Constant">&quot;stdout&quot;</span>);<br/></li>
<li>&nbsp; <a href="#L735" title="liolib.c:735">createstdfile</a>(L, <span class="Constant">stderr</span>, <span class="Constant">NULL</span>, <span class="Constant">&quot;stderr&quot;</span>);<br/></li>
<li>&nbsp; <span class="Statement">return</span> <span class="Constant">1</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
</ol></code>
 </body>
</html>
