<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>luac.c - src</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

code {
    font-family: consolas, monospace;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
  <h3>luac.c - src</h3>
   <a href="../index.html"> Table of Contents </a>
 <h4>Global variables defined</h4>
 <ul>
<li><a href="#L34">Output</a></li>
<li><a href="#L32">dumping</a></li>
<li><a href="#L31">listing</a></li>
<li><a href="#L35">output</a></li>
<li><a href="#L36">progname</a></li>
<li><a href="#L33">stripping</a></li>
</ul>
 <h4>Functions defined</h4>
 <ul>
<li><a href="#L288">PrintCode</a></li>
<li><a href="#L254">PrintConstant</a></li>
<li><a href="#L415">PrintDebug</a></li>
<li><a href="#L442">PrintFunction</a></li>
<li><a href="#L395">PrintHeader</a></li>
<li><a href="#L226">PrintString</a></li>
<li><a href="#L44">cannot</a></li>
<li><a href="#L139">combine</a></li>
<li><a href="#L72">doargs</a></li>
<li><a href="#L38">fatal</a></li>
<li><a href="#L192">main</a></li>
<li><a href="#L165">pmain</a></li>
<li><a href="#L122">reader</a></li>
<li><a href="#L50">usage</a></li>
<li><a href="#L159">writer</a></li>
</ul>
 <h4>Macros defined</h4>
 <ul>
<li><a href="#L120">FUNCTION</a></li>
<li><a href="#L70">IS</a></li>
<li><a href="#L8">LUA_CORE</a></li>
<li><a href="#L218">LUA_CORE</a></li>
<li><a href="#L286">MYK</a></li>
<li><a href="#L29">OUTPUT</a></li>
<li><a href="#L28">PROGNAME</a></li>
<li><a href="#L393">S</a></li>
<li><a href="#L392">SS</a></li>
<li><a href="#L285">UPVALNAME</a></li>
<li><a href="#L224">VOID</a></li>
<li><a href="#L26">luaU_print</a></li>
<li><a href="#L7">luac_c</a></li>
<li><a href="#L217">luac_c</a></li>
<li><a href="#L137">toproto</a></li>
</ul>
 <h4>Source code</h4>

  <code><ol><li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** $Id: luac.c,v 1.72 2015/01/06 03:09:13 lhf Exp $<br/></li>
<li></span><span class="Comment">** Lua compiler (saves bytecodes to files; also lists bytecodes)<br/></li>
<li></span><span class="Comment">** See Copyright Notice in lua.h<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li></span><br/></li>
<li><a id="L7">&#x200c;</a><span class="PreProc">#define <span class="linkable">luac_c</span><br/></li>
<li><a id="L8">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">LUA_CORE</span><br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;lprefix.h&quot;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;ctype.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;errno.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;stdio.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;stdlib.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;string.h&gt;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;lua.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;lauxlib.h&quot;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;lobject.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;lstate.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;lundump.h&quot;<br/></li>
<li></span><br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L442" title="luac.c:442">PrintFunction</a>(<span class="Type">const</span> <a href="lobject.h.html#L398" title="lobject.h:398">Proto</a>* f, <span class="Type">int</span> full);<br/></li>
<li><a id="L26">&#x200c;</a><span class="PreProc">#define <span class="linkable">luaU_print</span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L442" title="luac.c:442">PrintFunction</a><br/></li>
<li></span><br/></li>
<li><a id="L28">&#x200c;</a><span class="PreProc">#define <span class="linkable">PROGNAME</span>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">&quot;luac&quot;</span><span class="PreProc">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Comment">/* default program name */<br/></li>
<li><a id="L29">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">OUTPUT</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L28" title="luac.c:28">PROGNAME</a> </span><span class="Constant">&quot;.out&quot;</span><span class="PreProc">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Comment">/* default <a href="#L35" title="luac.c:35">output</a> file */<br/></li>
<li></span><br/></li>
<li><a id="L31">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">listing</span>=<span class="Constant">0</span>;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* list bytecodes? */<br/></li>
<li><a id="L32">&#x200c;</a></span><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">dumping</span>=<span class="Constant">1</span>;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* dump bytecodes? */<br/></li>
<li><a id="L33">&#x200c;</a></span><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">stripping</span>=<span class="Constant">0</span>;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* strip debug information? */<br/></li>
<li><a id="L34">&#x200c;</a></span><span class="Type">static</span> <span class="Type">char</span> <span class="linkable">Output</span>[]={ <a href="#L29" title="luac.c:29">OUTPUT</a> };&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* default <a href="#L35" title="luac.c:35">output</a> file name */<br/></li>
<li><a id="L35">&#x200c;</a></span><span class="Type">static</span> <span class="Type">const</span> <span class="Type">char</span>* <span class="linkable">output</span>=<a href="#L34" title="luac.c:34">Output</a>;&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* actual <span class="linkable">output</span> file name */<br/></li>
<li><a id="L36">&#x200c;</a></span><span class="Type">static</span> <span class="Type">const</span> <span class="Type">char</span>* <span class="linkable">progname</span>=<a href="#L28" title="luac.c:28">PROGNAME</a>;&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* actual program name */<br/></li>
<li></span><br/></li>
<li><a id="L38">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">fatal</span>(<span class="Type">const</span> <span class="Type">char</span>* message)<br/></li>
<li>{<br/></li>
<li> fprintf(<span class="Constant">stderr</span>,<span class="Constant">&quot;</span><span class="Special">%s</span><span class="Constant">: </span><span class="Special">%s\n</span><span class="Constant">&quot;</span>,<a href="lua.c.html#L105" title="lua.c:105">progname</a>,message);<br/></li>
<li> exit(<span class="Constant">EXIT_FAILURE</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L44">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">cannot</span>(<span class="Type">const</span> <span class="Type">char</span>* what)<br/></li>
<li>{<br/></li>
<li> fprintf(<span class="Constant">stderr</span>,<span class="Constant">&quot;</span><span class="Special">%s</span><span class="Constant">: <a href="#L44" title="luac.c:44">cannot</a> </span><span class="Special">%s</span><span class="Constant"> </span><span class="Special">%s</span><span class="Constant">: </span><span class="Special">%s\n</span><span class="Constant">&quot;</span>,<a href="lua.c.html#L105" title="lua.c:105">progname</a>,what,<a href="#L35" title="luac.c:35">output</a>,strerror(errno));<br/></li>
<li> exit(<span class="Constant">EXIT_FAILURE</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L50">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">usage</span>(<span class="Type">const</span> <span class="Type">char</span>* message)<br/></li>
<li>{<br/></li>
<li> <span class="Statement">if</span> (*message==<span class="Constant">'-'</span>)<br/></li>
<li>&nbsp; fprintf(<span class="Constant">stderr</span>,<span class="Constant">&quot;</span><span class="Special">%s</span><span class="Constant">: unrecognized option '</span><span class="Special">%s</span><span class="Constant">'</span><span class="Special">\n</span><span class="Constant">&quot;</span>,<a href="lua.c.html#L105" title="lua.c:105">progname</a>,message);<br/></li>
<li> <span class="Statement">else<br/></li>
<li></span>&nbsp; fprintf(<span class="Constant">stderr</span>,<span class="Constant">&quot;</span><span class="Special">%s</span><span class="Constant">: </span><span class="Special">%s\n</span><span class="Constant">&quot;</span>,<a href="lua.c.html#L105" title="lua.c:105">progname</a>,message);<br/></li>
<li> fprintf(<span class="Constant">stderr</span>,<br/></li>
<li>&nbsp; <span class="Constant">&quot;<a href="#L50" title="luac.c:50">usage</a>: </span><span class="Special">%s</span><span class="Constant"> [options] [filenames]</span><span class="Special">\n</span><span class="Constant">&quot;<br/></li>
<li></span>&nbsp; <span class="Constant">&quot;Available options are:</span><span class="Special">\n</span><span class="Constant">&quot;<br/></li>
<li></span>&nbsp; <span class="Constant">&quot;&nbsp; -l&nbsp; &nbsp; &nbsp;&nbsp; list (use -l -l for full <a href="#L31" title="luac.c:31">listing</a>)</span><span class="Special">\n</span><span class="Constant">&quot;<br/></li>
<li></span>&nbsp; <span class="Constant">&quot;&nbsp; -o name&nbsp; <a href="#L35" title="luac.c:35">output</a> to file 'name' (default is </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">)</span><span class="Special">\n</span><span class="Constant">&quot;<br/></li>
<li></span>&nbsp; <span class="Constant">&quot;&nbsp; -p&nbsp; &nbsp; &nbsp;&nbsp; parse only</span><span class="Special">\n</span><span class="Constant">&quot;<br/></li>
<li></span>&nbsp; <span class="Constant">&quot;&nbsp; -s&nbsp; &nbsp; &nbsp;&nbsp; strip debug information</span><span class="Special">\n</span><span class="Constant">&quot;<br/></li>
<li></span>&nbsp; <span class="Constant">&quot;&nbsp; -v&nbsp; &nbsp; &nbsp;&nbsp; show version information</span><span class="Special">\n</span><span class="Constant">&quot;<br/></li>
<li></span>&nbsp; <span class="Constant">&quot;&nbsp; --&nbsp; &nbsp; &nbsp;&nbsp; stop handling options</span><span class="Special">\n</span><span class="Constant">&quot;<br/></li>
<li></span>&nbsp; <span class="Constant">&quot;&nbsp; -&nbsp; &nbsp; &nbsp; &nbsp; stop handling options and process stdin</span><span class="Special">\n</span><span class="Constant">&quot;<br/></li>
<li></span>&nbsp; ,<a href="lua.c.html#L105" title="lua.c:105">progname</a>,<a href="#L34" title="luac.c:34">Output</a>);<br/></li>
<li> exit(<span class="Constant">EXIT_FAILURE</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L70">&#x200c;</a><span class="PreProc">#define <span class="linkable">IS</span>(s)&nbsp; &nbsp; &nbsp; &nbsp; (strcmp(argv[i],s)==</span><span class="Constant">0</span><span class="PreProc">)<br/></li>
<li></span><br/></li>
<li><a id="L72">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">doargs</span>(<span class="Type">int</span> argc, <span class="Type">char</span>* argv[])<br/></li>
<li>{<br/></li>
<li> <span class="Type">int</span> i;<br/></li>
<li> <span class="Type">int</span> version=<span class="Constant">0</span>;<br/></li>
<li> <span class="Statement">if</span> (argv[<span class="Constant">0</span>]!=<span class="Constant">NULL</span> &amp;&amp; *argv[<span class="Constant">0</span>]!=<span class="Constant">0</span>) <a href="lua.c.html#L105" title="lua.c:105">progname</a>=argv[<span class="Constant">0</span>];<br/></li>
<li> <span class="Statement">for</span> (i=<span class="Constant">1</span>; i&lt;argc; i++)<br/></li>
<li> {<br/></li>
<li>&nbsp; <span class="Statement">if</span> (*argv[i]!=<span class="Constant">'-'</span>)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* end of options; keep it */<br/></li>
<li></span>&nbsp;&nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (<a href="#L70" title="luac.c:70">IS</a>(<span class="Constant">&quot;--&quot;</span>))&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* end of options; skip it */<br/></li>
<li></span>&nbsp; {<br/></li>
<li>&nbsp;&nbsp; ++i;<br/></li>
<li>&nbsp;&nbsp; <span class="Statement">if</span> (version) ++version;<br/></li>
<li>&nbsp;&nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (<a href="#L70" title="luac.c:70">IS</a>(<span class="Constant">&quot;-&quot;</span>))&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* end of options; use stdin */<br/></li>
<li></span>&nbsp;&nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (<a href="#L70" title="luac.c:70">IS</a>(<span class="Constant">&quot;-l&quot;</span>))&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* list */<br/></li>
<li></span>&nbsp;&nbsp; ++<a href="#L31" title="luac.c:31">listing</a>;<br/></li>
<li>&nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (<a href="#L70" title="luac.c:70">IS</a>(<span class="Constant">&quot;-o&quot;</span>))&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* <a href="#L35" title="luac.c:35">output</a> file */<br/></li>
<li></span>&nbsp; {<br/></li>
<li>&nbsp;&nbsp; <a href="#L35" title="luac.c:35">output</a>=argv[++i];<br/></li>
<li>&nbsp;&nbsp; <span class="Statement">if</span> (<a href="#L35" title="luac.c:35">output</a>==<span class="Constant">NULL</span> || *<a href="#L35" title="luac.c:35">output</a>==<span class="Constant">0</span> || (*<a href="#L35" title="luac.c:35">output</a>==<span class="Constant">'-'</span> &amp;&amp; <a href="#L35" title="luac.c:35">output</a>[<span class="Constant">1</span>]!=<span class="Constant">0</span>))<br/></li>
<li>&nbsp; &nbsp; <a href="#L50" title="luac.c:50">usage</a>(<span class="Constant">&quot;'-o' needs argument&quot;</span>);<br/></li>
<li>&nbsp;&nbsp; <span class="Statement">if</span> (<a href="#L70" title="luac.c:70">IS</a>(<span class="Constant">&quot;-&quot;</span>)) <a href="#L35" title="luac.c:35">output</a>=<span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (<a href="#L70" title="luac.c:70">IS</a>(<span class="Constant">&quot;-p&quot;</span>))&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* parse only */<br/></li>
<li></span>&nbsp;&nbsp; <a href="#L32" title="luac.c:32">dumping</a>=<span class="Constant">0</span>;<br/></li>
<li>&nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (<a href="#L70" title="luac.c:70">IS</a>(<span class="Constant">&quot;-s&quot;</span>))&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* strip debug information */<br/></li>
<li></span>&nbsp;&nbsp; <a href="#L33" title="luac.c:33">stripping</a>=<span class="Constant">1</span>;<br/></li>
<li>&nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (<a href="#L70" title="luac.c:70">IS</a>(<span class="Constant">&quot;-v&quot;</span>))&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* show version */<br/></li>
<li></span>&nbsp;&nbsp; ++version;<br/></li>
<li>&nbsp; <span class="Statement">else</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* unknown option */<br/></li>
<li></span>&nbsp;&nbsp; <a href="#L50" title="luac.c:50">usage</a>(argv[i]);<br/></li>
<li> }<br/></li>
<li> <span class="Statement">if</span> (i==argc &amp;&amp; (<a href="#L31" title="luac.c:31">listing</a> || !<a href="#L32" title="luac.c:32">dumping</a>))<br/></li>
<li> {<br/></li>
<li>&nbsp; <a href="#L32" title="luac.c:32">dumping</a>=<span class="Constant">0</span>;<br/></li>
<li>&nbsp; argv[--i]=<a href="#L34" title="luac.c:34">Output</a>;<br/></li>
<li> }<br/></li>
<li> <span class="Statement">if</span> (version)<br/></li>
<li> {<br/></li>
<li>&nbsp; printf(<span class="Constant">&quot;</span><span class="Special">%s\n</span><span class="Constant">&quot;</span>,<a href="lua.h.html#L26" title="lua.h:26">LUA_COPYRIGHT</a>);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (version==argc-<span class="Constant">1</span>) exit(<span class="Constant">EXIT_SUCCESS</span>);<br/></li>
<li> }<br/></li>
<li> <span class="Statement">return</span> i;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L120">&#x200c;</a><span class="PreProc">#define <span class="linkable">FUNCTION</span> </span><span class="Constant">&quot;(function()end)();&quot;<br/></li>
<li></span><br/></li>
<li><a id="L122">&#x200c;</a><span class="Type">static</span> <span class="Type">const</span> <span class="Type">char</span>* <span class="linkable">reader</span>(<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">void</span> *ud, <span class="Type">size_t</span> *size)<br/></li>
<li>{<br/></li>
<li> <a href="llimits.h.html#L103" title="llimits.h:103">UNUSED</a>(L);<br/></li>
<li> <span class="Statement">if</span> ((*(<span class="Type">int</span>*)ud)--)<br/></li>
<li> {<br/></li>
<li>&nbsp; *size=<span class="Statement">sizeof</span>(<a href="#L120" title="luac.c:120">FUNCTION</a>)-<span class="Constant">1</span>;<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="#L120" title="luac.c:120">FUNCTION</a>;<br/></li>
<li> }<br/></li>
<li> <span class="Statement">else<br/></li>
<li></span> {<br/></li>
<li>&nbsp; *size=<span class="Constant">0</span>;<br/></li>
<li>&nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li> }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L137">&#x200c;</a><span class="PreProc">#define <span class="linkable">toproto</span>(L,i) <a href="lobject.h.html#L459" title="lobject.h:459">getproto</a>(L-&gt;top+(i))<br/></li>
<li></span><br/></li>
<li><a id="L139">&#x200c;</a><span class="Type">static</span> <span class="Type">const</span> <a href="lobject.h.html#L398" title="lobject.h:398">Proto</a>* <span class="linkable">combine</span>(<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a>* L, <span class="Type">int</span> n)<br/></li>
<li>{<br/></li>
<li> <span class="Statement">if</span> (n==<span class="Constant">1</span>)<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="#L137" title="luac.c:137">toproto</a>(L,-<span class="Constant">1</span>);<br/></li>
<li> <span class="Statement">else<br/></li>
<li></span> {<br/></li>
<li>&nbsp; <a href="lobject.h.html#L398" title="lobject.h:398">Proto</a>* f;<br/></li>
<li>&nbsp; <span class="Type">int</span> i=n;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="lapi.c.html#L963" title="lapi.c:963">lua_load</a>(L,<a href="#L122" title="luac.c:122">reader</a>,&amp;i,<span class="Constant">&quot;=(&quot;</span> <a href="#L28" title="luac.c:28">PROGNAME</a> <span class="Constant">&quot;)&quot;</span>,<span class="Constant">NULL</span>)!=<a href="lua.h.html#L45" title="lua.h:45">LUA_OK</a>) <a href="#L38" title="luac.c:38">fatal</a>(<a href="lua.h.html#L365" title="lua.h:365">lua_tostring</a>(L,-<span class="Constant">1</span>));<br/></li>
<li>&nbsp; f=<a href="#L137" title="luac.c:137">toproto</a>(L,-<span class="Constant">1</span>);<br/></li>
<li>&nbsp; <span class="Statement">for</span> (i=<span class="Constant">0</span>; i&lt;n; i++)<br/></li>
<li>&nbsp; {<br/></li>
<li>&nbsp;&nbsp; f-&gt;p[i]=<a href="#L137" title="luac.c:137">toproto</a>(L,i-n-<span class="Constant">1</span>);<br/></li>
<li>&nbsp;&nbsp; <span class="Statement">if</span> (f-&gt;p[i]-&gt;sizeupvalues&gt;<span class="Constant">0</span>) f-&gt;p[i]-&gt;upvalues[<span class="Constant">0</span>].instack=<span class="Constant">0</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; f-&gt;sizelineinfo=<span class="Constant">0</span>;<br/></li>
<li>&nbsp; <span class="Statement">return</span> f;<br/></li>
<li> }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L159">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">writer</span>(<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a>* L, <span class="Type">const</span> <span class="Type">void</span>* p, <span class="Type">size_t</span> size, <span class="Type">void</span>* u)<br/></li>
<li>{<br/></li>
<li> <a href="llimits.h.html#L103" title="llimits.h:103">UNUSED</a>(L);<br/></li>
<li> <span class="Statement">return</span> (fwrite(p,size,<span class="Constant">1</span>,(<span class="Type">FILE</span>*)u)!=<span class="Constant">1</span>) &amp;&amp; (size!=<span class="Constant">0</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L165">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">pmain</span>(<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a>* L)<br/></li>
<li>{<br/></li>
<li> <span class="Type">int</span> argc=(<span class="Type">int</span>)<a href="lua.h.html#L340" title="lua.h:340">lua_tointeger</a>(L,<span class="Constant">1</span>);<br/></li>
<li> <span class="Type">char</span>** argv=(<span class="Type">char</span>**)<a href="lapi.c.html#L410" title="lapi.c:410">lua_touserdata</a>(L,<span class="Constant">2</span>);<br/></li>
<li> <span class="Type">const</span> <a href="lobject.h.html#L398" title="lobject.h:398">Proto</a>* f;<br/></li>
<li> <span class="Type">int</span> i;<br/></li>
<li> <span class="Statement">if</span> (!<a href="lapi.c.html#L97" title="lapi.c:97">lua_checkstack</a>(L,argc)) <a href="#L38" title="luac.c:38">fatal</a>(<span class="Constant">&quot;too many input files&quot;</span>);<br/></li>
<li> <span class="Statement">for</span> (i=<span class="Constant">0</span>; i&lt;argc; i++)<br/></li>
<li> {<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">char</span>* filename=<a href="#L70" title="luac.c:70">IS</a>(<span class="Constant">&quot;-&quot;</span>) ? <span class="Constant">NULL</span> : argv[i];<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="lauxlib.h.html#L78" title="lauxlib.h:78">luaL_loadfile</a>(L,filename)!=<a href="lua.h.html#L45" title="lua.h:45">LUA_OK</a>) <a href="#L38" title="luac.c:38">fatal</a>(<a href="lua.h.html#L365" title="lua.h:365">lua_tostring</a>(L,-<span class="Constant">1</span>));<br/></li>
<li> }<br/></li>
<li> f=<a href="#L139" title="luac.c:139">combine</a>(L,argc);<br/></li>
<li> <span class="Statement">if</span> (<a href="#L31" title="luac.c:31">listing</a>) <a href="#L26" title="luac.c:26">luaU_print</a>(f,<a href="#L31" title="luac.c:31">listing</a>&gt;<span class="Constant">1</span>);<br/></li>
<li> <span class="Statement">if</span> (<a href="#L32" title="luac.c:32">dumping</a>)<br/></li>
<li> {<br/></li>
<li>&nbsp; <span class="Type">FILE</span>* D= (<a href="#L35" title="luac.c:35">output</a>==<span class="Constant">NULL</span>) ? <span class="Constant">stdout</span> : fopen(<a href="#L35" title="luac.c:35">output</a>,<span class="Constant">&quot;wb&quot;</span>);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (D==<span class="Constant">NULL</span>) <a href="#L44" title="luac.c:44">cannot</a>(<span class="Constant">&quot;open&quot;</span>);<br/></li>
<li>&nbsp; <a href="llimits.h.html#L185" title="llimits.h:185">lua_lock</a>(L);<br/></li>
<li>&nbsp; <a href="ldump.c.html#L201" title="ldump.c:201">luaU_dump</a>(L,f,<a href="lstrlib.c.html#L177" title="lstrlib.c:177">writer</a>,D,<a href="#L33" title="luac.c:33">stripping</a>);<br/></li>
<li>&nbsp; <a href="llimits.h.html#L186" title="llimits.h:186">lua_unlock</a>(L);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (ferror(D)) <a href="#L44" title="luac.c:44">cannot</a>(<span class="Constant">&quot;write&quot;</span>);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (fclose(D)) <a href="#L44" title="luac.c:44">cannot</a>(<span class="Constant">&quot;close&quot;</span>);<br/></li>
<li> }<br/></li>
<li> <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L192">&#x200c;</a><span class="Type">int</span> <span class="linkable">main</span>(<span class="Type">int</span> argc, <span class="Type">char</span>* argv[])<br/></li>
<li>{<br/></li>
<li> <a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a>* L;<br/></li>
<li> <span class="Type">int</span> i=<a href="#L72" title="luac.c:72">doargs</a>(argc,argv);<br/></li>
<li> argc-=i; argv+=i;<br/></li>
<li> <span class="Statement">if</span> (argc&lt;=<span class="Constant">0</span>) <a href="#L50" title="luac.c:50">usage</a>(<span class="Constant">&quot;no input files given&quot;</span>);<br/></li>
<li> L=<a href="lauxlib.c.html#L955" title="lauxlib.c:955">luaL_newstate</a>();<br/></li>
<li> <span class="Statement">if</span> (L==<span class="Constant">NULL</span>) <a href="#L38" title="luac.c:38">fatal</a>(<span class="Constant">&quot;<a href="#L44" title="luac.c:44">cannot</a> create state: not enough memory&quot;</span>);<br/></li>
<li> <a href="lua.h.html#L348" title="lua.h:348">lua_pushcfunction</a>(L,&amp;<a href="lua.c.html#L553" title="lua.c:553">pmain</a>);<br/></li>
<li> <a href="lapi.c.html#L464" title="lapi.c:464">lua_pushinteger</a>(L,argc);<br/></li>
<li> <a href="lapi.c.html#L558" title="lapi.c:558">lua_pushlightuserdata</a>(L,argv);<br/></li>
<li> <span class="Statement">if</span> (<a href="lua.h.html#L276" title="lua.h:276">lua_pcall</a>(L,<span class="Constant">2</span>,<span class="Constant">0</span>,<span class="Constant">0</span>)!=<a href="lua.h.html#L45" title="lua.h:45">LUA_OK</a>) <a href="#L38" title="luac.c:38">fatal</a>(<a href="lua.h.html#L365" title="lua.h:365">lua_tostring</a>(L,-<span class="Constant">1</span>));<br/></li>
<li> <a href="lstate.c.html#L340" title="lstate.c:340">lua_close</a>(L);<br/></li>
<li> <span class="Statement">return</span> <span class="Constant">EXIT_SUCCESS</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** $Id: print.c,v 1.76 2015/01/05 16:12:50 lhf Exp $<br/></li>
<li></span><span class="Comment">** print bytecodes<br/></li>
<li></span><span class="Comment">** See Copyright Notice in lua.h<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;ctype.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;stdio.h&gt;<br/></li>
<li></span><br/></li>
<li><a id="L217">&#x200c;</a><span class="PreProc">#define <span class="linkable">luac_c</span><br/></li>
<li><a id="L218">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">LUA_CORE</span><br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;ldebug.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;lobject.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;lopcodes.h&quot;<br/></li>
<li></span><br/></li>
<li><a id="L224">&#x200c;</a><span class="PreProc">#define <span class="linkable">VOID</span>(p)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ((</span><span class="Type">const</span><span class="PreProc"> </span><span class="Type">void</span><span class="PreProc">*)(p))<br/></li>
<li></span><br/></li>
<li><a id="L226">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">PrintString</span>(<span class="Type">const</span> <a href="lobject.h.html#L303" title="lobject.h:303">TString</a>* ts)<br/></li>
<li>{<br/></li>
<li> <span class="Type">const</span> <span class="Type">char</span>* s=<a href="lobject.h.html#L326" title="lobject.h:326">getstr</a>(ts);<br/></li>
<li> <span class="Type">size_t</span> i,n=ts-&gt;len;<br/></li>
<li> printf(<span class="Constant">&quot;</span><span class="Special">%c</span><span class="Constant">&quot;</span>,<span class="Constant">'&quot;'</span>);<br/></li>
<li> <span class="Statement">for</span> (i=<span class="Constant">0</span>; i&lt;n; i++)<br/></li>
<li> {<br/></li>
<li>&nbsp; <span class="Type">int</span> c=(<span class="Type">int</span>)(<span class="Type">unsigned</span> <span class="Type">char</span>)s[i];<br/></li>
<li>&nbsp; <span class="Statement">switch</span> (c)<br/></li>
<li>&nbsp; {<br/></li>
<li>&nbsp;&nbsp; <span class="Statement">case</span> <span class="Constant">'&quot;'</span>:&nbsp; printf(<span class="Constant">&quot;</span><span class="Special">\\\&quot;</span><span class="Constant">&quot;</span>); <span class="Statement">break</span>;<br/></li>
<li>&nbsp;&nbsp; <span class="Statement">case</span> <span class="Special">'\\'</span>: printf(<span class="Constant">&quot;</span><span class="Special">\\\\</span><span class="Constant">&quot;</span>); <span class="Statement">break</span>;<br/></li>
<li>&nbsp;&nbsp; <span class="Statement">case</span> <span class="Special">'\a'</span>: printf(<span class="Constant">&quot;</span><span class="Special">\\</span><span class="Constant">a&quot;</span>); <span class="Statement">break</span>;<br/></li>
<li>&nbsp;&nbsp; <span class="Statement">case</span> <span class="Special">'\b'</span>: printf(<span class="Constant">&quot;</span><span class="Special">\\</span><span class="Constant">b&quot;</span>); <span class="Statement">break</span>;<br/></li>
<li>&nbsp;&nbsp; <span class="Statement">case</span> <span class="Special">'\f'</span>: printf(<span class="Constant">&quot;</span><span class="Special">\\</span><span class="Constant">f&quot;</span>); <span class="Statement">break</span>;<br/></li>
<li>&nbsp;&nbsp; <span class="Statement">case</span> <span class="Special">'\n'</span>: printf(<span class="Constant">&quot;</span><span class="Special">\\</span><span class="Constant">n&quot;</span>); <span class="Statement">break</span>;<br/></li>
<li>&nbsp;&nbsp; <span class="Statement">case</span> <span class="Special">'\r'</span>: printf(<span class="Constant">&quot;</span><span class="Special">\\</span><span class="Constant">r&quot;</span>); <span class="Statement">break</span>;<br/></li>
<li>&nbsp;&nbsp; <span class="Statement">case</span> <span class="Special">'\t'</span>: printf(<span class="Constant">&quot;</span><span class="Special">\\</span><span class="Constant">t&quot;</span>); <span class="Statement">break</span>;<br/></li>
<li>&nbsp;&nbsp; <span class="Statement">case</span> <span class="Special">'\v'</span>: printf(<span class="Constant">&quot;</span><span class="Special">\\</span><span class="Constant">v&quot;</span>); <span class="Statement">break</span>;<br/></li>
<li><span class="cUserCont">&nbsp;&nbsp; </span><span class="Statement">default</span><span class="cUserCont">:</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (isprint(c))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; printf(<span class="Constant">&quot;</span><span class="Special">%c</span><span class="Constant">&quot;</span>,c);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; printf(<span class="Constant">&quot;</span><span class="Special">\\%03d</span><span class="Constant">&quot;</span>,c);<br/></li>
<li>&nbsp; }<br/></li>
<li> }<br/></li>
<li> printf(<span class="Constant">&quot;</span><span class="Special">%c</span><span class="Constant">&quot;</span>,<span class="Constant">'&quot;'</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L254">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">PrintConstant</span>(<span class="Type">const</span> <a href="lobject.h.html#L398" title="lobject.h:398">Proto</a>* f, <span class="Type">int</span> i)<br/></li>
<li>{<br/></li>
<li> <span class="Type">const</span> <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a>* o=&amp;f-&gt;k[i];<br/></li>
<li> <span class="Statement">switch</span> (<a href="lobject.h.html#L125" title="lobject.h:125">ttype</a>(o))<br/></li>
<li> {<br/></li>
<li>&nbsp; <span class="Statement">case</span> <a href="lua.h.html#L62" title="lua.h:62">LUA_TNIL</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; printf(<span class="Constant">&quot;nil&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; <span class="Statement">case</span> <a href="lua.h.html#L63" title="lua.h:63">LUA_TBOOLEAN</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; printf(<a href="lobject.h.html#L168" title="lobject.h:168">bvalue</a>(o) ? <span class="Constant">&quot;true&quot;</span> : <span class="Constant">&quot;false&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; <span class="Statement">case</span> <a href="lobject.h.html#L60" title="lobject.h:60">LUA_TNUMFLT</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">char</span> buff[<span class="Constant">100</span>];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; sprintf(buff,<a href="luaconf.h.html#L410" title="luaconf.h:410">LUA_NUMBER_FMT</a>,<a href="lobject.h.html#L156" title="lobject.h:156">fltvalue</a>(o));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; printf(<span class="Constant">&quot;</span><span class="Special">%s</span><span class="Constant">&quot;</span>,buff);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (buff[strspn(buff,<span class="Constant">&quot;-0123456789&quot;</span>)]==<span class="Special">'\0'</span>) printf(<span class="Constant">&quot;.0&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">case</span> <a href="lobject.h.html#L61" title="lobject.h:61">LUA_TNUMINT</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; printf(<a href="luaconf.h.html#L527" title="luaconf.h:527">LUA_INTEGER_FMT</a>,<a href="lobject.h.html#L155" title="lobject.h:155">ivalue</a>(o));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; <span class="Statement">case</span> <a href="lobject.h.html#L55" title="lobject.h:55">LUA_TSHRSTR</a>: <span class="Statement">case</span> <a href="lobject.h.html#L56" title="lobject.h:56">LUA_TLNGSTR</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L226" title="luac.c:226">PrintString</a>(<a href="lobject.h.html#L161" title="lobject.h:161">tsvalue</a>(o));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><span class="cUserCont">&nbsp; </span><span class="Statement">default</span><span class="cUserCont">:</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* <a href="#L44" title="luac.c:44">cannot</a> happen */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; printf(<span class="Constant">&quot;? type=</span><span class="Special">%d</span><span class="Constant">&quot;</span>,<a href="lobject.h.html#L125" title="lobject.h:125">ttype</a>(o));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li> }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L285">&#x200c;</a><span class="PreProc">#define <span class="linkable">UPVALNAME</span>(x) ((f-&gt;upvalues[x].name) ? <a href="lobject.h.html#L326" title="lobject.h:326">getstr</a>(f-&gt;upvalues[x].name) : </span><span class="Constant">&quot;-&quot;</span><span class="PreProc">)<br/></li>
<li><a id="L286">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">MYK</span>(x)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (-</span><span class="Constant">1</span><span class="PreProc">-(x))<br/></li>
<li></span><br/></li>
<li><a id="L288">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">PrintCode</span>(<span class="Type">const</span> <a href="lobject.h.html#L398" title="lobject.h:398">Proto</a>* f)<br/></li>
<li>{<br/></li>
<li> <span class="Type">const</span> <a href="llimits.h.html#L164" title="llimits.h:164">Instruction</a>* code=f-&gt;code;<br/></li>
<li> <span class="Type">int</span> pc,n=f-&gt;sizecode;<br/></li>
<li> <span class="Statement">for</span> (pc=<span class="Constant">0</span>; pc&lt;n; pc++)<br/></li>
<li> {<br/></li>
<li>&nbsp; <a href="llimits.h.html#L164" title="llimits.h:164">Instruction</a> i=code[pc];<br/></li>
<li>&nbsp; <a href="lopcodes.h.html#L232" title="lopcodes.h:232">OpCode</a> o=<a href="lopcodes.h.html#L89" title="lopcodes.h:89">GET_OPCODE</a>(i);<br/></li>
<li>&nbsp; <span class="Type">int</span> a=<a href="lopcodes.h.html#L97" title="lopcodes.h:97">GETARG_A</a>(i);<br/></li>
<li>&nbsp; <span class="Type">int</span> b=<a href="lopcodes.h.html#L100" title="lopcodes.h:100">GETARG_B</a>(i);<br/></li>
<li>&nbsp; <span class="Type">int</span> c=<a href="lopcodes.h.html#L103" title="lopcodes.h:103">GETARG_C</a>(i);<br/></li>
<li>&nbsp; <span class="Type">int</span> ax=<a href="lopcodes.h.html#L109" title="lopcodes.h:109">GETARG_Ax</a>(i);<br/></li>
<li>&nbsp; <span class="Type">int</span> bx=<a href="lopcodes.h.html#L106" title="lopcodes.h:106">GETARG_Bx</a>(i);<br/></li>
<li>&nbsp; <span class="Type">int</span> sbx=<a href="lopcodes.h.html#L112" title="lopcodes.h:112">GETARG_sBx</a>(i);<br/></li>
<li>&nbsp; <span class="Type">int</span> line=<a href="ldebug.h.html#L16" title="ldebug.h:16">getfuncline</a>(f,pc);<br/></li>
<li>&nbsp; printf(<span class="Constant">&quot;</span><span class="Special">\t%d\t</span><span class="Constant">&quot;</span>,pc+<span class="Constant">1</span>);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (line&gt;<span class="Constant">0</span>) printf(<span class="Constant">&quot;[</span><span class="Special">%d</span><span class="Constant">]</span><span class="Special">\t</span><span class="Constant">&quot;</span>,line); <span class="Statement">else</span> printf(<span class="Constant">&quot;[-]</span><span class="Special">\t</span><span class="Constant">&quot;</span>);<br/></li>
<li>&nbsp; printf(<span class="Constant">&quot;</span><span class="Special">%-9s\t</span><span class="Constant">&quot;</span>,<a href="lopcodes.c.html#L20" title="lopcodes.c:20">luaP_opnames</a>[o]);<br/></li>
<li>&nbsp; <span class="Statement">switch</span> (<a href="lopcodes.h.html#L281" title="lopcodes.h:281">getOpMode</a>(o))<br/></li>
<li>&nbsp; {<br/></li>
<li>&nbsp;&nbsp; <span class="Statement">case</span> iABC:<br/></li>
<li>&nbsp; &nbsp; printf(<span class="Constant">&quot;</span><span class="Special">%d</span><span class="Constant">&quot;</span>,a);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="lopcodes.h.html#L282" title="lopcodes.h:282">getBMode</a>(o)!=OpArgN) printf(<span class="Constant">&quot; </span><span class="Special">%d</span><span class="Constant">&quot;</span>,<a href="lopcodes.h.html#L137" title="lopcodes.h:137">ISK</a>(b) ? (<a href="#L286" title="luac.c:286">MYK</a>(<a href="lopcodes.h.html#L140" title="lopcodes.h:140">INDEXK</a>(b))) : b);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="lopcodes.h.html#L283" title="lopcodes.h:283">getCMode</a>(o)!=OpArgN) printf(<span class="Constant">&quot; </span><span class="Special">%d</span><span class="Constant">&quot;</span>,<a href="lopcodes.h.html#L137" title="lopcodes.h:137">ISK</a>(c) ? (<a href="#L286" title="luac.c:286">MYK</a>(<a href="lopcodes.h.html#L140" title="lopcodes.h:140">INDEXK</a>(c))) : c);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp;&nbsp; <span class="Statement">case</span> iABx:<br/></li>
<li>&nbsp; &nbsp; printf(<span class="Constant">&quot;</span><span class="Special">%d</span><span class="Constant">&quot;</span>,a);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="lopcodes.h.html#L282" title="lopcodes.h:282">getBMode</a>(o)==OpArgK) printf(<span class="Constant">&quot; </span><span class="Special">%d</span><span class="Constant">&quot;</span>,<a href="#L286" title="luac.c:286">MYK</a>(bx));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="lopcodes.h.html#L282" title="lopcodes.h:282">getBMode</a>(o)==OpArgU) printf(<span class="Constant">&quot; </span><span class="Special">%d</span><span class="Constant">&quot;</span>,bx);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp;&nbsp; <span class="Statement">case</span> iAsBx:<br/></li>
<li>&nbsp; &nbsp; printf(<span class="Constant">&quot;</span><span class="Special">%d</span><span class="Constant"> </span><span class="Special">%d</span><span class="Constant">&quot;</span>,a,sbx);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp;&nbsp; <span class="Statement">case</span> iAx:<br/></li>
<li>&nbsp; &nbsp; printf(<span class="Constant">&quot;</span><span class="Special">%d</span><span class="Constant">&quot;</span>,<a href="#L286" title="luac.c:286">MYK</a>(ax));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">switch</span> (o)<br/></li>
<li>&nbsp; {<br/></li>
<li>&nbsp;&nbsp; <span class="Statement">case</span> OP_LOADK:<br/></li>
<li>&nbsp; &nbsp; printf(<span class="Constant">&quot;</span><span class="Special">\t</span><span class="Constant">; &quot;</span>); <a href="#L254" title="luac.c:254">PrintConstant</a>(f,bx);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp;&nbsp; <span class="Statement">case</span> OP_GETUPVAL:<br/></li>
<li>&nbsp;&nbsp; <span class="Statement">case</span> OP_SETUPVAL:<br/></li>
<li>&nbsp; &nbsp; printf(<span class="Constant">&quot;</span><span class="Special">\t</span><span class="Constant">; </span><span class="Special">%s</span><span class="Constant">&quot;</span>,<a href="#L285" title="luac.c:285">UPVALNAME</a>(b));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp;&nbsp; <span class="Statement">case</span> OP_GETTABUP:<br/></li>
<li>&nbsp; &nbsp; printf(<span class="Constant">&quot;</span><span class="Special">\t</span><span class="Constant">; </span><span class="Special">%s</span><span class="Constant">&quot;</span>,<a href="#L285" title="luac.c:285">UPVALNAME</a>(b));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="lopcodes.h.html#L137" title="lopcodes.h:137">ISK</a>(c)) { printf(<span class="Constant">&quot; &quot;</span>); <a href="#L254" title="luac.c:254">PrintConstant</a>(f,<a href="lopcodes.h.html#L140" title="lopcodes.h:140">INDEXK</a>(c)); }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp;&nbsp; <span class="Statement">case</span> OP_SETTABUP:<br/></li>
<li>&nbsp; &nbsp; printf(<span class="Constant">&quot;</span><span class="Special">\t</span><span class="Constant">; </span><span class="Special">%s</span><span class="Constant">&quot;</span>,<a href="#L285" title="luac.c:285">UPVALNAME</a>(a));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="lopcodes.h.html#L137" title="lopcodes.h:137">ISK</a>(b)) { printf(<span class="Constant">&quot; &quot;</span>); <a href="#L254" title="luac.c:254">PrintConstant</a>(f,<a href="lopcodes.h.html#L140" title="lopcodes.h:140">INDEXK</a>(b)); }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="lopcodes.h.html#L137" title="lopcodes.h:137">ISK</a>(c)) { printf(<span class="Constant">&quot; &quot;</span>); <a href="#L254" title="luac.c:254">PrintConstant</a>(f,<a href="lopcodes.h.html#L140" title="lopcodes.h:140">INDEXK</a>(c)); }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp;&nbsp; <span class="Statement">case</span> OP_GETTABLE:<br/></li>
<li>&nbsp;&nbsp; <span class="Statement">case</span> OP_SELF:<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="lopcodes.h.html#L137" title="lopcodes.h:137">ISK</a>(c)) { printf(<span class="Constant">&quot;</span><span class="Special">\t</span><span class="Constant">; &quot;</span>); <a href="#L254" title="luac.c:254">PrintConstant</a>(f,<a href="lopcodes.h.html#L140" title="lopcodes.h:140">INDEXK</a>(c)); }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp;&nbsp; <span class="Statement">case</span> OP_SETTABLE:<br/></li>
<li>&nbsp;&nbsp; <span class="Statement">case</span> OP_ADD:<br/></li>
<li>&nbsp;&nbsp; <span class="Statement">case</span> OP_SUB:<br/></li>
<li>&nbsp;&nbsp; <span class="Statement">case</span> OP_MUL:<br/></li>
<li>&nbsp;&nbsp; <span class="Statement">case</span> OP_POW:<br/></li>
<li>&nbsp;&nbsp; <span class="Statement">case</span> OP_DIV:<br/></li>
<li>&nbsp;&nbsp; <span class="Statement">case</span> OP_IDIV:<br/></li>
<li>&nbsp;&nbsp; <span class="Statement">case</span> OP_BAND:<br/></li>
<li>&nbsp;&nbsp; <span class="Statement">case</span> OP_BOR:<br/></li>
<li>&nbsp;&nbsp; <span class="Statement">case</span> OP_BXOR:<br/></li>
<li>&nbsp;&nbsp; <span class="Statement">case</span> OP_SHL:<br/></li>
<li>&nbsp;&nbsp; <span class="Statement">case</span> OP_SHR:<br/></li>
<li>&nbsp;&nbsp; <span class="Statement">case</span> OP_EQ:<br/></li>
<li>&nbsp;&nbsp; <span class="Statement">case</span> OP_LT:<br/></li>
<li>&nbsp;&nbsp; <span class="Statement">case</span> OP_LE:<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="lopcodes.h.html#L137" title="lopcodes.h:137">ISK</a>(b) || <a href="lopcodes.h.html#L137" title="lopcodes.h:137">ISK</a>(c))<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp;&nbsp; printf(<span class="Constant">&quot;</span><span class="Special">\t</span><span class="Constant">; &quot;</span>);<br/></li>
<li>&nbsp; &nbsp;&nbsp; <span class="Statement">if</span> (<a href="lopcodes.h.html#L137" title="lopcodes.h:137">ISK</a>(b)) <a href="#L254" title="luac.c:254">PrintConstant</a>(f,<a href="lopcodes.h.html#L140" title="lopcodes.h:140">INDEXK</a>(b)); <span class="Statement">else</span> printf(<span class="Constant">&quot;-&quot;</span>);<br/></li>
<li>&nbsp; &nbsp;&nbsp; printf(<span class="Constant">&quot; &quot;</span>);<br/></li>
<li>&nbsp; &nbsp;&nbsp; <span class="Statement">if</span> (<a href="lopcodes.h.html#L137" title="lopcodes.h:137">ISK</a>(c)) <a href="#L254" title="luac.c:254">PrintConstant</a>(f,<a href="lopcodes.h.html#L140" title="lopcodes.h:140">INDEXK</a>(c)); <span class="Statement">else</span> printf(<span class="Constant">&quot;-&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp;&nbsp; <span class="Statement">case</span> OP_JMP:<br/></li>
<li>&nbsp;&nbsp; <span class="Statement">case</span> OP_FORLOOP:<br/></li>
<li>&nbsp;&nbsp; <span class="Statement">case</span> OP_FORPREP:<br/></li>
<li>&nbsp;&nbsp; <span class="Statement">case</span> OP_TFORLOOP:<br/></li>
<li>&nbsp; &nbsp; printf(<span class="Constant">&quot;</span><span class="Special">\t</span><span class="Constant">; to </span><span class="Special">%d</span><span class="Constant">&quot;</span>,sbx+pc+<span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp;&nbsp; <span class="Statement">case</span> OP_CLOSURE:<br/></li>
<li>&nbsp; &nbsp; printf(<span class="Constant">&quot;</span><span class="Special">\t</span><span class="Constant">; </span><span class="Special">%p</span><span class="Constant">&quot;</span>,<a href="#L224" title="luac.c:224">VOID</a>(f-&gt;p[bx]));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp;&nbsp; <span class="Statement">case</span> OP_SETLIST:<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c==<span class="Constant">0</span>) printf(<span class="Constant">&quot;</span><span class="Special">\t</span><span class="Constant">; </span><span class="Special">%d</span><span class="Constant">&quot;</span>,(<span class="Type">int</span>)code[++pc]); <span class="Statement">else</span> printf(<span class="Constant">&quot;</span><span class="Special">\t</span><span class="Constant">; </span><span class="Special">%d</span><span class="Constant">&quot;</span>,c);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp;&nbsp; <span class="Statement">case</span> OP_EXTRAARG:<br/></li>
<li>&nbsp; &nbsp; printf(<span class="Constant">&quot;</span><span class="Special">\t</span><span class="Constant">; &quot;</span>); <a href="#L254" title="luac.c:254">PrintConstant</a>(f,ax);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><span class="cUserCont">&nbsp;&nbsp; </span><span class="Statement">default</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; printf(<span class="Constant">&quot;</span><span class="Special">\n</span><span class="Constant">&quot;</span>);<br/></li>
<li> }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L392">&#x200c;</a><span class="PreProc">#define <span class="linkable">SS</span>(x)&nbsp; &nbsp; &nbsp; &nbsp; ((x==</span><span class="Constant">1</span><span class="PreProc">)?</span><span class="Constant">&quot;&quot;</span><span class="PreProc">:</span><span class="Constant">&quot;s&quot;</span><span class="PreProc">)<br/></li>
<li><a id="L393">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">S</span>(x)&nbsp; &nbsp; &nbsp; &nbsp; (</span><span class="Type">int</span><span class="PreProc">)(x),<a href="#L392" title="luac.c:392">SS</a>(x)<br/></li>
<li></span><br/></li>
<li><a id="L395">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">PrintHeader</span>(<span class="Type">const</span> <a href="lobject.h.html#L398" title="lobject.h:398">Proto</a>* f)<br/></li>
<li>{<br/></li>
<li> <span class="Type">const</span> <span class="Type">char</span>* s=f-&gt;source ? <a href="lobject.h.html#L326" title="lobject.h:326">getstr</a>(f-&gt;source) : <span class="Constant">&quot;=?&quot;</span>;<br/></li>
<li> <span class="Statement">if</span> (*s==<span class="Constant">'@'</span> || *s==<span class="Constant">'='</span>)<br/></li>
<li>&nbsp; s++;<br/></li>
<li> <span class="Statement">else</span> <span class="Statement">if</span> (*s==<a href="lua.h.html#L31" title="lua.h:31">LUA_SIGNATURE</a>[<span class="Constant">0</span>])<br/></li>
<li>&nbsp; s=<span class="Constant">&quot;(bstring)&quot;</span>;<br/></li>
<li> <span class="Statement">else<br/></li>
<li></span>&nbsp; s=<span class="Constant">&quot;(string)&quot;</span>;<br/></li>
<li> printf(<span class="Constant">&quot;</span><span class="Special">\n%s</span><span class="Constant"> &lt;</span><span class="Special">%s</span><span class="Constant">:</span><span class="Special">%d</span><span class="Constant">,</span><span class="Special">%d</span><span class="Constant">&gt; (</span><span class="Special">%d</span><span class="Constant"> instruction</span><span class="Special">%s</span><span class="Constant"> at </span><span class="Special">%p</span><span class="Constant">)</span><span class="Special">\n</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (f-&gt;linedefined==<span class="Constant">0</span>)?<span class="Constant">&quot;<a href="lua.c.html#L595" title="lua.c:595">main</a>&quot;</span>:<span class="Constant">&quot;function&quot;</span>,s,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; f-&gt;linedefined,f-&gt;lastlinedefined,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L393" title="luac.c:393">S</a>(f-&gt;sizecode),<a href="#L224" title="luac.c:224">VOID</a>(f));<br/></li>
<li> printf(<span class="Constant">&quot;</span><span class="Special">%d%s</span><span class="Constant"> param</span><span class="Special">%s</span><span class="Constant">, </span><span class="Special">%d</span><span class="Constant"> slot</span><span class="Special">%s</span><span class="Constant">, </span><span class="Special">%d</span><span class="Constant"> upvalue</span><span class="Special">%s</span><span class="Constant">, &quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; (<span class="Type">int</span>)(f-&gt;numparams),f-&gt;is_vararg?<span class="Constant">&quot;+&quot;</span>:<span class="Constant">&quot;&quot;</span>,<a href="#L392" title="luac.c:392">SS</a>(f-&gt;numparams),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L393" title="luac.c:393">S</a>(f-&gt;maxstacksize),<a href="#L393" title="luac.c:393">S</a>(f-&gt;sizeupvalues));<br/></li>
<li> printf(<span class="Constant">&quot;</span><span class="Special">%d</span><span class="Constant"> local</span><span class="Special">%s</span><span class="Constant">, </span><span class="Special">%d</span><span class="Constant"> constant</span><span class="Special">%s</span><span class="Constant">, </span><span class="Special">%d</span><span class="Constant"> function</span><span class="Special">%s\n</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L393" title="luac.c:393">S</a>(f-&gt;sizelocvars),<a href="#L393" title="luac.c:393">S</a>(f-&gt;sizek),<a href="#L393" title="luac.c:393">S</a>(f-&gt;sizep));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L415">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">PrintDebug</span>(<span class="Type">const</span> <a href="lobject.h.html#L398" title="lobject.h:398">Proto</a>* f)<br/></li>
<li>{<br/></li>
<li> <span class="Type">int</span> i,n;<br/></li>
<li> n=f-&gt;sizek;<br/></li>
<li> printf(<span class="Constant">&quot;constants (</span><span class="Special">%d</span><span class="Constant">) for </span><span class="Special">%p</span><span class="Constant">:</span><span class="Special">\n</span><span class="Constant">&quot;</span>,n,<a href="#L224" title="luac.c:224">VOID</a>(f));<br/></li>
<li> <span class="Statement">for</span> (i=<span class="Constant">0</span>; i&lt;n; i++)<br/></li>
<li> {<br/></li>
<li>&nbsp; printf(<span class="Constant">&quot;</span><span class="Special">\t%d\t</span><span class="Constant">&quot;</span>,i+<span class="Constant">1</span>);<br/></li>
<li>&nbsp; <a href="#L254" title="luac.c:254">PrintConstant</a>(f,i);<br/></li>
<li>&nbsp; printf(<span class="Constant">&quot;</span><span class="Special">\n</span><span class="Constant">&quot;</span>);<br/></li>
<li> }<br/></li>
<li> n=f-&gt;sizelocvars;<br/></li>
<li> printf(<span class="Constant">&quot;locals (</span><span class="Special">%d</span><span class="Constant">) for </span><span class="Special">%p</span><span class="Constant">:</span><span class="Special">\n</span><span class="Constant">&quot;</span>,n,<a href="#L224" title="luac.c:224">VOID</a>(f));<br/></li>
<li> <span class="Statement">for</span> (i=<span class="Constant">0</span>; i&lt;n; i++)<br/></li>
<li> {<br/></li>
<li>&nbsp; printf(<span class="Constant">&quot;</span><span class="Special">\t%d\t%s\t%d\t%d\n</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; i,<a href="lobject.h.html#L326" title="lobject.h:326">getstr</a>(f-&gt;locvars[i].varname),f-&gt;locvars[i].startpc+<span class="Constant">1</span>,f-&gt;locvars[i].endpc+<span class="Constant">1</span>);<br/></li>
<li> }<br/></li>
<li> n=f-&gt;sizeupvalues;<br/></li>
<li> printf(<span class="Constant">&quot;upvalues (</span><span class="Special">%d</span><span class="Constant">) for </span><span class="Special">%p</span><span class="Constant">:</span><span class="Special">\n</span><span class="Constant">&quot;</span>,n,<a href="#L224" title="luac.c:224">VOID</a>(f));<br/></li>
<li> <span class="Statement">for</span> (i=<span class="Constant">0</span>; i&lt;n; i++)<br/></li>
<li> {<br/></li>
<li>&nbsp; printf(<span class="Constant">&quot;</span><span class="Special">\t%d\t%s\t%d\t%d\n</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; i,<a href="#L285" title="luac.c:285">UPVALNAME</a>(i),f-&gt;upvalues[i].instack,f-&gt;upvalues[i].idx);<br/></li>
<li> }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L442">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">PrintFunction</span>(<span class="Type">const</span> <a href="lobject.h.html#L398" title="lobject.h:398">Proto</a>* f, <span class="Type">int</span> full)<br/></li>
<li>{<br/></li>
<li> <span class="Type">int</span> i,n=f-&gt;sizep;<br/></li>
<li> <a href="#L395" title="luac.c:395">PrintHeader</a>(f);<br/></li>
<li> <a href="#L288" title="luac.c:288">PrintCode</a>(f);<br/></li>
<li> <span class="Statement">if</span> (full) <a href="#L415" title="luac.c:415">PrintDebug</a>(f);<br/></li>
<li> <span class="Statement">for</span> (i=<span class="Constant">0</span>; i&lt;n; i++) <a href="#L442" title="luac.c:442">PrintFunction</a>(f-&gt;p[i],full);<br/></li>
<li>}<br/></li>
</ol></code>
 </body>
</html>
