<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>lfunc.c - src</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

code {
    font-family: consolas, monospace;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
  <h3>lfunc.c - src</h3>
   <a href="../index.html"> Table of Contents </a>
 <h4>Functions defined</h4>
 <ul>
<li><a href="#L83">luaF_close</a></li>
<li><a href="#L57">luaF_findupval</a></li>
<li><a href="#L125">luaF_freeproto</a></li>
<li><a href="#L140">luaF_getlocalname</a></li>
<li><a href="#L45">luaF_initupvals</a></li>
<li><a href="#L25">luaF_newCclosure</a></li>
<li><a href="#L33">luaF_newLclosure</a></li>
<li><a href="#L99">luaF_newproto</a></li>
</ul>
 <h4>Macros defined</h4>
 <ul>
<li><a href="#L8">LUA_CORE</a></li>
<li><a href="#L7">lfunc_c</a></li>
</ul>
 <h4>Source code</h4>

  <code><ol><li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** $Id: lfunc.c,v 2.45 2014/11/02 19:19:04 roberto Exp $<br/></li>
<li></span><span class="Comment">** Auxiliary functions to manipulate prototypes and closures<br/></li>
<li></span><span class="Comment">** See Copyright Notice in lua.h<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li></span><br/></li>
<li><a id="L7">&#x200c;</a><span class="PreProc">#define <span class="linkable">lfunc_c</span><br/></li>
<li><a id="L8">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">LUA_CORE</span><br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;lprefix.h&quot;<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;stddef.h&gt;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;lua.h&quot;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;lfunc.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;lgc.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;lmem.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;lobject.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;lstate.h&quot;<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L25">&#x200c;</a><a href="lobject.h.html#L437" title="lobject.h:437">CClosure</a> *<span class="linkable">luaF_newCclosure</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">int</span> n) {<br/></li>
<li>&nbsp; <a href="lobject.h.html#L87" title="lobject.h:87">GCObject</a> *o = <a href="lgc.c.html#L198" title="lgc.c:198">luaC_newobj</a>(L, <a href="lobject.h.html#L51" title="lobject.h:51">LUA_TCCL</a>, <a href="lfunc.h.html#L14" title="lfunc.h:14">sizeCclosure</a>(n));<br/></li>
<li>&nbsp; <a href="lobject.h.html#L437" title="lobject.h:437">CClosure</a> *c = <a href="lstate.h.html#L199" title="lstate.h:199">gco2ccl</a>(o);<br/></li>
<li>&nbsp; c-&gt;nupvalues = <a href="llimits.h.html#L110" title="llimits.h:110">cast_byte</a>(n);<br/></li>
<li>&nbsp; <span class="Statement">return</span> c;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L33">&#x200c;</a><a href="lobject.h.html#L444" title="lobject.h:444">LClosure</a> *<span class="linkable">luaF_newLclosure</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">int</span> n) {<br/></li>
<li>&nbsp; <a href="lobject.h.html#L87" title="lobject.h:87">GCObject</a> *o = <a href="lgc.c.html#L198" title="lgc.c:198">luaC_newobj</a>(L, <a href="lobject.h.html#L49" title="lobject.h:49">LUA_TLCL</a>, <a href="lfunc.h.html#L17" title="lfunc.h:17">sizeLclosure</a>(n));<br/></li>
<li>&nbsp; <a href="lobject.h.html#L444" title="lobject.h:444">LClosure</a> *c = <a href="lstate.h.html#L198" title="lstate.h:198">gco2lcl</a>(o);<br/></li>
<li>&nbsp; c-&gt;p = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; c-&gt;nupvalues = <a href="llimits.h.html#L110" title="llimits.h:110">cast_byte</a>(n);<br/></li>
<li>&nbsp; <span class="Statement">while</span> (n--) c-&gt;upvals[n] = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; <span class="Statement">return</span> c;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** fill a closure with new closed upvalues<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L45">&#x200c;</a></span><span class="Type">void</span> <span class="linkable">luaF_initupvals</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <a href="lobject.h.html#L444" title="lobject.h:444">LClosure</a> *cl) {<br/></li>
<li>&nbsp; <span class="Type">int</span> i;<br/></li>
<li>&nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; cl-&gt;nupvalues; i++) {<br/></li>
<li>&nbsp; &nbsp; <a href="lfunc.h.html#L28" title="lfunc.h:28">UpVal</a> *uv = <a href="lmem.h.html#L46" title="lmem.h:46">luaM_new</a>(L, <a href="lfunc.h.html#L28" title="lfunc.h:28">UpVal</a>);<br/></li>
<li>&nbsp; &nbsp; uv-&gt;refcount = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; uv-&gt;v = &amp;uv-&gt;u.value;&nbsp; <span class="Comment">/* make it closed */<br/></li>
<li></span>&nbsp; &nbsp; <a href="lobject.h.html#L196" title="lobject.h:196">setnilvalue</a>(uv-&gt;v);<br/></li>
<li>&nbsp; &nbsp; cl-&gt;upvals[i] = uv;<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L57">&#x200c;</a><a href="lfunc.h.html#L28" title="lfunc.h:28">UpVal</a> *<span class="linkable">luaF_findupval</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <a href="lobject.h.html#L294" title="lobject.h:294">StkId</a> level) {<br/></li>
<li>&nbsp; <a href="lfunc.h.html#L28" title="lfunc.h:28">UpVal</a> **pp = &amp;L-&gt;openupval;<br/></li>
<li>&nbsp; <a href="lfunc.h.html#L28" title="lfunc.h:28">UpVal</a> *p;<br/></li>
<li>&nbsp; <a href="lfunc.h.html#L28" title="lfunc.h:28">UpVal</a> *uv;<br/></li>
<li>&nbsp; <a href="lualib.h.html#L54" title="lualib.h:54">lua_assert</a>(<a href="lfunc.h.html#L22" title="lfunc.h:22">isintwups</a>(L) || L-&gt;openupval == <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; <span class="Statement">while</span> (*pp != <span class="Constant">NULL</span> &amp;&amp; (p = *pp)-&gt;v &gt;= level) {<br/></li>
<li>&nbsp; &nbsp; <a href="lualib.h.html#L54" title="lualib.h:54">lua_assert</a>(<a href="lfunc.h.html#L40" title="lfunc.h:40">upisopen</a>(p));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (p-&gt;v == level)&nbsp; <span class="Comment">/* found a corresponding upvalue? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span> p;&nbsp; <span class="Comment">/* return it */<br/></li>
<li></span>&nbsp; &nbsp; pp = &amp;p-&gt;u.open.<a href="llex.c.html#L31" title="llex.c:31">next</a>;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Comment">/* not found: create a new upvalue */<br/></li>
<li></span>&nbsp; uv = <a href="lmem.h.html#L46" title="lmem.h:46">luaM_new</a>(L, <a href="lfunc.h.html#L28" title="lfunc.h:28">UpVal</a>);<br/></li>
<li>&nbsp; uv-&gt;refcount = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; uv-&gt;u.open.<a href="llex.c.html#L31" title="llex.c:31">next</a> = *pp;&nbsp; <span class="Comment">/* link it to list of open upvalues */<br/></li>
<li></span>&nbsp; uv-&gt;u.open.touched = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; *pp = uv;<br/></li>
<li>&nbsp; uv-&gt;v = level;&nbsp; <span class="Comment">/* current value lives in the stack */<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (!<a href="lfunc.h.html#L22" title="lfunc.h:22">isintwups</a>(L)) {&nbsp; <span class="Comment">/* thread not in list of threads with upvalues? */<br/></li>
<li></span>&nbsp; &nbsp; L-&gt;twups = <a href="lstate.h.html#L175" title="lstate.h:175">G</a>(L)-&gt;twups;&nbsp; <span class="Comment">/* link it to the list */<br/></li>
<li></span>&nbsp; &nbsp; <a href="lstate.h.html#L175" title="lstate.h:175">G</a>(L)-&gt;twups = L;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> uv;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L83">&#x200c;</a><span class="Type">void</span> <span class="linkable">luaF_close</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <a href="lobject.h.html#L294" title="lobject.h:294">StkId</a> level) {<br/></li>
<li>&nbsp; <a href="lfunc.h.html#L28" title="lfunc.h:28">UpVal</a> *uv;<br/></li>
<li>&nbsp; <span class="Statement">while</span> (L-&gt;openupval != <span class="Constant">NULL</span> &amp;&amp; (uv = L-&gt;openupval)-&gt;v &gt;= level) {<br/></li>
<li>&nbsp; &nbsp; <a href="lualib.h.html#L54" title="lualib.h:54">lua_assert</a>(<a href="lfunc.h.html#L40" title="lfunc.h:40">upisopen</a>(uv));<br/></li>
<li>&nbsp; &nbsp; L-&gt;openupval = uv-&gt;u.open.<a href="llex.c.html#L31" title="llex.c:31">next</a>;&nbsp; <span class="Comment">/* remove from 'open' list */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (uv-&gt;refcount == <span class="Constant">0</span>)&nbsp; <span class="Comment">/* no references? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <a href="lmem.h.html#L42" title="lmem.h:42">luaM_free</a>(L, uv);&nbsp; <span class="Comment">/* free upvalue */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L245" title="lobject.h:245">setobj</a>(L, &amp;uv-&gt;u.value, uv-&gt;v);&nbsp; <span class="Comment">/* move value to upvalue slot */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; uv-&gt;v = &amp;uv-&gt;u.value;&nbsp; <span class="Comment">/* now current value lives here */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <a href="lgc.h.html#L121" title="lgc.h:121">luaC_upvalbarrier</a>(L, uv);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L99">&#x200c;</a><a href="lobject.h.html#L398" title="lobject.h:398">Proto</a> *<span class="linkable">luaF_newproto</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <a href="lobject.h.html#L87" title="lobject.h:87">GCObject</a> *o = <a href="lgc.c.html#L198" title="lgc.c:198">luaC_newobj</a>(L, <a href="lobject.h.html#L22" title="lobject.h:22">LUA_TPROTO</a>, <span class="Statement">sizeof</span>(<a href="lobject.h.html#L398" title="lobject.h:398">Proto</a>));<br/></li>
<li>&nbsp; <a href="lobject.h.html#L398" title="lobject.h:398">Proto</a> *f = <a href="lstate.h.html#L203" title="lstate.h:203">gco2p</a>(o);<br/></li>
<li>&nbsp; f-&gt;k = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; f-&gt;sizek = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; f-&gt;p = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; f-&gt;sizep = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; f-&gt;code = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; f-&gt;cache = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; f-&gt;sizecode = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; f-&gt;lineinfo = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; f-&gt;sizelineinfo = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; f-&gt;upvalues = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; f-&gt;sizeupvalues = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; f-&gt;numparams = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; f-&gt;is_vararg = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; f-&gt;maxstacksize = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; f-&gt;locvars = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; f-&gt;sizelocvars = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; f-&gt;linedefined = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; f-&gt;lastlinedefined = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; f-&gt;source = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; <span class="Statement">return</span> f;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L125">&#x200c;</a><span class="Type">void</span> <span class="linkable">luaF_freeproto</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <a href="lobject.h.html#L398" title="lobject.h:398">Proto</a> *f) {<br/></li>
<li>&nbsp; <a href="lmem.h.html#L43" title="lmem.h:43">luaM_freearray</a>(L, f-&gt;code, f-&gt;sizecode);<br/></li>
<li>&nbsp; <a href="lmem.h.html#L43" title="lmem.h:43">luaM_freearray</a>(L, f-&gt;p, f-&gt;sizep);<br/></li>
<li>&nbsp; <a href="lmem.h.html#L43" title="lmem.h:43">luaM_freearray</a>(L, f-&gt;k, f-&gt;sizek);<br/></li>
<li>&nbsp; <a href="lmem.h.html#L43" title="lmem.h:43">luaM_freearray</a>(L, f-&gt;lineinfo, f-&gt;sizelineinfo);<br/></li>
<li>&nbsp; <a href="lmem.h.html#L43" title="lmem.h:43">luaM_freearray</a>(L, f-&gt;locvars, f-&gt;sizelocvars);<br/></li>
<li>&nbsp; <a href="lmem.h.html#L43" title="lmem.h:43">luaM_freearray</a>(L, f-&gt;upvalues, f-&gt;sizeupvalues);<br/></li>
<li>&nbsp; <a href="lmem.h.html#L42" title="lmem.h:42">luaM_free</a>(L, f);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** Look for n-th local variable at line 'line' in function 'func'.<br/></li>
<li></span><span class="Comment">** Returns NULL if not found.<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L140">&#x200c;</a></span><span class="Type">const</span> <span class="Type">char</span> *<span class="linkable">luaF_getlocalname</span> (<span class="Type">const</span> <a href="lobject.h.html#L398" title="lobject.h:398">Proto</a> *f, <span class="Type">int</span> local_number, <span class="Type">int</span> pc) {<br/></li>
<li>&nbsp; <span class="Type">int</span> i;<br/></li>
<li>&nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i&lt;f-&gt;sizelocvars &amp;&amp; f-&gt;locvars[i].startpc &lt;= pc; i++) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (pc &lt; f-&gt;locvars[i].endpc) {&nbsp; <span class="Comment">/* is variable active? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; local_number--;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (local_number == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="lobject.h.html#L326" title="lobject.h:326">getstr</a>(f-&gt;locvars[i].varname);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;&nbsp; <span class="Comment">/* not found */<br/></li>
<li></span>}<br/></li>
<li><br/></li>
</ol></code>
 </body>
</html>
