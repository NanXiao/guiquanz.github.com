<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>lua.c - src</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

code {
    font-family: consolas, monospace;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
  <h3>lua.c - src</h3>
   <a href="../index.html"> Table of Contents </a>
 <h4>Global variables defined</h4>
 <ul>
<li><a href="#L103">globalL</a></li>
<li><a href="#L105">progname</a></li>
</ul>
 <h4>Functions defined</h4>
 <ul>
<li><a href="#L332">addreturn</a></li>
<li><a href="#L464">collectargs</a></li>
<li><a href="#L226">createargtable</a></li>
<li><a href="#L404">doREPL</a></li>
<li><a href="#L198">docall</a></li>
<li><a href="#L239">dochunk</a></li>
<li><a href="#L245">dofile</a></li>
<li><a href="#L259">dolibrary</a></li>
<li><a href="#L250">dostring</a></li>
<li><a href="#L273">get_prompt</a></li>
<li><a href="#L534">handle_luainit</a></li>
<li><a href="#L436">handle_script</a></li>
<li><a href="#L291">incomplete</a></li>
<li><a href="#L155">l_message</a></li>
<li><a href="#L387">l_print</a></li>
<li><a href="#L124">laction</a></li>
<li><a href="#L370">loadline</a></li>
<li><a href="#L111">lstop</a></li>
<li><a href="#L595">main</a></li>
<li><a href="#L179">msghandler</a></li>
<li><a href="#L350">multiline</a></li>
<li><a href="#L553">pmain</a></li>
<li><a href="#L130">print_usage</a></li>
<li><a href="#L212">print_version</a></li>
<li><a href="#L423">pushargs</a></li>
<li><a href="#L307">pushline</a></li>
<li><a href="#L166">report</a></li>
<li><a href="#L513">runargs</a></li>
</ul>
 <h4>Macros defined</h4>
 <ul>
<li><a href="#L282">EOFMARK</a></li>
<li><a href="#L40">LUA_INITVARVERSION</a></li>
<li><a href="#L37">LUA_INIT_VAR</a></li>
<li><a href="#L33">LUA_MAXINPUT</a></li>
<li><a href="#L29">LUA_PROGNAME</a></li>
<li><a href="#L24">LUA_PROMPT</a></li>
<li><a href="#L25">LUA_PROMPT2</a></li>
<li><a href="#L456">has_E</a></li>
<li><a href="#L455">has_e</a></li>
<li><a href="#L452">has_error</a></li>
<li><a href="#L453">has_i</a></li>
<li><a href="#L454">has_v</a></li>
<li><a href="#L7">lua_c</a></li>
<li><a href="#L86">lua_freeline</a></li>
<li><a href="#L94">lua_freeline</a></li>
<li><a href="#L82">lua_readline</a></li>
<li><a href="#L90">lua_readline</a></li>
<li><a href="#L83">lua_saveline</a></li>
<li><a href="#L93">lua_saveline</a></li>
<li><a href="#L53">lua_stdin_is_tty</a></li>
<li><a href="#L58">lua_stdin_is_tty</a></li>
<li><a href="#L63">lua_stdin_is_tty</a></li>
<li><a href="#L283">marklen</a></li>
</ul>
 <h4>Source code</h4>

  <code><ol><li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** $Id: lua.c,v 1.222 2014/11/11 19:41:27 roberto Exp $<br/></li>
<li></span><span class="Comment">** Lua stand-alone interpreter<br/></li>
<li></span><span class="Comment">** See Copyright Notice in lua.h<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li></span><br/></li>
<li><a id="L7">&#x200c;</a><span class="PreProc">#define <span class="linkable">lua_c</span><br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;lprefix.h&quot;<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;signal.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;stdio.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;stdlib.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;string.h&gt;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;lua.h&quot;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;lauxlib.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;lualib.h&quot;<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="PreProc">#if !defined(<a href="#L24" title="lua.c:24">LUA_PROMPT</a>)<br/></li>
<li><a id="L24">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">LUA_PROMPT</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">&quot;&gt; &quot;<br/></li>
<li><a id="L25">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">LUA_PROMPT2</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">&quot;&gt;&gt; &quot;<br/></li>
<li></span><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#if !defined(<a href="#L29" title="lua.c:29">LUA_PROGNAME</a>)<br/></li>
<li><a id="L29">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">LUA_PROGNAME</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">&quot;lua&quot;<br/></li>
<li></span><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#if !defined(<a href="#L33" title="lua.c:33">LUA_MAXINPUT</a>)<br/></li>
<li><a id="L33">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">LUA_MAXINPUT</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">512<br/></li>
<li></span><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#if !defined(<a href="#L37" title="lua.c:37">LUA_INIT_VAR</a>)<br/></li>
<li><a id="L37">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">LUA_INIT_VAR</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">&quot;LUA_INIT&quot;<br/></li>
<li></span><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><a id="L40">&#x200c;</a><span class="PreProc">#define <span class="linkable">LUA_INITVARVERSION</span>&nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L37" title="lua.c:37">LUA_INIT_VAR</a> </span><span class="Constant">&quot;_&quot;</span><span class="PreProc"> <a href="lua.h.html#L19" title="lua.h:19">LUA_VERSION_MAJOR</a> </span><span class="Constant">&quot;_&quot;</span><span class="PreProc"> <a href="lua.h.html#L20" title="lua.h:20">LUA_VERSION_MINOR</a><br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** <a href="#L53" title="lua.c:53">lua_stdin_is_tty</a> detects whether the standard input is a 'tty' (that<br/></li>
<li></span><span class="Comment">** is, whether we're running lua interactively).<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li></span><span class="PreProc">#if !defined(<a href="#L53" title="lua.c:53">lua_stdin_is_tty</a>)&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Comment">/* { */<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#if defined(<a href="luaconf.h.html#L62" title="luaconf.h:62">LUA_USE_POSIX</a>)&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Comment">/* { */<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;unistd.h&gt;<br/></li>
<li><a id="L53">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">lua_stdin_is_tty</span>()&nbsp; &nbsp; &nbsp; &nbsp; isatty(</span><span class="Constant">0</span><span class="PreProc">)<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#elif defined(<a href="luaconf.h.html#L51" title="luaconf.h:51">LUA_USE_WINDOWS</a>)&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Comment">/* }{ */<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;io.h&gt;<br/></li>
<li><a id="L58">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">lua_stdin_is_tty</span>()&nbsp; &nbsp; &nbsp; &nbsp; _isatty(_fileno(</span><span class="Constant">stdin</span><span class="PreProc">))<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#else</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* }{ */<br/></li>
<li></span><br/></li>
<li><span class="Comment">/* ISO C definition */<br/></li>
<li><a id="L63">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">lua_stdin_is_tty</span>()&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">1</span><span class="PreProc">&nbsp; </span><span class="Comment">/* assume stdin is a tty */<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#endif</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* } */<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#endif</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* } */<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** <a href="#L82" title="lua.c:82">lua_readline</a> defines how to show a prompt and then read a line from<br/></li>
<li></span><span class="Comment">** the standard input.<br/></li>
<li></span><span class="Comment">** <a href="#L83" title="lua.c:83">lua_saveline</a> defines how to &quot;<a href="llex.c.html#L56" title="llex.c:56">save</a>&quot; a read line in a &quot;history&quot;.<br/></li>
<li></span><span class="Comment">** <a href="#L86" title="lua.c:86">lua_freeline</a> defines how to free a line read by <a href="#L82" title="lua.c:82">lua_readline</a>.<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li></span><span class="PreProc">#if !defined(<a href="#L82" title="lua.c:82">lua_readline</a>)&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Comment">/* { */<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#if defined(<a href="luaconf.h.html#L64" title="luaconf.h:64">LUA_USE_READLINE</a>)&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Comment">/* { */<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;readline/readline.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;readline/history.h&gt;<br/></li>
<li><a id="L82">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">lua_readline</span>(L,b,p)&nbsp; &nbsp; &nbsp; &nbsp; ((</span><span class="Type">void</span><span class="PreProc">)L, ((b)=readline(p)) != </span><span class="Constant">NULL</span><span class="PreProc">)<br/></li>
<li><a id="L83">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">lua_saveline</span>(L,idx) \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">if</span><span class="PreProc"> (<a href="lapi.c.html#L390" title="lapi.c:390">lua_rawlen</a>(L,idx) &gt; </span><span class="Constant">0</span><span class="PreProc">)&nbsp; </span><span class="Comment">/* non-empty line? */</span><span class="PreProc"> \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; add_history(<a href="lua.h.html#L365" title="lua.h:365">lua_tostring</a>(L, idx));&nbsp; </span><span class="Comment">/* add it to history */<br/></li>
<li><a id="L86">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">lua_freeline</span>(L,b)&nbsp; &nbsp; &nbsp; &nbsp; ((</span><span class="Type">void</span><span class="PreProc">)L, free(b))<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#else</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* }{ */<br/></li>
<li></span><br/></li>
<li><a id="L90">&#x200c;</a><span class="PreProc">#define <span class="linkable">lua_readline</span>(L,b,p) \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; &nbsp; &nbsp; ((</span><span class="Type">void</span><span class="PreProc">)L, fputs(p, </span><span class="Constant">stdout</span><span class="PreProc">), fflush(</span><span class="Constant">stdout</span><span class="PreProc">),&nbsp; </span><span class="Comment">/* show prompt */</span><span class="PreProc"> \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; &nbsp; &nbsp; fgets(b, <a href="#L33" title="lua.c:33">LUA_MAXINPUT</a>, </span><span class="Constant">stdin</span><span class="PreProc">) != </span><span class="Constant">NULL</span><span class="PreProc">)&nbsp; </span><span class="Comment">/* get line */<br/></li>
<li><a id="L93">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">lua_saveline</span>(L,idx)&nbsp; &nbsp; &nbsp; &nbsp; { (</span><span class="Type">void</span><span class="PreProc">)L; (</span><span class="Type">void</span><span class="PreProc">)idx; }<br/></li>
<li><a id="L94">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">lua_freeline</span>(L,b)&nbsp; &nbsp; &nbsp; &nbsp; { (</span><span class="Type">void</span><span class="PreProc">)L; (</span><span class="Type">void</span><span class="PreProc">)b; }<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#endif</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* } */<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#endif</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* } */<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L103">&#x200c;</a><span class="Type">static</span> <a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *<span class="linkable">globalL</span> = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li><a id="L105">&#x200c;</a><span class="Type">static</span> <span class="Type">const</span> <span class="Type">char</span> *<span class="linkable">progname</span> = <a href="#L29" title="lua.c:29">LUA_PROGNAME</a>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** Hook set by signal function to stop the interpreter.<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L111">&#x200c;</a></span><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">lstop</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <a href="lua.h.html#L440" title="lua.h:440">lua_Debug</a> *ar) {<br/></li>
<li>&nbsp; (<span class="Type">void</span>)ar;&nbsp; <span class="Comment">/* unused arg. */<br/></li>
<li></span>&nbsp; <a href="ldebug.c.html#L54" title="ldebug.c:54">lua_sethook</a>(L, <span class="Constant">NULL</span>, <span class="Constant">0</span>, <span class="Constant">0</span>);&nbsp; <span class="Comment">/* reset hook */<br/></li>
<li></span>&nbsp; <a href="lauxlib.c.html#L212" title="lauxlib.c:212">luaL_error</a>(L, <span class="Constant">&quot;interrupted!&quot;</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** Function to be called at a C signal. Because a C signal <a href="luac.c.html#L44" title="luac.c:44">cannot</a><br/></li>
<li></span><span class="Comment">** just change a Lua state (as there is no proper synchronization),<br/></li>
<li></span><span class="Comment">** this function only sets a hook that, when called, will stop the<br/></li>
<li></span><span class="Comment">** interpreter.<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L124">&#x200c;</a></span><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">laction</span> (<span class="Type">int</span> i) {<br/></li>
<li>&nbsp; signal(i, <span class="Constant">SIG_DFL</span>); <span class="Comment">/* if another SIGINT happens, terminate process */<br/></li>
<li></span>&nbsp; <a href="ldebug.c.html#L54" title="ldebug.c:54">lua_sethook</a>(<a href="#L103" title="lua.c:103">globalL</a>, <a href="#L111" title="lua.c:111">lstop</a>, <a href="lua.h.html#L411" title="lua.h:411">LUA_MASKCALL</a> | <a href="lua.h.html#L412" title="lua.h:412">LUA_MASKRET</a> | <a href="lua.h.html#L414" title="lua.h:414">LUA_MASKCOUNT</a>, <span class="Constant">1</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L130">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">print_usage</span> (<span class="Type">const</span> <span class="Type">char</span> *badoption) {<br/></li>
<li>&nbsp; <a href="lauxlib.h.html#L225" title="lauxlib.h:225">lua_writestringerror</a>(<span class="Constant">&quot;</span><span class="Special">%s</span><span class="Constant">: &quot;</span>, <a href="#L105" title="lua.c:105">progname</a>);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (badoption[<span class="Constant">1</span>] == <span class="Constant">'e'</span> || badoption[<span class="Constant">1</span>] == <span class="Constant">'l'</span>)<br/></li>
<li>&nbsp; &nbsp; <a href="lauxlib.h.html#L225" title="lauxlib.h:225">lua_writestringerror</a>(<span class="Constant">&quot;'</span><span class="Special">%s</span><span class="Constant">' needs argument</span><span class="Special">\n</span><span class="Constant">&quot;</span>, badoption);<br/></li>
<li>&nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; <a href="lauxlib.h.html#L225" title="lauxlib.h:225">lua_writestringerror</a>(<span class="Constant">&quot;unrecognized option '</span><span class="Special">%s</span><span class="Constant">'</span><span class="Special">\n</span><span class="Constant">&quot;</span>, badoption);<br/></li>
<li>&nbsp; <a href="lauxlib.h.html#L225" title="lauxlib.h:225">lua_writestringerror</a>(<br/></li>
<li>&nbsp; <span class="Constant">&quot;<a href="luac.c.html#L50" title="luac.c:50">usage</a>: </span><span class="Special">%s</span><span class="Constant"> [options] [script [args]]</span><span class="Special">\n</span><span class="Constant">&quot;<br/></li>
<li></span>&nbsp; <span class="Constant">&quot;Available options are:</span><span class="Special">\n</span><span class="Constant">&quot;<br/></li>
<li></span>&nbsp; <span class="Constant">&quot;&nbsp; -e stat&nbsp; execute string 'stat'</span><span class="Special">\n</span><span class="Constant">&quot;<br/></li>
<li></span>&nbsp; <span class="Constant">&quot;&nbsp; -i&nbsp; &nbsp; &nbsp;&nbsp; enter interactive mode after executing 'script'</span><span class="Special">\n</span><span class="Constant">&quot;<br/></li>
<li></span>&nbsp; <span class="Constant">&quot;&nbsp; -l name&nbsp; require library 'name'</span><span class="Special">\n</span><span class="Constant">&quot;<br/></li>
<li></span>&nbsp; <span class="Constant">&quot;&nbsp; -v&nbsp; &nbsp; &nbsp;&nbsp; show version information</span><span class="Special">\n</span><span class="Constant">&quot;<br/></li>
<li></span>&nbsp; <span class="Constant">&quot;&nbsp; -E&nbsp; &nbsp; &nbsp;&nbsp; ignore environment variables</span><span class="Special">\n</span><span class="Constant">&quot;<br/></li>
<li></span>&nbsp; <span class="Constant">&quot;&nbsp; --&nbsp; &nbsp; &nbsp;&nbsp; stop handling options</span><span class="Special">\n</span><span class="Constant">&quot;<br/></li>
<li></span>&nbsp; <span class="Constant">&quot;&nbsp; -&nbsp; &nbsp; &nbsp; &nbsp; stop handling options and execute stdin</span><span class="Special">\n</span><span class="Constant">&quot;<br/></li>
<li></span>&nbsp; ,<br/></li>
<li>&nbsp; <a href="#L105" title="lua.c:105">progname</a>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** Prints an <a href="lundump.c.html#L40" title="lundump.c:40">error</a> message, adding the program name in front of it<br/></li>
<li></span><span class="Comment">** (if present)<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L155">&#x200c;</a></span><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">l_message</span> (<span class="Type">const</span> <span class="Type">char</span> *pname, <span class="Type">const</span> <span class="Type">char</span> *msg) {<br/></li>
<li>&nbsp; <span class="Statement">if</span> (pname) <a href="lauxlib.h.html#L225" title="lauxlib.h:225">lua_writestringerror</a>(<span class="Constant">&quot;</span><span class="Special">%s</span><span class="Constant">: &quot;</span>, pname);<br/></li>
<li>&nbsp; <a href="lauxlib.h.html#L225" title="lauxlib.h:225">lua_writestringerror</a>(<span class="Constant">&quot;</span><span class="Special">%s\n</span><span class="Constant">&quot;</span>, msg);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** Check whether 'status' is not OK and, if so, prints the <a href="lundump.c.html#L40" title="lundump.c:40">error</a><br/></li>
<li></span><span class="Comment">** message on the top of the stack. It assumes that the <a href="lundump.c.html#L40" title="lundump.c:40">error</a> object<br/></li>
<li></span><span class="Comment">** is a string, as it was either generated by Lua or by '<a href="#L179" title="lua.c:179">msghandler</a>'.<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L166">&#x200c;</a></span><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">report</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">int</span> status) {<br/></li>
<li>&nbsp; <span class="Statement">if</span> (status != <a href="lua.h.html#L45" title="lua.h:45">LUA_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span> *msg = <a href="lua.h.html#L365" title="lua.h:365">lua_tostring</a>(L, -<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="#L155" title="lua.c:155">l_message</a>(<a href="#L105" title="lua.c:105">progname</a>, msg);<br/></li>
<li>&nbsp; &nbsp; <a href="lua.h.html#L342" title="lua.h:342">lua_pop</a>(L, <span class="Constant">1</span>);&nbsp; <span class="Comment">/* remove message */<br/></li>
<li></span>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> status;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** Message handler used to run all chunks<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L179">&#x200c;</a></span><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">msghandler</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">char</span> *msg = <a href="lua.h.html#L365" title="lua.h:365">lua_tostring</a>(L, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (msg == <span class="Constant">NULL</span>) {&nbsp; <span class="Comment">/* is <a href="lundump.c.html#L40" title="lundump.c:40">error</a> object not a string? */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="lauxlib.c.html#L726" title="lauxlib.c:726">luaL_callmeta</a>(L, <span class="Constant">1</span>, <span class="Constant">&quot;__tostring&quot;</span>) &amp;&amp;&nbsp; <span class="Comment">/* does it have a metamethod */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lapi.c.html#L250" title="lapi.c:250">lua_type</a>(L, -<span class="Constant">1</span>) == <a href="lua.h.html#L66" title="lua.h:66">LUA_TSTRING</a>)&nbsp; <span class="Comment">/* that produces a string? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">1</span>;&nbsp; <span class="Comment">/* that is the message */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; msg = <a href="lapi.c.html#L513" title="lapi.c:513">lua_pushfstring</a>(L, <span class="Constant">&quot;(<a href="lundump.c.html#L40" title="lundump.c:40">error</a> object is a </span><span class="Special">%s</span><span class="Constant"> value)&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="lauxlib.h.html#L119" title="lauxlib.h:119">luaL_typename</a>(L, <span class="Constant">1</span>));<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <a href="lauxlib.c.html#L125" title="lauxlib.c:125">luaL_traceback</a>(L, L, msg, <span class="Constant">1</span>);&nbsp; <span class="Comment">/* append a standard traceback */<br/></li>
<li></span>&nbsp; <span class="Statement">return</span> <span class="Constant">1</span>;&nbsp; <span class="Comment">/* return the traceback */<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** Interface to '<a href="lua.h.html#L276" title="lua.h:276">lua_pcall</a>', which sets appropriate message function<br/></li>
<li></span><span class="Comment">** and C-signal handler. Used to run all chunks.<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L198">&#x200c;</a></span><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">docall</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">int</span> narg, <span class="Type">int</span> nres) {<br/></li>
<li>&nbsp; <span class="Type">int</span> status;<br/></li>
<li>&nbsp; <span class="Type">int</span> base = <a href="lapi.c.html#L166" title="lapi.c:166">lua_gettop</a>(L) - narg;&nbsp; <span class="Comment">/* function index */<br/></li>
<li></span>&nbsp; <a href="lua.h.html#L348" title="lua.h:348">lua_pushcfunction</a>(L, <a href="#L179" title="lua.c:179">msghandler</a>);&nbsp; <span class="Comment">/* push message handler */<br/></li>
<li></span>&nbsp; <a href="lua.h.html#L368" title="lua.h:368">lua_insert</a>(L, base);&nbsp; <span class="Comment">/* put it under function and args */<br/></li>
<li></span>&nbsp; <a href="#L103" title="lua.c:103">globalL</a> = L;&nbsp; <span class="Comment">/* to be available to '<a href="#L124" title="lua.c:124">laction</a>' */<br/></li>
<li></span>&nbsp; signal(<span class="Constant">SIGINT</span>, <a href="#L124" title="lua.c:124">laction</a>);&nbsp; <span class="Comment">/* set C-signal handler */<br/></li>
<li></span>&nbsp; status = <a href="lua.h.html#L276" title="lua.h:276">lua_pcall</a>(L, narg, nres, base);<br/></li>
<li>&nbsp; signal(<span class="Constant">SIGINT</span>, <span class="Constant">SIG_DFL</span>); <span class="Comment">/* reset C-signal handler */<br/></li>
<li></span>&nbsp; <a href="lua.h.html#L370" title="lua.h:370">lua_remove</a>(L, base);&nbsp; <span class="Comment">/* remove message handler from the stack */<br/></li>
<li></span>&nbsp; <span class="Statement">return</span> status;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L212">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">print_version</span> (<span class="Type">void</span>) {<br/></li>
<li>&nbsp; <a href="lauxlib.h.html#L215" title="lauxlib.h:215">lua_writestring</a>(<a href="lua.h.html#L26" title="lua.h:26">LUA_COPYRIGHT</a>, strlen(<a href="lua.h.html#L26" title="lua.h:26">LUA_COPYRIGHT</a>));<br/></li>
<li>&nbsp; <a href="lauxlib.h.html#L220" title="lauxlib.h:220">lua_writeline</a>();<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** Create the 'arg' table, which stores all arguments from the<br/></li>
<li></span><span class="Comment">** command line ('argv'). It should be aligned so that, at index 0,<br/></li>
<li></span><span class="Comment">** it has 'argv[script]', which is the script name. The arguments<br/></li>
<li></span><span class="Comment">** to the script (everything after 'script') go to positive indices;<br/></li>
<li></span><span class="Comment">** other arguments (before the script name) go to negative indices.<br/></li>
<li></span><span class="Comment">** If there is no script name, assume interpreter's name as base.<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L226">&#x200c;</a></span><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">createargtable</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">char</span> **argv, <span class="Type">int</span> argc, <span class="Type">int</span> script) {<br/></li>
<li>&nbsp; <span class="Type">int</span> i, narg;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (script == argc) script = <span class="Constant">0</span>;&nbsp; <span class="Comment">/* no script name? */<br/></li>
<li></span>&nbsp; narg = argc - (script + <span class="Constant">1</span>);&nbsp; <span class="Comment">/* number of positive indices */<br/></li>
<li></span>&nbsp; <a href="lapi.c.html#L664" title="lapi.c:664">lua_createtable</a>(L, narg, script + <span class="Constant">1</span>);<br/></li>
<li>&nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; argc; i++) {<br/></li>
<li>&nbsp; &nbsp; <a href="lapi.c.html#L484" title="lapi.c:484">lua_pushstring</a>(L, argv[i]);<br/></li>
<li>&nbsp; &nbsp; <a href="lapi.c.html#L785" title="lapi.c:785">lua_rawseti</a>(L, -<span class="Constant">2</span>, i - script);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <a href="lapi.c.html#L721" title="lapi.c:721">lua_setglobal</a>(L, <span class="Constant">&quot;arg&quot;</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L239">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">dochunk</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">int</span> status) {<br/></li>
<li>&nbsp; <span class="Statement">if</span> (status == <a href="lua.h.html#L45" title="lua.h:45">LUA_OK</a>) status = <a href="#L198" title="lua.c:198">docall</a>(L, <span class="Constant">0</span>, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="#L166" title="lua.c:166">report</a>(L, status);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L245">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">dofile</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">const</span> <span class="Type">char</span> *name) {<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="#L239" title="lua.c:239">dochunk</a>(L, <a href="lauxlib.h.html#L78" title="lauxlib.h:78">luaL_loadfile</a>(L, name));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L250">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">dostring</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">const</span> <span class="Type">char</span> *s, <span class="Type">const</span> <span class="Type">char</span> *name) {<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="#L239" title="lua.c:239">dochunk</a>(L, <a href="lauxlib.h.html#L131" title="lauxlib.h:131">luaL_loadbuffer</a>(L, s, strlen(s), name));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** Calls 'require(name)' and stores the result in a global variable<br/></li>
<li></span><span class="Comment">** with the given name.<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L259">&#x200c;</a></span><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">dolibrary</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">const</span> <span class="Type">char</span> *name) {<br/></li>
<li>&nbsp; <span class="Type">int</span> status;<br/></li>
<li>&nbsp; <a href="lapi.c.html#L581" title="lapi.c:581">lua_getglobal</a>(L, <span class="Constant">&quot;require&quot;</span>);<br/></li>
<li>&nbsp; <a href="lapi.c.html#L484" title="lapi.c:484">lua_pushstring</a>(L, name);<br/></li>
<li>&nbsp; status = <a href="#L198" title="lua.c:198">docall</a>(L, <span class="Constant">1</span>, <span class="Constant">1</span>);&nbsp; <span class="Comment">/* call 'require(name)' */<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (status == <a href="lua.h.html#L45" title="lua.h:45">LUA_OK</a>)<br/></li>
<li>&nbsp; &nbsp; <a href="lapi.c.html#L721" title="lapi.c:721">lua_setglobal</a>(L, name);&nbsp; <span class="Comment">/* global[name] = require return */<br/></li>
<li></span>&nbsp; <span class="Statement">return</span> <a href="#L166" title="lua.c:166">report</a>(L, status);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** Returns the string to be used as a prompt by the interpreter.<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L273">&#x200c;</a></span><span class="Type">static</span> <span class="Type">const</span> <span class="Type">char</span> *<span class="linkable">get_prompt</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">int</span> firstline) {<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">char</span> *p;<br/></li>
<li>&nbsp; <a href="lapi.c.html#L581" title="lapi.c:581">lua_getglobal</a>(L, firstline ? <span class="Constant">&quot;_PROMPT&quot;</span> : <span class="Constant">&quot;_PROMPT2&quot;</span>);<br/></li>
<li>&nbsp; p = <a href="lua.h.html#L365" title="lua.h:365">lua_tostring</a>(L, -<span class="Constant">1</span>);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (p == <span class="Constant">NULL</span>) p = (firstline ? <a href="#L24" title="lua.c:24">LUA_PROMPT</a> : <a href="#L25" title="lua.c:25">LUA_PROMPT2</a>);<br/></li>
<li>&nbsp; <span class="Statement">return</span> p;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* mark in <a href="lundump.c.html#L40" title="lundump.c:40">error</a> messages for <a href="#L291" title="lua.c:291">incomplete</a> statements */<br/></li>
<li><a id="L282">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">EOFMARK</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">&quot;&lt;eof&gt;&quot;<br/></li>
<li><a id="L283">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">marklen</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (</span><span class="Statement">sizeof</span><span class="PreProc">(<a href="#L282" title="lua.c:282">EOFMARK</a>)/</span><span class="Statement">sizeof</span><span class="PreProc">(</span><span class="Type">char</span><span class="PreProc">) - </span><span class="Constant">1</span><span class="PreProc">)<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** Check whether 'status' signals a syntax <a href="lundump.c.html#L40" title="lundump.c:40">error</a> and the <a href="lundump.c.html#L40" title="lundump.c:40">error</a><br/></li>
<li></span><span class="Comment">** message at the top of the stack ends with the above mark for<br/></li>
<li></span><span class="Comment">** <a href="#L291" title="lua.c:291">incomplete</a> statements.<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L291">&#x200c;</a></span><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">incomplete</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">int</span> status) {<br/></li>
<li>&nbsp; <span class="Statement">if</span> (status == <a href="lua.h.html#L48" title="lua.h:48">LUA_ERRSYNTAX</a>) {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span> lmsg;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span> *msg = <a href="lapi.c.html#L372" title="lapi.c:372">lua_tolstring</a>(L, -<span class="Constant">1</span>, &amp;lmsg);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (lmsg &gt;= <a href="#L283" title="lua.c:283">marklen</a> &amp;&amp; strcmp(msg + lmsg - <a href="#L283" title="lua.c:283">marklen</a>, <a href="#L282" title="lua.c:282">EOFMARK</a>) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="lua.h.html#L342" title="lua.h:342">lua_pop</a>(L, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;&nbsp; <span class="Comment">/* else... */<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** Prompt the user, read a line, and push it into the Lua stack.<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L307">&#x200c;</a></span><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">pushline</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">int</span> firstline) {<br/></li>
<li>&nbsp; <span class="Type">char</span> buffer[<a href="#L33" title="lua.c:33">LUA_MAXINPUT</a>];<br/></li>
<li>&nbsp; <span class="Type">char</span> *b = buffer;<br/></li>
<li>&nbsp; <span class="Type">size_t</span> l;<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">char</span> *prmt = <a href="#L273" title="lua.c:273">get_prompt</a>(L, firstline);<br/></li>
<li>&nbsp; <span class="Type">int</span> readstatus = <a href="#L82" title="lua.c:82">lua_readline</a>(L, b, prmt);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (readstatus == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;&nbsp; <span class="Comment">/* no input (prompt will be popped by caller) */<br/></li>
<li></span>&nbsp; <a href="lua.h.html#L342" title="lua.h:342">lua_pop</a>(L, <span class="Constant">1</span>);&nbsp; <span class="Comment">/* remove prompt */<br/></li>
<li></span>&nbsp; l = strlen(b);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (l &gt; <span class="Constant">0</span> &amp;&amp; b[l-<span class="Constant">1</span>] == <span class="Special">'\n'</span>)&nbsp; <span class="Comment">/* line ends with newline? */<br/></li>
<li></span>&nbsp; &nbsp; b[l-<span class="Constant">1</span>] = <span class="Special">'\0'</span>;&nbsp; <span class="Comment">/* remove it */<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (firstline &amp;&amp; b[<span class="Constant">0</span>] == <span class="Constant">'='</span>)&nbsp; <span class="Comment">/* for compatibility with 5.2, ... */<br/></li>
<li></span>&nbsp; &nbsp; <a href="lapi.c.html#L513" title="lapi.c:513">lua_pushfstring</a>(L, <span class="Constant">&quot;return </span><span class="Special">%s</span><span class="Constant">&quot;</span>, b + <span class="Constant">1</span>);&nbsp; <span class="Comment">/* change '=' to 'return' */<br/></li>
<li></span>&nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; <a href="lapi.c.html#L484" title="lapi.c:484">lua_pushstring</a>(L, b);<br/></li>
<li>&nbsp; <a href="#L86" title="lua.c:86">lua_freeline</a>(L, b);<br/></li>
<li>&nbsp; <span class="Statement">return</span> <span class="Constant">1</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** Try to compile line on the stack as 'return &lt;line&gt;'; on return, stack<br/></li>
<li></span><span class="Comment">** has either compiled chunk or original line (if compilation failed).<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L332">&#x200c;</a></span><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">addreturn</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <span class="Type">int</span> status;<br/></li>
<li>&nbsp; <span class="Type">size_t</span> len; <span class="Type">const</span> <span class="Type">char</span> *line;<br/></li>
<li>&nbsp; <a href="lua.h.html#L359" title="lua.h:359">lua_pushliteral</a>(L, <span class="Constant">&quot;return &quot;</span>);<br/></li>
<li>&nbsp; <a href="lapi.c.html#L236" title="lapi.c:236">lua_pushvalue</a>(L, -<span class="Constant">2</span>);&nbsp; <span class="Comment">/* duplicate line */<br/></li>
<li></span>&nbsp; <a href="lapi.c.html#L1111" title="lapi.c:1111">lua_concat</a>(L, <span class="Constant">2</span>);&nbsp; <span class="Comment">/* new line is &quot;return ...&quot; */<br/></li>
<li></span>&nbsp; line = <a href="lapi.c.html#L372" title="lapi.c:372">lua_tolstring</a>(L, -<span class="Constant">1</span>, &amp;len);<br/></li>
<li>&nbsp; <span class="Statement">if</span> ((status = <a href="lauxlib.h.html#L131" title="lauxlib.h:131">luaL_loadbuffer</a>(L, line, len, <span class="Constant">&quot;=stdin&quot;</span>)) == <a href="lua.h.html#L45" title="lua.h:45">LUA_OK</a>)<br/></li>
<li>&nbsp; &nbsp; <a href="lua.h.html#L370" title="lua.h:370">lua_remove</a>(L, -<span class="Constant">3</span>);&nbsp; <span class="Comment">/* remove original line */<br/></li>
<li></span>&nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; <a href="lua.h.html#L342" title="lua.h:342">lua_pop</a>(L, <span class="Constant">2</span>);&nbsp; <span class="Comment">/* remove result from '<a href="lauxlib.h.html#L131" title="lauxlib.h:131">luaL_loadbuffer</a>' and new line */<br/></li>
<li></span>&nbsp; <span class="Statement">return</span> status;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** Read multiple lines until a complete Lua <a href="lparser.c.html#L1534" title="lparser.c:1534">statement</a><br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L350">&#x200c;</a></span><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">multiline</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <span class="Statement">for</span> (;;) {&nbsp; <span class="Comment">/* repeat until gets a complete <a href="lparser.c.html#L1534" title="lparser.c:1534">statement</a> */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">size_t</span> len;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span> *line = <a href="lapi.c.html#L372" title="lapi.c:372">lua_tolstring</a>(L, <span class="Constant">1</span>, &amp;len);&nbsp; <span class="Comment">/* get what it has */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">int</span> status = <a href="lauxlib.h.html#L131" title="lauxlib.h:131">luaL_loadbuffer</a>(L, line, len, <span class="Constant">&quot;=stdin&quot;</span>);&nbsp; <span class="Comment">/* try it */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (!<a href="#L291" title="lua.c:291">incomplete</a>(L, status) || !<a href="#L307" title="lua.c:307">pushline</a>(L, <span class="Constant">0</span>))<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span> status;&nbsp; <span class="Comment">/* <a href="luac.c.html#L44" title="luac.c:44">cannot</a> or should not try to add continuation line */<br/></li>
<li></span>&nbsp; &nbsp; <a href="lua.h.html#L359" title="lua.h:359">lua_pushliteral</a>(L, <span class="Constant">&quot;</span><span class="Special">\n</span><span class="Constant">&quot;</span>);&nbsp; <span class="Comment">/* add newline... */<br/></li>
<li></span>&nbsp; &nbsp; <a href="lua.h.html#L368" title="lua.h:368">lua_insert</a>(L, -<span class="Constant">2</span>);&nbsp; <span class="Comment">/* ...between the two lines */<br/></li>
<li></span>&nbsp; &nbsp; <a href="lapi.c.html#L1111" title="lapi.c:1111">lua_concat</a>(L, <span class="Constant">3</span>);&nbsp; <span class="Comment">/* join them */<br/></li>
<li></span>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** Read a line and try to load (compile) it first as an expression (by<br/></li>
<li></span><span class="Comment">** adding &quot;return &quot; in front of it) and second as a <a href="lparser.c.html#L1534" title="lparser.c:1534">statement</a>. Return<br/></li>
<li></span><span class="Comment">** the final status of load/call with the resulting function (if any)<br/></li>
<li></span><span class="Comment">** in the top of the stack.<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L370">&#x200c;</a></span><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">loadline</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <span class="Type">int</span> status;<br/></li>
<li>&nbsp; <a href="lapi.c.html#L171" title="lapi.c:171">lua_settop</a>(L, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (!<a href="#L307" title="lua.c:307">pushline</a>(L, <span class="Constant">1</span>))<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant">1</span>;&nbsp; <span class="Comment">/* no input */<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> ((status = <a href="#L332" title="lua.c:332">addreturn</a>(L)) != <a href="lua.h.html#L45" title="lua.h:45">LUA_OK</a>)&nbsp; <span class="Comment">/* 'return ...' did not work? */<br/></li>
<li></span>&nbsp; &nbsp; status = <a href="#L350" title="lua.c:350">multiline</a>(L);&nbsp; <span class="Comment">/* try as command, maybe with continuation lines */<br/></li>
<li></span>&nbsp; <a href="#L83" title="lua.c:83">lua_saveline</a>(L, <span class="Constant">1</span>);&nbsp; <span class="Comment">/* keep history */<br/></li>
<li></span>&nbsp; <a href="lua.h.html#L370" title="lua.h:370">lua_remove</a>(L, <span class="Constant">1</span>);&nbsp; <span class="Comment">/* remove line from the stack */<br/></li>
<li></span>&nbsp; <a href="lualib.h.html#L54" title="lualib.h:54">lua_assert</a>(<a href="lapi.c.html#L166" title="lapi.c:166">lua_gettop</a>(L) == <span class="Constant">1</span>);<br/></li>
<li>&nbsp; <span class="Statement">return</span> status;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** Prints (calling the Lua 'print' function) any values on the stack<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L387">&#x200c;</a></span><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">l_print</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <span class="Type">int</span> n = <a href="lapi.c.html#L166" title="lapi.c:166">lua_gettop</a>(L);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (n &gt; <span class="Constant">0</span>) {&nbsp; <span class="Comment">/* any result to be printed? */<br/></li>
<li></span>&nbsp; &nbsp; <a href="lauxlib.c.html#L350" title="lauxlib.c:350">luaL_checkstack</a>(L, <a href="lua.h.html#L77" title="lua.h:77">LUA_MINSTACK</a>, <span class="Constant">&quot;too many results to print&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="lapi.c.html#L581" title="lapi.c:581">lua_getglobal</a>(L, <span class="Constant">&quot;print&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="lua.h.html#L368" title="lua.h:368">lua_insert</a>(L, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="lua.h.html#L276" title="lua.h:276">lua_pcall</a>(L, n, <span class="Constant">0</span>, <span class="Constant">0</span>) != <a href="lua.h.html#L45" title="lua.h:45">LUA_OK</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L155" title="lua.c:155">l_message</a>(<a href="#L105" title="lua.c:105">progname</a>, <a href="lapi.c.html#L513" title="lapi.c:513">lua_pushfstring</a>(L, <span class="Constant">&quot;<a href="lundump.c.html#L40" title="lundump.c:40">error</a> calling 'print' (</span><span class="Special">%s</span><span class="Constant">)&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="lua.h.html#L365" title="lua.h:365">lua_tostring</a>(L, -<span class="Constant">1</span>)));<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** Do the REPL: repeatedly read (load) a line, evaluate (call) it, and<br/></li>
<li></span><span class="Comment">** print any results.<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L404">&#x200c;</a></span><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">doREPL</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <span class="Type">int</span> status;<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">char</span> *oldprogname = <a href="#L105" title="lua.c:105">progname</a>;<br/></li>
<li>&nbsp; <a href="#L105" title="lua.c:105">progname</a> = <span class="Constant">NULL</span>;&nbsp; <span class="Comment">/* no '<a href="#L105" title="lua.c:105">progname</a>' on errors in interactive mode */<br/></li>
<li></span>&nbsp; <span class="Statement">while</span> ((status = <a href="#L370" title="lua.c:370">loadline</a>(L)) != -<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (status == <a href="lua.h.html#L45" title="lua.h:45">LUA_OK</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; status = <a href="#L198" title="lua.c:198">docall</a>(L, <span class="Constant">0</span>, <a href="lua.h.html#L34" title="lua.h:34">LUA_MULTRET</a>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (status == <a href="lua.h.html#L45" title="lua.h:45">LUA_OK</a>) <a href="#L387" title="lua.c:387">l_print</a>(L);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else</span> <a href="#L166" title="lua.c:166">report</a>(L, status);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <a href="lapi.c.html#L171" title="lapi.c:171">lua_settop</a>(L, <span class="Constant">0</span>);&nbsp; <span class="Comment">/* clear stack */<br/></li>
<li></span>&nbsp; <a href="lauxlib.h.html#L220" title="lauxlib.h:220">lua_writeline</a>();<br/></li>
<li>&nbsp; <a href="#L105" title="lua.c:105">progname</a> = oldprogname;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** Push on the stack the contents of table 'arg' from 1 to #arg<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L423">&#x200c;</a></span><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">pushargs</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <span class="Type">int</span> i, n;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="lapi.c.html#L581" title="lapi.c:581">lua_getglobal</a>(L, <span class="Constant">&quot;arg&quot;</span>) != <a href="lua.h.html#L67" title="lua.h:67">LUA_TTABLE</a>)<br/></li>
<li>&nbsp; &nbsp; <a href="lauxlib.c.html#L212" title="lauxlib.c:212">luaL_error</a>(L, <span class="Constant">&quot;'arg' is not a table&quot;</span>);<br/></li>
<li>&nbsp; n = (<span class="Type">int</span>)<a href="lauxlib.c.html#L736" title="lauxlib.c:736">luaL_len</a>(L, -<span class="Constant">1</span>);<br/></li>
<li>&nbsp; <a href="lauxlib.c.html#L350" title="lauxlib.c:350">luaL_checkstack</a>(L, n + <span class="Constant">3</span>, <span class="Constant">&quot;too many arguments to script&quot;</span>);<br/></li>
<li>&nbsp; <span class="Statement">for</span> (i = <span class="Constant">1</span>; i &lt;= n; i++)<br/></li>
<li>&nbsp; &nbsp; <a href="lapi.c.html#L638" title="lapi.c:638">lua_rawgeti</a>(L, -i, i);<br/></li>
<li>&nbsp; <a href="lua.h.html#L370" title="lua.h:370">lua_remove</a>(L, -i);&nbsp; <span class="Comment">/* remove table from the stack */<br/></li>
<li></span>&nbsp; <span class="Statement">return</span> n;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L436">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">handle_script</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">char</span> **argv) {<br/></li>
<li>&nbsp; <span class="Type">int</span> status;<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">char</span> *fname = argv[<span class="Constant">0</span>];<br/></li>
<li>&nbsp; <span class="Statement">if</span> (strcmp(fname, <span class="Constant">&quot;-&quot;</span>) == <span class="Constant">0</span> &amp;&amp; strcmp(argv[-<span class="Constant">1</span>], <span class="Constant">&quot;--&quot;</span>) != <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; fname = <span class="Constant">NULL</span>;&nbsp; <span class="Comment">/* stdin */<br/></li>
<li></span>&nbsp; status = <a href="lauxlib.h.html#L78" title="lauxlib.h:78">luaL_loadfile</a>(L, fname);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (status == <a href="lua.h.html#L45" title="lua.h:45">LUA_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span> n = <a href="#L423" title="lua.c:423">pushargs</a>(L);&nbsp; <span class="Comment">/* push arguments to script */<br/></li>
<li></span>&nbsp; &nbsp; status = <a href="#L198" title="lua.c:198">docall</a>(L, n, <a href="lua.h.html#L34" title="lua.h:34">LUA_MULTRET</a>);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="#L166" title="lua.c:166">report</a>(L, status);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/* bits of various argument indicators in 'args' */<br/></li>
<li><a id="L452">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">has_error</span>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">1</span><span class="PreProc">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Comment">/* bad option */<br/></li>
<li><a id="L453">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">has_i</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">2</span><span class="PreProc">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Comment">/* -i */<br/></li>
<li><a id="L454">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">has_v</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">4</span><span class="PreProc">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Comment">/* -v */<br/></li>
<li><a id="L455">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">has_e</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">8</span><span class="PreProc">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Comment">/* -e */<br/></li>
<li><a id="L456">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">has_E</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">16</span><span class="PreProc">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Comment">/* -E */<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** Traverses all arguments from 'argv', returning a <a href="lbitlib.c.html#L41" title="lbitlib.c:41">mask</a> with those<br/></li>
<li></span><span class="Comment">** needed before running any Lua code (or an <a href="lundump.c.html#L40" title="lundump.c:40">error</a> code if it finds<br/></li>
<li></span><span class="Comment">** any invalid argument). 'first' returns the first not-handled argument<br/></li>
<li></span><span class="Comment">** (either the script name or a bad argument in case of <a href="lundump.c.html#L40" title="lundump.c:40">error</a>).<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L464">&#x200c;</a></span><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">collectargs</span> (<span class="Type">char</span> **argv, <span class="Type">int</span> *first) {<br/></li>
<li>&nbsp; <span class="Type">int</span> args = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; <span class="Type">int</span> i;<br/></li>
<li>&nbsp; <span class="Statement">for</span> (i = <span class="Constant">1</span>; argv[i] != <span class="Constant">NULL</span>; i++) {<br/></li>
<li>&nbsp; &nbsp; *first = i;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (argv[i][<span class="Constant">0</span>] != <span class="Constant">'-'</span>)&nbsp; <span class="Comment">/* not an option? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> args;&nbsp; <span class="Comment">/* stop handling options */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">switch</span> (argv[i][<span class="Constant">1</span>]) {&nbsp; <span class="Comment">/* else <a href="lparser.c.html#L106" title="lparser.c:106">check</a> option */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'-'</span>:&nbsp; <span class="Comment">/* '--' */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (argv[i][<span class="Constant">2</span>] != <span class="Special">'\0'</span>)&nbsp; <span class="Comment">/* extra characters after '--'? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L452" title="lua.c:452">has_error</a>;&nbsp; <span class="Comment">/* invalid option */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; *first = i + <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> args;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Special">'\0'</span>:&nbsp; <span class="Comment">/* '-' */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> args;&nbsp; <span class="Comment">/* script &quot;name&quot; is '-' */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'E'</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (argv[i][<span class="Constant">2</span>] != <span class="Special">'\0'</span>)&nbsp; <span class="Comment">/* extra characters after 1st? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L452" title="lua.c:452">has_error</a>;&nbsp; <span class="Comment">/* invalid option */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; args |= <a href="#L456" title="lua.c:456">has_E</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'i'</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; args |= <a href="#L453" title="lua.c:453">has_i</a>;&nbsp; <span class="Comment">/* goes through&nbsp; (-i implies -v) */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'v'</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (argv[i][<span class="Constant">2</span>] != <span class="Special">'\0'</span>)&nbsp; <span class="Comment">/* extra characters after 1st? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L452" title="lua.c:452">has_error</a>;&nbsp; <span class="Comment">/* invalid option */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; args |= <a href="#L454" title="lua.c:454">has_v</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'e'</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; args |= <a href="#L455" title="lua.c:455">has_e</a>;&nbsp; <span class="Comment">/* go through */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'l'</span>:&nbsp; <span class="Comment">/* both options need an argument */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (argv[i][<span class="Constant">2</span>] == <span class="Special">'\0'</span>) {&nbsp; <span class="Comment">/* no concatenated argument? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i++;&nbsp; <span class="Comment">/* try <a href="llex.c.html#L31" title="llex.c:31">next</a> 'argv' */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (argv[i] == <span class="Constant">NULL</span> || argv[i][<span class="Constant">0</span>] == <span class="Constant">'-'</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L452" title="lua.c:452">has_error</a>;&nbsp; <span class="Comment">/* no <a href="llex.c.html#L31" title="llex.c:31">next</a> argument or it is another option */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:</span>&nbsp; <span class="Comment">/* invalid option */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L452" title="lua.c:452">has_error</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; *first = i;&nbsp; <span class="Comment">/* no script name */<br/></li>
<li></span>&nbsp; <span class="Statement">return</span> args;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** Processes options 'e' and 'l', which involve running Lua code.<br/></li>
<li></span><span class="Comment">** Returns 0 if some code raises an <a href="lundump.c.html#L40" title="lundump.c:40">error</a>.<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L513">&#x200c;</a></span><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">runargs</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">char</span> **argv, <span class="Type">int</span> n) {<br/></li>
<li>&nbsp; <span class="Type">int</span> i;<br/></li>
<li>&nbsp; <span class="Statement">for</span> (i = <span class="Constant">1</span>; i &lt; n; i++) {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span> status;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span> option = argv[i][<span class="Constant">1</span>];<br/></li>
<li>&nbsp; &nbsp; <a href="lualib.h.html#L54" title="lualib.h:54">lua_assert</a>(argv[i][<span class="Constant">0</span>] == <span class="Constant">'-'</span>);&nbsp; <span class="Comment">/* already checked */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (option == <span class="Constant">'e'</span> || option == <span class="Constant">'l'</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span> *extra = argv[i] + <span class="Constant">2</span>;&nbsp; <span class="Comment">/* both options need an argument */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (*extra == <span class="Special">'\0'</span>) extra = argv[++i];<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="lualib.h.html#L54" title="lualib.h:54">lua_assert</a>(extra != <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (option == <span class="Constant">'e'</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; status = <a href="#L250" title="lua.c:250">dostring</a>(L, extra, <span class="Constant">&quot;=(command line)&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; status = <a href="#L259" title="lua.c:259">dolibrary</a>(L, extra);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (status != <a href="lua.h.html#L45" title="lua.h:45">LUA_OK</a>) <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> <span class="Constant">1</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L534">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">handle_luainit</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">char</span> *name = <span class="Constant">&quot;=&quot;</span> <a href="#L40" title="lua.c:40">LUA_INITVARVERSION</a>;<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">char</span> *init = getenv(name + <span class="Constant">1</span>);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (init == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; name = <span class="Constant">&quot;=&quot;</span> <a href="#L37" title="lua.c:37">LUA_INIT_VAR</a>;<br/></li>
<li>&nbsp; &nbsp; init = getenv(name + <span class="Constant">1</span>);&nbsp; <span class="Comment">/* try alternative name */<br/></li>
<li></span>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">if</span> (init == <span class="Constant">NULL</span>) <span class="Statement">return</span> <a href="lua.h.html#L45" title="lua.h:45">LUA_OK</a>;<br/></li>
<li>&nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (init[<span class="Constant">0</span>] == <span class="Constant">'@'</span>)<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L245" title="lua.c:245">dofile</a>(L, init+<span class="Constant">1</span>);<br/></li>
<li>&nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L250" title="lua.c:250">dostring</a>(L, init, name);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** Main <a href="lparser.c.html#L776" title="lparser.c:776">body</a> of stand-alone interpreter (to be called in protected mode).<br/></li>
<li></span><span class="Comment">** Reads the options and handles them all.<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L553">&#x200c;</a></span><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">pmain</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <span class="Type">int</span> argc = (<span class="Type">int</span>)<a href="lua.h.html#L340" title="lua.h:340">lua_tointeger</a>(L, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; <span class="Type">char</span> **argv = (<span class="Type">char</span> **)<a href="lapi.c.html#L410" title="lapi.c:410">lua_touserdata</a>(L, <span class="Constant">2</span>);<br/></li>
<li>&nbsp; <span class="Type">int</span> script;<br/></li>
<li>&nbsp; <span class="Type">int</span> args = <a href="#L464" title="lua.c:464">collectargs</a>(argv, &amp;script);<br/></li>
<li>&nbsp; <a href="lauxlib.h.html#L32" title="lauxlib.h:32">luaL_checkversion</a>(L);&nbsp; <span class="Comment">/* <a href="lparser.c.html#L106" title="lparser.c:106">check</a> that interpreter has correct version */<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (argv[<span class="Constant">0</span>] &amp;&amp; argv[<span class="Constant">0</span>][<span class="Constant">0</span>]) <a href="#L105" title="lua.c:105">progname</a> = argv[<span class="Constant">0</span>];<br/></li>
<li>&nbsp; <span class="Statement">if</span> (args == <a href="#L452" title="lua.c:452">has_error</a>) {&nbsp; <span class="Comment">/* bad arg? */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L130" title="lua.c:130">print_usage</a>(argv[script]);&nbsp; <span class="Comment">/* 'script' has index of bad arg. */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">if</span> (args &amp; <a href="#L454" title="lua.c:454">has_v</a>)&nbsp; <span class="Comment">/* option '-v'? */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L212" title="lua.c:212">print_version</a>();<br/></li>
<li>&nbsp; <span class="Statement">if</span> (args &amp; <a href="#L456" title="lua.c:456">has_E</a>) {&nbsp; <span class="Comment">/* option '-E'? */<br/></li>
<li></span>&nbsp; &nbsp; <a href="lapi.c.html#L550" title="lapi.c:550">lua_pushboolean</a>(L, <span class="Constant">1</span>);&nbsp; <span class="Comment">/* signal for libraries to ignore env. vars. */<br/></li>
<li></span>&nbsp; &nbsp; <a href="lapi.c.html#L745" title="lapi.c:745">lua_setfield</a>(L, <a href="lua.h.html#L40" title="lua.h:40">LUA_REGISTRYINDEX</a>, <span class="Constant">&quot;LUA_NOENV&quot;</span>);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <a href="linit.c.html#L60" title="linit.c:60">luaL_openlibs</a>(L);&nbsp; <span class="Comment">/* open standard libraries */<br/></li>
<li></span>&nbsp; <a href="#L226" title="lua.c:226">createargtable</a>(L, argv, argc, script);&nbsp; <span class="Comment">/* create table 'arg' */<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (!(args &amp; <a href="#L456" title="lua.c:456">has_E</a>)) {&nbsp; <span class="Comment">/* no option '-E'? */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L534" title="lua.c:534">handle_luainit</a>(L) != <a href="lua.h.html#L45" title="lua.h:45">LUA_OK</a>)&nbsp; <span class="Comment">/* run LUA_INIT */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;&nbsp; <span class="Comment">/* <a href="lundump.c.html#L40" title="lundump.c:40">error</a> running LUA_INIT */<br/></li>
<li></span>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">if</span> (!<a href="#L513" title="lua.c:513">runargs</a>(L, argv, script))&nbsp; <span class="Comment">/* execute arguments -e and -l */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;&nbsp; <span class="Comment">/* something failed */<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (script &lt; argc &amp;&amp;&nbsp; <span class="Comment">/* execute <a href="#L595" title="lua.c:595">main</a> script (if there is one) */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <a href="#L436" title="lua.c:436">handle_script</a>(L, argv + script) != <a href="lua.h.html#L45" title="lua.h:45">LUA_OK</a>)<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (args &amp; <a href="#L453" title="lua.c:453">has_i</a>)&nbsp; <span class="Comment">/* -i option? */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L404" title="lua.c:404">doREPL</a>(L);&nbsp; <span class="Comment">/* do read-eval-print loop */<br/></li>
<li></span>&nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (script == argc &amp;&amp; !(args &amp; (<a href="#L455" title="lua.c:455">has_e</a> | <a href="#L454" title="lua.c:454">has_v</a>))) {&nbsp; <span class="Comment">/* no arguments? */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L53" title="lua.c:53">lua_stdin_is_tty</a>()) {&nbsp; <span class="Comment">/* running in interactive mode? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <a href="#L212" title="lua.c:212">print_version</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L404" title="lua.c:404">doREPL</a>(L);&nbsp; <span class="Comment">/* do read-eval-print loop */<br/></li>
<li></span>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else</span> <a href="#L245" title="lua.c:245">dofile</a>(L, <span class="Constant">NULL</span>);&nbsp; <span class="Comment">/* executes stdin as a file */<br/></li>
<li></span>&nbsp; }<br/></li>
<li>&nbsp; <a href="lapi.c.html#L550" title="lapi.c:550">lua_pushboolean</a>(L, <span class="Constant">1</span>);&nbsp; <span class="Comment">/* signal no errors */<br/></li>
<li></span>&nbsp; <span class="Statement">return</span> <span class="Constant">1</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L595">&#x200c;</a><span class="Type">int</span> <span class="linkable">main</span> (<span class="Type">int</span> argc, <span class="Type">char</span> **argv) {<br/></li>
<li>&nbsp; <span class="Type">int</span> status, result;<br/></li>
<li>&nbsp; <a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L = <a href="lauxlib.c.html#L955" title="lauxlib.c:955">luaL_newstate</a>();&nbsp; <span class="Comment">/* create state */<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (L == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; <a href="#L155" title="lua.c:155">l_message</a>(argv[<span class="Constant">0</span>], <span class="Constant">&quot;<a href="luac.c.html#L44" title="luac.c:44">cannot</a> create state: not enough memory&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">EXIT_FAILURE</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <a href="lua.h.html#L348" title="lua.h:348">lua_pushcfunction</a>(L, &amp;<a href="#L553" title="lua.c:553">pmain</a>);&nbsp; <span class="Comment">/* to call '<a href="#L553" title="lua.c:553">pmain</a>' in protected mode */<br/></li>
<li></span>&nbsp; <a href="lapi.c.html#L464" title="lapi.c:464">lua_pushinteger</a>(L, argc);&nbsp; <span class="Comment">/* 1st argument */<br/></li>
<li></span>&nbsp; <a href="lapi.c.html#L558" title="lapi.c:558">lua_pushlightuserdata</a>(L, argv); <span class="Comment">/* 2nd argument */<br/></li>
<li></span>&nbsp; status = <a href="lua.h.html#L276" title="lua.h:276">lua_pcall</a>(L, <span class="Constant">2</span>, <span class="Constant">1</span>, <span class="Constant">0</span>);&nbsp; <span class="Comment">/* do the call */<br/></li>
<li></span>&nbsp; result = <a href="lapi.c.html#L366" title="lapi.c:366">lua_toboolean</a>(L, -<span class="Constant">1</span>);&nbsp; <span class="Comment">/* get result */<br/></li>
<li></span>&nbsp; <a href="#L166" title="lua.c:166">report</a>(L, status);<br/></li>
<li>&nbsp; <a href="lstate.c.html#L340" title="lstate.c:340">lua_close</a>(L);<br/></li>
<li>&nbsp; <span class="Statement">return</span> (result &amp;&amp; status == <a href="lua.h.html#L45" title="lua.h:45">LUA_OK</a>) ? <span class="Constant">EXIT_SUCCESS</span> : <span class="Constant">EXIT_FAILURE</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
</ol></code>
 </body>
</html>
