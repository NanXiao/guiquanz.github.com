<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>ldebug.c - src</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

code {
    font-family: consolas, monospace;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
  <h3>ldebug.c - src</h3>
   <a href="../index.html"> Table of Contents </a>
 <h4>Functions defined</h4>
 <ul>
<li><a href="#L575">addinfo</a></li>
<li><a href="#L216">auxgetinfo</a></li>
<li><a href="#L197">collectvalidlines</a></li>
<li><a href="#L46">currentline</a></li>
<li><a href="#L40">currentpc</a></li>
<li><a href="#L331">filterpc</a></li>
<li><a href="#L118">findlocal</a></li>
<li><a href="#L341">findsetreg</a></li>
<li><a href="#L107">findvararg</a></li>
<li><a href="#L179">funcinfo</a></li>
<li><a href="#L441">getfuncname</a></li>
<li><a href="#L387">getobjname</a></li>
<li><a href="#L505">getupvalname</a></li>
<li><a href="#L494">isinstack</a></li>
<li><a href="#L311">kname</a></li>
<li><a href="#L539">luaG_concaterror</a></li>
<li><a href="#L591">luaG_errormsg</a></li>
<li><a href="#L545">luaG_opinterror</a></li>
<li><a href="#L565">luaG_ordererror</a></li>
<li><a href="#L603">luaG_runerror</a></li>
<li><a href="#L557">luaG_tointerror</a></li>
<li><a href="#L612">luaG_traceexec</a></li>
<li><a href="#L533">luaG_typeerror</a></li>
<li><a href="#L68">lua_gethook</a></li>
<li><a href="#L78">lua_gethookcount</a></li>
<li><a href="#L73">lua_gethookmask</a></li>
<li><a href="#L267">lua_getinfo</a></li>
<li><a href="#L144">lua_getlocal</a></li>
<li><a href="#L83">lua_getstack</a></li>
<li><a href="#L54">lua_sethook</a></li>
<li><a href="#L166">lua_setlocal</a></li>
<li><a href="#L100">upvalname</a></li>
<li><a href="#L519">varinfo</a></li>
</ul>
 <h4>Macros defined</h4>
 <ul>
<li><a href="#L8">LUA_CORE</a></li>
<li><a href="#L7">ldebug_c</a></li>
<li><a href="#L34">noLuaClosure</a></li>
</ul>
 <h4>Source code</h4>

  <code><ol><li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** $Id: ldebug.c,v 2.110 2015/01/02 12:52:22 roberto Exp $<br/></li>
<li></span><span class="Comment">** Debug Interface<br/></li>
<li></span><span class="Comment">** See Copyright Notice in lua.h<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li></span><br/></li>
<li><a id="L7">&#x200c;</a><span class="PreProc">#define <span class="linkable">ldebug_c</span><br/></li>
<li><a id="L8">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">LUA_CORE</span><br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;lprefix.h&quot;<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;stdarg.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;stddef.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;string.h&gt;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;lua.h&quot;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;lapi.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;lcode.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;ldebug.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;ldo.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;lfunc.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;lobject.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;lopcodes.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;lstate.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;lstring.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;ltable.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;ltm.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;lvm.h&quot;<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L34">&#x200c;</a><span class="PreProc">#define <span class="linkable">noLuaClosure</span>(f)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ((f) == </span><span class="Constant">NULL</span><span class="PreProc"> || (f)-&gt;c.tt == <a href="lobject.h.html#L51" title="lobject.h:51">LUA_TCCL</a>)<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">const</span> <span class="Type">char</span> *<a href="#L441" title="ldebug.c:441">getfuncname</a> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <a href="lstate.h.html#L65" title="lstate.h:65">CallInfo</a> *ci, <span class="Type">const</span> <span class="Type">char</span> **name);<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L40">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">currentpc</span> (<a href="lstate.h.html#L65" title="lstate.h:65">CallInfo</a> *ci) {<br/></li>
<li>&nbsp; <a href="lualib.h.html#L54" title="lualib.h:54">lua_assert</a>(<a href="lstate.h.html#L98" title="lstate.h:98">isLua</a>(ci));<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="ldebug.h.html#L14" title="ldebug.h:14">pcRel</a>(ci-&gt;u.l.savedpc, <a href="ldebug.h.html#L21" title="ldebug.h:21">ci_func</a>(ci)-&gt;p);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L46">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">currentline</span> (<a href="lstate.h.html#L65" title="lstate.h:65">CallInfo</a> *ci) {<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="ldebug.h.html#L16" title="ldebug.h:16">getfuncline</a>(<a href="ldebug.h.html#L21" title="ldebug.h:21">ci_func</a>(ci)-&gt;p, <a href="#L40" title="ldebug.c:40">currentpc</a>(ci));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** this function can be called asynchronous (e.g. during a signal)<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L54">&#x200c;</a></span><a href="luaconf.h.html#L222" title="luaconf.h:222">LUA_API</a> <span class="Type">void</span> <span class="linkable">lua_sethook</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <a href="lua.h.html#L420" title="lua.h:420">lua_Hook</a> func, <span class="Type">int</span> <a href="lbitlib.c.html#L41" title="lbitlib.c:41">mask</a>, <span class="Type">int</span> count) {<br/></li>
<li>&nbsp; <span class="Statement">if</span> (func == <span class="Constant">NULL</span> || <a href="lbitlib.c.html#L41" title="lbitlib.c:41">mask</a> == <span class="Constant">0</span>) {&nbsp; <span class="Comment">/* turn off hooks? */<br/></li>
<li></span>&nbsp; &nbsp; <a href="lbitlib.c.html#L41" title="lbitlib.c:41">mask</a> = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; func = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="lstate.h.html#L98" title="lstate.h:98">isLua</a>(L-&gt;ci))<br/></li>
<li>&nbsp; &nbsp; L-&gt;oldpc = L-&gt;ci-&gt;u.l.savedpc;<br/></li>
<li>&nbsp; L-&gt;hook = func;<br/></li>
<li>&nbsp; L-&gt;basehookcount = count;<br/></li>
<li>&nbsp; <a href="ldebug.h.html#L18" title="ldebug.h:18">resethookcount</a>(L);<br/></li>
<li>&nbsp; L-&gt;hookmask = <a href="llimits.h.html#L110" title="llimits.h:110">cast_byte</a>(<a href="lbitlib.c.html#L41" title="lbitlib.c:41">mask</a>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L68">&#x200c;</a><a href="luaconf.h.html#L222" title="luaconf.h:222">LUA_API</a> <a href="lua.h.html#L420" title="lua.h:420">lua_Hook</a> <span class="linkable">lua_gethook</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <span class="Statement">return</span> L-&gt;hook;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L73">&#x200c;</a><a href="luaconf.h.html#L222" title="luaconf.h:222">LUA_API</a> <span class="Type">int</span> <span class="linkable">lua_gethookmask</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <span class="Statement">return</span> L-&gt;hookmask;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L78">&#x200c;</a><a href="luaconf.h.html#L222" title="luaconf.h:222">LUA_API</a> <span class="Type">int</span> <span class="linkable">lua_gethookcount</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <span class="Statement">return</span> L-&gt;basehookcount;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L83">&#x200c;</a><a href="luaconf.h.html#L222" title="luaconf.h:222">LUA_API</a> <span class="Type">int</span> <span class="linkable">lua_getstack</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">int</span> level, <a href="lua.h.html#L440" title="lua.h:440">lua_Debug</a> *ar) {<br/></li>
<li>&nbsp; <span class="Type">int</span> status;<br/></li>
<li>&nbsp; <a href="lstate.h.html#L65" title="lstate.h:65">CallInfo</a> *ci;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (level &lt; <span class="Constant">0</span>) <span class="Statement">return</span> <span class="Constant">0</span>;&nbsp; <span class="Comment">/* invalid (negative) level */<br/></li>
<li></span>&nbsp; <a href="llimits.h.html#L185" title="llimits.h:185">lua_lock</a>(L);<br/></li>
<li>&nbsp; <span class="Statement">for</span> (ci = L-&gt;ci; level &gt; <span class="Constant">0</span> &amp;&amp; ci != &amp;L-&gt;base_ci; ci = ci-&gt;previous)<br/></li>
<li>&nbsp; &nbsp; level--;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (level == <span class="Constant">0</span> &amp;&amp; ci != &amp;L-&gt;base_ci) {&nbsp; <span class="Comment">/* level found? */<br/></li>
<li></span>&nbsp; &nbsp; status = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; ar-&gt;i_ci = ci;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">else</span> status = <span class="Constant">0</span>;&nbsp; <span class="Comment">/* no such level */<br/></li>
<li></span>&nbsp; <a href="llimits.h.html#L186" title="llimits.h:186">lua_unlock</a>(L);<br/></li>
<li>&nbsp; <span class="Statement">return</span> status;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L100">&#x200c;</a><span class="Type">static</span> <span class="Type">const</span> <span class="Type">char</span> *<span class="linkable">upvalname</span> (<a href="lobject.h.html#L398" title="lobject.h:398">Proto</a> *p, <span class="Type">int</span> uv) {<br/></li>
<li>&nbsp; <a href="lobject.h.html#L303" title="lobject.h:303">TString</a> *s = <a href="llimits.h.html#L79" title="llimits.h:79">check_exp</a>(uv &lt; p-&gt;sizeupvalues, p-&gt;upvalues[uv].name);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (s == <span class="Constant">NULL</span>) <span class="Statement">return</span> <span class="Constant">&quot;?&quot;</span>;<br/></li>
<li>&nbsp; <span class="Statement">else</span> <span class="Statement">return</span> <a href="lobject.h.html#L326" title="lobject.h:326">getstr</a>(s);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L107">&#x200c;</a><span class="Type">static</span> <span class="Type">const</span> <span class="Type">char</span> *<span class="linkable">findvararg</span> (<a href="lstate.h.html#L65" title="lstate.h:65">CallInfo</a> *ci, <span class="Type">int</span> n, <a href="lobject.h.html#L294" title="lobject.h:294">StkId</a> *pos) {<br/></li>
<li>&nbsp; <span class="Type">int</span> nparams = <a href="lobject.h.html#L164" title="lobject.h:164">clLvalue</a>(ci-&gt;func)-&gt;p-&gt;numparams;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (n &gt;= ci-&gt;u.l.base - ci-&gt;func - nparams)<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;&nbsp; <span class="Comment">/* no such vararg */<br/></li>
<li></span>&nbsp; <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; *pos = ci-&gt;func + nparams + n;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">&quot;(*vararg)&quot;</span>;&nbsp; <span class="Comment">/* generic name for any vararg */<br/></li>
<li></span>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L118">&#x200c;</a><span class="Type">static</span> <span class="Type">const</span> <span class="Type">char</span> *<span class="linkable">findlocal</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <a href="lstate.h.html#L65" title="lstate.h:65">CallInfo</a> *ci, <span class="Type">int</span> n,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L294" title="lobject.h:294">StkId</a> *pos) {<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">char</span> *name = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; <a href="lobject.h.html#L294" title="lobject.h:294">StkId</a> base;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="lstate.h.html#L98" title="lstate.h:98">isLua</a>(ci)) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (n &lt; <span class="Constant">0</span>)&nbsp; <span class="Comment">/* access to vararg values? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L107" title="ldebug.c:107">findvararg</a>(ci, -n, pos);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; base = ci-&gt;u.l.base;<br/></li>
<li>&nbsp; &nbsp; &nbsp; name = <a href="lfunc.c.html#L140" title="lfunc.c:140">luaF_getlocalname</a>(<a href="ldebug.h.html#L21" title="ldebug.h:21">ci_func</a>(ci)-&gt;p, n, <a href="#L40" title="ldebug.c:40">currentpc</a>(ci));<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; base = ci-&gt;func + <span class="Constant">1</span>;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (name == <span class="Constant">NULL</span>) {&nbsp; <span class="Comment">/* no 'standard' name? */<br/></li>
<li></span>&nbsp; &nbsp; <a href="lobject.h.html#L294" title="lobject.h:294">StkId</a> limit = (ci == L-&gt;ci) ? L-&gt;top : ci-&gt;<a href="llex.c.html#L31" title="llex.c:31">next</a>-&gt;func;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (limit - base &gt;= n &amp;&amp; n &gt; <span class="Constant">0</span>)&nbsp; <span class="Comment">/* is 'n' inside 'ci' stack? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; name = <span class="Constant">&quot;(*temporary)&quot;</span>;&nbsp; <span class="Comment">/* generic name for any valid slot */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;&nbsp; <span class="Comment">/* no name */<br/></li>
<li></span>&nbsp; }<br/></li>
<li>&nbsp; *pos = base + (n - <span class="Constant">1</span>);<br/></li>
<li>&nbsp; <span class="Statement">return</span> name;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L144">&#x200c;</a><a href="luaconf.h.html#L222" title="luaconf.h:222">LUA_API</a> <span class="Type">const</span> <span class="Type">char</span> *<span class="linkable">lua_getlocal</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">const</span> <a href="lua.h.html#L440" title="lua.h:440">lua_Debug</a> *ar, <span class="Type">int</span> n) {<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">char</span> *name;<br/></li>
<li>&nbsp; <a href="llimits.h.html#L185" title="llimits.h:185">lua_lock</a>(L);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (ar == <span class="Constant">NULL</span>) {&nbsp; <span class="Comment">/* information about non-active function? */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (!<a href="lobject.h.html#L457" title="lobject.h:457">isLfunction</a>(L-&gt;top - <span class="Constant">1</span>))&nbsp; <span class="Comment">/* not a Lua function? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; name = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else</span>&nbsp; <span class="Comment">/* consider live variables at function start (parameters) */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; name = <a href="lfunc.c.html#L140" title="lfunc.c:140">luaF_getlocalname</a>(<a href="lobject.h.html#L164" title="lobject.h:164">clLvalue</a>(L-&gt;top - <span class="Constant">1</span>)-&gt;p, n, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">else</span> {&nbsp; <span class="Comment">/* active function; get information through 'ar' */<br/></li>
<li></span>&nbsp; &nbsp; <a href="lobject.h.html#L294" title="lobject.h:294">StkId</a> pos = <span class="Constant">0</span>;&nbsp; <span class="Comment">/* to avoid warnings */<br/></li>
<li></span>&nbsp; &nbsp; name = <a href="#L118" title="ldebug.c:118">findlocal</a>(L, ar-&gt;i_ci, n, &amp;pos);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (name) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L257" title="lobject.h:257">setobj2s</a>(L, L-&gt;top, pos);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="lapi.h.html#L14" title="lapi.h:14">api_incr_top</a>(L);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <a href="llimits.h.html#L186" title="llimits.h:186">lua_unlock</a>(L);<br/></li>
<li>&nbsp; <span class="Statement">return</span> name;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L166">&#x200c;</a><a href="luaconf.h.html#L222" title="luaconf.h:222">LUA_API</a> <span class="Type">const</span> <span class="Type">char</span> *<span class="linkable">lua_setlocal</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">const</span> <a href="lua.h.html#L440" title="lua.h:440">lua_Debug</a> *ar, <span class="Type">int</span> n) {<br/></li>
<li>&nbsp; <a href="lobject.h.html#L294" title="lobject.h:294">StkId</a> pos = <span class="Constant">0</span>;&nbsp; <span class="Comment">/* to avoid warnings */<br/></li>
<li></span>&nbsp; <span class="Type">const</span> <span class="Type">char</span> *name = <a href="#L118" title="ldebug.c:118">findlocal</a>(L, ar-&gt;i_ci, n, &amp;pos);<br/></li>
<li>&nbsp; <a href="llimits.h.html#L185" title="llimits.h:185">lua_lock</a>(L);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (name) {<br/></li>
<li>&nbsp; &nbsp; <a href="lobject.h.html#L255" title="lobject.h:255">setobjs2s</a>(L, pos, L-&gt;top - <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; L-&gt;top--;&nbsp; <span class="Comment">/* pop value */<br/></li>
<li></span>&nbsp; }<br/></li>
<li>&nbsp; <a href="llimits.h.html#L186" title="llimits.h:186">lua_unlock</a>(L);<br/></li>
<li>&nbsp; <span class="Statement">return</span> name;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L179">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">funcinfo</span> (<a href="lua.h.html#L440" title="lua.h:440">lua_Debug</a> *ar, <a href="lobject.h.html#L451" title="lobject.h:451">Closure</a> *cl) {<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="#L34" title="ldebug.c:34">noLuaClosure</a>(cl)) {<br/></li>
<li>&nbsp; &nbsp; ar-&gt;source = <span class="Constant">&quot;=[C]&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; ar-&gt;linedefined = -<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; ar-&gt;lastlinedefined = -<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; ar-&gt;what = <span class="Constant">&quot;C&quot;</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; <a href="lobject.h.html#L398" title="lobject.h:398">Proto</a> *p = cl-&gt;l.p;<br/></li>
<li>&nbsp; &nbsp; ar-&gt;source = p-&gt;source ? <a href="lobject.h.html#L326" title="lobject.h:326">getstr</a>(p-&gt;source) : <span class="Constant">&quot;=?&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; ar-&gt;linedefined = p-&gt;linedefined;<br/></li>
<li>&nbsp; &nbsp; ar-&gt;lastlinedefined = p-&gt;lastlinedefined;<br/></li>
<li>&nbsp; &nbsp; ar-&gt;what = (ar-&gt;linedefined == <span class="Constant">0</span>) ? <span class="Constant">&quot;<a href="lua.c.html#L595" title="lua.c:595">main</a>&quot;</span> : <span class="Constant">&quot;Lua&quot;</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <a href="lobject.c.html#L435" title="lobject.c:435">luaO_chunkid</a>(ar-&gt;short_src, ar-&gt;source, <a href="luaconf.h.html#L691" title="luaconf.h:691">LUA_IDSIZE</a>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L197">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">collectvalidlines</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <a href="lobject.h.html#L451" title="lobject.h:451">Closure</a> *f) {<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="#L34" title="ldebug.c:34">noLuaClosure</a>(f)) {<br/></li>
<li>&nbsp; &nbsp; <a href="lobject.h.html#L196" title="lobject.h:196">setnilvalue</a>(L-&gt;top);<br/></li>
<li>&nbsp; &nbsp; <a href="lapi.h.html#L14" title="lapi.h:14">api_incr_top</a>(L);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span> i;<br/></li>
<li>&nbsp; &nbsp; <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> v;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span> *lineinfo = f-&gt;l.p-&gt;lineinfo;<br/></li>
<li>&nbsp; &nbsp; <a href="lobject.h.html#L488" title="lobject.h:488">Table</a> *t = <a href="ltable.c.html#L403" title="ltable.c:403">luaH_new</a>(L);&nbsp; <span class="Comment">/* new table to store active lines */<br/></li>
<li></span>&nbsp; &nbsp; <a href="lobject.h.html#L236" title="lobject.h:236">sethvalue</a>(L, L-&gt;top, t);&nbsp; <span class="Comment">/* push it on stack */<br/></li>
<li></span>&nbsp; &nbsp; <a href="lapi.h.html#L14" title="lapi.h:14">api_incr_top</a>(L);<br/></li>
<li>&nbsp; &nbsp; <a href="lobject.h.html#L204" title="lobject.h:204">setbvalue</a>(&amp;v, <span class="Constant">1</span>);&nbsp; <span class="Comment">/* boolean 'true' to be the value of all indices */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; f-&gt;l.p-&gt;sizelineinfo; i++)&nbsp; <span class="Comment">/* for all lines with code */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <a href="ltable.c.html#L580" title="ltable.c:580">luaH_setint</a>(L, t, lineinfo[i], &amp;v);&nbsp; <span class="Comment">/* table[line] = true */<br/></li>
<li></span>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L216">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">auxgetinfo</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">const</span> <span class="Type">char</span> *what, <a href="lua.h.html#L440" title="lua.h:440">lua_Debug</a> *ar,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="lobject.h.html#L451" title="lobject.h:451">Closure</a> *f, <a href="lstate.h.html#L65" title="lstate.h:65">CallInfo</a> *ci) {<br/></li>
<li>&nbsp; <span class="Type">int</span> status = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; <span class="Statement">for</span> (; *what; what++) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">switch</span> (*what) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'<a href="luac.c.html#L393" title="luac.c:393">S</a>'</span>: {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L179" title="ldebug.c:179">funcinfo</a>(ar, f);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'l'</span>: {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ar-&gt;<a href="#L46" title="ldebug.c:46">currentline</a> = (ci &amp;&amp; <a href="lstate.h.html#L98" title="lstate.h:98">isLua</a>(ci)) ? <a href="#L46" title="ldebug.c:46">currentline</a>(ci) : -<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'u'</span>: {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ar-&gt;nups = (f == <span class="Constant">NULL</span>) ? <span class="Constant">0</span> : f-&gt;c.nupvalues;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L34" title="ldebug.c:34">noLuaClosure</a>(f)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ar-&gt;isvararg = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ar-&gt;nparams = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ar-&gt;isvararg = f-&gt;l.p-&gt;is_vararg;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ar-&gt;nparams = f-&gt;l.p-&gt;numparams;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'t'</span>: {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ar-&gt;istailcall = (ci) ? ci-&gt;callstatus &amp; <a href="lstate.h.html#L95" title="lstate.h:95">CIST_TAIL</a> : <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'n'</span>: {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* calling function is a known Lua function? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ci &amp;&amp; !(ci-&gt;callstatus &amp; <a href="lstate.h.html#L95" title="lstate.h:95">CIST_TAIL</a>) &amp;&amp; <a href="lstate.h.html#L98" title="lstate.h:98">isLua</a>(ci-&gt;previous))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ar-&gt;namewhat = <a href="#L441" title="ldebug.c:441">getfuncname</a>(L, ci-&gt;previous, &amp;ar-&gt;name);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ar-&gt;namewhat = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ar-&gt;namewhat == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ar-&gt;namewhat = <span class="Constant">&quot;&quot;</span>;&nbsp; <span class="Comment">/* not found */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ar-&gt;name = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'L'</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'f'</span>:&nbsp; <span class="Comment">/* handled by <a href="#L267" title="ldebug.c:267">lua_getinfo</a> */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:</span> status = <span class="Constant">0</span>;&nbsp; <span class="Comment">/* invalid option */<br/></li>
<li></span>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> status;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L267">&#x200c;</a><a href="luaconf.h.html#L222" title="luaconf.h:222">LUA_API</a> <span class="Type">int</span> <span class="linkable">lua_getinfo</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">const</span> <span class="Type">char</span> *what, <a href="lua.h.html#L440" title="lua.h:440">lua_Debug</a> *ar) {<br/></li>
<li>&nbsp; <span class="Type">int</span> status;<br/></li>
<li>&nbsp; <a href="lobject.h.html#L451" title="lobject.h:451">Closure</a> *cl;<br/></li>
<li>&nbsp; <a href="lstate.h.html#L65" title="lstate.h:65">CallInfo</a> *ci;<br/></li>
<li>&nbsp; <a href="lobject.h.html#L294" title="lobject.h:294">StkId</a> func;<br/></li>
<li>&nbsp; <a href="llimits.h.html#L185" title="llimits.h:185">lua_lock</a>(L);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (*what == <span class="Constant">'&gt;'</span>) {<br/></li>
<li>&nbsp; &nbsp; ci = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; func = L-&gt;top - <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; <a href="llimits.h.html#L99" title="llimits.h:99">api_check</a>(<a href="lobject.h.html#L144" title="lobject.h:144">ttisfunction</a>(func), <span class="Constant">&quot;function expected&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; what++;&nbsp; <span class="Comment">/* skip the '&gt;' */<br/></li>
<li></span>&nbsp; &nbsp; L-&gt;top--;&nbsp; <span class="Comment">/* pop function */<br/></li>
<li></span>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; ci = ar-&gt;i_ci;<br/></li>
<li>&nbsp; &nbsp; func = ci-&gt;func;<br/></li>
<li>&nbsp; &nbsp; <a href="lualib.h.html#L54" title="lualib.h:54">lua_assert</a>(<a href="lobject.h.html#L144" title="lobject.h:144">ttisfunction</a>(ci-&gt;func));<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; cl = <a href="lobject.h.html#L145" title="lobject.h:145">ttisclosure</a>(func) ? <a href="lobject.h.html#L163" title="lobject.h:163">clvalue</a>(func) : <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; status = <a href="#L216" title="ldebug.c:216">auxgetinfo</a>(L, what, ar, cl, ci);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (strchr(what, <span class="Constant">'f'</span>)) {<br/></li>
<li>&nbsp; &nbsp; <a href="lobject.h.html#L255" title="lobject.h:255">setobjs2s</a>(L, L-&gt;top, func);<br/></li>
<li>&nbsp; &nbsp; <a href="lapi.h.html#L14" title="lapi.h:14">api_incr_top</a>(L);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">if</span> (strchr(what, <span class="Constant">'L'</span>))<br/></li>
<li>&nbsp; &nbsp; <a href="#L197" title="ldebug.c:197">collectvalidlines</a>(L, cl);<br/></li>
<li>&nbsp; <a href="llimits.h.html#L186" title="llimits.h:186">lua_unlock</a>(L);<br/></li>
<li>&nbsp; <span class="Statement">return</span> status;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** {======================================================<br/></li>
<li></span><span class="Comment">** Symbolic Execution<br/></li>
<li></span><span class="Comment">** =======================================================<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li></span><br/></li>
<li><span class="Type">static</span> <span class="Type">const</span> <span class="Type">char</span> *<a href="#L387" title="ldebug.c:387">getobjname</a> (<a href="lobject.h.html#L398" title="lobject.h:398">Proto</a> *p, <span class="Type">int</span> lastpc, <span class="Type">int</span> reg,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type">const</span> <span class="Type">char</span> **name);<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** find a &quot;name&quot; for the RK value 'c'<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L311">&#x200c;</a></span><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">kname</span> (<a href="lobject.h.html#L398" title="lobject.h:398">Proto</a> *p, <span class="Type">int</span> pc, <span class="Type">int</span> c, <span class="Type">const</span> <span class="Type">char</span> **name) {<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="lopcodes.h.html#L137" title="lopcodes.h:137">ISK</a>(c)) {&nbsp; <span class="Comment">/* is 'c' a constant? */<br/></li>
<li></span>&nbsp; &nbsp; <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> *kvalue = &amp;p-&gt;k[<a href="lopcodes.h.html#L140" title="lopcodes.h:140">INDEXK</a>(c)];<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="lobject.h.html#L140" title="lobject.h:140">ttisstring</a>(kvalue)) {&nbsp; <span class="Comment">/* literal constant? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; *name = <a href="lobject.h.html#L330" title="lobject.h:330">svalue</a>(kvalue);&nbsp; <span class="Comment">/* it is its own name */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* else no reasonable name found */<br/></li>
<li></span>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">else</span> {&nbsp; <span class="Comment">/* 'c' is a register */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span> *what = <a href="#L387" title="ldebug.c:387">getobjname</a>(p, pc, c, name); <span class="Comment">/* search for 'c' */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (what &amp;&amp; *what == <span class="Constant">'c'</span>) {&nbsp; <span class="Comment">/* found a constant name? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;&nbsp; <span class="Comment">/* 'name' already filled */<br/></li>
<li></span>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* else no reasonable name found */<br/></li>
<li></span>&nbsp; }<br/></li>
<li>&nbsp; *name = <span class="Constant">&quot;?&quot;</span>;&nbsp; <span class="Comment">/* no reasonable name found */<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L331">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">filterpc</span> (<span class="Type">int</span> pc, <span class="Type">int</span> jmptarget) {<br/></li>
<li>&nbsp; <span class="Statement">if</span> (pc &lt; jmptarget)&nbsp; <span class="Comment">/* is code conditional (inside a jump)? */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant">1</span>;&nbsp; <span class="Comment">/* <a href="luac.c.html#L44" title="luac.c:44">cannot</a> know who sets that register */<br/></li>
<li></span>&nbsp; <span class="Statement">else</span> <span class="Statement">return</span> pc;&nbsp; <span class="Comment">/* current position sets that register */<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** try to find last instruction before 'lastpc' that modified register 'reg'<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L341">&#x200c;</a></span><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">findsetreg</span> (<a href="lobject.h.html#L398" title="lobject.h:398">Proto</a> *p, <span class="Type">int</span> lastpc, <span class="Type">int</span> reg) {<br/></li>
<li>&nbsp; <span class="Type">int</span> pc;<br/></li>
<li>&nbsp; <span class="Type">int</span> setreg = -<span class="Constant">1</span>;&nbsp; <span class="Comment">/* keep last instruction that changed 'reg' */<br/></li>
<li></span>&nbsp; <span class="Type">int</span> jmptarget = <span class="Constant">0</span>;&nbsp; <span class="Comment">/* any code before this address is conditional */<br/></li>
<li></span>&nbsp; <span class="Statement">for</span> (pc = <span class="Constant">0</span>; pc &lt; lastpc; pc++) {<br/></li>
<li>&nbsp; &nbsp; <a href="llimits.h.html#L164" title="llimits.h:164">Instruction</a> i = p-&gt;code[pc];<br/></li>
<li>&nbsp; &nbsp; <a href="lopcodes.h.html#L232" title="lopcodes.h:232">OpCode</a> op = <a href="lopcodes.h.html#L89" title="lopcodes.h:89">GET_OPCODE</a>(i);<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span> a = <a href="lopcodes.h.html#L97" title="lopcodes.h:97">GETARG_A</a>(i);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">switch</span> (op) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> OP_LOADNIL: {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> b = <a href="lopcodes.h.html#L100" title="lopcodes.h:100">GETARG_B</a>(i);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (a &lt;= reg &amp;&amp; reg &lt;= a + b)&nbsp; <span class="Comment">/* set registers from 'a' to 'a+b' */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; setreg = <a href="#L331" title="ldebug.c:331">filterpc</a>(pc, jmptarget);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> OP_TFORCALL: {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (reg &gt;= a + <span class="Constant">2</span>)&nbsp; <span class="Comment">/* affect all regs above its base */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; setreg = <a href="#L331" title="ldebug.c:331">filterpc</a>(pc, jmptarget);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> OP_CALL:<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> OP_TAILCALL: {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (reg &gt;= a)&nbsp; <span class="Comment">/* affect all registers above base */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; setreg = <a href="#L331" title="ldebug.c:331">filterpc</a>(pc, jmptarget);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> OP_JMP: {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> b = <a href="lopcodes.h.html#L112" title="lopcodes.h:112">GETARG_sBx</a>(i);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> dest = pc + <span class="Constant">1</span> + b;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* jump is forward and do not skip 'lastpc'? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (pc &lt; dest &amp;&amp; dest &lt;= lastpc) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (dest &gt; jmptarget)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jmptarget = dest;&nbsp; <span class="Comment">/* update 'jmptarget' */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="lopcodes.h.html#L284" title="lopcodes.h:284">testAMode</a>(op) &amp;&amp; reg == a)&nbsp; <span class="Comment">/* any instruction that set A */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; setreg = <a href="#L331" title="ldebug.c:331">filterpc</a>(pc, jmptarget);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> setreg;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L387">&#x200c;</a><span class="Type">static</span> <span class="Type">const</span> <span class="Type">char</span> *<span class="linkable">getobjname</span> (<a href="lobject.h.html#L398" title="lobject.h:398">Proto</a> *p, <span class="Type">int</span> lastpc, <span class="Type">int</span> reg,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type">const</span> <span class="Type">char</span> **name) {<br/></li>
<li>&nbsp; <span class="Type">int</span> pc;<br/></li>
<li>&nbsp; *name = <a href="lfunc.c.html#L140" title="lfunc.c:140">luaF_getlocalname</a>(p, reg + <span class="Constant">1</span>, lastpc);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (*name)&nbsp; <span class="Comment">/* is a local? */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">&quot;local&quot;</span>;<br/></li>
<li>&nbsp; <span class="Comment">/* else try symbolic execution */<br/></li>
<li></span>&nbsp; pc = <a href="#L341" title="ldebug.c:341">findsetreg</a>(p, lastpc, reg);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (pc != -<span class="Constant">1</span>) {&nbsp; <span class="Comment">/* could find instruction? */<br/></li>
<li></span>&nbsp; &nbsp; <a href="llimits.h.html#L164" title="llimits.h:164">Instruction</a> i = p-&gt;code[pc];<br/></li>
<li>&nbsp; &nbsp; <a href="lopcodes.h.html#L232" title="lopcodes.h:232">OpCode</a> op = <a href="lopcodes.h.html#L89" title="lopcodes.h:89">GET_OPCODE</a>(i);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">switch</span> (op) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> OP_MOVE: {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> b = <a href="lopcodes.h.html#L100" title="lopcodes.h:100">GETARG_B</a>(i);&nbsp; <span class="Comment">/* move from 'b' to 'a' */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (b &lt; <a href="lopcodes.h.html#L97" title="lopcodes.h:97">GETARG_A</a>(i))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L387" title="ldebug.c:387">getobjname</a>(p, pc, b, name);&nbsp; <span class="Comment">/* get name for 'b' */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> OP_GETTABUP:<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> OP_GETTABLE: {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> k = <a href="lopcodes.h.html#L103" title="lopcodes.h:103">GETARG_C</a>(i);&nbsp; <span class="Comment">/* key index */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> t = <a href="lopcodes.h.html#L100" title="lopcodes.h:100">GETARG_B</a>(i);&nbsp; <span class="Comment">/* table index */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span> *vn = (op == OP_GETTABLE)&nbsp; <span class="Comment">/* name of indexed variable */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ? <a href="lfunc.c.html#L140" title="lfunc.c:140">luaF_getlocalname</a>(p, t + <span class="Constant">1</span>, pc)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; : <a href="#L100" title="ldebug.c:100">upvalname</a>(p, t);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L311" title="ldebug.c:311">kname</a>(p, pc, k, name);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> (vn &amp;&amp; strcmp(vn, <a href="llex.h.html#L18" title="llex.h:18">LUA_ENV</a>) == <span class="Constant">0</span>) ? <span class="Constant">&quot;global&quot;</span> : <span class="Constant">&quot;<a href="lparser.c.html#L696" title="lparser.c:696">field</a>&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> OP_GETUPVAL: {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *name = <a href="#L100" title="ldebug.c:100">upvalname</a>(p, <a href="lopcodes.h.html#L100" title="lopcodes.h:100">GETARG_B</a>(i));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">&quot;upvalue&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> OP_LOADK:<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> OP_LOADKX: {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> b = (op == OP_LOADK) ? <a href="lopcodes.h.html#L106" title="lopcodes.h:106">GETARG_Bx</a>(i)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; : <a href="lopcodes.h.html#L109" title="lopcodes.h:109">GETARG_Ax</a>(p-&gt;code[pc + <span class="Constant">1</span>]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="lobject.h.html#L140" title="lobject.h:140">ttisstring</a>(&amp;p-&gt;k[b])) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *name = <a href="lobject.h.html#L330" title="lobject.h:330">svalue</a>(&amp;p-&gt;k[b]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">&quot;constant&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> OP_SELF: {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> k = <a href="lopcodes.h.html#L103" title="lopcodes.h:103">GETARG_C</a>(i);&nbsp; <span class="Comment">/* key index */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L311" title="ldebug.c:311">kname</a>(p, pc, k, name);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">&quot;method&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:</span> <span class="Statement">break</span>;&nbsp; <span class="Comment">/* go through to return NULL */<br/></li>
<li></span>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;&nbsp; <span class="Comment">/* could not find reasonable name */<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L441">&#x200c;</a><span class="Type">static</span> <span class="Type">const</span> <span class="Type">char</span> *<span class="linkable">getfuncname</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <a href="lstate.h.html#L65" title="lstate.h:65">CallInfo</a> *ci, <span class="Type">const</span> <span class="Type">char</span> **name) {<br/></li>
<li>&nbsp; <a href="ltm.h.html#L44" title="ltm.h:44">TMS</a> tm = (<a href="ltm.h.html#L44" title="ltm.h:44">TMS</a>)<span class="Constant">0</span>;&nbsp; <span class="Comment">/* to avoid warnings */<br/></li>
<li></span>&nbsp; <a href="lobject.h.html#L398" title="lobject.h:398">Proto</a> *p = <a href="ldebug.h.html#L21" title="ldebug.h:21">ci_func</a>(ci)-&gt;p;&nbsp; <span class="Comment">/* calling function */<br/></li>
<li></span>&nbsp; <span class="Type">int</span> pc = <a href="#L40" title="ldebug.c:40">currentpc</a>(ci);&nbsp; <span class="Comment">/* calling instruction index */<br/></li>
<li></span>&nbsp; <a href="llimits.h.html#L164" title="llimits.h:164">Instruction</a> i = p-&gt;code[pc];&nbsp; <span class="Comment">/* calling instruction */<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (ci-&gt;callstatus &amp; <a href="lstate.h.html#L91" title="lstate.h:91">CIST_HOOKED</a>) {&nbsp; <span class="Comment">/* was it called inside a hook? */<br/></li>
<li></span>&nbsp; &nbsp; *name = <span class="Constant">&quot;?&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">&quot;hook&quot;</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">switch</span> (<a href="lopcodes.h.html#L89" title="lopcodes.h:89">GET_OPCODE</a>(i)) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> OP_CALL:<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> OP_TAILCALL:&nbsp; <span class="Comment">/* get function name */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L387" title="ldebug.c:387">getobjname</a>(p, pc, <a href="lopcodes.h.html#L97" title="lopcodes.h:97">GETARG_A</a>(i), name);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> OP_TFORCALL: {&nbsp; <span class="Comment">/* for iterator */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; *name = <span class="Constant">&quot;for iterator&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp;&nbsp; <span class="Statement">return</span> <span class="Constant">&quot;for iterator&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* all other instructions can call only through metamethods */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">case</span> OP_SELF: <span class="Statement">case</span> OP_GETTABUP: <span class="Statement">case</span> OP_GETTABLE:<br/></li>
<li>&nbsp; &nbsp; &nbsp; tm = TM_INDEX;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> OP_SETTABUP: <span class="Statement">case</span> OP_SETTABLE:<br/></li>
<li>&nbsp; &nbsp; &nbsp; tm = TM_NEWINDEX;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> OP_ADD: <span class="Statement">case</span> OP_SUB: <span class="Statement">case</span> OP_MUL: <span class="Statement">case</span> OP_MOD:<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> OP_POW: <span class="Statement">case</span> OP_DIV: <span class="Statement">case</span> OP_IDIV: <span class="Statement">case</span> OP_BAND:<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> OP_BOR: <span class="Statement">case</span> OP_BXOR: <span class="Statement">case</span> OP_SHL: <span class="Statement">case</span> OP_SHR: {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Type">int</span> offset = <a href="llimits.h.html#L112" title="llimits.h:112">cast_int</a>(<a href="lopcodes.h.html#L89" title="lopcodes.h:89">GET_OPCODE</a>(i)) - <a href="llimits.h.html#L112" title="llimits.h:112">cast_int</a>(OP_ADD);&nbsp; <span class="Comment">/* ORDER OP */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; tm = <a href="llimits.h.html#L107" title="llimits.h:107">cast</a>(<a href="ltm.h.html#L44" title="ltm.h:44">TMS</a>, offset + <a href="llimits.h.html#L112" title="llimits.h:112">cast_int</a>(TM_ADD));&nbsp; <span class="Comment">/* ORDER TM */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> OP_UNM: tm = TM_UNM; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> OP_BNOT: tm = TM_BNOT; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> OP_LEN: tm = TM_LEN; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> OP_CONCAT: tm = TM_CONCAT; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> OP_EQ: tm = TM_EQ; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> OP_LT: tm = TM_LT; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> OP_LE: tm = TM_LE; <span class="Statement">break</span>;<br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:</span> <a href="lualib.h.html#L54" title="lualib.h:54">lua_assert</a>(<span class="Constant">0</span>);&nbsp; <span class="Comment">/* other instructions <a href="luac.c.html#L44" title="luac.c:44">cannot</a> call a function */<br/></li>
<li></span>&nbsp; }<br/></li>
<li>&nbsp; *name = <a href="lobject.h.html#L326" title="lobject.h:326">getstr</a>(<a href="lstate.h.html#L175" title="lstate.h:175">G</a>(L)-&gt;tmname[tm]);<br/></li>
<li>&nbsp; <span class="Statement">return</span> <span class="Constant">&quot;metamethod&quot;</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* }====================================================== */<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** The subtraction of two potentially unrelated pointers is<br/></li>
<li></span><span class="Comment">** not ISO C, but it should not crash a program; the subsequent<br/></li>
<li></span><span class="Comment">** checks are ISO C and ensure a correct result.<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L494">&#x200c;</a></span><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">isinstack</span> (<a href="lstate.h.html#L65" title="lstate.h:65">CallInfo</a> *ci, <span class="Type">const</span> <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> *o) {<br/></li>
<li>&nbsp; <span class="Type">ptrdiff_t</span> i = o - ci-&gt;u.l.base;<br/></li>
<li>&nbsp; <span class="Statement">return</span> (<span class="Constant">0</span> &lt;= i &amp;&amp; i &lt; (ci-&gt;top - ci-&gt;u.l.base) &amp;&amp; ci-&gt;u.l.base + i == o);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** Checks whether value 'o' came from an upvalue. (That can only happen<br/></li>
<li></span><span class="Comment">** with instructions OP_GETTABUP/OP_SETTABUP, which operate directly on<br/></li>
<li></span><span class="Comment">** upvalues.)<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L505">&#x200c;</a></span><span class="Type">static</span> <span class="Type">const</span> <span class="Type">char</span> *<span class="linkable">getupvalname</span> (<a href="lstate.h.html#L65" title="lstate.h:65">CallInfo</a> *ci, <span class="Type">const</span> <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> *o,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type">const</span> <span class="Type">char</span> **name) {<br/></li>
<li>&nbsp; <a href="lobject.h.html#L444" title="lobject.h:444">LClosure</a> *c = <a href="ldebug.h.html#L21" title="ldebug.h:21">ci_func</a>(ci);<br/></li>
<li>&nbsp; <span class="Type">int</span> i;<br/></li>
<li>&nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; c-&gt;nupvalues; i++) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;upvals[i]-&gt;v == o) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; *name = <a href="#L100" title="ldebug.c:100">upvalname</a>(c-&gt;p, i);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">&quot;upvalue&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L519">&#x200c;</a><span class="Type">static</span> <span class="Type">const</span> <span class="Type">char</span> *<span class="linkable">varinfo</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">const</span> <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> *o) {<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">char</span> *name = <span class="Constant">NULL</span>;&nbsp; <span class="Comment">/* to avoid warnings */<br/></li>
<li></span>&nbsp; <a href="lstate.h.html#L65" title="lstate.h:65">CallInfo</a> *ci = L-&gt;ci;<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">char</span> *kind = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="lstate.h.html#L98" title="lstate.h:98">isLua</a>(ci)) {<br/></li>
<li>&nbsp; &nbsp; kind = <a href="#L505" title="ldebug.c:505">getupvalname</a>(ci, o, &amp;name);&nbsp; <span class="Comment">/* <a href="lparser.c.html#L106" title="lparser.c:106">check</a> whether 'o' is an upvalue */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (!kind &amp;&amp; <a href="#L494" title="ldebug.c:494">isinstack</a>(ci, o))&nbsp; <span class="Comment">/* no? try a register */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; kind = <a href="#L387" title="ldebug.c:387">getobjname</a>(<a href="ldebug.h.html#L21" title="ldebug.h:21">ci_func</a>(ci)-&gt;p, <a href="#L40" title="ldebug.c:40">currentpc</a>(ci),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="llimits.h.html#L112" title="llimits.h:112">cast_int</a>(o - ci-&gt;u.l.base), &amp;name);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> (kind) ? <a href="lobject.c.html#L416" title="lobject.c:416">luaO_pushfstring</a>(L, <span class="Constant">&quot; (</span><span class="Special">%s</span><span class="Constant"> '</span><span class="Special">%s</span><span class="Constant">')&quot;</span>, kind, name) : <span class="Constant">&quot;&quot;</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L533">&#x200c;</a><a href="llimits.h.html#L135" title="llimits.h:135">l_noret</a> <span class="linkable">luaG_typeerror</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">const</span> <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> *o, <span class="Type">const</span> <span class="Type">char</span> *op) {<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">char</span> *t = <a href="ltm.h.html#L54" title="ltm.h:54">objtypename</a>(o);<br/></li>
<li>&nbsp; <a href="#L603" title="ldebug.c:603">luaG_runerror</a>(L, <span class="Constant">&quot;attempt to </span><span class="Special">%s</span><span class="Constant"> a </span><span class="Special">%s</span><span class="Constant"> value</span><span class="Special">%s</span><span class="Constant">&quot;</span>, op, t, <a href="#L519" title="ldebug.c:519">varinfo</a>(L, o));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L539">&#x200c;</a><a href="llimits.h.html#L135" title="llimits.h:135">l_noret</a> <span class="linkable">luaG_concaterror</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">const</span> <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> *p1, <span class="Type">const</span> <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> *p2) {<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="lobject.h.html#L140" title="lobject.h:140">ttisstring</a>(p1) || <a href="lvm.h.html#L17" title="lvm.h:17">cvt2str</a>(p1)) p1 = p2;<br/></li>
<li>&nbsp; <a href="#L533" title="ldebug.c:533">luaG_typeerror</a>(L, p1, <span class="Constant">&quot;concatenate&quot;</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L545">&#x200c;</a><a href="llimits.h.html#L135" title="llimits.h:135">l_noret</a> <span class="linkable">luaG_opinterror</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">const</span> <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> *p1,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type">const</span> <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> *p2, <span class="Type">const</span> <span class="Type">char</span> *msg) {<br/></li>
<li>&nbsp; <a href="lua.h.html#L87" title="lua.h:87">lua_Number</a> temp;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (!<a href="lvm.h.html#L30" title="lvm.h:30">tonumber</a>(p1, &amp;temp))&nbsp; <span class="Comment">/* first operand is wrong? */<br/></li>
<li></span>&nbsp; &nbsp; p2 = p1;&nbsp; <span class="Comment">/* now second is wrong */<br/></li>
<li></span>&nbsp; <a href="#L533" title="ldebug.c:533">luaG_typeerror</a>(L, p2, msg);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** Error when both values are convertible to numbers, but not to integers<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L557">&#x200c;</a></span><a href="llimits.h.html#L135" title="llimits.h:135">l_noret</a> <span class="linkable">luaG_tointerror</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">const</span> <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> *p1, <span class="Type">const</span> <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> *p2) {<br/></li>
<li>&nbsp; <a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a> temp;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (!<a href="lvm.h.html#L33" title="lvm.h:33">tointeger</a>(p1, &amp;temp))<br/></li>
<li>&nbsp; &nbsp; p2 = p1;<br/></li>
<li>&nbsp; <a href="#L603" title="ldebug.c:603">luaG_runerror</a>(L, <span class="Constant">&quot;number</span><span class="Special">%s</span><span class="Constant"> has no integer representation&quot;</span>, <a href="#L519" title="ldebug.c:519">varinfo</a>(L, p2));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L565">&#x200c;</a><a href="llimits.h.html#L135" title="llimits.h:135">l_noret</a> <span class="linkable">luaG_ordererror</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">const</span> <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> *p1, <span class="Type">const</span> <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> *p2) {<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">char</span> *t1 = <a href="ltm.h.html#L54" title="ltm.h:54">objtypename</a>(p1);<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">char</span> *t2 = <a href="ltm.h.html#L54" title="ltm.h:54">objtypename</a>(p2);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (t1 == t2)<br/></li>
<li>&nbsp; &nbsp; <a href="#L603" title="ldebug.c:603">luaG_runerror</a>(L, <span class="Constant">&quot;attempt to compare two </span><span class="Special">%s</span><span class="Constant"> values&quot;</span>, t1);<br/></li>
<li>&nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L603" title="ldebug.c:603">luaG_runerror</a>(L, <span class="Constant">&quot;attempt to compare </span><span class="Special">%s</span><span class="Constant"> with </span><span class="Special">%s</span><span class="Constant">&quot;</span>, t1, t2);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L575">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">addinfo</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">const</span> <span class="Type">char</span> *msg) {<br/></li>
<li>&nbsp; <a href="lstate.h.html#L65" title="lstate.h:65">CallInfo</a> *ci = L-&gt;ci;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="lstate.h.html#L98" title="lstate.h:98">isLua</a>(ci)) {&nbsp; <span class="Comment">/* is Lua code? */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">char</span> buff[<a href="luaconf.h.html#L691" title="luaconf.h:691">LUA_IDSIZE</a>];&nbsp; <span class="Comment">/* add file:line information */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">int</span> line = <a href="#L46" title="ldebug.c:46">currentline</a>(ci);<br/></li>
<li>&nbsp; &nbsp; <a href="lobject.h.html#L303" title="lobject.h:303">TString</a> *src = <a href="ldebug.h.html#L21" title="ldebug.h:21">ci_func</a>(ci)-&gt;p-&gt;source;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (src)<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="lobject.c.html#L435" title="lobject.c:435">luaO_chunkid</a>(buff, <a href="lobject.h.html#L326" title="lobject.h:326">getstr</a>(src), <a href="luaconf.h.html#L691" title="luaconf.h:691">LUA_IDSIZE</a>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else</span> {&nbsp; <span class="Comment">/* no source available; use &quot;?&quot; instead */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; buff[<span class="Constant">0</span>] = <span class="Constant">'?'</span>; buff[<span class="Constant">1</span>] = <span class="Special">'\0'</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <a href="lobject.c.html#L416" title="lobject.c:416">luaO_pushfstring</a>(L, <span class="Constant">&quot;</span><span class="Special">%s</span><span class="Constant">:</span><span class="Special">%d</span><span class="Constant">: </span><span class="Special">%s</span><span class="Constant">&quot;</span>, buff, line, msg);<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L591">&#x200c;</a><a href="llimits.h.html#L135" title="llimits.h:135">l_noret</a> <span class="linkable">luaG_errormsg</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <span class="Statement">if</span> (L-&gt;errfunc != <span class="Constant">0</span>) {&nbsp; <span class="Comment">/* is there an <a href="lundump.c.html#L40" title="lundump.c:40">error</a> handling function? */<br/></li>
<li></span>&nbsp; &nbsp; <a href="lobject.h.html#L294" title="lobject.h:294">StkId</a> errfunc = <a href="ldo.h.html#L23" title="ldo.h:23">restorestack</a>(L, L-&gt;errfunc);<br/></li>
<li>&nbsp; &nbsp; <a href="lobject.h.html#L255" title="lobject.h:255">setobjs2s</a>(L, L-&gt;top, L-&gt;top - <span class="Constant">1</span>);&nbsp; <span class="Comment">/* move argument */<br/></li>
<li></span>&nbsp; &nbsp; <a href="lobject.h.html#L255" title="lobject.h:255">setobjs2s</a>(L, L-&gt;top - <span class="Constant">1</span>, errfunc);&nbsp; <span class="Comment">/* push function */<br/></li>
<li></span>&nbsp; &nbsp; L-&gt;top++;&nbsp; <span class="Comment">/* assume <a href="lstate.h.html#L38" title="lstate.h:38">EXTRA_STACK</a> */<br/></li>
<li></span>&nbsp; &nbsp; <a href="ldo.c.html#L413" title="ldo.c:413">luaD_call</a>(L, L-&gt;top - <span class="Constant">2</span>, <span class="Constant">1</span>, <span class="Constant">0</span>);&nbsp; <span class="Comment">/* call it */<br/></li>
<li></span>&nbsp; }<br/></li>
<li>&nbsp; <a href="ldo.c.html#L110" title="ldo.c:110">luaD_throw</a>(L, <a href="lua.h.html#L47" title="lua.h:47">LUA_ERRRUN</a>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L603">&#x200c;</a><a href="llimits.h.html#L135" title="llimits.h:135">l_noret</a> <span class="linkable">luaG_runerror</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">const</span> <span class="Type">char</span> *fmt, ...) {<br/></li>
<li>&nbsp; <span class="Type">va_list</span> argp;<br/></li>
<li>&nbsp; va_start(argp, fmt);<br/></li>
<li>&nbsp; <a href="#L575" title="ldebug.c:575">addinfo</a>(L, <a href="lobject.c.html#L348" title="lobject.c:348">luaO_pushvfstring</a>(L, fmt, argp));<br/></li>
<li>&nbsp; va_end(argp);<br/></li>
<li>&nbsp; <a href="#L591" title="ldebug.c:591">luaG_errormsg</a>(L);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L612">&#x200c;</a><span class="Type">void</span> <span class="linkable">luaG_traceexec</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <a href="lstate.h.html#L65" title="lstate.h:65">CallInfo</a> *ci = L-&gt;ci;<br/></li>
<li>&nbsp; <a href="llimits.h.html#L35" title="llimits.h:35">lu_byte</a> <a href="lbitlib.c.html#L41" title="lbitlib.c:41">mask</a> = L-&gt;hookmask;<br/></li>
<li>&nbsp; <span class="Type">int</span> counthook = ((<a href="lbitlib.c.html#L41" title="lbitlib.c:41">mask</a> &amp; <a href="lua.h.html#L414" title="lua.h:414">LUA_MASKCOUNT</a>) &amp;&amp; L-&gt;hookcount == <span class="Constant">0</span>);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (counthook)<br/></li>
<li>&nbsp; &nbsp; <a href="ldebug.h.html#L18" title="ldebug.h:18">resethookcount</a>(L);&nbsp; <span class="Comment">/* reset count */<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (ci-&gt;callstatus &amp; <a href="lstate.h.html#L96" title="lstate.h:96">CIST_HOOKYIELD</a>) {&nbsp; <span class="Comment">/* called hook last time? */<br/></li>
<li></span>&nbsp; &nbsp; ci-&gt;callstatus &amp;= ~<a href="lstate.h.html#L96" title="lstate.h:96">CIST_HOOKYIELD</a>;&nbsp; <span class="Comment">/* erase mark */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">return</span>;&nbsp; <span class="Comment">/* do not call hook again (VM yielded, so it did not move) */<br/></li>
<li></span>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">if</span> (counthook)<br/></li>
<li>&nbsp; &nbsp; <a href="ldo.c.html#L232" title="ldo.c:232">luaD_hook</a>(L, <a href="lua.h.html#L404" title="lua.h:404">LUA_HOOKCOUNT</a>, -<span class="Constant">1</span>);&nbsp; <span class="Comment">/* call count hook */<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (<a href="lbitlib.c.html#L41" title="lbitlib.c:41">mask</a> &amp; <a href="lua.h.html#L413" title="lua.h:413">LUA_MASKLINE</a>) {<br/></li>
<li>&nbsp; &nbsp; <a href="lobject.h.html#L398" title="lobject.h:398">Proto</a> *p = <a href="ldebug.h.html#L21" title="ldebug.h:21">ci_func</a>(ci)-&gt;p;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span> npc = <a href="ldebug.h.html#L14" title="ldebug.h:14">pcRel</a>(ci-&gt;u.l.savedpc, p);<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span> newline = <a href="ldebug.h.html#L16" title="ldebug.h:16">getfuncline</a>(p, npc);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (npc == <span class="Constant">0</span> ||&nbsp; <span class="Comment">/* call linehook when enter a new function, */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; ci-&gt;u.l.savedpc &lt;= L-&gt;oldpc ||&nbsp; <span class="Comment">/* when jump back (loop), or when */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; newline != <a href="ldebug.h.html#L16" title="ldebug.h:16">getfuncline</a>(p, <a href="ldebug.h.html#L14" title="ldebug.h:14">pcRel</a>(L-&gt;oldpc, p)))&nbsp; <span class="Comment">/* enter a new line */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <a href="ldo.c.html#L232" title="ldo.c:232">luaD_hook</a>(L, <a href="lua.h.html#L403" title="lua.h:403">LUA_HOOKLINE</a>, newline);&nbsp; <span class="Comment">/* call line hook */<br/></li>
<li></span>&nbsp; }<br/></li>
<li>&nbsp; L-&gt;oldpc = ci-&gt;u.l.savedpc;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (L-&gt;status == <a href="lua.h.html#L46" title="lua.h:46">LUA_YIELD</a>) {&nbsp; <span class="Comment">/* did hook yield? */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (counthook)<br/></li>
<li>&nbsp; &nbsp; &nbsp; L-&gt;hookcount = <span class="Constant">1</span>;&nbsp; <span class="Comment">/* undo decrement to zero */<br/></li>
<li></span>&nbsp; &nbsp; ci-&gt;u.l.savedpc--;&nbsp; <span class="Comment">/* undo increment (<a href="ldo.c.html#L534" title="ldo.c:534">resume</a> will increment it again) */<br/></li>
<li></span>&nbsp; &nbsp; ci-&gt;callstatus |= <a href="lstate.h.html#L96" title="lstate.h:96">CIST_HOOKYIELD</a>;&nbsp; <span class="Comment">/* mark that it yielded */<br/></li>
<li></span>&nbsp; &nbsp; ci-&gt;func = L-&gt;top - <span class="Constant">1</span>;&nbsp; <span class="Comment">/* protect stack below results */<br/></li>
<li></span>&nbsp; &nbsp; <a href="ldo.c.html#L110" title="ldo.c:110">luaD_throw</a>(L, <a href="lua.h.html#L46" title="lua.h:46">LUA_YIELD</a>);<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
</ol></code>
 </body>
</html>
