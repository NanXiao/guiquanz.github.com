<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>lvm.c - src</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

code {
    font-family: consolas, monospace;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
  <h3>lvm.c - src</h3>
   <a href="../index.html"> Table of Contents </a>
 <h4>Functions defined</h4>
 <ul>
<li><a href="#L140">forlimit</a></li>
<li><a href="#L493">getcached</a></li>
<li><a href="#L240">l_strcmp</a></li>
<li><a href="#L361">luaV_concat</a></li>
<li><a href="#L435">luaV_div</a></li>
<li><a href="#L305">luaV_equalobj</a></li>
<li><a href="#L650">luaV_execute</a></li>
<li><a href="#L539">luaV_finishOp</a></li>
<li><a href="#L164">luaV_gettable</a></li>
<li><a href="#L284">luaV_lessequal</a></li>
<li><a href="#L266">luaV_lessthan</a></li>
<li><a href="#L455">luaV_mod</a></li>
<li><a href="#L404">luaV_objlen</a></li>
<li><a href="#L194">luaV_settable</a></li>
<li><a href="#L476">luaV_shiftl</a></li>
<li><a href="#L120">luaV_tointeger_</a></li>
<li><a href="#L69">luaV_tonumber_</a></li>
<li><a href="#L515">pushclosure</a></li>
<li><a href="#L51">tofloat</a></li>
<li><a href="#L91">tointeger_aux</a></li>
</ul>
 <h4>Macros defined</h4>
 <ul>
<li><a href="#L623">KBx</a></li>
<li><a href="#L8">LUA_CORE</a></li>
<li><a href="#L39">LUA_FLOORN2I</a></li>
<li><a href="#L44">MAXTAGLOOP</a></li>
<li><a href="#L471">NBITS</a></li>
<li><a href="#L637">Protect</a></li>
<li><a href="#L615">RA</a></li>
<li><a href="#L617">RB</a></li>
<li><a href="#L618">RC</a></li>
<li><a href="#L619">RKB</a></li>
<li><a href="#L621">RKC</a></li>
<li><a href="#L639">checkGC</a></li>
<li><a href="#L628">dojump</a></li>
<li><a href="#L634">donextjump</a></li>
<li><a href="#L611">luai_runtimecheck</a></li>
<li><a href="#L7">lvm_c</a></li>
<li><a href="#L354">tostring</a></li>
<li><a href="#L648">vmbreak</a></li>
<li><a href="#L647">vmcase</a></li>
<li><a href="#L646">vmdispatch</a></li>
</ul>
 <h4>Source code</h4>

  <code><ol><li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** $Id: lvm.c,v 2.232 2014/12/27 20:30:38 roberto Exp $<br/></li>
<li></span><span class="Comment">** Lua virtual machine<br/></li>
<li></span><span class="Comment">** See Copyright Notice in lua.h<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li></span><br/></li>
<li><a id="L7">&#x200c;</a><span class="PreProc">#define <span class="linkable">lvm_c</span><br/></li>
<li><a id="L8">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">LUA_CORE</span><br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;lprefix.h&quot;<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;limits.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;stdio.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;stdlib.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;string.h&gt;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;lua.h&quot;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;ldebug.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;ldo.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;lfunc.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;lgc.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;lobject.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;lopcodes.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;lstate.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;lstring.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;ltable.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;ltm.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;lvm.h&quot;<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** You can define <a href="#L39" title="lvm.c:39">LUA_FLOORN2I</a> if you want to convert floats to integers<br/></li>
<li></span><span class="Comment">** by flooring them (instead of raising an <a href="lundump.c.html#L40" title="lundump.c:40">error</a> if they are not<br/></li>
<li></span><span class="Comment">** integral values)<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li></span><span class="PreProc">#if !defined(<a href="#L39" title="lvm.c:39">LUA_FLOORN2I</a>)<br/></li>
<li><a id="L39">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">LUA_FLOORN2I</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">0<br/></li>
<li></span><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Comment">/* limit for table tag-method chains (to avoid loops) */<br/></li>
<li><a id="L44">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">MAXTAGLOOP</span>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">2000<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** Similar to '<a href="lvm.h.html#L30" title="lvm.h:30">tonumber</a>', but does not attempt to convert strings and<br/></li>
<li></span><span class="Comment">** ensure correct precision (no extra bits). Used in comparisons.<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L51">&#x200c;</a></span><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">tofloat</span> (<span class="Type">const</span> <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> *obj, <a href="lua.h.html#L87" title="lua.h:87">lua_Number</a> *n) {<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="lobject.h.html#L135" title="lobject.h:135">ttisfloat</a>(obj)) *n = <a href="lobject.h.html#L156" title="lobject.h:156">fltvalue</a>(obj);<br/></li>
<li>&nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (<a href="lobject.h.html#L136" title="lobject.h:136">ttisinteger</a>(obj)) {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">volatile</span> <a href="lua.h.html#L87" title="lua.h:87">lua_Number</a> x = <a href="llimits.h.html#L111" title="llimits.h:111">cast_num</a>(<a href="lobject.h.html#L155" title="lobject.h:155">ivalue</a>(obj));&nbsp; <span class="Comment">/* avoid extra precision */<br/></li>
<li></span>&nbsp; &nbsp; *n = x;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; *n = <span class="Constant">0</span>;&nbsp; <span class="Comment">/* to avoid warnings */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> <span class="Constant">1</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** Try to convert a value to a float. The float case is already handled<br/></li>
<li></span><span class="Comment">** by the macro '<a href="lvm.h.html#L30" title="lvm.h:30">tonumber</a>'.<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L69">&#x200c;</a></span><span class="Type">int</span> <span class="linkable">luaV_tonumber_</span> (<span class="Type">const</span> <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> *obj, <a href="lua.h.html#L87" title="lua.h:87">lua_Number</a> *n) {<br/></li>
<li>&nbsp; <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> v;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="lobject.h.html#L136" title="lobject.h:136">ttisinteger</a>(obj)) {<br/></li>
<li>&nbsp; &nbsp; *n = <a href="llimits.h.html#L111" title="llimits.h:111">cast_num</a>(<a href="lobject.h.html#L155" title="lobject.h:155">ivalue</a>(obj));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">1</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (<a href="lvm.h.html#L24" title="lvm.h:24">cvt2num</a>(obj) &amp;&amp;&nbsp; <span class="Comment">/* string convertible to number? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.c.html#L282" title="lobject.c:282">luaO_str2num</a>(<a href="lobject.h.html#L330" title="lobject.h:330">svalue</a>(obj), &amp;v) == <a href="lobject.h.html#L161" title="lobject.h:161">tsvalue</a>(obj)-&gt;len + <span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; *n = <a href="lobject.h.html#L157" title="lobject.h:157">nvalue</a>(&amp;v);&nbsp; <span class="Comment">/* convert result of '<a href="lobject.c.html#L282" title="lobject.c:282">luaO_str2num</a>' to a float */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">1</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;&nbsp; <span class="Comment">/* conversion failed */<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** try to convert a value to an integer, rounding according to 'mode':<br/></li>
<li></span><span class="Comment">** mode == 0: accepts only integral values<br/></li>
<li></span><span class="Comment">** mode == 1: takes the floor of the number<br/></li>
<li></span><span class="Comment">** mode == 2: takes the ceil of the number<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L91">&#x200c;</a></span><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">tointeger_aux</span> (<span class="Type">const</span> <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> *obj, <a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a> *p, <span class="Type">int</span> mode) {<br/></li>
<li>&nbsp; <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> v;<br/></li>
<li><span class="cUserCont"> </span><span class="Statement">again</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (<a href="lobject.h.html#L135" title="lobject.h:135">ttisfloat</a>(obj)) {<br/></li>
<li>&nbsp; &nbsp; <a href="lua.h.html#L87" title="lua.h:87">lua_Number</a> n = <a href="lobject.h.html#L156" title="lobject.h:156">fltvalue</a>(obj);<br/></li>
<li>&nbsp; &nbsp; <a href="lua.h.html#L87" title="lua.h:87">lua_Number</a> f = <a href="luaconf.h.html#L450" title="luaconf.h:450">l_floor</a>(n);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (n != f) {&nbsp; <span class="Comment">/* not an integral value? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (mode == <span class="Constant">0</span>) <span class="Statement">return</span> <span class="Constant">0</span>;&nbsp; <span class="Comment">/* fails if mode demands integral value */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (mode &gt; <span class="Constant">1</span>)&nbsp; <span class="Comment">/* needs ceil? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; f += <span class="Constant">1</span>;&nbsp; <span class="Comment">/* convert floor to ceil (remember: n != f) */<br/></li>
<li></span>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="luaconf.h.html#L463" title="luaconf.h:463">lua_numbertointeger</a>(f, p);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (<a href="lobject.h.html#L136" title="lobject.h:136">ttisinteger</a>(obj)) {<br/></li>
<li>&nbsp; &nbsp; *p = <a href="lobject.h.html#L155" title="lobject.h:155">ivalue</a>(obj);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">1</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (<a href="lvm.h.html#L24" title="lvm.h:24">cvt2num</a>(obj) &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.c.html#L282" title="lobject.c:282">luaO_str2num</a>(<a href="lobject.h.html#L330" title="lobject.h:330">svalue</a>(obj), &amp;v) == <a href="lobject.h.html#L161" title="lobject.h:161">tsvalue</a>(obj)-&gt;len + <span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; obj = &amp;v;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">goto</span> again;&nbsp; <span class="Comment">/* convert result from '<a href="lobject.c.html#L282" title="lobject.c:282">luaO_str2num</a>' to an integer */<br/></li>
<li></span>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;&nbsp; <span class="Comment">/* conversion failed */<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** try to convert a value to an integer<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L120">&#x200c;</a></span><span class="Type">int</span> <span class="linkable">luaV_tointeger_</span> (<span class="Type">const</span> <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> *obj, <a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a> *p) {<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="#L91" title="lvm.c:91">tointeger_aux</a>(obj, p, <a href="#L39" title="lvm.c:39">LUA_FLOORN2I</a>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** Try to convert a 'for' limit to an integer, preserving the<br/></li>
<li></span><span class="Comment">** semantics of the loop.<br/></li>
<li></span><span class="Comment">** (The following explanation assumes a non-negative step; it is valid<br/></li>
<li></span><span class="Comment">** for negative steps mutatis mutandis.)<br/></li>
<li></span><span class="Comment">** If the limit can be converted to an integer, rounding down, that is<br/></li>
<li></span><span class="Comment">** it.<br/></li>
<li></span><span class="Comment">** Otherwise, <a href="lparser.c.html#L106" title="lparser.c:106">check</a> whether the limit can be converted to a number.&nbsp; If<br/></li>
<li></span><span class="Comment">** the number is too large, it is OK to set the limit as <a href="luaconf.h.html#L546" title="luaconf.h:546">LUA_MAXINTEGER</a>,<br/></li>
<li></span><span class="Comment">** which means no limit.&nbsp; If the number is too negative, the loop<br/></li>
<li></span><span class="Comment">** should not run, because any initial integer value is larger than the<br/></li>
<li></span><span class="Comment">** limit. So, it sets the limit to <a href="luaconf.h.html#L547" title="luaconf.h:547">LUA_MININTEGER</a>. 'stopnow' corrects<br/></li>
<li></span><span class="Comment">** the extreme case when the initial value is <a href="luaconf.h.html#L547" title="luaconf.h:547">LUA_MININTEGER</a>, in which<br/></li>
<li></span><span class="Comment">** case the <a href="luaconf.h.html#L547" title="luaconf.h:547">LUA_MININTEGER</a> limit would still run the loop once.<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L140">&#x200c;</a></span><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">forlimit</span> (<span class="Type">const</span> <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> *obj, <a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a> *p, <a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a> step,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type">int</span> *stopnow) {<br/></li>
<li>&nbsp; *stopnow = <span class="Constant">0</span>;&nbsp; <span class="Comment">/* usually, let loops run */<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (!<a href="#L91" title="lvm.c:91">tointeger_aux</a>(obj, p, (step &lt; <span class="Constant">0</span> ? <span class="Constant">2</span> : <span class="Constant">1</span>))) {&nbsp; <span class="Comment">/* not fit in integer? */<br/></li>
<li></span>&nbsp; &nbsp; <a href="lua.h.html#L87" title="lua.h:87">lua_Number</a> n;&nbsp; <span class="Comment">/* try to convert to float */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (!<a href="lvm.h.html#L30" title="lvm.h:30">tonumber</a>(obj, &amp;n)) <span class="Comment">/* <a href="luac.c.html#L44" title="luac.c:44">cannot</a> convert to float? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;&nbsp; <span class="Comment">/* not a number */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (n &gt; <span class="Constant">0</span>) {&nbsp; <span class="Comment">/* if true, float is larger than max integer */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; *p = <a href="luaconf.h.html#L546" title="luaconf.h:546">LUA_MAXINTEGER</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (step &lt; <span class="Constant">0</span>) *stopnow = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else</span> {&nbsp; <span class="Comment">/* float is smaller than min integer */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; *p = <a href="luaconf.h.html#L547" title="luaconf.h:547">LUA_MININTEGER</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (step &gt;= <span class="Constant">0</span>) *stopnow = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> <span class="Constant">1</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** Main function for table access (invoking metamethods if needed).<br/></li>
<li></span><span class="Comment">** Compute 'val = t[key]'<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L164">&#x200c;</a></span><span class="Type">void</span> <span class="linkable">luaV_gettable</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">const</span> <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> *t, <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> *key, <a href="lobject.h.html#L294" title="lobject.h:294">StkId</a> val) {<br/></li>
<li>&nbsp; <span class="Type">int</span> loop;&nbsp; <span class="Comment">/* counter to avoid infinite loops */<br/></li>
<li></span>&nbsp; <span class="Statement">for</span> (loop = <span class="Constant">0</span>; loop &lt; <a href="#L44" title="lvm.c:44">MAXTAGLOOP</a>; loop++) {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> *tm;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="lobject.h.html#L143" title="lobject.h:143">ttistable</a>(t)) {&nbsp; <span class="Comment">/* 't' is a table? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L488" title="lobject.h:488">Table</a> *h = <a href="lobject.h.html#L167" title="lobject.h:167">hvalue</a>(t);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Type">const</span> <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> *res = <a href="ltable.c.html#L540" title="ltable.c:540">luaH_get</a>(h, key); <span class="Comment">/* do a primitive get */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!<a href="lobject.h.html#L137" title="lobject.h:137">ttisnil</a>(res) ||&nbsp; <span class="Comment">/* result is not nil? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (tm = <a href="ltm.h.html#L51" title="ltm.h:51">fasttm</a>(L, h-&gt;metatable, TM_INDEX)) == <span class="Constant">NULL</span>) { <span class="Comment">/* or no TM? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L257" title="lobject.h:257">setobj2s</a>(L, val, res);&nbsp; <span class="Comment">/* result is the raw get */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Comment">/* else will try metamethod */<br/></li>
<li></span>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (<a href="lobject.h.html#L137" title="lobject.h:137">ttisnil</a>(tm = <a href="ltm.c.html#L70" title="ltm.c:70">luaT_gettmbyobj</a>(L, t, TM_INDEX)))<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="ldebug.c.html#L533" title="ldebug.c:533">luaG_typeerror</a>(L, t, <span class="Constant">&quot;index&quot;</span>);&nbsp; <span class="Comment">/* no metamethod */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="lobject.h.html#L144" title="lobject.h:144">ttisfunction</a>(tm)) {&nbsp; <span class="Comment">/* metamethod is a function */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <a href="ltm.c.html#L86" title="ltm.c:86">luaT_callTM</a>(L, tm, t, key, val, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; t = tm;&nbsp; <span class="Comment">/* else repeat access over 'tm' */<br/></li>
<li></span>&nbsp; }<br/></li>
<li>&nbsp; <a href="ldebug.c.html#L603" title="ldebug.c:603">luaG_runerror</a>(L, <span class="Constant">&quot;gettable chain too long; possible loop&quot;</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** Main function for table <a href="lparser.c.html#L1141" title="lparser.c:1141">assignment</a> (invoking metamethods if needed).<br/></li>
<li></span><span class="Comment">** Compute 't[key] = val'<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L194">&#x200c;</a></span><span class="Type">void</span> <span class="linkable">luaV_settable</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">const</span> <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> *t, <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> *key, <a href="lobject.h.html#L294" title="lobject.h:294">StkId</a> val) {<br/></li>
<li>&nbsp; <span class="Type">int</span> loop;&nbsp; <span class="Comment">/* counter to avoid infinite loops */<br/></li>
<li></span>&nbsp; <span class="Statement">for</span> (loop = <span class="Constant">0</span>; loop &lt; <a href="#L44" title="lvm.c:44">MAXTAGLOOP</a>; loop++) {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> *tm;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="lobject.h.html#L143" title="lobject.h:143">ttistable</a>(t)) {&nbsp; <span class="Comment">/* 't' is a table? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L488" title="lobject.h:488">Table</a> *h = <a href="lobject.h.html#L167" title="lobject.h:167">hvalue</a>(t);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> *oldval = <a href="llimits.h.html#L107" title="llimits.h:107">cast</a>(<a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> *, <a href="ltable.c.html#L540" title="ltable.c:540">luaH_get</a>(h, key));<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Comment">/* if previous value is not nil, there must be a previous entry<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; in the table; a metamethod has no relevance */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!<a href="lobject.h.html#L137" title="lobject.h:137">ttisnil</a>(oldval) ||<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">/* previous value is nil; must <a href="lparser.c.html#L106" title="lparser.c:106">check</a> the metamethod */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ((tm = <a href="ltm.h.html#L51" title="ltm.h:51">fasttm</a>(L, h-&gt;metatable, TM_NEWINDEX)) == <span class="Constant">NULL</span> &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">/* no metamethod; is there a previous entry in the table? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (oldval != <a href="lobject.h.html#L516" title="lobject.h:516">luaO_nilobject</a> ||<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">/* no previous entry; must create one. (The <a href="llex.c.html#L31" title="llex.c:31">next</a> test is<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; always true; we only need the <a href="lparser.c.html#L1141" title="lparser.c:1141">assignment</a>.) */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (oldval = <a href="ltable.c.html#L441" title="ltable.c:441">luaH_newkey</a>(L, h, key), <span class="Constant">1</span>)))) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* no metamethod and (now) there is an entry with given key */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L264" title="lobject.h:264">setobj2t</a>(L, oldval, val);&nbsp; <span class="Comment">/* assign new value to that entry */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ltable.h.html#L23" title="ltable.h:23">invalidateTMcache</a>(h);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lgc.h.html#L113" title="lgc.h:113">luaC_barrierback</a>(L, h, val);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Comment">/* else will try the metamethod */<br/></li>
<li></span>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else</span>&nbsp; <span class="Comment">/* not a table; <a href="lparser.c.html#L106" title="lparser.c:106">check</a> metamethod */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="lobject.h.html#L137" title="lobject.h:137">ttisnil</a>(tm = <a href="ltm.c.html#L70" title="ltm.c:70">luaT_gettmbyobj</a>(L, t, TM_NEWINDEX)))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ldebug.c.html#L533" title="ldebug.c:533">luaG_typeerror</a>(L, t, <span class="Constant">&quot;index&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* try the metamethod */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="lobject.h.html#L144" title="lobject.h:144">ttisfunction</a>(tm)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="ltm.c.html#L86" title="ltm.c:86">luaT_callTM</a>(L, tm, t, key, val, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; t = tm;&nbsp; <span class="Comment">/* else repeat <a href="lparser.c.html#L1141" title="lparser.c:1141">assignment</a> over 'tm' */<br/></li>
<li></span>&nbsp; }<br/></li>
<li>&nbsp; <a href="ldebug.c.html#L603" title="ldebug.c:603">luaG_runerror</a>(L, <span class="Constant">&quot;settable chain too long; possible loop&quot;</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** Compare two strings 'ls' x 'rs', returning an integer smaller-equal-<br/></li>
<li></span><span class="Comment">** -larger than zero if 'ls' is smaller-equal-larger than 'rs'.<br/></li>
<li></span><span class="Comment">** The code is a little tricky because it allows '\0' in the strings<br/></li>
<li></span><span class="Comment">** and it uses 'strcoll' (to respect locales) for each segments<br/></li>
<li></span><span class="Comment">** of the strings.<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L240">&#x200c;</a></span><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">l_strcmp</span> (<span class="Type">const</span> <a href="lobject.h.html#L303" title="lobject.h:303">TString</a> *ls, <span class="Type">const</span> <a href="lobject.h.html#L303" title="lobject.h:303">TString</a> *rs) {<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">char</span> *l = <a href="lobject.h.html#L326" title="lobject.h:326">getstr</a>(ls);<br/></li>
<li>&nbsp; <span class="Type">size_t</span> ll = ls-&gt;len;<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">char</span> *r = <a href="lobject.h.html#L326" title="lobject.h:326">getstr</a>(rs);<br/></li>
<li>&nbsp; <span class="Type">size_t</span> lr = rs-&gt;len;<br/></li>
<li>&nbsp; <span class="Statement">for</span> (;;) {&nbsp; <span class="Comment">/* for each segment */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">int</span> temp = strcoll(l, r);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (temp != <span class="Constant">0</span>)&nbsp; <span class="Comment">/* not equal? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span> temp;&nbsp; <span class="Comment">/* done */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">else</span> {&nbsp; <span class="Comment">/* strings are equal up to a '\0' */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Type">size_t</span> len = strlen(l);&nbsp; <span class="Comment">/* index of first '\0' in both strings */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (len == lr)&nbsp; <span class="Comment">/* 'rs' is finished? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> (len == ll) ? <span class="Constant">0</span> : <span class="Constant">1</span>;&nbsp; <span class="Comment">/* <a href="lparser.c.html#L106" title="lparser.c:106">check</a> 'ls' */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (len == ll)&nbsp; <span class="Comment">/* 'ls' is finished? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant">1</span>;&nbsp; <span class="Comment">/* 'ls' is smaller than 'rs' ('rs' is not finished) */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Comment">/* both strings longer than 'len'; go on comparing after the '\0' */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; len++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; l += len; ll -= len; r += len; lr -= len;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** Main operation less than; return 'l &lt; r'.<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L266">&#x200c;</a></span><span class="Type">int</span> <span class="linkable">luaV_lessthan</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">const</span> <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> *l, <span class="Type">const</span> <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> *r) {<br/></li>
<li>&nbsp; <span class="Type">int</span> res;<br/></li>
<li>&nbsp; <a href="lua.h.html#L87" title="lua.h:87">lua_Number</a> nl, nr;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="lobject.h.html#L136" title="lobject.h:136">ttisinteger</a>(l) &amp;&amp; <a href="lobject.h.html#L136" title="lobject.h:136">ttisinteger</a>(r))&nbsp; <span class="Comment">/* both operands are integers? */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">return</span> (<a href="lobject.h.html#L155" title="lobject.h:155">ivalue</a>(l) &lt; <a href="lobject.h.html#L155" title="lobject.h:155">ivalue</a>(r));<br/></li>
<li>&nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (<a href="#L51" title="lvm.c:51">tofloat</a>(l, &amp;nl) &amp;&amp; <a href="#L51" title="lvm.c:51">tofloat</a>(r, &amp;nr))&nbsp; <span class="Comment">/* both are numbers? */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">return</span> <a href="luaconf.h.html#L504" title="luaconf.h:504">luai_numlt</a>(nl, nr);<br/></li>
<li>&nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (<a href="lobject.h.html#L140" title="lobject.h:140">ttisstring</a>(l) &amp;&amp; <a href="lobject.h.html#L140" title="lobject.h:140">ttisstring</a>(r))&nbsp; <span class="Comment">/* both are strings? */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L240" title="lvm.c:240">l_strcmp</a>(<a href="lobject.h.html#L161" title="lobject.h:161">tsvalue</a>(l), <a href="lobject.h.html#L161" title="lobject.h:161">tsvalue</a>(r)) &lt; <span class="Constant">0</span>;<br/></li>
<li>&nbsp; <span class="Statement">else</span> <span class="Statement">if</span> ((res = <a href="ltm.c.html#L136" title="ltm.c:136">luaT_callorderTM</a>(L, l, r, TM_LT)) &lt; <span class="Constant">0</span>)&nbsp; <span class="Comment">/* no metamethod? */<br/></li>
<li></span>&nbsp; &nbsp; <a href="ldebug.c.html#L565" title="ldebug.c:565">luaG_ordererror</a>(L, l, r);&nbsp; <span class="Comment">/* <a href="lundump.c.html#L40" title="lundump.c:40">error</a> */<br/></li>
<li></span>&nbsp; <span class="Statement">return</span> res;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** Main operation less than or equal to; return 'l &lt;= r'.<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L284">&#x200c;</a></span><span class="Type">int</span> <span class="linkable">luaV_lessequal</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">const</span> <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> *l, <span class="Type">const</span> <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> *r) {<br/></li>
<li>&nbsp; <span class="Type">int</span> res;<br/></li>
<li>&nbsp; <a href="lua.h.html#L87" title="lua.h:87">lua_Number</a> nl, nr;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="lobject.h.html#L136" title="lobject.h:136">ttisinteger</a>(l) &amp;&amp; <a href="lobject.h.html#L136" title="lobject.h:136">ttisinteger</a>(r))&nbsp; <span class="Comment">/* both operands are integers? */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">return</span> (<a href="lobject.h.html#L155" title="lobject.h:155">ivalue</a>(l) &lt;= <a href="lobject.h.html#L155" title="lobject.h:155">ivalue</a>(r));<br/></li>
<li>&nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (<a href="#L51" title="lvm.c:51">tofloat</a>(l, &amp;nl) &amp;&amp; <a href="#L51" title="lvm.c:51">tofloat</a>(r, &amp;nr))&nbsp; <span class="Comment">/* both are numbers? */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">return</span> <a href="luaconf.h.html#L505" title="luaconf.h:505">luai_numle</a>(nl, nr);<br/></li>
<li>&nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (<a href="lobject.h.html#L140" title="lobject.h:140">ttisstring</a>(l) &amp;&amp; <a href="lobject.h.html#L140" title="lobject.h:140">ttisstring</a>(r))&nbsp; <span class="Comment">/* both are strings? */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L240" title="lvm.c:240">l_strcmp</a>(<a href="lobject.h.html#L161" title="lobject.h:161">tsvalue</a>(l), <a href="lobject.h.html#L161" title="lobject.h:161">tsvalue</a>(r)) &lt;= <span class="Constant">0</span>;<br/></li>
<li>&nbsp; <span class="Statement">else</span> <span class="Statement">if</span> ((res = <a href="ltm.c.html#L136" title="ltm.c:136">luaT_callorderTM</a>(L, l, r, TM_LE)) &gt;= <span class="Constant">0</span>)&nbsp; <span class="Comment">/* first try 'le' */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">return</span> res;<br/></li>
<li>&nbsp; <span class="Statement">else</span> <span class="Statement">if</span> ((res = <a href="ltm.c.html#L136" title="ltm.c:136">luaT_callorderTM</a>(L, r, l, TM_LT)) &lt; <span class="Constant">0</span>)&nbsp; <span class="Comment">/* else try 'lt' */<br/></li>
<li></span>&nbsp; &nbsp; <a href="ldebug.c.html#L565" title="ldebug.c:565">luaG_ordererror</a>(L, l, r);<br/></li>
<li>&nbsp; <span class="Statement">return</span> !res;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** Main operation for equality of Lua values; return 't1 == t2'.<br/></li>
<li></span><span class="Comment">** L == NULL means raw equality (no metamethods)<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L305">&#x200c;</a></span><span class="Type">int</span> <span class="linkable">luaV_equalobj</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">const</span> <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> *t1, <span class="Type">const</span> <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> *t2) {<br/></li>
<li>&nbsp; <span class="Type">const</span> <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> *tm;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="lobject.h.html#L125" title="lobject.h:125">ttype</a>(t1) != <a href="lobject.h.html#L125" title="lobject.h:125">ttype</a>(t2)) {&nbsp; <span class="Comment">/* not the same variant? */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="lobject.h.html#L128" title="lobject.h:128">ttnov</a>(t1) != <a href="lobject.h.html#L128" title="lobject.h:128">ttnov</a>(t2) || <a href="lobject.h.html#L128" title="lobject.h:128">ttnov</a>(t1) != <a href="lua.h.html#L65" title="lua.h:65">LUA_TNUMBER</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;&nbsp; <span class="Comment">/* only numbers can be equal with different variants */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">else</span> {&nbsp; <span class="Comment">/* two numbers with different variants */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <a href="lua.h.html#L87" title="lua.h:87">lua_Number</a> n1, n2;&nbsp; <span class="Comment">/* compare them as floats */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <a href="lualib.h.html#L54" title="lualib.h:54">lua_assert</a>(<a href="lobject.h.html#L134" title="lobject.h:134">ttisnumber</a>(t1) &amp;&amp; <a href="lobject.h.html#L134" title="lobject.h:134">ttisnumber</a>(t2));<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="llimits.h.html#L109" title="llimits.h:109">cast_void</a>(<a href="#L51" title="lvm.c:51">tofloat</a>(t1, &amp;n1)); <a href="llimits.h.html#L109" title="llimits.h:109">cast_void</a>(<a href="#L51" title="lvm.c:51">tofloat</a>(t2, &amp;n2));<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="luaconf.h.html#L503" title="luaconf.h:503">luai_numeq</a>(n1, n2);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Comment">/* values have same type and same variant */<br/></li>
<li></span>&nbsp; <span class="Statement">switch</span> (<a href="lobject.h.html#L125" title="lobject.h:125">ttype</a>(t1)) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="lua.h.html#L62" title="lua.h:62">LUA_TNIL</a>: <span class="Statement">return</span> <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="lobject.h.html#L61" title="lobject.h:61">LUA_TNUMINT</a>: <span class="Statement">return</span> (<a href="lobject.h.html#L155" title="lobject.h:155">ivalue</a>(t1) == <a href="lobject.h.html#L155" title="lobject.h:155">ivalue</a>(t2));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="lobject.h.html#L60" title="lobject.h:60">LUA_TNUMFLT</a>: <span class="Statement">return</span> <a href="luaconf.h.html#L503" title="luaconf.h:503">luai_numeq</a>(<a href="lobject.h.html#L156" title="lobject.h:156">fltvalue</a>(t1), <a href="lobject.h.html#L156" title="lobject.h:156">fltvalue</a>(t2));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="lua.h.html#L63" title="lua.h:63">LUA_TBOOLEAN</a>: <span class="Statement">return</span> <a href="lobject.h.html#L168" title="lobject.h:168">bvalue</a>(t1) == <a href="lobject.h.html#L168" title="lobject.h:168">bvalue</a>(t2);&nbsp; <span class="Comment">/* true must be 1 !! */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">case</span> <a href="lua.h.html#L64" title="lua.h:64">LUA_TLIGHTUSERDATA</a>: <span class="Statement">return</span> <a href="lobject.h.html#L160" title="lobject.h:160">pvalue</a>(t1) == <a href="lobject.h.html#L160" title="lobject.h:160">pvalue</a>(t2);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="lobject.h.html#L50" title="lobject.h:50">LUA_TLCF</a>: <span class="Statement">return</span> <a href="lobject.h.html#L166" title="lobject.h:166">fvalue</a>(t1) == <a href="lobject.h.html#L166" title="lobject.h:166">fvalue</a>(t2);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="lobject.h.html#L55" title="lobject.h:55">LUA_TSHRSTR</a>: <span class="Statement">return</span> <a href="lstring.h.html#L34" title="lstring.h:34">eqshrstr</a>(<a href="lobject.h.html#L161" title="lobject.h:161">tsvalue</a>(t1), <a href="lobject.h.html#L161" title="lobject.h:161">tsvalue</a>(t2));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="lobject.h.html#L56" title="lobject.h:56">LUA_TLNGSTR</a>: <span class="Statement">return</span> <a href="lstring.c.html#L38" title="lstring.c:38">luaS_eqlngstr</a>(<a href="lobject.h.html#L161" title="lobject.h:161">tsvalue</a>(t1), <a href="lobject.h.html#L161" title="lobject.h:161">tsvalue</a>(t2));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="lua.h.html#L69" title="lua.h:69">LUA_TUSERDATA</a>: {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="lobject.h.html#L162" title="lobject.h:162">uvalue</a>(t1) == <a href="lobject.h.html#L162" title="lobject.h:162">uvalue</a>(t2)) <span class="Statement">return</span> <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (L == <span class="Constant">NULL</span>) <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; tm = <a href="ltm.h.html#L51" title="ltm.h:51">fasttm</a>(L, <a href="lobject.h.html#L162" title="lobject.h:162">uvalue</a>(t1)-&gt;metatable, TM_EQ);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (tm == <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; tm = <a href="ltm.h.html#L51" title="ltm.h:51">fasttm</a>(L, <a href="lobject.h.html#L162" title="lobject.h:162">uvalue</a>(t2)-&gt;metatable, TM_EQ);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;&nbsp; <span class="Comment">/* will try TM */<br/></li>
<li></span>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="lua.h.html#L67" title="lua.h:67">LUA_TTABLE</a>: {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="lobject.h.html#L167" title="lobject.h:167">hvalue</a>(t1) == <a href="lobject.h.html#L167" title="lobject.h:167">hvalue</a>(t2)) <span class="Statement">return</span> <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (L == <span class="Constant">NULL</span>) <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; tm = <a href="ltm.h.html#L51" title="ltm.h:51">fasttm</a>(L, <a href="lobject.h.html#L167" title="lobject.h:167">hvalue</a>(t1)-&gt;metatable, TM_EQ);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (tm == <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; tm = <a href="ltm.h.html#L51" title="ltm.h:51">fasttm</a>(L, <a href="lobject.h.html#L167" title="lobject.h:167">hvalue</a>(t2)-&gt;metatable, TM_EQ);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;&nbsp; <span class="Comment">/* will try TM */<br/></li>
<li></span>&nbsp; &nbsp; }<br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="lobject.h.html#L159" title="lobject.h:159">gcvalue</a>(t1) == <a href="lobject.h.html#L159" title="lobject.h:159">gcvalue</a>(t2);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">if</span> (tm == <span class="Constant">NULL</span>)&nbsp; <span class="Comment">/* no TM? */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;&nbsp; <span class="Comment">/* objects are different */<br/></li>
<li></span>&nbsp; <a href="ltm.c.html#L86" title="ltm.c:86">luaT_callTM</a>(L, tm, t1, t2, L-&gt;top, <span class="Constant">1</span>);&nbsp; <span class="Comment">/* call TM */<br/></li>
<li></span>&nbsp; <span class="Statement">return</span> !<a href="lobject.h.html#L173" title="lobject.h:173">l_isfalse</a>(L-&gt;top);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/* macro used by '<a href="#L361" title="lvm.c:361">luaV_concat</a>' to ensure that element at 'o' is a string */<br/></li>
<li><a id="L354">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">tostring</span>(L,o)&nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; &nbsp; &nbsp; (<a href="lobject.h.html#L140" title="lobject.h:140">ttisstring</a>(o) || (<a href="lvm.h.html#L17" title="lvm.h:17">cvt2str</a>(o) &amp;&amp; (<a href="lobject.c.html#L322" title="lobject.c:322">luaO_tostring</a>(L, o), </span><span class="Constant">1</span><span class="PreProc">)))<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** Main operation for concatenation: concat 'total' values in the stack,<br/></li>
<li></span><span class="Comment">** from 'L-&gt;top - total' up to 'L-&gt;top - 1'.<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L361">&#x200c;</a></span><span class="Type">void</span> <span class="linkable">luaV_concat</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">int</span> total) {<br/></li>
<li>&nbsp; <a href="lualib.h.html#L54" title="lualib.h:54">lua_assert</a>(total &gt;= <span class="Constant">2</span>);<br/></li>
<li>&nbsp; <span class="Statement">do</span> {<br/></li>
<li>&nbsp; &nbsp; <a href="lobject.h.html#L294" title="lobject.h:294">StkId</a> top = L-&gt;top;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span> n = <span class="Constant">2</span>;&nbsp; <span class="Comment">/* number of elements handled in this pass (at least 2) */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (!(<a href="lobject.h.html#L140" title="lobject.h:140">ttisstring</a>(top-<span class="Constant">2</span>) || <a href="lvm.h.html#L17" title="lvm.h:17">cvt2str</a>(top-<span class="Constant">2</span>)) || !<a href="#L354" title="lvm.c:354">tostring</a>(L, top-<span class="Constant">1</span>))<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="ltm.c.html#L114" title="ltm.c:114">luaT_trybinTM</a>(L, top-<span class="Constant">2</span>, top-<span class="Constant">1</span>, top-<span class="Constant">2</span>, TM_CONCAT);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (<a href="lobject.h.html#L161" title="lobject.h:161">tsvalue</a>(top-<span class="Constant">1</span>)-&gt;len == <span class="Constant">0</span>)&nbsp; <span class="Comment">/* second operand is empty? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <a href="llimits.h.html#L109" title="llimits.h:109">cast_void</a>(<a href="#L354" title="lvm.c:354">tostring</a>(L, top - <span class="Constant">2</span>));&nbsp; <span class="Comment">/* result is first operand */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (<a href="lobject.h.html#L140" title="lobject.h:140">ttisstring</a>(top-<span class="Constant">2</span>) &amp;&amp; <a href="lobject.h.html#L161" title="lobject.h:161">tsvalue</a>(top-<span class="Constant">2</span>)-&gt;len == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L255" title="lobject.h:255">setobjs2s</a>(L, top - <span class="Constant">2</span>, top - <span class="Constant">1</span>);&nbsp; <span class="Comment">/* result is second op. */<br/></li>
<li></span>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Comment">/* at least two non-empty string values; get as many as possible */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Type">size_t</span> tl = <a href="lobject.h.html#L161" title="lobject.h:161">tsvalue</a>(top-<span class="Constant">1</span>)-&gt;len;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Type">char</span> *buffer;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Type">int</span> i;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Comment">/* collect total length */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">1</span>; i &lt; total &amp;&amp; <a href="#L354" title="lvm.c:354">tostring</a>(L, top-i-<span class="Constant">1</span>); i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">size_t</span> l = <a href="lobject.h.html#L161" title="lobject.h:161">tsvalue</a>(top-i-<span class="Constant">1</span>)-&gt;len;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (l &gt;= (<a href="llimits.h.html#L42" title="llimits.h:42">MAX_SIZE</a>/<span class="Statement">sizeof</span>(<span class="Type">char</span>)) - tl)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ldebug.c.html#L603" title="ldebug.c:603">luaG_runerror</a>(L, <span class="Constant">&quot;string length overflow&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; tl += l;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; buffer = <a href="lzio.c.html#L70" title="lzio.c:70">luaZ_openspace</a>(L, &amp;<a href="lstate.h.html#L175" title="lstate.h:175">G</a>(L)-&gt;buff, tl);<br/></li>
<li>&nbsp; &nbsp; &nbsp; tl = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; n = i;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">do</span> {&nbsp; <span class="Comment">/* copy all strings to buffer */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">size_t</span> l = <a href="lobject.h.html#L161" title="lobject.h:161">tsvalue</a>(top-i)-&gt;len;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; memcpy(buffer+tl, <a href="lobject.h.html#L330" title="lobject.h:330">svalue</a>(top-i), l * <span class="Statement">sizeof</span>(<span class="Type">char</span>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; tl += l;<br/></li>
<li>&nbsp; &nbsp; &nbsp; } <span class="Statement">while</span> (--i &gt; <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L258" title="lobject.h:258">setsvalue2s</a>(L, top-n, <a href="lstring.c.html#L151" title="lstring.c:151">luaS_newlstr</a>(L, buffer, tl));&nbsp; <span class="Comment">/* create result */<br/></li>
<li></span>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; total -= n-<span class="Constant">1</span>;&nbsp; <span class="Comment">/* got 'n' strings to create 1 new */<br/></li>
<li></span>&nbsp; &nbsp; L-&gt;top -= n-<span class="Constant">1</span>;&nbsp; <span class="Comment">/* popped 'n' strings and pushed one */<br/></li>
<li></span>&nbsp; } <span class="Statement">while</span> (total &gt; <span class="Constant">1</span>);&nbsp; <span class="Comment">/* repeat until only 1 result left */<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** Main operation 'ra' = #rb'.<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L404">&#x200c;</a></span><span class="Type">void</span> <span class="linkable">luaV_objlen</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <a href="lobject.h.html#L294" title="lobject.h:294">StkId</a> ra, <span class="Type">const</span> <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> *rb) {<br/></li>
<li>&nbsp; <span class="Type">const</span> <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> *tm;<br/></li>
<li>&nbsp; <span class="Statement">switch</span> (<a href="lobject.h.html#L128" title="lobject.h:128">ttnov</a>(rb)) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="lua.h.html#L67" title="lua.h:67">LUA_TTABLE</a>: {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L488" title="lobject.h:488">Table</a> *h = <a href="lobject.h.html#L167" title="lobject.h:167">hvalue</a>(rb);<br/></li>
<li>&nbsp; &nbsp; &nbsp; tm = <a href="ltm.h.html#L51" title="ltm.h:51">fasttm</a>(L, h-&gt;metatable, TM_LEN);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (tm) <span class="Statement">break</span>;&nbsp; <span class="Comment">/* metamethod? break switch to call it */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L193" title="lobject.h:193">setivalue</a>(ra, <a href="ltable.c.html#L622" title="ltable.c:622">luaH_getn</a>(h));&nbsp; <span class="Comment">/* else primitive len */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="lua.h.html#L66" title="lua.h:66">LUA_TSTRING</a>: {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L193" title="lobject.h:193">setivalue</a>(ra, <a href="lobject.h.html#L161" title="lobject.h:161">tsvalue</a>(rb)-&gt;len);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:</span> {&nbsp; <span class="Comment">/* try metamethod */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; tm = <a href="ltm.c.html#L70" title="ltm.c:70">luaT_gettmbyobj</a>(L, rb, TM_LEN);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="lobject.h.html#L137" title="lobject.h:137">ttisnil</a>(tm))&nbsp; <span class="Comment">/* no metamethod? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ldebug.c.html#L533" title="ldebug.c:533">luaG_typeerror</a>(L, rb, <span class="Constant">&quot;get length of&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <a href="ltm.c.html#L86" title="ltm.c:86">luaT_callTM</a>(L, tm, rb, rb, ra, <span class="Constant">1</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** Integer division; return 'm // n', that is, floor(m/n).<br/></li>
<li></span><span class="Comment">** C division truncates its result (rounds towards zero).<br/></li>
<li></span><span class="Comment">** 'floor(q) == trunc(q)' when 'q &gt;= 0' or when 'q' is integer,<br/></li>
<li></span><span class="Comment">** otherwise 'floor(q) == trunc(q) - 1'.<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L435">&#x200c;</a></span><a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a> <span class="linkable">luaV_div</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a> m, <a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a> n) {<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="llimits.h.html#L118" title="llimits.h:118">l_castS2U</a>(n) + <span class="Constant">1u</span> &lt;= <span class="Constant">1u</span>) {&nbsp; <span class="Comment">/* special cases: -1 or 0 */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (n == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="ldebug.c.html#L603" title="ldebug.c:603">luaG_runerror</a>(L, <span class="Constant">&quot;attempt to divide by zero&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="lvm.h.html#L36" title="lvm.h:36">intop</a>(-, <span class="Constant">0</span>, m);&nbsp;&nbsp; <span class="Comment">/* n==-1; avoid overflow with 0x80000...//-1 */<br/></li>
<li></span>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; <a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a> q = m / n;&nbsp; <span class="Comment">/* perform C division */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> ((m ^ n) &lt; <span class="Constant">0</span> &amp;&amp; m % n != <span class="Constant">0</span>)&nbsp; <span class="Comment">/* 'm/n' would be negative non-integer? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; q -= <span class="Constant">1</span>;&nbsp; <span class="Comment">/* correct result for different rounding */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">return</span> q;<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** Integer modulus; return 'm % n'. (Assume that C '%' with<br/></li>
<li></span><span class="Comment">** negative operands follows C99 behavior. See previous comment<br/></li>
<li></span><span class="Comment">** about <a href="#L435" title="lvm.c:435">luaV_div</a>.)<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L455">&#x200c;</a></span><a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a> <span class="linkable">luaV_mod</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a> m, <a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a> n) {<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="llimits.h.html#L118" title="llimits.h:118">l_castS2U</a>(n) + <span class="Constant">1u</span> &lt;= <span class="Constant">1u</span>) {&nbsp; <span class="Comment">/* special cases: -1 or 0 */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (n == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="ldebug.c.html#L603" title="ldebug.c:603">luaG_runerror</a>(L, <span class="Constant">&quot;attempt to perform 'n</span><span class="Special">%%</span><span class="Constant">0'&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;&nbsp;&nbsp; <span class="Comment">/* m % -1 == 0; avoid overflow with 0x80000...%-1 */<br/></li>
<li></span>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; <a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a> r = m % n;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r != <span class="Constant">0</span> &amp;&amp; (m ^ n) &lt; <span class="Constant">0</span>)&nbsp; <span class="Comment">/* 'm/n' would be non-integer negative? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; r += n;&nbsp; <span class="Comment">/* correct result for different rounding */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">return</span> r;<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/* number of bits in an integer */<br/></li>
<li><a id="L471">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NBITS</span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="llimits.h.html#L112" title="llimits.h:112">cast_int</a>(</span><span class="Statement">sizeof</span><span class="PreProc">(<a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a>) * </span><span class="Constant">CHAR_BIT</span><span class="PreProc">)<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** Shift left operation. (Shift right just negates 'y'.)<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L476">&#x200c;</a></span><a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a> <span class="linkable">luaV_shiftl</span> (<a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a> x, <a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a> y) {<br/></li>
<li>&nbsp; <span class="Statement">if</span> (y &lt; <span class="Constant">0</span>) {&nbsp; <span class="Comment">/* shift right? */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (y &lt;= -<a href="#L471" title="lvm.c:471">NBITS</a>) <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">return</span> <a href="lvm.h.html#L36" title="lvm.h:36">intop</a>(&gt;&gt;, x, -y);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">else</span> {&nbsp; <span class="Comment">/* shift left */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (y &gt;= <a href="#L471" title="lvm.c:471">NBITS</a>) <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">return</span> <a href="lvm.h.html#L36" title="lvm.h:36">intop</a>(&lt;&lt;, x, y);<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** <a href="lparser.c.html#L106" title="lparser.c:106">check</a> whether cached closure in prototype 'p' may be reused, that is,<br/></li>
<li></span><span class="Comment">** whether there is a cached closure with the same upvalues needed by<br/></li>
<li></span><span class="Comment">** new closure to be created.<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L493">&#x200c;</a></span><span class="Type">static</span> <a href="lobject.h.html#L444" title="lobject.h:444">LClosure</a> *<span class="linkable">getcached</span> (<a href="lobject.h.html#L398" title="lobject.h:398">Proto</a> *p, <a href="lfunc.h.html#L28" title="lfunc.h:28">UpVal</a> **encup, <a href="lobject.h.html#L294" title="lobject.h:294">StkId</a> base) {<br/></li>
<li>&nbsp; <a href="lobject.h.html#L444" title="lobject.h:444">LClosure</a> *c = p-&gt;cache;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (c != <span class="Constant">NULL</span>) {&nbsp; <span class="Comment">/* is there a cached closure? */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">int</span> nup = p-&gt;sizeupvalues;<br/></li>
<li>&nbsp; &nbsp; <a href="lobject.h.html#L377" title="lobject.h:377">Upvaldesc</a> *uv = p-&gt;upvalues;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span> i;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; nup; i++) {&nbsp; <span class="Comment">/* <a href="lparser.c.html#L106" title="lparser.c:106">check</a> whether it has right upvalues */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> *v = uv[i].instack ? base + uv[i].idx : encup[uv[i].idx]-&gt;v;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;upvals[i]-&gt;v != v)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;&nbsp; <span class="Comment">/* wrong upvalue; <a href="luac.c.html#L44" title="luac.c:44">cannot</a> reuse closure */<br/></li>
<li></span>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> c;&nbsp; <span class="Comment">/* return cached closure (or NULL if no cached closure) */<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** create a new Lua closure, push it in the stack, and initialize<br/></li>
<li></span><span class="Comment">** its upvalues. Note that the closure is not cached if prototype is<br/></li>
<li></span><span class="Comment">** already black (which means that 'cache' was already cleared by the<br/></li>
<li></span><span class="Comment">** GC).<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L515">&#x200c;</a></span><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">pushclosure</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <a href="lobject.h.html#L398" title="lobject.h:398">Proto</a> *p, <a href="lfunc.h.html#L28" title="lfunc.h:28">UpVal</a> **encup, <a href="lobject.h.html#L294" title="lobject.h:294">StkId</a> base,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="lobject.h.html#L294" title="lobject.h:294">StkId</a> ra) {<br/></li>
<li>&nbsp; <span class="Type">int</span> nup = p-&gt;sizeupvalues;<br/></li>
<li>&nbsp; <a href="lobject.h.html#L377" title="lobject.h:377">Upvaldesc</a> *uv = p-&gt;upvalues;<br/></li>
<li>&nbsp; <span class="Type">int</span> i;<br/></li>
<li>&nbsp; <a href="lobject.h.html#L444" title="lobject.h:444">LClosure</a> *ncl = <a href="lfunc.c.html#L33" title="lfunc.c:33">luaF_newLclosure</a>(L, nup);<br/></li>
<li>&nbsp; ncl-&gt;p = p;<br/></li>
<li>&nbsp; <a href="lobject.h.html#L226" title="lobject.h:226">setclLvalue</a>(L, ra, ncl);&nbsp; <span class="Comment">/* anchor new closure in stack */<br/></li>
<li></span>&nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; nup; i++) {&nbsp; <span class="Comment">/* fill in its upvalues */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (uv[i].instack)&nbsp; <span class="Comment">/* upvalue refers to local variable? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; ncl-&gt;upvals[i] = <a href="lfunc.c.html#L57" title="lfunc.c:57">luaF_findupval</a>(L, base + uv[i].idx);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else</span>&nbsp; <span class="Comment">/* get upvalue from enclosing function */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; ncl-&gt;upvals[i] = encup[uv[i].idx];<br/></li>
<li>&nbsp; &nbsp; ncl-&gt;upvals[i]-&gt;refcount++;<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* new closure is white, so we do not need a barrier here */<br/></li>
<li></span>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">if</span> (!<a href="lgc.h.html#L88" title="lgc.h:88">isblack</a>(p))&nbsp; <span class="Comment">/* cache will not break GC invariant? */<br/></li>
<li></span>&nbsp; &nbsp; p-&gt;cache = ncl;&nbsp; <span class="Comment">/* <a href="llex.c.html#L56" title="llex.c:56">save</a> it on cache for reuse */<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** finish execution of an opcode interrupted by an yield<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L539">&#x200c;</a></span><span class="Type">void</span> <span class="linkable">luaV_finishOp</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <a href="lstate.h.html#L65" title="lstate.h:65">CallInfo</a> *ci = L-&gt;ci;<br/></li>
<li>&nbsp; <a href="lobject.h.html#L294" title="lobject.h:294">StkId</a> base = ci-&gt;u.l.base;<br/></li>
<li>&nbsp; <a href="llimits.h.html#L164" title="llimits.h:164">Instruction</a> inst = *(ci-&gt;u.l.savedpc - <span class="Constant">1</span>);&nbsp; <span class="Comment">/* interrupted instruction */<br/></li>
<li></span>&nbsp; <a href="lopcodes.h.html#L232" title="lopcodes.h:232">OpCode</a> op = <a href="lopcodes.h.html#L89" title="lopcodes.h:89">GET_OPCODE</a>(inst);<br/></li>
<li>&nbsp; <span class="Statement">switch</span> (op) {&nbsp; <span class="Comment">/* finish its execution */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">case</span> OP_ADD: <span class="Statement">case</span> OP_SUB: <span class="Statement">case</span> OP_MUL: <span class="Statement">case</span> OP_DIV: <span class="Statement">case</span> OP_IDIV:<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> OP_BAND: <span class="Statement">case</span> OP_BOR: <span class="Statement">case</span> OP_BXOR: <span class="Statement">case</span> OP_SHL: <span class="Statement">case</span> OP_SHR:<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> OP_MOD: <span class="Statement">case</span> OP_POW:<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> OP_UNM: <span class="Statement">case</span> OP_BNOT: <span class="Statement">case</span> OP_LEN:<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> OP_GETTABUP: <span class="Statement">case</span> OP_GETTABLE: <span class="Statement">case</span> OP_SELF: {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L255" title="lobject.h:255">setobjs2s</a>(L, base + <a href="lopcodes.h.html#L97" title="lopcodes.h:97">GETARG_A</a>(inst), --L-&gt;top);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> OP_LE: <span class="Statement">case</span> OP_LT: <span class="Statement">case</span> OP_EQ: {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Type">int</span> res = !<a href="lobject.h.html#L173" title="lobject.h:173">l_isfalse</a>(L-&gt;top - <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; L-&gt;top--;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Comment">/* metamethod should not be called when operand is K */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <a href="lualib.h.html#L54" title="lualib.h:54">lua_assert</a>(!<a href="lopcodes.h.html#L137" title="lopcodes.h:137">ISK</a>(<a href="lopcodes.h.html#L100" title="lopcodes.h:100">GETARG_B</a>(inst)));<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (op == OP_LE &amp;&amp;&nbsp; <span class="Comment">/* &quot;&lt;=&quot; using &quot;&lt;&quot; instead? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L137" title="lobject.h:137">ttisnil</a>(<a href="ltm.c.html#L70" title="ltm.c:70">luaT_gettmbyobj</a>(L, base + <a href="lopcodes.h.html#L100" title="lopcodes.h:100">GETARG_B</a>(inst), TM_LE)))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; res = !res;&nbsp; <span class="Comment">/* invert result */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <a href="lualib.h.html#L54" title="lualib.h:54">lua_assert</a>(<a href="lopcodes.h.html#L89" title="lopcodes.h:89">GET_OPCODE</a>(*ci-&gt;u.l.savedpc) == OP_JMP);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (res != <a href="lopcodes.h.html#L97" title="lopcodes.h:97">GETARG_A</a>(inst))&nbsp; <span class="Comment">/* condition failed? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; ci-&gt;u.l.savedpc++;&nbsp; <span class="Comment">/* skip jump instruction */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> OP_CONCAT: {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L294" title="lobject.h:294">StkId</a> top = L-&gt;top - <span class="Constant">1</span>;&nbsp; <span class="Comment">/* top when '<a href="ltm.c.html#L114" title="ltm.c:114">luaT_trybinTM</a>' was called */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Type">int</span> b = <a href="lopcodes.h.html#L100" title="lopcodes.h:100">GETARG_B</a>(inst);&nbsp; &nbsp; &nbsp; <span class="Comment">/* first element to concatenate */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Type">int</span> total = <a href="llimits.h.html#L112" title="llimits.h:112">cast_int</a>(top - <span class="Constant">1</span> - (base + b));&nbsp; <span class="Comment">/* yet to concatenate */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L257" title="lobject.h:257">setobj2s</a>(L, top - <span class="Constant">2</span>, top);&nbsp; <span class="Comment">/* put TM result in proper position */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (total &gt; <span class="Constant">1</span>) {&nbsp; <span class="Comment">/* are there elements to concat? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; L-&gt;top = top - <span class="Constant">1</span>;&nbsp; <span class="Comment">/* top is one after last element (at top-2) */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L361" title="lvm.c:361">luaV_concat</a>(L, total);&nbsp; <span class="Comment">/* concat them (may yield again) */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Comment">/* move final result to final position */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L257" title="lobject.h:257">setobj2s</a>(L, ci-&gt;u.l.base + <a href="lopcodes.h.html#L97" title="lopcodes.h:97">GETARG_A</a>(inst), L-&gt;top - <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; L-&gt;top = ci-&gt;top;&nbsp; <span class="Comment">/* restore top */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> OP_TFORCALL: {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="lualib.h.html#L54" title="lualib.h:54">lua_assert</a>(<a href="lopcodes.h.html#L89" title="lopcodes.h:89">GET_OPCODE</a>(*ci-&gt;u.l.savedpc) == OP_TFORLOOP);<br/></li>
<li>&nbsp; &nbsp; &nbsp; L-&gt;top = ci-&gt;top;&nbsp; <span class="Comment">/* correct top */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> OP_CALL: {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="lopcodes.h.html#L103" title="lopcodes.h:103">GETARG_C</a>(inst) - <span class="Constant">1</span> &gt;= <span class="Constant">0</span>)&nbsp; <span class="Comment">/* nresults &gt;= 0? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; L-&gt;top = ci-&gt;top;&nbsp; <span class="Comment">/* adjust results */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> OP_TAILCALL: <span class="Statement">case</span> OP_SETTABUP: <span class="Statement">case</span> OP_SETTABLE:<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:</span> <a href="lualib.h.html#L54" title="lualib.h:54">lua_assert</a>(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** {==================================================================<br/></li>
<li></span><span class="Comment">** Function '<a href="#L650" title="lvm.c:650">luaV_execute</a>': <a href="lua.c.html#L595" title="lua.c:595">main</a> interpreter loop<br/></li>
<li></span><span class="Comment">** ===================================================================<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** some macros for common tasks in '<a href="#L650" title="lvm.c:650">luaV_execute</a>'<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#if !defined <a href="#L611" title="lvm.c:611">luai_runtimecheck</a><br/></li>
<li><a id="L611">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">luai_runtimecheck</span>(L, c)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Comment">/* void */<br/></li>
<li></span><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><a id="L615">&#x200c;</a><span class="PreProc">#define <span class="linkable">RA</span>(i)&nbsp; &nbsp; &nbsp; &nbsp; (base+<a href="lopcodes.h.html#L97" title="lopcodes.h:97">GETARG_A</a>(i))<br/></li>
<li></span><span class="Comment">/* to be used after possible stack reallocation */<br/></li>
<li><a id="L617">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">RB</span>(i)&nbsp; &nbsp; &nbsp; &nbsp; <a href="llimits.h.html#L79" title="llimits.h:79">check_exp</a>(<a href="lopcodes.h.html#L282" title="lopcodes.h:282">getBMode</a>(<a href="lopcodes.h.html#L89" title="lopcodes.h:89">GET_OPCODE</a>(i)) == OpArgR, base+<a href="lopcodes.h.html#L100" title="lopcodes.h:100">GETARG_B</a>(i))<br/></li>
<li><a id="L618">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">RC</span>(i)&nbsp; &nbsp; &nbsp; &nbsp; <a href="llimits.h.html#L79" title="llimits.h:79">check_exp</a>(<a href="lopcodes.h.html#L283" title="lopcodes.h:283">getCMode</a>(<a href="lopcodes.h.html#L89" title="lopcodes.h:89">GET_OPCODE</a>(i)) == OpArgR, base+<a href="lopcodes.h.html#L103" title="lopcodes.h:103">GETARG_C</a>(i))<br/></li>
<li><a id="L619">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">RKB</span>(i)&nbsp; &nbsp; &nbsp; &nbsp; <a href="llimits.h.html#L79" title="llimits.h:79">check_exp</a>(<a href="lopcodes.h.html#L282" title="lopcodes.h:282">getBMode</a>(<a href="lopcodes.h.html#L89" title="lopcodes.h:89">GET_OPCODE</a>(i)) == OpArgK, \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; &nbsp; &nbsp; <a href="lopcodes.h.html#L137" title="lopcodes.h:137">ISK</a>(<a href="lopcodes.h.html#L100" title="lopcodes.h:100">GETARG_B</a>(i)) ? k+<a href="lopcodes.h.html#L140" title="lopcodes.h:140">INDEXK</a>(<a href="lopcodes.h.html#L100" title="lopcodes.h:100">GETARG_B</a>(i)) : base+<a href="lopcodes.h.html#L100" title="lopcodes.h:100">GETARG_B</a>(i))<br/></li>
<li><a id="L621">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">RKC</span>(i)&nbsp; &nbsp; &nbsp; &nbsp; <a href="llimits.h.html#L79" title="llimits.h:79">check_exp</a>(<a href="lopcodes.h.html#L283" title="lopcodes.h:283">getCMode</a>(<a href="lopcodes.h.html#L89" title="lopcodes.h:89">GET_OPCODE</a>(i)) == OpArgK, \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; &nbsp; &nbsp; <a href="lopcodes.h.html#L137" title="lopcodes.h:137">ISK</a>(<a href="lopcodes.h.html#L103" title="lopcodes.h:103">GETARG_C</a>(i)) ? k+<a href="lopcodes.h.html#L140" title="lopcodes.h:140">INDEXK</a>(<a href="lopcodes.h.html#L103" title="lopcodes.h:103">GETARG_C</a>(i)) : base+<a href="lopcodes.h.html#L103" title="lopcodes.h:103">GETARG_C</a>(i))<br/></li>
<li><a id="L623">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">KBx</span>(i)&nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; (k + (<a href="lopcodes.h.html#L106" title="lopcodes.h:106">GETARG_Bx</a>(i) != </span><span class="Constant">0</span><span class="PreProc"> ? <a href="lopcodes.h.html#L106" title="lopcodes.h:106">GETARG_Bx</a>(i) - </span><span class="Constant">1</span><span class="PreProc"> : <a href="lopcodes.h.html#L109" title="lopcodes.h:109">GETARG_Ax</a>(*ci-&gt;u.l.savedpc++)))<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Comment">/* execute a jump instruction */<br/></li>
<li><a id="L628">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">dojump</span>(ci,i,e) \<br/></li>
<li></span><span class="PreProc">&nbsp; { </span><span class="Type">int</span><span class="PreProc"> a = <a href="lopcodes.h.html#L97" title="lopcodes.h:97">GETARG_A</a>(i); \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; </span><span class="Statement">if</span><span class="PreProc"> (a &gt; </span><span class="Constant">0</span><span class="PreProc">) <a href="lfunc.c.html#L83" title="lfunc.c:83">luaF_close</a>(L, ci-&gt;u.l.base + a - </span><span class="Constant">1</span><span class="PreProc">); \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; ci-&gt;u.l.savedpc += <a href="lopcodes.h.html#L112" title="lopcodes.h:112">GETARG_sBx</a>(i) + e; }<br/></li>
<li></span><br/></li>
<li><span class="Comment">/* for test instructions, execute the jump instruction that follows it */<br/></li>
<li><a id="L634">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">donextjump</span>(ci)&nbsp; &nbsp; &nbsp; &nbsp; { i = *ci-&gt;u.l.savedpc; <a href="#L628" title="lvm.c:628">dojump</a>(ci, i, </span><span class="Constant">1</span><span class="PreProc">); }<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><a id="L637">&#x200c;</a><span class="PreProc">#define <span class="linkable">Protect</span>(x)&nbsp; &nbsp; &nbsp; &nbsp; { {x;}; base = ci-&gt;u.l.base; }<br/></li>
<li></span><br/></li>
<li><a id="L639">&#x200c;</a><span class="PreProc">#define <span class="linkable">checkGC</span>(L,c)&nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; <a href="#L637" title="lvm.c:637">Protect</a>( <a href="lgc.h.html#L104" title="lgc.h:104">luaC_condGC</a>(L,</span><span class="Error">{</span><span class="PreProc">L-&gt;top = (c);&nbsp; </span><span class="Comment">/* limit of live values */</span><span class="PreProc"> \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lgc.c.html#L1109" title="lgc.c:1109">luaC_step</a>(L); \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; L-&gt;top = ci-&gt;top;</span><span class="Error">}</span><span class="PreProc">)&nbsp; </span><span class="Comment">/* restore top */</span><span class="PreProc"> \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="llimits.h.html#L190" title="llimits.h:190">luai_threadyield</a>(L); )<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><a id="L646">&#x200c;</a><span class="PreProc">#define <span class="linkable">vmdispatch</span>(o)&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">switch</span><span class="PreProc">(o)<br/></li>
<li><a id="L647">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">vmcase</span>(l)&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">case</span><span class="PreProc"> l:<br/></li>
<li><a id="L648">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">vmbreak</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">break<br/></li>
<li></span><br/></li>
<li><a id="L650">&#x200c;</a><span class="Type">void</span> <span class="linkable">luaV_execute</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <a href="lstate.h.html#L65" title="lstate.h:65">CallInfo</a> *ci = L-&gt;ci;<br/></li>
<li>&nbsp; <a href="lobject.h.html#L444" title="lobject.h:444">LClosure</a> *cl;<br/></li>
<li>&nbsp; <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> *k;<br/></li>
<li>&nbsp; <a href="lobject.h.html#L294" title="lobject.h:294">StkId</a> base;<br/></li>
<li><span class="cUserCont"> </span><span class="Statement">newframe</span><span class="cUserCont">:</span>&nbsp; <span class="Comment">/* reentry point when frame changes (call/return) */<br/></li>
<li></span>&nbsp; <a href="lualib.h.html#L54" title="lualib.h:54">lua_assert</a>(ci == L-&gt;ci);<br/></li>
<li>&nbsp; cl = <a href="lobject.h.html#L164" title="lobject.h:164">clLvalue</a>(ci-&gt;func);<br/></li>
<li>&nbsp; k = cl-&gt;p-&gt;k;<br/></li>
<li>&nbsp; base = ci-&gt;u.l.base;<br/></li>
<li>&nbsp; <span class="Comment">/* <a href="lua.c.html#L595" title="lua.c:595">main</a> loop of interpreter */<br/></li>
<li></span>&nbsp; <span class="Statement">for</span> (;;) {<br/></li>
<li>&nbsp; &nbsp; <a href="llimits.h.html#L164" title="llimits.h:164">Instruction</a> i = *(ci-&gt;u.l.savedpc++);<br/></li>
<li>&nbsp; &nbsp; <a href="lobject.h.html#L294" title="lobject.h:294">StkId</a> ra;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> ((L-&gt;hookmask &amp; (<a href="lua.h.html#L413" title="lua.h:413">LUA_MASKLINE</a> | <a href="lua.h.html#L414" title="lua.h:414">LUA_MASKCOUNT</a>)) &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; (--L-&gt;hookcount == <span class="Constant">0</span> || L-&gt;hookmask &amp; <a href="lua.h.html#L413" title="lua.h:413">LUA_MASKLINE</a>)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L637" title="lvm.c:637">Protect</a>(<a href="ldebug.c.html#L612" title="ldebug.c:612">luaG_traceexec</a>(L));<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* WARNING: several calls may realloc the stack and invalidate 'ra' */<br/></li>
<li></span>&nbsp; &nbsp; ra = <a href="#L615" title="lvm.c:615">RA</a>(i);<br/></li>
<li>&nbsp; &nbsp; <a href="lualib.h.html#L54" title="lualib.h:54">lua_assert</a>(base == ci-&gt;u.l.base);<br/></li>
<li>&nbsp; &nbsp; <a href="lualib.h.html#L54" title="lualib.h:54">lua_assert</a>(base &lt;= L-&gt;top &amp;&amp; L-&gt;top &lt; L-&gt;stack + L-&gt;stacksize);<br/></li>
<li>&nbsp; &nbsp; <a href="#L646" title="lvm.c:646">vmdispatch</a> (<a href="lopcodes.h.html#L89" title="lopcodes.h:89">GET_OPCODE</a>(i)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L647" title="lvm.c:647">vmcase</a>(OP_MOVE) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L255" title="lobject.h:255">setobjs2s</a>(L, ra, <a href="#L617" title="lvm.c:617">RB</a>(i));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L648" title="lvm.c:648">vmbreak</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L647" title="lvm.c:647">vmcase</a>(OP_LOADK) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> *rb = k + <a href="lopcodes.h.html#L106" title="lopcodes.h:106">GETARG_Bx</a>(i);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L257" title="lobject.h:257">setobj2s</a>(L, ra, rb);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L648" title="lvm.c:648">vmbreak</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L647" title="lvm.c:647">vmcase</a>(OP_LOADKX) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> *rb;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lualib.h.html#L54" title="lualib.h:54">lua_assert</a>(<a href="lopcodes.h.html#L89" title="lopcodes.h:89">GET_OPCODE</a>(*ci-&gt;u.l.savedpc) == OP_EXTRAARG);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rb = k + <a href="lopcodes.h.html#L109" title="lopcodes.h:109">GETARG_Ax</a>(*ci-&gt;u.l.savedpc++);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L257" title="lobject.h:257">setobj2s</a>(L, ra, rb);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L648" title="lvm.c:648">vmbreak</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L647" title="lvm.c:647">vmcase</a>(OP_LOADBOOL) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L204" title="lobject.h:204">setbvalue</a>(ra, <a href="lopcodes.h.html#L100" title="lopcodes.h:100">GETARG_B</a>(i));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="lopcodes.h.html#L103" title="lopcodes.h:103">GETARG_C</a>(i)) ci-&gt;u.l.savedpc++;&nbsp; <span class="Comment">/* skip <a href="llex.c.html#L31" title="llex.c:31">next</a> instruction (if C) */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L648" title="lvm.c:648">vmbreak</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L647" title="lvm.c:647">vmcase</a>(OP_LOADNIL) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> b = <a href="lopcodes.h.html#L100" title="lopcodes.h:100">GETARG_B</a>(i);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">do</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L196" title="lobject.h:196">setnilvalue</a>(ra++);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">while</span> (b--);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L648" title="lvm.c:648">vmbreak</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L647" title="lvm.c:647">vmcase</a>(OP_GETUPVAL) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> b = <a href="lopcodes.h.html#L100" title="lopcodes.h:100">GETARG_B</a>(i);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L257" title="lobject.h:257">setobj2s</a>(L, ra, cl-&gt;upvals[b]-&gt;v);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L648" title="lvm.c:648">vmbreak</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L647" title="lvm.c:647">vmcase</a>(OP_GETTABUP) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> b = <a href="lopcodes.h.html#L100" title="lopcodes.h:100">GETARG_B</a>(i);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L637" title="lvm.c:637">Protect</a>(<a href="#L164" title="lvm.c:164">luaV_gettable</a>(L, cl-&gt;upvals[b]-&gt;v, <a href="#L621" title="lvm.c:621">RKC</a>(i), ra));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L648" title="lvm.c:648">vmbreak</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L647" title="lvm.c:647">vmcase</a>(OP_GETTABLE) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L637" title="lvm.c:637">Protect</a>(<a href="#L164" title="lvm.c:164">luaV_gettable</a>(L, <a href="#L617" title="lvm.c:617">RB</a>(i), <a href="#L621" title="lvm.c:621">RKC</a>(i), ra));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L648" title="lvm.c:648">vmbreak</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L647" title="lvm.c:647">vmcase</a>(OP_SETTABUP) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> a = <a href="lopcodes.h.html#L97" title="lopcodes.h:97">GETARG_A</a>(i);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L637" title="lvm.c:637">Protect</a>(<a href="#L194" title="lvm.c:194">luaV_settable</a>(L, cl-&gt;upvals[a]-&gt;v, <a href="#L619" title="lvm.c:619">RKB</a>(i), <a href="#L621" title="lvm.c:621">RKC</a>(i)));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L648" title="lvm.c:648">vmbreak</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L647" title="lvm.c:647">vmcase</a>(OP_SETUPVAL) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lfunc.h.html#L28" title="lfunc.h:28">UpVal</a> *uv = cl-&gt;upvals[<a href="lopcodes.h.html#L100" title="lopcodes.h:100">GETARG_B</a>(i)];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L245" title="lobject.h:245">setobj</a>(L, uv-&gt;v, ra);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lgc.h.html#L121" title="lgc.h:121">luaC_upvalbarrier</a>(L, uv);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L648" title="lvm.c:648">vmbreak</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L647" title="lvm.c:647">vmcase</a>(OP_SETTABLE) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L637" title="lvm.c:637">Protect</a>(<a href="#L194" title="lvm.c:194">luaV_settable</a>(L, ra, <a href="#L619" title="lvm.c:619">RKB</a>(i), <a href="#L621" title="lvm.c:621">RKC</a>(i)));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L648" title="lvm.c:648">vmbreak</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L647" title="lvm.c:647">vmcase</a>(OP_NEWTABLE) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> b = <a href="lopcodes.h.html#L100" title="lopcodes.h:100">GETARG_B</a>(i);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> c = <a href="lopcodes.h.html#L103" title="lopcodes.h:103">GETARG_C</a>(i);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L488" title="lobject.h:488">Table</a> *t = <a href="ltable.c.html#L403" title="ltable.c:403">luaH_new</a>(L);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L236" title="lobject.h:236">sethvalue</a>(L, ra, t);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (b != <span class="Constant">0</span> || c != <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ltable.c.html#L335" title="ltable.c:335">luaH_resize</a>(L, t, <a href="lobject.c.html#L51" title="lobject.c:51">luaO_fb2int</a>(b), <a href="lobject.c.html#L51" title="lobject.c:51">luaO_fb2int</a>(c));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L639" title="lvm.c:639">checkGC</a>(L, ra + <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L648" title="lvm.c:648">vmbreak</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L647" title="lvm.c:647">vmcase</a>(OP_SELF) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L294" title="lobject.h:294">StkId</a> rb = <a href="#L617" title="lvm.c:617">RB</a>(i);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L255" title="lobject.h:255">setobjs2s</a>(L, ra+<span class="Constant">1</span>, rb);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L637" title="lvm.c:637">Protect</a>(<a href="#L164" title="lvm.c:164">luaV_gettable</a>(L, rb, <a href="#L621" title="lvm.c:621">RKC</a>(i), ra));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L648" title="lvm.c:648">vmbreak</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L647" title="lvm.c:647">vmcase</a>(OP_ADD) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> *rb = <a href="#L619" title="lvm.c:619">RKB</a>(i);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> *rc = <a href="#L621" title="lvm.c:621">RKC</a>(i);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lua.h.html#L87" title="lua.h:87">lua_Number</a> nb; <a href="lua.h.html#L87" title="lua.h:87">lua_Number</a> nc;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="lobject.h.html#L136" title="lobject.h:136">ttisinteger</a>(rb) &amp;&amp; <a href="lobject.h.html#L136" title="lobject.h:136">ttisinteger</a>(rc)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a> ib = <a href="lobject.h.html#L155" title="lobject.h:155">ivalue</a>(rb); <a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a> ic = <a href="lobject.h.html#L155" title="lobject.h:155">ivalue</a>(rc);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L193" title="lobject.h:193">setivalue</a>(ra, <a href="lvm.h.html#L36" title="lvm.h:36">intop</a>(+, ib, ic));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (<a href="lvm.h.html#L30" title="lvm.h:30">tonumber</a>(rb, &amp;nb) &amp;&amp; <a href="lvm.h.html#L30" title="lvm.h:30">tonumber</a>(rc, &amp;nc)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L190" title="lobject.h:190">setfltvalue</a>(ra, <a href="luaconf.h.html#L498" title="luaconf.h:498">luai_numadd</a>(L, nb, nc));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else</span> { <a href="#L637" title="lvm.c:637">Protect</a>(<a href="ltm.c.html#L114" title="ltm.c:114">luaT_trybinTM</a>(L, rb, rc, ra, TM_ADD)); }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L648" title="lvm.c:648">vmbreak</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L647" title="lvm.c:647">vmcase</a>(OP_SUB) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> *rb = <a href="#L619" title="lvm.c:619">RKB</a>(i);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> *rc = <a href="#L621" title="lvm.c:621">RKC</a>(i);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lua.h.html#L87" title="lua.h:87">lua_Number</a> nb; <a href="lua.h.html#L87" title="lua.h:87">lua_Number</a> nc;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="lobject.h.html#L136" title="lobject.h:136">ttisinteger</a>(rb) &amp;&amp; <a href="lobject.h.html#L136" title="lobject.h:136">ttisinteger</a>(rc)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a> ib = <a href="lobject.h.html#L155" title="lobject.h:155">ivalue</a>(rb); <a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a> ic = <a href="lobject.h.html#L155" title="lobject.h:155">ivalue</a>(rc);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L193" title="lobject.h:193">setivalue</a>(ra, <a href="lvm.h.html#L36" title="lvm.h:36">intop</a>(-, ib, ic));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (<a href="lvm.h.html#L30" title="lvm.h:30">tonumber</a>(rb, &amp;nb) &amp;&amp; <a href="lvm.h.html#L30" title="lvm.h:30">tonumber</a>(rc, &amp;nc)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L190" title="lobject.h:190">setfltvalue</a>(ra, <a href="luaconf.h.html#L499" title="luaconf.h:499">luai_numsub</a>(L, nb, nc));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else</span> { <a href="#L637" title="lvm.c:637">Protect</a>(<a href="ltm.c.html#L114" title="ltm.c:114">luaT_trybinTM</a>(L, rb, rc, ra, TM_SUB)); }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L648" title="lvm.c:648">vmbreak</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L647" title="lvm.c:647">vmcase</a>(OP_MUL) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> *rb = <a href="#L619" title="lvm.c:619">RKB</a>(i);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> *rc = <a href="#L621" title="lvm.c:621">RKC</a>(i);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lua.h.html#L87" title="lua.h:87">lua_Number</a> nb; <a href="lua.h.html#L87" title="lua.h:87">lua_Number</a> nc;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="lobject.h.html#L136" title="lobject.h:136">ttisinteger</a>(rb) &amp;&amp; <a href="lobject.h.html#L136" title="lobject.h:136">ttisinteger</a>(rc)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a> ib = <a href="lobject.h.html#L155" title="lobject.h:155">ivalue</a>(rb); <a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a> ic = <a href="lobject.h.html#L155" title="lobject.h:155">ivalue</a>(rc);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L193" title="lobject.h:193">setivalue</a>(ra, <a href="lvm.h.html#L36" title="lvm.h:36">intop</a>(*, ib, ic));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (<a href="lvm.h.html#L30" title="lvm.h:30">tonumber</a>(rb, &amp;nb) &amp;&amp; <a href="lvm.h.html#L30" title="lvm.h:30">tonumber</a>(rc, &amp;nc)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L190" title="lobject.h:190">setfltvalue</a>(ra, <a href="luaconf.h.html#L500" title="luaconf.h:500">luai_nummul</a>(L, nb, nc));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else</span> { <a href="#L637" title="lvm.c:637">Protect</a>(<a href="ltm.c.html#L114" title="ltm.c:114">luaT_trybinTM</a>(L, rb, rc, ra, TM_MUL)); }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L648" title="lvm.c:648">vmbreak</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L647" title="lvm.c:647">vmcase</a>(OP_DIV) {&nbsp; <span class="Comment">/* float division (always with floats) */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> *rb = <a href="#L619" title="lvm.c:619">RKB</a>(i);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> *rc = <a href="#L621" title="lvm.c:621">RKC</a>(i);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lua.h.html#L87" title="lua.h:87">lua_Number</a> nb; <a href="lua.h.html#L87" title="lua.h:87">lua_Number</a> nc;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="lvm.h.html#L30" title="lvm.h:30">tonumber</a>(rb, &amp;nb) &amp;&amp; <a href="lvm.h.html#L30" title="lvm.h:30">tonumber</a>(rc, &amp;nc)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L190" title="lobject.h:190">setfltvalue</a>(ra, <a href="luaconf.h.html#L501" title="luaconf.h:501">luai_numdiv</a>(L, nb, nc));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else</span> { <a href="#L637" title="lvm.c:637">Protect</a>(<a href="ltm.c.html#L114" title="ltm.c:114">luaT_trybinTM</a>(L, rb, rc, ra, TM_DIV)); }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L648" title="lvm.c:648">vmbreak</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L647" title="lvm.c:647">vmcase</a>(OP_BAND) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> *rb = <a href="#L619" title="lvm.c:619">RKB</a>(i);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> *rc = <a href="#L621" title="lvm.c:621">RKC</a>(i);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a> ib; <a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a> ic;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="lvm.h.html#L33" title="lvm.h:33">tointeger</a>(rb, &amp;ib) &amp;&amp; <a href="lvm.h.html#L33" title="lvm.h:33">tointeger</a>(rc, &amp;ic)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L193" title="lobject.h:193">setivalue</a>(ra, <a href="lvm.h.html#L36" title="lvm.h:36">intop</a>(&amp;, ib, ic));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else</span> { <a href="#L637" title="lvm.c:637">Protect</a>(<a href="ltm.c.html#L114" title="ltm.c:114">luaT_trybinTM</a>(L, rb, rc, ra, TM_BAND)); }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L648" title="lvm.c:648">vmbreak</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L647" title="lvm.c:647">vmcase</a>(OP_BOR) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> *rb = <a href="#L619" title="lvm.c:619">RKB</a>(i);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> *rc = <a href="#L621" title="lvm.c:621">RKC</a>(i);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a> ib; <a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a> ic;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="lvm.h.html#L33" title="lvm.h:33">tointeger</a>(rb, &amp;ib) &amp;&amp; <a href="lvm.h.html#L33" title="lvm.h:33">tointeger</a>(rc, &amp;ic)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L193" title="lobject.h:193">setivalue</a>(ra, <a href="lvm.h.html#L36" title="lvm.h:36">intop</a>(|, ib, ic));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else</span> { <a href="#L637" title="lvm.c:637">Protect</a>(<a href="ltm.c.html#L114" title="ltm.c:114">luaT_trybinTM</a>(L, rb, rc, ra, TM_BOR)); }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L648" title="lvm.c:648">vmbreak</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L647" title="lvm.c:647">vmcase</a>(OP_BXOR) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> *rb = <a href="#L619" title="lvm.c:619">RKB</a>(i);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> *rc = <a href="#L621" title="lvm.c:621">RKC</a>(i);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a> ib; <a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a> ic;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="lvm.h.html#L33" title="lvm.h:33">tointeger</a>(rb, &amp;ib) &amp;&amp; <a href="lvm.h.html#L33" title="lvm.h:33">tointeger</a>(rc, &amp;ic)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L193" title="lobject.h:193">setivalue</a>(ra, <a href="lvm.h.html#L36" title="lvm.h:36">intop</a>(^, ib, ic));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else</span> { <a href="#L637" title="lvm.c:637">Protect</a>(<a href="ltm.c.html#L114" title="ltm.c:114">luaT_trybinTM</a>(L, rb, rc, ra, TM_BXOR)); }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L648" title="lvm.c:648">vmbreak</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L647" title="lvm.c:647">vmcase</a>(OP_SHL) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> *rb = <a href="#L619" title="lvm.c:619">RKB</a>(i);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> *rc = <a href="#L621" title="lvm.c:621">RKC</a>(i);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a> ib; <a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a> ic;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="lvm.h.html#L33" title="lvm.h:33">tointeger</a>(rb, &amp;ib) &amp;&amp; <a href="lvm.h.html#L33" title="lvm.h:33">tointeger</a>(rc, &amp;ic)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L193" title="lobject.h:193">setivalue</a>(ra, <a href="#L476" title="lvm.c:476">luaV_shiftl</a>(ib, ic));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else</span> { <a href="#L637" title="lvm.c:637">Protect</a>(<a href="ltm.c.html#L114" title="ltm.c:114">luaT_trybinTM</a>(L, rb, rc, ra, TM_SHL)); }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L648" title="lvm.c:648">vmbreak</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L647" title="lvm.c:647">vmcase</a>(OP_SHR) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> *rb = <a href="#L619" title="lvm.c:619">RKB</a>(i);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> *rc = <a href="#L621" title="lvm.c:621">RKC</a>(i);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a> ib; <a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a> ic;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="lvm.h.html#L33" title="lvm.h:33">tointeger</a>(rb, &amp;ib) &amp;&amp; <a href="lvm.h.html#L33" title="lvm.h:33">tointeger</a>(rc, &amp;ic)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L193" title="lobject.h:193">setivalue</a>(ra, <a href="#L476" title="lvm.c:476">luaV_shiftl</a>(ib, -ic));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else</span> { <a href="#L637" title="lvm.c:637">Protect</a>(<a href="ltm.c.html#L114" title="ltm.c:114">luaT_trybinTM</a>(L, rb, rc, ra, TM_SHR)); }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L648" title="lvm.c:648">vmbreak</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L647" title="lvm.c:647">vmcase</a>(OP_MOD) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> *rb = <a href="#L619" title="lvm.c:619">RKB</a>(i);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> *rc = <a href="#L621" title="lvm.c:621">RKC</a>(i);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lua.h.html#L87" title="lua.h:87">lua_Number</a> nb; <a href="lua.h.html#L87" title="lua.h:87">lua_Number</a> nc;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="lobject.h.html#L136" title="lobject.h:136">ttisinteger</a>(rb) &amp;&amp; <a href="lobject.h.html#L136" title="lobject.h:136">ttisinteger</a>(rc)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a> ib = <a href="lobject.h.html#L155" title="lobject.h:155">ivalue</a>(rb); <a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a> ic = <a href="lobject.h.html#L155" title="lobject.h:155">ivalue</a>(rc);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L193" title="lobject.h:193">setivalue</a>(ra, <a href="#L455" title="lvm.c:455">luaV_mod</a>(L, ib, ic));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (<a href="lvm.h.html#L30" title="lvm.h:30">tonumber</a>(rb, &amp;nb) &amp;&amp; <a href="lvm.h.html#L30" title="lvm.h:30">tonumber</a>(rc, &amp;nc)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lua.h.html#L87" title="lua.h:87">lua_Number</a> m;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="luaconf.h.html#L488" title="luaconf.h:488">luai_nummod</a>(L, nb, nc, m);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L190" title="lobject.h:190">setfltvalue</a>(ra, m);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else</span> { <a href="#L637" title="lvm.c:637">Protect</a>(<a href="ltm.c.html#L114" title="ltm.c:114">luaT_trybinTM</a>(L, rb, rc, ra, TM_MOD)); }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L648" title="lvm.c:648">vmbreak</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L647" title="lvm.c:647">vmcase</a>(OP_IDIV) {&nbsp; <span class="Comment">/* floor division */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> *rb = <a href="#L619" title="lvm.c:619">RKB</a>(i);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> *rc = <a href="#L621" title="lvm.c:621">RKC</a>(i);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lua.h.html#L87" title="lua.h:87">lua_Number</a> nb; <a href="lua.h.html#L87" title="lua.h:87">lua_Number</a> nc;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="lobject.h.html#L136" title="lobject.h:136">ttisinteger</a>(rb) &amp;&amp; <a href="lobject.h.html#L136" title="lobject.h:136">ttisinteger</a>(rc)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a> ib = <a href="lobject.h.html#L155" title="lobject.h:155">ivalue</a>(rb); <a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a> ic = <a href="lobject.h.html#L155" title="lobject.h:155">ivalue</a>(rc);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L193" title="lobject.h:193">setivalue</a>(ra, <a href="#L435" title="lvm.c:435">luaV_div</a>(L, ib, ic));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (<a href="lvm.h.html#L30" title="lvm.h:30">tonumber</a>(rb, &amp;nb) &amp;&amp; <a href="lvm.h.html#L30" title="lvm.h:30">tonumber</a>(rc, &amp;nc)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L190" title="lobject.h:190">setfltvalue</a>(ra, <a href="luaconf.h.html#L479" title="luaconf.h:479">luai_numidiv</a>(L, nb, nc));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else</span> { <a href="#L637" title="lvm.c:637">Protect</a>(<a href="ltm.c.html#L114" title="ltm.c:114">luaT_trybinTM</a>(L, rb, rc, ra, TM_IDIV)); }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L648" title="lvm.c:648">vmbreak</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L647" title="lvm.c:647">vmcase</a>(OP_POW) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> *rb = <a href="#L619" title="lvm.c:619">RKB</a>(i);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> *rc = <a href="#L621" title="lvm.c:621">RKC</a>(i);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lua.h.html#L87" title="lua.h:87">lua_Number</a> nb; <a href="lua.h.html#L87" title="lua.h:87">lua_Number</a> nc;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="lvm.h.html#L30" title="lvm.h:30">tonumber</a>(rb, &amp;nb) &amp;&amp; <a href="lvm.h.html#L30" title="lvm.h:30">tonumber</a>(rc, &amp;nc)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L190" title="lobject.h:190">setfltvalue</a>(ra, <a href="luaconf.h.html#L492" title="luaconf.h:492">luai_numpow</a>(L, nb, nc));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else</span> { <a href="#L637" title="lvm.c:637">Protect</a>(<a href="ltm.c.html#L114" title="ltm.c:114">luaT_trybinTM</a>(L, rb, rc, ra, TM_POW)); }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L648" title="lvm.c:648">vmbreak</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L647" title="lvm.c:647">vmcase</a>(OP_UNM) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> *rb = <a href="#L617" title="lvm.c:617">RB</a>(i);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lua.h.html#L87" title="lua.h:87">lua_Number</a> nb;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="lobject.h.html#L136" title="lobject.h:136">ttisinteger</a>(rb)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a> ib = <a href="lobject.h.html#L155" title="lobject.h:155">ivalue</a>(rb);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L193" title="lobject.h:193">setivalue</a>(ra, <a href="lvm.h.html#L36" title="lvm.h:36">intop</a>(-, <span class="Constant">0</span>, ib));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (<a href="lvm.h.html#L30" title="lvm.h:30">tonumber</a>(rb, &amp;nb)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L190" title="lobject.h:190">setfltvalue</a>(ra, <a href="luaconf.h.html#L502" title="luaconf.h:502">luai_numunm</a>(L, nb));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L637" title="lvm.c:637">Protect</a>(<a href="ltm.c.html#L114" title="ltm.c:114">luaT_trybinTM</a>(L, rb, rb, ra, TM_UNM));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L648" title="lvm.c:648">vmbreak</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L647" title="lvm.c:647">vmcase</a>(OP_BNOT) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> *rb = <a href="#L617" title="lvm.c:617">RB</a>(i);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a> ib;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="lvm.h.html#L33" title="lvm.h:33">tointeger</a>(rb, &amp;ib)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L193" title="lobject.h:193">setivalue</a>(ra, <a href="lvm.h.html#L36" title="lvm.h:36">intop</a>(^, ~<a href="llimits.h.html#L118" title="llimits.h:118">l_castS2U</a>(<span class="Constant">0</span>), ib));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L637" title="lvm.c:637">Protect</a>(<a href="ltm.c.html#L114" title="ltm.c:114">luaT_trybinTM</a>(L, rb, rb, ra, TM_BNOT));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L648" title="lvm.c:648">vmbreak</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L647" title="lvm.c:647">vmcase</a>(OP_NOT) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> *rb = <a href="#L617" title="lvm.c:617">RB</a>(i);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> res = <a href="lobject.h.html#L173" title="lobject.h:173">l_isfalse</a>(rb);&nbsp; <span class="Comment">/* <a href="llex.c.html#L31" title="llex.c:31">next</a> <a href="lparser.c.html#L1141" title="lparser.c:1141">assignment</a> may change this value */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L204" title="lobject.h:204">setbvalue</a>(ra, res);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L648" title="lvm.c:648">vmbreak</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L647" title="lvm.c:647">vmcase</a>(OP_LEN) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L637" title="lvm.c:637">Protect</a>(<a href="#L404" title="lvm.c:404">luaV_objlen</a>(L, ra, <a href="#L617" title="lvm.c:617">RB</a>(i)));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L648" title="lvm.c:648">vmbreak</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L647" title="lvm.c:647">vmcase</a>(OP_CONCAT) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> b = <a href="lopcodes.h.html#L100" title="lopcodes.h:100">GETARG_B</a>(i);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> c = <a href="lopcodes.h.html#L103" title="lopcodes.h:103">GETARG_C</a>(i);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L294" title="lobject.h:294">StkId</a> rb;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; L-&gt;top = base + c + <span class="Constant">1</span>;&nbsp; <span class="Comment">/* mark the end of concat operands */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L637" title="lvm.c:637">Protect</a>(<a href="#L361" title="lvm.c:361">luaV_concat</a>(L, c - b + <span class="Constant">1</span>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ra = <a href="#L615" title="lvm.c:615">RA</a>(i);&nbsp; <span class="Comment">/* 'luav_concat' may invoke TMs and move the stack */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; rb = b + base;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L255" title="lobject.h:255">setobjs2s</a>(L, ra, rb);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L639" title="lvm.c:639">checkGC</a>(L, (ra &gt;= rb ? ra + <span class="Constant">1</span> : rb));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; L-&gt;top = ci-&gt;top;&nbsp; <span class="Comment">/* restore top */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L648" title="lvm.c:648">vmbreak</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L647" title="lvm.c:647">vmcase</a>(OP_JMP) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L628" title="lvm.c:628">dojump</a>(ci, i, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L648" title="lvm.c:648">vmbreak</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L647" title="lvm.c:647">vmcase</a>(OP_EQ) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> *rb = <a href="#L619" title="lvm.c:619">RKB</a>(i);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> *rc = <a href="#L621" title="lvm.c:621">RKC</a>(i);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L637" title="lvm.c:637">Protect</a>(<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="llimits.h.html#L112" title="llimits.h:112">cast_int</a>(<a href="#L305" title="lvm.c:305">luaV_equalobj</a>(L, rb, rc)) != <a href="lopcodes.h.html#L97" title="lopcodes.h:97">GETARG_A</a>(i))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ci-&gt;u.l.savedpc++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L634" title="lvm.c:634">donextjump</a>(ci);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; )<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L648" title="lvm.c:648">vmbreak</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L647" title="lvm.c:647">vmcase</a>(OP_LT) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L637" title="lvm.c:637">Protect</a>(<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L266" title="lvm.c:266">luaV_lessthan</a>(L, <a href="#L619" title="lvm.c:619">RKB</a>(i), <a href="#L621" title="lvm.c:621">RKC</a>(i)) != <a href="lopcodes.h.html#L97" title="lopcodes.h:97">GETARG_A</a>(i))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ci-&gt;u.l.savedpc++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L634" title="lvm.c:634">donextjump</a>(ci);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; )<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L648" title="lvm.c:648">vmbreak</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L647" title="lvm.c:647">vmcase</a>(OP_LE) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L637" title="lvm.c:637">Protect</a>(<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L284" title="lvm.c:284">luaV_lessequal</a>(L, <a href="#L619" title="lvm.c:619">RKB</a>(i), <a href="#L621" title="lvm.c:621">RKC</a>(i)) != <a href="lopcodes.h.html#L97" title="lopcodes.h:97">GETARG_A</a>(i))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ci-&gt;u.l.savedpc++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L634" title="lvm.c:634">donextjump</a>(ci);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; )<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L648" title="lvm.c:648">vmbreak</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L647" title="lvm.c:647">vmcase</a>(OP_TEST) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="lopcodes.h.html#L103" title="lopcodes.h:103">GETARG_C</a>(i) ? <a href="lobject.h.html#L173" title="lobject.h:173">l_isfalse</a>(ra) : !<a href="lobject.h.html#L173" title="lobject.h:173">l_isfalse</a>(ra))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ci-&gt;u.l.savedpc++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L634" title="lvm.c:634">donextjump</a>(ci);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L648" title="lvm.c:648">vmbreak</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L647" title="lvm.c:647">vmcase</a>(OP_TESTSET) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> *rb = <a href="#L617" title="lvm.c:617">RB</a>(i);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="lopcodes.h.html#L103" title="lopcodes.h:103">GETARG_C</a>(i) ? <a href="lobject.h.html#L173" title="lobject.h:173">l_isfalse</a>(rb) : !<a href="lobject.h.html#L173" title="lobject.h:173">l_isfalse</a>(rb))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ci-&gt;u.l.savedpc++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L255" title="lobject.h:255">setobjs2s</a>(L, ra, rb);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L634" title="lvm.c:634">donextjump</a>(ci);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L648" title="lvm.c:648">vmbreak</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L647" title="lvm.c:647">vmcase</a>(OP_CALL) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> b = <a href="lopcodes.h.html#L100" title="lopcodes.h:100">GETARG_B</a>(i);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> nresults = <a href="lopcodes.h.html#L103" title="lopcodes.h:103">GETARG_C</a>(i) - <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (b != <span class="Constant">0</span>) L-&gt;top = ra+b;&nbsp; <span class="Comment">/* else previous instruction set top */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="ldo.c.html#L314" title="ldo.c:314">luaD_precall</a>(L, ra, nresults)) {&nbsp; <span class="Comment">/* C function? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (nresults &gt;= <span class="Constant">0</span>) L-&gt;top = ci-&gt;top;&nbsp; <span class="Comment">/* adjust results */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; base = ci-&gt;u.l.base;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else</span> {&nbsp; <span class="Comment">/* Lua function */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ci = L-&gt;ci;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ci-&gt;callstatus |= <a href="lstate.h.html#L92" title="lstate.h:92">CIST_REENTRY</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> newframe;&nbsp; <span class="Comment">/* restart <a href="#L650" title="lvm.c:650">luaV_execute</a> over new Lua function */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L648" title="lvm.c:648">vmbreak</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L647" title="lvm.c:647">vmcase</a>(OP_TAILCALL) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> b = <a href="lopcodes.h.html#L100" title="lopcodes.h:100">GETARG_B</a>(i);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (b != <span class="Constant">0</span>) L-&gt;top = ra+b;&nbsp; <span class="Comment">/* else previous instruction set top */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lualib.h.html#L54" title="lualib.h:54">lua_assert</a>(<a href="lopcodes.h.html#L103" title="lopcodes.h:103">GETARG_C</a>(i) - <span class="Constant">1</span> == <a href="lua.h.html#L34" title="lua.h:34">LUA_MULTRET</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="ldo.c.html#L314" title="ldo.c:314">luaD_precall</a>(L, ra, <a href="lua.h.html#L34" title="lua.h:34">LUA_MULTRET</a>))&nbsp; <span class="Comment">/* C function? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; base = ci-&gt;u.l.base;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* tail call: put called frame (n) in place of caller one (o) */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lstate.h.html#L65" title="lstate.h:65">CallInfo</a> *nci = L-&gt;ci;&nbsp; <span class="Comment">/* called frame */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lstate.h.html#L65" title="lstate.h:65">CallInfo</a> *oci = nci-&gt;previous;&nbsp; <span class="Comment">/* caller frame */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L294" title="lobject.h:294">StkId</a> nfunc = nci-&gt;func;&nbsp; <span class="Comment">/* called function */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L294" title="lobject.h:294">StkId</a> ofunc = oci-&gt;func;&nbsp; <span class="Comment">/* caller function */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* last stack slot filled by 'precall' */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L294" title="lobject.h:294">StkId</a> lim = nci-&gt;u.l.base + <a href="lobject.h.html#L459" title="lobject.h:459">getproto</a>(nfunc)-&gt;numparams;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> aux;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* close all upvalues from previous call */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (cl-&gt;p-&gt;sizep &gt; <span class="Constant">0</span>) <a href="lfunc.c.html#L83" title="lfunc.c:83">luaF_close</a>(L, oci-&gt;u.l.base);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* move new frame into old one */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (aux = <span class="Constant">0</span>; nfunc + aux &lt; lim; aux++)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L255" title="lobject.h:255">setobjs2s</a>(L, ofunc + aux, nfunc + aux);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; oci-&gt;u.l.base = ofunc + (nci-&gt;u.l.base - nfunc);&nbsp; <span class="Comment">/* correct base */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; oci-&gt;top = L-&gt;top = ofunc + (L-&gt;top - nfunc);&nbsp; <span class="Comment">/* correct top */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; oci-&gt;u.l.savedpc = nci-&gt;u.l.savedpc;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; oci-&gt;callstatus |= <a href="lstate.h.html#L95" title="lstate.h:95">CIST_TAIL</a>;&nbsp; <span class="Comment">/* function was tail called */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ci = L-&gt;ci = oci;&nbsp; <span class="Comment">/* remove new frame */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lualib.h.html#L54" title="lualib.h:54">lua_assert</a>(L-&gt;top == oci-&gt;u.l.base + <a href="lobject.h.html#L459" title="lobject.h:459">getproto</a>(ofunc)-&gt;maxstacksize);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> newframe;&nbsp; <span class="Comment">/* restart <a href="#L650" title="lvm.c:650">luaV_execute</a> over new Lua function */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L648" title="lvm.c:648">vmbreak</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L647" title="lvm.c:647">vmcase</a>(OP_RETURN) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> b = <a href="lopcodes.h.html#L100" title="lopcodes.h:100">GETARG_B</a>(i);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (b != <span class="Constant">0</span>) L-&gt;top = ra+b-<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (cl-&gt;p-&gt;sizep &gt; <span class="Constant">0</span>) <a href="lfunc.c.html#L83" title="lfunc.c:83">luaF_close</a>(L, base);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; b = <a href="ldo.c.html#L382" title="ldo.c:382">luaD_poscall</a>(L, ra);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!(ci-&gt;callstatus &amp; <a href="lstate.h.html#L92" title="lstate.h:92">CIST_REENTRY</a>))&nbsp; <span class="Comment">/* 'ci' still the called one */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;&nbsp; <span class="Comment">/* external invocation: return */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else</span> {&nbsp; <span class="Comment">/* invocation via reentry: continue execution */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ci = L-&gt;ci;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (b) L-&gt;top = ci-&gt;top;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lualib.h.html#L54" title="lualib.h:54">lua_assert</a>(<a href="lstate.h.html#L98" title="lstate.h:98">isLua</a>(ci));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lualib.h.html#L54" title="lualib.h:54">lua_assert</a>(<a href="lopcodes.h.html#L89" title="lopcodes.h:89">GET_OPCODE</a>(*((ci)-&gt;u.l.savedpc - <span class="Constant">1</span>)) == OP_CALL);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> newframe;&nbsp; <span class="Comment">/* restart <a href="#L650" title="lvm.c:650">luaV_execute</a> over new Lua function */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L647" title="lvm.c:647">vmcase</a>(OP_FORLOOP) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="lobject.h.html#L136" title="lobject.h:136">ttisinteger</a>(ra)) {&nbsp; <span class="Comment">/* integer loop? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a> step = <a href="lobject.h.html#L155" title="lobject.h:155">ivalue</a>(ra + <span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a> idx = <a href="lobject.h.html#L155" title="lobject.h:155">ivalue</a>(ra) + step; <span class="Comment">/* increment index */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a> limit = <a href="lobject.h.html#L155" title="lobject.h:155">ivalue</a>(ra + <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((<span class="Constant">0</span> &lt; step) ? (idx &lt;= limit) : (limit &lt;= idx)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ci-&gt;u.l.savedpc += <a href="lopcodes.h.html#L112" title="lopcodes.h:112">GETARG_sBx</a>(i);&nbsp; <span class="Comment">/* jump back */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L193" title="lobject.h:193">setivalue</a>(ra, idx);&nbsp; <span class="Comment">/* update internal index... */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L193" title="lobject.h:193">setivalue</a>(ra + <span class="Constant">3</span>, idx);&nbsp; <span class="Comment">/* ...and external index */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else</span> {&nbsp; <span class="Comment">/* floating loop */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lua.h.html#L87" title="lua.h:87">lua_Number</a> step = <a href="lobject.h.html#L156" title="lobject.h:156">fltvalue</a>(ra + <span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lua.h.html#L87" title="lua.h:87">lua_Number</a> idx = <a href="luaconf.h.html#L498" title="luaconf.h:498">luai_numadd</a>(L, <a href="lobject.h.html#L156" title="lobject.h:156">fltvalue</a>(ra), step); <span class="Comment">/* inc. index */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lua.h.html#L87" title="lua.h:87">lua_Number</a> limit = <a href="lobject.h.html#L156" title="lobject.h:156">fltvalue</a>(ra + <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="luaconf.h.html#L504" title="luaconf.h:504">luai_numlt</a>(<span class="Constant">0</span>, step) ? <a href="luaconf.h.html#L505" title="luaconf.h:505">luai_numle</a>(idx, limit)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : <a href="luaconf.h.html#L505" title="luaconf.h:505">luai_numle</a>(limit, idx)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ci-&gt;u.l.savedpc += <a href="lopcodes.h.html#L112" title="lopcodes.h:112">GETARG_sBx</a>(i);&nbsp; <span class="Comment">/* jump back */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L190" title="lobject.h:190">setfltvalue</a>(ra, idx);&nbsp; <span class="Comment">/* update internal index... */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L190" title="lobject.h:190">setfltvalue</a>(ra + <span class="Constant">3</span>, idx);&nbsp; <span class="Comment">/* ...and external index */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L648" title="lvm.c:648">vmbreak</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L647" title="lvm.c:647">vmcase</a>(OP_FORPREP) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> *init = ra;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> *plimit = ra + <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> *pstep = ra + <span class="Constant">2</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a> ilimit;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> stopnow;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="lobject.h.html#L136" title="lobject.h:136">ttisinteger</a>(init) &amp;&amp; <a href="lobject.h.html#L136" title="lobject.h:136">ttisinteger</a>(pstep) &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L140" title="lvm.c:140">forlimit</a>(plimit, &amp;ilimit, <a href="lobject.h.html#L155" title="lobject.h:155">ivalue</a>(pstep), &amp;stopnow)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* all values are integer */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a> initv = (stopnow ? <span class="Constant">0</span> : <a href="lobject.h.html#L155" title="lobject.h:155">ivalue</a>(init));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L193" title="lobject.h:193">setivalue</a>(plimit, ilimit);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L193" title="lobject.h:193">setivalue</a>(init, initv - <a href="lobject.h.html#L155" title="lobject.h:155">ivalue</a>(pstep));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else</span> {&nbsp; <span class="Comment">/* try making all values floats */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lua.h.html#L87" title="lua.h:87">lua_Number</a> ninit; <a href="lua.h.html#L87" title="lua.h:87">lua_Number</a> nlimit; <a href="lua.h.html#L87" title="lua.h:87">lua_Number</a> nstep;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!<a href="lvm.h.html#L30" title="lvm.h:30">tonumber</a>(plimit, &amp;nlimit))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ldebug.c.html#L603" title="ldebug.c:603">luaG_runerror</a>(L, <span class="Constant">&quot;'for' limit must be a number&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L190" title="lobject.h:190">setfltvalue</a>(plimit, nlimit);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!<a href="lvm.h.html#L30" title="lvm.h:30">tonumber</a>(pstep, &amp;nstep))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ldebug.c.html#L603" title="ldebug.c:603">luaG_runerror</a>(L, <span class="Constant">&quot;'for' step must be a number&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L190" title="lobject.h:190">setfltvalue</a>(pstep, nstep);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!<a href="lvm.h.html#L30" title="lvm.h:30">tonumber</a>(init, &amp;ninit))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ldebug.c.html#L603" title="ldebug.c:603">luaG_runerror</a>(L, <span class="Constant">&quot;'for' initial value must be a number&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L190" title="lobject.h:190">setfltvalue</a>(init, <a href="luaconf.h.html#L499" title="luaconf.h:499">luai_numsub</a>(L, ninit, nstep));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ci-&gt;u.l.savedpc += <a href="lopcodes.h.html#L112" title="lopcodes.h:112">GETARG_sBx</a>(i);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L648" title="lvm.c:648">vmbreak</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L647" title="lvm.c:647">vmcase</a>(OP_TFORCALL) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L294" title="lobject.h:294">StkId</a> cb = ra + <span class="Constant">3</span>;&nbsp; <span class="Comment">/* call base */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L255" title="lobject.h:255">setobjs2s</a>(L, cb+<span class="Constant">2</span>, ra+<span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L255" title="lobject.h:255">setobjs2s</a>(L, cb+<span class="Constant">1</span>, ra+<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L255" title="lobject.h:255">setobjs2s</a>(L, cb, ra);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; L-&gt;top = cb + <span class="Constant">3</span>;&nbsp; <span class="Comment">/* func. + 2 args (state and index) */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L637" title="lvm.c:637">Protect</a>(<a href="ldo.c.html#L413" title="ldo.c:413">luaD_call</a>(L, cb, <a href="lopcodes.h.html#L103" title="lopcodes.h:103">GETARG_C</a>(i), <span class="Constant">1</span>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; L-&gt;top = ci-&gt;top;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; i = *(ci-&gt;u.l.savedpc++);&nbsp; <span class="Comment">/* go to <a href="llex.c.html#L31" title="llex.c:31">next</a> instruction */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; ra = <a href="#L615" title="lvm.c:615">RA</a>(i);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lualib.h.html#L54" title="lualib.h:54">lua_assert</a>(<a href="lopcodes.h.html#L89" title="lopcodes.h:89">GET_OPCODE</a>(i) == OP_TFORLOOP);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> l_tforloop;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L647" title="lvm.c:647">vmcase</a>(OP_TFORLOOP) {<br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">l_tforloop</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!<a href="lobject.h.html#L137" title="lobject.h:137">ttisnil</a>(ra + <span class="Constant">1</span>)) {&nbsp; <span class="Comment">/* continue loop? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L255" title="lobject.h:255">setobjs2s</a>(L, ra, ra + <span class="Constant">1</span>);&nbsp; <span class="Comment">/* <a href="llex.c.html#L56" title="llex.c:56">save</a> control variable */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ci-&gt;u.l.savedpc += <a href="lopcodes.h.html#L112" title="lopcodes.h:112">GETARG_sBx</a>(i);&nbsp; <span class="Comment">/* jump back */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L648" title="lvm.c:648">vmbreak</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L647" title="lvm.c:647">vmcase</a>(OP_SETLIST) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> n = <a href="lopcodes.h.html#L100" title="lopcodes.h:100">GETARG_B</a>(i);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> c = <a href="lopcodes.h.html#L103" title="lopcodes.h:103">GETARG_C</a>(i);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">unsigned</span> <span class="Type">int</span> last;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L488" title="lobject.h:488">Table</a> *h;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n == <span class="Constant">0</span>) n = <a href="llimits.h.html#L112" title="llimits.h:112">cast_int</a>(L-&gt;top - ra) - <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (c == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lualib.h.html#L54" title="lualib.h:54">lua_assert</a>(<a href="lopcodes.h.html#L89" title="lopcodes.h:89">GET_OPCODE</a>(*ci-&gt;u.l.savedpc) == OP_EXTRAARG);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c = <a href="lopcodes.h.html#L109" title="lopcodes.h:109">GETARG_Ax</a>(*ci-&gt;u.l.savedpc++);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L611" title="lvm.c:611">luai_runtimecheck</a>(L, <a href="lobject.h.html#L143" title="lobject.h:143">ttistable</a>(ra));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; h = <a href="lobject.h.html#L167" title="lobject.h:167">hvalue</a>(ra);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; last = ((c-<span class="Constant">1</span>)*<a href="lopcodes.h.html#L292" title="lopcodes.h:292">LFIELDS_PER_FLUSH</a>) + n;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (last &gt; h-&gt;sizearray)&nbsp; <span class="Comment">/* needs more space? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ltable.c.html#L370" title="ltable.c:370">luaH_resizearray</a>(L, h, last);&nbsp; <span class="Comment">/* pre-allocate it at once */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (; n &gt; <span class="Constant">0</span>; n--) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L108" title="lobject.h:108">TValue</a> *val = ra+n;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ltable.c.html#L580" title="ltable.c:580">luaH_setint</a>(L, h, last--, val);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lgc.h.html#L113" title="lgc.h:113">luaC_barrierback</a>(L, h, val);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; L-&gt;top = ci-&gt;top;&nbsp; <span class="Comment">/* correct top (in case of previous open call) */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L648" title="lvm.c:648">vmbreak</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L647" title="lvm.c:647">vmcase</a>(OP_CLOSURE) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L398" title="lobject.h:398">Proto</a> *p = cl-&gt;p-&gt;p[<a href="lopcodes.h.html#L106" title="lopcodes.h:106">GETARG_Bx</a>(i)];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L444" title="lobject.h:444">LClosure</a> *ncl = <a href="#L493" title="lvm.c:493">getcached</a>(p, cl-&gt;upvals, base);&nbsp; <span class="Comment">/* cached closure */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ncl == <span class="Constant">NULL</span>)&nbsp; <span class="Comment">/* no <a href="lstrlib.c.html#L420" title="lstrlib.c:420">match</a>? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L515" title="lvm.c:515">pushclosure</a>(L, p, cl-&gt;upvals, base, ra);&nbsp; <span class="Comment">/* create a new one */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L226" title="lobject.h:226">setclLvalue</a>(L, ra, ncl);&nbsp; <span class="Comment">/* push cashed closure */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L639" title="lvm.c:639">checkGC</a>(L, ra + <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L648" title="lvm.c:648">vmbreak</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L647" title="lvm.c:647">vmcase</a>(OP_VARARG) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> b = <a href="lopcodes.h.html#L100" title="lopcodes.h:100">GETARG_B</a>(i) - <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> j;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> n = <a href="llimits.h.html#L112" title="llimits.h:112">cast_int</a>(base - ci-&gt;func) - cl-&gt;p-&gt;numparams - <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (b &lt; <span class="Constant">0</span>) {&nbsp; <span class="Comment">/* B == 0? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b = n;&nbsp; <span class="Comment">/* get all var. arguments */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L637" title="lvm.c:637">Protect</a>(<a href="ldo.h.html#L16" title="ldo.h:16">luaD_checkstack</a>(L, n));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ra = <a href="#L615" title="lvm.c:615">RA</a>(i);&nbsp; <span class="Comment">/* previous call may change the stack */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; L-&gt;top = ra + n;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (j = <span class="Constant">0</span>; j &lt; b; j++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (j &lt; n) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L255" title="lobject.h:255">setobjs2s</a>(L, ra + j, base - n + j);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lobject.h.html#L196" title="lobject.h:196">setnilvalue</a>(ra + j);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L648" title="lvm.c:648">vmbreak</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L647" title="lvm.c:647">vmcase</a>(OP_EXTRAARG) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lualib.h.html#L54" title="lualib.h:54">lua_assert</a>(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L648" title="lvm.c:648">vmbreak</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* }================================================================== */<br/></li>
<li></span><br/></li>
</ol></code>
 </body>
</html>
