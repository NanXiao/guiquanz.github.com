<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>lauxlib.c - src</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

code {
    font-family: consolas, monospace;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
  <h3>lauxlib.c - src</h3>
   <a href="../index.html"> Table of Contents </a>
 <h4>Data types defined</h4>
 <ul>
<li><a href="#L573">LoadF</a></li>
<li><a href="#L577">LoadF</a></li>
<li><a href="#L677">LoadS</a></li>
<li><a href="#L680">LoadS</a></li>
</ul>
 <h4>Functions defined</h4>
 <ul>
<li><a href="#L110">countlevels</a></li>
<li><a href="#L598">errfile</a></li>
<li><a href="#L45">findfield</a></li>
<li><a href="#L580">getF</a></li>
<li><a href="#L683">getS</a></li>
<li><a href="#L406">interror</a></li>
<li><a href="#L937">l_alloc</a></li>
<li><a href="#L813">libsize</a></li>
<li><a href="#L470">luaL_addlstring</a></li>
<li><a href="#L477">luaL_addstring</a></li>
<li><a href="#L496">luaL_addvalue</a></li>
<li><a href="#L162">luaL_argerror</a></li>
<li><a href="#L507">luaL_buffinit</a></li>
<li><a href="#L515">luaL_buffinitsize</a></li>
<li><a href="#L726">luaL_callmeta</a></li>
<li><a href="#L368">luaL_checkany</a></li>
<li><a href="#L414">luaL_checkinteger</a></li>
<li><a href="#L374">luaL_checklstring</a></li>
<li><a href="#L392">luaL_checknumber</a></li>
<li><a href="#L337">luaL_checkoption</a></li>
<li><a href="#L350">luaL_checkstack</a></li>
<li><a href="#L362">luaL_checktype</a></li>
<li><a href="#L322">luaL_checkudata</a></li>
<li><a href="#L962">luaL_checkversion_</a></li>
<li><a href="#L212">luaL_error</a></li>
<li><a href="#L263">luaL_execresult</a></li>
<li><a href="#L223">luaL_fileresult</a></li>
<li><a href="#L784">luaL_findtable</a></li>
<li><a href="#L710">luaL_getmetafield</a></li>
<li><a href="#L880">luaL_getsubtable</a></li>
<li><a href="#L920">luaL_gsub</a></li>
<li><a href="#L736">luaL_len</a></li>
<li><a href="#L693">luaL_loadbufferx</a></li>
<li><a href="#L641">luaL_loadfilex</a></li>
<li><a href="#L702">luaL_loadstring</a></li>
<li><a href="#L288">luaL_newmetatable</a></li>
<li><a href="#L955">luaL_newstate</a></li>
<li><a href="#L842">luaL_openlib</a></li>
<li><a href="#L424">luaL_optinteger</a></li>
<li><a href="#L381">luaL_optlstring</a></li>
<li><a href="#L401">luaL_optnumber</a></li>
<li><a href="#L448">luaL_prepbuffsize</a></li>
<li><a href="#L826">luaL_pushmodule</a></li>
<li><a href="#L482">luaL_pushresult</a></li>
<li><a href="#L490">luaL_pushresultsize</a></li>
<li><a href="#L533">luaL_ref</a></li>
<li><a href="#L900">luaL_requiref</a></li>
<li><a href="#L863">luaL_setfuncs</a></li>
<li><a href="#L301">luaL_setmetatable</a></li>
<li><a href="#L307">luaL_testudata</a></li>
<li><a href="#L748">luaL_tolstring</a></li>
<li><a href="#L125">luaL_traceback</a></li>
<li><a href="#L554">luaL_unref</a></li>
<li><a href="#L199">luaL_where</a></li>
<li><a href="#L948">panic</a></li>
<li><a href="#L94">pushfuncname</a></li>
<li><a href="#L73">pushglobalfuncname</a></li>
<li><a href="#L607">skipBOM</a></li>
<li><a href="#L628">skipcomment</a></li>
<li><a href="#L194">tag_error</a></li>
<li><a href="#L180">typeerror</a></li>
</ul>
 <h4>Macros defined</h4>
 <ul>
<li><a href="#L36">LEVELS1</a></li>
<li><a href="#L37">LEVELS2</a></li>
<li><a href="#L8">LUA_LIB</a></li>
<li><a href="#L442">buffonstack</a></li>
<li><a href="#L530">freelist</a></li>
<li><a href="#L250">l_inspectstat</a></li>
<li><a href="#L256">l_inspectstat</a></li>
<li><a href="#L7">lauxlib_c</a></li>
</ul>
 <h4>Source code</h4>

  <code><ol><li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** $Id: lauxlib.c,v 1.279 2014/12/14 18:32:26 roberto Exp $<br/></li>
<li></span><span class="Comment">** Auxiliary functions for building Lua libraries<br/></li>
<li></span><span class="Comment">** See Copyright Notice in lua.h<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li></span><br/></li>
<li><a id="L7">&#x200c;</a><span class="PreProc">#define <span class="linkable">lauxlib_c</span><br/></li>
<li><a id="L8">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">LUA_LIB</span><br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;lprefix.h&quot;<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;errno.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;stdarg.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;stdio.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;stdlib.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;string.h&gt;<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Comment">/* This file uses only the official API of Lua.<br/></li>
<li></span><span class="Comment">** Any function declared here could be written as an application function.<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;lua.h&quot;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;lauxlib.h&quot;<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** {======================================================<br/></li>
<li></span><span class="Comment">** Traceback<br/></li>
<li></span><span class="Comment">** =======================================================<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><a id="L36">&#x200c;</a><span class="PreProc">#define <span class="linkable">LEVELS1</span>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">12</span><span class="PreProc">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Comment">/* size of the first part of the stack */<br/></li>
<li><a id="L37">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">LEVELS2</span>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">10</span><span class="PreProc">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Comment">/* size of the second part of the stack */<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** search for 'objidx' in table at index -1.<br/></li>
<li></span><span class="Comment">** return 1 + string at top if find a good name.<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L45">&#x200c;</a></span><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">findfield</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">int</span> objidx, <span class="Type">int</span> level) {<br/></li>
<li>&nbsp; <span class="Statement">if</span> (level == <span class="Constant">0</span> || !<a href="lua.h.html#L351" title="lua.h:351">lua_istable</a>(L, -<span class="Constant">1</span>))<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;&nbsp; <span class="Comment">/* not found */<br/></li>
<li></span>&nbsp; <a href="lapi.c.html#L448" title="lapi.c:448">lua_pushnil</a>(L);&nbsp; <span class="Comment">/* start '<a href="llex.c.html#L31" title="llex.c:31">next</a>' loop */<br/></li>
<li></span>&nbsp; <span class="Statement">while</span> (<a href="lapi.c.html#L1094" title="lapi.c:1094">lua_next</a>(L, -<span class="Constant">2</span>)) {&nbsp; <span class="Comment">/* for each pair in table */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="lapi.c.html#L250" title="lapi.c:250">lua_type</a>(L, -<span class="Constant">2</span>) == <a href="lua.h.html#L66" title="lua.h:66">LUA_TSTRING</a>) {&nbsp; <span class="Comment">/* ignore non-string keys */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="lapi.c.html#L294" title="lapi.c:294">lua_rawequal</a>(L, objidx, -<span class="Constant">1</span>)) {&nbsp; <span class="Comment">/* found object? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lua.h.html#L342" title="lua.h:342">lua_pop</a>(L, <span class="Constant">1</span>);&nbsp; <span class="Comment">/* remove value (but keep name) */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (<a href="#L45" title="lauxlib.c:45">findfield</a>(L, objidx, level - <span class="Constant">1</span>)) {&nbsp; <span class="Comment">/* try recursively */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lua.h.html#L370" title="lua.h:370">lua_remove</a>(L, -<span class="Constant">2</span>);&nbsp; <span class="Comment">/* remove table (but keep name) */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lua.h.html#L359" title="lua.h:359">lua_pushliteral</a>(L, <span class="Constant">&quot;.&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lua.h.html#L368" title="lua.h:368">lua_insert</a>(L, -<span class="Constant">2</span>);&nbsp; <span class="Comment">/* place '.' between the two names */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lapi.c.html#L1111" title="lapi.c:1111">lua_concat</a>(L, <span class="Constant">3</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <a href="lua.h.html#L342" title="lua.h:342">lua_pop</a>(L, <span class="Constant">1</span>);&nbsp; <span class="Comment">/* remove value */<br/></li>
<li></span>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;&nbsp; <span class="Comment">/* not found */<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** Search for a name for a function in all loaded modules<br/></li>
<li></span><span class="Comment">** (registry._LOADED).<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L73">&#x200c;</a></span><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">pushglobalfuncname</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <a href="lua.h.html#L440" title="lua.h:440">lua_Debug</a> *ar) {<br/></li>
<li>&nbsp; <span class="Type">int</span> top = <a href="lapi.c.html#L166" title="lapi.c:166">lua_gettop</a>(L);<br/></li>
<li>&nbsp; <a href="ldebug.c.html#L267" title="ldebug.c:267">lua_getinfo</a>(L, <span class="Constant">&quot;f&quot;</span>, ar);&nbsp; <span class="Comment">/* push function */<br/></li>
<li></span>&nbsp; <a href="lapi.c.html#L603" title="lapi.c:603">lua_getfield</a>(L, <a href="lua.h.html#L40" title="lua.h:40">LUA_REGISTRYINDEX</a>, <span class="Constant">&quot;_LOADED&quot;</span>);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="#L45" title="lauxlib.c:45">findfield</a>(L, top + <span class="Constant">1</span>, <span class="Constant">2</span>)) {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span> *name = <a href="lua.h.html#L365" title="lua.h:365">lua_tostring</a>(L, -<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (strncmp(name, <span class="Constant">&quot;_G.&quot;</span>, <span class="Constant">3</span>) == <span class="Constant">0</span>) {&nbsp; <span class="Comment">/* name start with '_G.'? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <a href="lapi.c.html#L484" title="lapi.c:484">lua_pushstring</a>(L, name + <span class="Constant">3</span>);&nbsp; <span class="Comment">/* push name without prefix */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <a href="lua.h.html#L370" title="lua.h:370">lua_remove</a>(L, -<span class="Constant">2</span>);&nbsp; <span class="Comment">/* remove original name */<br/></li>
<li></span>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <a href="lapi.c.html#L221" title="lapi.c:221">lua_copy</a>(L, -<span class="Constant">1</span>, top + <span class="Constant">1</span>);&nbsp; <span class="Comment">/* move name to proper place */<br/></li>
<li></span>&nbsp; &nbsp; <a href="lua.h.html#L342" title="lua.h:342">lua_pop</a>(L, <span class="Constant">2</span>);&nbsp; <span class="Comment">/* remove pushed values */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">1</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; <a href="lapi.c.html#L171" title="lapi.c:171">lua_settop</a>(L, top);&nbsp; <span class="Comment">/* remove function and global table */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L94">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">pushfuncname</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <a href="lua.h.html#L440" title="lua.h:440">lua_Debug</a> *ar) {<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="#L73" title="lauxlib.c:73">pushglobalfuncname</a>(L, ar)) {&nbsp; <span class="Comment">/* try first a global name */<br/></li>
<li></span>&nbsp; &nbsp; <a href="lapi.c.html#L513" title="lapi.c:513">lua_pushfstring</a>(L, <span class="Constant">&quot;function '</span><span class="Special">%s</span><span class="Constant">'&quot;</span>, <a href="lua.h.html#L365" title="lua.h:365">lua_tostring</a>(L, -<span class="Constant">1</span>));<br/></li>
<li>&nbsp; &nbsp; <a href="lua.h.html#L370" title="lua.h:370">lua_remove</a>(L, -<span class="Constant">2</span>);&nbsp; <span class="Comment">/* remove name */<br/></li>
<li></span>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (*ar-&gt;namewhat != <span class="Special">'\0'</span>)&nbsp; <span class="Comment">/* is there a name from code? */<br/></li>
<li></span>&nbsp; &nbsp; <a href="lapi.c.html#L513" title="lapi.c:513">lua_pushfstring</a>(L, <span class="Constant">&quot;</span><span class="Special">%s</span><span class="Constant"> '</span><span class="Special">%s</span><span class="Constant">'&quot;</span>, ar-&gt;namewhat, ar-&gt;name);&nbsp; <span class="Comment">/* use it */<br/></li>
<li></span>&nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (*ar-&gt;what == <span class="Constant">'m'</span>)&nbsp; <span class="Comment">/* <a href="lua.c.html#L595" title="lua.c:595">main</a>? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <a href="lua.h.html#L359" title="lua.h:359">lua_pushliteral</a>(L, <span class="Constant">&quot;<a href="lua.c.html#L595" title="lua.c:595">main</a> chunk&quot;</span>);<br/></li>
<li>&nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (*ar-&gt;what != <span class="Constant">'C'</span>)&nbsp; <span class="Comment">/* for Lua functions, use &lt;file:line&gt; */<br/></li>
<li></span>&nbsp; &nbsp; <a href="lapi.c.html#L513" title="lapi.c:513">lua_pushfstring</a>(L, <span class="Constant">&quot;function &lt;</span><span class="Special">%s</span><span class="Constant">:</span><span class="Special">%d</span><span class="Constant">&gt;&quot;</span>, ar-&gt;short_src, ar-&gt;linedefined);<br/></li>
<li>&nbsp; <span class="Statement">else</span>&nbsp; <span class="Comment">/* nothing left... */<br/></li>
<li></span>&nbsp; &nbsp; <a href="lua.h.html#L359" title="lua.h:359">lua_pushliteral</a>(L, <span class="Constant">&quot;?&quot;</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L110">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">countlevels</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <a href="lua.h.html#L440" title="lua.h:440">lua_Debug</a> ar;<br/></li>
<li>&nbsp; <span class="Type">int</span> li = <span class="Constant">1</span>, le = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; <span class="Comment">/* find an upper bound */<br/></li>
<li></span>&nbsp; <span class="Statement">while</span> (<a href="ldebug.c.html#L83" title="ldebug.c:83">lua_getstack</a>(L, le, &amp;ar)) { li = le; le *= <span class="Constant">2</span>; }<br/></li>
<li>&nbsp; <span class="Comment">/* do a binary search */<br/></li>
<li></span>&nbsp; <span class="Statement">while</span> (li &lt; le) {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span> m = (li + le)/<span class="Constant">2</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="ldebug.c.html#L83" title="ldebug.c:83">lua_getstack</a>(L, m, &amp;ar)) li = m + <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else</span> le = m;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> le - <span class="Constant">1</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L125">&#x200c;</a><a href="luaconf.h.html#L235" title="luaconf.h:235">LUALIB_API</a> <span class="Type">void</span> <span class="linkable">luaL_traceback</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L1,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span> *msg, <span class="Type">int</span> level) {<br/></li>
<li>&nbsp; <a href="lua.h.html#L440" title="lua.h:440">lua_Debug</a> ar;<br/></li>
<li>&nbsp; <span class="Type">int</span> top = <a href="lapi.c.html#L166" title="lapi.c:166">lua_gettop</a>(L);<br/></li>
<li>&nbsp; <span class="Type">int</span> numlevels = <a href="#L110" title="lauxlib.c:110">countlevels</a>(L1);<br/></li>
<li>&nbsp; <span class="Type">int</span> mark = (numlevels &gt; <a href="#L36" title="lauxlib.c:36">LEVELS1</a> + <a href="#L37" title="lauxlib.c:37">LEVELS2</a>) ? <a href="#L36" title="lauxlib.c:36">LEVELS1</a> : <span class="Constant">0</span>;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (msg) <a href="lapi.c.html#L513" title="lapi.c:513">lua_pushfstring</a>(L, <span class="Constant">&quot;</span><span class="Special">%s\n</span><span class="Constant">&quot;</span>, msg);<br/></li>
<li>&nbsp; <a href="lua.h.html#L359" title="lua.h:359">lua_pushliteral</a>(L, <span class="Constant">&quot;stack traceback:&quot;</span>);<br/></li>
<li>&nbsp; <span class="Statement">while</span> (<a href="ldebug.c.html#L83" title="ldebug.c:83">lua_getstack</a>(L1, level++, &amp;ar)) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (level == mark) {&nbsp; <span class="Comment">/* too many levels? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <a href="lua.h.html#L359" title="lua.h:359">lua_pushliteral</a>(L, <span class="Constant">&quot;</span><span class="Special">\n\t</span><span class="Constant">...&quot;</span>);&nbsp; <span class="Comment">/* add a '...' */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; level = numlevels - <a href="#L37" title="lauxlib.c:37">LEVELS2</a>;&nbsp; <span class="Comment">/* and skip to last ones */<br/></li>
<li></span>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="ldebug.c.html#L267" title="ldebug.c:267">lua_getinfo</a>(L1, <span class="Constant">&quot;Slnt&quot;</span>, &amp;ar);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="lapi.c.html#L513" title="lapi.c:513">lua_pushfstring</a>(L, <span class="Constant">&quot;</span><span class="Special">\n\t%s</span><span class="Constant">:&quot;</span>, ar.short_src);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ar.<a href="ldebug.c.html#L46" title="ldebug.c:46">currentline</a> &gt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lapi.c.html#L513" title="lapi.c:513">lua_pushfstring</a>(L, <span class="Constant">&quot;</span><span class="Special">%d</span><span class="Constant">:&quot;</span>, ar.<a href="ldebug.c.html#L46" title="ldebug.c:46">currentline</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="lua.h.html#L359" title="lua.h:359">lua_pushliteral</a>(L, <span class="Constant">&quot; in &quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L94" title="lauxlib.c:94">pushfuncname</a>(L, &amp;ar);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ar.istailcall)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lua.h.html#L359" title="lua.h:359">lua_pushliteral</a>(L, <span class="Constant">&quot;</span><span class="Special">\n\t</span><span class="Constant">(...tail calls...)&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="lapi.c.html#L1111" title="lapi.c:1111">lua_concat</a>(L, <a href="lapi.c.html#L166" title="lapi.c:166">lua_gettop</a>(L) - top);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <a href="lapi.c.html#L1111" title="lapi.c:1111">lua_concat</a>(L, <a href="lapi.c.html#L166" title="lapi.c:166">lua_gettop</a>(L) - top);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* }====================================================== */<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** {======================================================<br/></li>
<li></span><span class="Comment">** Error-<a href="lua.c.html#L166" title="lua.c:166">report</a> functions<br/></li>
<li></span><span class="Comment">** =======================================================<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li></span><br/></li>
<li><a id="L162">&#x200c;</a><a href="luaconf.h.html#L235" title="luaconf.h:235">LUALIB_API</a> <span class="Type">int</span> <span class="linkable">luaL_argerror</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">int</span> arg, <span class="Type">const</span> <span class="Type">char</span> *extramsg) {<br/></li>
<li>&nbsp; <a href="lua.h.html#L440" title="lua.h:440">lua_Debug</a> ar;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (!<a href="ldebug.c.html#L83" title="ldebug.c:83">lua_getstack</a>(L, <span class="Constant">0</span>, &amp;ar))&nbsp; <span class="Comment">/* no stack frame? */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L212" title="lauxlib.c:212">luaL_error</a>(L, <span class="Constant">&quot;bad argument #</span><span class="Special">%d</span><span class="Constant"> (</span><span class="Special">%s</span><span class="Constant">)&quot;</span>, arg, extramsg);<br/></li>
<li>&nbsp; <a href="ldebug.c.html#L267" title="ldebug.c:267">lua_getinfo</a>(L, <span class="Constant">&quot;n&quot;</span>, &amp;ar);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (strcmp(ar.namewhat, <span class="Constant">&quot;method&quot;</span>) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; arg--;&nbsp; <span class="Comment">/* do not count 'self' */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (arg == <span class="Constant">0</span>)&nbsp; <span class="Comment">/* <a href="lundump.c.html#L40" title="lundump.c:40">error</a> is in the self argument itself? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L212" title="lauxlib.c:212">luaL_error</a>(L, <span class="Constant">&quot;calling '</span><span class="Special">%s</span><span class="Constant">' on bad self (</span><span class="Special">%s</span><span class="Constant">)&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ar.name, extramsg);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">if</span> (ar.name == <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; ar.name = (<a href="#L73" title="lauxlib.c:73">pushglobalfuncname</a>(L, &amp;ar)) ? <a href="lua.h.html#L365" title="lua.h:365">lua_tostring</a>(L, -<span class="Constant">1</span>) : <span class="Constant">&quot;?&quot;</span>;<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="#L212" title="lauxlib.c:212">luaL_error</a>(L, <span class="Constant">&quot;bad argument #</span><span class="Special">%d</span><span class="Constant"> to '</span><span class="Special">%s</span><span class="Constant">' (</span><span class="Special">%s</span><span class="Constant">)&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; arg, ar.name, extramsg);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L180">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">typeerror</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">int</span> arg, <span class="Type">const</span> <span class="Type">char</span> *tname) {<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">char</span> *msg;<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">char</span> *typearg;&nbsp; <span class="Comment">/* name for the type of the actual argument */<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (<a href="#L710" title="lauxlib.c:710">luaL_getmetafield</a>(L, arg, <span class="Constant">&quot;__name&quot;</span>) == <a href="lua.h.html#L66" title="lua.h:66">LUA_TSTRING</a>)<br/></li>
<li>&nbsp; &nbsp; typearg = <a href="lua.h.html#L365" title="lua.h:365">lua_tostring</a>(L, -<span class="Constant">1</span>);&nbsp; <span class="Comment">/* use the given type name */<br/></li>
<li></span>&nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (<a href="lapi.c.html#L250" title="lapi.c:250">lua_type</a>(L, arg) == <a href="lua.h.html#L64" title="lua.h:64">LUA_TLIGHTUSERDATA</a>)<br/></li>
<li>&nbsp; &nbsp; typearg = <span class="Constant">&quot;light userdata&quot;</span>;&nbsp; <span class="Comment">/* special name for messages */<br/></li>
<li></span>&nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; typearg = <a href="lauxlib.h.html#L119" title="lauxlib.h:119">luaL_typename</a>(L, arg);&nbsp; <span class="Comment">/* standard name */<br/></li>
<li></span>&nbsp; msg = <a href="lapi.c.html#L513" title="lapi.c:513">lua_pushfstring</a>(L, <span class="Constant">&quot;</span><span class="Special">%s</span><span class="Constant"> expected, got </span><span class="Special">%s</span><span class="Constant">&quot;</span>, tname, typearg);<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="#L162" title="lauxlib.c:162">luaL_argerror</a>(L, arg, msg);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L194">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">tag_error</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">int</span> arg, <span class="Type">int</span> tag) {<br/></li>
<li>&nbsp; <a href="#L180" title="lauxlib.c:180">typeerror</a>(L, arg, <a href="lapi.c.html#L256" title="lapi.c:256">lua_typename</a>(L, tag));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L199">&#x200c;</a><a href="luaconf.h.html#L235" title="luaconf.h:235">LUALIB_API</a> <span class="Type">void</span> <span class="linkable">luaL_where</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">int</span> level) {<br/></li>
<li>&nbsp; <a href="lua.h.html#L440" title="lua.h:440">lua_Debug</a> ar;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="ldebug.c.html#L83" title="ldebug.c:83">lua_getstack</a>(L, level, &amp;ar)) {&nbsp; <span class="Comment">/* <a href="lparser.c.html#L106" title="lparser.c:106">check</a> function at level */<br/></li>
<li></span>&nbsp; &nbsp; <a href="ldebug.c.html#L267" title="ldebug.c:267">lua_getinfo</a>(L, <span class="Constant">&quot;Sl&quot;</span>, &amp;ar);&nbsp; <span class="Comment">/* get info about it */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (ar.<a href="ldebug.c.html#L46" title="ldebug.c:46">currentline</a> &gt; <span class="Constant">0</span>) {&nbsp; <span class="Comment">/* is there info? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <a href="lapi.c.html#L513" title="lapi.c:513">lua_pushfstring</a>(L, <span class="Constant">&quot;</span><span class="Special">%s</span><span class="Constant">:</span><span class="Special">%d</span><span class="Constant">: &quot;</span>, ar.short_src, ar.<a href="ldebug.c.html#L46" title="ldebug.c:46">currentline</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <a href="lua.h.html#L359" title="lua.h:359">lua_pushliteral</a>(L, <span class="Constant">&quot;&quot;</span>);&nbsp; <span class="Comment">/* else, no information available... */<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L212">&#x200c;</a><a href="luaconf.h.html#L235" title="luaconf.h:235">LUALIB_API</a> <span class="Type">int</span> <span class="linkable">luaL_error</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">const</span> <span class="Type">char</span> *fmt, ...) {<br/></li>
<li>&nbsp; <span class="Type">va_list</span> argp;<br/></li>
<li>&nbsp; va_start(argp, fmt);<br/></li>
<li>&nbsp; <a href="#L199" title="lauxlib.c:199">luaL_where</a>(L, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; <a href="lapi.c.html#L502" title="lapi.c:502">lua_pushvfstring</a>(L, fmt, argp);<br/></li>
<li>&nbsp; va_end(argp);<br/></li>
<li>&nbsp; <a href="lapi.c.html#L1111" title="lapi.c:1111">lua_concat</a>(L, <span class="Constant">2</span>);<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="lapi.c.html#L1085" title="lapi.c:1085">lua_error</a>(L);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L223">&#x200c;</a><a href="luaconf.h.html#L235" title="luaconf.h:235">LUALIB_API</a> <span class="Type">int</span> <span class="linkable">luaL_fileresult</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">int</span> stat, <span class="Type">const</span> <span class="Type">char</span> *fname) {<br/></li>
<li>&nbsp; <span class="Type">int</span> en = errno;&nbsp; <span class="Comment">/* calls to Lua API may change this value */<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (stat) {<br/></li>
<li>&nbsp; &nbsp; <a href="lapi.c.html#L550" title="lapi.c:550">lua_pushboolean</a>(L, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">1</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; <a href="lapi.c.html#L448" title="lapi.c:448">lua_pushnil</a>(L);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (fname)<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="lapi.c.html#L513" title="lapi.c:513">lua_pushfstring</a>(L, <span class="Constant">&quot;</span><span class="Special">%s</span><span class="Constant">: </span><span class="Special">%s</span><span class="Constant">&quot;</span>, fname, strerror(en));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <a href="lapi.c.html#L484" title="lapi.c:484">lua_pushstring</a>(L, strerror(en));<br/></li>
<li>&nbsp; &nbsp; <a href="lapi.c.html#L464" title="lapi.c:464">lua_pushinteger</a>(L, en);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">3</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="PreProc">#if !defined(<a href="#L250" title="lauxlib.c:250">l_inspectstat</a>)&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Comment">/* { */<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#if defined(<a href="luaconf.h.html#L62" title="luaconf.h:62">LUA_USE_POSIX</a>)<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;sys/wait.h&gt;<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** use appropriate macros to interpret 'pclose' return status<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L250">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">l_inspectstat</span>(stat,what)&nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp;&nbsp; </span><span class="Statement">if</span><span class="PreProc"> (WIFEXITED(stat)) { stat = WEXITSTATUS(stat); } \<br/></li>
<li></span><span class="PreProc">&nbsp;&nbsp; </span><span class="Statement">else</span><span class="PreProc"> </span><span class="Statement">if</span><span class="PreProc"> (WIFSIGNALED(stat)) { stat = WTERMSIG(stat); what = </span><span class="Constant">&quot;signal&quot;</span><span class="PreProc">; }<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span><br/></li>
<li><a id="L256">&#x200c;</a><span class="PreProc">#define <span class="linkable">l_inspectstat</span>(stat,what)&nbsp; </span><span class="Comment">/* no op */<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#endif</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* } */<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><a id="L263">&#x200c;</a><a href="luaconf.h.html#L235" title="luaconf.h:235">LUALIB_API</a> <span class="Type">int</span> <span class="linkable">luaL_execresult</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">int</span> stat) {<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">char</span> *what = <span class="Constant">&quot;exit&quot;</span>;&nbsp; <span class="Comment">/* type of termination */<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (stat == -<span class="Constant">1</span>)&nbsp; <span class="Comment">/* <a href="lundump.c.html#L40" title="lundump.c:40">error</a>? */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L223" title="lauxlib.c:223">luaL_fileresult</a>(L, <span class="Constant">0</span>, <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; <a href="#L250" title="lauxlib.c:250">l_inspectstat</a>(stat, what);&nbsp; <span class="Comment">/* interpret result */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (*what == <span class="Constant">'e'</span> &amp;&amp; stat == <span class="Constant">0</span>)&nbsp; <span class="Comment">/* successful termination? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <a href="lapi.c.html#L550" title="lapi.c:550">lua_pushboolean</a>(L, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <a href="lapi.c.html#L448" title="lapi.c:448">lua_pushnil</a>(L);<br/></li>
<li>&nbsp; &nbsp; <a href="lapi.c.html#L484" title="lapi.c:484">lua_pushstring</a>(L, what);<br/></li>
<li>&nbsp; &nbsp; <a href="lapi.c.html#L464" title="lapi.c:464">lua_pushinteger</a>(L, stat);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">3</span>;&nbsp; <span class="Comment">/* return true/nil,what,code */<br/></li>
<li></span>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* }====================================================== */<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** {======================================================<br/></li>
<li></span><span class="Comment">** Userdata's metatable manipulation<br/></li>
<li></span><span class="Comment">** =======================================================<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li></span><br/></li>
<li><a id="L288">&#x200c;</a><a href="luaconf.h.html#L235" title="luaconf.h:235">LUALIB_API</a> <span class="Type">int</span> <span class="linkable">luaL_newmetatable</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">const</span> <span class="Type">char</span> *tname) {<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="lauxlib.h.html#L127" title="lauxlib.h:127">luaL_getmetatable</a>(L, tname))&nbsp; <span class="Comment">/* name already in use? */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;&nbsp; <span class="Comment">/* leave previous value on top, but return 0 */<br/></li>
<li></span>&nbsp; <a href="lua.h.html#L342" title="lua.h:342">lua_pop</a>(L, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; <a href="lua.h.html#L344" title="lua.h:344">lua_newtable</a>(L);&nbsp; <span class="Comment">/* create metatable */<br/></li>
<li></span>&nbsp; <a href="lapi.c.html#L484" title="lapi.c:484">lua_pushstring</a>(L, tname);<br/></li>
<li>&nbsp; <a href="lapi.c.html#L745" title="lapi.c:745">lua_setfield</a>(L, -<span class="Constant">2</span>, <span class="Constant">&quot;__name&quot;</span>);&nbsp; <span class="Comment">/* metatable.__name = tname */<br/></li>
<li></span>&nbsp; <a href="lapi.c.html#L236" title="lapi.c:236">lua_pushvalue</a>(L, -<span class="Constant">1</span>);<br/></li>
<li>&nbsp; <a href="lapi.c.html#L745" title="lapi.c:745">lua_setfield</a>(L, <a href="lua.h.html#L40" title="lua.h:40">LUA_REGISTRYINDEX</a>, tname);&nbsp; <span class="Comment">/* registry.name = metatable */<br/></li>
<li></span>&nbsp; <span class="Statement">return</span> <span class="Constant">1</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L301">&#x200c;</a><a href="luaconf.h.html#L235" title="luaconf.h:235">LUALIB_API</a> <span class="Type">void</span> <span class="linkable">luaL_setmetatable</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">const</span> <span class="Type">char</span> *tname) {<br/></li>
<li>&nbsp; <a href="lauxlib.h.html#L127" title="lauxlib.h:127">luaL_getmetatable</a>(L, tname);<br/></li>
<li>&nbsp; <a href="lapi.c.html#L817" title="lapi.c:817">lua_setmetatable</a>(L, -<span class="Constant">2</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L307">&#x200c;</a><a href="luaconf.h.html#L235" title="luaconf.h:235">LUALIB_API</a> <span class="Type">void</span> *<span class="linkable">luaL_testudata</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">int</span> ud, <span class="Type">const</span> <span class="Type">char</span> *tname) {<br/></li>
<li>&nbsp; <span class="Type">void</span> *p = <a href="lapi.c.html#L410" title="lapi.c:410">lua_touserdata</a>(L, ud);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (p != <span class="Constant">NULL</span>) {&nbsp; <span class="Comment">/* value is a userdata? */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="lapi.c.html#L677" title="lapi.c:677">lua_getmetatable</a>(L, ud)) {&nbsp; <span class="Comment">/* does it have a metatable? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <a href="lauxlib.h.html#L127" title="lauxlib.h:127">luaL_getmetatable</a>(L, tname);&nbsp; <span class="Comment">/* get correct metatable */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!<a href="lapi.c.html#L294" title="lapi.c:294">lua_rawequal</a>(L, -<span class="Constant">1</span>, -<span class="Constant">2</span>))&nbsp; <span class="Comment">/* not the same? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; p = <span class="Constant">NULL</span>;&nbsp; <span class="Comment">/* value is a userdata with wrong metatable */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <a href="lua.h.html#L342" title="lua.h:342">lua_pop</a>(L, <span class="Constant">2</span>);&nbsp; <span class="Comment">/* remove both metatables */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span> p;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;&nbsp; <span class="Comment">/* value is not a userdata with a metatable */<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L322">&#x200c;</a><a href="luaconf.h.html#L235" title="luaconf.h:235">LUALIB_API</a> <span class="Type">void</span> *<span class="linkable">luaL_checkudata</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">int</span> ud, <span class="Type">const</span> <span class="Type">char</span> *tname) {<br/></li>
<li>&nbsp; <span class="Type">void</span> *p = <a href="#L307" title="lauxlib.c:307">luaL_testudata</a>(L, ud, tname);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (p == <span class="Constant">NULL</span>) <a href="#L180" title="lauxlib.c:180">typeerror</a>(L, ud, tname);<br/></li>
<li>&nbsp; <span class="Statement">return</span> p;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* }====================================================== */<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** {======================================================<br/></li>
<li></span><span class="Comment">** Argument <a href="lparser.c.html#L106" title="lparser.c:106">check</a> functions<br/></li>
<li></span><span class="Comment">** =======================================================<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li></span><br/></li>
<li><a id="L337">&#x200c;</a><a href="luaconf.h.html#L235" title="luaconf.h:235">LUALIB_API</a> <span class="Type">int</span> <span class="linkable">luaL_checkoption</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">int</span> arg, <span class="Type">const</span> <span class="Type">char</span> *def,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type">const</span> <span class="Type">char</span> *<span class="Type">const</span> lst[]) {<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">char</span> *name = (def) ? <a href="lauxlib.h.html#L117" title="lauxlib.h:117">luaL_optstring</a>(L, arg, def) :<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="lauxlib.h.html#L116" title="lauxlib.h:116">luaL_checkstring</a>(L, arg);<br/></li>
<li>&nbsp; <span class="Type">int</span> i;<br/></li>
<li>&nbsp; <span class="Statement">for</span> (i=<span class="Constant">0</span>; lst[i]; i++)<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (strcmp(lst[i], name) == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span> i;<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="#L162" title="lauxlib.c:162">luaL_argerror</a>(L, arg,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="lapi.c.html#L513" title="lapi.c:513">lua_pushfstring</a>(L, <span class="Constant">&quot;invalid option '</span><span class="Special">%s</span><span class="Constant">'&quot;</span>, name));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L350">&#x200c;</a><a href="luaconf.h.html#L235" title="luaconf.h:235">LUALIB_API</a> <span class="Type">void</span> <span class="linkable">luaL_checkstack</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">int</span> space, <span class="Type">const</span> <span class="Type">char</span> *msg) {<br/></li>
<li>&nbsp; <span class="Comment">/* keep some extra space to run <a href="lundump.c.html#L40" title="lundump.c:40">error</a> routines, if needed */<br/></li>
<li></span>&nbsp; <span class="Type">const</span> <span class="Type">int</span> extra = <a href="lua.h.html#L77" title="lua.h:77">LUA_MINSTACK</a>;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (!<a href="lapi.c.html#L97" title="lapi.c:97">lua_checkstack</a>(L, space + extra)) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (msg)<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L212" title="lauxlib.c:212">luaL_error</a>(L, <span class="Constant">&quot;stack overflow (</span><span class="Special">%s</span><span class="Constant">)&quot;</span>, msg);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <a href="#L212" title="lauxlib.c:212">luaL_error</a>(L, <span class="Constant">&quot;stack overflow&quot;</span>);<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L362">&#x200c;</a><a href="luaconf.h.html#L235" title="luaconf.h:235">LUALIB_API</a> <span class="Type">void</span> <span class="linkable">luaL_checktype</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">int</span> arg, <span class="Type">int</span> t) {<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="lapi.c.html#L250" title="lapi.c:250">lua_type</a>(L, arg) != t)<br/></li>
<li>&nbsp; &nbsp; <a href="#L194" title="lauxlib.c:194">tag_error</a>(L, arg, t);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L368">&#x200c;</a><a href="luaconf.h.html#L235" title="luaconf.h:235">LUALIB_API</a> <span class="Type">void</span> <span class="linkable">luaL_checkany</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">int</span> arg) {<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="lapi.c.html#L250" title="lapi.c:250">lua_type</a>(L, arg) == <a href="lua.h.html#L60" title="lua.h:60">LUA_TNONE</a>)<br/></li>
<li>&nbsp; &nbsp; <a href="#L162" title="lauxlib.c:162">luaL_argerror</a>(L, arg, <span class="Constant">&quot;value expected&quot;</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L374">&#x200c;</a><a href="luaconf.h.html#L235" title="luaconf.h:235">LUALIB_API</a> <span class="Type">const</span> <span class="Type">char</span> *<span class="linkable">luaL_checklstring</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">int</span> arg, <span class="Type">size_t</span> *len) {<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">char</span> *s = <a href="lapi.c.html#L372" title="lapi.c:372">lua_tolstring</a>(L, arg, len);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (!s) <a href="#L194" title="lauxlib.c:194">tag_error</a>(L, arg, <a href="lua.h.html#L66" title="lua.h:66">LUA_TSTRING</a>);<br/></li>
<li>&nbsp; <span class="Statement">return</span> s;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L381">&#x200c;</a><a href="luaconf.h.html#L235" title="luaconf.h:235">LUALIB_API</a> <span class="Type">const</span> <span class="Type">char</span> *<span class="linkable">luaL_optlstring</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">int</span> arg,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span> *def, <span class="Type">size_t</span> *len) {<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="lua.h.html#L357" title="lua.h:357">lua_isnoneornil</a>(L, arg)) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (len)<br/></li>
<li>&nbsp; &nbsp; &nbsp; *len = (def ? strlen(def) : <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> def;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">else</span> <span class="Statement">return</span> <a href="#L374" title="lauxlib.c:374">luaL_checklstring</a>(L, arg, len);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L392">&#x200c;</a><a href="luaconf.h.html#L235" title="luaconf.h:235">LUALIB_API</a> <a href="lua.h.html#L87" title="lua.h:87">lua_Number</a> <span class="linkable">luaL_checknumber</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">int</span> arg) {<br/></li>
<li>&nbsp; <span class="Type">int</span> isnum;<br/></li>
<li>&nbsp; <a href="lua.h.html#L87" title="lua.h:87">lua_Number</a> d = <a href="lapi.c.html#L344" title="lapi.c:344">lua_tonumberx</a>(L, arg, &amp;isnum);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (!isnum)<br/></li>
<li>&nbsp; &nbsp; <a href="#L194" title="lauxlib.c:194">tag_error</a>(L, arg, <a href="lua.h.html#L65" title="lua.h:65">LUA_TNUMBER</a>);<br/></li>
<li>&nbsp; <span class="Statement">return</span> d;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L401">&#x200c;</a><a href="luaconf.h.html#L235" title="luaconf.h:235">LUALIB_API</a> <a href="lua.h.html#L87" title="lua.h:87">lua_Number</a> <span class="linkable">luaL_optnumber</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">int</span> arg, <a href="lua.h.html#L87" title="lua.h:87">lua_Number</a> def) {<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="lauxlib.h.html#L129" title="lauxlib.h:129">luaL_opt</a>(L, <a href="#L392" title="lauxlib.c:392">luaL_checknumber</a>, arg, def);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L406">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">interror</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">int</span> arg) {<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="lapi.c.html#L275" title="lapi.c:275">lua_isnumber</a>(L, arg))<br/></li>
<li>&nbsp; &nbsp; <a href="#L162" title="lauxlib.c:162">luaL_argerror</a>(L, arg, <span class="Constant">&quot;number has no integer representation&quot;</span>);<br/></li>
<li>&nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L194" title="lauxlib.c:194">tag_error</a>(L, arg, <a href="lua.h.html#L65" title="lua.h:65">LUA_TNUMBER</a>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L414">&#x200c;</a><a href="luaconf.h.html#L235" title="luaconf.h:235">LUALIB_API</a> <a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a> <span class="linkable">luaL_checkinteger</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">int</span> arg) {<br/></li>
<li>&nbsp; <span class="Type">int</span> isnum;<br/></li>
<li>&nbsp; <a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a> d = <a href="lapi.c.html#L355" title="lapi.c:355">lua_tointegerx</a>(L, arg, &amp;isnum);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (!isnum) {<br/></li>
<li>&nbsp; &nbsp; <a href="#L406" title="lauxlib.c:406">interror</a>(L, arg);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> d;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L424">&#x200c;</a><a href="luaconf.h.html#L235" title="luaconf.h:235">LUALIB_API</a> <a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a> <span class="linkable">luaL_optinteger</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">int</span> arg,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a> def) {<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="lauxlib.h.html#L129" title="lauxlib.h:129">luaL_opt</a>(L, <a href="#L414" title="lauxlib.c:414">luaL_checkinteger</a>, arg, def);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* }====================================================== */<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** {======================================================<br/></li>
<li></span><span class="Comment">** Generic Buffer manipulation<br/></li>
<li></span><span class="Comment">** =======================================================<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** <a href="lparser.c.html#L106" title="lparser.c:106">check</a> whether buffer is using a userdata on the stack as a temporary<br/></li>
<li></span><span class="Comment">** buffer<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L442">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">buffonstack</span>(B)&nbsp; &nbsp; &nbsp; &nbsp; ((B)-&gt;b != (B)-&gt;initb)<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** returns a pointer to a free area with at least 'sz' bytes<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L448">&#x200c;</a></span><a href="luaconf.h.html#L235" title="luaconf.h:235">LUALIB_API</a> <span class="Type">char</span> *<span class="linkable">luaL_prepbuffsize</span> (<a href="lauxlib.h.html#L140" title="lauxlib.h:140">luaL_Buffer</a> *B, <span class="Type">size_t</span> sz) {<br/></li>
<li>&nbsp; <a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L = B-&gt;L;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (B-&gt;size - B-&gt;n &lt; sz) {&nbsp; <span class="Comment">/* not enough space? */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">char</span> *newbuff;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span> newsize = B-&gt;size * <span class="Constant">2</span>;&nbsp; <span class="Comment">/* double buffer size */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (newsize - B-&gt;n &lt; sz)&nbsp; <span class="Comment">/* not big enough? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; newsize = B-&gt;n + sz;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (newsize &lt; B-&gt;n || newsize - B-&gt;n &lt; sz)<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L212" title="lauxlib.c:212">luaL_error</a>(L, <span class="Constant">&quot;buffer too large&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* create larger buffer */<br/></li>
<li></span>&nbsp; &nbsp; newbuff = (<span class="Type">char</span> *)<a href="lapi.c.html#L1155" title="lapi.c:1155">lua_newuserdata</a>(L, newsize * <span class="Statement">sizeof</span>(<span class="Type">char</span>));<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* move content to new buffer */<br/></li>
<li></span>&nbsp; &nbsp; memcpy(newbuff, B-&gt;b, B-&gt;n * <span class="Statement">sizeof</span>(<span class="Type">char</span>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L442" title="lauxlib.c:442">buffonstack</a>(B))<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="lua.h.html#L370" title="lua.h:370">lua_remove</a>(L, -<span class="Constant">2</span>);&nbsp; <span class="Comment">/* remove old buffer */<br/></li>
<li></span>&nbsp; &nbsp; B-&gt;b = newbuff;<br/></li>
<li>&nbsp; &nbsp; B-&gt;size = newsize;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> &amp;B-&gt;b[B-&gt;n];<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L470">&#x200c;</a><a href="luaconf.h.html#L235" title="luaconf.h:235">LUALIB_API</a> <span class="Type">void</span> <span class="linkable">luaL_addlstring</span> (<a href="lauxlib.h.html#L140" title="lauxlib.h:140">luaL_Buffer</a> *B, <span class="Type">const</span> <span class="Type">char</span> *s, <span class="Type">size_t</span> l) {<br/></li>
<li>&nbsp; <span class="Type">char</span> *b = <a href="#L448" title="lauxlib.c:448">luaL_prepbuffsize</a>(B, l);<br/></li>
<li>&nbsp; memcpy(b, s, l * <span class="Statement">sizeof</span>(<span class="Type">char</span>));<br/></li>
<li>&nbsp; <a href="lauxlib.h.html#L153" title="lauxlib.h:153">luaL_addsize</a>(B, l);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L477">&#x200c;</a><a href="luaconf.h.html#L235" title="luaconf.h:235">LUALIB_API</a> <span class="Type">void</span> <span class="linkable">luaL_addstring</span> (<a href="lauxlib.h.html#L140" title="lauxlib.h:140">luaL_Buffer</a> *B, <span class="Type">const</span> <span class="Type">char</span> *s) {<br/></li>
<li>&nbsp; <a href="#L470" title="lauxlib.c:470">luaL_addlstring</a>(B, s, strlen(s));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L482">&#x200c;</a><a href="luaconf.h.html#L235" title="luaconf.h:235">LUALIB_API</a> <span class="Type">void</span> <span class="linkable">luaL_pushresult</span> (<a href="lauxlib.h.html#L140" title="lauxlib.h:140">luaL_Buffer</a> *B) {<br/></li>
<li>&nbsp; <a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L = B-&gt;L;<br/></li>
<li>&nbsp; <a href="lapi.c.html#L472" title="lapi.c:472">lua_pushlstring</a>(L, B-&gt;b, B-&gt;n);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="#L442" title="lauxlib.c:442">buffonstack</a>(B))<br/></li>
<li>&nbsp; &nbsp; <a href="lua.h.html#L370" title="lua.h:370">lua_remove</a>(L, -<span class="Constant">2</span>);&nbsp; <span class="Comment">/* remove old buffer */<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L490">&#x200c;</a><a href="luaconf.h.html#L235" title="luaconf.h:235">LUALIB_API</a> <span class="Type">void</span> <span class="linkable">luaL_pushresultsize</span> (<a href="lauxlib.h.html#L140" title="lauxlib.h:140">luaL_Buffer</a> *B, <span class="Type">size_t</span> sz) {<br/></li>
<li>&nbsp; <a href="lauxlib.h.html#L153" title="lauxlib.h:153">luaL_addsize</a>(B, sz);<br/></li>
<li>&nbsp; <a href="#L482" title="lauxlib.c:482">luaL_pushresult</a>(B);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L496">&#x200c;</a><a href="luaconf.h.html#L235" title="luaconf.h:235">LUALIB_API</a> <span class="Type">void</span> <span class="linkable">luaL_addvalue</span> (<a href="lauxlib.h.html#L140" title="lauxlib.h:140">luaL_Buffer</a> *B) {<br/></li>
<li>&nbsp; <a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L = B-&gt;L;<br/></li>
<li>&nbsp; <span class="Type">size_t</span> l;<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">char</span> *s = <a href="lapi.c.html#L372" title="lapi.c:372">lua_tolstring</a>(L, -<span class="Constant">1</span>, &amp;l);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="#L442" title="lauxlib.c:442">buffonstack</a>(B))<br/></li>
<li>&nbsp; &nbsp; <a href="lua.h.html#L368" title="lua.h:368">lua_insert</a>(L, -<span class="Constant">2</span>);&nbsp; <span class="Comment">/* put value below buffer */<br/></li>
<li></span>&nbsp; <a href="#L470" title="lauxlib.c:470">luaL_addlstring</a>(B, s, l);<br/></li>
<li>&nbsp; <a href="lua.h.html#L370" title="lua.h:370">lua_remove</a>(L, (<a href="#L442" title="lauxlib.c:442">buffonstack</a>(B)) ? -<span class="Constant">2</span> : -<span class="Constant">1</span>);&nbsp; <span class="Comment">/* remove value */<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L507">&#x200c;</a><a href="luaconf.h.html#L235" title="luaconf.h:235">LUALIB_API</a> <span class="Type">void</span> <span class="linkable">luaL_buffinit</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <a href="lauxlib.h.html#L140" title="lauxlib.h:140">luaL_Buffer</a> *B) {<br/></li>
<li>&nbsp; B-&gt;L = L;<br/></li>
<li>&nbsp; B-&gt;b = B-&gt;initb;<br/></li>
<li>&nbsp; B-&gt;n = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; B-&gt;size = <a href="luaconf.h.html#L707" title="luaconf.h:707">LUAL_BUFFERSIZE</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L515">&#x200c;</a><a href="luaconf.h.html#L235" title="luaconf.h:235">LUALIB_API</a> <span class="Type">char</span> *<span class="linkable">luaL_buffinitsize</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <a href="lauxlib.h.html#L140" title="lauxlib.h:140">luaL_Buffer</a> *B, <span class="Type">size_t</span> sz) {<br/></li>
<li>&nbsp; <a href="#L507" title="lauxlib.c:507">luaL_buffinit</a>(L, B);<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="#L448" title="lauxlib.c:448">luaL_prepbuffsize</a>(B, sz);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* }====================================================== */<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** {======================================================<br/></li>
<li></span><span class="Comment">** Reference system<br/></li>
<li></span><span class="Comment">** =======================================================<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li></span><br/></li>
<li><span class="Comment">/* index of free-list header */<br/></li>
<li><a id="L530">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">freelist</span>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">0<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><a id="L533">&#x200c;</a><a href="luaconf.h.html#L235" title="luaconf.h:235">LUALIB_API</a> <span class="Type">int</span> <span class="linkable">luaL_ref</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">int</span> t) {<br/></li>
<li>&nbsp; <span class="Type">int</span> ref;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="lua.h.html#L353" title="lua.h:353">lua_isnil</a>(L, -<span class="Constant">1</span>)) {<br/></li>
<li>&nbsp; &nbsp; <a href="lua.h.html#L342" title="lua.h:342">lua_pop</a>(L, <span class="Constant">1</span>);&nbsp; <span class="Comment">/* remove from stack */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">return</span> <a href="lauxlib.h.html#L70" title="lauxlib.h:70">LUA_REFNIL</a>;&nbsp; <span class="Comment">/* 'nil' has a unique fixed reference */<br/></li>
<li></span>&nbsp; }<br/></li>
<li>&nbsp; t = <a href="lapi.c.html#L159" title="lapi.c:159">lua_absindex</a>(L, t);<br/></li>
<li>&nbsp; <a href="lapi.c.html#L638" title="lapi.c:638">lua_rawgeti</a>(L, t, <a href="#L530" title="lauxlib.c:530">freelist</a>);&nbsp; <span class="Comment">/* get first free element */<br/></li>
<li></span>&nbsp; ref = (<span class="Type">int</span>)<a href="lua.h.html#L340" title="lua.h:340">lua_tointeger</a>(L, -<span class="Constant">1</span>);&nbsp; <span class="Comment">/* ref = t[<a href="#L530" title="lauxlib.c:530">freelist</a>] */<br/></li>
<li></span>&nbsp; <a href="lua.h.html#L342" title="lua.h:342">lua_pop</a>(L, <span class="Constant">1</span>);&nbsp; <span class="Comment">/* remove it from stack */<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (ref != <span class="Constant">0</span>) {&nbsp; <span class="Comment">/* any free element? */<br/></li>
<li></span>&nbsp; &nbsp; <a href="lapi.c.html#L638" title="lapi.c:638">lua_rawgeti</a>(L, t, ref);&nbsp; <span class="Comment">/* remove it from list */<br/></li>
<li></span>&nbsp; &nbsp; <a href="lapi.c.html#L785" title="lapi.c:785">lua_rawseti</a>(L, t, <a href="#L530" title="lauxlib.c:530">freelist</a>);&nbsp; <span class="Comment">/* (t[<a href="#L530" title="lauxlib.c:530">freelist</a>] = t[ref]) */<br/></li>
<li></span>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">else</span>&nbsp; <span class="Comment">/* no free elements */<br/></li>
<li></span>&nbsp; &nbsp; ref = (<span class="Type">int</span>)<a href="lapi.c.html#L390" title="lapi.c:390">lua_rawlen</a>(L, t) + <span class="Constant">1</span>;&nbsp; <span class="Comment">/* get a new reference */<br/></li>
<li></span>&nbsp; <a href="lapi.c.html#L785" title="lapi.c:785">lua_rawseti</a>(L, t, ref);<br/></li>
<li>&nbsp; <span class="Statement">return</span> ref;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L554">&#x200c;</a><a href="luaconf.h.html#L235" title="luaconf.h:235">LUALIB_API</a> <span class="Type">void</span> <span class="linkable">luaL_unref</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">int</span> t, <span class="Type">int</span> ref) {<br/></li>
<li>&nbsp; <span class="Statement">if</span> (ref &gt;= <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; t = <a href="lapi.c.html#L159" title="lapi.c:159">lua_absindex</a>(L, t);<br/></li>
<li>&nbsp; &nbsp; <a href="lapi.c.html#L638" title="lapi.c:638">lua_rawgeti</a>(L, t, <a href="#L530" title="lauxlib.c:530">freelist</a>);<br/></li>
<li>&nbsp; &nbsp; <a href="lapi.c.html#L785" title="lapi.c:785">lua_rawseti</a>(L, t, ref);&nbsp; <span class="Comment">/* t[ref] = t[<a href="#L530" title="lauxlib.c:530">freelist</a>] */<br/></li>
<li></span>&nbsp; &nbsp; <a href="lapi.c.html#L464" title="lapi.c:464">lua_pushinteger</a>(L, ref);<br/></li>
<li>&nbsp; &nbsp; <a href="lapi.c.html#L785" title="lapi.c:785">lua_rawseti</a>(L, t, <a href="#L530" title="lauxlib.c:530">freelist</a>);&nbsp; <span class="Comment">/* t[<a href="#L530" title="lauxlib.c:530">freelist</a>] = ref */<br/></li>
<li></span>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* }====================================================== */<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** {======================================================<br/></li>
<li></span><span class="Comment">** Load functions<br/></li>
<li></span><span class="Comment">** =======================================================<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li></span><br/></li>
<li><a id="L573">&#x200c;</a><span class="Type">typedef</span> <span class="Type">struct</span> <span class="linkable">LoadF</span> {<br/></li>
<li>&nbsp; <span class="Type">int</span> n;&nbsp; <span class="Comment">/* number of pre-read characters */<br/></li>
<li></span>&nbsp; <span class="Type">FILE</span> *f;&nbsp; <span class="Comment">/* file being read */<br/></li>
<li></span>&nbsp; <span class="Type">char</span> buff[<span class="Constant">BUFSIZ</span>];&nbsp; <span class="Comment">/* area for reading file */<br/></li>
<li><a id="L577">&#x200c;</a></span>} <span class="linkable">LoadF</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L580">&#x200c;</a><span class="Type">static</span> <span class="Type">const</span> <span class="Type">char</span> *<span class="linkable">getF</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">void</span> *ud, <span class="Type">size_t</span> *size) {<br/></li>
<li>&nbsp; <a href="#L573" title="lauxlib.c:573">LoadF</a> *lf = (<a href="#L573" title="lauxlib.c:573">LoadF</a> *)ud;<br/></li>
<li>&nbsp; (<span class="Type">void</span>)L;&nbsp; <span class="Comment">/* not used */<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (lf-&gt;n &gt; <span class="Constant">0</span>) {&nbsp; <span class="Comment">/* are there pre-read characters to be read? */<br/></li>
<li></span>&nbsp; &nbsp; *size = lf-&gt;n;&nbsp; <span class="Comment">/* return them (chars already in buffer) */<br/></li>
<li></span>&nbsp; &nbsp; lf-&gt;n = <span class="Constant">0</span>;&nbsp; <span class="Comment">/* no more pre-read characters */<br/></li>
<li></span>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">else</span> {&nbsp; <span class="Comment">/* read a <a href="lparser.c.html#L1087" title="lparser.c:1087">block</a> from file */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">/* 'fread' can return &gt; 0 *and* set the EOF flag. If <a href="llex.c.html#L31" title="llex.c:31">next</a> call to<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp;&nbsp; '<a href="#L580" title="lauxlib.c:580">getF</a>' called 'fread', it might still wait for user input.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp;&nbsp; The <a href="llex.c.html#L31" title="llex.c:31">next</a> <a href="lparser.c.html#L106" title="lparser.c:106">check</a> avoids this problem. */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (feof(lf-&gt;f)) <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; *size = fread(lf-&gt;buff, <span class="Constant">1</span>, <span class="Statement">sizeof</span>(lf-&gt;buff), lf-&gt;f);&nbsp; <span class="Comment">/* read <a href="lparser.c.html#L1087" title="lparser.c:1087">block</a> */<br/></li>
<li></span>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> lf-&gt;buff;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L598">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">errfile</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">const</span> <span class="Type">char</span> *what, <span class="Type">int</span> fnameindex) {<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">char</span> *serr = strerror(errno);<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">char</span> *filename = <a href="lua.h.html#L365" title="lua.h:365">lua_tostring</a>(L, fnameindex) + <span class="Constant">1</span>;<br/></li>
<li>&nbsp; <a href="lapi.c.html#L513" title="lapi.c:513">lua_pushfstring</a>(L, <span class="Constant">&quot;<a href="luac.c.html#L44" title="luac.c:44">cannot</a> </span><span class="Special">%s</span><span class="Constant"> </span><span class="Special">%s</span><span class="Constant">: </span><span class="Special">%s</span><span class="Constant">&quot;</span>, what, filename, serr);<br/></li>
<li>&nbsp; <a href="lua.h.html#L370" title="lua.h:370">lua_remove</a>(L, fnameindex);<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="lauxlib.h.html#L20" title="lauxlib.h:20">LUA_ERRFILE</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L607">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">skipBOM</span> (<a href="#L573" title="lauxlib.c:573">LoadF</a> *lf) {<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">char</span> *p = <span class="Constant">&quot;</span><span class="Special">\xEF\xBB\xBF</span><span class="Constant">&quot;</span>;&nbsp; <span class="Comment">/* Utf8 BOM mark */<br/></li>
<li></span>&nbsp; <span class="Type">int</span> c;<br/></li>
<li>&nbsp; lf-&gt;n = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; <span class="Statement">do</span> {<br/></li>
<li>&nbsp; &nbsp; c = getc(lf-&gt;f);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c == <span class="Constant">EOF</span> || c != *(<span class="Type">const</span> <span class="Type">unsigned</span> <span class="Type">char</span> *)p++) <span class="Statement">return</span> c;<br/></li>
<li>&nbsp; &nbsp; lf-&gt;buff[lf-&gt;n++] = c;&nbsp; <span class="Comment">/* to be read by the parser */<br/></li>
<li></span>&nbsp; } <span class="Statement">while</span> (*p != <span class="Special">'\0'</span>);<br/></li>
<li>&nbsp; lf-&gt;n = <span class="Constant">0</span>;&nbsp; <span class="Comment">/* prefix matched; discard it */<br/></li>
<li></span>&nbsp; <span class="Statement">return</span> getc(lf-&gt;f);&nbsp; <span class="Comment">/* return <a href="llex.c.html#L31" title="llex.c:31">next</a> character */<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** reads the first character of file 'f' and skips an optional BOM mark<br/></li>
<li></span><span class="Comment">** in its beginning plus its first line if it starts with '#'. Returns<br/></li>
<li></span><span class="Comment">** true if it skipped the first line.&nbsp; In any case, '*cp' has the<br/></li>
<li></span><span class="Comment">** first &quot;valid&quot; character of the file (after the optional BOM and<br/></li>
<li></span><span class="Comment">** a first-line comment).<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L628">&#x200c;</a></span><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">skipcomment</span> (<a href="#L573" title="lauxlib.c:573">LoadF</a> *lf, <span class="Type">int</span> *cp) {<br/></li>
<li>&nbsp; <span class="Type">int</span> c = *cp = <a href="#L607" title="lauxlib.c:607">skipBOM</a>(lf);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (c == <span class="Constant">'#'</span>) {&nbsp; <span class="Comment">/* first line is a comment (Unix exec. file)? */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">do</span> {&nbsp; <span class="Comment">/* skip first line */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; c = getc(lf-&gt;f);<br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">while</span> (c != <span class="Constant">EOF</span> &amp;&amp; c != <span class="Special">'\n'</span>) ;<br/></li>
<li>&nbsp; &nbsp; *cp = getc(lf-&gt;f);&nbsp; <span class="Comment">/* skip end-of-line, if present */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">1</span>;&nbsp; <span class="Comment">/* there was a comment */<br/></li>
<li></span>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">else</span> <span class="Statement">return</span> <span class="Constant">0</span>;&nbsp; <span class="Comment">/* no comment */<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L641">&#x200c;</a><a href="luaconf.h.html#L235" title="luaconf.h:235">LUALIB_API</a> <span class="Type">int</span> <span class="linkable">luaL_loadfilex</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">const</span> <span class="Type">char</span> *filename,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type">const</span> <span class="Type">char</span> *mode) {<br/></li>
<li>&nbsp; <a href="#L573" title="lauxlib.c:573">LoadF</a> lf;<br/></li>
<li>&nbsp; <span class="Type">int</span> status, readstatus;<br/></li>
<li>&nbsp; <span class="Type">int</span> c;<br/></li>
<li>&nbsp; <span class="Type">int</span> fnameindex = <a href="lapi.c.html#L166" title="lapi.c:166">lua_gettop</a>(L) + <span class="Constant">1</span>;&nbsp; <span class="Comment">/* index of filename on the stack */<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (filename == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; <a href="lua.h.html#L359" title="lua.h:359">lua_pushliteral</a>(L, <span class="Constant">&quot;=stdin&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; lf.f = <span class="Constant">stdin</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; <a href="lapi.c.html#L513" title="lapi.c:513">lua_pushfstring</a>(L, <span class="Constant">&quot;@</span><span class="Special">%s</span><span class="Constant">&quot;</span>, filename);<br/></li>
<li>&nbsp; &nbsp; lf.f = fopen(filename, <span class="Constant">&quot;r&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (lf.f == <span class="Constant">NULL</span>) <span class="Statement">return</span> <a href="#L598" title="lauxlib.c:598">errfile</a>(L, <span class="Constant">&quot;open&quot;</span>, fnameindex);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="#L628" title="lauxlib.c:628">skipcomment</a>(&amp;lf, &amp;c))&nbsp; <span class="Comment">/* read initial portion */<br/></li>
<li></span>&nbsp; &nbsp; lf.buff[lf.n++] = <span class="Special">'\n'</span>;&nbsp; <span class="Comment">/* add line to correct line numbers */<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (c == <a href="lua.h.html#L31" title="lua.h:31">LUA_SIGNATURE</a>[<span class="Constant">0</span>] &amp;&amp; filename) {&nbsp; <span class="Comment">/* binary file? */<br/></li>
<li></span>&nbsp; &nbsp; lf.f = freopen(filename, <span class="Constant">&quot;rb&quot;</span>, lf.f);&nbsp; <span class="Comment">/* reopen in binary mode */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (lf.f == <span class="Constant">NULL</span>) <span class="Statement">return</span> <a href="#L598" title="lauxlib.c:598">errfile</a>(L, <span class="Constant">&quot;reopen&quot;</span>, fnameindex);<br/></li>
<li>&nbsp; &nbsp; <a href="#L628" title="lauxlib.c:628">skipcomment</a>(&amp;lf, &amp;c);&nbsp; <span class="Comment">/* re-read initial portion */<br/></li>
<li></span>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">if</span> (c != <span class="Constant">EOF</span>)<br/></li>
<li>&nbsp; &nbsp; lf.buff[lf.n++] = c;&nbsp; <span class="Comment">/* 'c' is the first character of the stream */<br/></li>
<li></span>&nbsp; status = <a href="lapi.c.html#L963" title="lapi.c:963">lua_load</a>(L, <a href="#L580" title="lauxlib.c:580">getF</a>, &amp;lf, <a href="lua.h.html#L365" title="lua.h:365">lua_tostring</a>(L, -<span class="Constant">1</span>), mode);<br/></li>
<li>&nbsp; readstatus = ferror(lf.f);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (filename) fclose(lf.f);&nbsp; <span class="Comment">/* close file (even in case of errors) */<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (readstatus) {<br/></li>
<li>&nbsp; &nbsp; <a href="lapi.c.html#L171" title="lapi.c:171">lua_settop</a>(L, fnameindex);&nbsp; <span class="Comment">/* ignore results from '<a href="lapi.c.html#L963" title="lapi.c:963">lua_load</a>' */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L598" title="lauxlib.c:598">errfile</a>(L, <span class="Constant">&quot;read&quot;</span>, fnameindex);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <a href="lua.h.html#L370" title="lua.h:370">lua_remove</a>(L, fnameindex);<br/></li>
<li>&nbsp; <span class="Statement">return</span> status;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L677">&#x200c;</a><span class="Type">typedef</span> <span class="Type">struct</span> <span class="linkable">LoadS</span> {<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">char</span> *s;<br/></li>
<li>&nbsp; <span class="Type">size_t</span> size;<br/></li>
<li><a id="L680">&#x200c;</a>} <span class="linkable">LoadS</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L683">&#x200c;</a><span class="Type">static</span> <span class="Type">const</span> <span class="Type">char</span> *<span class="linkable">getS</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">void</span> *ud, <span class="Type">size_t</span> *size) {<br/></li>
<li>&nbsp; <a href="#L677" title="lauxlib.c:677">LoadS</a> *ls = (<a href="#L677" title="lauxlib.c:677">LoadS</a> *)ud;<br/></li>
<li>&nbsp; (<span class="Type">void</span>)L;&nbsp; <span class="Comment">/* not used */<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (ls-&gt;size == <span class="Constant">0</span>) <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; *size = ls-&gt;size;<br/></li>
<li>&nbsp; ls-&gt;size = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; <span class="Statement">return</span> ls-&gt;s;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L693">&#x200c;</a><a href="luaconf.h.html#L235" title="luaconf.h:235">LUALIB_API</a> <span class="Type">int</span> <span class="linkable">luaL_loadbufferx</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">const</span> <span class="Type">char</span> *buff, <span class="Type">size_t</span> size,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type">const</span> <span class="Type">char</span> *name, <span class="Type">const</span> <span class="Type">char</span> *mode) {<br/></li>
<li>&nbsp; <a href="#L677" title="lauxlib.c:677">LoadS</a> ls;<br/></li>
<li>&nbsp; ls.s = buff;<br/></li>
<li>&nbsp; ls.size = size;<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="lapi.c.html#L963" title="lapi.c:963">lua_load</a>(L, <a href="#L683" title="lauxlib.c:683">getS</a>, &amp;ls, name, mode);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L702">&#x200c;</a><a href="luaconf.h.html#L235" title="luaconf.h:235">LUALIB_API</a> <span class="Type">int</span> <span class="linkable">luaL_loadstring</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">const</span> <span class="Type">char</span> *s) {<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="lauxlib.h.html#L131" title="lauxlib.h:131">luaL_loadbuffer</a>(L, s, strlen(s), s);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* }====================================================== */<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L710">&#x200c;</a><a href="luaconf.h.html#L235" title="luaconf.h:235">LUALIB_API</a> <span class="Type">int</span> <span class="linkable">luaL_getmetafield</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">int</span> obj, <span class="Type">const</span> <span class="Type">char</span> *event) {<br/></li>
<li>&nbsp; <span class="Statement">if</span> (!<a href="lapi.c.html#L677" title="lapi.c:677">lua_getmetatable</a>(L, obj))&nbsp; <span class="Comment">/* no metatable? */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">return</span> <a href="lua.h.html#L62" title="lua.h:62">LUA_TNIL</a>;<br/></li>
<li>&nbsp; <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span> tt;<br/></li>
<li>&nbsp; &nbsp; <a href="lapi.c.html#L484" title="lapi.c:484">lua_pushstring</a>(L, event);<br/></li>
<li>&nbsp; &nbsp; tt = <a href="lapi.c.html#L627" title="lapi.c:627">lua_rawget</a>(L, -<span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (tt == <a href="lua.h.html#L62" title="lua.h:62">LUA_TNIL</a>)&nbsp; <span class="Comment">/* is metafield nil? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <a href="lua.h.html#L342" title="lua.h:342">lua_pop</a>(L, <span class="Constant">2</span>);&nbsp; <span class="Comment">/* remove metatable and metafield */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <a href="lua.h.html#L370" title="lua.h:370">lua_remove</a>(L, -<span class="Constant">2</span>);&nbsp; <span class="Comment">/* remove only metatable */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">return</span> tt;&nbsp; <span class="Comment">/* return metafield type */<br/></li>
<li></span>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L726">&#x200c;</a><a href="luaconf.h.html#L235" title="luaconf.h:235">LUALIB_API</a> <span class="Type">int</span> <span class="linkable">luaL_callmeta</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">int</span> obj, <span class="Type">const</span> <span class="Type">char</span> *event) {<br/></li>
<li>&nbsp; obj = <a href="lapi.c.html#L159" title="lapi.c:159">lua_absindex</a>(L, obj);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="#L710" title="lauxlib.c:710">luaL_getmetafield</a>(L, obj, event) == <a href="lua.h.html#L62" title="lua.h:62">LUA_TNIL</a>)&nbsp; <span class="Comment">/* no metafield? */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>&nbsp; <a href="lapi.c.html#L236" title="lapi.c:236">lua_pushvalue</a>(L, obj);<br/></li>
<li>&nbsp; <a href="lua.h.html#L272" title="lua.h:272">lua_call</a>(L, <span class="Constant">1</span>, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; <span class="Statement">return</span> <span class="Constant">1</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L736">&#x200c;</a><a href="luaconf.h.html#L235" title="luaconf.h:235">LUALIB_API</a> <a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a> <span class="linkable">luaL_len</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">int</span> idx) {<br/></li>
<li>&nbsp; <a href="lua.h.html#L91" title="lua.h:91">lua_Integer</a> l;<br/></li>
<li>&nbsp; <span class="Type">int</span> isnum;<br/></li>
<li>&nbsp; <a href="lapi.c.html#L1127" title="lapi.c:1127">lua_len</a>(L, idx);<br/></li>
<li>&nbsp; l = <a href="lapi.c.html#L355" title="lapi.c:355">lua_tointegerx</a>(L, -<span class="Constant">1</span>, &amp;isnum);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (!isnum)<br/></li>
<li>&nbsp; &nbsp; <a href="#L212" title="lauxlib.c:212">luaL_error</a>(L, <span class="Constant">&quot;object length is not an integer&quot;</span>);<br/></li>
<li>&nbsp; <a href="lua.h.html#L342" title="lua.h:342">lua_pop</a>(L, <span class="Constant">1</span>);&nbsp; <span class="Comment">/* remove object */<br/></li>
<li></span>&nbsp; <span class="Statement">return</span> l;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L748">&#x200c;</a><a href="luaconf.h.html#L235" title="luaconf.h:235">LUALIB_API</a> <span class="Type">const</span> <span class="Type">char</span> *<span class="linkable">luaL_tolstring</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">int</span> idx, <span class="Type">size_t</span> *len) {<br/></li>
<li>&nbsp; <span class="Statement">if</span> (!<a href="#L726" title="lauxlib.c:726">luaL_callmeta</a>(L, idx, <span class="Constant">&quot;__tostring&quot;</span>)) {&nbsp; <span class="Comment">/* no metafield? */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">switch</span> (<a href="lapi.c.html#L250" title="lapi.c:250">lua_type</a>(L, idx)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="lua.h.html#L65" title="lua.h:65">LUA_TNUMBER</a>: {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="lapi.c.html#L269" title="lapi.c:269">lua_isinteger</a>(L, idx))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lapi.c.html#L513" title="lapi.c:513">lua_pushfstring</a>(L, <span class="Constant">&quot;%I&quot;</span>, <a href="lua.h.html#L340" title="lua.h:340">lua_tointeger</a>(L, idx));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lapi.c.html#L513" title="lapi.c:513">lua_pushfstring</a>(L, <span class="Constant">&quot;</span><span class="Special">%f</span><span class="Constant">&quot;</span>, <a href="lua.h.html#L339" title="lua.h:339">lua_tonumber</a>(L, idx));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="lua.h.html#L66" title="lua.h:66">LUA_TSTRING</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lapi.c.html#L236" title="lapi.c:236">lua_pushvalue</a>(L, idx);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="lua.h.html#L63" title="lua.h:63">LUA_TBOOLEAN</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lapi.c.html#L484" title="lapi.c:484">lua_pushstring</a>(L, (<a href="lapi.c.html#L366" title="lapi.c:366">lua_toboolean</a>(L, idx) ? <span class="Constant">&quot;true&quot;</span> : <span class="Constant">&quot;false&quot;</span>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="lua.h.html#L62" title="lua.h:62">LUA_TNIL</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lua.h.html#L359" title="lua.h:359">lua_pushliteral</a>(L, <span class="Constant">&quot;nil&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lapi.c.html#L513" title="lapi.c:513">lua_pushfstring</a>(L, <span class="Constant">&quot;</span><span class="Special">%s</span><span class="Constant">: </span><span class="Special">%p</span><span class="Constant">&quot;</span>, <a href="lauxlib.h.html#L119" title="lauxlib.h:119">luaL_typename</a>(L, idx),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lapi.c.html#L426" title="lapi.c:426">lua_topointer</a>(L, idx));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="lapi.c.html#L372" title="lapi.c:372">lua_tolstring</a>(L, -<span class="Constant">1</span>, len);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** {======================================================<br/></li>
<li></span><span class="Comment">** Compatibility with 5.1 module functions<br/></li>
<li></span><span class="Comment">** =======================================================<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li></span><span class="PreProc">#if defined(<a href="luaconf.h.html#L372" title="luaconf.h:372">LUA_COMPAT_MODULE</a>)<br/></li>
<li></span><br/></li>
<li><a id="L784">&#x200c;</a><span class="Type">static</span> <span class="Type">const</span> <span class="Type">char</span> *<span class="linkable">luaL_findtable</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">int</span> idx,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type">const</span> <span class="Type">char</span> *fname, <span class="Type">int</span> szhint) {<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">char</span> *e;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (idx) <a href="lapi.c.html#L236" title="lapi.c:236">lua_pushvalue</a>(L, idx);<br/></li>
<li>&nbsp; <span class="Statement">do</span> {<br/></li>
<li>&nbsp; &nbsp; e = strchr(fname, <span class="Constant">'.'</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (e == <span class="Constant">NULL</span>) e = fname + strlen(fname);<br/></li>
<li>&nbsp; &nbsp; <a href="lapi.c.html#L472" title="lapi.c:472">lua_pushlstring</a>(L, fname, e - fname);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="lapi.c.html#L627" title="lapi.c:627">lua_rawget</a>(L, -<span class="Constant">2</span>) == <a href="lua.h.html#L62" title="lua.h:62">LUA_TNIL</a>) {&nbsp; <span class="Comment">/* no such <a href="lparser.c.html#L696" title="lparser.c:696">field</a>? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <a href="lua.h.html#L342" title="lua.h:342">lua_pop</a>(L, <span class="Constant">1</span>);&nbsp; <span class="Comment">/* remove this nil */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <a href="lapi.c.html#L664" title="lapi.c:664">lua_createtable</a>(L, <span class="Constant">0</span>, (*e == <span class="Constant">'.'</span> ? <span class="Constant">1</span> : szhint)); <span class="Comment">/* new table for <a href="lparser.c.html#L696" title="lparser.c:696">field</a> */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <a href="lapi.c.html#L472" title="lapi.c:472">lua_pushlstring</a>(L, fname, e - fname);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="lapi.c.html#L236" title="lapi.c:236">lua_pushvalue</a>(L, -<span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="lapi.c.html#L734" title="lapi.c:734">lua_settable</a>(L, -<span class="Constant">4</span>);&nbsp; <span class="Comment">/* set new table into <a href="lparser.c.html#L696" title="lparser.c:696">field</a> */<br/></li>
<li></span>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (!<a href="lua.h.html#L351" title="lua.h:351">lua_istable</a>(L, -<span class="Constant">1</span>)) {&nbsp; <span class="Comment">/* <a href="lparser.c.html#L696" title="lparser.c:696">field</a> has a non-table value? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <a href="lua.h.html#L342" title="lua.h:342">lua_pop</a>(L, <span class="Constant">2</span>);&nbsp; <span class="Comment">/* remove table and value */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span> fname;&nbsp; <span class="Comment">/* return problematic part of the name */<br/></li>
<li></span>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <a href="lua.h.html#L370" title="lua.h:370">lua_remove</a>(L, -<span class="Constant">2</span>);&nbsp; <span class="Comment">/* remove previous table */<br/></li>
<li></span>&nbsp; &nbsp; fname = e + <span class="Constant">1</span>;<br/></li>
<li>&nbsp; } <span class="Statement">while</span> (*e == <span class="Constant">'.'</span>);<br/></li>
<li>&nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** Count number of elements in a <a href="lauxlib.h.html#L23" title="lauxlib.h:23">luaL_Reg</a> list.<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L813">&#x200c;</a></span><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">libsize</span> (<span class="Type">const</span> <a href="lauxlib.h.html#L23" title="lauxlib.h:23">luaL_Reg</a> *l) {<br/></li>
<li>&nbsp; <span class="Type">int</span> size = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; <span class="Statement">for</span> (; l &amp;&amp; l-&gt;name; l++) size++;<br/></li>
<li>&nbsp; <span class="Statement">return</span> size;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** Find or create a module table with a given name. The function<br/></li>
<li></span><span class="Comment">** first looks at the _LOADED table and, if that fails, try a<br/></li>
<li></span><span class="Comment">** global variable with that name. In any case, leaves on the stack<br/></li>
<li></span><span class="Comment">** the module table.<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L826">&#x200c;</a></span><a href="luaconf.h.html#L235" title="luaconf.h:235">LUALIB_API</a> <span class="Type">void</span> <span class="linkable">luaL_pushmodule</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">const</span> <span class="Type">char</span> *modname,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type">int</span> sizehint) {<br/></li>
<li>&nbsp; <a href="#L784" title="lauxlib.c:784">luaL_findtable</a>(L, <a href="lua.h.html#L40" title="lua.h:40">LUA_REGISTRYINDEX</a>, <span class="Constant">&quot;_LOADED&quot;</span>, <span class="Constant">1</span>);&nbsp; <span class="Comment">/* get _LOADED table */<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (<a href="lapi.c.html#L603" title="lapi.c:603">lua_getfield</a>(L, -<span class="Constant">1</span>, modname) != <a href="lua.h.html#L67" title="lua.h:67">LUA_TTABLE</a>) {&nbsp; <span class="Comment">/* no _LOADED[modname]? */<br/></li>
<li></span>&nbsp; &nbsp; <a href="lua.h.html#L342" title="lua.h:342">lua_pop</a>(L, <span class="Constant">1</span>);&nbsp; <span class="Comment">/* remove previous result */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">/* try global variable (and create one if it does not exist) */<br/></li>
<li></span>&nbsp; &nbsp; <a href="lua.h.html#L362" title="lua.h:362">lua_pushglobaltable</a>(L);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L784" title="lauxlib.c:784">luaL_findtable</a>(L, <span class="Constant">0</span>, modname, sizehint) != <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L212" title="lauxlib.c:212">luaL_error</a>(L, <span class="Constant">&quot;name conflict for module '</span><span class="Special">%s</span><span class="Constant">'&quot;</span>, modname);<br/></li>
<li>&nbsp; &nbsp; <a href="lapi.c.html#L236" title="lapi.c:236">lua_pushvalue</a>(L, -<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="lapi.c.html#L745" title="lapi.c:745">lua_setfield</a>(L, -<span class="Constant">3</span>, modname);&nbsp; <span class="Comment">/* _LOADED[modname] = new table */<br/></li>
<li></span>&nbsp; }<br/></li>
<li>&nbsp; <a href="lua.h.html#L370" title="lua.h:370">lua_remove</a>(L, -<span class="Constant">2</span>);&nbsp; <span class="Comment">/* remove _LOADED table */<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L842">&#x200c;</a><a href="luaconf.h.html#L235" title="luaconf.h:235">LUALIB_API</a> <span class="Type">void</span> <span class="linkable">luaL_openlib</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">const</span> <span class="Type">char</span> *libname,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type">const</span> <a href="lauxlib.h.html#L23" title="lauxlib.h:23">luaL_Reg</a> *l, <span class="Type">int</span> nup) {<br/></li>
<li>&nbsp; <a href="lauxlib.h.html#L32" title="lauxlib.h:32">luaL_checkversion</a>(L);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (libname) {<br/></li>
<li>&nbsp; &nbsp; <a href="#L826" title="lauxlib.c:826">luaL_pushmodule</a>(L, libname, <a href="#L813" title="lauxlib.c:813">libsize</a>(l));&nbsp; <span class="Comment">/* get/create library table */<br/></li>
<li></span>&nbsp; &nbsp; <a href="lua.h.html#L368" title="lua.h:368">lua_insert</a>(L, -(nup + <span class="Constant">1</span>));&nbsp; <span class="Comment">/* move library table to below upvalues */<br/></li>
<li></span>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">if</span> (l)<br/></li>
<li>&nbsp; &nbsp; <a href="#L863" title="lauxlib.c:863">luaL_setfuncs</a>(L, l, nup);<br/></li>
<li>&nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; <a href="lua.h.html#L342" title="lua.h:342">lua_pop</a>(L, nup);&nbsp; <span class="Comment">/* remove upvalues */<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><span class="Comment">/* }====================================================== */<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** set functions from list 'l' into table at top - 'nup'; each<br/></li>
<li></span><span class="Comment">** function gets the 'nup' elements at the top as upvalues.<br/></li>
<li></span><span class="Comment">** Returns with only the table at the stack.<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L863">&#x200c;</a></span><a href="luaconf.h.html#L235" title="luaconf.h:235">LUALIB_API</a> <span class="Type">void</span> <span class="linkable">luaL_setfuncs</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">const</span> <a href="lauxlib.h.html#L23" title="lauxlib.h:23">luaL_Reg</a> *l, <span class="Type">int</span> nup) {<br/></li>
<li>&nbsp; <a href="#L350" title="lauxlib.c:350">luaL_checkstack</a>(L, nup, <span class="Constant">&quot;too many upvalues&quot;</span>);<br/></li>
<li>&nbsp; <span class="Statement">for</span> (; l-&gt;name != <span class="Constant">NULL</span>; l++) {&nbsp; <span class="Comment">/* fill the table with given functions */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">int</span> i;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; nup; i++)&nbsp; <span class="Comment">/* copy upvalues to the top */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <a href="lapi.c.html#L236" title="lapi.c:236">lua_pushvalue</a>(L, -nup);<br/></li>
<li>&nbsp; &nbsp; <a href="lapi.c.html#L526" title="lapi.c:526">lua_pushcclosure</a>(L, l-&gt;func, nup);&nbsp; <span class="Comment">/* closure with those upvalues */<br/></li>
<li></span>&nbsp; &nbsp; <a href="lapi.c.html#L745" title="lapi.c:745">lua_setfield</a>(L, -(nup + <span class="Constant">2</span>), l-&gt;name);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <a href="lua.h.html#L342" title="lua.h:342">lua_pop</a>(L, nup);&nbsp; <span class="Comment">/* remove upvalues */<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** ensure that stack[idx][fname] has a table and push that table<br/></li>
<li></span><span class="Comment">** into the stack<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L880">&#x200c;</a></span><a href="luaconf.h.html#L235" title="luaconf.h:235">LUALIB_API</a> <span class="Type">int</span> <span class="linkable">luaL_getsubtable</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">int</span> idx, <span class="Type">const</span> <span class="Type">char</span> *fname) {<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="lapi.c.html#L603" title="lapi.c:603">lua_getfield</a>(L, idx, fname) == <a href="lua.h.html#L67" title="lua.h:67">LUA_TTABLE</a>)<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">1</span>;&nbsp; <span class="Comment">/* table already there */<br/></li>
<li></span>&nbsp; <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; <a href="lua.h.html#L342" title="lua.h:342">lua_pop</a>(L, <span class="Constant">1</span>);&nbsp; <span class="Comment">/* remove previous result */<br/></li>
<li></span>&nbsp; &nbsp; idx = <a href="lapi.c.html#L159" title="lapi.c:159">lua_absindex</a>(L, idx);<br/></li>
<li>&nbsp; &nbsp; <a href="lua.h.html#L344" title="lua.h:344">lua_newtable</a>(L);<br/></li>
<li>&nbsp; &nbsp; <a href="lapi.c.html#L236" title="lapi.c:236">lua_pushvalue</a>(L, -<span class="Constant">1</span>);&nbsp; <span class="Comment">/* copy to be left at top */<br/></li>
<li></span>&nbsp; &nbsp; <a href="lapi.c.html#L745" title="lapi.c:745">lua_setfield</a>(L, idx, fname);&nbsp; <span class="Comment">/* assign new table to <a href="lparser.c.html#L696" title="lparser.c:696">field</a> */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;&nbsp; <span class="Comment">/* false, because did not find table there */<br/></li>
<li></span>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** Stripped-down 'require': After checking &quot;loaded&quot; table, calls 'openf'<br/></li>
<li></span><span class="Comment">** to open a module, registers the result in 'package.loaded' table and,<br/></li>
<li></span><span class="Comment">** if 'glb' is true, also registers the result in the global table.<br/></li>
<li></span><span class="Comment">** Leaves resulting module on the top.<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L900">&#x200c;</a></span><a href="luaconf.h.html#L235" title="luaconf.h:235">LUALIB_API</a> <span class="Type">void</span> <span class="linkable">luaL_requiref</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">const</span> <span class="Type">char</span> *modname,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="lua.h.html#L103" title="lua.h:103">lua_CFunction</a> openf, <span class="Type">int</span> glb) {<br/></li>
<li>&nbsp; <a href="#L880" title="lauxlib.c:880">luaL_getsubtable</a>(L, <a href="lua.h.html#L40" title="lua.h:40">LUA_REGISTRYINDEX</a>, <span class="Constant">&quot;_LOADED&quot;</span>);<br/></li>
<li>&nbsp; <a href="lapi.c.html#L603" title="lapi.c:603">lua_getfield</a>(L, -<span class="Constant">1</span>, modname);&nbsp; <span class="Comment">/* _LOADED[modname] */<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (!<a href="lapi.c.html#L366" title="lapi.c:366">lua_toboolean</a>(L, -<span class="Constant">1</span>)) {&nbsp; <span class="Comment">/* package not already loaded? */<br/></li>
<li></span>&nbsp; &nbsp; <a href="lua.h.html#L342" title="lua.h:342">lua_pop</a>(L, <span class="Constant">1</span>);&nbsp; <span class="Comment">/* remove <a href="lparser.c.html#L696" title="lparser.c:696">field</a> */<br/></li>
<li></span>&nbsp; &nbsp; <a href="lua.h.html#L348" title="lua.h:348">lua_pushcfunction</a>(L, openf);<br/></li>
<li>&nbsp; &nbsp; <a href="lapi.c.html#L484" title="lapi.c:484">lua_pushstring</a>(L, modname);&nbsp; <span class="Comment">/* argument to open function */<br/></li>
<li></span>&nbsp; &nbsp; <a href="lua.h.html#L272" title="lua.h:272">lua_call</a>(L, <span class="Constant">1</span>, <span class="Constant">1</span>);&nbsp; <span class="Comment">/* call 'openf' to open module */<br/></li>
<li></span>&nbsp; &nbsp; <a href="lapi.c.html#L236" title="lapi.c:236">lua_pushvalue</a>(L, -<span class="Constant">1</span>);&nbsp; <span class="Comment">/* make copy of module (call result) */<br/></li>
<li></span>&nbsp; &nbsp; <a href="lapi.c.html#L745" title="lapi.c:745">lua_setfield</a>(L, -<span class="Constant">3</span>, modname);&nbsp; <span class="Comment">/* _LOADED[modname] = module */<br/></li>
<li></span>&nbsp; }<br/></li>
<li>&nbsp; <a href="lua.h.html#L370" title="lua.h:370">lua_remove</a>(L, -<span class="Constant">2</span>);&nbsp; <span class="Comment">/* remove _LOADED table */<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (glb) {<br/></li>
<li>&nbsp; &nbsp; <a href="lapi.c.html#L236" title="lapi.c:236">lua_pushvalue</a>(L, -<span class="Constant">1</span>);&nbsp; <span class="Comment">/* copy of module */<br/></li>
<li></span>&nbsp; &nbsp; <a href="lapi.c.html#L721" title="lapi.c:721">lua_setglobal</a>(L, modname);&nbsp; <span class="Comment">/* _G[modname] = module */<br/></li>
<li></span>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L920">&#x200c;</a><a href="luaconf.h.html#L235" title="luaconf.h:235">LUALIB_API</a> <span class="Type">const</span> <span class="Type">char</span> *<span class="linkable">luaL_gsub</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">const</span> <span class="Type">char</span> *s, <span class="Type">const</span> <span class="Type">char</span> *p,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type">const</span> <span class="Type">char</span> *r) {<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">char</span> *wild;<br/></li>
<li>&nbsp; <span class="Type">size_t</span> l = strlen(p);<br/></li>
<li>&nbsp; <a href="lauxlib.h.html#L140" title="lauxlib.h:140">luaL_Buffer</a> b;<br/></li>
<li>&nbsp; <a href="#L507" title="lauxlib.c:507">luaL_buffinit</a>(L, &amp;b);<br/></li>
<li>&nbsp; <span class="Statement">while</span> ((wild = strstr(s, p)) != <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; <a href="#L470" title="lauxlib.c:470">luaL_addlstring</a>(&amp;b, s, wild - s);&nbsp; <span class="Comment">/* push prefix */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L477" title="lauxlib.c:477">luaL_addstring</a>(&amp;b, r);&nbsp; <span class="Comment">/* push replacement in place of pattern */<br/></li>
<li></span>&nbsp; &nbsp; s = wild + l;&nbsp; <span class="Comment">/* continue after 'p' */<br/></li>
<li></span>&nbsp; }<br/></li>
<li>&nbsp; <a href="#L477" title="lauxlib.c:477">luaL_addstring</a>(&amp;b, s);&nbsp; <span class="Comment">/* push last suffix */<br/></li>
<li></span>&nbsp; <a href="#L482" title="lauxlib.c:482">luaL_pushresult</a>(&amp;b);<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="lua.h.html#L365" title="lua.h:365">lua_tostring</a>(L, -<span class="Constant">1</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L937">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> *<span class="linkable">l_alloc</span> (<span class="Type">void</span> *ud, <span class="Type">void</span> *ptr, <span class="Type">size_t</span> osize, <span class="Type">size_t</span> nsize) {<br/></li>
<li>&nbsp; (<span class="Type">void</span>)ud; (<span class="Type">void</span>)osize;&nbsp; <span class="Comment">/* not used */<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (nsize == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; free(ptr);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">return</span> realloc(ptr, nsize);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L948">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">panic</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <a href="lauxlib.h.html#L225" title="lauxlib.h:225">lua_writestringerror</a>(<span class="Constant">&quot;PANIC: unprotected <a href="lundump.c.html#L40" title="lundump.c:40">error</a> in call to Lua API (</span><span class="Special">%s</span><span class="Constant">)</span><span class="Special">\n</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="lua.h.html#L365" title="lua.h:365">lua_tostring</a>(L, -<span class="Constant">1</span>));<br/></li>
<li>&nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;&nbsp; <span class="Comment">/* return to Lua to abort */<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L955">&#x200c;</a><a href="luaconf.h.html#L235" title="luaconf.h:235">LUALIB_API</a> <a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *<span class="linkable">luaL_newstate</span> (<span class="Type">void</span>) {<br/></li>
<li>&nbsp; <a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L = <a href="lstate.c.html#L293" title="lstate.c:293">lua_newstate</a>(<a href="#L937" title="lauxlib.c:937">l_alloc</a>, <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (L) <a href="lapi.c.html#L133" title="lapi.c:133">lua_atpanic</a>(L, &amp;<a href="#L948" title="lauxlib.c:948">panic</a>);<br/></li>
<li>&nbsp; <span class="Statement">return</span> L;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L962">&#x200c;</a><a href="luaconf.h.html#L235" title="luaconf.h:235">LUALIB_API</a> <span class="Type">void</span> <span class="linkable">luaL_checkversion_</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <a href="lua.h.html#L87" title="lua.h:87">lua_Number</a> ver, <span class="Type">size_t</span> sz) {<br/></li>
<li>&nbsp; <span class="Type">const</span> <a href="lua.h.html#L87" title="lua.h:87">lua_Number</a> *v = <a href="lapi.c.html#L143" title="lapi.c:143">lua_version</a>(L);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (sz != <a href="lauxlib.h.html#L29" title="lauxlib.h:29">LUAL_NUMSIZES</a>)&nbsp; <span class="Comment">/* <a href="lparser.c.html#L106" title="lparser.c:106">check</a> numeric types */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L212" title="lauxlib.c:212">luaL_error</a>(L, <span class="Constant">&quot;core and library have incompatible numeric types&quot;</span>);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (v != <a href="lapi.c.html#L143" title="lapi.c:143">lua_version</a>(<span class="Constant">NULL</span>))<br/></li>
<li>&nbsp; &nbsp; <a href="#L212" title="lauxlib.c:212">luaL_error</a>(L, <span class="Constant">&quot;multiple Lua VMs detected&quot;</span>);<br/></li>
<li>&nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (*v != ver)<br/></li>
<li>&nbsp; &nbsp; <a href="#L212" title="lauxlib.c:212">luaL_error</a>(L, <span class="Constant">&quot;version mismatch: app. needs </span><span class="Special">%f</span><span class="Constant">, Lua core provides </span><span class="Special">%f</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ver, *v);<br/></li>
<li>}<br/></li>
<li><br/></li>
</ol></code>
 </body>
</html>
