<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>ldblib.c - src</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

code {
    font-family: consolas, monospace;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
  <h3>ldblib.c - src</h3>
   <a href="../index.html"> Table of Contents </a>
 <h4>Global variables defined</h4>
 <ul>
<li><a href="#L27">HOOKKEY</a></li>
<li><a href="#L412">dblib</a></li>
</ul>
 <h4>Functions defined</h4>
 <ul>
<li><a href="#L231">auxupvalue</a></li>
<li><a href="#L258">checkupval</a></li>
<li><a href="#L383">db_debug</a></li>
<li><a href="#L361">db_gethook</a></li>
<li><a href="#L131">db_getinfo</a></li>
<li><a href="#L178">db_getlocal</a></li>
<li><a href="#L36">db_getmetatable</a></li>
<li><a href="#L30">db_getregistry</a></li>
<li><a href="#L243">db_getupvalue</a></li>
<li><a href="#L55">db_getuservalue</a></li>
<li><a href="#L330">db_sethook</a></li>
<li><a href="#L208">db_setlocal</a></li>
<li><a href="#L45">db_setmetatable</a></li>
<li><a href="#L248">db_setupvalue</a></li>
<li><a href="#L64">db_setuservalue</a></li>
<li><a href="#L398">db_traceback</a></li>
<li><a href="#L267">db_upvalueid</a></li>
<li><a href="#L274">db_upvaluejoin</a></li>
<li><a href="#L79">getthread</a></li>
<li><a href="#L288">hookf</a></li>
<li><a href="#L433">luaopen_debug</a></li>
<li><a href="#L307">makemask</a></li>
<li><a href="#L106">settabsb</a></li>
<li><a href="#L101">settabsi</a></li>
<li><a href="#L96">settabss</a></li>
<li><a href="#L119">treatstackoption</a></li>
<li><a href="#L320">unmakemask</a></li>
</ul>
 <h4>Macros defined</h4>
 <ul>
<li><a href="#L8">LUA_LIB</a></li>
<li><a href="#L7">ldblib_c</a></li>
</ul>
 <h4>Source code</h4>

  <code><ol><li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** $Id: ldblib.c,v 1.148 2015/01/02 12:52:22 roberto Exp $<br/></li>
<li></span><span class="Comment">** Interface from Lua to its debug API<br/></li>
<li></span><span class="Comment">** See Copyright Notice in lua.h<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li></span><br/></li>
<li><a id="L7">&#x200c;</a><span class="PreProc">#define <span class="linkable">ldblib_c</span><br/></li>
<li><a id="L8">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">LUA_LIB</span><br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;lprefix.h&quot;<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;stdio.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;stdlib.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;string.h&gt;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;lua.h&quot;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;lauxlib.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;lualib.h&quot;<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** The hook table at registry[&amp;<a href="#L27" title="ldblib.c:27">HOOKKEY</a>] maps threads to their current<br/></li>
<li></span><span class="Comment">** hook function. (We only need the unique address of '<a href="#L27" title="ldblib.c:27">HOOKKEY</a>'.)<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L27">&#x200c;</a></span><span class="Type">static</span> <span class="Type">const</span> <span class="Type">int</span> <span class="linkable">HOOKKEY</span> = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L30">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">db_getregistry</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <a href="lapi.c.html#L236" title="lapi.c:236">lua_pushvalue</a>(L, <a href="lua.h.html#L40" title="lua.h:40">LUA_REGISTRYINDEX</a>);<br/></li>
<li>&nbsp; <span class="Statement">return</span> <span class="Constant">1</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L36">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">db_getmetatable</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <a href="lauxlib.c.html#L368" title="lauxlib.c:368">luaL_checkany</a>(L, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (!<a href="lapi.c.html#L677" title="lapi.c:677">lua_getmetatable</a>(L, <span class="Constant">1</span>)) {<br/></li>
<li>&nbsp; &nbsp; <a href="lapi.c.html#L448" title="lapi.c:448">lua_pushnil</a>(L);&nbsp; <span class="Comment">/* no metatable */<br/></li>
<li></span>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> <span class="Constant">1</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L45">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">db_setmetatable</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <span class="Type">int</span> t = <a href="lapi.c.html#L250" title="lapi.c:250">lua_type</a>(L, <span class="Constant">2</span>);<br/></li>
<li>&nbsp; <a href="lauxlib.h.html#L114" title="lauxlib.h:114">luaL_argcheck</a>(L, t == <a href="lua.h.html#L62" title="lua.h:62">LUA_TNIL</a> || t == <a href="lua.h.html#L67" title="lua.h:67">LUA_TTABLE</a>, <span class="Constant">2</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;nil or table expected&quot;</span>);<br/></li>
<li>&nbsp; <a href="lapi.c.html#L171" title="lapi.c:171">lua_settop</a>(L, <span class="Constant">2</span>);<br/></li>
<li>&nbsp; <a href="lapi.c.html#L817" title="lapi.c:817">lua_setmetatable</a>(L, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; <span class="Statement">return</span> <span class="Constant">1</span>;&nbsp; <span class="Comment">/* return 1st argument */<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L55">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">db_getuservalue</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="lapi.c.html#L250" title="lapi.c:250">lua_type</a>(L, <span class="Constant">1</span>) != <a href="lua.h.html#L69" title="lua.h:69">LUA_TUSERDATA</a>)<br/></li>
<li>&nbsp; &nbsp; <a href="lapi.c.html#L448" title="lapi.c:448">lua_pushnil</a>(L);<br/></li>
<li>&nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; <a href="lapi.c.html#L704" title="lapi.c:704">lua_getuservalue</a>(L, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; <span class="Statement">return</span> <span class="Constant">1</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L64">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">db_setuservalue</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <a href="lauxlib.c.html#L362" title="lauxlib.c:362">luaL_checktype</a>(L, <span class="Constant">1</span>, <a href="lua.h.html#L69" title="lua.h:69">LUA_TUSERDATA</a>);<br/></li>
<li>&nbsp; <a href="lauxlib.c.html#L368" title="lauxlib.c:368">luaL_checkany</a>(L, <span class="Constant">2</span>);<br/></li>
<li>&nbsp; <a href="lapi.c.html#L171" title="lapi.c:171">lua_settop</a>(L, <span class="Constant">2</span>);<br/></li>
<li>&nbsp; <a href="lapi.c.html#L857" title="lapi.c:857">lua_setuservalue</a>(L, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; <span class="Statement">return</span> <span class="Constant">1</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** Auxiliary function used by several library functions: <a href="lparser.c.html#L106" title="lparser.c:106">check</a> for<br/></li>
<li></span><span class="Comment">** an optional thread as function's first argument and set 'arg' with<br/></li>
<li></span><span class="Comment">** 1 if this argument is present (so that functions can skip it to<br/></li>
<li></span><span class="Comment">** access their other arguments)<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L79">&#x200c;</a></span><span class="Type">static</span> <a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *<span class="linkable">getthread</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">int</span> *arg) {<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="lua.h.html#L355" title="lua.h:355">lua_isthread</a>(L, <span class="Constant">1</span>)) {<br/></li>
<li>&nbsp; &nbsp; *arg = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="lapi.c.html#L420" title="lapi.c:420">lua_tothread</a>(L, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; *arg = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> L;&nbsp; <span class="Comment">/* function will operate over current thread */<br/></li>
<li></span>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** Variations of '<a href="lapi.c.html#L734" title="lapi.c:734">lua_settable</a>', used by '<a href="#L131" title="ldblib.c:131">db_getinfo</a>' to put results<br/></li>
<li></span><span class="Comment">** from '<a href="ldebug.c.html#L267" title="ldebug.c:267">lua_getinfo</a>' into result table. Key is always a string;<br/></li>
<li></span><span class="Comment">** value can be a string, an int, or a boolean.<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L96">&#x200c;</a></span><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">settabss</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">const</span> <span class="Type">char</span> *k, <span class="Type">const</span> <span class="Type">char</span> *v) {<br/></li>
<li>&nbsp; <a href="lapi.c.html#L484" title="lapi.c:484">lua_pushstring</a>(L, v);<br/></li>
<li>&nbsp; <a href="lapi.c.html#L745" title="lapi.c:745">lua_setfield</a>(L, -<span class="Constant">2</span>, k);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L101">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">settabsi</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">const</span> <span class="Type">char</span> *k, <span class="Type">int</span> v) {<br/></li>
<li>&nbsp; <a href="lapi.c.html#L464" title="lapi.c:464">lua_pushinteger</a>(L, v);<br/></li>
<li>&nbsp; <a href="lapi.c.html#L745" title="lapi.c:745">lua_setfield</a>(L, -<span class="Constant">2</span>, k);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L106">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">settabsb</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">const</span> <span class="Type">char</span> *k, <span class="Type">int</span> v) {<br/></li>
<li>&nbsp; <a href="lapi.c.html#L550" title="lapi.c:550">lua_pushboolean</a>(L, v);<br/></li>
<li>&nbsp; <a href="lapi.c.html#L745" title="lapi.c:745">lua_setfield</a>(L, -<span class="Constant">2</span>, k);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** In function '<a href="#L131" title="ldblib.c:131">db_getinfo</a>', the call to '<a href="ldebug.c.html#L267" title="ldebug.c:267">lua_getinfo</a>' may push<br/></li>
<li></span><span class="Comment">** results on the stack; later it creates the result table to put<br/></li>
<li></span><span class="Comment">** these objects. Function '<a href="#L119" title="ldblib.c:119">treatstackoption</a>' puts the result from<br/></li>
<li></span><span class="Comment">** '<a href="ldebug.c.html#L267" title="ldebug.c:267">lua_getinfo</a>' on top of the result table so that it can call<br/></li>
<li></span><span class="Comment">** '<a href="lapi.c.html#L745" title="lapi.c:745">lua_setfield</a>'.<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L119">&#x200c;</a></span><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">treatstackoption</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L1, <span class="Type">const</span> <span class="Type">char</span> *fname) {<br/></li>
<li>&nbsp; <span class="Statement">if</span> (L == L1)<br/></li>
<li>&nbsp; &nbsp; <a href="lapi.c.html#L206" title="lapi.c:206">lua_rotate</a>(L, -<span class="Constant">2</span>, <span class="Constant">1</span>);&nbsp; <span class="Comment">/* exchange object and table */<br/></li>
<li></span>&nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; <a href="lapi.c.html#L118" title="lapi.c:118">lua_xmove</a>(L1, L, <span class="Constant">1</span>);&nbsp; <span class="Comment">/* move object to the &quot;<a href="lua.c.html#L595" title="lua.c:595">main</a>&quot; stack */<br/></li>
<li></span>&nbsp; <a href="lapi.c.html#L745" title="lapi.c:745">lua_setfield</a>(L, -<span class="Constant">2</span>, fname);&nbsp; <span class="Comment">/* put object into table */<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** Calls '<a href="ldebug.c.html#L267" title="ldebug.c:267">lua_getinfo</a>' and collects all results in a new table.<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L131">&#x200c;</a></span><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">db_getinfo</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <a href="lua.h.html#L440" title="lua.h:440">lua_Debug</a> ar;<br/></li>
<li>&nbsp; <span class="Type">int</span> arg;<br/></li>
<li>&nbsp; <a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L1 = <a href="#L79" title="ldblib.c:79">getthread</a>(L, &amp;arg);<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">char</span> *options = <a href="lauxlib.h.html#L117" title="lauxlib.h:117">luaL_optstring</a>(L, arg+<span class="Constant">2</span>, <span class="Constant">&quot;flnStu&quot;</span>);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="lua.h.html#L350" title="lua.h:350">lua_isfunction</a>(L, arg + <span class="Constant">1</span>)) {&nbsp; <span class="Comment">/* info about a function? */<br/></li>
<li></span>&nbsp; &nbsp; options = <a href="lapi.c.html#L513" title="lapi.c:513">lua_pushfstring</a>(L, <span class="Constant">&quot;&gt;</span><span class="Special">%s</span><span class="Constant">&quot;</span>, options);&nbsp; <span class="Comment">/* add '&gt;' to 'options' */<br/></li>
<li></span>&nbsp; &nbsp; <a href="lapi.c.html#L236" title="lapi.c:236">lua_pushvalue</a>(L, arg + <span class="Constant">1</span>);&nbsp; <span class="Comment">/* move function to 'L1' stack */<br/></li>
<li></span>&nbsp; &nbsp; <a href="lapi.c.html#L118" title="lapi.c:118">lua_xmove</a>(L, L1, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">else</span> {&nbsp; <span class="Comment">/* stack level */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (!<a href="ldebug.c.html#L83" title="ldebug.c:83">lua_getstack</a>(L1, (<span class="Type">int</span>)<a href="lauxlib.c.html#L414" title="lauxlib.c:414">luaL_checkinteger</a>(L, arg + <span class="Constant">1</span>), &amp;ar)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="lapi.c.html#L448" title="lapi.c:448">lua_pushnil</a>(L);&nbsp; <span class="Comment">/* level out of range */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">if</span> (!<a href="ldebug.c.html#L267" title="ldebug.c:267">lua_getinfo</a>(L1, options, &amp;ar))<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="lauxlib.c.html#L162" title="lauxlib.c:162">luaL_argerror</a>(L, arg+<span class="Constant">2</span>, <span class="Constant">&quot;invalid option&quot;</span>);<br/></li>
<li>&nbsp; <a href="lua.h.html#L344" title="lua.h:344">lua_newtable</a>(L);&nbsp; <span class="Comment">/* table to collect results */<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (strchr(options, <span class="Constant">'<a href="luac.c.html#L393" title="luac.c:393">S</a>'</span>)) {<br/></li>
<li>&nbsp; &nbsp; <a href="#L96" title="ldblib.c:96">settabss</a>(L, <span class="Constant">&quot;source&quot;</span>, ar.source);<br/></li>
<li>&nbsp; &nbsp; <a href="#L96" title="ldblib.c:96">settabss</a>(L, <span class="Constant">&quot;short_src&quot;</span>, ar.short_src);<br/></li>
<li>&nbsp; &nbsp; <a href="#L101" title="ldblib.c:101">settabsi</a>(L, <span class="Constant">&quot;linedefined&quot;</span>, ar.linedefined);<br/></li>
<li>&nbsp; &nbsp; <a href="#L101" title="ldblib.c:101">settabsi</a>(L, <span class="Constant">&quot;lastlinedefined&quot;</span>, ar.lastlinedefined);<br/></li>
<li>&nbsp; &nbsp; <a href="#L96" title="ldblib.c:96">settabss</a>(L, <span class="Constant">&quot;what&quot;</span>, ar.what);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">if</span> (strchr(options, <span class="Constant">'l'</span>))<br/></li>
<li>&nbsp; &nbsp; <a href="#L101" title="ldblib.c:101">settabsi</a>(L, <span class="Constant">&quot;<a href="ldebug.c.html#L46" title="ldebug.c:46">currentline</a>&quot;</span>, ar.<a href="ldebug.c.html#L46" title="ldebug.c:46">currentline</a>);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (strchr(options, <span class="Constant">'u'</span>)) {<br/></li>
<li>&nbsp; &nbsp; <a href="#L101" title="ldblib.c:101">settabsi</a>(L, <span class="Constant">&quot;nups&quot;</span>, ar.nups);<br/></li>
<li>&nbsp; &nbsp; <a href="#L101" title="ldblib.c:101">settabsi</a>(L, <span class="Constant">&quot;nparams&quot;</span>, ar.nparams);<br/></li>
<li>&nbsp; &nbsp; <a href="#L106" title="ldblib.c:106">settabsb</a>(L, <span class="Constant">&quot;isvararg&quot;</span>, ar.isvararg);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">if</span> (strchr(options, <span class="Constant">'n'</span>)) {<br/></li>
<li>&nbsp; &nbsp; <a href="#L96" title="ldblib.c:96">settabss</a>(L, <span class="Constant">&quot;name&quot;</span>, ar.name);<br/></li>
<li>&nbsp; &nbsp; <a href="#L96" title="ldblib.c:96">settabss</a>(L, <span class="Constant">&quot;namewhat&quot;</span>, ar.namewhat);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">if</span> (strchr(options, <span class="Constant">'t'</span>))<br/></li>
<li>&nbsp; &nbsp; <a href="#L106" title="ldblib.c:106">settabsb</a>(L, <span class="Constant">&quot;istailcall&quot;</span>, ar.istailcall);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (strchr(options, <span class="Constant">'L'</span>))<br/></li>
<li>&nbsp; &nbsp; <a href="#L119" title="ldblib.c:119">treatstackoption</a>(L, L1, <span class="Constant">&quot;activelines&quot;</span>);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (strchr(options, <span class="Constant">'f'</span>))<br/></li>
<li>&nbsp; &nbsp; <a href="#L119" title="ldblib.c:119">treatstackoption</a>(L, L1, <span class="Constant">&quot;func&quot;</span>);<br/></li>
<li>&nbsp; <span class="Statement">return</span> <span class="Constant">1</span>;&nbsp; <span class="Comment">/* return table */<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L178">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">db_getlocal</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <span class="Type">int</span> arg;<br/></li>
<li>&nbsp; <a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L1 = <a href="#L79" title="ldblib.c:79">getthread</a>(L, &amp;arg);<br/></li>
<li>&nbsp; <a href="lua.h.html#L440" title="lua.h:440">lua_Debug</a> ar;<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">char</span> *name;<br/></li>
<li>&nbsp; <span class="Type">int</span> nvar = (<span class="Type">int</span>)<a href="lauxlib.c.html#L414" title="lauxlib.c:414">luaL_checkinteger</a>(L, arg + <span class="Constant">2</span>);&nbsp; <span class="Comment">/* local-variable index */<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (<a href="lua.h.html#L350" title="lua.h:350">lua_isfunction</a>(L, arg + <span class="Constant">1</span>)) {&nbsp; <span class="Comment">/* function argument? */<br/></li>
<li></span>&nbsp; &nbsp; <a href="lapi.c.html#L236" title="lapi.c:236">lua_pushvalue</a>(L, arg + <span class="Constant">1</span>);&nbsp; <span class="Comment">/* push function */<br/></li>
<li></span>&nbsp; &nbsp; <a href="lapi.c.html#L484" title="lapi.c:484">lua_pushstring</a>(L, <a href="ldebug.c.html#L144" title="ldebug.c:144">lua_getlocal</a>(L, <span class="Constant">NULL</span>, nvar));&nbsp; <span class="Comment">/* push local name */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">1</span>;&nbsp; <span class="Comment">/* return only name (there is no value) */<br/></li>
<li></span>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">else</span> {&nbsp; <span class="Comment">/* stack-level argument */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">int</span> level = (<span class="Type">int</span>)<a href="lauxlib.c.html#L414" title="lauxlib.c:414">luaL_checkinteger</a>(L, arg + <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!<a href="ldebug.c.html#L83" title="ldebug.c:83">lua_getstack</a>(L1, level, &amp;ar))&nbsp; <span class="Comment">/* out of range? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="lauxlib.c.html#L162" title="lauxlib.c:162">luaL_argerror</a>(L, arg+<span class="Constant">1</span>, <span class="Constant">&quot;level out of range&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; name = <a href="ldebug.c.html#L144" title="ldebug.c:144">lua_getlocal</a>(L1, &amp;ar, nvar);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (name) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="lapi.c.html#L118" title="lapi.c:118">lua_xmove</a>(L1, L, <span class="Constant">1</span>);&nbsp; <span class="Comment">/* move local value */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <a href="lapi.c.html#L484" title="lapi.c:484">lua_pushstring</a>(L, name);&nbsp; <span class="Comment">/* push name */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <a href="lapi.c.html#L206" title="lapi.c:206">lua_rotate</a>(L, -<span class="Constant">2</span>, <span class="Constant">1</span>);&nbsp; <span class="Comment">/* re-order */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">2</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="lapi.c.html#L448" title="lapi.c:448">lua_pushnil</a>(L);&nbsp; <span class="Comment">/* no name (nor value) */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L208">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">db_setlocal</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <span class="Type">int</span> arg;<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">char</span> *name;<br/></li>
<li>&nbsp; <a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L1 = <a href="#L79" title="ldblib.c:79">getthread</a>(L, &amp;arg);<br/></li>
<li>&nbsp; <a href="lua.h.html#L440" title="lua.h:440">lua_Debug</a> ar;<br/></li>
<li>&nbsp; <span class="Type">int</span> level = (<span class="Type">int</span>)<a href="lauxlib.c.html#L414" title="lauxlib.c:414">luaL_checkinteger</a>(L, arg + <span class="Constant">1</span>);<br/></li>
<li>&nbsp; <span class="Type">int</span> nvar = (<span class="Type">int</span>)<a href="lauxlib.c.html#L414" title="lauxlib.c:414">luaL_checkinteger</a>(L, arg + <span class="Constant">2</span>);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (!<a href="ldebug.c.html#L83" title="ldebug.c:83">lua_getstack</a>(L1, level, &amp;ar))&nbsp; <span class="Comment">/* out of range? */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">return</span> <a href="lauxlib.c.html#L162" title="lauxlib.c:162">luaL_argerror</a>(L, arg+<span class="Constant">1</span>, <span class="Constant">&quot;level out of range&quot;</span>);<br/></li>
<li>&nbsp; <a href="lauxlib.c.html#L368" title="lauxlib.c:368">luaL_checkany</a>(L, arg+<span class="Constant">3</span>);<br/></li>
<li>&nbsp; <a href="lapi.c.html#L171" title="lapi.c:171">lua_settop</a>(L, arg+<span class="Constant">3</span>);<br/></li>
<li>&nbsp; <a href="lapi.c.html#L118" title="lapi.c:118">lua_xmove</a>(L, L1, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; name = <a href="ldebug.c.html#L166" title="ldebug.c:166">lua_setlocal</a>(L1, &amp;ar, nvar);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (name == <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; <a href="lua.h.html#L342" title="lua.h:342">lua_pop</a>(L1, <span class="Constant">1</span>);&nbsp; <span class="Comment">/* pop value (if not popped by '<a href="ldebug.c.html#L166" title="ldebug.c:166">lua_setlocal</a>') */<br/></li>
<li></span>&nbsp; <a href="lapi.c.html#L484" title="lapi.c:484">lua_pushstring</a>(L, name);<br/></li>
<li>&nbsp; <span class="Statement">return</span> <span class="Constant">1</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** get (if 'get' is true) or set an upvalue from a closure<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L231">&#x200c;</a></span><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">auxupvalue</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">int</span> get) {<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">char</span> *name;<br/></li>
<li>&nbsp; <span class="Type">int</span> n = (<span class="Type">int</span>)<a href="lauxlib.c.html#L414" title="lauxlib.c:414">luaL_checkinteger</a>(L, <span class="Constant">2</span>);&nbsp; <span class="Comment">/* upvalue index */<br/></li>
<li></span>&nbsp; <a href="lauxlib.c.html#L362" title="lauxlib.c:362">luaL_checktype</a>(L, <span class="Constant">1</span>, <a href="lua.h.html#L68" title="lua.h:68">LUA_TFUNCTION</a>);&nbsp; <span class="Comment">/* closure */<br/></li>
<li></span>&nbsp; name = get ? <a href="lapi.c.html#L1193" title="lapi.c:1193">lua_getupvalue</a>(L, <span class="Constant">1</span>, n) : <a href="lapi.c.html#L1207" title="lapi.c:1207">lua_setupvalue</a>(L, <span class="Constant">1</span>, n);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (name == <span class="Constant">NULL</span>) <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>&nbsp; <a href="lapi.c.html#L484" title="lapi.c:484">lua_pushstring</a>(L, name);<br/></li>
<li>&nbsp; <a href="lua.h.html#L368" title="lua.h:368">lua_insert</a>(L, -(get+<span class="Constant">1</span>));&nbsp; <span class="Comment">/* no-op if get is false */<br/></li>
<li></span>&nbsp; <span class="Statement">return</span> get + <span class="Constant">1</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L243">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">db_getupvalue</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="#L231" title="ldblib.c:231">auxupvalue</a>(L, <span class="Constant">1</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L248">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">db_setupvalue</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <a href="lauxlib.c.html#L368" title="lauxlib.c:368">luaL_checkany</a>(L, <span class="Constant">3</span>);<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="#L231" title="ldblib.c:231">auxupvalue</a>(L, <span class="Constant">0</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** Check whether a given upvalue from a given closure exists and<br/></li>
<li></span><span class="Comment">** returns its index<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L258">&#x200c;</a></span><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">checkupval</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <span class="Type">int</span> argf, <span class="Type">int</span> argnup) {<br/></li>
<li>&nbsp; <span class="Type">int</span> nup = (<span class="Type">int</span>)<a href="lauxlib.c.html#L414" title="lauxlib.c:414">luaL_checkinteger</a>(L, argnup);&nbsp; <span class="Comment">/* upvalue index */<br/></li>
<li></span>&nbsp; <a href="lauxlib.c.html#L362" title="lauxlib.c:362">luaL_checktype</a>(L, argf, <a href="lua.h.html#L68" title="lua.h:68">LUA_TFUNCTION</a>);&nbsp; <span class="Comment">/* closure */<br/></li>
<li></span>&nbsp; <a href="lauxlib.h.html#L114" title="lauxlib.h:114">luaL_argcheck</a>(L, (<a href="lapi.c.html#L1193" title="lapi.c:1193">lua_getupvalue</a>(L, argf, nup) != <span class="Constant">NULL</span>), argnup,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;invalid upvalue index&quot;</span>);<br/></li>
<li>&nbsp; <span class="Statement">return</span> nup;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L267">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">db_upvalueid</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <span class="Type">int</span> n = <a href="#L258" title="ldblib.c:258">checkupval</a>(L, <span class="Constant">1</span>, <span class="Constant">2</span>);<br/></li>
<li>&nbsp; <a href="lapi.c.html#L558" title="lapi.c:558">lua_pushlightuserdata</a>(L, <a href="lapi.c.html#L1239" title="lapi.c:1239">lua_upvalueid</a>(L, <span class="Constant">1</span>, n));<br/></li>
<li>&nbsp; <span class="Statement">return</span> <span class="Constant">1</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L274">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">db_upvaluejoin</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <span class="Type">int</span> n1 = <a href="#L258" title="ldblib.c:258">checkupval</a>(L, <span class="Constant">1</span>, <span class="Constant">2</span>);<br/></li>
<li>&nbsp; <span class="Type">int</span> n2 = <a href="#L258" title="ldblib.c:258">checkupval</a>(L, <span class="Constant">3</span>, <span class="Constant">4</span>);<br/></li>
<li>&nbsp; <a href="lauxlib.h.html#L114" title="lauxlib.h:114">luaL_argcheck</a>(L, !<a href="lapi.c.html#L263" title="lapi.c:263">lua_iscfunction</a>(L, <span class="Constant">1</span>), <span class="Constant">1</span>, <span class="Constant">&quot;Lua function expected&quot;</span>);<br/></li>
<li>&nbsp; <a href="lauxlib.h.html#L114" title="lauxlib.h:114">luaL_argcheck</a>(L, !<a href="lapi.c.html#L263" title="lapi.c:263">lua_iscfunction</a>(L, <span class="Constant">3</span>), <span class="Constant">3</span>, <span class="Constant">&quot;Lua function expected&quot;</span>);<br/></li>
<li>&nbsp; <a href="lapi.c.html#L1258" title="lapi.c:1258">lua_upvaluejoin</a>(L, <span class="Constant">1</span>, n1, <span class="Constant">3</span>, n2);<br/></li>
<li>&nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** Call hook function registered at hook table for the current<br/></li>
<li></span><span class="Comment">** thread (if there is one)<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L288">&#x200c;</a></span><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">hookf</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L, <a href="lua.h.html#L440" title="lua.h:440">lua_Debug</a> *ar) {<br/></li>
<li>&nbsp; <span class="Type">static</span> <span class="Type">const</span> <span class="Type">char</span> *<span class="Type">const</span> hooknames[] =<br/></li>
<li>&nbsp; &nbsp; {<span class="Constant">&quot;call&quot;</span>, <span class="Constant">&quot;return&quot;</span>, <span class="Constant">&quot;line&quot;</span>, <span class="Constant">&quot;count&quot;</span>, <span class="Constant">&quot;tail call&quot;</span>};<br/></li>
<li>&nbsp; <a href="lapi.c.html#L650" title="lapi.c:650">lua_rawgetp</a>(L, <a href="lua.h.html#L40" title="lua.h:40">LUA_REGISTRYINDEX</a>, &amp;<a href="#L27" title="ldblib.c:27">HOOKKEY</a>);<br/></li>
<li>&nbsp; <a href="lapi.c.html#L566" title="lapi.c:566">lua_pushthread</a>(L);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="lapi.c.html#L627" title="lapi.c:627">lua_rawget</a>(L, -<span class="Constant">2</span>) == <a href="lua.h.html#L68" title="lua.h:68">LUA_TFUNCTION</a>) {&nbsp; <span class="Comment">/* is there a hook function? */<br/></li>
<li></span>&nbsp; &nbsp; <a href="lapi.c.html#L484" title="lapi.c:484">lua_pushstring</a>(L, hooknames[(<span class="Type">int</span>)ar-&gt;event]);&nbsp; <span class="Comment">/* push event name */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (ar-&gt;<a href="ldebug.c.html#L46" title="ldebug.c:46">currentline</a> &gt;= <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="lapi.c.html#L464" title="lapi.c:464">lua_pushinteger</a>(L, ar-&gt;<a href="ldebug.c.html#L46" title="ldebug.c:46">currentline</a>);&nbsp; <span class="Comment">/* push current line */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">else</span> <a href="lapi.c.html#L448" title="lapi.c:448">lua_pushnil</a>(L);<br/></li>
<li>&nbsp; &nbsp; <a href="lualib.h.html#L54" title="lualib.h:54">lua_assert</a>(<a href="ldebug.c.html#L267" title="ldebug.c:267">lua_getinfo</a>(L, <span class="Constant">&quot;lS&quot;</span>, ar));<br/></li>
<li>&nbsp; &nbsp; <a href="lua.h.html#L272" title="lua.h:272">lua_call</a>(L, <span class="Constant">2</span>, <span class="Constant">0</span>);&nbsp; <span class="Comment">/* call hook function */<br/></li>
<li></span>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** Convert a string <a href="lbitlib.c.html#L41" title="lbitlib.c:41">mask</a> (for 'sethook') into a bit <a href="lbitlib.c.html#L41" title="lbitlib.c:41">mask</a><br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L307">&#x200c;</a></span><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">makemask</span> (<span class="Type">const</span> <span class="Type">char</span> *smask, <span class="Type">int</span> count) {<br/></li>
<li>&nbsp; <span class="Type">int</span> <a href="lbitlib.c.html#L41" title="lbitlib.c:41">mask</a> = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (strchr(smask, <span class="Constant">'c'</span>)) <a href="lbitlib.c.html#L41" title="lbitlib.c:41">mask</a> |= <a href="lua.h.html#L411" title="lua.h:411">LUA_MASKCALL</a>;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (strchr(smask, <span class="Constant">'r'</span>)) <a href="lbitlib.c.html#L41" title="lbitlib.c:41">mask</a> |= <a href="lua.h.html#L412" title="lua.h:412">LUA_MASKRET</a>;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (strchr(smask, <span class="Constant">'l'</span>)) <a href="lbitlib.c.html#L41" title="lbitlib.c:41">mask</a> |= <a href="lua.h.html#L413" title="lua.h:413">LUA_MASKLINE</a>;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (count &gt; <span class="Constant">0</span>) <a href="lbitlib.c.html#L41" title="lbitlib.c:41">mask</a> |= <a href="lua.h.html#L414" title="lua.h:414">LUA_MASKCOUNT</a>;<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="lbitlib.c.html#L41" title="lbitlib.c:41">mask</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">** Convert a bit <a href="lbitlib.c.html#L41" title="lbitlib.c:41">mask</a> (for 'gethook') into a string <a href="lbitlib.c.html#L41" title="lbitlib.c:41">mask</a><br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L320">&#x200c;</a></span><span class="Type">static</span> <span class="Type">char</span> *<span class="linkable">unmakemask</span> (<span class="Type">int</span> <a href="lbitlib.c.html#L41" title="lbitlib.c:41">mask</a>, <span class="Type">char</span> *smask) {<br/></li>
<li>&nbsp; <span class="Type">int</span> i = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="lbitlib.c.html#L41" title="lbitlib.c:41">mask</a> &amp; <a href="lua.h.html#L411" title="lua.h:411">LUA_MASKCALL</a>) smask[i++] = <span class="Constant">'c'</span>;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="lbitlib.c.html#L41" title="lbitlib.c:41">mask</a> &amp; <a href="lua.h.html#L412" title="lua.h:412">LUA_MASKRET</a>) smask[i++] = <span class="Constant">'r'</span>;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="lbitlib.c.html#L41" title="lbitlib.c:41">mask</a> &amp; <a href="lua.h.html#L413" title="lua.h:413">LUA_MASKLINE</a>) smask[i++] = <span class="Constant">'l'</span>;<br/></li>
<li>&nbsp; smask[i] = <span class="Special">'\0'</span>;<br/></li>
<li>&nbsp; <span class="Statement">return</span> smask;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L330">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">db_sethook</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <span class="Type">int</span> arg, <a href="lbitlib.c.html#L41" title="lbitlib.c:41">mask</a>, count;<br/></li>
<li>&nbsp; <a href="lua.h.html#L420" title="lua.h:420">lua_Hook</a> func;<br/></li>
<li>&nbsp; <a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L1 = <a href="#L79" title="ldblib.c:79">getthread</a>(L, &amp;arg);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="lua.h.html#L357" title="lua.h:357">lua_isnoneornil</a>(L, arg+<span class="Constant">1</span>)) {&nbsp; <span class="Comment">/* no hook? */<br/></li>
<li></span>&nbsp; &nbsp; <a href="lapi.c.html#L171" title="lapi.c:171">lua_settop</a>(L, arg+<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; func = <span class="Constant">NULL</span>; <a href="lbitlib.c.html#L41" title="lbitlib.c:41">mask</a> = <span class="Constant">0</span>; count = <span class="Constant">0</span>;&nbsp; <span class="Comment">/* turn off hooks */<br/></li>
<li></span>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span> *smask = <a href="lauxlib.h.html#L116" title="lauxlib.h:116">luaL_checkstring</a>(L, arg+<span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="lauxlib.c.html#L362" title="lauxlib.c:362">luaL_checktype</a>(L, arg+<span class="Constant">1</span>, <a href="lua.h.html#L68" title="lua.h:68">LUA_TFUNCTION</a>);<br/></li>
<li>&nbsp; &nbsp; count = (<span class="Type">int</span>)<a href="lauxlib.c.html#L424" title="lauxlib.c:424">luaL_optinteger</a>(L, arg + <span class="Constant">3</span>, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; func = <a href="#L288" title="ldblib.c:288">hookf</a>; <a href="lbitlib.c.html#L41" title="lbitlib.c:41">mask</a> = <a href="#L307" title="ldblib.c:307">makemask</a>(smask, count);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="lapi.c.html#L650" title="lapi.c:650">lua_rawgetp</a>(L, <a href="lua.h.html#L40" title="lua.h:40">LUA_REGISTRYINDEX</a>, &amp;<a href="#L27" title="ldblib.c:27">HOOKKEY</a>) == <a href="lua.h.html#L62" title="lua.h:62">LUA_TNIL</a>) {<br/></li>
<li>&nbsp; &nbsp; <a href="lapi.c.html#L664" title="lapi.c:664">lua_createtable</a>(L, <span class="Constant">0</span>, <span class="Constant">2</span>);&nbsp; <span class="Comment">/* create a hook table */<br/></li>
<li></span>&nbsp; &nbsp; <a href="lapi.c.html#L236" title="lapi.c:236">lua_pushvalue</a>(L, -<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="lapi.c.html#L800" title="lapi.c:800">lua_rawsetp</a>(L, <a href="lua.h.html#L40" title="lua.h:40">LUA_REGISTRYINDEX</a>, &amp;<a href="#L27" title="ldblib.c:27">HOOKKEY</a>);&nbsp; <span class="Comment">/* set it in position */<br/></li>
<li></span>&nbsp; &nbsp; <a href="lapi.c.html#L484" title="lapi.c:484">lua_pushstring</a>(L, <span class="Constant">&quot;k&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="lapi.c.html#L745" title="lapi.c:745">lua_setfield</a>(L, -<span class="Constant">2</span>, <span class="Constant">&quot;__mode&quot;</span>);&nbsp; <span class="Comment">/** hooktable.__mode = &quot;k&quot; */<br/></li>
<li></span>&nbsp; &nbsp; <a href="lapi.c.html#L236" title="lapi.c:236">lua_pushvalue</a>(L, -<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="lapi.c.html#L817" title="lapi.c:817">lua_setmetatable</a>(L, -<span class="Constant">2</span>);&nbsp; <span class="Comment">/* setmetatable(hooktable) = hooktable */<br/></li>
<li></span>&nbsp; }<br/></li>
<li>&nbsp; <a href="lapi.c.html#L566" title="lapi.c:566">lua_pushthread</a>(L1); <a href="lapi.c.html#L118" title="lapi.c:118">lua_xmove</a>(L1, L, <span class="Constant">1</span>);&nbsp; <span class="Comment">/* key (thread) */<br/></li>
<li></span>&nbsp; <a href="lapi.c.html#L236" title="lapi.c:236">lua_pushvalue</a>(L, arg + <span class="Constant">1</span>);&nbsp; <span class="Comment">/* value (hook function) */<br/></li>
<li></span>&nbsp; <a href="lapi.c.html#L769" title="lapi.c:769">lua_rawset</a>(L, -<span class="Constant">3</span>);&nbsp; <span class="Comment">/* hooktable[L1] = new Lua hook */<br/></li>
<li></span>&nbsp; <a href="ldebug.c.html#L54" title="ldebug.c:54">lua_sethook</a>(L1, func, <a href="lbitlib.c.html#L41" title="lbitlib.c:41">mask</a>, count);<br/></li>
<li>&nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L361">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">db_gethook</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <span class="Type">int</span> arg;<br/></li>
<li>&nbsp; <a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L1 = <a href="#L79" title="ldblib.c:79">getthread</a>(L, &amp;arg);<br/></li>
<li>&nbsp; <span class="Type">char</span> buff[<span class="Constant">5</span>];<br/></li>
<li>&nbsp; <span class="Type">int</span> <a href="lbitlib.c.html#L41" title="lbitlib.c:41">mask</a> = <a href="ldebug.c.html#L73" title="ldebug.c:73">lua_gethookmask</a>(L1);<br/></li>
<li>&nbsp; <a href="lua.h.html#L420" title="lua.h:420">lua_Hook</a> hook = <a href="ldebug.c.html#L68" title="ldebug.c:68">lua_gethook</a>(L1);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (hook == <span class="Constant">NULL</span>)&nbsp; <span class="Comment">/* no hook? */<br/></li>
<li></span>&nbsp; &nbsp; <a href="lapi.c.html#L448" title="lapi.c:448">lua_pushnil</a>(L);<br/></li>
<li>&nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (hook != <a href="#L288" title="ldblib.c:288">hookf</a>)&nbsp; <span class="Comment">/* external hook? */<br/></li>
<li></span>&nbsp; &nbsp; <a href="lua.h.html#L359" title="lua.h:359">lua_pushliteral</a>(L, <span class="Constant">&quot;external hook&quot;</span>);<br/></li>
<li>&nbsp; <span class="Statement">else</span> {&nbsp; <span class="Comment">/* hook table must exist */<br/></li>
<li></span>&nbsp; &nbsp; <a href="lapi.c.html#L650" title="lapi.c:650">lua_rawgetp</a>(L, <a href="lua.h.html#L40" title="lua.h:40">LUA_REGISTRYINDEX</a>, &amp;<a href="#L27" title="ldblib.c:27">HOOKKEY</a>);<br/></li>
<li>&nbsp; &nbsp; <a href="lapi.c.html#L566" title="lapi.c:566">lua_pushthread</a>(L1); <a href="lapi.c.html#L118" title="lapi.c:118">lua_xmove</a>(L1, L, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="lapi.c.html#L627" title="lapi.c:627">lua_rawget</a>(L, -<span class="Constant">2</span>);&nbsp;&nbsp; <span class="Comment">/* 1st result = hooktable[L1] */<br/></li>
<li></span>&nbsp; &nbsp; <a href="lua.h.html#L370" title="lua.h:370">lua_remove</a>(L, -<span class="Constant">2</span>);&nbsp; <span class="Comment">/* remove hook table */<br/></li>
<li></span>&nbsp; }<br/></li>
<li>&nbsp; <a href="lapi.c.html#L484" title="lapi.c:484">lua_pushstring</a>(L, <a href="#L320" title="ldblib.c:320">unmakemask</a>(<a href="lbitlib.c.html#L41" title="lbitlib.c:41">mask</a>, buff));&nbsp; <span class="Comment">/* 2nd result = <a href="lbitlib.c.html#L41" title="lbitlib.c:41">mask</a> */<br/></li>
<li></span>&nbsp; <a href="lapi.c.html#L464" title="lapi.c:464">lua_pushinteger</a>(L, <a href="ldebug.c.html#L78" title="ldebug.c:78">lua_gethookcount</a>(L1));&nbsp; <span class="Comment">/* 3rd result = count */<br/></li>
<li></span>&nbsp; <span class="Statement">return</span> <span class="Constant">3</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L383">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">db_debug</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <span class="Statement">for</span> (;;) {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span> buffer[<span class="Constant">250</span>];<br/></li>
<li>&nbsp; &nbsp; <a href="lauxlib.h.html#L225" title="lauxlib.h:225">lua_writestringerror</a>(<span class="Constant">&quot;</span><span class="Special">%s</span><span class="Constant">&quot;</span>, <span class="Constant">&quot;lua_debug&gt; &quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (fgets(buffer, <span class="Statement">sizeof</span>(buffer), <span class="Constant">stdin</span>) == <span class="Constant">0</span> ||<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; strcmp(buffer, <span class="Constant">&quot;cont</span><span class="Special">\n</span><span class="Constant">&quot;</span>) == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="lauxlib.h.html#L131" title="lauxlib.h:131">luaL_loadbuffer</a>(L, buffer, strlen(buffer), <span class="Constant">&quot;=(debug command)&quot;</span>) ||<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="lua.h.html#L276" title="lua.h:276">lua_pcall</a>(L, <span class="Constant">0</span>, <span class="Constant">0</span>, <span class="Constant">0</span>))<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="lauxlib.h.html#L225" title="lauxlib.h:225">lua_writestringerror</a>(<span class="Constant">&quot;</span><span class="Special">%s\n</span><span class="Constant">&quot;</span>, <a href="lua.h.html#L365" title="lua.h:365">lua_tostring</a>(L, -<span class="Constant">1</span>));<br/></li>
<li>&nbsp; &nbsp; <a href="lapi.c.html#L171" title="lapi.c:171">lua_settop</a>(L, <span class="Constant">0</span>);&nbsp; <span class="Comment">/* remove eventual returns */<br/></li>
<li></span>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L398">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">db_traceback</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <span class="Type">int</span> arg;<br/></li>
<li>&nbsp; <a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L1 = <a href="#L79" title="ldblib.c:79">getthread</a>(L, &amp;arg);<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">char</span> *msg = <a href="lua.h.html#L365" title="lua.h:365">lua_tostring</a>(L, arg + <span class="Constant">1</span>);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (msg == <span class="Constant">NULL</span> &amp;&amp; !<a href="lua.h.html#L357" title="lua.h:357">lua_isnoneornil</a>(L, arg + <span class="Constant">1</span>))&nbsp; <span class="Comment">/* non-string 'msg'? */<br/></li>
<li></span>&nbsp; &nbsp; <a href="lapi.c.html#L236" title="lapi.c:236">lua_pushvalue</a>(L, arg + <span class="Constant">1</span>);&nbsp; <span class="Comment">/* return it untouched */<br/></li>
<li></span>&nbsp; <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span> level = (<span class="Type">int</span>)<a href="lauxlib.c.html#L424" title="lauxlib.c:424">luaL_optinteger</a>(L, arg + <span class="Constant">2</span>, (L == L1) ? <span class="Constant">1</span> : <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="lauxlib.c.html#L125" title="lauxlib.c:125">luaL_traceback</a>(L, L1, msg, level);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> <span class="Constant">1</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L412">&#x200c;</a><span class="Type">static</span> <span class="Type">const</span> <a href="lauxlib.h.html#L23" title="lauxlib.h:23">luaL_Reg</a> <span class="linkable">dblib</span>[] = {<br/></li>
<li>&nbsp; {<span class="Constant">&quot;debug&quot;</span>, <a href="#L383" title="ldblib.c:383">db_debug</a>},<br/></li>
<li>&nbsp; {<span class="Constant">&quot;<a href="lobject.h.html#L368" title="lobject.h:368">getuservalue</a>&quot;</span>, <a href="#L55" title="ldblib.c:55">db_getuservalue</a>},<br/></li>
<li>&nbsp; {<span class="Constant">&quot;gethook&quot;</span>, <a href="#L361" title="ldblib.c:361">db_gethook</a>},<br/></li>
<li>&nbsp; {<span class="Constant">&quot;getinfo&quot;</span>, <a href="#L131" title="ldblib.c:131">db_getinfo</a>},<br/></li>
<li>&nbsp; {<span class="Constant">&quot;getlocal&quot;</span>, <a href="#L178" title="ldblib.c:178">db_getlocal</a>},<br/></li>
<li>&nbsp; {<span class="Constant">&quot;getregistry&quot;</span>, <a href="#L30" title="ldblib.c:30">db_getregistry</a>},<br/></li>
<li>&nbsp; {<span class="Constant">&quot;getmetatable&quot;</span>, <a href="#L36" title="ldblib.c:36">db_getmetatable</a>},<br/></li>
<li>&nbsp; {<span class="Constant">&quot;getupvalue&quot;</span>, <a href="#L243" title="ldblib.c:243">db_getupvalue</a>},<br/></li>
<li>&nbsp; {<span class="Constant">&quot;upvaluejoin&quot;</span>, <a href="#L274" title="ldblib.c:274">db_upvaluejoin</a>},<br/></li>
<li>&nbsp; {<span class="Constant">&quot;upvalueid&quot;</span>, <a href="#L267" title="ldblib.c:267">db_upvalueid</a>},<br/></li>
<li>&nbsp; {<span class="Constant">&quot;<a href="lobject.h.html#L362" title="lobject.h:362">setuservalue</a>&quot;</span>, <a href="#L64" title="ldblib.c:64">db_setuservalue</a>},<br/></li>
<li>&nbsp; {<span class="Constant">&quot;sethook&quot;</span>, <a href="#L330" title="ldblib.c:330">db_sethook</a>},<br/></li>
<li>&nbsp; {<span class="Constant">&quot;setlocal&quot;</span>, <a href="#L208" title="ldblib.c:208">db_setlocal</a>},<br/></li>
<li>&nbsp; {<span class="Constant">&quot;setmetatable&quot;</span>, <a href="#L45" title="ldblib.c:45">db_setmetatable</a>},<br/></li>
<li>&nbsp; {<span class="Constant">&quot;setupvalue&quot;</span>, <a href="#L248" title="ldblib.c:248">db_setupvalue</a>},<br/></li>
<li>&nbsp; {<span class="Constant">&quot;traceback&quot;</span>, <a href="#L398" title="ldblib.c:398">db_traceback</a>},<br/></li>
<li>&nbsp; {<span class="Constant">NULL</span>, <span class="Constant">NULL</span>}<br/></li>
<li>};<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L433">&#x200c;</a><a href="luaconf.h.html#L236" title="luaconf.h:236">LUAMOD_API</a> <span class="Type">int</span> <span class="linkable">luaopen_debug</span> (<a href="lstate.h.html#L149" title="lstate.h:149">lua_State</a> *L) {<br/></li>
<li>&nbsp; <a href="lauxlib.h.html#L111" title="lauxlib.h:111">luaL_newlib</a>(L, <a href="#L412" title="ldblib.c:412">dblib</a>);<br/></li>
<li>&nbsp; <span class="Statement">return</span> <span class="Constant">1</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
</ol></code>
 </body>
</html>
