<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>db/db_test.cc - leveldb-1.18</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

code {
    font-family: consolas, monospace;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
  <h3>db/db_test.cc - leveldb-1.18</h3>
   <a href="../index.html"> Table of Contents </a>
 <h4>Data types defined</h4>
 <ul>
<li><a href="#L1828">KVMap</a></li>
<li><a href="#L1736">MTState</a></li>
<li><a href="#L1743">MTThread</a></li>
<li><a href="#L194">OptionConfig</a></li>
</ul>
 <h4>Functions defined</h4>
 <ul>
<li><a href="#L336">AllEntriesFor</a></li>
<li><a href="#L34">AtomicCounter</a></li>
<li><a href="#L2065">BM_LogAndApply</a></li>
<li><a href="#L1048">Between</a></li>
<li><a href="#L227">ChangeOptions</a></li>
<li><a href="#L261">Close</a></li>
<li><a href="#L424">Compact</a></li>
<li><a href="#L1895">CompactRange</a></li>
<li><a href="#L1940">CompareIterators</a></li>
<li><a href="#L311">Contents</a></li>
<li><a href="#L411">CountFiles</a></li>
<li><a href="#L238">CurrentOptions</a></li>
<li><a href="#L209">DBTest</a></li>
<li><a href="#L52">DelayMilliseconds</a></li>
<li><a href="#L292">Delete</a></li>
<li><a href="#L1843">Delete</a></li>
<li><a href="#L473">DeleteAnSSTFile</a></li>
<li><a href="#L266">DestroyAndReopen</a></li>
<li><a href="#L444">DumpFileCounts</a></li>
<li><a href="#L457">DumpSSTableList</a></li>
<li><a href="#L395">FilesPerLevel</a></li>
<li><a href="#L440">FillLevels</a></li>
<li><a href="#L296">Get</a></li>
<li><a href="#L1846">Get</a></li>
<li><a href="#L1890">GetApproximateSizes</a></li>
<li><a href="#L1887">GetProperty</a></li>
<li><a href="#L1862">GetSnapshot</a></li>
<li><a href="#L35">Increment</a></li>
<li><a href="#L38">IncrementBy</a></li>
<li><a href="#L463">IterStatus</a></li>
<li><a href="#L908">Key</a></li>
<li><a href="#L1748">MTThreadBody</a></li>
<li><a href="#L2059">MakeKey</a></li>
<li><a href="#L430">MakeTables</a></li>
<li><a href="#L1838">ModelDB</a></li>
<li><a href="#L1901">ModelIter</a></li>
<li><a href="#L1851">NewIterator</a></li>
<li><a href="#L164">NewRandomAccessFile</a></li>
<li><a href="#L91">NewWritableFile</a></li>
<li><a href="#L1919">Next</a></li>
<li><a href="#L378">NumTableFilesAtLevel</a></li>
<li><a href="#L1920">Prev</a></li>
<li><a href="#L288">Put</a></li>
<li><a href="#L1840">Put</a></li>
<li><a href="#L1933">RandomKey</a></li>
<li><a href="#L22">RandomString</a></li>
<li><a href="#L42">Read</a></li>
<li><a href="#L1868">ReleaseSnapshot</a></li>
<li><a href="#L488">RenameLDBToSST</a></li>
<li><a href="#L257">Reopen</a></li>
<li><a href="#L46">Reset</a></li>
<li><a href="#L1916">Seek</a></li>
<li><a href="#L1908">SeekToFirst</a></li>
<li><a href="#L1909">SeekToLast</a></li>
<li><a href="#L417">Size</a></li>
<li><a href="#L81">SpecialEnv</a></li>
<li><a href="#L506">TEST(DBTest, Empty) {</a></li>
<li><a href="#L513">TEST(DBTest, ReadWrite) {</a></li>
<li><a href="#L524">TEST(DBTest, PutDeleteGet) {</a></li>
<li><a href="#L535">TEST(DBTest, GetFromImmutableLayer) {</a></li>
<li><a href="#L553">TEST(DBTest, GetFromVersions) {</a></li>
<li><a href="#L561">TEST(DBTest, GetSnapshot) {</a></li>
<li><a href="#L579">TEST(DBTest, GetLevel0Ordering) {</a></li>
<li><a href="#L594">TEST(DBTest, GetOrderedByLevels) {</a></li>
<li><a href="#L606">TEST(DBTest, GetPicksCorrectFile) {</a></li>
<li><a href="#L621">TEST(DBTest, GetEncountersEmptyLevel) {</a></li>
<li><a href="#L660">TEST(DBTest, IterEmpty) {</a></li>
<li><a href="#L675">TEST(DBTest, IterSingle) {</a></li>
<li><a href="#L713">TEST(DBTest, IterMulti) {</a></li>
<li><a href="#L796">TEST(DBTest, IterSmallAndLargeMix) {</a></li>
<li><a href="#L834">TEST(DBTest, IterMultiWithDelete) {</a></li>
<li><a href="#L851">TEST(DBTest, Recover) {</a></li>
<li><a href="#L873">TEST(DBTest, RecoveryWithEmptyLog) {</a></li>
<li><a href="#L887">TEST(DBTest, RecoverDuringMemtableCompaction) {</a></li>
<li><a href="#L914">TEST(DBTest, MinorCompactionsHappen) {</a></li>
<li><a href="#L939">TEST(DBTest, RecoverWithLargeLog) {</a></li>
<li><a href="#L963">TEST(DBTest, CompactionsGenerateMultipleFiles) {</a></li>
<li><a href="#L989">TEST(DBTest, RepeatedWritesToSameKey) {</a></li>
<li><a href="#L1008">TEST(DBTest, SparseMerge) {</a></li>
<li><a href="#L1059">TEST(DBTest, ApproximateSizes) {</a></li>
<li><a href="#L1109">TEST(DBTest, ApproximateSizes_MixOfSmallAndLarge) {</a></li>
<li><a href="#L1147">TEST(DBTest, IteratorPinsRef) {</a></li>
<li><a href="#L1169">TEST(DBTest, Snapshot) {</a></li>
<li><a href="#L1198">TEST(DBTest, HiddenValuesAreRemoved) {</a></li>
<li><a href="#L1229">TEST(DBTest, DeletionMarkers1) {</a></li>
<li><a href="#L1258">TEST(DBTest, DeletionMarkers2) {</a></li>
<li><a href="#L1284">TEST(DBTest, OverlapInLevel0) {</a></li>
<li><a href="#L1325">TEST(DBTest, L0_CompactionBug_Issue44_a) {</a></li>
<li><a href="#L1342">TEST(DBTest, L0_CompactionBug_Issue44_b) {</a></li>
<li><a href="#L1368">TEST(DBTest, ComparatorCheck) {</a></li>
<li><a href="#L1391">TEST(DBTest, CustomComparator) {</a></li>
<li><a href="#L1446">TEST(DBTest, ManualCompaction) {</a></li>
<li><a href="#L1480">TEST(DBTest, DBOpen_Options) {</a></li>
<li><a href="#L1519">TEST(DBTest, Locking) {</a></li>
<li><a href="#L1526">TEST(DBTest, NoSpace) {</a></li>
<li><a href="#L1545">TEST(DBTest, NonWritableFileSystem) {</a></li>
<li><a href="#L1565">TEST(DBTest, WriteSyncError) {</a></li>
<li><a href="#L1596">TEST(DBTest, ManifestWriteError) {</a></li>
<li><a href="#L1637">TEST(DBTest, MissingSSTFile) {</a></li>
<li><a href="#L1655">TEST(DBTest, StillReadSST) {</a></li>
<li><a href="#L1671">TEST(DBTest, FilesDeletedAfterCompaction) {</a></li>
<li><a href="#L1682">TEST(DBTest, BloomFilter) {</a></li>
<li><a href="#L1795">TEST(DBTest, MultiThreaded) {</a></li>
<li><a href="#L1988">TEST(DBTest, Randomized) {</a></li>
<li><a href="#L386">TotalTableFiles</a></li>
<li><a href="#L273">TryReopen</a></li>
<li><a href="#L1907">Valid</a></li>
<li><a href="#L1871">Write</a></li>
<li><a href="#L253">dbfull</a></li>
<li><a href="#L1921">key</a></li>
<li><a href="#L2118">main</a></li>
<li><a href="#L1923">status</a></li>
<li><a href="#L1922">value</a></li>
<li><a href="#L218">~DBTest</a></li>
<li><a href="#L1839">~ModelDB</a></li>
<li><a href="#L1904">~ModelIter</a></li>
</ul>
 <h4>Source code</h4>

  <code><ol><li><span class="Comment">// Copyright (c) 2011 The LevelDB Authors. All rights reserved.<br/></li>
<li></span><span class="Comment">// Use of this source <a href="../include/leveldb/status.h.html#L84" title="include/leveldb/status.h:84">code</a> is governed by a BSD-style license that can be<br/></li>
<li></span><span class="Comment">// found in the LICENSE file. See the AUTHORS file for names of contributors.<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;leveldb/<a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a>.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;leveldb/filter_policy.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;<a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a>/db_impl.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;<a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a>/filename.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;<a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a>/version_set.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;<a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a>/write_batch_internal.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;leveldb/cache.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;leveldb/env.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;leveldb/table.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;util/<a href="skiplist_test.cc.html#L155" title="db/skiplist_test.cc:155">hash</a>.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;util/logging.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;util/mutexlock.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;util/testharness.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;util/testutil.h&quot;<br/></li>
<li></span><br/></li>
<li><span class="Type">namespace</span> leveldb {<br/></li>
<li><br/></li>
<li><a id="L22">&#x200c;</a><span class="Type">static</span> std::string <span class="linkable">RandomString</span>(<a href="../util/random.h.html#L19" title="util/random.h:19">Random</a>* rnd, <span class="Type">int</span> len) {<br/></li>
<li>&nbsp; std::string r;<br/></li>
<li>&nbsp; test::<a href="#L22" title="db/db_test.cc:22">RandomString</a>(rnd, len, &amp;r);<br/></li>
<li>&nbsp; <span class="Statement">return</span> r;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Type">namespace</span> {<br/></li>
<li><span class="Type">class</span> <a href="#L34" title="db/db_test.cc:34">AtomicCounter</a> {<br/></li>
<li><span class="cUserCont"> </span><span class="Statement">private</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; port::<a href="../port/port_posix.cc.html#L22" title="port/port_posix.cc:22">Mutex</a> mu_;<br/></li>
<li>&nbsp; <span class="Type">int</span> count_;<br/></li>
<li><span class="cUserCont"> </span><span class="Statement">public</span><span class="cUserCont">:<br/></li>
<li><a id="L34">&#x200c;</a></span>&nbsp; <span class="linkable">AtomicCounter</span>() : count_(<span class="Constant">0</span>) { }<br/></li>
<li><a id="L35">&#x200c;</a>&nbsp; <span class="Type">void</span> <span class="linkable">Increment</span>() {<br/></li>
<li>&nbsp; &nbsp; <a href="#L38" title="db/db_test.cc:38">IncrementBy</a>(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; }<br/></li>
<li><a id="L38">&#x200c;</a>&nbsp; <span class="Type">void</span> <span class="linkable">IncrementBy</span>(<span class="Type">int</span> count) {<br/></li>
<li>&nbsp; &nbsp; MutexLock l(&amp;mu_);<br/></li>
<li>&nbsp; &nbsp; count_ += count;<br/></li>
<li>&nbsp; }<br/></li>
<li><a id="L42">&#x200c;</a>&nbsp; <span class="Type">int</span> <span class="linkable">Read</span>() {<br/></li>
<li>&nbsp; &nbsp; MutexLock l(&amp;mu_);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> count_;<br/></li>
<li>&nbsp; }<br/></li>
<li><a id="L46">&#x200c;</a>&nbsp; <span class="Type">void</span> <span class="linkable">Reset</span>() {<br/></li>
<li>&nbsp; &nbsp; MutexLock l(&amp;mu_);<br/></li>
<li>&nbsp; &nbsp; count_ = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li>};<br/></li>
<li><br/></li>
<li><a id="L52">&#x200c;</a><span class="Type">void</span> <span class="linkable">DelayMilliseconds</span>(<span class="Type">int</span> millis) {<br/></li>
<li>&nbsp; <a href="../include/leveldb/env.h.html#L33" title="include/leveldb/env.h:33">Env</a>::<a href="../util/env_posix.cc.html#L600" title="util/env_posix.cc:600">Default</a>()-&gt;<a href="../include/leveldb/env.h.html#L324" title="include/leveldb/env.h:324">SleepForMicroseconds</a>(millis * <span class="Constant">1000</span>);<br/></li>
<li>}<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">// Special <a href="../include/leveldb/env.h.html#L33" title="include/leveldb/env.h:33">Env</a> used to delay background operations<br/></li>
<li></span><span class="Type">class</span> <a href="#L81" title="db/db_test.cc:81">SpecialEnv</a> : <span class="Statement">public</span> <a href="../include/leveldb/env.h.html#L276" title="include/leveldb/env.h:276">EnvWrapper</a> {<br/></li>
<li><span class="cUserCont"> </span><span class="Statement">public</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; <span class="Comment">// sstable/log <a href="../table/table_test.cc.html#L98" title="table/table_test.cc:98">Sync</a>() calls are blocked while this pointer is non-NULL.<br/></li>
<li></span>&nbsp; port::<a href="../port/port_example.h.html#L83" title="port/port_example.h:83">AtomicPointer</a> delay_data_sync_;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// sstable/log <a href="../table/table_test.cc.html#L98" title="table/table_test.cc:98">Sync</a>() calls return an error.<br/></li>
<li></span>&nbsp; port::<a href="../port/port_example.h.html#L83" title="port/port_example.h:83">AtomicPointer</a> data_sync_error_;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// Simulate no-space errors while this pointer is non-NULL.<br/></li>
<li></span>&nbsp; port::<a href="../port/port_example.h.html#L83" title="port/port_example.h:83">AtomicPointer</a> no_space_;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// Simulate non-writable file system while this pointer is non-NULL<br/></li>
<li></span>&nbsp; port::<a href="../port/port_example.h.html#L83" title="port/port_example.h:83">AtomicPointer</a> non_writable_;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// Force sync of manifest files to fail while this pointer is non-NULL<br/></li>
<li></span>&nbsp; port::<a href="../port/port_example.h.html#L83" title="port/port_example.h:83">AtomicPointer</a> manifest_sync_error_;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// Force write to manifest files to fail while this pointer is non-NULL<br/></li>
<li></span>&nbsp; port::<a href="../port/port_example.h.html#L83" title="port/port_example.h:83">AtomicPointer</a> manifest_write_error_;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Type">bool</span> count_random_reads_;<br/></li>
<li>&nbsp; <a href="#L34" title="db/db_test.cc:34">AtomicCounter</a> random_read_counter_;<br/></li>
<li><br/></li>
<li><a id="L81">&#x200c;</a>&nbsp; <span class="Type">explicit</span> <span class="linkable">SpecialEnv</span>(<a href="../include/leveldb/env.h.html#L33" title="include/leveldb/env.h:33">Env</a>* base) : <a href="../include/leveldb/env.h.html#L276" title="include/leveldb/env.h:276">EnvWrapper</a>(base) {<br/></li>
<li>&nbsp; &nbsp; delay_data_sync_.<a href="../port/atomic_pointer.h.html#L121" title="port/atomic_pointer.h:121">Release_Store</a>(<span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; data_sync_error_.<a href="../port/atomic_pointer.h.html#L121" title="port/atomic_pointer.h:121">Release_Store</a>(<span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; no_space_.<a href="../port/atomic_pointer.h.html#L121" title="port/atomic_pointer.h:121">Release_Store</a>(<span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; non_writable_.<a href="../port/atomic_pointer.h.html#L121" title="port/atomic_pointer.h:121">Release_Store</a>(<span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; count_random_reads_ = <span class="Constant">false</span>;<br/></li>
<li>&nbsp; &nbsp; manifest_sync_error_.<a href="../port/atomic_pointer.h.html#L121" title="port/atomic_pointer.h:121">Release_Store</a>(<span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; manifest_write_error_.<a href="../port/atomic_pointer.h.html#L121" title="port/atomic_pointer.h:121">Release_Store</a>(<span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li><a id="L91">&#x200c;</a>&nbsp; <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> <span class="linkable">NewWritableFile</span>(<span class="Type">const</span> std::string&amp; f, <a href="../include/leveldb/env.h.html#L214" title="include/leveldb/env.h:214">WritableFile</a>** r) {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">class</span> DataFile : <span class="Statement">public</span> <a href="../include/leveldb/env.h.html#L214" title="include/leveldb/env.h:214">WritableFile</a> {<br/></li>
<li><span class="cUserCont">&nbsp; &nbsp;&nbsp; </span><span class="Statement">private</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <a href="#L81" title="db/db_test.cc:81">SpecialEnv</a>* env_;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../include/leveldb/env.h.html#L214" title="include/leveldb/env.h:214">WritableFile</a>* base_;<br/></li>
<li><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp;&nbsp; </span><span class="Statement">public</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; DataFile(<a href="#L81" title="db/db_test.cc:81">SpecialEnv</a>* env, <a href="../include/leveldb/env.h.html#L214" title="include/leveldb/env.h:214">WritableFile</a>* base)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : env_(env),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; base_(base) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; ~DataFile() { <span class="Statement">delete</span> base_; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> <a href="../table/table_test.cc.html#L100" title="table/table_test.cc:100">Append</a>(<span class="Type">const</span> <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>&amp; <a href="../table/table_test.cc.html#L173" title="table/table_test.cc:173">data</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (env_-&gt;no_space_.<a href="../port/atomic_pointer.h.html#L116" title="port/atomic_pointer.h:116">Acquire_Load</a>() != <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">// Drop writes on the floor<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a>::<a href="../include/leveldb/status.h.html#L32" title="include/leveldb/status.h:32">OK</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> base_-&gt;<a href="../table/table_test.cc.html#L100" title="table/table_test.cc:100">Append</a>(<a href="../table/table_test.cc.html#L173" title="table/table_test.cc:173">data</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> <a href="../table/table_test.cc.html#L96" title="table/table_test.cc:96">Close</a>() { <span class="Statement">return</span> base_-&gt;<a href="../table/table_test.cc.html#L96" title="table/table_test.cc:96">Close</a>(); }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> <a href="../table/table_test.cc.html#L97" title="table/table_test.cc:97">Flush</a>() { <span class="Statement">return</span> base_-&gt;<a href="../table/table_test.cc.html#L97" title="table/table_test.cc:97">Flush</a>(); }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> <a href="../table/table_test.cc.html#L98" title="table/table_test.cc:98">Sync</a>() {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (env_-&gt;data_sync_error_.<a href="../port/atomic_pointer.h.html#L116" title="port/atomic_pointer.h:116">Acquire_Load</a>() != <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a>::<a href="../include/leveldb/status.h.html#L47" title="include/leveldb/status.h:47">IOError</a>(<span class="Constant">&quot;simulated <a href="../table/table_test.cc.html#L173" title="table/table_test.cc:173">data</a> sync error&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">while</span> (env_-&gt;delay_data_sync_.<a href="../port/atomic_pointer.h.html#L116" title="port/atomic_pointer.h:116">Acquire_Load</a>() != <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L52" title="db/db_test.cc:52">DelayMilliseconds</a>(<span class="Constant">100</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> base_-&gt;<a href="../table/table_test.cc.html#L98" title="table/table_test.cc:98">Sync</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; };<br/></li>
<li>&nbsp; &nbsp; <span class="Type">class</span> ManifestFile : <span class="Statement">public</span> <a href="../include/leveldb/env.h.html#L214" title="include/leveldb/env.h:214">WritableFile</a> {<br/></li>
<li><span class="cUserCont">&nbsp; &nbsp;&nbsp; </span><span class="Statement">private</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <a href="#L81" title="db/db_test.cc:81">SpecialEnv</a>* env_;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../include/leveldb/env.h.html#L214" title="include/leveldb/env.h:214">WritableFile</a>* base_;<br/></li>
<li><span class="cUserCont">&nbsp; &nbsp;&nbsp; </span><span class="Statement">public</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; ManifestFile(<a href="#L81" title="db/db_test.cc:81">SpecialEnv</a>* env, <a href="../include/leveldb/env.h.html#L214" title="include/leveldb/env.h:214">WritableFile</a>* b) : env_(env), base_(b) { }<br/></li>
<li>&nbsp; &nbsp; &nbsp; ~ManifestFile() { <span class="Statement">delete</span> base_; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> <a href="../table/table_test.cc.html#L100" title="table/table_test.cc:100">Append</a>(<span class="Type">const</span> <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>&amp; <a href="../table/table_test.cc.html#L173" title="table/table_test.cc:173">data</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (env_-&gt;manifest_write_error_.<a href="../port/atomic_pointer.h.html#L116" title="port/atomic_pointer.h:116">Acquire_Load</a>() != <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a>::<a href="../include/leveldb/status.h.html#L47" title="include/leveldb/status.h:47">IOError</a>(<span class="Constant">&quot;simulated writer error&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> base_-&gt;<a href="../table/table_test.cc.html#L100" title="table/table_test.cc:100">Append</a>(<a href="../table/table_test.cc.html#L173" title="table/table_test.cc:173">data</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> <a href="../table/table_test.cc.html#L96" title="table/table_test.cc:96">Close</a>() { <span class="Statement">return</span> base_-&gt;<a href="../table/table_test.cc.html#L96" title="table/table_test.cc:96">Close</a>(); }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> <a href="../table/table_test.cc.html#L97" title="table/table_test.cc:97">Flush</a>() { <span class="Statement">return</span> base_-&gt;<a href="../table/table_test.cc.html#L97" title="table/table_test.cc:97">Flush</a>(); }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> <a href="../table/table_test.cc.html#L98" title="table/table_test.cc:98">Sync</a>() {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (env_-&gt;manifest_sync_error_.<a href="../port/atomic_pointer.h.html#L116" title="port/atomic_pointer.h:116">Acquire_Load</a>() != <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a>::<a href="../include/leveldb/status.h.html#L47" title="include/leveldb/status.h:47">IOError</a>(<span class="Constant">&quot;simulated sync error&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> base_-&gt;<a href="../table/table_test.cc.html#L98" title="table/table_test.cc:98">Sync</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; };<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (non_writable_.<a href="../port/atomic_pointer.h.html#L116" title="port/atomic_pointer.h:116">Acquire_Load</a>() != <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a>::<a href="../include/leveldb/status.h.html#L47" title="include/leveldb/status.h:47">IOError</a>(<span class="Constant">&quot;simulated write error&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> s = <a href="../include/leveldb/env.h.html#L280" title="include/leveldb/env.h:280">target</a>()-&gt;<a href="../include/leveldb/env.h.html#L289" title="include/leveldb/env.h:289">NewWritableFile</a>(f, r);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (s.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>()) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (strstr(f.c_str(), <span class="Constant">&quot;.ldb&quot;</span>) != <span class="Constant">NULL</span> ||<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; strstr(f.c_str(), <span class="Constant">&quot;.log&quot;</span>) != <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *r = <span class="Statement">new</span> DataFile(<span class="Statement">this</span>, *r);<br/></li>
<li>&nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (strstr(f.c_str(), <span class="Constant">&quot;MANIFEST&quot;</span>) != <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *r = <span class="Statement">new</span> ManifestFile(<span class="Statement">this</span>, *r);<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> s;<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li><a id="L164">&#x200c;</a>&nbsp; <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> <span class="linkable">NewRandomAccessFile</span>(<span class="Type">const</span> std::string&amp; f, <a href="../include/leveldb/env.h.html#L188" title="include/leveldb/env.h:188">RandomAccessFile</a>** r) {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">class</span> CountingFile : <span class="Statement">public</span> <a href="../include/leveldb/env.h.html#L188" title="include/leveldb/env.h:188">RandomAccessFile</a> {<br/></li>
<li><span class="cUserCont">&nbsp; &nbsp;&nbsp; </span><span class="Statement">private</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <a href="../include/leveldb/env.h.html#L188" title="include/leveldb/env.h:188">RandomAccessFile</a>* target_;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L34" title="db/db_test.cc:34">AtomicCounter</a>* counter_;<br/></li>
<li><span class="cUserCont">&nbsp; &nbsp;&nbsp; </span><span class="Statement">public</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; CountingFile(<a href="../include/leveldb/env.h.html#L188" title="include/leveldb/env.h:188">RandomAccessFile</a>* <a href="../include/leveldb/env.h.html#L280" title="include/leveldb/env.h:280">target</a>, <a href="#L34" title="db/db_test.cc:34">AtomicCounter</a>* counter)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : target_(<a href="../include/leveldb/env.h.html#L280" title="include/leveldb/env.h:280">target</a>), counter_(counter) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Type">virtual</span> ~CountingFile() { <span class="Statement">delete</span> target_; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Type">virtual</span> <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> <a href="../table/table_test.cc.html#L120" title="table/table_test.cc:120">Read</a>(<span class="Type"><a href="../port/win/stdint.h.html#L22" title="port/win/stdint.h:22">uint64_t</a></span> <a href="../table/format.h.html#L27" title="table/format.h:27">offset</a>, <span class="Type">size_t</span> n, <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>* result,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">char</span>* scratch) <span class="Type">const</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; counter_-&gt;<a href="../table/table_test.cc.html#L66" title="table/table_test.cc:66">Increment</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> target_-&gt;<a href="../table/table_test.cc.html#L120" title="table/table_test.cc:120">Read</a>(<a href="../table/format.h.html#L27" title="table/format.h:27">offset</a>, n, result, scratch);<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; };<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> s = <a href="../include/leveldb/env.h.html#L280" title="include/leveldb/env.h:280">target</a>()-&gt;<a href="../include/leveldb/env.h.html#L286" title="include/leveldb/env.h:286">NewRandomAccessFile</a>(f, r);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (s.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>() &amp;&amp; count_random_reads_) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; *r = <span class="Statement">new</span> CountingFile(*r, &amp;random_read_counter_);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> s;<br/></li>
<li>&nbsp; }<br/></li>
<li>};<br/></li>
<li><br/></li>
<li><span class="Type">class</span> <a href="#L209" title="db/db_test.cc:209">DBTest</a> {<br/></li>
<li><span class="cUserCont"> </span><span class="Statement">private</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; <span class="Type">const</span> FilterPolicy* filter_policy_;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// <a href="write_batch.cc.html#L90" title="db/write_batch.cc:90">Sequence</a> of option configurations to try<br/></li>
<li><a id="L194">&#x200c;</a></span>&nbsp; <span class="Type">enum</span> <span class="linkable">OptionConfig</span> {<br/></li>
<li>&nbsp; &nbsp; kDefault,<br/></li>
<li>&nbsp; &nbsp; kFilter,<br/></li>
<li>&nbsp; &nbsp; kUncompressed,<br/></li>
<li>&nbsp; &nbsp; kEnd<br/></li>
<li>&nbsp; };<br/></li>
<li>&nbsp; <span class="Type">int</span> option_config_;<br/></li>
<li><br/></li>
<li><span class="cUserCont"> </span><span class="Statement">public</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; std::string dbname_;<br/></li>
<li>&nbsp; <a href="#L81" title="db/db_test.cc:81">SpecialEnv</a>* env_;<br/></li>
<li>&nbsp; <a href="../include/leveldb/db.h.html#L55" title="include/leveldb/db.h:55">DB</a>* db_;<br/></li>
<li><br/></li>
<li>&nbsp; <a href="../include/leveldb/options.h.html#L31" title="include/leveldb/options.h:31">Options</a> last_options_;<br/></li>
<li><br/></li>
<li><a id="L209">&#x200c;</a>&nbsp; <span class="linkable">DBTest</span>() : option_config_(kDefault),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; env_(<span class="Statement">new</span> <a href="#L81" title="db/db_test.cc:81">SpecialEnv</a>(<a href="../include/leveldb/env.h.html#L33" title="include/leveldb/env.h:33">Env</a>::<a href="../util/env_posix.cc.html#L600" title="util/env_posix.cc:600">Default</a>())) {<br/></li>
<li>&nbsp; &nbsp; filter_policy_ = <a href="../util/bloom.cc.html#L91" title="util/bloom.cc:91">NewBloomFilterPolicy</a>(<span class="Constant">10</span>);<br/></li>
<li>&nbsp; &nbsp; dbname_ = test::<a href="../util/testharness.cc.html#L60" title="util/testharness.cc:60">TmpDir</a>() + <span class="Constant">&quot;/db_test&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; <a href="db_impl.cc.html#L1482" title="db/db_impl.cc:1482">DestroyDB</a>(dbname_, <a href="../include/leveldb/options.h.html#L31" title="include/leveldb/options.h:31">Options</a>());<br/></li>
<li>&nbsp; &nbsp; db_ = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; <a href="corruption_test.cc.html#L60" title="db/corruption_test.cc:60">Reopen</a>();<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li><a id="L218">&#x200c;</a>&nbsp; ~<a href="#L209" title="db/db_test.cc:209">DBTest</a>() {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">delete</span> db_;<br/></li>
<li>&nbsp; &nbsp; <a href="db_impl.cc.html#L1482" title="db/db_impl.cc:1482">DestroyDB</a>(dbname_, <a href="../include/leveldb/options.h.html#L31" title="include/leveldb/options.h:31">Options</a>());<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">delete</span> env_;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">delete</span> filter_policy_;<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// Switch to a fresh database with the next option configuration to<br/></li>
<li></span>&nbsp; <span class="Comment">// test.&nbsp; Return false if there are no more configurations to test.<br/></li>
<li><a id="L227">&#x200c;</a></span>&nbsp; <span class="Type">bool</span> <span class="linkable">ChangeOptions</span>() {<br/></li>
<li>&nbsp; &nbsp; option_config_++;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (option_config_ &gt;= kEnd) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">false</span>;<br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L266" title="db/db_test.cc:266">DestroyAndReopen</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// Return the <a href="version_set.h.html#L185" title="db/version_set.h:185">current</a> option configuration.<br/></li>
<li><a id="L238">&#x200c;</a></span>&nbsp; <a href="../include/leveldb/options.h.html#L31" title="include/leveldb/options.h:31">Options</a> <span class="linkable">CurrentOptions</span>() {<br/></li>
<li>&nbsp; &nbsp; <a href="../include/leveldb/options.h.html#L31" title="include/leveldb/options.h:31">Options</a> options;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">switch</span> (option_config_) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> kFilter:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; options.filter_policy = filter_policy_;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> kUncompressed:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; options.compression = kNoCompression;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> options;<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li><a id="L253">&#x200c;</a>&nbsp; <a href="db_impl.cc.html#L116" title="db/db_impl.cc:116">DBImpl</a>* <span class="linkable">dbfull</span>() {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Statement">reinterpret_cast</span>&lt;<a href="db_impl.cc.html#L116" title="db/db_impl.cc:116">DBImpl</a>*&gt;(db_);<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li><a id="L257">&#x200c;</a>&nbsp; <span class="Type">void</span> <span class="linkable">Reopen</span>(<a href="../include/leveldb/options.h.html#L31" title="include/leveldb/options.h:31">Options</a>* options = <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="corruption_test.cc.html#L54" title="db/corruption_test.cc:54">TryReopen</a>(options));<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li><a id="L261">&#x200c;</a>&nbsp; <span class="Type">void</span> <span class="linkable">Close</span>() {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">delete</span> db_;<br/></li>
<li>&nbsp; &nbsp; db_ = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li><a id="L266">&#x200c;</a>&nbsp; <span class="Type">void</span> <span class="linkable">DestroyAndReopen</span>(<a href="../include/leveldb/options.h.html#L31" title="include/leveldb/options.h:31">Options</a>* options = <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">delete</span> db_;<br/></li>
<li>&nbsp; &nbsp; db_ = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; <a href="db_impl.cc.html#L1482" title="db/db_impl.cc:1482">DestroyDB</a>(dbname_, <a href="../include/leveldb/options.h.html#L31" title="include/leveldb/options.h:31">Options</a>());<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="corruption_test.cc.html#L54" title="db/corruption_test.cc:54">TryReopen</a>(options));<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li><a id="L273">&#x200c;</a>&nbsp; <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> <span class="linkable">TryReopen</span>(<a href="../include/leveldb/options.h.html#L31" title="include/leveldb/options.h:31">Options</a>* options) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">delete</span> db_;<br/></li>
<li>&nbsp; &nbsp; db_ = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; <a href="../include/leveldb/options.h.html#L31" title="include/leveldb/options.h:31">Options</a> opts;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (options != <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; opts = *options;<br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; opts = <a href="#L238" title="db/db_test.cc:238">CurrentOptions</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; opts.create_if_missing = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; last_options_ = opts;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../include/leveldb/db.h.html#L55" title="include/leveldb/db.h:55">DB</a>::<a href="../table/table.cc.html#L38" title="table/table.cc:38">Open</a>(opts, dbname_, &amp;db_);<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li><a id="L288">&#x200c;</a>&nbsp; <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> <span class="linkable">Put</span>(<span class="Type">const</span> std::string&amp; k, <span class="Type">const</span> std::string&amp; v) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> db_-&gt;<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<a href="../include/leveldb/options.h.html#L169" title="include/leveldb/options.h:169">WriteOptions</a>(), k, v);<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li><a id="L292">&#x200c;</a>&nbsp; <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> <span class="linkable">Delete</span>(<span class="Type">const</span> std::string&amp; k) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> db_-&gt;<a href="write_batch.cc.html#L105" title="db/write_batch.cc:105">Delete</a>(<a href="../include/leveldb/options.h.html#L169" title="include/leveldb/options.h:169">WriteOptions</a>(), k);<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li><a id="L296">&#x200c;</a>&nbsp; std::string <span class="linkable">Get</span>(<span class="Type">const</span> std::string&amp; k, <span class="Type">const</span> Snapshot* snapshot = <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; <a href="../include/leveldb/options.h.html#L143" title="include/leveldb/options.h:143">ReadOptions</a> options;<br/></li>
<li>&nbsp; &nbsp; options.snapshot = snapshot;<br/></li>
<li>&nbsp; &nbsp; std::string result;<br/></li>
<li>&nbsp; &nbsp; <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> s = db_-&gt;<a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(options, k, &amp;result);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (s.<a href="../include/leveldb/status.h.html#L55" title="include/leveldb/status.h:55">IsNotFound</a>()) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; result = <span class="Constant">&quot;NOT_FOUND&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (!s.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>()) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; result = s.<a href="../table/table_test.cc.html#L587" title="table/table_test.cc:587">ToString</a>();<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> result;<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// Return a string that contains all <a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>,<a href="../table/two_level_iterator.cc.html#L41" title="table/two_level_iterator.cc:41">value</a> pairs in order,<br/></li>
<li></span>&nbsp; <span class="Comment">// formatted like &quot;(k1-&gt;v1)(k2-&gt;v2)&quot;.<br/></li>
<li><a id="L311">&#x200c;</a></span>&nbsp; std::string <span class="linkable">Contents</span>() {<br/></li>
<li>&nbsp; &nbsp; std::vector&lt;std::string&gt; forward;<br/></li>
<li>&nbsp; &nbsp; std::string result;<br/></li>
<li>&nbsp; &nbsp; <a href="../table/iterator.cc.html#L9" title="table/iterator.cc:9">Iterator</a>* <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a> = db_-&gt;<a href="../table/table_test.cc.html#L209" title="table/table_test.cc:209">NewIterator</a>(<a href="../include/leveldb/options.h.html#L143" title="include/leveldb/options.h:143">ReadOptions</a>());<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L98" title="table/two_level_iterator.cc:98">SeekToFirst</a>(); <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L34" title="table/two_level_iterator.cc:34">Valid</a>(); <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L112" title="table/two_level_iterator.cc:112">Next</a>()) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; std::string s = <a href="#L463" title="db/db_test.cc:463">IterStatus</a>(<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; result.push_back(<span class="Constant">'('</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; result.append(s);<br/></li>
<li>&nbsp; &nbsp; &nbsp; result.push_back(<span class="Constant">')'</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; forward.push_back(s);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// <a href="corruption_test.cc.html#L88" title="db/corruption_test.cc:88">Check</a> reverse iteration results are the reverse of forward results<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">size_t</span> matched = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L105" title="table/two_level_iterator.cc:105">SeekToLast</a>(); <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L34" title="table/two_level_iterator.cc:34">Valid</a>(); <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L118" title="table/two_level_iterator.cc:118">Prev</a>()) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../util/testharness.h.html#L112" title="util/testharness.h:112">ASSERT_LT</a>(matched, forward.<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>());<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L463" title="db/db_test.cc:463">IterStatus</a>(<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>), forward[forward.<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>() - matched - <span class="Constant">1</span>]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; matched++;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(matched, forward.<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>());<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">delete</span> <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> result;<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li><a id="L336">&#x200c;</a>&nbsp; std::string <span class="linkable">AllEntriesFor</span>(<span class="Type">const</span> <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>&amp; <a href="dbformat.h.html#L159" title="db/dbformat.h:159">user_key</a>) {<br/></li>
<li>&nbsp; &nbsp; <a href="../table/iterator.cc.html#L9" title="table/iterator.cc:9">Iterator</a>* <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a> = <a href="#L253" title="db/db_test.cc:253">dbfull</a>()-&gt;<a href="db_impl.cc.html#L1066" title="db/db_impl.cc:1066">TEST_NewInternalIterator</a>();<br/></li>
<li>&nbsp; &nbsp; <a href="dbformat.h.html#L148" title="db/dbformat.h:148">InternalKey</a> <a href="../include/leveldb/env.h.html#L280" title="include/leveldb/env.h:280">target</a>(<a href="dbformat.h.html#L159" title="db/dbformat.h:159">user_key</a>, kMaxSequenceNumber, kTypeValue);<br/></li>
<li>&nbsp; &nbsp; <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L91" title="table/two_level_iterator.cc:91">Seek</a>(<a href="../include/leveldb/env.h.html#L280" title="include/leveldb/env.h:280">target</a>.<a href="dbformat.h.html#L154" title="db/dbformat.h:154">Encode</a>());<br/></li>
<li>&nbsp; &nbsp; std::string result;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a>().<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>()) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; result = <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a>().<a href="../table/table_test.cc.html#L587" title="table/table_test.cc:587">ToString</a>();<br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; result = <span class="Constant">&quot;[ &quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Type">bool</span> first = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">while</span> (<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L34" title="table/two_level_iterator.cc:34">Valid</a>()) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="dbformat.h.html#L70" title="db/dbformat.h:70">ParsedInternalKey</a> ikey;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!<a href="dbformat.h.html#L176" title="db/dbformat.h:176">ParseInternalKey</a>(<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>(), &amp;ikey)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; result += <span class="Constant">&quot;CORRUPTED&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (last_options_.comparator-&gt;<a href="../table/table_test.cc.html#L44" title="table/table_test.cc:44">Compare</a>(ikey.<a href="dbformat.h.html#L159" title="db/dbformat.h:159">user_key</a>, <a href="dbformat.h.html#L159" title="db/dbformat.h:159">user_key</a>) != <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!first) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; result += <span class="Constant">&quot;, &quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; first = <span class="Constant">false</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (ikey.type) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> kTypeValue:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; result += <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L41" title="table/two_level_iterator.cc:41">value</a>().<a href="../table/table_test.cc.html#L587" title="table/table_test.cc:587">ToString</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> kTypeDeletion:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; result += <span class="Constant">&quot;DEL&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L112" title="table/two_level_iterator.cc:112">Next</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!first) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; result += <span class="Constant">&quot; &quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; result += <span class="Constant">&quot;]&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">delete</span> <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> result;<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li><a id="L378">&#x200c;</a>&nbsp; <span class="Type">int</span> <span class="linkable">NumTableFilesAtLevel</span>(<span class="Type">int</span> <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>) {<br/></li>
<li>&nbsp; &nbsp; std::string property;<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; db_-&gt;<a href="db_impl.cc.html#L1349" title="db/db_impl.cc:1349">GetProperty</a>(<span class="Constant">&quot;leveldb.num-files-at-<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>&quot;</span> + <a href="../util/logging.cc.html#L36" title="util/logging.cc:36">NumberToString</a>(<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;property));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> atoi(property.c_str());<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li><a id="L386">&#x200c;</a>&nbsp; <span class="Type">int</span> <span class="linkable">TotalTableFiles</span>() {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span> result = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (<span class="Type">int</span> <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> = <span class="Constant">0</span>; <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> &lt; config::kNumLevels; <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; result += <a href="#L378" title="db/db_test.cc:378">NumTableFilesAtLevel</a>(<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> result;<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// Return spread of files per <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a><br/></li>
<li><a id="L395">&#x200c;</a></span>&nbsp; std::string <span class="linkable">FilesPerLevel</span>() {<br/></li>
<li>&nbsp; &nbsp; std::string result;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span> last_non_zero_offset = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (<span class="Type">int</span> <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> = <span class="Constant">0</span>; <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> &lt; config::kNumLevels; <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Type">int</span> f = <a href="#L378" title="db/db_test.cc:378">NumTableFilesAtLevel</a>(<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Type">char</span> buf[<span class="Constant">100</span>];<br/></li>
<li>&nbsp; &nbsp; &nbsp; snprintf(buf, <span class="Statement">sizeof</span>(buf), <span class="Constant">&quot;</span><span class="Special">%s%d</span><span class="Constant">&quot;</span>, (<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> ? <span class="Constant">&quot;,&quot;</span> : <span class="Constant">&quot;&quot;</span>), f);<br/></li>
<li>&nbsp; &nbsp; &nbsp; result += buf;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (f &gt; <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; last_non_zero_offset = result.<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; result.resize(last_non_zero_offset);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> result;<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li><a id="L411">&#x200c;</a>&nbsp; <span class="Type">int</span> <span class="linkable">CountFiles</span>() {<br/></li>
<li>&nbsp; &nbsp; std::vector&lt;std::string&gt; files;<br/></li>
<li>&nbsp; &nbsp; env_-&gt;<a href="../include/leveldb/env.h.html#L293" title="include/leveldb/env.h:293">GetChildren</a>(dbname_, &amp;files);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Statement">static_cast</span>&lt;<span class="Type">int</span>&gt;(files.<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>());<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li><a id="L417">&#x200c;</a>&nbsp; <span class="Type"><a href="../port/win/stdint.h.html#L22" title="port/win/stdint.h:22">uint64_t</a></span> <span class="linkable">Size</span>(<span class="Type">const</span> <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>&amp; start, <span class="Type">const</span> <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>&amp; limit) {<br/></li>
<li>&nbsp; &nbsp; <a href="../include/leveldb/db.h.html#L33" title="include/leveldb/db.h:33">Range</a> r(start, limit);<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../port/win/stdint.h.html#L22" title="port/win/stdint.h:22">uint64_t</a></span> <a href="../table/format.h.html#L31" title="table/format.h:31">size</a>;<br/></li>
<li>&nbsp; &nbsp; db_-&gt;<a href="db_impl.cc.html#L1403" title="db/db_impl.cc:1403">GetApproximateSizes</a>(&amp;r, <span class="Constant">1</span>, &amp;<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../table/format.h.html#L31" title="table/format.h:31">size</a>;<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li><a id="L424">&#x200c;</a>&nbsp; <span class="Type">void</span> <span class="linkable">Compact</span>(<span class="Type">const</span> <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>&amp; start, <span class="Type">const</span> <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>&amp; limit) {<br/></li>
<li>&nbsp; &nbsp; db_-&gt;<a href="version_set.cc.html#L1364" title="db/version_set.cc:1364">CompactRange</a>(&amp;start, &amp;limit);<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// Do n memtable compactions, each of which produces an sstable<br/></li>
<li></span>&nbsp; <span class="Comment">// covering the range [small,large].<br/></li>
<li><a id="L430">&#x200c;</a></span>&nbsp; <span class="Type">void</span> <span class="linkable">MakeTables</span>(<span class="Type">int</span> n, <span class="Type">const</span> std::string&amp; small, <span class="Type">const</span> std::string&amp; large) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (<span class="Type">int</span> i = <span class="Constant">0</span>; i &lt; n; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(small, <span class="Constant">&quot;begin&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(large, <span class="Constant">&quot;end&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L253" title="db/db_test.cc:253">dbfull</a>()-&gt;<a href="db_impl.cc.html#L590" title="db/db_impl.cc:590">TEST_CompactMemTable</a>();<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// Prevent pushing of new sstables into deeper levels by adding<br/></li>
<li></span>&nbsp; <span class="Comment">// tables that cover a specified range to all levels.<br/></li>
<li><a id="L440">&#x200c;</a></span>&nbsp; <span class="Type">void</span> <span class="linkable">FillLevels</span>(<span class="Type">const</span> std::string&amp; smallest, <span class="Type">const</span> std::string&amp; largest) {<br/></li>
<li>&nbsp; &nbsp; <a href="#L430" title="db/db_test.cc:430">MakeTables</a>(config::kNumLevels, smallest, largest);<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li><a id="L444">&#x200c;</a>&nbsp; <span class="Type">void</span> <span class="linkable">DumpFileCounts</span>(<span class="Type">const</span> <span class="Type">char</span>* label) {<br/></li>
<li>&nbsp; &nbsp; fprintf(<span class="Constant">stderr</span>, <span class="Constant">&quot;---</span><span class="Special">\n%s</span><span class="Constant">:</span><span class="Special">\n</span><span class="Constant">&quot;</span>, label);<br/></li>
<li>&nbsp; &nbsp; fprintf(<span class="Constant">stderr</span>, <span class="Constant">&quot;maxoverlap: </span><span class="Special">%lld\n</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">static_cast</span>&lt;<span class="Type">long</span> <span class="Type">long</span>&gt;(<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L253" title="db/db_test.cc:253">dbfull</a>()-&gt;<a href="db_impl.cc.html#L1072" title="db/db_impl.cc:1072">TEST_MaxNextLevelOverlappingBytes</a>()));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (<span class="Type">int</span> <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> = <span class="Constant">0</span>; <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> &lt; config::kNumLevels; <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Type">int</span> num = <a href="#L378" title="db/db_test.cc:378">NumTableFilesAtLevel</a>(<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (num &gt; <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; fprintf(<span class="Constant">stderr</span>, <span class="Constant">&quot;&nbsp; <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> </span><span class="Special">%3d</span><span class="Constant"> : </span><span class="Special">%d</span><span class="Constant"> files</span><span class="Special">\n</span><span class="Constant">&quot;</span>, <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>, num);<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li><a id="L457">&#x200c;</a>&nbsp; std::string <span class="linkable">DumpSSTableList</span>() {<br/></li>
<li>&nbsp; &nbsp; std::string property;<br/></li>
<li>&nbsp; &nbsp; db_-&gt;<a href="db_impl.cc.html#L1349" title="db/db_impl.cc:1349">GetProperty</a>(<span class="Constant">&quot;leveldb.sstables&quot;</span>, &amp;property);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> property;<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li><a id="L463">&#x200c;</a>&nbsp; std::string <span class="linkable">IterStatus</span>(<a href="../table/iterator.cc.html#L9" title="table/iterator.cc:9">Iterator</a>* <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>) {<br/></li>
<li>&nbsp; &nbsp; std::string result;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L34" title="table/two_level_iterator.cc:34">Valid</a>()) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; result = <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>().<a href="../table/table_test.cc.html#L587" title="table/table_test.cc:587">ToString</a>() + <span class="Constant">&quot;-&gt;&quot;</span> + <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L41" title="table/two_level_iterator.cc:41">value</a>().<a href="../table/table_test.cc.html#L587" title="table/table_test.cc:587">ToString</a>();<br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; result = <span class="Constant">&quot;(invalid)&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> result;<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li><a id="L473">&#x200c;</a>&nbsp; <span class="Type">bool</span> <span class="linkable">DeleteAnSSTFile</span>() {<br/></li>
<li>&nbsp; &nbsp; std::vector&lt;std::string&gt; filenames;<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(env_-&gt;<a href="../include/leveldb/env.h.html#L293" title="include/leveldb/env.h:293">GetChildren</a>(dbname_, &amp;filenames));<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../port/win/stdint.h.html#L22" title="port/win/stdint.h:22">uint64_t</a></span> number;<br/></li>
<li>&nbsp; &nbsp; <a href="filename.h.html#L20" title="db/filename.h:20">FileType</a> type;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (<span class="Type">size_t</span> i = <span class="Constant">0</span>; i &lt; filenames.<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>(); i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="filename.cc.html#L80" title="db/filename.cc:80">ParseFileName</a>(filenames[i], &amp;number, &amp;type) &amp;&amp; type == kTableFile) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(env_-&gt;<a href="../include/leveldb/env.h.html#L296" title="include/leveldb/env.h:296">DeleteFile</a>(<a href="filename.cc.html#L32" title="db/filename.cc:32">TableFileName</a>(dbname_, number)));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">false</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// Returns number of files renamed.<br/></li>
<li><a id="L488">&#x200c;</a></span>&nbsp; <span class="Type">int</span> <span class="linkable">RenameLDBToSST</span>() {<br/></li>
<li>&nbsp; &nbsp; std::vector&lt;std::string&gt; filenames;<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(env_-&gt;<a href="../include/leveldb/env.h.html#L293" title="include/leveldb/env.h:293">GetChildren</a>(dbname_, &amp;filenames));<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../port/win/stdint.h.html#L22" title="port/win/stdint.h:22">uint64_t</a></span> number;<br/></li>
<li>&nbsp; &nbsp; <a href="filename.h.html#L20" title="db/filename.h:20">FileType</a> type;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span> files_renamed = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (<span class="Type">size_t</span> i = <span class="Constant">0</span>; i &lt; filenames.<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>(); i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="filename.cc.html#L80" title="db/filename.cc:80">ParseFileName</a>(filenames[i], &amp;number, &amp;type) &amp;&amp; type == kTableFile) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">const</span> std::string from = <a href="filename.cc.html#L32" title="db/filename.cc:32">TableFileName</a>(dbname_, number);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">const</span> std::string to = <a href="filename.cc.html#L37" title="db/filename.cc:37">SSTTableFileName</a>(dbname_, number);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(env_-&gt;<a href="../include/leveldb/env.h.html#L302" title="include/leveldb/env.h:302">RenameFile</a>(from, to));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; files_renamed++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> files_renamed;<br/></li>
<li>&nbsp; }<br/></li>
<li>};<br/></li>
<li><br/></li>
<li><a id="L506">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L209" title="db/db_test.cc:209">DBTest</a>, Empty) {<br/></li>
<li>&nbsp; <span class="Statement">do</span> {<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(db_ != <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;NOT_FOUND&quot;</span>, <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(<span class="Constant">&quot;foo&quot;</span>));<br/></li>
<li>&nbsp; } <span class="Statement">while</span> (<a href="../table/table_builder.cc.html#L76" title="table/table_builder.cc:76">ChangeOptions</a>());<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L513">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L209" title="db/db_test.cc:209">DBTest</a>, ReadWrite) {<br/></li>
<li>&nbsp; <span class="Statement">do</span> {<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;foo&quot;</span>, <span class="Constant">&quot;v1&quot;</span>));<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;v1&quot;</span>, <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(<span class="Constant">&quot;foo&quot;</span>));<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;bar&quot;</span>, <span class="Constant">&quot;v2&quot;</span>));<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;foo&quot;</span>, <span class="Constant">&quot;v3&quot;</span>));<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;v3&quot;</span>, <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(<span class="Constant">&quot;foo&quot;</span>));<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;v2&quot;</span>, <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(<span class="Constant">&quot;bar&quot;</span>));<br/></li>
<li>&nbsp; } <span class="Statement">while</span> (<a href="../table/table_builder.cc.html#L76" title="table/table_builder.cc:76">ChangeOptions</a>());<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L524">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L209" title="db/db_test.cc:209">DBTest</a>, PutDeleteGet) {<br/></li>
<li>&nbsp; <span class="Statement">do</span> {<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(db_-&gt;<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<a href="../include/leveldb/options.h.html#L169" title="include/leveldb/options.h:169">WriteOptions</a>(), <span class="Constant">&quot;foo&quot;</span>, <span class="Constant">&quot;v1&quot;</span>));<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;v1&quot;</span>, <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(<span class="Constant">&quot;foo&quot;</span>));<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(db_-&gt;<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<a href="../include/leveldb/options.h.html#L169" title="include/leveldb/options.h:169">WriteOptions</a>(), <span class="Constant">&quot;foo&quot;</span>, <span class="Constant">&quot;v2&quot;</span>));<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;v2&quot;</span>, <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(<span class="Constant">&quot;foo&quot;</span>));<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(db_-&gt;<a href="write_batch.cc.html#L105" title="db/write_batch.cc:105">Delete</a>(<a href="../include/leveldb/options.h.html#L169" title="include/leveldb/options.h:169">WriteOptions</a>(), <span class="Constant">&quot;foo&quot;</span>));<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;NOT_FOUND&quot;</span>, <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(<span class="Constant">&quot;foo&quot;</span>));<br/></li>
<li>&nbsp; } <span class="Statement">while</span> (<a href="../table/table_builder.cc.html#L76" title="table/table_builder.cc:76">ChangeOptions</a>());<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L535">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L209" title="db/db_test.cc:209">DBTest</a>, GetFromImmutableLayer) {<br/></li>
<li>&nbsp; <span class="Statement">do</span> {<br/></li>
<li>&nbsp; &nbsp; <a href="../include/leveldb/options.h.html#L31" title="include/leveldb/options.h:31">Options</a> options = <a href="#L238" title="db/db_test.cc:238">CurrentOptions</a>();<br/></li>
<li>&nbsp; &nbsp; options.env = env_;<br/></li>
<li>&nbsp; &nbsp; options.write_buffer_size = <span class="Constant">100000</span>;&nbsp; <span class="Comment">// Small write buffer<br/></li>
<li></span>&nbsp; &nbsp; <a href="corruption_test.cc.html#L60" title="db/corruption_test.cc:60">Reopen</a>(&amp;options);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;foo&quot;</span>, <span class="Constant">&quot;v1&quot;</span>));<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;v1&quot;</span>, <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(<span class="Constant">&quot;foo&quot;</span>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; env_-&gt;delay_data_sync_.<a href="../port/atomic_pointer.h.html#L121" title="port/atomic_pointer.h:121">Release_Store</a>(env_);&nbsp; &nbsp; &nbsp; <span class="Comment">// <a href="../table/block.cc.html#L23" title="table/block.cc:23">Block</a> sync calls<br/></li>
<li></span>&nbsp; &nbsp; <a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;k1&quot;</span>, std::string(<span class="Constant">100000</span>, <span class="Constant">'x'</span>));&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">// Fill memtable<br/></li>
<li></span>&nbsp; &nbsp; <a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;k2&quot;</span>, std::string(<span class="Constant">100000</span>, <span class="Constant">'y'</span>));&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">// Trigger compaction<br/></li>
<li></span>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;v1&quot;</span>, <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(<span class="Constant">&quot;foo&quot;</span>));<br/></li>
<li>&nbsp; &nbsp; env_-&gt;delay_data_sync_.<a href="../port/atomic_pointer.h.html#L121" title="port/atomic_pointer.h:121">Release_Store</a>(<span class="Constant">NULL</span>);&nbsp; &nbsp; &nbsp; <span class="Comment">// <a href="../util/cache.cc.html#L220" title="util/cache.cc:220">Release</a> sync calls<br/></li>
<li></span>&nbsp; } <span class="Statement">while</span> (<a href="../table/table_builder.cc.html#L76" title="table/table_builder.cc:76">ChangeOptions</a>());<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L553">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L209" title="db/db_test.cc:209">DBTest</a>, GetFromVersions) {<br/></li>
<li>&nbsp; <span class="Statement">do</span> {<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;foo&quot;</span>, <span class="Constant">&quot;v1&quot;</span>));<br/></li>
<li>&nbsp; &nbsp; <a href="#L253" title="db/db_test.cc:253">dbfull</a>()-&gt;<a href="db_impl.cc.html#L590" title="db/db_impl.cc:590">TEST_CompactMemTable</a>();<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;v1&quot;</span>, <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(<span class="Constant">&quot;foo&quot;</span>));<br/></li>
<li>&nbsp; } <span class="Statement">while</span> (<a href="../table/table_builder.cc.html#L76" title="table/table_builder.cc:76">ChangeOptions</a>());<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L561">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L209" title="db/db_test.cc:209">DBTest</a>, <a href="db_impl.cc.html#L1143" title="db/db_impl.cc:1143">GetSnapshot</a>) {<br/></li>
<li>&nbsp; <span class="Statement">do</span> {<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// Try with both a short <a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a> and a long <a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a><br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">for</span> (<span class="Type">int</span> i = <span class="Constant">0</span>; i &lt; <span class="Constant">2</span>; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; std::string <a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a> = (i == <span class="Constant">0</span>) ? std::string(<span class="Constant">&quot;foo&quot;</span>) : std::string(<span class="Constant">200</span>, <span class="Constant">'x'</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>, <span class="Constant">&quot;v1&quot;</span>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Type">const</span> Snapshot* s1 = db_-&gt;<a href="db_impl.cc.html#L1143" title="db/db_impl.cc:1143">GetSnapshot</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>, <span class="Constant">&quot;v2&quot;</span>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;v2&quot;</span>, <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(<a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;v1&quot;</span>, <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(<a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>, s1));<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L253" title="db/db_test.cc:253">dbfull</a>()-&gt;<a href="db_impl.cc.html#L590" title="db/db_impl.cc:590">TEST_CompactMemTable</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;v2&quot;</span>, <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(<a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;v1&quot;</span>, <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(<a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>, s1));<br/></li>
<li>&nbsp; &nbsp; &nbsp; db_-&gt;<a href="db_impl.cc.html#L1148" title="db/db_impl.cc:1148">ReleaseSnapshot</a>(s1);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; } <span class="Statement">while</span> (<a href="../table/table_builder.cc.html#L76" title="table/table_builder.cc:76">ChangeOptions</a>());<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L579">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L209" title="db/db_test.cc:209">DBTest</a>, GetLevel0Ordering) {<br/></li>
<li>&nbsp; <span class="Statement">do</span> {<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// <a href="corruption_test.cc.html#L88" title="db/corruption_test.cc:88">Check</a> that we process <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>-0 files in correct order.&nbsp; The <a href="../include/leveldb/status.h.html#L84" title="include/leveldb/status.h:84">code</a><br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">// below generates two <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>-0 files where the earlier one comes<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">// before the later one in the <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>-0 file list since the earlier<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">// one has a smaller &quot;smallest&quot; <a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>.<br/></li>
<li></span>&nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;bar&quot;</span>, <span class="Constant">&quot;b&quot;</span>));<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;foo&quot;</span>, <span class="Constant">&quot;v1&quot;</span>));<br/></li>
<li>&nbsp; &nbsp; <a href="#L253" title="db/db_test.cc:253">dbfull</a>()-&gt;<a href="db_impl.cc.html#L590" title="db/db_impl.cc:590">TEST_CompactMemTable</a>();<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;foo&quot;</span>, <span class="Constant">&quot;v2&quot;</span>));<br/></li>
<li>&nbsp; &nbsp; <a href="#L253" title="db/db_test.cc:253">dbfull</a>()-&gt;<a href="db_impl.cc.html#L590" title="db/db_impl.cc:590">TEST_CompactMemTable</a>();<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;v2&quot;</span>, <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(<span class="Constant">&quot;foo&quot;</span>));<br/></li>
<li>&nbsp; } <span class="Statement">while</span> (<a href="../table/table_builder.cc.html#L76" title="table/table_builder.cc:76">ChangeOptions</a>());<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L594">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L209" title="db/db_test.cc:209">DBTest</a>, GetOrderedByLevels) {<br/></li>
<li>&nbsp; <span class="Statement">do</span> {<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;foo&quot;</span>, <span class="Constant">&quot;v1&quot;</span>));<br/></li>
<li>&nbsp; &nbsp; <a href="#L424" title="db/db_test.cc:424">Compact</a>(<span class="Constant">&quot;a&quot;</span>, <span class="Constant">&quot;z&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;v1&quot;</span>, <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(<span class="Constant">&quot;foo&quot;</span>));<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;foo&quot;</span>, <span class="Constant">&quot;v2&quot;</span>));<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;v2&quot;</span>, <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(<span class="Constant">&quot;foo&quot;</span>));<br/></li>
<li>&nbsp; &nbsp; <a href="#L253" title="db/db_test.cc:253">dbfull</a>()-&gt;<a href="db_impl.cc.html#L590" title="db/db_impl.cc:590">TEST_CompactMemTable</a>();<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;v2&quot;</span>, <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(<span class="Constant">&quot;foo&quot;</span>));<br/></li>
<li>&nbsp; } <span class="Statement">while</span> (<a href="../table/table_builder.cc.html#L76" title="table/table_builder.cc:76">ChangeOptions</a>());<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L606">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L209" title="db/db_test.cc:209">DBTest</a>, GetPicksCorrectFile) {<br/></li>
<li>&nbsp; <span class="Statement">do</span> {<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// Arrange to have multiple files in a non-<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>-0 <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>.<br/></li>
<li></span>&nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;a&quot;</span>, <span class="Constant">&quot;va&quot;</span>));<br/></li>
<li>&nbsp; &nbsp; <a href="#L424" title="db/db_test.cc:424">Compact</a>(<span class="Constant">&quot;a&quot;</span>, <span class="Constant">&quot;b&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;x&quot;</span>, <span class="Constant">&quot;vx&quot;</span>));<br/></li>
<li>&nbsp; &nbsp; <a href="#L424" title="db/db_test.cc:424">Compact</a>(<span class="Constant">&quot;x&quot;</span>, <span class="Constant">&quot;y&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;f&quot;</span>, <span class="Constant">&quot;vf&quot;</span>));<br/></li>
<li>&nbsp; &nbsp; <a href="#L424" title="db/db_test.cc:424">Compact</a>(<span class="Constant">&quot;f&quot;</span>, <span class="Constant">&quot;g&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;va&quot;</span>, <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(<span class="Constant">&quot;a&quot;</span>));<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;vf&quot;</span>, <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(<span class="Constant">&quot;f&quot;</span>));<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;vx&quot;</span>, <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(<span class="Constant">&quot;x&quot;</span>));<br/></li>
<li>&nbsp; } <span class="Statement">while</span> (<a href="../table/table_builder.cc.html#L76" title="table/table_builder.cc:76">ChangeOptions</a>());<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L621">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L209" title="db/db_test.cc:209">DBTest</a>, GetEncountersEmptyLevel) {<br/></li>
<li>&nbsp; <span class="Statement">do</span> {<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// Arrange for the following to happen:<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">//&nbsp;&nbsp; * sstable A in <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> 0<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">//&nbsp;&nbsp; * nothing in <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> 1<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">//&nbsp;&nbsp; * sstable B in <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> 2<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">// Then do enough <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>() calls to arrange for an automatic compaction<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">// of sstable A.&nbsp; A bug would cause the compaction to be marked as<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">// occurring at <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> 1 (instead of the correct <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> 0).<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// Step 1: First place sstables in levels 0 and 2<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">int</span> compaction_count = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (<a href="#L378" title="db/db_test.cc:378">NumTableFilesAtLevel</a>(<span class="Constant">0</span>) == <span class="Constant">0</span> ||<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L378" title="db/db_test.cc:378">NumTableFilesAtLevel</a>(<span class="Constant">2</span>) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../util/testharness.h.html#L111" title="util/testharness.h:111">ASSERT_LE</a>(compaction_count, <span class="Constant">100</span>) &lt;&lt; <span class="Constant">&quot;could not fill levels 0 and 2&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; compaction_count++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;a&quot;</span>, <span class="Constant">&quot;begin&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;z&quot;</span>, <span class="Constant">&quot;end&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L253" title="db/db_test.cc:253">dbfull</a>()-&gt;<a href="db_impl.cc.html#L590" title="db/db_impl.cc:590">TEST_CompactMemTable</a>();<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// Step 2: <a href="../include/leveldb/slice.h.html#L56" title="include/leveldb/slice.h:56">clear</a> <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> 1 if necessary.<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L253" title="db/db_test.cc:253">dbfull</a>()-&gt;<a href="db_impl.cc.html#L553" title="db/db_impl.cc:553">TEST_CompactRange</a>(<span class="Constant">1</span>, <span class="Constant">NULL</span>, <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L378" title="db/db_test.cc:378">NumTableFilesAtLevel</a>(<span class="Constant">0</span>), <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L378" title="db/db_test.cc:378">NumTableFilesAtLevel</a>(<span class="Constant">1</span>), <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L378" title="db/db_test.cc:378">NumTableFilesAtLevel</a>(<span class="Constant">2</span>), <span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// Step 3: read a bunch of times<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">for</span> (<span class="Type">int</span> i = <span class="Constant">0</span>; i &lt; <span class="Constant">1000</span>; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;NOT_FOUND&quot;</span>, <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(<span class="Constant">&quot;missing&quot;</span>));<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// Step 4: <a href="skiplist_test.cc.html#L315" title="db/skiplist_test.cc:315">Wait</a> for compaction to finish<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L52" title="db/db_test.cc:52">DelayMilliseconds</a>(<span class="Constant">1000</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L378" title="db/db_test.cc:378">NumTableFilesAtLevel</a>(<span class="Constant">0</span>), <span class="Constant">0</span>);<br/></li>
<li>&nbsp; } <span class="Statement">while</span> (<a href="../table/table_builder.cc.html#L76" title="table/table_builder.cc:76">ChangeOptions</a>());<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L660">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L209" title="db/db_test.cc:209">DBTest</a>, IterEmpty) {<br/></li>
<li>&nbsp; <a href="../table/iterator.cc.html#L9" title="table/iterator.cc:9">Iterator</a>* <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a> = db_-&gt;<a href="../table/table_test.cc.html#L209" title="table/table_test.cc:209">NewIterator</a>(<a href="../include/leveldb/options.h.html#L143" title="include/leveldb/options.h:143">ReadOptions</a>());<br/></li>
<li><br/></li>
<li>&nbsp; <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L98" title="table/two_level_iterator.cc:98">SeekToFirst</a>();<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L463" title="db/db_test.cc:463">IterStatus</a>(<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>), <span class="Constant">&quot;(invalid)&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L105" title="table/two_level_iterator.cc:105">SeekToLast</a>();<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L463" title="db/db_test.cc:463">IterStatus</a>(<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>), <span class="Constant">&quot;(invalid)&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L91" title="table/two_level_iterator.cc:91">Seek</a>(<span class="Constant">&quot;foo&quot;</span>);<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L463" title="db/db_test.cc:463">IterStatus</a>(<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>), <span class="Constant">&quot;(invalid)&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">delete</span> <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L675">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L209" title="db/db_test.cc:209">DBTest</a>, IterSingle) {<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;a&quot;</span>, <span class="Constant">&quot;va&quot;</span>));<br/></li>
<li>&nbsp; <a href="../table/iterator.cc.html#L9" title="table/iterator.cc:9">Iterator</a>* <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a> = db_-&gt;<a href="../table/table_test.cc.html#L209" title="table/table_test.cc:209">NewIterator</a>(<a href="../include/leveldb/options.h.html#L143" title="include/leveldb/options.h:143">ReadOptions</a>());<br/></li>
<li><br/></li>
<li>&nbsp; <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L98" title="table/two_level_iterator.cc:98">SeekToFirst</a>();<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L463" title="db/db_test.cc:463">IterStatus</a>(<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>), <span class="Constant">&quot;a-&gt;va&quot;</span>);<br/></li>
<li>&nbsp; <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L112" title="table/two_level_iterator.cc:112">Next</a>();<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L463" title="db/db_test.cc:463">IterStatus</a>(<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>), <span class="Constant">&quot;(invalid)&quot;</span>);<br/></li>
<li>&nbsp; <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L98" title="table/two_level_iterator.cc:98">SeekToFirst</a>();<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L463" title="db/db_test.cc:463">IterStatus</a>(<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>), <span class="Constant">&quot;a-&gt;va&quot;</span>);<br/></li>
<li>&nbsp; <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L118" title="table/two_level_iterator.cc:118">Prev</a>();<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L463" title="db/db_test.cc:463">IterStatus</a>(<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>), <span class="Constant">&quot;(invalid)&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L105" title="table/two_level_iterator.cc:105">SeekToLast</a>();<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L463" title="db/db_test.cc:463">IterStatus</a>(<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>), <span class="Constant">&quot;a-&gt;va&quot;</span>);<br/></li>
<li>&nbsp; <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L112" title="table/two_level_iterator.cc:112">Next</a>();<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L463" title="db/db_test.cc:463">IterStatus</a>(<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>), <span class="Constant">&quot;(invalid)&quot;</span>);<br/></li>
<li>&nbsp; <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L105" title="table/two_level_iterator.cc:105">SeekToLast</a>();<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L463" title="db/db_test.cc:463">IterStatus</a>(<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>), <span class="Constant">&quot;a-&gt;va&quot;</span>);<br/></li>
<li>&nbsp; <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L118" title="table/two_level_iterator.cc:118">Prev</a>();<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L463" title="db/db_test.cc:463">IterStatus</a>(<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>), <span class="Constant">&quot;(invalid)&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L91" title="table/two_level_iterator.cc:91">Seek</a>(<span class="Constant">&quot;&quot;</span>);<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L463" title="db/db_test.cc:463">IterStatus</a>(<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>), <span class="Constant">&quot;a-&gt;va&quot;</span>);<br/></li>
<li>&nbsp; <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L112" title="table/two_level_iterator.cc:112">Next</a>();<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L463" title="db/db_test.cc:463">IterStatus</a>(<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>), <span class="Constant">&quot;(invalid)&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L91" title="table/two_level_iterator.cc:91">Seek</a>(<span class="Constant">&quot;a&quot;</span>);<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L463" title="db/db_test.cc:463">IterStatus</a>(<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>), <span class="Constant">&quot;a-&gt;va&quot;</span>);<br/></li>
<li>&nbsp; <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L112" title="table/two_level_iterator.cc:112">Next</a>();<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L463" title="db/db_test.cc:463">IterStatus</a>(<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>), <span class="Constant">&quot;(invalid)&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L91" title="table/two_level_iterator.cc:91">Seek</a>(<span class="Constant">&quot;b&quot;</span>);<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L463" title="db/db_test.cc:463">IterStatus</a>(<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>), <span class="Constant">&quot;(invalid)&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">delete</span> <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L713">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L209" title="db/db_test.cc:209">DBTest</a>, IterMulti) {<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;a&quot;</span>, <span class="Constant">&quot;va&quot;</span>));<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;b&quot;</span>, <span class="Constant">&quot;vb&quot;</span>));<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;c&quot;</span>, <span class="Constant">&quot;vc&quot;</span>));<br/></li>
<li>&nbsp; <a href="../table/iterator.cc.html#L9" title="table/iterator.cc:9">Iterator</a>* <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a> = db_-&gt;<a href="../table/table_test.cc.html#L209" title="table/table_test.cc:209">NewIterator</a>(<a href="../include/leveldb/options.h.html#L143" title="include/leveldb/options.h:143">ReadOptions</a>());<br/></li>
<li><br/></li>
<li>&nbsp; <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L98" title="table/two_level_iterator.cc:98">SeekToFirst</a>();<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L463" title="db/db_test.cc:463">IterStatus</a>(<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>), <span class="Constant">&quot;a-&gt;va&quot;</span>);<br/></li>
<li>&nbsp; <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L112" title="table/two_level_iterator.cc:112">Next</a>();<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L463" title="db/db_test.cc:463">IterStatus</a>(<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>), <span class="Constant">&quot;b-&gt;vb&quot;</span>);<br/></li>
<li>&nbsp; <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L112" title="table/two_level_iterator.cc:112">Next</a>();<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L463" title="db/db_test.cc:463">IterStatus</a>(<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>), <span class="Constant">&quot;c-&gt;vc&quot;</span>);<br/></li>
<li>&nbsp; <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L112" title="table/two_level_iterator.cc:112">Next</a>();<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L463" title="db/db_test.cc:463">IterStatus</a>(<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>), <span class="Constant">&quot;(invalid)&quot;</span>);<br/></li>
<li>&nbsp; <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L98" title="table/two_level_iterator.cc:98">SeekToFirst</a>();<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L463" title="db/db_test.cc:463">IterStatus</a>(<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>), <span class="Constant">&quot;a-&gt;va&quot;</span>);<br/></li>
<li>&nbsp; <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L118" title="table/two_level_iterator.cc:118">Prev</a>();<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L463" title="db/db_test.cc:463">IterStatus</a>(<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>), <span class="Constant">&quot;(invalid)&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L105" title="table/two_level_iterator.cc:105">SeekToLast</a>();<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L463" title="db/db_test.cc:463">IterStatus</a>(<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>), <span class="Constant">&quot;c-&gt;vc&quot;</span>);<br/></li>
<li>&nbsp; <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L118" title="table/two_level_iterator.cc:118">Prev</a>();<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L463" title="db/db_test.cc:463">IterStatus</a>(<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>), <span class="Constant">&quot;b-&gt;vb&quot;</span>);<br/></li>
<li>&nbsp; <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L118" title="table/two_level_iterator.cc:118">Prev</a>();<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L463" title="db/db_test.cc:463">IterStatus</a>(<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>), <span class="Constant">&quot;a-&gt;va&quot;</span>);<br/></li>
<li>&nbsp; <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L118" title="table/two_level_iterator.cc:118">Prev</a>();<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L463" title="db/db_test.cc:463">IterStatus</a>(<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>), <span class="Constant">&quot;(invalid)&quot;</span>);<br/></li>
<li>&nbsp; <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L105" title="table/two_level_iterator.cc:105">SeekToLast</a>();<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L463" title="db/db_test.cc:463">IterStatus</a>(<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>), <span class="Constant">&quot;c-&gt;vc&quot;</span>);<br/></li>
<li>&nbsp; <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L112" title="table/two_level_iterator.cc:112">Next</a>();<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L463" title="db/db_test.cc:463">IterStatus</a>(<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>), <span class="Constant">&quot;(invalid)&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L91" title="table/two_level_iterator.cc:91">Seek</a>(<span class="Constant">&quot;&quot;</span>);<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L463" title="db/db_test.cc:463">IterStatus</a>(<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>), <span class="Constant">&quot;a-&gt;va&quot;</span>);<br/></li>
<li>&nbsp; <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L91" title="table/two_level_iterator.cc:91">Seek</a>(<span class="Constant">&quot;a&quot;</span>);<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L463" title="db/db_test.cc:463">IterStatus</a>(<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>), <span class="Constant">&quot;a-&gt;va&quot;</span>);<br/></li>
<li>&nbsp; <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L91" title="table/two_level_iterator.cc:91">Seek</a>(<span class="Constant">&quot;ax&quot;</span>);<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L463" title="db/db_test.cc:463">IterStatus</a>(<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>), <span class="Constant">&quot;b-&gt;vb&quot;</span>);<br/></li>
<li>&nbsp; <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L91" title="table/two_level_iterator.cc:91">Seek</a>(<span class="Constant">&quot;b&quot;</span>);<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L463" title="db/db_test.cc:463">IterStatus</a>(<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>), <span class="Constant">&quot;b-&gt;vb&quot;</span>);<br/></li>
<li>&nbsp; <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L91" title="table/two_level_iterator.cc:91">Seek</a>(<span class="Constant">&quot;z&quot;</span>);<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L463" title="db/db_test.cc:463">IterStatus</a>(<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>), <span class="Constant">&quot;(invalid)&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// Switch from reverse to forward<br/></li>
<li></span>&nbsp; <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L105" title="table/two_level_iterator.cc:105">SeekToLast</a>();<br/></li>
<li>&nbsp; <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L118" title="table/two_level_iterator.cc:118">Prev</a>();<br/></li>
<li>&nbsp; <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L118" title="table/two_level_iterator.cc:118">Prev</a>();<br/></li>
<li>&nbsp; <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L112" title="table/two_level_iterator.cc:112">Next</a>();<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L463" title="db/db_test.cc:463">IterStatus</a>(<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>), <span class="Constant">&quot;b-&gt;vb&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// Switch from forward to reverse<br/></li>
<li></span>&nbsp; <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L98" title="table/two_level_iterator.cc:98">SeekToFirst</a>();<br/></li>
<li>&nbsp; <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L112" title="table/two_level_iterator.cc:112">Next</a>();<br/></li>
<li>&nbsp; <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L112" title="table/two_level_iterator.cc:112">Next</a>();<br/></li>
<li>&nbsp; <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L118" title="table/two_level_iterator.cc:118">Prev</a>();<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L463" title="db/db_test.cc:463">IterStatus</a>(<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>), <span class="Constant">&quot;b-&gt;vb&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// Make sure <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a> stays at snapshot<br/></li>
<li></span>&nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;a&quot;</span>,&nbsp; <span class="Constant">&quot;va2&quot;</span>));<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;a2&quot;</span>, <span class="Constant">&quot;va3&quot;</span>));<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;b&quot;</span>,&nbsp; <span class="Constant">&quot;vb2&quot;</span>));<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;c&quot;</span>,&nbsp; <span class="Constant">&quot;vc2&quot;</span>));<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L105" title="db/write_batch.cc:105">Delete</a>(<span class="Constant">&quot;b&quot;</span>));<br/></li>
<li>&nbsp; <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L98" title="table/two_level_iterator.cc:98">SeekToFirst</a>();<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L463" title="db/db_test.cc:463">IterStatus</a>(<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>), <span class="Constant">&quot;a-&gt;va&quot;</span>);<br/></li>
<li>&nbsp; <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L112" title="table/two_level_iterator.cc:112">Next</a>();<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L463" title="db/db_test.cc:463">IterStatus</a>(<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>), <span class="Constant">&quot;b-&gt;vb&quot;</span>);<br/></li>
<li>&nbsp; <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L112" title="table/two_level_iterator.cc:112">Next</a>();<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L463" title="db/db_test.cc:463">IterStatus</a>(<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>), <span class="Constant">&quot;c-&gt;vc&quot;</span>);<br/></li>
<li>&nbsp; <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L112" title="table/two_level_iterator.cc:112">Next</a>();<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L463" title="db/db_test.cc:463">IterStatus</a>(<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>), <span class="Constant">&quot;(invalid)&quot;</span>);<br/></li>
<li>&nbsp; <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L105" title="table/two_level_iterator.cc:105">SeekToLast</a>();<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L463" title="db/db_test.cc:463">IterStatus</a>(<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>), <span class="Constant">&quot;c-&gt;vc&quot;</span>);<br/></li>
<li>&nbsp; <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L118" title="table/two_level_iterator.cc:118">Prev</a>();<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L463" title="db/db_test.cc:463">IterStatus</a>(<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>), <span class="Constant">&quot;b-&gt;vb&quot;</span>);<br/></li>
<li>&nbsp; <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L118" title="table/two_level_iterator.cc:118">Prev</a>();<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L463" title="db/db_test.cc:463">IterStatus</a>(<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>), <span class="Constant">&quot;a-&gt;va&quot;</span>);<br/></li>
<li>&nbsp; <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L118" title="table/two_level_iterator.cc:118">Prev</a>();<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L463" title="db/db_test.cc:463">IterStatus</a>(<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>), <span class="Constant">&quot;(invalid)&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">delete</span> <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L796">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L209" title="db/db_test.cc:209">DBTest</a>, IterSmallAndLargeMix) {<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;a&quot;</span>, <span class="Constant">&quot;va&quot;</span>));<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;b&quot;</span>, std::string(<span class="Constant">100000</span>, <span class="Constant">'b'</span>)));<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;c&quot;</span>, <span class="Constant">&quot;vc&quot;</span>));<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;d&quot;</span>, std::string(<span class="Constant">100000</span>, <span class="Constant">'d'</span>)));<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;e&quot;</span>, std::string(<span class="Constant">100000</span>, <span class="Constant">'e'</span>)));<br/></li>
<li><br/></li>
<li>&nbsp; <a href="../table/iterator.cc.html#L9" title="table/iterator.cc:9">Iterator</a>* <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a> = db_-&gt;<a href="../table/table_test.cc.html#L209" title="table/table_test.cc:209">NewIterator</a>(<a href="../include/leveldb/options.h.html#L143" title="include/leveldb/options.h:143">ReadOptions</a>());<br/></li>
<li><br/></li>
<li>&nbsp; <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L98" title="table/two_level_iterator.cc:98">SeekToFirst</a>();<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L463" title="db/db_test.cc:463">IterStatus</a>(<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>), <span class="Constant">&quot;a-&gt;va&quot;</span>);<br/></li>
<li>&nbsp; <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L112" title="table/two_level_iterator.cc:112">Next</a>();<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L463" title="db/db_test.cc:463">IterStatus</a>(<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>), <span class="Constant">&quot;b-&gt;&quot;</span> + std::string(<span class="Constant">100000</span>, <span class="Constant">'b'</span>));<br/></li>
<li>&nbsp; <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L112" title="table/two_level_iterator.cc:112">Next</a>();<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L463" title="db/db_test.cc:463">IterStatus</a>(<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>), <span class="Constant">&quot;c-&gt;vc&quot;</span>);<br/></li>
<li>&nbsp; <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L112" title="table/two_level_iterator.cc:112">Next</a>();<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L463" title="db/db_test.cc:463">IterStatus</a>(<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>), <span class="Constant">&quot;d-&gt;&quot;</span> + std::string(<span class="Constant">100000</span>, <span class="Constant">'d'</span>));<br/></li>
<li>&nbsp; <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L112" title="table/two_level_iterator.cc:112">Next</a>();<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L463" title="db/db_test.cc:463">IterStatus</a>(<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>), <span class="Constant">&quot;e-&gt;&quot;</span> + std::string(<span class="Constant">100000</span>, <span class="Constant">'e'</span>));<br/></li>
<li>&nbsp; <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L112" title="table/two_level_iterator.cc:112">Next</a>();<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L463" title="db/db_test.cc:463">IterStatus</a>(<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>), <span class="Constant">&quot;(invalid)&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L105" title="table/two_level_iterator.cc:105">SeekToLast</a>();<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L463" title="db/db_test.cc:463">IterStatus</a>(<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>), <span class="Constant">&quot;e-&gt;&quot;</span> + std::string(<span class="Constant">100000</span>, <span class="Constant">'e'</span>));<br/></li>
<li>&nbsp; <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L118" title="table/two_level_iterator.cc:118">Prev</a>();<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L463" title="db/db_test.cc:463">IterStatus</a>(<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>), <span class="Constant">&quot;d-&gt;&quot;</span> + std::string(<span class="Constant">100000</span>, <span class="Constant">'d'</span>));<br/></li>
<li>&nbsp; <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L118" title="table/two_level_iterator.cc:118">Prev</a>();<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L463" title="db/db_test.cc:463">IterStatus</a>(<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>), <span class="Constant">&quot;c-&gt;vc&quot;</span>);<br/></li>
<li>&nbsp; <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L118" title="table/two_level_iterator.cc:118">Prev</a>();<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L463" title="db/db_test.cc:463">IterStatus</a>(<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>), <span class="Constant">&quot;b-&gt;&quot;</span> + std::string(<span class="Constant">100000</span>, <span class="Constant">'b'</span>));<br/></li>
<li>&nbsp; <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L118" title="table/two_level_iterator.cc:118">Prev</a>();<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L463" title="db/db_test.cc:463">IterStatus</a>(<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>), <span class="Constant">&quot;a-&gt;va&quot;</span>);<br/></li>
<li>&nbsp; <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L118" title="table/two_level_iterator.cc:118">Prev</a>();<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L463" title="db/db_test.cc:463">IterStatus</a>(<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>), <span class="Constant">&quot;(invalid)&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">delete</span> <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L834">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L209" title="db/db_test.cc:209">DBTest</a>, IterMultiWithDelete) {<br/></li>
<li>&nbsp; <span class="Statement">do</span> {<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;a&quot;</span>, <span class="Constant">&quot;va&quot;</span>));<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;b&quot;</span>, <span class="Constant">&quot;vb&quot;</span>));<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;c&quot;</span>, <span class="Constant">&quot;vc&quot;</span>));<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L105" title="db/write_batch.cc:105">Delete</a>(<span class="Constant">&quot;b&quot;</span>));<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;NOT_FOUND&quot;</span>, <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(<span class="Constant">&quot;b&quot;</span>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../table/iterator.cc.html#L9" title="table/iterator.cc:9">Iterator</a>* <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a> = db_-&gt;<a href="../table/table_test.cc.html#L209" title="table/table_test.cc:209">NewIterator</a>(<a href="../include/leveldb/options.h.html#L143" title="include/leveldb/options.h:143">ReadOptions</a>());<br/></li>
<li>&nbsp; &nbsp; <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L91" title="table/two_level_iterator.cc:91">Seek</a>(<span class="Constant">&quot;c&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L463" title="db/db_test.cc:463">IterStatus</a>(<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>), <span class="Constant">&quot;c-&gt;vc&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L118" title="table/two_level_iterator.cc:118">Prev</a>();<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L463" title="db/db_test.cc:463">IterStatus</a>(<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>), <span class="Constant">&quot;a-&gt;va&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">delete</span> <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>;<br/></li>
<li>&nbsp; } <span class="Statement">while</span> (<a href="../table/table_builder.cc.html#L76" title="table/table_builder.cc:76">ChangeOptions</a>());<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L851">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L209" title="db/db_test.cc:209">DBTest</a>, <a href="version_set.cc.html#L896" title="db/version_set.cc:896">Recover</a>) {<br/></li>
<li>&nbsp; <span class="Statement">do</span> {<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;foo&quot;</span>, <span class="Constant">&quot;v1&quot;</span>));<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;baz&quot;</span>, <span class="Constant">&quot;v5&quot;</span>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="corruption_test.cc.html#L60" title="db/corruption_test.cc:60">Reopen</a>();<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;v1&quot;</span>, <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(<span class="Constant">&quot;foo&quot;</span>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;v1&quot;</span>, <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(<span class="Constant">&quot;foo&quot;</span>));<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;v5&quot;</span>, <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(<span class="Constant">&quot;baz&quot;</span>));<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;bar&quot;</span>, <span class="Constant">&quot;v2&quot;</span>));<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;foo&quot;</span>, <span class="Constant">&quot;v3&quot;</span>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="corruption_test.cc.html#L60" title="db/corruption_test.cc:60">Reopen</a>();<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;v3&quot;</span>, <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(<span class="Constant">&quot;foo&quot;</span>));<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;foo&quot;</span>, <span class="Constant">&quot;v4&quot;</span>));<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;v4&quot;</span>, <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(<span class="Constant">&quot;foo&quot;</span>));<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;v2&quot;</span>, <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(<span class="Constant">&quot;bar&quot;</span>));<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;v5&quot;</span>, <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(<span class="Constant">&quot;baz&quot;</span>));<br/></li>
<li>&nbsp; } <span class="Statement">while</span> (<a href="../table/table_builder.cc.html#L76" title="table/table_builder.cc:76">ChangeOptions</a>());<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L873">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L209" title="db/db_test.cc:209">DBTest</a>, RecoveryWithEmptyLog) {<br/></li>
<li>&nbsp; <span class="Statement">do</span> {<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;foo&quot;</span>, <span class="Constant">&quot;v1&quot;</span>));<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;foo&quot;</span>, <span class="Constant">&quot;v2&quot;</span>));<br/></li>
<li>&nbsp; &nbsp; <a href="corruption_test.cc.html#L60" title="db/corruption_test.cc:60">Reopen</a>();<br/></li>
<li>&nbsp; &nbsp; <a href="corruption_test.cc.html#L60" title="db/corruption_test.cc:60">Reopen</a>();<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;foo&quot;</span>, <span class="Constant">&quot;v3&quot;</span>));<br/></li>
<li>&nbsp; &nbsp; <a href="corruption_test.cc.html#L60" title="db/corruption_test.cc:60">Reopen</a>();<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;v3&quot;</span>, <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(<span class="Constant">&quot;foo&quot;</span>));<br/></li>
<li>&nbsp; } <span class="Statement">while</span> (<a href="../table/table_builder.cc.html#L76" title="table/table_builder.cc:76">ChangeOptions</a>());<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">// <a href="corruption_test.cc.html#L88" title="db/corruption_test.cc:88">Check</a> that writes done during a memtable compaction are recovered<br/></li>
<li></span><span class="Comment">// if the database is shutdown during the memtable compaction.<br/></li>
<li><a id="L887">&#x200c;</a></span><span class="linkable">TEST</span>(<a href="#L209" title="db/db_test.cc:209">DBTest</a>, RecoverDuringMemtableCompaction) {<br/></li>
<li>&nbsp; <span class="Statement">do</span> {<br/></li>
<li>&nbsp; &nbsp; <a href="../include/leveldb/options.h.html#L31" title="include/leveldb/options.h:31">Options</a> options = <a href="#L238" title="db/db_test.cc:238">CurrentOptions</a>();<br/></li>
<li>&nbsp; &nbsp; options.env = env_;<br/></li>
<li>&nbsp; &nbsp; options.write_buffer_size = <span class="Constant">1000000</span>;<br/></li>
<li>&nbsp; &nbsp; <a href="corruption_test.cc.html#L60" title="db/corruption_test.cc:60">Reopen</a>(&amp;options);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// Trigger a long memtable compaction and reopen the database during it<br/></li>
<li></span>&nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;foo&quot;</span>, <span class="Constant">&quot;v1&quot;</span>));&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">// Goes to 1st log file<br/></li>
<li></span>&nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;big1&quot;</span>, std::string(<span class="Constant">10000000</span>, <span class="Constant">'x'</span>)));&nbsp; <span class="Comment">// Fills memtable<br/></li>
<li></span>&nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;big2&quot;</span>, std::string(<span class="Constant">1000</span>, <span class="Constant">'y'</span>)));&nbsp; &nbsp; &nbsp; <span class="Comment">// Triggers compaction<br/></li>
<li></span>&nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;bar&quot;</span>, <span class="Constant">&quot;v2&quot;</span>));&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">// Goes to new log file<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="corruption_test.cc.html#L60" title="db/corruption_test.cc:60">Reopen</a>(&amp;options);<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;v1&quot;</span>, <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(<span class="Constant">&quot;foo&quot;</span>));<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;v2&quot;</span>, <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(<span class="Constant">&quot;bar&quot;</span>));<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(std::string(<span class="Constant">10000000</span>, <span class="Constant">'x'</span>), <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(<span class="Constant">&quot;big1&quot;</span>));<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(std::string(<span class="Constant">1000</span>, <span class="Constant">'y'</span>), <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(<span class="Constant">&quot;big2&quot;</span>));<br/></li>
<li>&nbsp; } <span class="Statement">while</span> (<a href="../table/table_builder.cc.html#L76" title="table/table_builder.cc:76">ChangeOptions</a>());<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L908">&#x200c;</a><span class="Type">static</span> std::string <span class="linkable">Key</span>(<span class="Type">int</span> i) {<br/></li>
<li>&nbsp; <span class="Type">char</span> buf[<span class="Constant">100</span>];<br/></li>
<li>&nbsp; snprintf(buf, <span class="Statement">sizeof</span>(buf), <span class="Constant">&quot;<a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a></span><span class="Special">%06d</span><span class="Constant">&quot;</span>, i);<br/></li>
<li>&nbsp; <span class="Statement">return</span> std::string(buf);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L914">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L209" title="db/db_test.cc:209">DBTest</a>, MinorCompactionsHappen) {<br/></li>
<li>&nbsp; <a href="../include/leveldb/options.h.html#L31" title="include/leveldb/options.h:31">Options</a> options = <a href="#L238" title="db/db_test.cc:238">CurrentOptions</a>();<br/></li>
<li>&nbsp; options.write_buffer_size = <span class="Constant">10000</span>;<br/></li>
<li>&nbsp; <a href="corruption_test.cc.html#L60" title="db/corruption_test.cc:60">Reopen</a>(&amp;options);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">int</span> N = <span class="Constant">500</span>;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Type">int</span> starting_num_tables = <a href="#L386" title="db/db_test.cc:386">TotalTableFiles</a>();<br/></li>
<li>&nbsp; <span class="Statement">for</span> (<span class="Type">int</span> i = <span class="Constant">0</span>; i &lt; N; i++) {<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<a href="autocompact_test.cc.html#L36" title="db/autocompact_test.cc:36">Key</a>(i), <a href="autocompact_test.cc.html#L36" title="db/autocompact_test.cc:36">Key</a>(i) + std::string(<span class="Constant">1000</span>, <span class="Constant">'v'</span>)));<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Type">int</span> ending_num_tables = <a href="#L386" title="db/db_test.cc:386">TotalTableFiles</a>();<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L110" title="util/testharness.h:110">ASSERT_GT</a>(ending_num_tables, starting_num_tables);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">for</span> (<span class="Type">int</span> i = <span class="Constant">0</span>; i &lt; N; i++) {<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="autocompact_test.cc.html#L36" title="db/autocompact_test.cc:36">Key</a>(i) + std::string(<span class="Constant">1000</span>, <span class="Constant">'v'</span>), <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(<a href="autocompact_test.cc.html#L36" title="db/autocompact_test.cc:36">Key</a>(i)));<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <a href="corruption_test.cc.html#L60" title="db/corruption_test.cc:60">Reopen</a>();<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">for</span> (<span class="Type">int</span> i = <span class="Constant">0</span>; i &lt; N; i++) {<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="autocompact_test.cc.html#L36" title="db/autocompact_test.cc:36">Key</a>(i) + std::string(<span class="Constant">1000</span>, <span class="Constant">'v'</span>), <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(<a href="autocompact_test.cc.html#L36" title="db/autocompact_test.cc:36">Key</a>(i)));<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L939">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L209" title="db/db_test.cc:209">DBTest</a>, RecoverWithLargeLog) {<br/></li>
<li>&nbsp; {<br/></li>
<li>&nbsp; &nbsp; <a href="../include/leveldb/options.h.html#L31" title="include/leveldb/options.h:31">Options</a> options = <a href="#L238" title="db/db_test.cc:238">CurrentOptions</a>();<br/></li>
<li>&nbsp; &nbsp; <a href="corruption_test.cc.html#L60" title="db/corruption_test.cc:60">Reopen</a>(&amp;options);<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;big1&quot;</span>, std::string(<span class="Constant">200000</span>, <span class="Constant">'1'</span>)));<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;big2&quot;</span>, std::string(<span class="Constant">200000</span>, <span class="Constant">'2'</span>)));<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;small3&quot;</span>, std::string(<span class="Constant">10</span>, <span class="Constant">'3'</span>)));<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;small4&quot;</span>, std::string(<span class="Constant">10</span>, <span class="Constant">'4'</span>)));<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L378" title="db/db_test.cc:378">NumTableFilesAtLevel</a>(<span class="Constant">0</span>), <span class="Constant">0</span>);<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// Make sure that if we re-open with a small write buffer <a href="../table/format.h.html#L31" title="table/format.h:31">size</a> that<br/></li>
<li></span>&nbsp; <span class="Comment">// we flush table files in the middle of a large log file.<br/></li>
<li></span>&nbsp; <a href="../include/leveldb/options.h.html#L31" title="include/leveldb/options.h:31">Options</a> options = <a href="#L238" title="db/db_test.cc:238">CurrentOptions</a>();<br/></li>
<li>&nbsp; options.write_buffer_size = <span class="Constant">100000</span>;<br/></li>
<li>&nbsp; <a href="corruption_test.cc.html#L60" title="db/corruption_test.cc:60">Reopen</a>(&amp;options);<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L378" title="db/db_test.cc:378">NumTableFilesAtLevel</a>(<span class="Constant">0</span>), <span class="Constant">3</span>);<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(std::string(<span class="Constant">200000</span>, <span class="Constant">'1'</span>), <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(<span class="Constant">&quot;big1&quot;</span>));<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(std::string(<span class="Constant">200000</span>, <span class="Constant">'2'</span>), <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(<span class="Constant">&quot;big2&quot;</span>));<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(std::string(<span class="Constant">10</span>, <span class="Constant">'3'</span>), <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(<span class="Constant">&quot;small3&quot;</span>));<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(std::string(<span class="Constant">10</span>, <span class="Constant">'4'</span>), <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(<span class="Constant">&quot;small4&quot;</span>));<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L110" title="util/testharness.h:110">ASSERT_GT</a>(<a href="#L378" title="db/db_test.cc:378">NumTableFilesAtLevel</a>(<span class="Constant">0</span>), <span class="Constant">1</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L963">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L209" title="db/db_test.cc:209">DBTest</a>, CompactionsGenerateMultipleFiles) {<br/></li>
<li>&nbsp; <a href="../include/leveldb/options.h.html#L31" title="include/leveldb/options.h:31">Options</a> options = <a href="#L238" title="db/db_test.cc:238">CurrentOptions</a>();<br/></li>
<li>&nbsp; options.write_buffer_size = <span class="Constant">100000000</span>;&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">// Large write buffer<br/></li>
<li></span>&nbsp; <a href="corruption_test.cc.html#L60" title="db/corruption_test.cc:60">Reopen</a>(&amp;options);<br/></li>
<li><br/></li>
<li>&nbsp; <a href="../util/random.h.html#L19" title="util/random.h:19">Random</a> rnd(<span class="Constant">301</span>);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// <a href="log_test.cc.html#L121" title="db/log_test.cc:121">Write</a> 8MB (80 values, each 100K)<br/></li>
<li></span>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L378" title="db/db_test.cc:378">NumTableFilesAtLevel</a>(<span class="Constant">0</span>), <span class="Constant">0</span>);<br/></li>
<li>&nbsp; std::vector&lt;std::string&gt; values;<br/></li>
<li>&nbsp; <span class="Statement">for</span> (<span class="Type">int</span> i = <span class="Constant">0</span>; i &lt; <span class="Constant">80</span>; i++) {<br/></li>
<li>&nbsp; &nbsp; values.push_back(<a href="#L22" title="db/db_test.cc:22">RandomString</a>(&amp;rnd, <span class="Constant">100000</span>));<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<a href="autocompact_test.cc.html#L36" title="db/autocompact_test.cc:36">Key</a>(i), values[i]));<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// Reopening moves updates to <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>-0<br/></li>
<li></span>&nbsp; <a href="corruption_test.cc.html#L60" title="db/corruption_test.cc:60">Reopen</a>(&amp;options);<br/></li>
<li>&nbsp; <a href="#L253" title="db/db_test.cc:253">dbfull</a>()-&gt;<a href="db_impl.cc.html#L553" title="db/db_impl.cc:553">TEST_CompactRange</a>(<span class="Constant">0</span>, <span class="Constant">NULL</span>, <span class="Constant">NULL</span>);<br/></li>
<li><br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L378" title="db/db_test.cc:378">NumTableFilesAtLevel</a>(<span class="Constant">0</span>), <span class="Constant">0</span>);<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L110" title="util/testharness.h:110">ASSERT_GT</a>(<a href="#L378" title="db/db_test.cc:378">NumTableFilesAtLevel</a>(<span class="Constant">1</span>), <span class="Constant">1</span>);<br/></li>
<li>&nbsp; <span class="Statement">for</span> (<span class="Type">int</span> i = <span class="Constant">0</span>; i &lt; <span class="Constant">80</span>; i++) {<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(<a href="autocompact_test.cc.html#L36" title="db/autocompact_test.cc:36">Key</a>(i)), values[i]);<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L989">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L209" title="db/db_test.cc:209">DBTest</a>, RepeatedWritesToSameKey) {<br/></li>
<li>&nbsp; <a href="../include/leveldb/options.h.html#L31" title="include/leveldb/options.h:31">Options</a> options = <a href="#L238" title="db/db_test.cc:238">CurrentOptions</a>();<br/></li>
<li>&nbsp; options.env = env_;<br/></li>
<li>&nbsp; options.write_buffer_size = <span class="Constant">100000</span>;&nbsp; <span class="Comment">// Small write buffer<br/></li>
<li></span>&nbsp; <a href="corruption_test.cc.html#L60" title="db/corruption_test.cc:60">Reopen</a>(&amp;options);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// We must have at most one file per <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> except for <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>-0,<br/></li>
<li></span>&nbsp; <span class="Comment">// which may have up to kL0_StopWritesTrigger files.<br/></li>
<li></span>&nbsp; <span class="Type">const</span> <span class="Type">int</span> kMaxFiles = config::kNumLevels + config::kL0_StopWritesTrigger;<br/></li>
<li><br/></li>
<li>&nbsp; <a href="../util/random.h.html#L19" title="util/random.h:19">Random</a> rnd(<span class="Constant">301</span>);<br/></li>
<li>&nbsp; std::string <a href="../table/two_level_iterator.cc.html#L41" title="table/two_level_iterator.cc:41">value</a> = <a href="#L22" title="db/db_test.cc:22">RandomString</a>(&amp;rnd, <span class="Constant">2</span> * options.write_buffer_size);<br/></li>
<li>&nbsp; <span class="Statement">for</span> (<span class="Type">int</span> i = <span class="Constant">0</span>; i &lt; <span class="Constant">5</span> * kMaxFiles; i++) {<br/></li>
<li>&nbsp; &nbsp; <a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;<a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>&quot;</span>, <a href="../table/two_level_iterator.cc.html#L41" title="table/two_level_iterator.cc:41">value</a>);<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L111" title="util/testharness.h:111">ASSERT_LE</a>(<a href="#L386" title="db/db_test.cc:386">TotalTableFiles</a>(), kMaxFiles);<br/></li>
<li>&nbsp; &nbsp; fprintf(<span class="Constant">stderr</span>, <span class="Constant">&quot;after </span><span class="Special">%d</span><span class="Constant">: </span><span class="Special">%d</span><span class="Constant"> files</span><span class="Special">\n</span><span class="Constant">&quot;</span>, <span class="Type">int</span>(i+<span class="Constant">1</span>), <a href="#L386" title="db/db_test.cc:386">TotalTableFiles</a>());<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1008">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L209" title="db/db_test.cc:209">DBTest</a>, SparseMerge) {<br/></li>
<li>&nbsp; <a href="../include/leveldb/options.h.html#L31" title="include/leveldb/options.h:31">Options</a> options = <a href="#L238" title="db/db_test.cc:238">CurrentOptions</a>();<br/></li>
<li>&nbsp; options.compression = kNoCompression;<br/></li>
<li>&nbsp; <a href="corruption_test.cc.html#L60" title="db/corruption_test.cc:60">Reopen</a>(&amp;options);<br/></li>
<li><br/></li>
<li>&nbsp; <a href="#L440" title="db/db_test.cc:440">FillLevels</a>(<span class="Constant">&quot;A&quot;</span>, <span class="Constant">&quot;Z&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// Suppose there is:<br/></li>
<li></span>&nbsp; <span class="Comment">//&nbsp; &nbsp; small amount of <a href="../table/table_test.cc.html#L173" title="table/table_test.cc:173">data</a> with prefix A<br/></li>
<li></span>&nbsp; <span class="Comment">//&nbsp; &nbsp; large amount of <a href="../table/table_test.cc.html#L173" title="table/table_test.cc:173">data</a> with prefix B<br/></li>
<li></span>&nbsp; <span class="Comment">//&nbsp; &nbsp; small amount of <a href="../table/table_test.cc.html#L173" title="table/table_test.cc:173">data</a> with prefix C<br/></li>
<li></span>&nbsp; <span class="Comment">// and that recent updates have made small changes to all three prefixes.<br/></li>
<li></span>&nbsp; <span class="Comment">// <a href="corruption_test.cc.html#L88" title="db/corruption_test.cc:88">Check</a> that we do not do a compaction that merges all of B in one shot.<br/></li>
<li></span>&nbsp; <span class="Type">const</span> std::string <a href="../table/two_level_iterator.cc.html#L41" title="table/two_level_iterator.cc:41">value</a>(<span class="Constant">1000</span>, <span class="Constant">'x'</span>);<br/></li>
<li>&nbsp; <a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;A&quot;</span>, <span class="Constant">&quot;va&quot;</span>);<br/></li>
<li>&nbsp; <span class="Comment">// <a href="log_test.cc.html#L121" title="db/log_test.cc:121">Write</a> approximately 100MB of &quot;B&quot; values<br/></li>
<li></span>&nbsp; <span class="Statement">for</span> (<span class="Type">int</span> i = <span class="Constant">0</span>; i &lt; <span class="Constant">100000</span>; i++) {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span> <a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>[<span class="Constant">100</span>];<br/></li>
<li>&nbsp; &nbsp; snprintf(<a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>, <span class="Statement">sizeof</span>(<a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>), <span class="Constant">&quot;B</span><span class="Special">%010d</span><span class="Constant">&quot;</span>, i);<br/></li>
<li>&nbsp; &nbsp; <a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>, <a href="../table/two_level_iterator.cc.html#L41" title="table/two_level_iterator.cc:41">value</a>);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;C&quot;</span>, <span class="Constant">&quot;vc&quot;</span>);<br/></li>
<li>&nbsp; <a href="#L253" title="db/db_test.cc:253">dbfull</a>()-&gt;<a href="db_impl.cc.html#L590" title="db/db_impl.cc:590">TEST_CompactMemTable</a>();<br/></li>
<li>&nbsp; <a href="#L253" title="db/db_test.cc:253">dbfull</a>()-&gt;<a href="db_impl.cc.html#L553" title="db/db_impl.cc:553">TEST_CompactRange</a>(<span class="Constant">0</span>, <span class="Constant">NULL</span>, <span class="Constant">NULL</span>);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// Make sparse update<br/></li>
<li></span>&nbsp; <a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;A&quot;</span>,&nbsp; &nbsp; <span class="Constant">&quot;va2&quot;</span>);<br/></li>
<li>&nbsp; <a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;B100&quot;</span>, <span class="Constant">&quot;bvalue2&quot;</span>);<br/></li>
<li>&nbsp; <a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;C&quot;</span>,&nbsp; &nbsp; <span class="Constant">&quot;vc2&quot;</span>);<br/></li>
<li>&nbsp; <a href="#L253" title="db/db_test.cc:253">dbfull</a>()-&gt;<a href="db_impl.cc.html#L590" title="db/db_impl.cc:590">TEST_CompactMemTable</a>();<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// Compactions should not cause us to create a situation where<br/></li>
<li></span>&nbsp; <span class="Comment">// a file overlaps too much <a href="../table/table_test.cc.html#L173" title="table/table_test.cc:173">data</a> at the next <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>.<br/></li>
<li></span>&nbsp; <a href="../util/testharness.h.html#L111" title="util/testharness.h:111">ASSERT_LE</a>(<a href="#L253" title="db/db_test.cc:253">dbfull</a>()-&gt;<a href="db_impl.cc.html#L1072" title="db/db_impl.cc:1072">TEST_MaxNextLevelOverlappingBytes</a>(), <span class="Constant">20</span>*<span class="Constant">1048576</span>);<br/></li>
<li>&nbsp; <a href="#L253" title="db/db_test.cc:253">dbfull</a>()-&gt;<a href="db_impl.cc.html#L553" title="db/db_impl.cc:553">TEST_CompactRange</a>(<span class="Constant">0</span>, <span class="Constant">NULL</span>, <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L111" title="util/testharness.h:111">ASSERT_LE</a>(<a href="#L253" title="db/db_test.cc:253">dbfull</a>()-&gt;<a href="db_impl.cc.html#L1072" title="db/db_impl.cc:1072">TEST_MaxNextLevelOverlappingBytes</a>(), <span class="Constant">20</span>*<span class="Constant">1048576</span>);<br/></li>
<li>&nbsp; <a href="#L253" title="db/db_test.cc:253">dbfull</a>()-&gt;<a href="db_impl.cc.html#L553" title="db/db_impl.cc:553">TEST_CompactRange</a>(<span class="Constant">1</span>, <span class="Constant">NULL</span>, <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L111" title="util/testharness.h:111">ASSERT_LE</a>(<a href="#L253" title="db/db_test.cc:253">dbfull</a>()-&gt;<a href="db_impl.cc.html#L1072" title="db/db_impl.cc:1072">TEST_MaxNextLevelOverlappingBytes</a>(), <span class="Constant">20</span>*<span class="Constant">1048576</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1048">&#x200c;</a><span class="Type">static</span> <span class="Type">bool</span> <span class="linkable">Between</span>(<span class="Type"><a href="../port/win/stdint.h.html#L22" title="port/win/stdint.h:22">uint64_t</a></span> val, <span class="Type"><a href="../port/win/stdint.h.html#L22" title="port/win/stdint.h:22">uint64_t</a></span> low, <span class="Type"><a href="../port/win/stdint.h.html#L22" title="port/win/stdint.h:22">uint64_t</a></span> high) {<br/></li>
<li>&nbsp; <span class="Type">bool</span> result = (val &gt;= low) &amp;&amp; (val &lt;= high);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (!result) {<br/></li>
<li>&nbsp; &nbsp; fprintf(<span class="Constant">stderr</span>, <span class="Constant">&quot;<a href="corruption_test.cc.html#L196" title="db/corruption_test.cc:196">Value</a> </span><span class="Special">%llu</span><span class="Constant"> is not in range [</span><span class="Special">%llu</span><span class="Constant">, </span><span class="Special">%llu</span><span class="Constant">]</span><span class="Special">\n</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<span class="Type">unsigned</span> <span class="Type">long</span> <span class="Type">long</span>)(val),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<span class="Type">unsigned</span> <span class="Type">long</span> <span class="Type">long</span>)(low),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<span class="Type">unsigned</span> <span class="Type">long</span> <span class="Type">long</span>)(high));<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> result;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1059">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L209" title="db/db_test.cc:209">DBTest</a>, ApproximateSizes) {<br/></li>
<li>&nbsp; <span class="Statement">do</span> {<br/></li>
<li>&nbsp; &nbsp; <a href="../include/leveldb/options.h.html#L31" title="include/leveldb/options.h:31">Options</a> options = <a href="#L238" title="db/db_test.cc:238">CurrentOptions</a>();<br/></li>
<li>&nbsp; &nbsp; options.write_buffer_size = <span class="Constant">100000000</span>;&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">// Large write buffer<br/></li>
<li></span>&nbsp; &nbsp; options.compression = kNoCompression;<br/></li>
<li>&nbsp; &nbsp; <a href="#L266" title="db/db_test.cc:266">DestroyAndReopen</a>();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(<a href="../table/table_test.cc.html#L787" title="table/table_test.cc:787">Between</a>(<a href="../table/table_test.cc.html#L118" title="table/table_test.cc:118">Size</a>(<span class="Constant">&quot;&quot;</span>, <span class="Constant">&quot;xyz&quot;</span>), <span class="Constant">0</span>, <span class="Constant">0</span>));<br/></li>
<li>&nbsp; &nbsp; <a href="corruption_test.cc.html#L60" title="db/corruption_test.cc:60">Reopen</a>(&amp;options);<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(<a href="../table/table_test.cc.html#L787" title="table/table_test.cc:787">Between</a>(<a href="../table/table_test.cc.html#L118" title="table/table_test.cc:118">Size</a>(<span class="Constant">&quot;&quot;</span>, <span class="Constant">&quot;xyz&quot;</span>), <span class="Constant">0</span>, <span class="Constant">0</span>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// <a href="log_test.cc.html#L121" title="db/log_test.cc:121">Write</a> 8MB (80 values, each 100K)<br/></li>
<li></span>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L378" title="db/db_test.cc:378">NumTableFilesAtLevel</a>(<span class="Constant">0</span>), <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <span class="Type">int</span> N = <span class="Constant">80</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">static</span> <span class="Type">const</span> <span class="Type">int</span> S1 = <span class="Constant">100000</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">static</span> <span class="Type">const</span> <span class="Type">int</span> S2 = <span class="Constant">105000</span>;&nbsp; <span class="Comment">// Allow some expansion from metadata<br/></li>
<li></span>&nbsp; &nbsp; <a href="../util/random.h.html#L19" title="util/random.h:19">Random</a> rnd(<span class="Constant">301</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (<span class="Type">int</span> i = <span class="Constant">0</span>; i &lt; N; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<a href="autocompact_test.cc.html#L36" title="db/autocompact_test.cc:36">Key</a>(i), <a href="#L22" title="db/db_test.cc:22">RandomString</a>(&amp;rnd, S1)));<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// 0 because <a href="db_impl.cc.html#L1403" title="db/db_impl.cc:1403">GetApproximateSizes</a>() does not account for memtable space<br/></li>
<li></span>&nbsp; &nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(<a href="../table/table_test.cc.html#L787" title="table/table_test.cc:787">Between</a>(<a href="../table/table_test.cc.html#L118" title="table/table_test.cc:118">Size</a>(<span class="Constant">&quot;&quot;</span>, <a href="autocompact_test.cc.html#L36" title="db/autocompact_test.cc:36">Key</a>(<span class="Constant">50</span>)), <span class="Constant">0</span>, <span class="Constant">0</span>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// <a href="corruption_test.cc.html#L88" title="db/corruption_test.cc:88">Check</a> sizes across recovery by reopening a few times<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">for</span> (<span class="Type">int</span> run = <span class="Constant">0</span>; run &lt; <span class="Constant">3</span>; run++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="corruption_test.cc.html#L60" title="db/corruption_test.cc:60">Reopen</a>(&amp;options);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (<span class="Type">int</span> compact_start = <span class="Constant">0</span>; compact_start &lt; N; compact_start += <span class="Constant">10</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (<span class="Type">int</span> i = <span class="Constant">0</span>; i &lt; N; i += <span class="Constant">10</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(<a href="../table/table_test.cc.html#L787" title="table/table_test.cc:787">Between</a>(<a href="../table/table_test.cc.html#L118" title="table/table_test.cc:118">Size</a>(<span class="Constant">&quot;&quot;</span>, <a href="autocompact_test.cc.html#L36" title="db/autocompact_test.cc:36">Key</a>(i)), S1*i, S2*i));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(<a href="../table/table_test.cc.html#L787" title="table/table_test.cc:787">Between</a>(<a href="../table/table_test.cc.html#L118" title="table/table_test.cc:118">Size</a>(<span class="Constant">&quot;&quot;</span>, <a href="autocompact_test.cc.html#L36" title="db/autocompact_test.cc:36">Key</a>(i)+<span class="Constant">&quot;.suffix&quot;</span>), S1*(i+<span class="Constant">1</span>), S2*(i+<span class="Constant">1</span>)));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(<a href="../table/table_test.cc.html#L787" title="table/table_test.cc:787">Between</a>(<a href="../table/table_test.cc.html#L118" title="table/table_test.cc:118">Size</a>(<a href="autocompact_test.cc.html#L36" title="db/autocompact_test.cc:36">Key</a>(i), <a href="autocompact_test.cc.html#L36" title="db/autocompact_test.cc:36">Key</a>(i+<span class="Constant">10</span>)), S1*<span class="Constant">10</span>, S2*<span class="Constant">10</span>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(<a href="../table/table_test.cc.html#L787" title="table/table_test.cc:787">Between</a>(<a href="../table/table_test.cc.html#L118" title="table/table_test.cc:118">Size</a>(<span class="Constant">&quot;&quot;</span>, <a href="autocompact_test.cc.html#L36" title="db/autocompact_test.cc:36">Key</a>(<span class="Constant">50</span>)), S1*<span class="Constant">50</span>, S2*<span class="Constant">50</span>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(<a href="../table/table_test.cc.html#L787" title="table/table_test.cc:787">Between</a>(<a href="../table/table_test.cc.html#L118" title="table/table_test.cc:118">Size</a>(<span class="Constant">&quot;&quot;</span>, <a href="autocompact_test.cc.html#L36" title="db/autocompact_test.cc:36">Key</a>(<span class="Constant">50</span>)+<span class="Constant">&quot;.suffix&quot;</span>), S1*<span class="Constant">50</span>, S2*<span class="Constant">50</span>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; std::string cstart_str = <a href="autocompact_test.cc.html#L36" title="db/autocompact_test.cc:36">Key</a>(compact_start);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; std::string cend_str = <a href="autocompact_test.cc.html#L36" title="db/autocompact_test.cc:36">Key</a>(compact_start + <span class="Constant">9</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a> cstart = cstart_str;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a> cend = cend_str;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L253" title="db/db_test.cc:253">dbfull</a>()-&gt;<a href="db_impl.cc.html#L553" title="db/db_impl.cc:553">TEST_CompactRange</a>(<span class="Constant">0</span>, &amp;cstart, &amp;cend);<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L378" title="db/db_test.cc:378">NumTableFilesAtLevel</a>(<span class="Constant">0</span>), <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../util/testharness.h.html#L110" title="util/testharness.h:110">ASSERT_GT</a>(<a href="#L378" title="db/db_test.cc:378">NumTableFilesAtLevel</a>(<span class="Constant">1</span>), <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; } <span class="Statement">while</span> (<a href="../table/table_builder.cc.html#L76" title="table/table_builder.cc:76">ChangeOptions</a>());<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1109">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L209" title="db/db_test.cc:209">DBTest</a>, ApproximateSizes_MixOfSmallAndLarge) {<br/></li>
<li>&nbsp; <span class="Statement">do</span> {<br/></li>
<li>&nbsp; &nbsp; <a href="../include/leveldb/options.h.html#L31" title="include/leveldb/options.h:31">Options</a> options = <a href="#L238" title="db/db_test.cc:238">CurrentOptions</a>();<br/></li>
<li>&nbsp; &nbsp; options.compression = kNoCompression;<br/></li>
<li>&nbsp; &nbsp; <a href="corruption_test.cc.html#L60" title="db/corruption_test.cc:60">Reopen</a>();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../util/random.h.html#L19" title="util/random.h:19">Random</a> rnd(<span class="Constant">301</span>);<br/></li>
<li>&nbsp; &nbsp; std::string big1 = <a href="#L22" title="db/db_test.cc:22">RandomString</a>(&amp;rnd, <span class="Constant">100000</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<a href="autocompact_test.cc.html#L36" title="db/autocompact_test.cc:36">Key</a>(<span class="Constant">0</span>), <a href="#L22" title="db/db_test.cc:22">RandomString</a>(&amp;rnd, <span class="Constant">10000</span>)));<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<a href="autocompact_test.cc.html#L36" title="db/autocompact_test.cc:36">Key</a>(<span class="Constant">1</span>), <a href="#L22" title="db/db_test.cc:22">RandomString</a>(&amp;rnd, <span class="Constant">10000</span>)));<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<a href="autocompact_test.cc.html#L36" title="db/autocompact_test.cc:36">Key</a>(<span class="Constant">2</span>), big1));<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<a href="autocompact_test.cc.html#L36" title="db/autocompact_test.cc:36">Key</a>(<span class="Constant">3</span>), <a href="#L22" title="db/db_test.cc:22">RandomString</a>(&amp;rnd, <span class="Constant">10000</span>)));<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<a href="autocompact_test.cc.html#L36" title="db/autocompact_test.cc:36">Key</a>(<span class="Constant">4</span>), big1));<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<a href="autocompact_test.cc.html#L36" title="db/autocompact_test.cc:36">Key</a>(<span class="Constant">5</span>), <a href="#L22" title="db/db_test.cc:22">RandomString</a>(&amp;rnd, <span class="Constant">10000</span>)));<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<a href="autocompact_test.cc.html#L36" title="db/autocompact_test.cc:36">Key</a>(<span class="Constant">6</span>), <a href="#L22" title="db/db_test.cc:22">RandomString</a>(&amp;rnd, <span class="Constant">300000</span>)));<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<a href="autocompact_test.cc.html#L36" title="db/autocompact_test.cc:36">Key</a>(<span class="Constant">7</span>), <a href="#L22" title="db/db_test.cc:22">RandomString</a>(&amp;rnd, <span class="Constant">10000</span>)));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// <a href="corruption_test.cc.html#L88" title="db/corruption_test.cc:88">Check</a> sizes across recovery by reopening a few times<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">for</span> (<span class="Type">int</span> run = <span class="Constant">0</span>; run &lt; <span class="Constant">3</span>; run++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="corruption_test.cc.html#L60" title="db/corruption_test.cc:60">Reopen</a>(&amp;options);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(<a href="../table/table_test.cc.html#L787" title="table/table_test.cc:787">Between</a>(<a href="../table/table_test.cc.html#L118" title="table/table_test.cc:118">Size</a>(<span class="Constant">&quot;&quot;</span>, <a href="autocompact_test.cc.html#L36" title="db/autocompact_test.cc:36">Key</a>(<span class="Constant">0</span>)), <span class="Constant">0</span>, <span class="Constant">0</span>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(<a href="../table/table_test.cc.html#L787" title="table/table_test.cc:787">Between</a>(<a href="../table/table_test.cc.html#L118" title="table/table_test.cc:118">Size</a>(<span class="Constant">&quot;&quot;</span>, <a href="autocompact_test.cc.html#L36" title="db/autocompact_test.cc:36">Key</a>(<span class="Constant">1</span>)), <span class="Constant">10000</span>, <span class="Constant">11000</span>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(<a href="../table/table_test.cc.html#L787" title="table/table_test.cc:787">Between</a>(<a href="../table/table_test.cc.html#L118" title="table/table_test.cc:118">Size</a>(<span class="Constant">&quot;&quot;</span>, <a href="autocompact_test.cc.html#L36" title="db/autocompact_test.cc:36">Key</a>(<span class="Constant">2</span>)), <span class="Constant">20000</span>, <span class="Constant">21000</span>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(<a href="../table/table_test.cc.html#L787" title="table/table_test.cc:787">Between</a>(<a href="../table/table_test.cc.html#L118" title="table/table_test.cc:118">Size</a>(<span class="Constant">&quot;&quot;</span>, <a href="autocompact_test.cc.html#L36" title="db/autocompact_test.cc:36">Key</a>(<span class="Constant">3</span>)), <span class="Constant">120000</span>, <span class="Constant">121000</span>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(<a href="../table/table_test.cc.html#L787" title="table/table_test.cc:787">Between</a>(<a href="../table/table_test.cc.html#L118" title="table/table_test.cc:118">Size</a>(<span class="Constant">&quot;&quot;</span>, <a href="autocompact_test.cc.html#L36" title="db/autocompact_test.cc:36">Key</a>(<span class="Constant">4</span>)), <span class="Constant">130000</span>, <span class="Constant">131000</span>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(<a href="../table/table_test.cc.html#L787" title="table/table_test.cc:787">Between</a>(<a href="../table/table_test.cc.html#L118" title="table/table_test.cc:118">Size</a>(<span class="Constant">&quot;&quot;</span>, <a href="autocompact_test.cc.html#L36" title="db/autocompact_test.cc:36">Key</a>(<span class="Constant">5</span>)), <span class="Constant">230000</span>, <span class="Constant">231000</span>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(<a href="../table/table_test.cc.html#L787" title="table/table_test.cc:787">Between</a>(<a href="../table/table_test.cc.html#L118" title="table/table_test.cc:118">Size</a>(<span class="Constant">&quot;&quot;</span>, <a href="autocompact_test.cc.html#L36" title="db/autocompact_test.cc:36">Key</a>(<span class="Constant">6</span>)), <span class="Constant">240000</span>, <span class="Constant">241000</span>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(<a href="../table/table_test.cc.html#L787" title="table/table_test.cc:787">Between</a>(<a href="../table/table_test.cc.html#L118" title="table/table_test.cc:118">Size</a>(<span class="Constant">&quot;&quot;</span>, <a href="autocompact_test.cc.html#L36" title="db/autocompact_test.cc:36">Key</a>(<span class="Constant">7</span>)), <span class="Constant">540000</span>, <span class="Constant">541000</span>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(<a href="../table/table_test.cc.html#L787" title="table/table_test.cc:787">Between</a>(<a href="../table/table_test.cc.html#L118" title="table/table_test.cc:118">Size</a>(<span class="Constant">&quot;&quot;</span>, <a href="autocompact_test.cc.html#L36" title="db/autocompact_test.cc:36">Key</a>(<span class="Constant">8</span>)), <span class="Constant">550000</span>, <span class="Constant">560000</span>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(<a href="../table/table_test.cc.html#L787" title="table/table_test.cc:787">Between</a>(<a href="../table/table_test.cc.html#L118" title="table/table_test.cc:118">Size</a>(<a href="autocompact_test.cc.html#L36" title="db/autocompact_test.cc:36">Key</a>(<span class="Constant">3</span>), <a href="autocompact_test.cc.html#L36" title="db/autocompact_test.cc:36">Key</a>(<span class="Constant">5</span>)), <span class="Constant">110000</span>, <span class="Constant">111000</span>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L253" title="db/db_test.cc:253">dbfull</a>()-&gt;<a href="db_impl.cc.html#L553" title="db/db_impl.cc:553">TEST_CompactRange</a>(<span class="Constant">0</span>, <span class="Constant">NULL</span>, <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; } <span class="Statement">while</span> (<a href="../table/table_builder.cc.html#L76" title="table/table_builder.cc:76">ChangeOptions</a>());<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1147">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L209" title="db/db_test.cc:209">DBTest</a>, IteratorPinsRef) {<br/></li>
<li>&nbsp; <a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;foo&quot;</span>, <span class="Constant">&quot;hello&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a> iterator that will yield the <a href="version_set.h.html#L185" title="db/version_set.h:185">current</a> <a href="../table/table_test.cc.html#L94" title="table/table_test.cc:94">contents</a> of the <a href="../include/leveldb/db.h.html#L55" title="include/leveldb/db.h:55">DB</a>.<br/></li>
<li></span>&nbsp; <a href="../table/iterator.cc.html#L9" title="table/iterator.cc:9">Iterator</a>* <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a> = db_-&gt;<a href="../table/table_test.cc.html#L209" title="table/table_test.cc:209">NewIterator</a>(<a href="../include/leveldb/options.h.html#L143" title="include/leveldb/options.h:143">ReadOptions</a>());<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// <a href="log_test.cc.html#L121" title="db/log_test.cc:121">Write</a> to force compactions<br/></li>
<li></span>&nbsp; <a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;foo&quot;</span>, <span class="Constant">&quot;newvalue1&quot;</span>);<br/></li>
<li>&nbsp; <span class="Statement">for</span> (<span class="Type">int</span> i = <span class="Constant">0</span>; i &lt; <span class="Constant">100</span>; i++) {<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<a href="autocompact_test.cc.html#L36" title="db/autocompact_test.cc:36">Key</a>(i), <a href="autocompact_test.cc.html#L36" title="db/autocompact_test.cc:36">Key</a>(i) + std::string(<span class="Constant">100000</span>, <span class="Constant">'v'</span>))); <span class="Comment">// 100K values<br/></li>
<li></span>&nbsp; }<br/></li>
<li>&nbsp; <a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;foo&quot;</span>, <span class="Constant">&quot;newvalue2&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L98" title="table/two_level_iterator.cc:98">SeekToFirst</a>();<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L34" title="table/two_level_iterator.cc:34">Valid</a>());<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;foo&quot;</span>, <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>().<a href="../table/table_test.cc.html#L587" title="table/table_test.cc:587">ToString</a>());<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;hello&quot;</span>, <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L41" title="table/two_level_iterator.cc:41">value</a>().<a href="../table/table_test.cc.html#L587" title="table/table_test.cc:587">ToString</a>());<br/></li>
<li>&nbsp; <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L112" title="table/two_level_iterator.cc:112">Next</a>();<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(!<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L34" title="table/two_level_iterator.cc:34">Valid</a>());<br/></li>
<li>&nbsp; <span class="Statement">delete</span> <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1169">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L209" title="db/db_test.cc:209">DBTest</a>, Snapshot) {<br/></li>
<li>&nbsp; <span class="Statement">do</span> {<br/></li>
<li>&nbsp; &nbsp; <a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;foo&quot;</span>, <span class="Constant">&quot;v1&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> Snapshot* s1 = db_-&gt;<a href="db_impl.cc.html#L1143" title="db/db_impl.cc:1143">GetSnapshot</a>();<br/></li>
<li>&nbsp; &nbsp; <a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;foo&quot;</span>, <span class="Constant">&quot;v2&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> Snapshot* s2 = db_-&gt;<a href="db_impl.cc.html#L1143" title="db/db_impl.cc:1143">GetSnapshot</a>();<br/></li>
<li>&nbsp; &nbsp; <a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;foo&quot;</span>, <span class="Constant">&quot;v3&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> Snapshot* s3 = db_-&gt;<a href="db_impl.cc.html#L1143" title="db/db_impl.cc:1143">GetSnapshot</a>();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;foo&quot;</span>, <span class="Constant">&quot;v4&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;v1&quot;</span>, <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(<span class="Constant">&quot;foo&quot;</span>, s1));<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;v2&quot;</span>, <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(<span class="Constant">&quot;foo&quot;</span>, s2));<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;v3&quot;</span>, <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(<span class="Constant">&quot;foo&quot;</span>, s3));<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;v4&quot;</span>, <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(<span class="Constant">&quot;foo&quot;</span>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; db_-&gt;<a href="db_impl.cc.html#L1148" title="db/db_impl.cc:1148">ReleaseSnapshot</a>(s3);<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;v1&quot;</span>, <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(<span class="Constant">&quot;foo&quot;</span>, s1));<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;v2&quot;</span>, <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(<span class="Constant">&quot;foo&quot;</span>, s2));<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;v4&quot;</span>, <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(<span class="Constant">&quot;foo&quot;</span>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; db_-&gt;<a href="db_impl.cc.html#L1148" title="db/db_impl.cc:1148">ReleaseSnapshot</a>(s1);<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;v2&quot;</span>, <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(<span class="Constant">&quot;foo&quot;</span>, s2));<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;v4&quot;</span>, <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(<span class="Constant">&quot;foo&quot;</span>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; db_-&gt;<a href="db_impl.cc.html#L1148" title="db/db_impl.cc:1148">ReleaseSnapshot</a>(s2);<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;v4&quot;</span>, <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(<span class="Constant">&quot;foo&quot;</span>));<br/></li>
<li>&nbsp; } <span class="Statement">while</span> (<a href="../table/table_builder.cc.html#L76" title="table/table_builder.cc:76">ChangeOptions</a>());<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1198">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L209" title="db/db_test.cc:209">DBTest</a>, HiddenValuesAreRemoved) {<br/></li>
<li>&nbsp; <span class="Statement">do</span> {<br/></li>
<li>&nbsp; &nbsp; <a href="../util/random.h.html#L19" title="util/random.h:19">Random</a> rnd(<span class="Constant">301</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="#L440" title="db/db_test.cc:440">FillLevels</a>(<span class="Constant">&quot;a&quot;</span>, <span class="Constant">&quot;z&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; std::string big = <a href="#L22" title="db/db_test.cc:22">RandomString</a>(&amp;rnd, <span class="Constant">50000</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;foo&quot;</span>, big);<br/></li>
<li>&nbsp; &nbsp; <a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;pastfoo&quot;</span>, <span class="Constant">&quot;v&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> Snapshot* snapshot = db_-&gt;<a href="db_impl.cc.html#L1143" title="db/db_impl.cc:1143">GetSnapshot</a>();<br/></li>
<li>&nbsp; &nbsp; <a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;foo&quot;</span>, <span class="Constant">&quot;tiny&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;pastfoo2&quot;</span>, <span class="Constant">&quot;v2&quot;</span>);&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">// Advance sequence number one more<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="#L253" title="db/db_test.cc:253">dbfull</a>()-&gt;<a href="db_impl.cc.html#L590" title="db/db_impl.cc:590">TEST_CompactMemTable</a>());<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L110" title="util/testharness.h:110">ASSERT_GT</a>(<a href="#L378" title="db/db_test.cc:378">NumTableFilesAtLevel</a>(<span class="Constant">0</span>), <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(big, <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(<span class="Constant">&quot;foo&quot;</span>, snapshot));<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(<a href="../table/table_test.cc.html#L787" title="table/table_test.cc:787">Between</a>(<a href="../table/table_test.cc.html#L118" title="table/table_test.cc:118">Size</a>(<span class="Constant">&quot;&quot;</span>, <span class="Constant">&quot;pastfoo&quot;</span>), <span class="Constant">50000</span>, <span class="Constant">60000</span>));<br/></li>
<li>&nbsp; &nbsp; db_-&gt;<a href="db_impl.cc.html#L1148" title="db/db_impl.cc:1148">ReleaseSnapshot</a>(snapshot);<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L336" title="db/db_test.cc:336">AllEntriesFor</a>(<span class="Constant">&quot;foo&quot;</span>), <span class="Constant">&quot;[ tiny, &quot;</span> + big + <span class="Constant">&quot; ]&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a> x(<span class="Constant">&quot;x&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="#L253" title="db/db_test.cc:253">dbfull</a>()-&gt;<a href="db_impl.cc.html#L553" title="db/db_impl.cc:553">TEST_CompactRange</a>(<span class="Constant">0</span>, <span class="Constant">NULL</span>, &amp;x);<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L336" title="db/db_test.cc:336">AllEntriesFor</a>(<span class="Constant">&quot;foo&quot;</span>), <span class="Constant">&quot;[ tiny ]&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L378" title="db/db_test.cc:378">NumTableFilesAtLevel</a>(<span class="Constant">0</span>), <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L109" title="util/testharness.h:109">ASSERT_GE</a>(<a href="#L378" title="db/db_test.cc:378">NumTableFilesAtLevel</a>(<span class="Constant">1</span>), <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="#L253" title="db/db_test.cc:253">dbfull</a>()-&gt;<a href="db_impl.cc.html#L553" title="db/db_impl.cc:553">TEST_CompactRange</a>(<span class="Constant">1</span>, <span class="Constant">NULL</span>, &amp;x);<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L336" title="db/db_test.cc:336">AllEntriesFor</a>(<span class="Constant">&quot;foo&quot;</span>), <span class="Constant">&quot;[ tiny ]&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(<a href="../table/table_test.cc.html#L787" title="table/table_test.cc:787">Between</a>(<a href="../table/table_test.cc.html#L118" title="table/table_test.cc:118">Size</a>(<span class="Constant">&quot;&quot;</span>, <span class="Constant">&quot;pastfoo&quot;</span>), <span class="Constant">0</span>, <span class="Constant">1000</span>));<br/></li>
<li>&nbsp; } <span class="Statement">while</span> (<a href="../table/table_builder.cc.html#L76" title="table/table_builder.cc:76">ChangeOptions</a>());<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1229">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L209" title="db/db_test.cc:209">DBTest</a>, DeletionMarkers1) {<br/></li>
<li>&nbsp; <a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;foo&quot;</span>, <span class="Constant">&quot;v1&quot;</span>);<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="#L253" title="db/db_test.cc:253">dbfull</a>()-&gt;<a href="db_impl.cc.html#L590" title="db/db_impl.cc:590">TEST_CompactMemTable</a>());<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">int</span> last = config::kMaxMemCompactLevel;<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L378" title="db/db_test.cc:378">NumTableFilesAtLevel</a>(last), <span class="Constant">1</span>);&nbsp;&nbsp; <span class="Comment">// foo =&gt; v1 is now in last <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a><br/></li>
<li></span><br/></li>
<li>&nbsp; <span class="Comment">// Place a table at <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> last-1 to prevent merging with preceding mutation<br/></li>
<li></span>&nbsp; <a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;a&quot;</span>, <span class="Constant">&quot;begin&quot;</span>);<br/></li>
<li>&nbsp; <a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;z&quot;</span>, <span class="Constant">&quot;end&quot;</span>);<br/></li>
<li>&nbsp; <a href="#L253" title="db/db_test.cc:253">dbfull</a>()-&gt;<a href="db_impl.cc.html#L590" title="db/db_impl.cc:590">TEST_CompactMemTable</a>();<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L378" title="db/db_test.cc:378">NumTableFilesAtLevel</a>(last), <span class="Constant">1</span>);<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L378" title="db/db_test.cc:378">NumTableFilesAtLevel</a>(last-<span class="Constant">1</span>), <span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; <a href="write_batch.cc.html#L105" title="db/write_batch.cc:105">Delete</a>(<span class="Constant">&quot;foo&quot;</span>);<br/></li>
<li>&nbsp; <a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;foo&quot;</span>, <span class="Constant">&quot;v2&quot;</span>);<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L336" title="db/db_test.cc:336">AllEntriesFor</a>(<span class="Constant">&quot;foo&quot;</span>), <span class="Constant">&quot;[ v2, DEL, v1 ]&quot;</span>);<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="#L253" title="db/db_test.cc:253">dbfull</a>()-&gt;<a href="db_impl.cc.html#L590" title="db/db_impl.cc:590">TEST_CompactMemTable</a>());&nbsp; <span class="Comment">// Moves to <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> last-2<br/></li>
<li></span>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L336" title="db/db_test.cc:336">AllEntriesFor</a>(<span class="Constant">&quot;foo&quot;</span>), <span class="Constant">&quot;[ v2, DEL, v1 ]&quot;</span>);<br/></li>
<li>&nbsp; <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a> z(<span class="Constant">&quot;z&quot;</span>);<br/></li>
<li>&nbsp; <a href="#L253" title="db/db_test.cc:253">dbfull</a>()-&gt;<a href="db_impl.cc.html#L553" title="db/db_impl.cc:553">TEST_CompactRange</a>(last-<span class="Constant">2</span>, <span class="Constant">NULL</span>, &amp;z);<br/></li>
<li>&nbsp; <span class="Comment">// DEL eliminated, but v1 remains because we aren't compacting that <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a><br/></li>
<li></span>&nbsp; <span class="Comment">// (DEL can be eliminated because v2 hides v1).<br/></li>
<li></span>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L336" title="db/db_test.cc:336">AllEntriesFor</a>(<span class="Constant">&quot;foo&quot;</span>), <span class="Constant">&quot;[ v2, v1 ]&quot;</span>);<br/></li>
<li>&nbsp; <a href="#L253" title="db/db_test.cc:253">dbfull</a>()-&gt;<a href="db_impl.cc.html#L553" title="db/db_impl.cc:553">TEST_CompactRange</a>(last-<span class="Constant">1</span>, <span class="Constant">NULL</span>, <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; <span class="Comment">// Merging last-1 w/ last, so we are the base <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> for &quot;foo&quot;, so<br/></li>
<li></span>&nbsp; <span class="Comment">// DEL is removed.&nbsp; (as is v1).<br/></li>
<li></span>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L336" title="db/db_test.cc:336">AllEntriesFor</a>(<span class="Constant">&quot;foo&quot;</span>), <span class="Constant">&quot;[ v2 ]&quot;</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1258">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L209" title="db/db_test.cc:209">DBTest</a>, DeletionMarkers2) {<br/></li>
<li>&nbsp; <a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;foo&quot;</span>, <span class="Constant">&quot;v1&quot;</span>);<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="#L253" title="db/db_test.cc:253">dbfull</a>()-&gt;<a href="db_impl.cc.html#L590" title="db/db_impl.cc:590">TEST_CompactMemTable</a>());<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">int</span> last = config::kMaxMemCompactLevel;<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L378" title="db/db_test.cc:378">NumTableFilesAtLevel</a>(last), <span class="Constant">1</span>);&nbsp;&nbsp; <span class="Comment">// foo =&gt; v1 is now in last <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a><br/></li>
<li></span><br/></li>
<li>&nbsp; <span class="Comment">// Place a table at <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> last-1 to prevent merging with preceding mutation<br/></li>
<li></span>&nbsp; <a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;a&quot;</span>, <span class="Constant">&quot;begin&quot;</span>);<br/></li>
<li>&nbsp; <a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;z&quot;</span>, <span class="Constant">&quot;end&quot;</span>);<br/></li>
<li>&nbsp; <a href="#L253" title="db/db_test.cc:253">dbfull</a>()-&gt;<a href="db_impl.cc.html#L590" title="db/db_impl.cc:590">TEST_CompactMemTable</a>();<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L378" title="db/db_test.cc:378">NumTableFilesAtLevel</a>(last), <span class="Constant">1</span>);<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L378" title="db/db_test.cc:378">NumTableFilesAtLevel</a>(last-<span class="Constant">1</span>), <span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; <a href="write_batch.cc.html#L105" title="db/write_batch.cc:105">Delete</a>(<span class="Constant">&quot;foo&quot;</span>);<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L336" title="db/db_test.cc:336">AllEntriesFor</a>(<span class="Constant">&quot;foo&quot;</span>), <span class="Constant">&quot;[ DEL, v1 ]&quot;</span>);<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="#L253" title="db/db_test.cc:253">dbfull</a>()-&gt;<a href="db_impl.cc.html#L590" title="db/db_impl.cc:590">TEST_CompactMemTable</a>());&nbsp; <span class="Comment">// Moves to <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> last-2<br/></li>
<li></span>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L336" title="db/db_test.cc:336">AllEntriesFor</a>(<span class="Constant">&quot;foo&quot;</span>), <span class="Constant">&quot;[ DEL, v1 ]&quot;</span>);<br/></li>
<li>&nbsp; <a href="#L253" title="db/db_test.cc:253">dbfull</a>()-&gt;<a href="db_impl.cc.html#L553" title="db/db_impl.cc:553">TEST_CompactRange</a>(last-<span class="Constant">2</span>, <span class="Constant">NULL</span>, <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; <span class="Comment">// DEL kept: &quot;last&quot; file overlaps<br/></li>
<li></span>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L336" title="db/db_test.cc:336">AllEntriesFor</a>(<span class="Constant">&quot;foo&quot;</span>), <span class="Constant">&quot;[ DEL, v1 ]&quot;</span>);<br/></li>
<li>&nbsp; <a href="#L253" title="db/db_test.cc:253">dbfull</a>()-&gt;<a href="db_impl.cc.html#L553" title="db/db_impl.cc:553">TEST_CompactRange</a>(last-<span class="Constant">1</span>, <span class="Constant">NULL</span>, <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; <span class="Comment">// Merging last-1 w/ last, so we are the base <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> for &quot;foo&quot;, so<br/></li>
<li></span>&nbsp; <span class="Comment">// DEL is removed.&nbsp; (as is v1).<br/></li>
<li></span>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L336" title="db/db_test.cc:336">AllEntriesFor</a>(<span class="Constant">&quot;foo&quot;</span>), <span class="Constant">&quot;[ ]&quot;</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1284">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L209" title="db/db_test.cc:209">DBTest</a>, OverlapInLevel0) {<br/></li>
<li>&nbsp; <span class="Statement">do</span> {<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(config::kMaxMemCompactLevel, <span class="Constant">2</span>) &lt;&lt; <span class="Constant">&quot;Fix test to match config&quot;</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// Fill levels 1 and 2 to disable the pushing of new memtables to levels &gt; 0.<br/></li>
<li></span>&nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;100&quot;</span>, <span class="Constant">&quot;v100&quot;</span>));<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;999&quot;</span>, <span class="Constant">&quot;v999&quot;</span>));<br/></li>
<li>&nbsp; &nbsp; <a href="#L253" title="db/db_test.cc:253">dbfull</a>()-&gt;<a href="db_impl.cc.html#L590" title="db/db_impl.cc:590">TEST_CompactMemTable</a>();<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L105" title="db/write_batch.cc:105">Delete</a>(<span class="Constant">&quot;100&quot;</span>));<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L105" title="db/write_batch.cc:105">Delete</a>(<span class="Constant">&quot;999&quot;</span>));<br/></li>
<li>&nbsp; &nbsp; <a href="#L253" title="db/db_test.cc:253">dbfull</a>()-&gt;<a href="db_impl.cc.html#L590" title="db/db_impl.cc:590">TEST_CompactMemTable</a>();<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;0,1,1&quot;</span>, <a href="#L395" title="db/db_test.cc:395">FilesPerLevel</a>());<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// Make files spanning the following ranges in <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>-0:<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">//&nbsp; files[0]&nbsp; 200 .. 900<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">//&nbsp; files[1]&nbsp; 300 .. 500<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">// Note that files are sorted by smallest <a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>.<br/></li>
<li></span>&nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;300&quot;</span>, <span class="Constant">&quot;v300&quot;</span>));<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;500&quot;</span>, <span class="Constant">&quot;v500&quot;</span>));<br/></li>
<li>&nbsp; &nbsp; <a href="#L253" title="db/db_test.cc:253">dbfull</a>()-&gt;<a href="db_impl.cc.html#L590" title="db/db_impl.cc:590">TEST_CompactMemTable</a>();<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;200&quot;</span>, <span class="Constant">&quot;v200&quot;</span>));<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;600&quot;</span>, <span class="Constant">&quot;v600&quot;</span>));<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;900&quot;</span>, <span class="Constant">&quot;v900&quot;</span>));<br/></li>
<li>&nbsp; &nbsp; <a href="#L253" title="db/db_test.cc:253">dbfull</a>()-&gt;<a href="db_impl.cc.html#L590" title="db/db_impl.cc:590">TEST_CompactMemTable</a>();<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;2,1,1&quot;</span>, <a href="#L395" title="db/db_test.cc:395">FilesPerLevel</a>());<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// <a href="#L424" title="db/db_test.cc:424">Compact</a> away the placeholder files we created initially<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L253" title="db/db_test.cc:253">dbfull</a>()-&gt;<a href="db_impl.cc.html#L553" title="db/db_impl.cc:553">TEST_CompactRange</a>(<span class="Constant">1</span>, <span class="Constant">NULL</span>, <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="#L253" title="db/db_test.cc:253">dbfull</a>()-&gt;<a href="db_impl.cc.html#L553" title="db/db_impl.cc:553">TEST_CompactRange</a>(<span class="Constant">2</span>, <span class="Constant">NULL</span>, <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;2&quot;</span>, <a href="#L395" title="db/db_test.cc:395">FilesPerLevel</a>());<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// Do a memtable compaction.&nbsp; Before bug-fix, the compaction would<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">// not detect the overlap with <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>-0 files and would incorrectly place<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">// the deletion in a deeper <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>.<br/></li>
<li></span>&nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L105" title="db/write_batch.cc:105">Delete</a>(<span class="Constant">&quot;600&quot;</span>));<br/></li>
<li>&nbsp; &nbsp; <a href="#L253" title="db/db_test.cc:253">dbfull</a>()-&gt;<a href="db_impl.cc.html#L590" title="db/db_impl.cc:590">TEST_CompactMemTable</a>();<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;3&quot;</span>, <a href="#L395" title="db/db_test.cc:395">FilesPerLevel</a>());<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;NOT_FOUND&quot;</span>, <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(<span class="Constant">&quot;600&quot;</span>));<br/></li>
<li>&nbsp; } <span class="Statement">while</span> (<a href="../table/table_builder.cc.html#L76" title="table/table_builder.cc:76">ChangeOptions</a>());<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1325">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L209" title="db/db_test.cc:209">DBTest</a>, L0_CompactionBug_Issue44_a) {<br/></li>
<li>&nbsp; <a href="corruption_test.cc.html#L60" title="db/corruption_test.cc:60">Reopen</a>();<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;b&quot;</span>, <span class="Constant">&quot;v&quot;</span>));<br/></li>
<li>&nbsp; <a href="corruption_test.cc.html#L60" title="db/corruption_test.cc:60">Reopen</a>();<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L105" title="db/write_batch.cc:105">Delete</a>(<span class="Constant">&quot;b&quot;</span>));<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L105" title="db/write_batch.cc:105">Delete</a>(<span class="Constant">&quot;a&quot;</span>));<br/></li>
<li>&nbsp; <a href="corruption_test.cc.html#L60" title="db/corruption_test.cc:60">Reopen</a>();<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L105" title="db/write_batch.cc:105">Delete</a>(<span class="Constant">&quot;a&quot;</span>));<br/></li>
<li>&nbsp; <a href="corruption_test.cc.html#L60" title="db/corruption_test.cc:60">Reopen</a>();<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;a&quot;</span>, <span class="Constant">&quot;v&quot;</span>));<br/></li>
<li>&nbsp; <a href="corruption_test.cc.html#L60" title="db/corruption_test.cc:60">Reopen</a>();<br/></li>
<li>&nbsp; <a href="corruption_test.cc.html#L60" title="db/corruption_test.cc:60">Reopen</a>();<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;(a-&gt;v)&quot;</span>, <a href="write_batch_internal.h.html#L31" title="db/write_batch_internal.h:31">Contents</a>());<br/></li>
<li>&nbsp; <a href="#L52" title="db/db_test.cc:52">DelayMilliseconds</a>(<span class="Constant">1000</span>);&nbsp; <span class="Comment">// <a href="skiplist_test.cc.html#L315" title="db/skiplist_test.cc:315">Wait</a> for compaction to finish<br/></li>
<li></span>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;(a-&gt;v)&quot;</span>, <a href="write_batch_internal.h.html#L31" title="db/write_batch_internal.h:31">Contents</a>());<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1342">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L209" title="db/db_test.cc:209">DBTest</a>, L0_CompactionBug_Issue44_b) {<br/></li>
<li>&nbsp; <a href="corruption_test.cc.html#L60" title="db/corruption_test.cc:60">Reopen</a>();<br/></li>
<li>&nbsp; <a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;&quot;</span>,<span class="Constant">&quot;&quot;</span>);<br/></li>
<li>&nbsp; <a href="corruption_test.cc.html#L60" title="db/corruption_test.cc:60">Reopen</a>();<br/></li>
<li>&nbsp; <a href="write_batch.cc.html#L105" title="db/write_batch.cc:105">Delete</a>(<span class="Constant">&quot;e&quot;</span>);<br/></li>
<li>&nbsp; <a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;&quot;</span>,<span class="Constant">&quot;&quot;</span>);<br/></li>
<li>&nbsp; <a href="corruption_test.cc.html#L60" title="db/corruption_test.cc:60">Reopen</a>();<br/></li>
<li>&nbsp; <a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;c&quot;</span>, <span class="Constant">&quot;cv&quot;</span>);<br/></li>
<li>&nbsp; <a href="corruption_test.cc.html#L60" title="db/corruption_test.cc:60">Reopen</a>();<br/></li>
<li>&nbsp; <a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;&quot;</span>,<span class="Constant">&quot;&quot;</span>);<br/></li>
<li>&nbsp; <a href="corruption_test.cc.html#L60" title="db/corruption_test.cc:60">Reopen</a>();<br/></li>
<li>&nbsp; <a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;&quot;</span>,<span class="Constant">&quot;&quot;</span>);<br/></li>
<li>&nbsp; <a href="#L52" title="db/db_test.cc:52">DelayMilliseconds</a>(<span class="Constant">1000</span>);&nbsp; <span class="Comment">// <a href="skiplist_test.cc.html#L315" title="db/skiplist_test.cc:315">Wait</a> for compaction to finish<br/></li>
<li></span>&nbsp; <a href="corruption_test.cc.html#L60" title="db/corruption_test.cc:60">Reopen</a>();<br/></li>
<li>&nbsp; <a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;d&quot;</span>,<span class="Constant">&quot;dv&quot;</span>);<br/></li>
<li>&nbsp; <a href="corruption_test.cc.html#L60" title="db/corruption_test.cc:60">Reopen</a>();<br/></li>
<li>&nbsp; <a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;&quot;</span>,<span class="Constant">&quot;&quot;</span>);<br/></li>
<li>&nbsp; <a href="corruption_test.cc.html#L60" title="db/corruption_test.cc:60">Reopen</a>();<br/></li>
<li>&nbsp; <a href="write_batch.cc.html#L105" title="db/write_batch.cc:105">Delete</a>(<span class="Constant">&quot;d&quot;</span>);<br/></li>
<li>&nbsp; <a href="write_batch.cc.html#L105" title="db/write_batch.cc:105">Delete</a>(<span class="Constant">&quot;b&quot;</span>);<br/></li>
<li>&nbsp; <a href="corruption_test.cc.html#L60" title="db/corruption_test.cc:60">Reopen</a>();<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;(-&gt;)(c-&gt;cv)&quot;</span>, <a href="write_batch_internal.h.html#L31" title="db/write_batch_internal.h:31">Contents</a>());<br/></li>
<li>&nbsp; <a href="#L52" title="db/db_test.cc:52">DelayMilliseconds</a>(<span class="Constant">1000</span>);&nbsp; <span class="Comment">// <a href="skiplist_test.cc.html#L315" title="db/skiplist_test.cc:315">Wait</a> for compaction to finish<br/></li>
<li></span>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;(-&gt;)(c-&gt;cv)&quot;</span>, <a href="write_batch_internal.h.html#L31" title="db/write_batch_internal.h:31">Contents</a>());<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1368">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L209" title="db/db_test.cc:209">DBTest</a>, ComparatorCheck) {<br/></li>
<li>&nbsp; <span class="Type">class</span> NewComparator : <span class="Statement">public</span> <a href="skiplist_test.cc.html#L17" title="db/skiplist_test.cc:17">Comparator</a> {<br/></li>
<li><span class="cUserCont">&nbsp;&nbsp; </span><span class="Statement">public</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">virtual</span> <span class="Type">const</span> <span class="Type">char</span>* <a href="../table/table_test.cc.html#L40" title="table/table_test.cc:40">Name</a>() <span class="Type">const</span> { <span class="Statement">return</span> <span class="Constant">&quot;leveldb.NewComparator&quot;</span>; }<br/></li>
<li>&nbsp; &nbsp; <span class="Type">virtual</span> <span class="Type">int</span> <a href="../table/table_test.cc.html#L44" title="table/table_test.cc:44">Compare</a>(<span class="Type">const</span> <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>&amp; a, <span class="Type">const</span> <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>&amp; b) <span class="Type">const</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../util/comparator.cc.html#L76" title="util/comparator.cc:76">BytewiseComparator</a>()-&gt;<a href="../table/table_test.cc.html#L44" title="table/table_test.cc:44">Compare</a>(a, b);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Type">virtual</span> <span class="Type">void</span> <a href="../table/table_test.cc.html#L48" title="table/table_test.cc:48">FindShortestSeparator</a>(std::string* s, <span class="Type">const</span> <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>&amp; l) <span class="Type">const</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../util/comparator.cc.html#L76" title="util/comparator.cc:76">BytewiseComparator</a>()-&gt;<a href="../table/table_test.cc.html#L48" title="table/table_test.cc:48">FindShortestSeparator</a>(s, l);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Type">virtual</span> <span class="Type">void</span> <a href="../table/table_test.cc.html#L57" title="table/table_test.cc:57">FindShortSuccessor</a>(std::string* <a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>) <span class="Type">const</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../util/comparator.cc.html#L76" title="util/comparator.cc:76">BytewiseComparator</a>()-&gt;<a href="../table/table_test.cc.html#L57" title="table/table_test.cc:57">FindShortSuccessor</a>(<a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; };<br/></li>
<li>&nbsp; NewComparator cmp;<br/></li>
<li>&nbsp; <a href="../include/leveldb/options.h.html#L31" title="include/leveldb/options.h:31">Options</a> new_options = <a href="#L238" title="db/db_test.cc:238">CurrentOptions</a>();<br/></li>
<li>&nbsp; new_options.comparator = &amp;cmp;<br/></li>
<li>&nbsp; <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> s = <a href="corruption_test.cc.html#L54" title="db/corruption_test.cc:54">TryReopen</a>(&amp;new_options);<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(!s.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>());<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(s.<a href="../table/table_test.cc.html#L587" title="table/table_test.cc:587">ToString</a>().find(<span class="Constant">&quot;comparator&quot;</span>) != std::string::npos)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &lt;&lt; s.<a href="../table/table_test.cc.html#L587" title="table/table_test.cc:587">ToString</a>();<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1391">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L209" title="db/db_test.cc:209">DBTest</a>, CustomComparator) {<br/></li>
<li>&nbsp; <span class="Type">class</span> NumberComparator : <span class="Statement">public</span> <a href="skiplist_test.cc.html#L17" title="db/skiplist_test.cc:17">Comparator</a> {<br/></li>
<li><span class="cUserCont">&nbsp;&nbsp; </span><span class="Statement">public</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">virtual</span> <span class="Type">const</span> <span class="Type">char</span>* <a href="../table/table_test.cc.html#L40" title="table/table_test.cc:40">Name</a>() <span class="Type">const</span> { <span class="Statement">return</span> <span class="Constant">&quot;test.NumberComparator&quot;</span>; }<br/></li>
<li>&nbsp; &nbsp; <span class="Type">virtual</span> <span class="Type">int</span> <a href="../table/table_test.cc.html#L44" title="table/table_test.cc:44">Compare</a>(<span class="Type">const</span> <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>&amp; a, <span class="Type">const</span> <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>&amp; b) <span class="Type">const</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span> ToNumber(a) - ToNumber(b);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Type">virtual</span> <span class="Type">void</span> <a href="../table/table_test.cc.html#L48" title="table/table_test.cc:48">FindShortestSeparator</a>(std::string* s, <span class="Type">const</span> <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>&amp; l) <span class="Type">const</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; ToNumber(*s);&nbsp; &nbsp;&nbsp; <span class="Comment">// <a href="corruption_test.cc.html#L88" title="db/corruption_test.cc:88">Check</a> format<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; ToNumber(l);&nbsp; &nbsp; &nbsp; <span class="Comment">// <a href="corruption_test.cc.html#L88" title="db/corruption_test.cc:88">Check</a> format<br/></li>
<li></span>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Type">virtual</span> <span class="Type">void</span> <a href="../table/table_test.cc.html#L57" title="table/table_test.cc:57">FindShortSuccessor</a>(std::string* <a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>) <span class="Type">const</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; ToNumber(*<a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>);&nbsp;&nbsp; <span class="Comment">// <a href="corruption_test.cc.html#L88" title="db/corruption_test.cc:88">Check</a> format<br/></li>
<li></span>&nbsp; &nbsp; }<br/></li>
<li><span class="cUserCont">&nbsp;&nbsp; </span><span class="Statement">private</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">static</span> <span class="Type">int</span> ToNumber(<span class="Type">const</span> <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>&amp; x) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Comment">// <a href="corruption_test.cc.html#L88" title="db/corruption_test.cc:88">Check</a> that there are no extra characters.<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(x.<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>() &gt;= <span class="Constant">2</span> &amp;&amp; x[<span class="Constant">0</span>] == <span class="Constant">'['</span> &amp;&amp; x[x.<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>()-<span class="Constant">1</span>] == <span class="Constant">']'</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;&lt; <a href="../util/logging.cc.html#L42" title="util/logging.cc:42">EscapeString</a>(x);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Type">int</span> val;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Type">char</span> ignored;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(sscanf(x.<a href="../table/table_test.cc.html#L587" title="table/table_test.cc:587">ToString</a>().c_str(), <span class="Constant">&quot;[</span><span class="Special">%i</span><span class="Constant">]</span><span class="Special">%c</span><span class="Constant">&quot;</span>, &amp;val, &amp;ignored) == <span class="Constant">1</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;&lt; <a href="../util/logging.cc.html#L42" title="util/logging.cc:42">EscapeString</a>(x);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span> val;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; };<br/></li>
<li>&nbsp; NumberComparator cmp;<br/></li>
<li>&nbsp; <a href="../include/leveldb/options.h.html#L31" title="include/leveldb/options.h:31">Options</a> new_options = <a href="#L238" title="db/db_test.cc:238">CurrentOptions</a>();<br/></li>
<li>&nbsp; new_options.create_if_missing = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; new_options.comparator = &amp;cmp;<br/></li>
<li>&nbsp; new_options.filter_policy = <span class="Constant">NULL</span>;&nbsp; &nbsp;&nbsp; <span class="Comment">// Cannot use bloom filters<br/></li>
<li></span>&nbsp; new_options.write_buffer_size = <span class="Constant">1000</span>;&nbsp; <span class="Comment">// <a href="#L424" title="db/db_test.cc:424">Compact</a> more often<br/></li>
<li></span>&nbsp; <a href="#L266" title="db/db_test.cc:266">DestroyAndReopen</a>(&amp;new_options);<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;[10]&quot;</span>, <span class="Constant">&quot;ten&quot;</span>));<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;[0x14]&quot;</span>, <span class="Constant">&quot;twenty&quot;</span>));<br/></li>
<li>&nbsp; <span class="Statement">for</span> (<span class="Type">int</span> i = <span class="Constant">0</span>; i &lt; <span class="Constant">2</span>; i++) {<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;ten&quot;</span>, <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(<span class="Constant">&quot;[10]&quot;</span>));<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;ten&quot;</span>, <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(<span class="Constant">&quot;[0xa]&quot;</span>));<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;twenty&quot;</span>, <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(<span class="Constant">&quot;[20]&quot;</span>));<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;twenty&quot;</span>, <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(<span class="Constant">&quot;[0x14]&quot;</span>));<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;NOT_FOUND&quot;</span>, <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(<span class="Constant">&quot;[15]&quot;</span>));<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;NOT_FOUND&quot;</span>, <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(<span class="Constant">&quot;[0xf]&quot;</span>));<br/></li>
<li>&nbsp; &nbsp; <a href="#L424" title="db/db_test.cc:424">Compact</a>(<span class="Constant">&quot;[0]&quot;</span>, <span class="Constant">&quot;[9999]&quot;</span>);<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">for</span> (<span class="Type">int</span> run = <span class="Constant">0</span>; run &lt; <span class="Constant">2</span>; run++) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (<span class="Type">int</span> i = <span class="Constant">0</span>; i &lt; <span class="Constant">1000</span>; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Type">char</span> buf[<span class="Constant">100</span>];<br/></li>
<li>&nbsp; &nbsp; &nbsp; snprintf(buf, <span class="Statement">sizeof</span>(buf), <span class="Constant">&quot;[</span><span class="Special">%d</span><span class="Constant">]&quot;</span>, i*<span class="Constant">10</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(buf, buf));<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <a href="#L424" title="db/db_test.cc:424">Compact</a>(<span class="Constant">&quot;[0]&quot;</span>, <span class="Constant">&quot;[1000000]&quot;</span>);<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1446">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L209" title="db/db_test.cc:209">DBTest</a>, <a href="db_impl.h.html#L162" title="db/db_impl.h:162">ManualCompaction</a>) {<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(config::kMaxMemCompactLevel, <span class="Constant">2</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &lt;&lt; <span class="Constant">&quot;Need to update this test to match kMaxMemCompactLevel&quot;</span>;<br/></li>
<li><br/></li>
<li>&nbsp; <a href="#L430" title="db/db_test.cc:430">MakeTables</a>(<span class="Constant">3</span>, <span class="Constant">&quot;p&quot;</span>, <span class="Constant">&quot;q&quot;</span>);<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;1,1,1&quot;</span>, <a href="#L395" title="db/db_test.cc:395">FilesPerLevel</a>());<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// <a href="version_set.cc.html#L1399" title="db/version_set.cc:1399">Compaction</a> range falls before files<br/></li>
<li></span>&nbsp; <a href="#L424" title="db/db_test.cc:424">Compact</a>(<span class="Constant">&quot;&quot;</span>, <span class="Constant">&quot;c&quot;</span>);<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;1,1,1&quot;</span>, <a href="#L395" title="db/db_test.cc:395">FilesPerLevel</a>());<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// <a href="version_set.cc.html#L1399" title="db/version_set.cc:1399">Compaction</a> range falls after files<br/></li>
<li></span>&nbsp; <a href="#L424" title="db/db_test.cc:424">Compact</a>(<span class="Constant">&quot;r&quot;</span>, <span class="Constant">&quot;z&quot;</span>);<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;1,1,1&quot;</span>, <a href="#L395" title="db/db_test.cc:395">FilesPerLevel</a>());<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// <a href="version_set.cc.html#L1399" title="db/version_set.cc:1399">Compaction</a> range overlaps files<br/></li>
<li></span>&nbsp; <a href="#L424" title="db/db_test.cc:424">Compact</a>(<span class="Constant">&quot;p1&quot;</span>, <span class="Constant">&quot;p9&quot;</span>);<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;0,0,1&quot;</span>, <a href="#L395" title="db/db_test.cc:395">FilesPerLevel</a>());<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// Populate a different range<br/></li>
<li></span>&nbsp; <a href="#L430" title="db/db_test.cc:430">MakeTables</a>(<span class="Constant">3</span>, <span class="Constant">&quot;c&quot;</span>, <span class="Constant">&quot;e&quot;</span>);<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;1,1,2&quot;</span>, <a href="#L395" title="db/db_test.cc:395">FilesPerLevel</a>());<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// <a href="#L424" title="db/db_test.cc:424">Compact</a> just the new range<br/></li>
<li></span>&nbsp; <a href="#L424" title="db/db_test.cc:424">Compact</a>(<span class="Constant">&quot;b&quot;</span>, <span class="Constant">&quot;f&quot;</span>);<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;0,0,2&quot;</span>, <a href="#L395" title="db/db_test.cc:395">FilesPerLevel</a>());<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// <a href="#L424" title="db/db_test.cc:424">Compact</a> all<br/></li>
<li></span>&nbsp; <a href="#L430" title="db/db_test.cc:430">MakeTables</a>(<span class="Constant">1</span>, <span class="Constant">&quot;a&quot;</span>, <span class="Constant">&quot;z&quot;</span>);<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;0,1,2&quot;</span>, <a href="#L395" title="db/db_test.cc:395">FilesPerLevel</a>());<br/></li>
<li>&nbsp; db_-&gt;<a href="version_set.cc.html#L1364" title="db/version_set.cc:1364">CompactRange</a>(<span class="Constant">NULL</span>, <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;0,0,1&quot;</span>, <a href="#L395" title="db/db_test.cc:395">FilesPerLevel</a>());<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1480">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L209" title="db/db_test.cc:209">DBTest</a>, DBOpen_Options) {<br/></li>
<li>&nbsp; std::string <a href="c_test.c.html#L15" title="db/c_test.c:15">dbname</a> = test::<a href="../util/testharness.cc.html#L60" title="util/testharness.cc:60">TmpDir</a>() + <span class="Constant">&quot;/db_options_test&quot;</span>;<br/></li>
<li>&nbsp; <a href="db_impl.cc.html#L1482" title="db/db_impl.cc:1482">DestroyDB</a>(<a href="c_test.c.html#L15" title="db/c_test.c:15">dbname</a>, <a href="../include/leveldb/options.h.html#L31" title="include/leveldb/options.h:31">Options</a>());<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// Does not exist, and create_if_missing == false: error<br/></li>
<li></span>&nbsp; <a href="../include/leveldb/db.h.html#L55" title="include/leveldb/db.h:55">DB</a>* <a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a> = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; <a href="../include/leveldb/options.h.html#L31" title="include/leveldb/options.h:31">Options</a> opts;<br/></li>
<li>&nbsp; opts.create_if_missing = <span class="Constant">false</span>;<br/></li>
<li>&nbsp; <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> s = <a href="../include/leveldb/db.h.html#L55" title="include/leveldb/db.h:55">DB</a>::<a href="../table/table.cc.html#L38" title="table/table.cc:38">Open</a>(opts, <a href="c_test.c.html#L15" title="db/c_test.c:15">dbname</a>, &amp;<a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a>);<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(strstr(s.<a href="../table/table_test.cc.html#L587" title="table/table_test.cc:587">ToString</a>().c_str(), <span class="Constant">&quot;does not exist&quot;</span>) != <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(<a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a> == <span class="Constant">NULL</span>);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// Does not exist, and create_if_missing == true: <a href="../include/leveldb/status.h.html#L32" title="include/leveldb/status.h:32">OK</a><br/></li>
<li></span>&nbsp; opts.create_if_missing = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; s = <a href="../include/leveldb/db.h.html#L55" title="include/leveldb/db.h:55">DB</a>::<a href="../table/table.cc.html#L38" title="table/table.cc:38">Open</a>(opts, <a href="c_test.c.html#L15" title="db/c_test.c:15">dbname</a>, &amp;<a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a>);<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(s);<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(<a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a> != <span class="Constant">NULL</span>);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">delete</span> <a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a>;<br/></li>
<li>&nbsp; <a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a> = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// Does exist, and error_if_exists == true: error<br/></li>
<li></span>&nbsp; opts.create_if_missing = <span class="Constant">false</span>;<br/></li>
<li>&nbsp; opts.error_if_exists = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; s = <a href="../include/leveldb/db.h.html#L55" title="include/leveldb/db.h:55">DB</a>::<a href="../table/table.cc.html#L38" title="table/table.cc:38">Open</a>(opts, <a href="c_test.c.html#L15" title="db/c_test.c:15">dbname</a>, &amp;<a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a>);<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(strstr(s.<a href="../table/table_test.cc.html#L587" title="table/table_test.cc:587">ToString</a>().c_str(), <span class="Constant">&quot;exists&quot;</span>) != <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(<a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a> == <span class="Constant">NULL</span>);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// Does exist, and error_if_exists == false: <a href="../include/leveldb/status.h.html#L32" title="include/leveldb/status.h:32">OK</a><br/></li>
<li></span>&nbsp; opts.create_if_missing = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; opts.error_if_exists = <span class="Constant">false</span>;<br/></li>
<li>&nbsp; s = <a href="../include/leveldb/db.h.html#L55" title="include/leveldb/db.h:55">DB</a>::<a href="../table/table.cc.html#L38" title="table/table.cc:38">Open</a>(opts, <a href="c_test.c.html#L15" title="db/c_test.c:15">dbname</a>, &amp;<a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a>);<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(s);<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(<a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a> != <span class="Constant">NULL</span>);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">delete</span> <a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a>;<br/></li>
<li>&nbsp; <a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a> = <span class="Constant">NULL</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1519">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L209" title="db/db_test.cc:209">DBTest</a>, Locking) {<br/></li>
<li>&nbsp; <a href="../include/leveldb/db.h.html#L55" title="include/leveldb/db.h:55">DB</a>* db2 = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> s = <a href="../include/leveldb/db.h.html#L55" title="include/leveldb/db.h:55">DB</a>::<a href="../table/table.cc.html#L38" title="table/table.cc:38">Open</a>(<a href="#L238" title="db/db_test.cc:238">CurrentOptions</a>(), dbname_, &amp;db2);<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(!s.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>()) &lt;&lt; <span class="Constant">&quot;Locking did not prevent re-opening <a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a>&quot;</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">// <a href="corruption_test.cc.html#L88" title="db/corruption_test.cc:88">Check</a> that number of files does not grow when we are out of space<br/></li>
<li><a id="L1526">&#x200c;</a></span><span class="linkable">TEST</span>(<a href="#L209" title="db/db_test.cc:209">DBTest</a>, NoSpace) {<br/></li>
<li>&nbsp; <a href="../include/leveldb/options.h.html#L31" title="include/leveldb/options.h:31">Options</a> options = <a href="#L238" title="db/db_test.cc:238">CurrentOptions</a>();<br/></li>
<li>&nbsp; options.env = env_;<br/></li>
<li>&nbsp; <a href="corruption_test.cc.html#L60" title="db/corruption_test.cc:60">Reopen</a>(&amp;options);<br/></li>
<li><br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;foo&quot;</span>, <span class="Constant">&quot;v1&quot;</span>));<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;v1&quot;</span>, <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(<span class="Constant">&quot;foo&quot;</span>));<br/></li>
<li>&nbsp; <a href="#L424" title="db/db_test.cc:424">Compact</a>(<span class="Constant">&quot;a&quot;</span>, <span class="Constant">&quot;z&quot;</span>);<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">int</span> num_files = <a href="#L411" title="db/db_test.cc:411">CountFiles</a>();<br/></li>
<li>&nbsp; env_-&gt;no_space_.<a href="../port/atomic_pointer.h.html#L121" title="port/atomic_pointer.h:121">Release_Store</a>(env_);&nbsp;&nbsp; <span class="Comment">// Force out-of-space errors<br/></li>
<li></span>&nbsp; <span class="Statement">for</span> (<span class="Type">int</span> i = <span class="Constant">0</span>; i &lt; <span class="Constant">10</span>; i++) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (<span class="Type">int</span> <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> = <span class="Constant">0</span>; <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> &lt; config::kNumLevels-<span class="Constant">1</span>; <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L253" title="db/db_test.cc:253">dbfull</a>()-&gt;<a href="db_impl.cc.html#L553" title="db/db_impl.cc:553">TEST_CompactRange</a>(<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>, <span class="Constant">NULL</span>, <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; env_-&gt;no_space_.<a href="../port/atomic_pointer.h.html#L121" title="port/atomic_pointer.h:121">Release_Store</a>(<span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L112" title="util/testharness.h:112">ASSERT_LT</a>(<a href="#L411" title="db/db_test.cc:411">CountFiles</a>(), num_files + <span class="Constant">3</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1545">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L209" title="db/db_test.cc:209">DBTest</a>, NonWritableFileSystem) {<br/></li>
<li>&nbsp; <a href="../include/leveldb/options.h.html#L31" title="include/leveldb/options.h:31">Options</a> options = <a href="#L238" title="db/db_test.cc:238">CurrentOptions</a>();<br/></li>
<li>&nbsp; options.write_buffer_size = <span class="Constant">1000</span>;<br/></li>
<li>&nbsp; options.env = env_;<br/></li>
<li>&nbsp; <a href="corruption_test.cc.html#L60" title="db/corruption_test.cc:60">Reopen</a>(&amp;options);<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;foo&quot;</span>, <span class="Constant">&quot;v1&quot;</span>));<br/></li>
<li>&nbsp; env_-&gt;non_writable_.<a href="../port/atomic_pointer.h.html#L121" title="port/atomic_pointer.h:121">Release_Store</a>(env_);&nbsp; <span class="Comment">// Force errors for new files<br/></li>
<li></span>&nbsp; std::string big(<span class="Constant">100000</span>, <span class="Constant">'x'</span>);<br/></li>
<li>&nbsp; <span class="Type">int</span> errors = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; <span class="Statement">for</span> (<span class="Type">int</span> i = <span class="Constant">0</span>; i &lt; <span class="Constant">20</span>; i++) {<br/></li>
<li>&nbsp; &nbsp; fprintf(<span class="Constant">stderr</span>, <span class="Constant">&quot;<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a> </span><span class="Special">%d</span><span class="Constant">; errors </span><span class="Special">%d\n</span><span class="Constant">&quot;</span>, i, errors);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;foo&quot;</span>, big).<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>()) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; errors++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L52" title="db/db_test.cc:52">DelayMilliseconds</a>(<span class="Constant">100</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L110" title="util/testharness.h:110">ASSERT_GT</a>(errors, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; env_-&gt;non_writable_.<a href="../port/atomic_pointer.h.html#L121" title="port/atomic_pointer.h:121">Release_Store</a>(<span class="Constant">NULL</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1565">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L209" title="db/db_test.cc:209">DBTest</a>, WriteSyncError) {<br/></li>
<li>&nbsp; <span class="Comment">// <a href="corruption_test.cc.html#L88" title="db/corruption_test.cc:88">Check</a> that log sync errors cause the <a href="../include/leveldb/db.h.html#L55" title="include/leveldb/db.h:55">DB</a> to disallow future writes.<br/></li>
<li></span><br/></li>
<li>&nbsp; <span class="Comment">// (a) Cause log sync calls to fail<br/></li>
<li></span>&nbsp; <a href="../include/leveldb/options.h.html#L31" title="include/leveldb/options.h:31">Options</a> options = <a href="#L238" title="db/db_test.cc:238">CurrentOptions</a>();<br/></li>
<li>&nbsp; options.env = env_;<br/></li>
<li>&nbsp; <a href="corruption_test.cc.html#L60" title="db/corruption_test.cc:60">Reopen</a>(&amp;options);<br/></li>
<li>&nbsp; env_-&gt;data_sync_error_.<a href="../port/atomic_pointer.h.html#L121" title="port/atomic_pointer.h:121">Release_Store</a>(env_);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// (b) Normal write should succeed<br/></li>
<li></span>&nbsp; <a href="../include/leveldb/options.h.html#L169" title="include/leveldb/options.h:169">WriteOptions</a> w;<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(db_-&gt;<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(w, <span class="Constant">&quot;k1&quot;</span>, <span class="Constant">&quot;v1&quot;</span>));<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;v1&quot;</span>, <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(<span class="Constant">&quot;k1&quot;</span>));<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// (c) Do a sync write; should fail<br/></li>
<li></span>&nbsp; w.sync = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(!db_-&gt;<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(w, <span class="Constant">&quot;k2&quot;</span>, <span class="Constant">&quot;v2&quot;</span>).<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>());<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;v1&quot;</span>, <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(<span class="Constant">&quot;k1&quot;</span>));<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;NOT_FOUND&quot;</span>, <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(<span class="Constant">&quot;k2&quot;</span>));<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// (d) make sync behave normally<br/></li>
<li></span>&nbsp; env_-&gt;data_sync_error_.<a href="../port/atomic_pointer.h.html#L121" title="port/atomic_pointer.h:121">Release_Store</a>(<span class="Constant">NULL</span>);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// (e) Do a non-sync write; should fail<br/></li>
<li></span>&nbsp; w.sync = <span class="Constant">false</span>;<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(!db_-&gt;<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(w, <span class="Constant">&quot;k3&quot;</span>, <span class="Constant">&quot;v3&quot;</span>).<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>());<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;v1&quot;</span>, <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(<span class="Constant">&quot;k1&quot;</span>));<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;NOT_FOUND&quot;</span>, <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(<span class="Constant">&quot;k2&quot;</span>));<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;NOT_FOUND&quot;</span>, <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(<span class="Constant">&quot;k3&quot;</span>));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1596">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L209" title="db/db_test.cc:209">DBTest</a>, ManifestWriteError) {<br/></li>
<li>&nbsp; <span class="Comment">// <a href="../table/table_test.cc.html#L477" title="table/table_test.cc:477">Test</a> for the following problem:<br/></li>
<li></span>&nbsp; <span class="Comment">// (a) <a href="version_set.cc.html#L1399" title="db/version_set.cc:1399">Compaction</a> produces file F<br/></li>
<li></span>&nbsp; <span class="Comment">// (b) <a href="../util/env.cc.html#L27" title="util/env.cc:27">Log</a> record containing F is written to MANIFEST file, but <a href="../table/table_test.cc.html#L98" title="table/table_test.cc:98">Sync</a>() fails<br/></li>
<li></span>&nbsp; <span class="Comment">// (c) GC deletes F<br/></li>
<li></span>&nbsp; <span class="Comment">// (d) After reopening <a href="../include/leveldb/db.h.html#L55" title="include/leveldb/db.h:55">DB</a>, reads fail since deleted F is named in log record<br/></li>
<li></span><br/></li>
<li>&nbsp; <span class="Comment">// We iterate twice.&nbsp; In the second iteration, everything is the<br/></li>
<li></span>&nbsp; <span class="Comment">// same except the log record never makes it to the MANIFEST file.<br/></li>
<li></span>&nbsp; <span class="Statement">for</span> (<span class="Type">int</span> <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a> = <span class="Constant">0</span>; <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a> &lt; <span class="Constant">2</span>; <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>++) {<br/></li>
<li>&nbsp; &nbsp; port::<a href="../port/port_example.h.html#L83" title="port/port_example.h:83">AtomicPointer</a>* error_type = (<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a> == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ? &amp;env_-&gt;manifest_sync_error_<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; : &amp;env_-&gt;manifest_write_error_;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// <a href="skiplist.h.html#L337" title="db/skiplist.h:337">Insert</a> foo=&gt;bar mapping<br/></li>
<li></span>&nbsp; &nbsp; <a href="../include/leveldb/options.h.html#L31" title="include/leveldb/options.h:31">Options</a> options = <a href="#L238" title="db/db_test.cc:238">CurrentOptions</a>();<br/></li>
<li>&nbsp; &nbsp; options.env = env_;<br/></li>
<li>&nbsp; &nbsp; options.create_if_missing = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; options.error_if_exists = <span class="Constant">false</span>;<br/></li>
<li>&nbsp; &nbsp; <a href="#L266" title="db/db_test.cc:266">DestroyAndReopen</a>(&amp;options);<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;foo&quot;</span>, <span class="Constant">&quot;bar&quot;</span>));<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;bar&quot;</span>, <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(<span class="Constant">&quot;foo&quot;</span>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// Memtable compaction (will succeed)<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L253" title="db/db_test.cc:253">dbfull</a>()-&gt;<a href="db_impl.cc.html#L590" title="db/db_impl.cc:590">TEST_CompactMemTable</a>();<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;bar&quot;</span>, <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(<span class="Constant">&quot;foo&quot;</span>));<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <span class="Type">int</span> last = config::kMaxMemCompactLevel;<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L378" title="db/db_test.cc:378">NumTableFilesAtLevel</a>(last), <span class="Constant">1</span>);&nbsp;&nbsp; <span class="Comment">// foo=&gt;bar is now in last <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a><br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// Merging compaction (will fail)<br/></li>
<li></span>&nbsp; &nbsp; error_type-&gt;<a href="../port/atomic_pointer.h.html#L121" title="port/atomic_pointer.h:121">Release_Store</a>(env_);<br/></li>
<li>&nbsp; &nbsp; <a href="#L253" title="db/db_test.cc:253">dbfull</a>()-&gt;<a href="db_impl.cc.html#L553" title="db/db_impl.cc:553">TEST_CompactRange</a>(last, <span class="Constant">NULL</span>, <span class="Constant">NULL</span>);&nbsp; <span class="Comment">// Should fail<br/></li>
<li></span>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;bar&quot;</span>, <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(<span class="Constant">&quot;foo&quot;</span>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// Recovery: should not lose <a href="../table/table_test.cc.html#L173" title="table/table_test.cc:173">data</a><br/></li>
<li></span>&nbsp; &nbsp; error_type-&gt;<a href="../port/atomic_pointer.h.html#L121" title="port/atomic_pointer.h:121">Release_Store</a>(<span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="corruption_test.cc.html#L60" title="db/corruption_test.cc:60">Reopen</a>(&amp;options);<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;bar&quot;</span>, <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(<span class="Constant">&quot;foo&quot;</span>));<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1637">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L209" title="db/db_test.cc:209">DBTest</a>, MissingSSTFile) {<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;foo&quot;</span>, <span class="Constant">&quot;bar&quot;</span>));<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;bar&quot;</span>, <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(<span class="Constant">&quot;foo&quot;</span>));<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// Dump the memtable to disk.<br/></li>
<li></span>&nbsp; <a href="#L253" title="db/db_test.cc:253">dbfull</a>()-&gt;<a href="db_impl.cc.html#L590" title="db/db_impl.cc:590">TEST_CompactMemTable</a>();<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;bar&quot;</span>, <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(<span class="Constant">&quot;foo&quot;</span>));<br/></li>
<li><br/></li>
<li>&nbsp; <a href="../table/table_test.cc.html#L96" title="table/table_test.cc:96">Close</a>();<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(<a href="#L473" title="db/db_test.cc:473">DeleteAnSSTFile</a>());<br/></li>
<li>&nbsp; <a href="../include/leveldb/options.h.html#L31" title="include/leveldb/options.h:31">Options</a> options = <a href="#L238" title="db/db_test.cc:238">CurrentOptions</a>();<br/></li>
<li>&nbsp; options.paranoid_checks = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> s = <a href="corruption_test.cc.html#L54" title="db/corruption_test.cc:54">TryReopen</a>(&amp;options);<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(!s.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>());<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(s.<a href="../table/table_test.cc.html#L587" title="table/table_test.cc:587">ToString</a>().find(<span class="Constant">&quot;issing&quot;</span>) != std::string::npos)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &lt;&lt; s.<a href="../table/table_test.cc.html#L587" title="table/table_test.cc:587">ToString</a>();<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1655">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L209" title="db/db_test.cc:209">DBTest</a>, StillReadSST) {<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;foo&quot;</span>, <span class="Constant">&quot;bar&quot;</span>));<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;bar&quot;</span>, <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(<span class="Constant">&quot;foo&quot;</span>));<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// Dump the memtable to disk.<br/></li>
<li></span>&nbsp; <a href="#L253" title="db/db_test.cc:253">dbfull</a>()-&gt;<a href="db_impl.cc.html#L590" title="db/db_impl.cc:590">TEST_CompactMemTable</a>();<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;bar&quot;</span>, <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(<span class="Constant">&quot;foo&quot;</span>));<br/></li>
<li>&nbsp; <a href="../table/table_test.cc.html#L96" title="table/table_test.cc:96">Close</a>();<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L110" title="util/testharness.h:110">ASSERT_GT</a>(<a href="#L488" title="db/db_test.cc:488">RenameLDBToSST</a>(), <span class="Constant">0</span>);<br/></li>
<li>&nbsp; <a href="../include/leveldb/options.h.html#L31" title="include/leveldb/options.h:31">Options</a> options = <a href="#L238" title="db/db_test.cc:238">CurrentOptions</a>();<br/></li>
<li>&nbsp; options.paranoid_checks = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> s = <a href="corruption_test.cc.html#L54" title="db/corruption_test.cc:54">TryReopen</a>(&amp;options);<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(s.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>());<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;bar&quot;</span>, <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(<span class="Constant">&quot;foo&quot;</span>));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1671">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L209" title="db/db_test.cc:209">DBTest</a>, FilesDeletedAfterCompaction) {<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;foo&quot;</span>, <span class="Constant">&quot;v2&quot;</span>));<br/></li>
<li>&nbsp; <a href="#L424" title="db/db_test.cc:424">Compact</a>(<span class="Constant">&quot;a&quot;</span>, <span class="Constant">&quot;z&quot;</span>);<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">int</span> num_files = <a href="#L411" title="db/db_test.cc:411">CountFiles</a>();<br/></li>
<li>&nbsp; <span class="Statement">for</span> (<span class="Type">int</span> i = <span class="Constant">0</span>; i &lt; <span class="Constant">10</span>; i++) {<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Constant">&quot;foo&quot;</span>, <span class="Constant">&quot;v2&quot;</span>));<br/></li>
<li>&nbsp; &nbsp; <a href="#L424" title="db/db_test.cc:424">Compact</a>(<span class="Constant">&quot;a&quot;</span>, <span class="Constant">&quot;z&quot;</span>);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L411" title="db/db_test.cc:411">CountFiles</a>(), num_files);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1682">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L209" title="db/db_test.cc:209">DBTest</a>, BloomFilter) {<br/></li>
<li>&nbsp; env_-&gt;count_random_reads_ = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; <a href="../include/leveldb/options.h.html#L31" title="include/leveldb/options.h:31">Options</a> options = <a href="#L238" title="db/db_test.cc:238">CurrentOptions</a>();<br/></li>
<li>&nbsp; options.env = env_;<br/></li>
<li>&nbsp; options.block_cache = <a href="../util/cache.cc.html#L321" title="util/cache.cc:321">NewLRUCache</a>(<span class="Constant">0</span>);&nbsp; <span class="Comment">// Prevent cache hits<br/></li>
<li></span>&nbsp; options.filter_policy = <a href="../util/bloom.cc.html#L91" title="util/bloom.cc:91">NewBloomFilterPolicy</a>(<span class="Constant">10</span>);<br/></li>
<li>&nbsp; <a href="corruption_test.cc.html#L60" title="db/corruption_test.cc:60">Reopen</a>(&amp;options);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// Populate multiple layers<br/></li>
<li></span>&nbsp; <span class="Type">const</span> <span class="Type">int</span> N = <span class="Constant">10000</span>;<br/></li>
<li>&nbsp; <span class="Statement">for</span> (<span class="Type">int</span> i = <span class="Constant">0</span>; i &lt; N; i++) {<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<a href="autocompact_test.cc.html#L36" title="db/autocompact_test.cc:36">Key</a>(i), <a href="autocompact_test.cc.html#L36" title="db/autocompact_test.cc:36">Key</a>(i)));<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <a href="#L424" title="db/db_test.cc:424">Compact</a>(<span class="Constant">&quot;a&quot;</span>, <span class="Constant">&quot;z&quot;</span>);<br/></li>
<li>&nbsp; <span class="Statement">for</span> (<span class="Type">int</span> i = <span class="Constant">0</span>; i &lt; N; i += <span class="Constant">100</span>) {<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<a href="autocompact_test.cc.html#L36" title="db/autocompact_test.cc:36">Key</a>(i), <a href="autocompact_test.cc.html#L36" title="db/autocompact_test.cc:36">Key</a>(i)));<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <a href="#L253" title="db/db_test.cc:253">dbfull</a>()-&gt;<a href="db_impl.cc.html#L590" title="db/db_impl.cc:590">TEST_CompactMemTable</a>();<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// Prevent auto compactions triggered by seeks<br/></li>
<li></span>&nbsp; env_-&gt;delay_data_sync_.<a href="../port/atomic_pointer.h.html#L121" title="port/atomic_pointer.h:121">Release_Store</a>(env_);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// <a href="../util/cache.cc.html#L58" title="util/cache.cc:58">Lookup</a> present keys.&nbsp; Should rarely read from small sstable.<br/></li>
<li></span>&nbsp; env_-&gt;random_read_counter_.<a href="../table/table_test.cc.html#L262" title="table/table_test.cc:262">Reset</a>();<br/></li>
<li>&nbsp; <span class="Statement">for</span> (<span class="Type">int</span> i = <span class="Constant">0</span>; i &lt; N; i++) {<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="autocompact_test.cc.html#L36" title="db/autocompact_test.cc:36">Key</a>(i), <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(<a href="autocompact_test.cc.html#L36" title="db/autocompact_test.cc:36">Key</a>(i)));<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Type">int</span> reads = env_-&gt;random_read_counter_.<a href="../table/table_test.cc.html#L120" title="table/table_test.cc:120">Read</a>();<br/></li>
<li>&nbsp; fprintf(<span class="Constant">stderr</span>, <span class="Constant">&quot;</span><span class="Special">%d</span><span class="Constant"> present =&gt; </span><span class="Special">%d</span><span class="Constant"> reads</span><span class="Special">\n</span><span class="Constant">&quot;</span>, N, reads);<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L109" title="util/testharness.h:109">ASSERT_GE</a>(reads, N);<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L111" title="util/testharness.h:111">ASSERT_LE</a>(reads, N + <span class="Constant">2</span>*N/<span class="Constant">100</span>);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// <a href="../util/cache.cc.html#L58" title="util/cache.cc:58">Lookup</a> present keys.&nbsp; Should rarely read from either sstable.<br/></li>
<li></span>&nbsp; env_-&gt;random_read_counter_.<a href="../table/table_test.cc.html#L262" title="table/table_test.cc:262">Reset</a>();<br/></li>
<li>&nbsp; <span class="Statement">for</span> (<span class="Type">int</span> i = <span class="Constant">0</span>; i &lt; N; i++) {<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;NOT_FOUND&quot;</span>, <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(<a href="autocompact_test.cc.html#L36" title="db/autocompact_test.cc:36">Key</a>(i) + <span class="Constant">&quot;.missing&quot;</span>));<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; reads = env_-&gt;random_read_counter_.<a href="../table/table_test.cc.html#L120" title="table/table_test.cc:120">Read</a>();<br/></li>
<li>&nbsp; fprintf(<span class="Constant">stderr</span>, <span class="Constant">&quot;</span><span class="Special">%d</span><span class="Constant"> missing =&gt; </span><span class="Special">%d</span><span class="Constant"> reads</span><span class="Special">\n</span><span class="Constant">&quot;</span>, N, reads);<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L111" title="util/testharness.h:111">ASSERT_LE</a>(reads, <span class="Constant">3</span>*N/<span class="Constant">100</span>);<br/></li>
<li><br/></li>
<li>&nbsp; env_-&gt;delay_data_sync_.<a href="../port/atomic_pointer.h.html#L121" title="port/atomic_pointer.h:121">Release_Store</a>(<span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; <a href="../table/table_test.cc.html#L96" title="table/table_test.cc:96">Close</a>();<br/></li>
<li>&nbsp; <span class="Statement">delete</span> options.block_cache;<br/></li>
<li>&nbsp; <span class="Statement">delete</span> options.filter_policy;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">// Multi-threaded test:<br/></li>
<li></span><span class="Type">namespace</span> {<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">const</span> <span class="Type">int</span> kNumThreads = <span class="Constant">4</span>;<br/></li>
<li><span class="Type">static</span> <span class="Type">const</span> <span class="Type">int</span> kTestSeconds = <span class="Constant">10</span>;<br/></li>
<li><span class="Type">static</span> <span class="Type">const</span> <span class="Type">int</span> kNumKeys = <span class="Constant">1000</span>;<br/></li>
<li><br/></li>
<li><a id="L1736">&#x200c;</a><span class="Type">struct</span> <span class="linkable">MTState</span> {<br/></li>
<li>&nbsp; <a href="#L209" title="db/db_test.cc:209">DBTest</a>* test;<br/></li>
<li>&nbsp; port::<a href="../port/port_example.h.html#L83" title="port/port_example.h:83">AtomicPointer</a> stop;<br/></li>
<li>&nbsp; port::<a href="../port/port_example.h.html#L83" title="port/port_example.h:83">AtomicPointer</a> counter[kNumThreads];<br/></li>
<li>&nbsp; port::<a href="../port/port_example.h.html#L83" title="port/port_example.h:83">AtomicPointer</a> thread_done[kNumThreads];<br/></li>
<li>};<br/></li>
<li><br/></li>
<li><a id="L1743">&#x200c;</a><span class="Type">struct</span> <span class="linkable">MTThread</span> {<br/></li>
<li>&nbsp; <a href="#L1736" title="db/db_test.cc:1736">MTState</a>* state;<br/></li>
<li>&nbsp; <span class="Type">int</span> id;<br/></li>
<li>};<br/></li>
<li><br/></li>
<li><a id="L1748">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">MTThreadBody</span>(<span class="Type">void</span>* arg) {<br/></li>
<li>&nbsp; <a href="#L1743" title="db/db_test.cc:1743">MTThread</a>* t = <span class="Statement">reinterpret_cast</span>&lt;<a href="#L1743" title="db/db_test.cc:1743">MTThread</a>*&gt;(arg);<br/></li>
<li>&nbsp; <span class="Type">int</span> id = t-&gt;id;<br/></li>
<li>&nbsp; <a href="../include/leveldb/db.h.html#L55" title="include/leveldb/db.h:55">DB</a>* <a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a> = t-&gt;state-&gt;test-&gt;db_;<br/></li>
<li>&nbsp; <span class="Type">uintptr_t</span> counter = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; fprintf(<span class="Constant">stderr</span>, <span class="Constant">&quot;... starting thread </span><span class="Special">%d\n</span><span class="Constant">&quot;</span>, id);<br/></li>
<li>&nbsp; <a href="../util/random.h.html#L19" title="util/random.h:19">Random</a> rnd(<span class="Constant">1000</span> + id);<br/></li>
<li>&nbsp; std::string <a href="../table/two_level_iterator.cc.html#L41" title="table/two_level_iterator.cc:41">value</a>;<br/></li>
<li>&nbsp; <span class="Type">char</span> valbuf[<span class="Constant">1500</span>];<br/></li>
<li>&nbsp; <span class="Statement">while</span> (t-&gt;state-&gt;stop.<a href="../port/atomic_pointer.h.html#L116" title="port/atomic_pointer.h:116">Acquire_Load</a>() == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; t-&gt;state-&gt;counter[id].<a href="../port/atomic_pointer.h.html#L121" title="port/atomic_pointer.h:121">Release_Store</a>(<span class="Statement">reinterpret_cast</span>&lt;<span class="Type">void</span>*&gt;(counter));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span> <a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a> = rnd.<a href="../util/random.h.html#L48" title="util/random.h:48">Uniform</a>(kNumKeys);<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span> keybuf[<span class="Constant">20</span>];<br/></li>
<li>&nbsp; &nbsp; snprintf(keybuf, <span class="Statement">sizeof</span>(keybuf), <span class="Constant">&quot;</span><span class="Special">%016d</span><span class="Constant">&quot;</span>, <a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rnd.<a href="../util/random.h.html#L52" title="util/random.h:52">OneIn</a>(<span class="Constant">2</span>)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Comment">// <a href="log_test.cc.html#L121" title="db/log_test.cc:121">Write</a> values of the form &lt;<a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>, my id, counter&gt;.<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Comment">// We add some padding for force compactions.<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; snprintf(valbuf, <span class="Statement">sizeof</span>(valbuf), <span class="Constant">&quot;</span><span class="Special">%d</span><span class="Constant">.</span><span class="Special">%d</span><span class="Constant">.</span><span class="Special">%-1000d</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>, id, <span class="Statement">static_cast</span>&lt;<span class="Type">int</span>&gt;(counter));<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(<a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a>-&gt;<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<a href="../include/leveldb/options.h.html#L169" title="include/leveldb/options.h:169">WriteOptions</a>(), <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>(keybuf), <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>(valbuf)));<br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Comment">// <a href="../table/table_test.cc.html#L120" title="table/table_test.cc:120">Read</a> a <a href="../table/two_level_iterator.cc.html#L41" title="table/two_level_iterator.cc:41">value</a> and verify that it matches the pattern written above.<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> s = <a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a>-&gt;<a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(<a href="../include/leveldb/options.h.html#L143" title="include/leveldb/options.h:143">ReadOptions</a>(), <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>(keybuf), &amp;<a href="../table/two_level_iterator.cc.html#L41" title="table/two_level_iterator.cc:41">value</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (s.<a href="../include/leveldb/status.h.html#L55" title="include/leveldb/status.h:55">IsNotFound</a>()) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">// <a href="autocompact_test.cc.html#L36" title="db/autocompact_test.cc:36">Key</a> has not yet been written<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">// <a href="corruption_test.cc.html#L88" title="db/corruption_test.cc:88">Check</a> that the writer thread counter is &gt;= the counter in the <a href="../table/two_level_iterator.cc.html#L41" title="table/two_level_iterator.cc:41">value</a><br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(s);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> k, w, c;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">3</span>, sscanf(<a href="../table/two_level_iterator.cc.html#L41" title="table/two_level_iterator.cc:41">value</a>.c_str(), <span class="Constant">&quot;</span><span class="Special">%d</span><span class="Constant">.</span><span class="Special">%d</span><span class="Constant">.</span><span class="Special">%d</span><span class="Constant">&quot;</span>, &amp;k, &amp;w, &amp;c)) &lt;&lt; <a href="../table/two_level_iterator.cc.html#L41" title="table/two_level_iterator.cc:41">value</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(k, <a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../util/testharness.h.html#L109" title="util/testharness.h:109">ASSERT_GE</a>(w, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../util/testharness.h.html#L112" title="util/testharness.h:112">ASSERT_LT</a>(w, kNumThreads);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../util/testharness.h.html#L111" title="util/testharness.h:111">ASSERT_LE</a>(<span class="Statement">static_cast</span>&lt;<span class="Type">uintptr_t</span>&gt;(c), <span class="Statement">reinterpret_cast</span>&lt;<span class="Type">uintptr_t</span>&gt;(<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; t-&gt;state-&gt;counter[w].<a href="../port/atomic_pointer.h.html#L116" title="port/atomic_pointer.h:116">Acquire_Load</a>()));<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; counter++;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; t-&gt;state-&gt;thread_done[id].<a href="../port/atomic_pointer.h.html#L121" title="port/atomic_pointer.h:121">Release_Store</a>(t);<br/></li>
<li>&nbsp; fprintf(<span class="Constant">stderr</span>, <span class="Constant">&quot;... stopping thread </span><span class="Special">%d</span><span class="Constant"> after </span><span class="Special">%d</span><span class="Constant"> ops</span><span class="Special">\n</span><span class="Constant">&quot;</span>, id, <span class="Type">int</span>(counter));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li>}&nbsp; <span class="Comment">// namespace<br/></li>
<li></span><br/></li>
<li><a id="L1795">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L209" title="db/db_test.cc:209">DBTest</a>, MultiThreaded) {<br/></li>
<li>&nbsp; <span class="Statement">do</span> {<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// Initialize state<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L1736" title="db/db_test.cc:1736">MTState</a> mt;<br/></li>
<li>&nbsp; &nbsp; mt.test = <span class="Statement">this</span>;<br/></li>
<li>&nbsp; &nbsp; mt.stop.<a href="../port/atomic_pointer.h.html#L121" title="port/atomic_pointer.h:121">Release_Store</a>(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (<span class="Type">int</span> id = <span class="Constant">0</span>; id &lt; kNumThreads; id++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; mt.counter[id].<a href="../port/atomic_pointer.h.html#L121" title="port/atomic_pointer.h:121">Release_Store</a>(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; mt.thread_done[id].<a href="../port/atomic_pointer.h.html#L121" title="port/atomic_pointer.h:121">Release_Store</a>(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// <a href="db_bench.cc.html#L176" title="db/db_bench.cc:176">Start</a> threads<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L1743" title="db/db_test.cc:1743">MTThread</a> thread[kNumThreads];<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (<span class="Type">int</span> id = <span class="Constant">0</span>; id &lt; kNumThreads; id++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; thread[id].state = &amp;mt;<br/></li>
<li>&nbsp; &nbsp; &nbsp; thread[id].id = id;<br/></li>
<li>&nbsp; &nbsp; &nbsp; env_-&gt;<a href="../include/leveldb/env.h.html#L312" title="include/leveldb/env.h:312">StartThread</a>(<a href="#L1748" title="db/db_test.cc:1748">MTThreadBody</a>, &amp;thread[id]);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// Let them run for a while<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L52" title="db/db_test.cc:52">DelayMilliseconds</a>(kTestSeconds * <span class="Constant">1000</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// <a href="db_bench.cc.html#L200" title="db/db_bench.cc:200">Stop</a> the threads and wait for them to finish<br/></li>
<li></span>&nbsp; &nbsp; mt.stop.<a href="../port/atomic_pointer.h.html#L121" title="port/atomic_pointer.h:121">Release_Store</a>(&amp;mt);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (<span class="Type">int</span> id = <span class="Constant">0</span>; id &lt; kNumThreads; id++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">while</span> (mt.thread_done[id].<a href="../port/atomic_pointer.h.html#L116" title="port/atomic_pointer.h:116">Acquire_Load</a>() == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L52" title="db/db_test.cc:52">DelayMilliseconds</a>(<span class="Constant">100</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; } <span class="Statement">while</span> (<a href="../table/table_builder.cc.html#L76" title="table/table_builder.cc:76">ChangeOptions</a>());<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Type">namespace</span> {<br/></li>
<li><a id="L1828">&#x200c;</a><span class="Type">typedef</span> std::map&lt;std::string, std::string&gt; <span class="linkable">KVMap</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Type">class</span> <a href="#L1838" title="db/db_test.cc:1838">ModelDB</a>: <span class="Statement">public</span> <a href="../include/leveldb/db.h.html#L55" title="include/leveldb/db.h:55">DB</a> {<br/></li>
<li><span class="cUserCont"> </span><span class="Statement">public</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; <span class="Type">class</span> ModelSnapshot : <span class="Statement">public</span> Snapshot {<br/></li>
<li><span class="cUserCont">&nbsp;&nbsp; </span><span class="Statement">public</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; &nbsp; <a href="../table/table_test.cc.html#L137" title="table/table_test.cc:137">KVMap</a> map_;<br/></li>
<li>&nbsp; };<br/></li>
<li><br/></li>
<li><a id="L1838">&#x200c;</a>&nbsp; <span class="Type">explicit</span> <span class="linkable">ModelDB</span>(<span class="Type">const</span> <a href="../include/leveldb/options.h.html#L31" title="include/leveldb/options.h:31">Options</a>&amp; options): options_(options) { }<br/></li>
<li><a id="L1839">&#x200c;</a>&nbsp; ~<a href="#L1838" title="db/db_test.cc:1838">ModelDB</a>() { }<br/></li>
<li><a id="L1840">&#x200c;</a>&nbsp; <span class="Type">virtual</span> <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> <span class="linkable">Put</span>(<span class="Type">const</span> <a href="../include/leveldb/options.h.html#L169" title="include/leveldb/options.h:169">WriteOptions</a>&amp; o, <span class="Type">const</span> <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>&amp; k, <span class="Type">const</span> <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>&amp; v) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../include/leveldb/db.h.html#L55" title="include/leveldb/db.h:55">DB</a>::<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(o, k, v);<br/></li>
<li>&nbsp; }<br/></li>
<li><a id="L1843">&#x200c;</a>&nbsp; <span class="Type">virtual</span> <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> <span class="linkable">Delete</span>(<span class="Type">const</span> <a href="../include/leveldb/options.h.html#L169" title="include/leveldb/options.h:169">WriteOptions</a>&amp; o, <span class="Type">const</span> <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>&amp; <a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../include/leveldb/db.h.html#L55" title="include/leveldb/db.h:55">DB</a>::<a href="write_batch.cc.html#L105" title="db/write_batch.cc:105">Delete</a>(o, <a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>);<br/></li>
<li>&nbsp; }<br/></li>
<li><a id="L1846">&#x200c;</a>&nbsp; <span class="Type">virtual</span> <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> <span class="linkable">Get</span>(<span class="Type">const</span> <a href="../include/leveldb/options.h.html#L143" title="include/leveldb/options.h:143">ReadOptions</a>&amp; options,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type">const</span> <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>&amp; <a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>, std::string* <a href="../table/two_level_iterator.cc.html#L41" title="table/two_level_iterator.cc:41">value</a>) {<br/></li>
<li>&nbsp; &nbsp; assert(<span class="Constant">false</span>);&nbsp; &nbsp; &nbsp; <span class="Comment">// Not implemented<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a>::<a href="../include/leveldb/status.h.html#L35" title="include/leveldb/status.h:35">NotFound</a>(<a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>);<br/></li>
<li>&nbsp; }<br/></li>
<li><a id="L1851">&#x200c;</a>&nbsp; <span class="Type">virtual</span> <a href="../table/iterator.cc.html#L9" title="table/iterator.cc:9">Iterator</a>* <span class="linkable">NewIterator</span>(<span class="Type">const</span> <a href="../include/leveldb/options.h.html#L143" title="include/leveldb/options.h:143">ReadOptions</a>&amp; options) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (options.snapshot == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../table/table_test.cc.html#L137" title="table/table_test.cc:137">KVMap</a>* saved = <span class="Statement">new</span> <a href="../table/table_test.cc.html#L137" title="table/table_test.cc:137">KVMap</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; *saved = map_;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Statement">new</span> <a href="#L1901" title="db/db_test.cc:1901">ModelIter</a>(saved, <span class="Constant">true</span>);<br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Type">const</span> <a href="../table/table_test.cc.html#L137" title="table/table_test.cc:137">KVMap</a>* snapshot_state =<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;(<span class="Statement">reinterpret_cast</span>&lt;<span class="Type">const</span> ModelSnapshot*&gt;(options.snapshot)-&gt;map_);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Statement">new</span> <a href="#L1901" title="db/db_test.cc:1901">ModelIter</a>(snapshot_state, <span class="Constant">false</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li><a id="L1862">&#x200c;</a>&nbsp; <span class="Type">virtual</span> <span class="Type">const</span> Snapshot* <span class="linkable">GetSnapshot</span>() {<br/></li>
<li>&nbsp; &nbsp; ModelSnapshot* snapshot = <span class="Statement">new</span> ModelSnapshot;<br/></li>
<li>&nbsp; &nbsp; snapshot-&gt;map_ = map_;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> snapshot;<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li><a id="L1868">&#x200c;</a>&nbsp; <span class="Type">virtual</span> <span class="Type">void</span> <span class="linkable">ReleaseSnapshot</span>(<span class="Type">const</span> Snapshot* snapshot) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">delete</span> <span class="Statement">reinterpret_cast</span>&lt;<span class="Type">const</span> ModelSnapshot*&gt;(snapshot);<br/></li>
<li>&nbsp; }<br/></li>
<li><a id="L1871">&#x200c;</a>&nbsp; <span class="Type">virtual</span> <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> <span class="linkable">Write</span>(<span class="Type">const</span> <a href="../include/leveldb/options.h.html#L169" title="include/leveldb/options.h:169">WriteOptions</a>&amp; options, <a href="write_batch.cc.html#L29" title="db/write_batch.cc:29">WriteBatch</a>* batch) {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">class</span> Handler : <span class="Statement">public</span> <a href="write_batch.cc.html#L29" title="db/write_batch.cc:29">WriteBatch</a>::Handler {<br/></li>
<li><span class="cUserCont">&nbsp; &nbsp;&nbsp; </span><span class="Statement">public</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <a href="../table/table_test.cc.html#L137" title="table/table_test.cc:137">KVMap</a>* map_;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Type">virtual</span> <span class="Type">void</span> <a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<span class="Type">const</span> <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>&amp; <a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>, <span class="Type">const</span> <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>&amp; <a href="../table/two_level_iterator.cc.html#L41" title="table/two_level_iterator.cc:41">value</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; (*map_)[<a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>.<a href="../table/table_test.cc.html#L587" title="table/table_test.cc:587">ToString</a>()] = <a href="../table/two_level_iterator.cc.html#L41" title="table/two_level_iterator.cc:41">value</a>.<a href="../table/table_test.cc.html#L587" title="table/table_test.cc:587">ToString</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Type">virtual</span> <span class="Type">void</span> <a href="write_batch.cc.html#L105" title="db/write_batch.cc:105">Delete</a>(<span class="Type">const</span> <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>&amp; <a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; map_-&gt;erase(<a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>.<a href="../table/table_test.cc.html#L587" title="table/table_test.cc:587">ToString</a>());<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; };<br/></li>
<li>&nbsp; &nbsp; Handler handler;<br/></li>
<li>&nbsp; &nbsp; handler.map_ = &amp;map_;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> batch-&gt;<a href="write_batch.cc.html#L42" title="db/write_batch.cc:42">Iterate</a>(&amp;handler);<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li><a id="L1887">&#x200c;</a>&nbsp; <span class="Type">virtual</span> <span class="Type">bool</span> <span class="linkable">GetProperty</span>(<span class="Type">const</span> <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>&amp; property, std::string* <a href="../table/two_level_iterator.cc.html#L41" title="table/two_level_iterator.cc:41">value</a>) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">false</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li><a id="L1890">&#x200c;</a>&nbsp; <span class="Type">virtual</span> <span class="Type">void</span> <span class="linkable">GetApproximateSizes</span>(<span class="Type">const</span> <a href="../include/leveldb/db.h.html#L33" title="include/leveldb/db.h:33">Range</a>* r, <span class="Type">int</span> n, <span class="Type"><a href="../port/win/stdint.h.html#L22" title="port/win/stdint.h:22">uint64_t</a></span>* sizes) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (<span class="Type">int</span> i = <span class="Constant">0</span>; i &lt; n; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; sizes[i] = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li><a id="L1895">&#x200c;</a>&nbsp; <span class="Type">virtual</span> <span class="Type">void</span> <span class="linkable">CompactRange</span>(<span class="Type">const</span> <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>* start, <span class="Type">const</span> <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>* end) {<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li><span class="cUserCont"> </span><span class="Statement">private</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; <span class="Type">class</span> <a href="#L1901" title="db/db_test.cc:1901">ModelIter</a>: <span class="Statement">public</span> <a href="../table/iterator.cc.html#L9" title="table/iterator.cc:9">Iterator</a> {<br/></li>
<li><span class="cUserCont">&nbsp;&nbsp; </span><span class="Statement">public</span><span class="cUserCont">:<br/></li>
<li><a id="L1901">&#x200c;</a></span>&nbsp; &nbsp; <span class="linkable">ModelIter</span>(<span class="Type">const</span> <a href="../table/table_test.cc.html#L137" title="table/table_test.cc:137">KVMap</a>* map, <span class="Type">bool</span> owned)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; : map_(map), owned_(owned), iter_(map_-&gt;end()) {<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><a id="L1904">&#x200c;</a>&nbsp; &nbsp; ~<a href="#L1901" title="db/db_test.cc:1901">ModelIter</a>() {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (owned_) <span class="Statement">delete</span> map_;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><a id="L1907">&#x200c;</a>&nbsp; &nbsp; <span class="Type">virtual</span> <span class="Type">bool</span> <span class="linkable">Valid</span>() <span class="Type">const</span> { <span class="Statement">return</span> iter_ != map_-&gt;end(); }<br/></li>
<li><a id="L1908">&#x200c;</a>&nbsp; &nbsp; <span class="Type">virtual</span> <span class="Type">void</span> <span class="linkable">SeekToFirst</span>() { iter_ = map_-&gt;begin(); }<br/></li>
<li><a id="L1909">&#x200c;</a>&nbsp; &nbsp; <span class="Type">virtual</span> <span class="Type">void</span> <span class="linkable">SeekToLast</span>() {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (map_-&gt;<a href="../table/block_builder.h.html#L38" title="table/block_builder.h:38">empty</a>()) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; iter_ = map_-&gt;end();<br/></li>
<li>&nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; iter_ = map_-&gt;find(map_-&gt;rbegin()-&gt;first);<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><a id="L1916">&#x200c;</a>&nbsp; &nbsp; <span class="Type">virtual</span> <span class="Type">void</span> <span class="linkable">Seek</span>(<span class="Type">const</span> <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>&amp; k) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; iter_ = map_-&gt;lower_bound(k.<a href="../table/table_test.cc.html#L587" title="table/table_test.cc:587">ToString</a>());<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><a id="L1919">&#x200c;</a>&nbsp; &nbsp; <span class="Type">virtual</span> <span class="Type">void</span> <span class="linkable">Next</span>() { ++iter_; }<br/></li>
<li><a id="L1920">&#x200c;</a>&nbsp; &nbsp; <span class="Type">virtual</span> <span class="Type">void</span> <span class="linkable">Prev</span>() { --iter_; }<br/></li>
<li><a id="L1921">&#x200c;</a>&nbsp; &nbsp; <span class="Type">virtual</span> <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a> <span class="linkable">key</span>() <span class="Type">const</span> { <span class="Statement">return</span> iter_-&gt;first; }<br/></li>
<li><a id="L1922">&#x200c;</a>&nbsp; &nbsp; <span class="Type">virtual</span> <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a> <span class="linkable">value</span>() <span class="Type">const</span> { <span class="Statement">return</span> iter_-&gt;second; }<br/></li>
<li><a id="L1923">&#x200c;</a>&nbsp; &nbsp; <span class="Type">virtual</span> <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> <span class="linkable">status</span>() <span class="Type">const</span> { <span class="Statement">return</span> <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a>::<a href="../include/leveldb/status.h.html#L32" title="include/leveldb/status.h:32">OK</a>(); }<br/></li>
<li><span class="cUserCont">&nbsp;&nbsp; </span><span class="Statement">private</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">const</span> <a href="../table/table_test.cc.html#L137" title="table/table_test.cc:137">KVMap</a>* <span class="Type">const</span> map_;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <span class="Type">bool</span> owned_;&nbsp; <span class="Comment">// Do we own map_<br/></li>
<li></span>&nbsp; &nbsp; <a href="../table/table_test.cc.html#L137" title="table/table_test.cc:137">KVMap</a>::const_iterator iter_;<br/></li>
<li>&nbsp; };<br/></li>
<li>&nbsp; <span class="Type">const</span> <a href="../include/leveldb/options.h.html#L31" title="include/leveldb/options.h:31">Options</a> options_;<br/></li>
<li>&nbsp; <a href="../table/table_test.cc.html#L137" title="table/table_test.cc:137">KVMap</a> map_;<br/></li>
<li>};<br/></li>
<li><br/></li>
<li><a id="L1933">&#x200c;</a><span class="Type">static</span> std::string <span class="linkable">RandomKey</span>(<a href="../util/random.h.html#L19" title="util/random.h:19">Random</a>* rnd) {<br/></li>
<li>&nbsp; <span class="Type">int</span> len = (rnd-&gt;<a href="../util/random.h.html#L52" title="util/random.h:52">OneIn</a>(<span class="Constant">3</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ? <span class="Constant">1</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">// Short sometimes to encourage collisions<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; : (rnd-&gt;<a href="../util/random.h.html#L52" title="util/random.h:52">OneIn</a>(<span class="Constant">100</span>) ? rnd-&gt;<a href="../util/random.h.html#L57" title="util/random.h:57">Skewed</a>(<span class="Constant">10</span>) : rnd-&gt;<a href="../util/random.h.html#L48" title="util/random.h:48">Uniform</a>(<span class="Constant">10</span>)));<br/></li>
<li>&nbsp; <span class="Statement">return</span> test::<a href="#L1933" title="db/db_test.cc:1933">RandomKey</a>(rnd, len);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1940">&#x200c;</a><span class="Type">static</span> <span class="Type">bool</span> <span class="linkable">CompareIterators</span>(<span class="Type">int</span> step,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../include/leveldb/db.h.html#L55" title="include/leveldb/db.h:55">DB</a>* model,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../include/leveldb/db.h.html#L55" title="include/leveldb/db.h:55">DB</a>* <a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type">const</span> Snapshot* model_snap,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type">const</span> Snapshot* db_snap) {<br/></li>
<li>&nbsp; <a href="../include/leveldb/options.h.html#L143" title="include/leveldb/options.h:143">ReadOptions</a> options;<br/></li>
<li>&nbsp; options.snapshot = model_snap;<br/></li>
<li>&nbsp; <a href="../table/iterator.cc.html#L9" title="table/iterator.cc:9">Iterator</a>* miter = model-&gt;<a href="../table/table_test.cc.html#L209" title="table/table_test.cc:209">NewIterator</a>(options);<br/></li>
<li>&nbsp; options.snapshot = db_snap;<br/></li>
<li>&nbsp; <a href="../table/iterator.cc.html#L9" title="table/iterator.cc:9">Iterator</a>* dbiter = <a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a>-&gt;<a href="../table/table_test.cc.html#L209" title="table/table_test.cc:209">NewIterator</a>(options);<br/></li>
<li>&nbsp; <span class="Type">bool</span> <a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a> = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; <span class="Type">int</span> count = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; <span class="Statement">for</span> (miter-&gt;<a href="../table/two_level_iterator.cc.html#L98" title="table/two_level_iterator.cc:98">SeekToFirst</a>(), dbiter-&gt;<a href="../table/two_level_iterator.cc.html#L98" title="table/two_level_iterator.cc:98">SeekToFirst</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp;&nbsp; <a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a> &amp;&amp; miter-&gt;<a href="../table/two_level_iterator.cc.html#L34" title="table/two_level_iterator.cc:34">Valid</a>() &amp;&amp; dbiter-&gt;<a href="../table/two_level_iterator.cc.html#L34" title="table/two_level_iterator.cc:34">Valid</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp;&nbsp; miter-&gt;<a href="../table/two_level_iterator.cc.html#L112" title="table/two_level_iterator.cc:112">Next</a>(), dbiter-&gt;<a href="../table/two_level_iterator.cc.html#L112" title="table/two_level_iterator.cc:112">Next</a>()) {<br/></li>
<li>&nbsp; &nbsp; count++;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (miter-&gt;<a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>().<a href="../include/leveldb/slice.h.html#L96" title="include/leveldb/slice.h:96">compare</a>(dbiter-&gt;<a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>()) != <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; fprintf(<span class="Constant">stderr</span>, <span class="Constant">&quot;step </span><span class="Special">%d</span><span class="Constant">: <a href="autocompact_test.cc.html#L36" title="db/autocompact_test.cc:36">Key</a> mismatch: '</span><span class="Special">%s</span><span class="Constant">' vs. '</span><span class="Special">%s</span><span class="Constant">'</span><span class="Special">\n</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; step,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../util/logging.cc.html#L42" title="util/logging.cc:42">EscapeString</a>(miter-&gt;<a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>()).c_str(),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../util/logging.cc.html#L42" title="util/logging.cc:42">EscapeString</a>(dbiter-&gt;<a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>()).c_str());<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a> = <span class="Constant">false</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (miter-&gt;<a href="../table/two_level_iterator.cc.html#L41" title="table/two_level_iterator.cc:41">value</a>().<a href="../include/leveldb/slice.h.html#L96" title="include/leveldb/slice.h:96">compare</a>(dbiter-&gt;<a href="../table/two_level_iterator.cc.html#L41" title="table/two_level_iterator.cc:41">value</a>()) != <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; fprintf(<span class="Constant">stderr</span>, <span class="Constant">&quot;step </span><span class="Special">%d</span><span class="Constant">: <a href="corruption_test.cc.html#L196" title="db/corruption_test.cc:196">Value</a> mismatch for <a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a> '</span><span class="Special">%s</span><span class="Constant">': '</span><span class="Special">%s</span><span class="Constant">' vs. '</span><span class="Special">%s</span><span class="Constant">'</span><span class="Special">\n</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; step,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../util/logging.cc.html#L42" title="util/logging.cc:42">EscapeString</a>(miter-&gt;<a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>()).c_str(),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../util/logging.cc.html#L42" title="util/logging.cc:42">EscapeString</a>(miter-&gt;<a href="../table/two_level_iterator.cc.html#L41" title="table/two_level_iterator.cc:41">value</a>()).c_str(),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../util/logging.cc.html#L42" title="util/logging.cc:42">EscapeString</a>(miter-&gt;<a href="../table/two_level_iterator.cc.html#L41" title="table/two_level_iterator.cc:41">value</a>()).c_str());<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a> = <span class="Constant">false</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (miter-&gt;<a href="../table/two_level_iterator.cc.html#L34" title="table/two_level_iterator.cc:34">Valid</a>() != dbiter-&gt;<a href="../table/two_level_iterator.cc.html#L34" title="table/two_level_iterator.cc:34">Valid</a>()) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; fprintf(<span class="Constant">stderr</span>, <span class="Constant">&quot;step </span><span class="Special">%d</span><span class="Constant">: Mismatch at end of iterators: </span><span class="Special">%d</span><span class="Constant"> vs. </span><span class="Special">%d\n</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; step, miter-&gt;<a href="../table/two_level_iterator.cc.html#L34" title="table/two_level_iterator.cc:34">Valid</a>(), dbiter-&gt;<a href="../table/two_level_iterator.cc.html#L34" title="table/two_level_iterator.cc:34">Valid</a>());<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a> = <span class="Constant">false</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; fprintf(<span class="Constant">stderr</span>, <span class="Constant">&quot;</span><span class="Special">%d</span><span class="Constant"> entries compared: <a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>=</span><span class="Special">%d\n</span><span class="Constant">&quot;</span>, count, <a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>);<br/></li>
<li>&nbsp; <span class="Statement">delete</span> miter;<br/></li>
<li>&nbsp; <span class="Statement">delete</span> dbiter;<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1988">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L209" title="db/db_test.cc:209">DBTest</a>, Randomized) {<br/></li>
<li>&nbsp; <a href="../util/random.h.html#L19" title="util/random.h:19">Random</a> rnd(test::<a href="../util/testharness.cc.html#L67" title="util/testharness.cc:67">RandomSeed</a>());<br/></li>
<li>&nbsp; <span class="Statement">do</span> {<br/></li>
<li>&nbsp; &nbsp; <a href="#L1838" title="db/db_test.cc:1838">ModelDB</a> model(<a href="#L238" title="db/db_test.cc:238">CurrentOptions</a>());<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <span class="Type">int</span> N = <span class="Constant">10000</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> Snapshot* model_snap = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> Snapshot* db_snap = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; std::string k, v;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (<span class="Type">int</span> step = <span class="Constant">0</span>; step &lt; N; step++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (step % <span class="Constant">100</span> == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; fprintf(<span class="Constant">stderr</span>, <span class="Constant">&quot;Step </span><span class="Special">%d</span><span class="Constant"> of </span><span class="Special">%d\n</span><span class="Constant">&quot;</span>, step, N);<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Comment">// </span><span class="Todo">TODO</span><span class="Comment">(sanjay): <a href="../table/table_test.cc.html#L477" title="table/table_test.cc:477">Test</a> <a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>() works<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Type">int</span> p = rnd.<a href="../util/random.h.html#L48" title="util/random.h:48">Uniform</a>(<span class="Constant">100</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (p &lt; <span class="Constant">45</span>) {&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">// <a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a><br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; k = <a href="#L1933" title="db/db_test.cc:1933">RandomKey</a>(&amp;rnd);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; v = <a href="#L22" title="db/db_test.cc:22">RandomString</a>(&amp;rnd,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; rnd.<a href="../util/random.h.html#L52" title="util/random.h:52">OneIn</a>(<span class="Constant">20</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ? <span class="Constant">100</span> + rnd.<a href="../util/random.h.html#L48" title="util/random.h:48">Uniform</a>(<span class="Constant">100</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; : rnd.<a href="../util/random.h.html#L48" title="util/random.h:48">Uniform</a>(<span class="Constant">8</span>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(model.<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<a href="../include/leveldb/options.h.html#L169" title="include/leveldb/options.h:169">WriteOptions</a>(), k, v));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(db_-&gt;<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<a href="../include/leveldb/options.h.html#L169" title="include/leveldb/options.h:169">WriteOptions</a>(), k, v));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (p &lt; <span class="Constant">90</span>) {&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">// <a href="write_batch.cc.html#L105" title="db/write_batch.cc:105">Delete</a><br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; k = <a href="#L1933" title="db/db_test.cc:1933">RandomKey</a>(&amp;rnd);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(model.<a href="write_batch.cc.html#L105" title="db/write_batch.cc:105">Delete</a>(<a href="../include/leveldb/options.h.html#L169" title="include/leveldb/options.h:169">WriteOptions</a>(), k));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(db_-&gt;<a href="write_batch.cc.html#L105" title="db/write_batch.cc:105">Delete</a>(<a href="../include/leveldb/options.h.html#L169" title="include/leveldb/options.h:169">WriteOptions</a>(), k));<br/></li>
<li><br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">// Multi-element batch<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="write_batch.cc.html#L29" title="db/write_batch.cc:29">WriteBatch</a> b;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">const</span> <span class="Type">int</span> num = rnd.<a href="../util/random.h.html#L48" title="util/random.h:48">Uniform</a>(<span class="Constant">8</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (<span class="Type">int</span> i = <span class="Constant">0</span>; i &lt; num; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (i == <span class="Constant">0</span> || !rnd.<a href="../util/random.h.html#L52" title="util/random.h:52">OneIn</a>(<span class="Constant">10</span>)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; k = <a href="#L1933" title="db/db_test.cc:1933">RandomKey</a>(&amp;rnd);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">// Periodically re-use the same <a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a> from the previous <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>, so<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">// we have multiple entries in the write batch for the same <a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a><br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rnd.<a href="../util/random.h.html#L52" title="util/random.h:52">OneIn</a>(<span class="Constant">2</span>)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; v = <a href="#L22" title="db/db_test.cc:22">RandomString</a>(&amp;rnd, rnd.<a href="../util/random.h.html#L48" title="util/random.h:48">Uniform</a>(<span class="Constant">10</span>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b.<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(k, v);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b.<a href="write_batch.cc.html#L105" title="db/write_batch.cc:105">Delete</a>(k);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(model.<a href="log_test.cc.html#L121" title="db/log_test.cc:121">Write</a>(<a href="../include/leveldb/options.h.html#L169" title="include/leveldb/options.h:169">WriteOptions</a>(), &amp;b));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(db_-&gt;<a href="log_test.cc.html#L121" title="db/log_test.cc:121">Write</a>(<a href="../include/leveldb/options.h.html#L169" title="include/leveldb/options.h:169">WriteOptions</a>(), &amp;b));<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((step % <span class="Constant">100</span>) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(<a href="#L1940" title="db/db_test.cc:1940">CompareIterators</a>(step, &amp;model, db_, <span class="Constant">NULL</span>, <span class="Constant">NULL</span>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(<a href="#L1940" title="db/db_test.cc:1940">CompareIterators</a>(step, &amp;model, db_, model_snap, db_snap));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">// Save a snapshot from each <a href="../include/leveldb/db.h.html#L55" title="include/leveldb/db.h:55">DB</a> this time that we'll use next<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">// time we <a href="../include/leveldb/slice.h.html#L96" title="include/leveldb/slice.h:96">compare</a> things, to make sure the <a href="version_set.h.html#L185" title="db/version_set.h:185">current</a> state is<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">// preserved with the snapshot<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (model_snap != <span class="Constant">NULL</span>) model.<a href="db_impl.cc.html#L1148" title="db/db_impl.cc:1148">ReleaseSnapshot</a>(model_snap);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (db_snap != <span class="Constant">NULL</span>) db_-&gt;<a href="db_impl.cc.html#L1148" title="db/db_impl.cc:1148">ReleaseSnapshot</a>(db_snap);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="corruption_test.cc.html#L60" title="db/corruption_test.cc:60">Reopen</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(<a href="#L1940" title="db/db_test.cc:1940">CompareIterators</a>(step, &amp;model, db_, <span class="Constant">NULL</span>, <span class="Constant">NULL</span>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; model_snap = model.<a href="db_impl.cc.html#L1143" title="db/db_impl.cc:1143">GetSnapshot</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; db_snap = db_-&gt;<a href="db_impl.cc.html#L1143" title="db/db_impl.cc:1143">GetSnapshot</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (model_snap != <span class="Constant">NULL</span>) model.<a href="db_impl.cc.html#L1148" title="db/db_impl.cc:1148">ReleaseSnapshot</a>(model_snap);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (db_snap != <span class="Constant">NULL</span>) db_-&gt;<a href="db_impl.cc.html#L1148" title="db/db_impl.cc:1148">ReleaseSnapshot</a>(db_snap);<br/></li>
<li>&nbsp; } <span class="Statement">while</span> (<a href="../table/table_builder.cc.html#L76" title="table/table_builder.cc:76">ChangeOptions</a>());<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L2059">&#x200c;</a>std::string <span class="linkable">MakeKey</span>(<span class="Type">unsigned</span> <span class="Type">int</span> num) {<br/></li>
<li>&nbsp; <span class="Type">char</span> buf[<span class="Constant">30</span>];<br/></li>
<li>&nbsp; snprintf(buf, <span class="Statement">sizeof</span>(buf), <span class="Constant">&quot;</span><span class="Special">%016u</span><span class="Constant">&quot;</span>, num);<br/></li>
<li>&nbsp; <span class="Statement">return</span> std::string(buf);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L2065">&#x200c;</a><span class="Type">void</span> <span class="linkable">BM_LogAndApply</span>(<span class="Type">int</span> iters, <span class="Type">int</span> num_base_files) {<br/></li>
<li>&nbsp; std::string <a href="c_test.c.html#L15" title="db/c_test.c:15">dbname</a> = test::<a href="../util/testharness.cc.html#L60" title="util/testharness.cc:60">TmpDir</a>() + <span class="Constant">&quot;/leveldb_test_benchmark&quot;</span>;<br/></li>
<li>&nbsp; <a href="db_impl.cc.html#L1482" title="db/db_impl.cc:1482">DestroyDB</a>(<a href="c_test.c.html#L15" title="db/c_test.c:15">dbname</a>, <a href="../include/leveldb/options.h.html#L31" title="include/leveldb/options.h:31">Options</a>());<br/></li>
<li><br/></li>
<li>&nbsp; <a href="../include/leveldb/db.h.html#L55" title="include/leveldb/db.h:55">DB</a>* <a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a> = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; <a href="../include/leveldb/options.h.html#L31" title="include/leveldb/options.h:31">Options</a> opts;<br/></li>
<li>&nbsp; opts.create_if_missing = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> s = <a href="../include/leveldb/db.h.html#L55" title="include/leveldb/db.h:55">DB</a>::<a href="../table/table.cc.html#L38" title="table/table.cc:38">Open</a>(opts, <a href="c_test.c.html#L15" title="db/c_test.c:15">dbname</a>, &amp;<a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a>);<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(s);<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(<a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a> != <span class="Constant">NULL</span>);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">delete</span> <a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a>;<br/></li>
<li>&nbsp; <a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a> = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; <a href="../include/leveldb/env.h.html#L33" title="include/leveldb/env.h:33">Env</a>* env = <a href="../include/leveldb/env.h.html#L33" title="include/leveldb/env.h:33">Env</a>::<a href="../util/env_posix.cc.html#L600" title="util/env_posix.cc:600">Default</a>();<br/></li>
<li><br/></li>
<li>&nbsp; port::<a href="../port/port_posix.cc.html#L22" title="port/port_posix.cc:22">Mutex</a> mu;<br/></li>
<li>&nbsp; MutexLock l(&amp;mu);<br/></li>
<li><br/></li>
<li>&nbsp; <a href="dbformat.h.html#L117" title="db/dbformat.h:117">InternalKeyComparator</a> cmp(<a href="../util/comparator.cc.html#L76" title="util/comparator.cc:76">BytewiseComparator</a>());<br/></li>
<li>&nbsp; <a href="../include/leveldb/options.h.html#L31" title="include/leveldb/options.h:31">Options</a> options;<br/></li>
<li>&nbsp; <a href="version_set.cc.html#L766" title="db/version_set.cc:766">VersionSet</a> vset(<a href="c_test.c.html#L15" title="db/c_test.c:15">dbname</a>, &amp;options, <span class="Constant">NULL</span>, &amp;cmp);<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(vset.<a href="version_set.cc.html#L896" title="db/version_set.cc:896">Recover</a>());<br/></li>
<li>&nbsp; <a href="version_edit.h.html#L30" title="db/version_edit.h:30">VersionEdit</a> vbase;<br/></li>
<li>&nbsp; <span class="Type"><a href="../port/win/stdint.h.html#L22" title="port/win/stdint.h:22">uint64_t</a></span> fnum = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; <span class="Statement">for</span> (<span class="Type">int</span> i = <span class="Constant">0</span>; i &lt; num_base_files; i++) {<br/></li>
<li>&nbsp; &nbsp; <a href="dbformat.h.html#L148" title="db/dbformat.h:148">InternalKey</a> start(<a href="skiplist_test.cc.html#L162" title="db/skiplist_test.cc:162">MakeKey</a>(<span class="Constant">2</span>*fnum), <span class="Constant">1</span>, kTypeValue);<br/></li>
<li>&nbsp; &nbsp; <a href="dbformat.h.html#L148" title="db/dbformat.h:148">InternalKey</a> limit(<a href="skiplist_test.cc.html#L162" title="db/skiplist_test.cc:162">MakeKey</a>(<span class="Constant">2</span>*fnum+<span class="Constant">1</span>), <span class="Constant">1</span>, kTypeDeletion);<br/></li>
<li>&nbsp; &nbsp; vbase.<a href="version_edit.h.html#L62" title="db/version_edit.h:62">AddFile</a>(<span class="Constant">2</span>, fnum++, <span class="Constant">1</span> <span class="Comment">/* file <a href="../table/format.h.html#L31" title="table/format.h:31">size</a> */</span>, start, limit);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L106" title="util/testharness.h:106">ASSERT_OK</a>(vset.<a href="version_set.cc.html#L811" title="db/version_set.cc:811">LogAndApply</a>(&amp;vbase, &amp;mu));<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Type"><a href="../port/win/stdint.h.html#L22" title="port/win/stdint.h:22">uint64_t</a></span> start_micros = env-&gt;<a href="../include/leveldb/env.h.html#L321" title="include/leveldb/env.h:321">NowMicros</a>();<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">for</span> (<span class="Type">int</span> i = <span class="Constant">0</span>; i &lt; iters; i++) {<br/></li>
<li>&nbsp; &nbsp; <a href="version_edit.h.html#L30" title="db/version_edit.h:30">VersionEdit</a> vedit;<br/></li>
<li>&nbsp; &nbsp; vedit.<a href="../include/leveldb/env.h.html#L296" title="include/leveldb/env.h:296">DeleteFile</a>(<span class="Constant">2</span>, fnum);<br/></li>
<li>&nbsp; &nbsp; <a href="dbformat.h.html#L148" title="db/dbformat.h:148">InternalKey</a> start(<a href="skiplist_test.cc.html#L162" title="db/skiplist_test.cc:162">MakeKey</a>(<span class="Constant">2</span>*fnum), <span class="Constant">1</span>, kTypeValue);<br/></li>
<li>&nbsp; &nbsp; <a href="dbformat.h.html#L148" title="db/dbformat.h:148">InternalKey</a> limit(<a href="skiplist_test.cc.html#L162" title="db/skiplist_test.cc:162">MakeKey</a>(<span class="Constant">2</span>*fnum+<span class="Constant">1</span>), <span class="Constant">1</span>, kTypeDeletion);<br/></li>
<li>&nbsp; &nbsp; vedit.<a href="version_edit.h.html#L62" title="db/version_edit.h:62">AddFile</a>(<span class="Constant">2</span>, fnum++, <span class="Constant">1</span> <span class="Comment">/* file <a href="../table/format.h.html#L31" title="table/format.h:31">size</a> */</span>, start, limit);<br/></li>
<li>&nbsp; &nbsp; vset.<a href="version_set.cc.html#L811" title="db/version_set.cc:811">LogAndApply</a>(&amp;vedit, &amp;mu);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Type"><a href="../port/win/stdint.h.html#L22" title="port/win/stdint.h:22">uint64_t</a></span> stop_micros = env-&gt;<a href="../include/leveldb/env.h.html#L321" title="include/leveldb/env.h:321">NowMicros</a>();<br/></li>
<li>&nbsp; <span class="Type">unsigned</span> <span class="Type">int</span> us = stop_micros - start_micros;<br/></li>
<li>&nbsp; <span class="Type">char</span> buf[<span class="Constant">16</span>];<br/></li>
<li>&nbsp; snprintf(buf, <span class="Statement">sizeof</span>(buf), <span class="Constant">&quot;</span><span class="Special">%d</span><span class="Constant">&quot;</span>, num_base_files);<br/></li>
<li>&nbsp; fprintf(<span class="Constant">stderr</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;<a href="#L2065" title="db/db_test.cc:2065">BM_LogAndApply</a>/</span><span class="Special">%-6s</span><span class="Constant">&nbsp;&nbsp; </span><span class="Special">%8d</span><span class="Constant"> iters : </span><span class="Special">%9u</span><span class="Constant"> us (</span><span class="Special">%7.0f</span><span class="Constant"> us / <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>)</span><span class="Special">\n</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; buf, iters, us, ((<span class="Type">float</span>)us) / iters);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li>}&nbsp; <span class="Comment">// namespace leveldb<br/></li>
<li></span><br/></li>
<li><a id="L2118">&#x200c;</a><span class="Type">int</span> <span class="linkable">main</span>(<span class="Type">int</span> argc, <span class="Type">char</span>** argv) {<br/></li>
<li>&nbsp; <span class="Statement">if</span> (argc &gt; <span class="Constant">1</span> &amp;&amp; std::string(argv[<span class="Constant">1</span>]) == <span class="Constant">&quot;--benchmark&quot;</span>) {<br/></li>
<li>&nbsp; &nbsp; leveldb::<a href="#L2065" title="db/db_test.cc:2065">BM_LogAndApply</a>(<span class="Constant">1000</span>, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; leveldb::<a href="#L2065" title="db/db_test.cc:2065">BM_LogAndApply</a>(<span class="Constant">1000</span>, <span class="Constant">100</span>);<br/></li>
<li>&nbsp; &nbsp; leveldb::<a href="#L2065" title="db/db_test.cc:2065">BM_LogAndApply</a>(<span class="Constant">1000</span>, <span class="Constant">10000</span>);<br/></li>
<li>&nbsp; &nbsp; leveldb::<a href="#L2065" title="db/db_test.cc:2065">BM_LogAndApply</a>(<span class="Constant">100</span>, <span class="Constant">100000</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">return</span> leveldb::test::<a href="../util/testharness.cc.html#L36" title="util/testharness.cc:36">RunAllTests</a>();<br/></li>
<li>}<br/></li>
</ol></code>
 </body>
</html>
