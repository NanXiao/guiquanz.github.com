<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>db/db_impl.cc - leveldb-1.18</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

code {
    font-family: consolas, monospace;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
  <h3>db/db_impl.cc - leveldb-1.18</h3>
   <a href="../index.html"> Table of Contents </a>
 <h4>Data types defined</h4>
 <ul>
<li><a href="#L51">CompactionState</a></li>
<li><a href="#L1017">IterState</a></li>
<li><a href="#L61">Output</a></li>
<li><a href="#L41">Writer</a></li>
</ul>
 <h4>Functions defined</h4>
 <ul>
<li><a href="#L632">BGWork</a></li>
<li><a href="#L636">BackgroundCall</a></li>
<li><a href="#L655">BackgroundCompaction</a></li>
<li><a href="#L1237">BuildBatchGroup</a></li>
<li><a href="#L740">CleanupCompaction</a></li>
<li><a href="#L1024">CleanupIteratorState</a></li>
<li><a href="#L86">ClipToRange</a></li>
<li><a href="#L503">CompactMemTable</a></li>
<li><a href="#L536">CompactRange</a></li>
<li><a href="#L76">CompactionState</a></li>
<li><a href="#L116">DBImpl</a></li>
<li><a href="#L1158">Delete</a></li>
<li><a href="#L1437">Delete</a></li>
<li><a href="#L218">DeleteObsoleteFiles</a></li>
<li><a href="#L1482">DestroyDB</a></li>
<li><a href="#L855">DoCompactionWork</a></li>
<li><a href="#L782">FinishCompactionOutputFile</a></li>
<li><a href="#L1077">Get</a></li>
<li><a href="#L1403">GetApproximateSizes</a></li>
<li><a href="#L1349">GetProperty</a></li>
<li><a href="#L1143">GetSnapshot</a></li>
<li><a href="#L834">InstallCompactionResults</a></li>
<li><a href="#L1286">MakeRoomForWrite</a></li>
<li><a href="#L209">MaybeIgnoreError</a></li>
<li><a href="#L614">MaybeScheduleCompaction</a></li>
<li><a href="#L177">NewDB</a></li>
<li><a href="#L1035">NewInternalIterator</a></li>
<li><a href="#L1124">NewIterator</a></li>
<li><a href="#L1445">Open</a></li>
<li><a href="#L757">OpenCompactionOutputFile</a></li>
<li><a href="#L1154">Put</a></li>
<li><a href="#L1431">Put</a></li>
<li><a href="#L606">RecordBackgroundError</a></li>
<li><a href="#L1136">RecordReadSample</a></li>
<li><a href="#L274">Recover</a></li>
<li><a href="#L362">RecoverLogFile</a></li>
<li><a href="#L1148">ReleaseSnapshot</a></li>
<li><a href="#L90">SanitizeOptions</a></li>
<li><a href="#L590">TEST_CompactMemTable</a></li>
<li><a href="#L553">TEST_CompactRange</a></li>
<li><a href="#L1072">TEST_MaxNextLevelOverlappingBytes</a></li>
<li><a href="#L1066">TEST_NewInternalIterator</a></li>
<li><a href="#L1162">Write</a></li>
<li><a href="#L457">WriteLevel0Table</a></li>
<li><a href="#L48">Writer</a></li>
<li><a href="#L74">current_output</a></li>
<li><a href="#L1443">~DB</a></li>
<li><a href="#L148">~DBImpl</a></li>
<li><a href="#L1479">~Snapshot</a></li>
</ul>
 <h4>Source code</h4>

  <code><ol><li><span class="Comment">// Copyright (c) 2011 The LevelDB Authors. All rights reserved.<br/></li>
<li></span><span class="Comment">// Use of this source <a href="../include/leveldb/status.h.html#L84" title="include/leveldb/status.h:84">code</a> is governed by a BSD-style license that can be<br/></li>
<li></span><span class="Comment">// found in the LICENSE file. See the AUTHORS file for names of contributors.<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;<a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a>/db_impl.h&quot;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;algorithm&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;set&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;string&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;stdint.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;stdio.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;vector&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;<a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a>/builder.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;<a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a>/db_iter.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;<a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a>/dbformat.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;<a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a>/filename.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;<a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a>/log_reader.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;<a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a>/log_writer.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;<a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a>/memtable.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;<a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a>/table_cache.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;<a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a>/version_set.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;<a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a>/write_batch_internal.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;leveldb/<a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a>.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;leveldb/env.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;leveldb/<a href="../table/two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a>.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;leveldb/table.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;leveldb/table_builder.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;port/port.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;table/block.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;table/merger.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;table/two_level_iterator.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;util/coding.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;util/logging.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;util/mutexlock.h&quot;<br/></li>
<li></span><br/></li>
<li><span class="Type">namespace</span> leveldb {<br/></li>
<li><br/></li>
<li><span class="Type">const</span> <span class="Type">int</span> kNumNonTableCacheFiles = <span class="Constant">10</span>;<br/></li>
<li><br/></li>
<li><span class="Comment">// Information kept for every waiting writer<br/></li>
<li><a id="L41">&#x200c;</a></span><span class="Type">struct</span> <a href="#L116" title="db/db_impl.cc:116">DBImpl</a>::<span class="linkable">Writer</span> {<br/></li>
<li>&nbsp; <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> <a href="../table/two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a>;<br/></li>
<li>&nbsp; <a href="write_batch.cc.html#L29" title="db/write_batch.cc:29">WriteBatch</a>* batch;<br/></li>
<li>&nbsp; <span class="Type">bool</span> sync;<br/></li>
<li>&nbsp; <span class="Type">bool</span> done;<br/></li>
<li>&nbsp; port::<a href="../port/port_posix.cc.html#L30" title="port/port_posix.cc:30">CondVar</a> cv;<br/></li>
<li><br/></li>
<li><a id="L48">&#x200c;</a>&nbsp; <span class="Type">explicit</span> <span class="linkable">Writer</span>(port::<a href="../port/port_posix.cc.html#L22" title="port/port_posix.cc:22">Mutex</a>* mu) : cv(mu) { }<br/></li>
<li>};<br/></li>
<li><br/></li>
<li><a id="L51">&#x200c;</a><span class="Type">struct</span> <a href="#L116" title="db/db_impl.cc:116">DBImpl</a>::<span class="linkable">CompactionState</span> {<br/></li>
<li>&nbsp; <a href="version_set.cc.html#L1399" title="db/version_set.cc:1399">Compaction</a>* <span class="Type">const</span> compaction;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// <a href="write_batch.cc.html#L90" title="db/write_batch.cc:90">Sequence</a> numbers &lt; smallest_snapshot are not significant since we<br/></li>
<li></span>&nbsp; <span class="Comment">// will never have to service a snapshot below smallest_snapshot.<br/></li>
<li></span>&nbsp; <span class="Comment">// Therefore if we have seen a sequence number S &lt;= smallest_snapshot,<br/></li>
<li></span>&nbsp; <span class="Comment">// we can drop all entries for the same <a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a> with sequence numbers &lt; S.<br/></li>
<li></span>&nbsp; <a href="dbformat.h.html#L63" title="db/dbformat.h:63">SequenceNumber</a> smallest_snapshot;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// Files produced by compaction<br/></li>
<li><a id="L61">&#x200c;</a></span>&nbsp; <span class="Type">struct</span> <span class="linkable">Output</span> {<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../port/win/stdint.h.html#L22" title="port/win/stdint.h:22">uint64_t</a></span> number;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../port/win/stdint.h.html#L22" title="port/win/stdint.h:22">uint64_t</a></span> file_size;<br/></li>
<li>&nbsp; &nbsp; <a href="dbformat.h.html#L148" title="db/dbformat.h:148">InternalKey</a> smallest, largest;<br/></li>
<li>&nbsp; };<br/></li>
<li>&nbsp; std::vector&lt;<a href="#L61" title="db/db_impl.cc:61">Output</a>&gt; outputs;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// <a href="skiplist_test.cc.html#L188" title="db/skiplist_test.cc:188">State</a> kept for output being generated<br/></li>
<li></span>&nbsp; <a href="../include/leveldb/env.h.html#L214" title="include/leveldb/env.h:214">WritableFile</a>* outfile;<br/></li>
<li>&nbsp; <a href="../table/table_builder.cc.html#L63" title="table/table_builder.cc:63">TableBuilder</a>* builder;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Type"><a href="../port/win/stdint.h.html#L22" title="port/win/stdint.h:22">uint64_t</a></span> total_bytes;<br/></li>
<li><br/></li>
<li><a id="L74">&#x200c;</a>&nbsp; <a href="#L61" title="db/db_impl.cc:61">Output</a>* <span class="linkable">current_output</span>() { <span class="Statement">return</span> &amp;outputs[outputs.<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>()-<span class="Constant">1</span>]; }<br/></li>
<li><br/></li>
<li><a id="L76">&#x200c;</a>&nbsp; <span class="Type">explicit</span> <span class="linkable">CompactionState</span>(<a href="version_set.cc.html#L1399" title="db/version_set.cc:1399">Compaction</a>* c)<br/></li>
<li>&nbsp; &nbsp; &nbsp; : compaction(c),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; outfile(<span class="Constant">NULL</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; builder(<span class="Constant">NULL</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; total_bytes(<span class="Constant">0</span>) {<br/></li>
<li>&nbsp; }<br/></li>
<li>};<br/></li>
<li><br/></li>
<li><span class="Comment">// Fix user-supplied options to be reasonable<br/></li>
<li></span><span class="Type">template</span> &lt;<span class="Type">class</span> T,<span class="Type">class</span> V&gt;<br/></li>
<li><a id="L86">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">ClipToRange</span>(T* ptr, V minvalue, V maxvalue) {<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<span class="Statement">static_cast</span>&lt;V&gt;(*ptr) &gt; maxvalue) *ptr = maxvalue;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<span class="Statement">static_cast</span>&lt;V&gt;(*ptr) &lt; minvalue) *ptr = minvalue;<br/></li>
<li>}<br/></li>
<li><a id="L90">&#x200c;</a><a href="../include/leveldb/options.h.html#L31" title="include/leveldb/options.h:31">Options</a> <span class="linkable">SanitizeOptions</span>(<span class="Type">const</span> std::string&amp; <a href="c_test.c.html#L15" title="db/c_test.c:15">dbname</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">const</span> <a href="dbformat.h.html#L117" title="db/dbformat.h:117">InternalKeyComparator</a>* icmp,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">const</span> <a href="dbformat.h.html#L135" title="db/dbformat.h:135">InternalFilterPolicy</a>* ipolicy,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">const</span> <a href="../include/leveldb/options.h.html#L31" title="include/leveldb/options.h:31">Options</a>&amp; src) {<br/></li>
<li>&nbsp; <a href="../include/leveldb/options.h.html#L31" title="include/leveldb/options.h:31">Options</a> result = src;<br/></li>
<li>&nbsp; result.comparator = icmp;<br/></li>
<li>&nbsp; result.filter_policy = (src.filter_policy != <span class="Constant">NULL</span>) ? ipolicy : <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; <a href="#L86" title="db/db_impl.cc:86">ClipToRange</a>(&amp;result.max_open_files,&nbsp; &nbsp; <span class="Constant">64</span> + kNumNonTableCacheFiles, <span class="Constant">50000</span>);<br/></li>
<li>&nbsp; <a href="#L86" title="db/db_impl.cc:86">ClipToRange</a>(&amp;result.write_buffer_size, <span class="Constant">64</span>&lt;&lt;<span class="Constant">10</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">1</span>&lt;&lt;<span class="Constant">30</span>);<br/></li>
<li>&nbsp; <a href="#L86" title="db/db_impl.cc:86">ClipToRange</a>(&amp;result.block_size,&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">1</span>&lt;&lt;<span class="Constant">10</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">4</span>&lt;&lt;<span class="Constant">20</span>);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (result.info_log == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// <a href="../table/table.cc.html#L38" title="table/table.cc:38">Open</a> a log file in the same directory as the <a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a><br/></li>
<li></span>&nbsp; &nbsp; src.env-&gt;<a href="../include/leveldb/env.h.html#L297" title="include/leveldb/env.h:297">CreateDir</a>(<a href="c_test.c.html#L15" title="db/c_test.c:15">dbname</a>);&nbsp; <span class="Comment">// In case it does not exist<br/></li>
<li></span>&nbsp; &nbsp; src.env-&gt;<a href="../include/leveldb/env.h.html#L302" title="include/leveldb/env.h:302">RenameFile</a>(<a href="filename.cc.html#L63" title="db/filename.cc:63">InfoLogFileName</a>(<a href="c_test.c.html#L15" title="db/c_test.c:15">dbname</a>), <a href="filename.cc.html#L68" title="db/filename.cc:68">OldInfoLogFileName</a>(<a href="c_test.c.html#L15" title="db/c_test.c:15">dbname</a>));<br/></li>
<li>&nbsp; &nbsp; <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> s = src.env-&gt;<a href="../include/leveldb/env.h.html#L318" title="include/leveldb/env.h:318">NewLogger</a>(<a href="filename.cc.html#L63" title="db/filename.cc:63">InfoLogFileName</a>(<a href="c_test.c.html#L15" title="db/c_test.c:15">dbname</a>), &amp;result.info_log);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!s.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>()) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Comment">// No place suitable for logging<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; result.info_log = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">if</span> (result.block_cache == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; result.block_cache = <a href="../util/cache.cc.html#L321" title="util/cache.cc:321">NewLRUCache</a>(<span class="Constant">8</span> &lt;&lt; <span class="Constant">20</span>);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> result;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L116">&#x200c;</a><span class="linkable">DBImpl</span>::<span class="linkable">DBImpl</span>(<span class="Type">const</span> <a href="../include/leveldb/options.h.html#L31" title="include/leveldb/options.h:31">Options</a>&amp; raw_options, <span class="Type">const</span> std::string&amp; <a href="c_test.c.html#L15" title="db/c_test.c:15">dbname</a>)<br/></li>
<li>&nbsp; &nbsp; : env_(raw_options.env),<br/></li>
<li>&nbsp; &nbsp; &nbsp; internal_comparator_(raw_options.comparator),<br/></li>
<li>&nbsp; &nbsp; &nbsp; internal_filter_policy_(raw_options.filter_policy),<br/></li>
<li>&nbsp; &nbsp; &nbsp; options_(<a href="#L90" title="db/db_impl.cc:90">SanitizeOptions</a>(<a href="c_test.c.html#L15" title="db/c_test.c:15">dbname</a>, &amp;internal_comparator_,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;internal_filter_policy_, raw_options)),<br/></li>
<li>&nbsp; &nbsp; &nbsp; owns_info_log_(options_.info_log != raw_options.info_log),<br/></li>
<li>&nbsp; &nbsp; &nbsp; owns_cache_(options_.block_cache != raw_options.block_cache),<br/></li>
<li>&nbsp; &nbsp; &nbsp; dbname_(<a href="c_test.c.html#L15" title="db/c_test.c:15">dbname</a>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; db_lock_(<span class="Constant">NULL</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; shutting_down_(<span class="Constant">NULL</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; bg_cv_(&amp;mutex_),<br/></li>
<li>&nbsp; &nbsp; &nbsp; mem_(<span class="Statement">new</span> <a href="memtable.cc.html#L21" title="db/memtable.cc:21">MemTable</a>(internal_comparator_)),<br/></li>
<li>&nbsp; &nbsp; &nbsp; imm_(<span class="Constant">NULL</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; logfile_(<span class="Constant">NULL</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; logfile_number_(<span class="Constant">0</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; log_(<span class="Constant">NULL</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; seed_(<span class="Constant">0</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; tmp_batch_(<span class="Statement">new</span> <a href="write_batch.cc.html#L29" title="db/write_batch.cc:29">WriteBatch</a>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; bg_compaction_scheduled_(<span class="Constant">false</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; manual_compaction_(<span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; mem_-&gt;<a href="version_set.cc.html#L473" title="db/version_set.cc:473">Ref</a>();<br/></li>
<li>&nbsp; has_imm_.<a href="../port/atomic_pointer.h.html#L121" title="port/atomic_pointer.h:121">Release_Store</a>(<span class="Constant">NULL</span>);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// Reserve ten files or so for other uses and give the rest to <a href="table_cache.cc.html#L32" title="db/table_cache.cc:32">TableCache</a>.<br/></li>
<li></span>&nbsp; <span class="Type">const</span> <span class="Type">int</span> table_cache_size = options_.max_open_files - kNumNonTableCacheFiles;<br/></li>
<li>&nbsp; table_cache_ = <span class="Statement">new</span> <a href="table_cache.cc.html#L32" title="db/table_cache.cc:32">TableCache</a>(dbname_, &amp;options_, table_cache_size);<br/></li>
<li><br/></li>
<li>&nbsp; versions_ = <span class="Statement">new</span> <a href="version_set.cc.html#L766" title="db/version_set.cc:766">VersionSet</a>(dbname_, &amp;options_, table_cache_,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;internal_comparator_);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L148">&#x200c;</a><a href="#L116" title="db/db_impl.cc:116">DBImpl</a>::~<a href="#L116" title="db/db_impl.cc:116">DBImpl</a>() {<br/></li>
<li>&nbsp; <span class="Comment">// <a href="skiplist_test.cc.html#L315" title="db/skiplist_test.cc:315">Wait</a> for background work to finish<br/></li>
<li></span>&nbsp; mutex_.<a href="../port/port_posix.cc.html#L26" title="port/port_posix.cc:26">Lock</a>();<br/></li>
<li>&nbsp; shutting_down_.<a href="../port/atomic_pointer.h.html#L121" title="port/atomic_pointer.h:121">Release_Store</a>(<span class="Statement">this</span>);&nbsp; <span class="Comment">// Any non-NULL <a href="../table/two_level_iterator.cc.html#L41" title="table/two_level_iterator.cc:41">value</a> is <a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a><br/></li>
<li></span>&nbsp; <span class="Statement">while</span> (bg_compaction_scheduled_) {<br/></li>
<li>&nbsp; &nbsp; bg_cv_.<a href="skiplist_test.cc.html#L315" title="db/skiplist_test.cc:315">Wait</a>();<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; mutex_.<a href="../port/port_posix.cc.html#L28" title="port/port_posix.cc:28">Unlock</a>();<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">if</span> (db_lock_ != <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; env_-&gt;<a href="../include/leveldb/env.h.html#L308" title="include/leveldb/env.h:308">UnlockFile</a>(db_lock_);<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">delete</span> versions_;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (mem_ != <span class="Constant">NULL</span>) mem_-&gt;<a href="version_set.cc.html#L477" title="db/version_set.cc:477">Unref</a>();<br/></li>
<li>&nbsp; <span class="Statement">if</span> (imm_ != <span class="Constant">NULL</span>) imm_-&gt;<a href="version_set.cc.html#L477" title="db/version_set.cc:477">Unref</a>();<br/></li>
<li>&nbsp; <span class="Statement">delete</span> tmp_batch_;<br/></li>
<li>&nbsp; <span class="Statement">delete</span> log_;<br/></li>
<li>&nbsp; <span class="Statement">delete</span> logfile_;<br/></li>
<li>&nbsp; <span class="Statement">delete</span> table_cache_;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">if</span> (owns_info_log_) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">delete</span> options_.info_log;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">if</span> (owns_cache_) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">delete</span> options_.block_cache;<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L177">&#x200c;</a><a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> <a href="#L116" title="db/db_impl.cc:116">DBImpl</a>::<span class="linkable">NewDB</span>() {<br/></li>
<li>&nbsp; <a href="version_edit.h.html#L30" title="db/version_edit.h:30">VersionEdit</a> new_db;<br/></li>
<li>&nbsp; new_db.<a href="version_edit.h.html#L35" title="db/version_edit.h:35">SetComparatorName</a>(<a href="db_impl.h.html#L197" title="db/db_impl.h:197">user_comparator</a>()-&gt;<a href="../table/table_test.cc.html#L40" title="table/table_test.cc:40">Name</a>());<br/></li>
<li>&nbsp; new_db.<a href="version_edit.h.html#L39" title="db/version_edit.h:39">SetLogNumber</a>(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; new_db.<a href="version_edit.h.html#L47" title="db/version_edit.h:47">SetNextFile</a>(<span class="Constant">2</span>);<br/></li>
<li>&nbsp; new_db.<a href="version_set.h.html#L212" title="db/version_set.h:212">SetLastSequence</a>(<span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Type">const</span> std::string manifest = <a href="filename.cc.html#L42" title="db/filename.cc:42">DescriptorFileName</a>(dbname_, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; <a href="../include/leveldb/env.h.html#L214" title="include/leveldb/env.h:214">WritableFile</a>* file;<br/></li>
<li>&nbsp; <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> s = env_-&gt;<a href="../include/leveldb/env.h.html#L289" title="include/leveldb/env.h:289">NewWritableFile</a>(manifest, &amp;file);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (!s.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>()) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> s;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; {<br/></li>
<li>&nbsp; &nbsp; log::<a href="#L41" title="db/db_impl.cc:41">Writer</a> log(file);<br/></li>
<li>&nbsp; &nbsp; std::string record;<br/></li>
<li>&nbsp; &nbsp; new_db.<a href="../table/format.cc.html#L15" title="table/format.cc:15">EncodeTo</a>(&amp;record);<br/></li>
<li>&nbsp; &nbsp; s = log.<a href="log_writer.cc.html#L27" title="db/log_writer.cc:27">AddRecord</a>(record);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (s.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>()) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; s = file-&gt;<a href="../table/table_test.cc.html#L96" title="table/table_test.cc:96">Close</a>();<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">delete</span> file;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (s.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>()) {<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// Make &quot;CURRENT&quot; file that points to the new manifest file.<br/></li>
<li></span>&nbsp; &nbsp; s = <a href="filename.cc.html#L126" title="db/filename.cc:126">SetCurrentFile</a>(env_, dbname_, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; env_-&gt;<a href="../include/leveldb/env.h.html#L296" title="include/leveldb/env.h:296">DeleteFile</a>(manifest);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> s;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L209">&#x200c;</a><span class="Type">void</span> <a href="#L116" title="db/db_impl.cc:116">DBImpl</a>::<span class="linkable">MaybeIgnoreError</span>(<a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a>* s) <span class="Type">const</span> {<br/></li>
<li>&nbsp; <span class="Statement">if</span> (s-&gt;<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>() || options_.paranoid_checks) {<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// No change needed<br/></li>
<li></span>&nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; <a href="../util/env.cc.html#L27" title="util/env.cc:27">Log</a>(options_.info_log, <span class="Constant">&quot;Ignoring error </span><span class="Special">%s</span><span class="Constant">&quot;</span>, s-&gt;<a href="../table/table_test.cc.html#L587" title="table/table_test.cc:587">ToString</a>().c_str());<br/></li>
<li>&nbsp; &nbsp; *s = <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a>::<a href="../include/leveldb/status.h.html#L32" title="include/leveldb/status.h:32">OK</a>();<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L218">&#x200c;</a><span class="Type">void</span> <a href="#L116" title="db/db_impl.cc:116">DBImpl</a>::<span class="linkable">DeleteObsoleteFiles</span>() {<br/></li>
<li>&nbsp; <span class="Statement">if</span> (!bg_error_.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>()) {<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// After a background error, we don't know whether a new version may<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">// or may not have been committed, so we cannot safely garbage collect.<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// Make a set of all of the live files<br/></li>
<li></span>&nbsp; std::set&lt;<span class="Type"><a href="../port/win/stdint.h.html#L22" title="port/win/stdint.h:22">uint64_t</a></span>&gt; live = pending_outputs_;<br/></li>
<li>&nbsp; versions_-&gt;<a href="version_set.cc.html#L1137" title="db/version_set.cc:1137">AddLiveFiles</a>(&amp;live);<br/></li>
<li><br/></li>
<li>&nbsp; std::vector&lt;std::string&gt; filenames;<br/></li>
<li>&nbsp; env_-&gt;<a href="../include/leveldb/env.h.html#L293" title="include/leveldb/env.h:293">GetChildren</a>(dbname_, &amp;filenames); <span class="Comment">// Ignoring errors on purpose<br/></li>
<li></span>&nbsp; <span class="Type"><a href="../port/win/stdint.h.html#L22" title="port/win/stdint.h:22">uint64_t</a></span> number;<br/></li>
<li>&nbsp; <a href="filename.h.html#L20" title="db/filename.h:20">FileType</a> type;<br/></li>
<li>&nbsp; <span class="Statement">for</span> (<span class="Type">size_t</span> i = <span class="Constant">0</span>; i &lt; filenames.<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>(); i++) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="filename.cc.html#L80" title="db/filename.cc:80">ParseFileName</a>(filenames[i], &amp;number, &amp;type)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Type">bool</span> keep = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (type) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> kLogFile:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; keep = ((number &gt;= versions_-&gt;<a href="version_set.h.html#L221" title="db/version_set.h:221">LogNumber</a>()) ||<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (number == versions_-&gt;<a href="version_set.h.html#L225" title="db/version_set.h:225">PrevLogNumber</a>()));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> kDescriptorFile:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">// Keep my manifest file, and any newer incarnations'<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">// (in case there is a race that allows other incarnations)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; keep = (number &gt;= versions_-&gt;<a href="version_set.h.html#L188" title="db/version_set.h:188">ManifestFileNumber</a>());<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> kTableFile:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; keep = (live.find(number) != live.end());<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> kTempFile:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">// Any temp files that are currently being written to must<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">// be recorded in pending_outputs_, which is inserted into &quot;live&quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; keep = (live.find(number) != live.end());<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> kCurrentFile:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> kDBLockFile:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> kInfoLogFile:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; keep = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!keep) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (type == kTableFile) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; table_cache_-&gt;<a href="table_cache.cc.html#L121" title="db/table_cache.cc:121">Evict</a>(number);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../util/env.cc.html#L27" title="util/env.cc:27">Log</a>(options_.info_log, <span class="Constant">&quot;<a href="write_batch.cc.html#L105" title="db/write_batch.cc:105">Delete</a> type=</span><span class="Special">%d</span><span class="Constant"> #</span><span class="Special">%lld\n</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span>(type),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">static_cast</span>&lt;<span class="Type">unsigned</span> <span class="Type">long</span> <span class="Type">long</span>&gt;(number));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; env_-&gt;<a href="../include/leveldb/env.h.html#L296" title="include/leveldb/env.h:296">DeleteFile</a>(dbname_ + <span class="Constant">&quot;/&quot;</span> + filenames[i]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L274">&#x200c;</a><a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> <a href="#L116" title="db/db_impl.cc:116">DBImpl</a>::<span class="linkable">Recover</span>(<a href="version_edit.h.html#L30" title="db/version_edit.h:30">VersionEdit</a>* <a href="version_set.h.html#L332" title="db/version_set.h:332">edit</a>) {<br/></li>
<li>&nbsp; mutex_.<a href="../port/port_posix.h.html#L89" title="port/port_posix.h:89">AssertHeld</a>();<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// Ignore error from <a href="../include/leveldb/env.h.html#L297" title="include/leveldb/env.h:297">CreateDir</a> since the creation of the <a href="../include/leveldb/db.h.html#L55" title="include/leveldb/db.h:55">DB</a> is<br/></li>
<li></span>&nbsp; <span class="Comment">// committed only when the descriptor is created, and this directory<br/></li>
<li></span>&nbsp; <span class="Comment">// may already exist from a previous failed creation attempt.<br/></li>
<li></span>&nbsp; env_-&gt;<a href="../include/leveldb/env.h.html#L297" title="include/leveldb/env.h:297">CreateDir</a>(dbname_);<br/></li>
<li>&nbsp; assert(db_lock_ == <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> s = env_-&gt;<a href="../include/leveldb/env.h.html#L305" title="include/leveldb/env.h:305">LockFile</a>(<a href="filename.cc.html#L54" title="db/filename.cc:54">LockFileName</a>(dbname_), &amp;db_lock_);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (!s.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>()) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> s;<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">if</span> (!env_-&gt;<a href="../include/leveldb/env.h.html#L292" title="include/leveldb/env.h:292">FileExists</a>(<a href="filename.cc.html#L50" title="db/filename.cc:50">CurrentFileName</a>(dbname_))) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (options_.create_if_missing) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; s = <a href="../table/table_test.cc.html#L380" title="table/table_test.cc:380">NewDB</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!s.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>()) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> s;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a>::<a href="../include/leveldb/status.h.html#L44" title="include/leveldb/status.h:44">InvalidArgument</a>(<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dbname_, <span class="Constant">&quot;does not exist (create_if_missing is false)&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (options_.error_if_exists) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a>::<a href="../include/leveldb/status.h.html#L44" title="include/leveldb/status.h:44">InvalidArgument</a>(<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dbname_, <span class="Constant">&quot;exists (error_if_exists is true)&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; s = versions_-&gt;<a href="version_set.cc.html#L896" title="db/version_set.cc:896">Recover</a>();<br/></li>
<li>&nbsp; <span class="Statement">if</span> (s.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>()) {<br/></li>
<li>&nbsp; &nbsp; <a href="dbformat.h.html#L63" title="db/dbformat.h:63">SequenceNumber</a> max_sequence(<span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// <a href="version_set.cc.html#L896" title="db/version_set.cc:896">Recover</a> from all newer log files than the ones named in the<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">// descriptor (new log files may have been added by the previous<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">// incarnation without registering them in the descriptor).<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">//<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">// Note that <a href="version_set.h.html#L225" title="db/version_set.h:225">PrevLogNumber</a>() is no longer used, but we pay<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">// attention to it in case we are recovering a database<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">// produced by an older version of leveldb.<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">const</span> <span class="Type"><a href="../port/win/stdint.h.html#L22" title="port/win/stdint.h:22">uint64_t</a></span> min_log = versions_-&gt;<a href="version_set.h.html#L221" title="db/version_set.h:221">LogNumber</a>();<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <span class="Type"><a href="../port/win/stdint.h.html#L22" title="port/win/stdint.h:22">uint64_t</a></span> prev_log = versions_-&gt;<a href="version_set.h.html#L225" title="db/version_set.h:225">PrevLogNumber</a>();<br/></li>
<li>&nbsp; &nbsp; std::vector&lt;std::string&gt; filenames;<br/></li>
<li>&nbsp; &nbsp; s = env_-&gt;<a href="../include/leveldb/env.h.html#L293" title="include/leveldb/env.h:293">GetChildren</a>(dbname_, &amp;filenames);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!s.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>()) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span> s;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; std::set&lt;<span class="Type"><a href="../port/win/stdint.h.html#L22" title="port/win/stdint.h:22">uint64_t</a></span>&gt; expected;<br/></li>
<li>&nbsp; &nbsp; versions_-&gt;<a href="version_set.cc.html#L1137" title="db/version_set.cc:1137">AddLiveFiles</a>(&amp;expected);<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../port/win/stdint.h.html#L22" title="port/win/stdint.h:22">uint64_t</a></span> number;<br/></li>
<li>&nbsp; &nbsp; <a href="filename.h.html#L20" title="db/filename.h:20">FileType</a> type;<br/></li>
<li>&nbsp; &nbsp; std::vector&lt;<span class="Type"><a href="../port/win/stdint.h.html#L22" title="port/win/stdint.h:22">uint64_t</a></span>&gt; logs;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (<span class="Type">size_t</span> i = <span class="Constant">0</span>; i &lt; filenames.<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>(); i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="filename.cc.html#L80" title="db/filename.cc:80">ParseFileName</a>(filenames[i], &amp;number, &amp;type)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; expected.erase(number);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (type == kLogFile &amp;&amp; ((number &gt;= min_log) || (number == prev_log)))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; logs.push_back(number);<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!expected.<a href="../table/block_builder.h.html#L38" title="table/block_builder.h:38">empty</a>()) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Type">char</span> buf[<span class="Constant">50</span>];<br/></li>
<li>&nbsp; &nbsp; &nbsp; snprintf(buf, <span class="Statement">sizeof</span>(buf), <span class="Constant">&quot;</span><span class="Special">%d</span><span class="Constant"> missing files; e.g.&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Statement">static_cast</span>&lt;<span class="Type">int</span>&gt;(expected.<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>()));<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a>::<a href="../include/leveldb/status.h.html#L38" title="include/leveldb/status.h:38">Corruption</a>(buf, <a href="filename.cc.html#L32" title="db/filename.cc:32">TableFileName</a>(dbname_, *(expected.begin())));<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// <a href="version_set.cc.html#L896" title="db/version_set.cc:896">Recover</a> in the order in which the logs were generated<br/></li>
<li></span>&nbsp; &nbsp; std::sort(logs.begin(), logs.end());<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (<span class="Type">size_t</span> i = <span class="Constant">0</span>; i &lt; logs.<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>(); i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; s = <a href="#L362" title="db/db_impl.cc:362">RecoverLogFile</a>(logs[i], <a href="version_set.h.html#L332" title="db/version_set.h:332">edit</a>, &amp;max_sequence);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Comment">// The previous incarnation may not have written any MANIFEST<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Comment">// records after allocating this log number.&nbsp; So we manually<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Comment">// update the file number allocation counter in <a href="version_set.cc.html#L766" title="db/version_set.cc:766">VersionSet</a>.<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; versions_-&gt;<a href="version_set.cc.html#L1011" title="db/version_set.cc:1011">MarkFileNumberUsed</a>(logs[i]);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (s.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>()) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (versions_-&gt;<a href="version_set.h.html#L209" title="db/version_set.h:209">LastSequence</a>() &lt; max_sequence) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; versions_-&gt;<a href="version_set.h.html#L212" title="db/version_set.h:212">SetLastSequence</a>(max_sequence);<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">return</span> s;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L362">&#x200c;</a><a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> <a href="#L116" title="db/db_impl.cc:116">DBImpl</a>::<span class="linkable">RecoverLogFile</span>(<span class="Type"><a href="../port/win/stdint.h.html#L22" title="port/win/stdint.h:22">uint64_t</a></span> log_number,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="version_edit.h.html#L30" title="db/version_edit.h:30">VersionEdit</a>* <a href="version_set.h.html#L332" title="db/version_set.h:332">edit</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="dbformat.h.html#L63" title="db/dbformat.h:63">SequenceNumber</a>* max_sequence) {<br/></li>
<li>&nbsp; <span class="Type">struct</span> LogReporter : <span class="Statement">public</span> log::<a href="log_reader.cc.html#L18" title="db/log_reader.cc:18">Reader</a>::Reporter {<br/></li>
<li>&nbsp; &nbsp; <a href="../include/leveldb/env.h.html#L33" title="include/leveldb/env.h:33">Env</a>* env;<br/></li>
<li>&nbsp; &nbsp; <a href="../include/leveldb/env.h.html#L231" title="include/leveldb/env.h:231">Logger</a>* info_log;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span>* fname;<br/></li>
<li>&nbsp; &nbsp; <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a>* <a href="../table/two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a>;&nbsp; <span class="Comment">// NULL if options_.paranoid_checks==false<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">virtual</span> <span class="Type">void</span> <a href="../include/leveldb/status.h.html#L38" title="include/leveldb/status.h:38">Corruption</a>(<span class="Type">size_t</span> bytes, <span class="Type">const</span> <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a>&amp; s) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../util/env.cc.html#L27" title="util/env.cc:27">Log</a>(info_log, <span class="Constant">&quot;</span><span class="Special">%s%s</span><span class="Constant">: dropping </span><span class="Special">%d</span><span class="Constant"> bytes; </span><span class="Special">%s</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<span class="Statement">this</span>-&gt;<a href="../table/two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a> == <span class="Constant">NULL</span> ? <span class="Constant">&quot;(ignoring error) &quot;</span> : <span class="Constant">&quot;&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fname, <span class="Statement">static_cast</span>&lt;<span class="Type">int</span>&gt;(bytes), s.<a href="../table/table_test.cc.html#L587" title="table/table_test.cc:587">ToString</a>().c_str());<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<span class="Statement">this</span>-&gt;<a href="../table/two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a> != <span class="Constant">NULL</span> &amp;&amp; <span class="Statement">this</span>-&gt;<a href="../table/two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a>-&gt;<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>()) *<span class="Statement">this</span>-&gt;<a href="../table/two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a> = s;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; };<br/></li>
<li><br/></li>
<li>&nbsp; mutex_.<a href="../port/port_posix.h.html#L89" title="port/port_posix.h:89">AssertHeld</a>();<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// <a href="../table/table.cc.html#L38" title="table/table.cc:38">Open</a> the log file<br/></li>
<li></span>&nbsp; std::string fname = <a href="filename.cc.html#L27" title="db/filename.cc:27">LogFileName</a>(dbname_, log_number);<br/></li>
<li>&nbsp; <a href="../include/leveldb/env.h.html#L157" title="include/leveldb/env.h:157">SequentialFile</a>* file;<br/></li>
<li>&nbsp; <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> <a href="../table/two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a> = env_-&gt;<a href="../include/leveldb/env.h.html#L283" title="include/leveldb/env.h:283">NewSequentialFile</a>(fname, &amp;file);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (!<a href="../table/two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a>.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>()) {<br/></li>
<li>&nbsp; &nbsp; <a href="#L209" title="db/db_impl.cc:209">MaybeIgnoreError</a>(&amp;<a href="../table/two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../table/two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a>;<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// Create the log reader.<br/></li>
<li></span>&nbsp; LogReporter reporter;<br/></li>
<li>&nbsp; reporter.env = env_;<br/></li>
<li>&nbsp; reporter.info_log = options_.info_log;<br/></li>
<li>&nbsp; reporter.fname = fname.c_str();<br/></li>
<li>&nbsp; reporter.<a href="../table/two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a> = (options_.paranoid_checks ? &amp;<a href="../table/two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a> : <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; <span class="Comment">// We intentionally make log::<a href="log_reader.cc.html#L18" title="db/log_reader.cc:18">Reader</a> do checksumming even if<br/></li>
<li></span>&nbsp; <span class="Comment">// paranoid_checks==false so that corruptions cause entire commits<br/></li>
<li></span>&nbsp; <span class="Comment">// to be skipped instead of propagating bad information (like overly<br/></li>
<li></span>&nbsp; <span class="Comment">// large sequence numbers).<br/></li>
<li></span>&nbsp; log::<a href="log_reader.cc.html#L18" title="db/log_reader.cc:18">Reader</a> reader(file, &amp;reporter, <span class="Constant">true</span><span class="Comment">/*checksum*/</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">0</span><span class="Comment">/*initial_offset*/</span>);<br/></li>
<li>&nbsp; <a href="../util/env.cc.html#L27" title="util/env.cc:27">Log</a>(options_.info_log, <span class="Constant">&quot;Recovering log #</span><span class="Special">%llu</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; (<span class="Type">unsigned</span> <span class="Type">long</span> <span class="Type">long</span>) log_number);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// <a href="../table/table_test.cc.html#L120" title="table/table_test.cc:120">Read</a> all the records and add to a memtable<br/></li>
<li></span>&nbsp; std::string scratch;<br/></li>
<li>&nbsp; <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a> record;<br/></li>
<li>&nbsp; <a href="write_batch.cc.html#L29" title="db/write_batch.cc:29">WriteBatch</a> batch;<br/></li>
<li>&nbsp; <a href="memtable.cc.html#L21" title="db/memtable.cc:21">MemTable</a>* mem = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; <span class="Statement">while</span> (reader.<a href="log_reader.cc.html#L59" title="db/log_reader.cc:59">ReadRecord</a>(&amp;record, &amp;scratch) &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../table/two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a>.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>()) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (record.<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>() &lt; <span class="Constant">12</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; reporter.<a href="../include/leveldb/status.h.html#L38" title="include/leveldb/status.h:38">Corruption</a>(<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; record.<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>(), <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a>::<a href="../include/leveldb/status.h.html#L38" title="include/leveldb/status.h:38">Corruption</a>(<span class="Constant">&quot;log record too small&quot;</span>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; WriteBatchInternal::<a href="write_batch.cc.html#L136" title="db/write_batch.cc:136">SetContents</a>(&amp;batch, record);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (mem == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; mem = <span class="Statement">new</span> <a href="memtable.cc.html#L21" title="db/memtable.cc:21">MemTable</a>(internal_comparator_);<br/></li>
<li>&nbsp; &nbsp; &nbsp; mem-&gt;<a href="version_set.cc.html#L473" title="db/version_set.cc:473">Ref</a>();<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <a href="../table/two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a> = WriteBatchInternal::<a href="write_batch.cc.html#L128" title="db/write_batch.cc:128">InsertInto</a>(&amp;batch, mem);<br/></li>
<li>&nbsp; &nbsp; <a href="#L209" title="db/db_impl.cc:209">MaybeIgnoreError</a>(&amp;<a href="../table/two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!<a href="../table/two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a>.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>()) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <a href="dbformat.h.html#L63" title="db/dbformat.h:63">SequenceNumber</a> last_seq =<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; WriteBatchInternal::<a href="write_batch.cc.html#L90" title="db/write_batch.cc:90">Sequence</a>(&amp;batch) +<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; WriteBatchInternal::<a href="write_batch.cc.html#L82" title="db/write_batch.cc:82">Count</a>(&amp;batch) - <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (last_seq &gt; *max_sequence) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; *max_sequence = last_seq;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (mem-&gt;<a href="memtable.cc.html#L31" title="db/memtable.cc:31">ApproximateMemoryUsage</a>() &gt; options_.write_buffer_size) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../table/two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a> = <a href="#L457" title="db/db_impl.cc:457">WriteLevel0Table</a>(mem, <a href="version_set.h.html#L332" title="db/version_set.h:332">edit</a>, <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!<a href="../table/two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a>.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>()) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">// Reflect errors immediately so that conditions like full<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">// file-systems cause the <a href="../include/leveldb/db.h.html#L55" title="include/leveldb/db.h:55">DB</a>::<a href="../table/table.cc.html#L38" title="table/table.cc:38">Open</a>() to fail.<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; mem-&gt;<a href="version_set.cc.html#L477" title="db/version_set.cc:477">Unref</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; mem = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="../table/two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a>.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>() &amp;&amp; mem != <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; <a href="../table/two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a> = <a href="#L457" title="db/db_impl.cc:457">WriteLevel0Table</a>(mem, <a href="version_set.h.html#L332" title="db/version_set.h:332">edit</a>, <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// Reflect errors immediately so that conditions like full<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">// file-systems cause the <a href="../include/leveldb/db.h.html#L55" title="include/leveldb/db.h:55">DB</a>::<a href="../table/table.cc.html#L38" title="table/table.cc:38">Open</a>() to fail.<br/></li>
<li></span>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">if</span> (mem != <span class="Constant">NULL</span>) mem-&gt;<a href="version_set.cc.html#L477" title="db/version_set.cc:477">Unref</a>();<br/></li>
<li>&nbsp; <span class="Statement">delete</span> file;<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="../table/two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L457">&#x200c;</a><a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> <a href="#L116" title="db/db_impl.cc:116">DBImpl</a>::<span class="linkable">WriteLevel0Table</span>(<a href="memtable.cc.html#L21" title="db/memtable.cc:21">MemTable</a>* mem, <a href="version_edit.h.html#L30" title="db/version_edit.h:30">VersionEdit</a>* <a href="version_set.h.html#L332" title="db/version_set.h:332">edit</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="version_set.h.html#L150" title="db/version_set.h:150">Version</a>* base) {<br/></li>
<li>&nbsp; mutex_.<a href="../port/port_posix.h.html#L89" title="port/port_posix.h:89">AssertHeld</a>();<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type"><a href="../port/win/stdint.h.html#L22" title="port/win/stdint.h:22">uint64_t</a></span> start_micros = env_-&gt;<a href="../include/leveldb/env.h.html#L321" title="include/leveldb/env.h:321">NowMicros</a>();<br/></li>
<li>&nbsp; <a href="version_edit.h.html#L17" title="db/version_edit.h:17">FileMetaData</a> meta;<br/></li>
<li>&nbsp; meta.number = versions_-&gt;<a href="version_set.h.html#L191" title="db/version_set.h:191">NewFileNumber</a>();<br/></li>
<li>&nbsp; pending_outputs_.insert(meta.number);<br/></li>
<li>&nbsp; <a href="../table/iterator.cc.html#L9" title="table/iterator.cc:9">Iterator</a>* <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a> = mem-&gt;<a href="../table/table_test.cc.html#L209" title="table/table_test.cc:209">NewIterator</a>();<br/></li>
<li>&nbsp; <a href="../util/env.cc.html#L27" title="util/env.cc:27">Log</a>(options_.info_log, <span class="Constant">&quot;Level-0 table #</span><span class="Special">%llu</span><span class="Constant">: started&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; (<span class="Type">unsigned</span> <span class="Type">long</span> <span class="Type">long</span>) meta.number);<br/></li>
<li><br/></li>
<li>&nbsp; <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> s;<br/></li>
<li>&nbsp; {<br/></li>
<li>&nbsp; &nbsp; mutex_.<a href="../port/port_posix.cc.html#L28" title="port/port_posix.cc:28">Unlock</a>();<br/></li>
<li>&nbsp; &nbsp; s = <a href="builder.cc.html#L17" title="db/builder.cc:17">BuildTable</a>(dbname_, env_, options_, table_cache_, <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>, &amp;meta);<br/></li>
<li>&nbsp; &nbsp; mutex_.<a href="../port/port_posix.cc.html#L26" title="port/port_posix.cc:26">Lock</a>();<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <a href="../util/env.cc.html#L27" title="util/env.cc:27">Log</a>(options_.info_log, <span class="Constant">&quot;Level-0 table #</span><span class="Special">%llu</span><span class="Constant">: </span><span class="Special">%lld</span><span class="Constant"> bytes </span><span class="Special">%s</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; (<span class="Type">unsigned</span> <span class="Type">long</span> <span class="Type">long</span>) meta.number,<br/></li>
<li>&nbsp; &nbsp; &nbsp; (<span class="Type">unsigned</span> <span class="Type">long</span> <span class="Type">long</span>) meta.file_size,<br/></li>
<li>&nbsp; &nbsp; &nbsp; s.<a href="../table/table_test.cc.html#L587" title="table/table_test.cc:587">ToString</a>().c_str());<br/></li>
<li>&nbsp; <span class="Statement">delete</span> <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>;<br/></li>
<li>&nbsp; pending_outputs_.erase(meta.number);<br/></li>
<li><br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// Note that if file_size is zero, the file has been deleted and<br/></li>
<li></span>&nbsp; <span class="Comment">// should not be added to the manifest.<br/></li>
<li></span>&nbsp; <span class="Type">int</span> <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (s.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>() &amp;&amp; meta.file_size &gt; <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a> min_user_key = meta.smallest.<a href="dbformat.h.html#L159" title="db/dbformat.h:159">user_key</a>();<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a> max_user_key = meta.largest.<a href="dbformat.h.html#L159" title="db/dbformat.h:159">user_key</a>();<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (base != <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> = base-&gt;<a href="version_set.cc.html#L493" title="db/version_set.cc:493">PickLevelForMemTableOutput</a>(min_user_key, max_user_key);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <a href="version_set.h.html#L332" title="db/version_set.h:332">edit</a>-&gt;<a href="version_edit.h.html#L62" title="db/version_edit.h:62">AddFile</a>(<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>, meta.number, meta.file_size,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; meta.smallest, meta.largest);<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <a href="db_impl.h.html#L178" title="db/db_impl.h:178">CompactionStats</a> stats;<br/></li>
<li>&nbsp; stats.micros = env_-&gt;<a href="../include/leveldb/env.h.html#L321" title="include/leveldb/env.h:321">NowMicros</a>() - start_micros;<br/></li>
<li>&nbsp; stats.bytes_written = meta.file_size;<br/></li>
<li>&nbsp; stats_[<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>].<a href="../table/table_test.cc.html#L146" title="table/table_test.cc:146">Add</a>(stats);<br/></li>
<li>&nbsp; <span class="Statement">return</span> s;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L503">&#x200c;</a><span class="Type">void</span> <a href="#L116" title="db/db_impl.cc:116">DBImpl</a>::<span class="linkable">CompactMemTable</span>() {<br/></li>
<li>&nbsp; mutex_.<a href="../port/port_posix.h.html#L89" title="port/port_posix.h:89">AssertHeld</a>();<br/></li>
<li>&nbsp; assert(imm_ != <span class="Constant">NULL</span>);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// Save the <a href="../table/table_test.cc.html#L94" title="table/table_test.cc:94">contents</a> of the memtable as a new <a href="../include/leveldb/table.h.html#L62" title="include/leveldb/table.h:62">Table</a><br/></li>
<li></span>&nbsp; <a href="version_edit.h.html#L30" title="db/version_edit.h:30">VersionEdit</a> <a href="version_set.h.html#L332" title="db/version_set.h:332">edit</a>;<br/></li>
<li>&nbsp; <a href="version_set.h.html#L150" title="db/version_set.h:150">Version</a>* base = versions_-&gt;<a href="version_set.h.html#L185" title="db/version_set.h:185">current</a>();<br/></li>
<li>&nbsp; base-&gt;<a href="version_set.cc.html#L473" title="db/version_set.cc:473">Ref</a>();<br/></li>
<li>&nbsp; <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> s = <a href="#L457" title="db/db_impl.cc:457">WriteLevel0Table</a>(imm_, &amp;<a href="version_set.h.html#L332" title="db/version_set.h:332">edit</a>, base);<br/></li>
<li>&nbsp; base-&gt;<a href="version_set.cc.html#L477" title="db/version_set.cc:477">Unref</a>();<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">if</span> (s.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>() &amp;&amp; shutting_down_.<a href="../port/atomic_pointer.h.html#L116" title="port/atomic_pointer.h:116">Acquire_Load</a>()) {<br/></li>
<li>&nbsp; &nbsp; s = <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a>::<a href="../include/leveldb/status.h.html#L47" title="include/leveldb/status.h:47">IOError</a>(<span class="Constant">&quot;Deleting <a href="../include/leveldb/db.h.html#L55" title="include/leveldb/db.h:55">DB</a> during memtable compaction&quot;</span>);<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// Replace immutable memtable with the generated <a href="../include/leveldb/table.h.html#L62" title="include/leveldb/table.h:62">Table</a><br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (s.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>()) {<br/></li>
<li>&nbsp; &nbsp; <a href="version_set.h.html#L332" title="db/version_set.h:332">edit</a>.<a href="version_edit.h.html#L43" title="db/version_edit.h:43">SetPrevLogNumber</a>(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="version_set.h.html#L332" title="db/version_set.h:332">edit</a>.<a href="version_edit.h.html#L39" title="db/version_edit.h:39">SetLogNumber</a>(logfile_number_);&nbsp; <span class="Comment">// Earlier logs no longer needed<br/></li>
<li></span>&nbsp; &nbsp; s = versions_-&gt;<a href="version_set.cc.html#L811" title="db/version_set.cc:811">LogAndApply</a>(&amp;<a href="version_set.h.html#L332" title="db/version_set.h:332">edit</a>, &amp;mutex_);<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">if</span> (s.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>()) {<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// Commit to the new state<br/></li>
<li></span>&nbsp; &nbsp; imm_-&gt;<a href="version_set.cc.html#L477" title="db/version_set.cc:477">Unref</a>();<br/></li>
<li>&nbsp; &nbsp; imm_ = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; has_imm_.<a href="../port/atomic_pointer.h.html#L121" title="port/atomic_pointer.h:121">Release_Store</a>(<span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="#L218" title="db/db_impl.cc:218">DeleteObsoleteFiles</a>();<br/></li>
<li>&nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; <a href="#L606" title="db/db_impl.cc:606">RecordBackgroundError</a>(s);<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L536">&#x200c;</a><span class="Type">void</span> <a href="#L116" title="db/db_impl.cc:116">DBImpl</a>::<span class="linkable">CompactRange</span>(<span class="Type">const</span> <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>* begin, <span class="Type">const</span> <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>* end) {<br/></li>
<li>&nbsp; <span class="Type">int</span> max_level_with_files = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; {<br/></li>
<li>&nbsp; &nbsp; MutexLock l(&amp;mutex_);<br/></li>
<li>&nbsp; &nbsp; <a href="version_set.h.html#L150" title="db/version_set.h:150">Version</a>* base = versions_-&gt;<a href="version_set.h.html#L185" title="db/version_set.h:185">current</a>();<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (<span class="Type">int</span> <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> = <span class="Constant">1</span>; <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> &lt; config::kNumLevels; <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (base-&gt;<a href="version_set.cc.html#L486" title="db/version_set.cc:486">OverlapInLevel</a>(<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>, begin, end)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; max_level_with_files = <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <a href="#L590" title="db/db_impl.cc:590">TEST_CompactMemTable</a>(); <span class="Comment">// </span><span class="Todo">TODO</span><span class="Comment">(sanjay): <a href="log_test.cc.html#L79" title="db/log_test.cc:79">Skip</a> if memtable does not overlap<br/></li>
<li></span>&nbsp; <span class="Statement">for</span> (<span class="Type">int</span> <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> = <span class="Constant">0</span>; <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> &lt; max_level_with_files; <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>++) {<br/></li>
<li>&nbsp; &nbsp; <a href="#L553" title="db/db_impl.cc:553">TEST_CompactRange</a>(<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>, begin, end);<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L553">&#x200c;</a><span class="Type">void</span> <a href="#L116" title="db/db_impl.cc:116">DBImpl</a>::<span class="linkable">TEST_CompactRange</span>(<span class="Type">int</span> <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>, <span class="Type">const</span> <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>* begin,<span class="Type">const</span> <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>* end) {<br/></li>
<li>&nbsp; assert(<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> &gt;= <span class="Constant">0</span>);<br/></li>
<li>&nbsp; assert(<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> + <span class="Constant">1</span> &lt; config::kNumLevels);<br/></li>
<li><br/></li>
<li>&nbsp; <a href="dbformat.h.html#L148" title="db/dbformat.h:148">InternalKey</a> begin_storage, end_storage;<br/></li>
<li><br/></li>
<li>&nbsp; <a href="db_impl.h.html#L162" title="db/db_impl.h:162">ManualCompaction</a> manual;<br/></li>
<li>&nbsp; manual.<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> = <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>;<br/></li>
<li>&nbsp; manual.done = <span class="Constant">false</span>;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (begin == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; manual.begin = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; begin_storage = <a href="dbformat.h.html#L148" title="db/dbformat.h:148">InternalKey</a>(*begin, kMaxSequenceNumber, kValueTypeForSeek);<br/></li>
<li>&nbsp; &nbsp; manual.begin = &amp;begin_storage;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">if</span> (end == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; manual.end = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; end_storage = <a href="dbformat.h.html#L148" title="db/dbformat.h:148">InternalKey</a>(*end, <span class="Constant">0</span>, <span class="Statement">static_cast</span>&lt;<a href="dbformat.h.html#L51" title="db/dbformat.h:51">ValueType</a>&gt;(<span class="Constant">0</span>));<br/></li>
<li>&nbsp; &nbsp; manual.end = &amp;end_storage;<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; MutexLock l(&amp;mutex_);<br/></li>
<li>&nbsp; <span class="Statement">while</span> (!manual.done &amp;&amp; !shutting_down_.<a href="../port/atomic_pointer.h.html#L116" title="port/atomic_pointer.h:116">Acquire_Load</a>() &amp;&amp; bg_error_.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>()) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (manual_compaction_ == <span class="Constant">NULL</span>) {&nbsp; <span class="Comment">// Idle<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; manual_compaction_ = &amp;manual;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L614" title="db/db_impl.cc:614">MaybeScheduleCompaction</a>();<br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {&nbsp; <span class="Comment">// Running either my compaction or another compaction.<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; bg_cv_.<a href="skiplist_test.cc.html#L315" title="db/skiplist_test.cc:315">Wait</a>();<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">if</span> (manual_compaction_ == &amp;manual) {<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// Cancel my manual compaction since we aborted early for some reason.<br/></li>
<li></span>&nbsp; &nbsp; manual_compaction_ = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L590">&#x200c;</a><a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> <a href="#L116" title="db/db_impl.cc:116">DBImpl</a>::<span class="linkable">TEST_CompactMemTable</span>() {<br/></li>
<li>&nbsp; <span class="Comment">// NULL batch means just wait for earlier writes to be done<br/></li>
<li></span>&nbsp; <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> s = <a href="log_test.cc.html#L121" title="db/log_test.cc:121">Write</a>(<a href="../include/leveldb/options.h.html#L169" title="include/leveldb/options.h:169">WriteOptions</a>(), <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (s.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>()) {<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// <a href="skiplist_test.cc.html#L315" title="db/skiplist_test.cc:315">Wait</a> until the compaction completes<br/></li>
<li></span>&nbsp; &nbsp; MutexLock l(&amp;mutex_);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (imm_ != <span class="Constant">NULL</span> &amp;&amp; bg_error_.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>()) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; bg_cv_.<a href="skiplist_test.cc.html#L315" title="db/skiplist_test.cc:315">Wait</a>();<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (imm_ != <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; s = bg_error_;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> s;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L606">&#x200c;</a><span class="Type">void</span> <a href="#L116" title="db/db_impl.cc:116">DBImpl</a>::<span class="linkable">RecordBackgroundError</span>(<span class="Type">const</span> <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a>&amp; s) {<br/></li>
<li>&nbsp; mutex_.<a href="../port/port_posix.h.html#L89" title="port/port_posix.h:89">AssertHeld</a>();<br/></li>
<li>&nbsp; <span class="Statement">if</span> (bg_error_.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>()) {<br/></li>
<li>&nbsp; &nbsp; bg_error_ = s;<br/></li>
<li>&nbsp; &nbsp; bg_cv_.<a href="../port/port_posix.cc.html#L45" title="port/port_posix.cc:45">SignalAll</a>();<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L614">&#x200c;</a><span class="Type">void</span> <a href="#L116" title="db/db_impl.cc:116">DBImpl</a>::<span class="linkable">MaybeScheduleCompaction</span>() {<br/></li>
<li>&nbsp; mutex_.<a href="../port/port_posix.h.html#L89" title="port/port_posix.h:89">AssertHeld</a>();<br/></li>
<li>&nbsp; <span class="Statement">if</span> (bg_compaction_scheduled_) {<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// Already scheduled<br/></li>
<li></span>&nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (shutting_down_.<a href="../port/atomic_pointer.h.html#L116" title="port/atomic_pointer.h:116">Acquire_Load</a>()) {<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// <a href="../include/leveldb/db.h.html#L55" title="include/leveldb/db.h:55">DB</a> is being deleted; no more background compactions<br/></li>
<li></span>&nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (!bg_error_.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>()) {<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// Already got an error; no more changes<br/></li>
<li></span>&nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (imm_ == <span class="Constant">NULL</span> &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; manual_compaction_ == <span class="Constant">NULL</span> &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; !versions_-&gt;<a href="version_set.h.html#L251" title="db/version_set.h:251">NeedsCompaction</a>()) {<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// No work to be done<br/></li>
<li></span>&nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; bg_compaction_scheduled_ = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; env_-&gt;<a href="../include/leveldb/env.h.html#L309" title="include/leveldb/env.h:309">Schedule</a>(&amp;<a href="#L116" title="db/db_impl.cc:116">DBImpl</a>::<a href="#L632" title="db/db_impl.cc:632">BGWork</a>, <span class="Statement">this</span>);<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L632">&#x200c;</a><span class="Type">void</span> <a href="#L116" title="db/db_impl.cc:116">DBImpl</a>::<span class="linkable">BGWork</span>(<span class="Type">void</span>* <a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a>) {<br/></li>
<li>&nbsp; <span class="Statement">reinterpret_cast</span>&lt;<a href="#L116" title="db/db_impl.cc:116">DBImpl</a>*&gt;(<a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a>)-&gt;<a href="#L636" title="db/db_impl.cc:636">BackgroundCall</a>();<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L636">&#x200c;</a><span class="Type">void</span> <a href="#L116" title="db/db_impl.cc:116">DBImpl</a>::<span class="linkable">BackgroundCall</span>() {<br/></li>
<li>&nbsp; MutexLock l(&amp;mutex_);<br/></li>
<li>&nbsp; assert(bg_compaction_scheduled_);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (shutting_down_.<a href="../port/atomic_pointer.h.html#L116" title="port/atomic_pointer.h:116">Acquire_Load</a>()) {<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// No more background work when shutting down.<br/></li>
<li></span>&nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (!bg_error_.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>()) {<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// No more background work after a background error.<br/></li>
<li></span>&nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; <a href="#L655" title="db/db_impl.cc:655">BackgroundCompaction</a>();<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; bg_compaction_scheduled_ = <span class="Constant">false</span>;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// Previous compaction may have produced too many files in a <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>,<br/></li>
<li></span>&nbsp; <span class="Comment">// so reschedule another compaction if needed.<br/></li>
<li></span>&nbsp; <a href="#L614" title="db/db_impl.cc:614">MaybeScheduleCompaction</a>();<br/></li>
<li>&nbsp; bg_cv_.<a href="../port/port_posix.cc.html#L45" title="port/port_posix.cc:45">SignalAll</a>();<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L655">&#x200c;</a><span class="Type">void</span> <a href="#L116" title="db/db_impl.cc:116">DBImpl</a>::<span class="linkable">BackgroundCompaction</span>() {<br/></li>
<li>&nbsp; mutex_.<a href="../port/port_posix.h.html#L89" title="port/port_posix.h:89">AssertHeld</a>();<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">if</span> (imm_ != <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; <a href="#L503" title="db/db_impl.cc:503">CompactMemTable</a>();<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <a href="version_set.cc.html#L1399" title="db/version_set.cc:1399">Compaction</a>* c;<br/></li>
<li>&nbsp; <span class="Type">bool</span> is_manual = (manual_compaction_ != <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; <a href="dbformat.h.html#L148" title="db/dbformat.h:148">InternalKey</a> manual_end;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (is_manual) {<br/></li>
<li>&nbsp; &nbsp; <a href="db_impl.h.html#L162" title="db/db_impl.h:162">ManualCompaction</a>* m = manual_compaction_;<br/></li>
<li>&nbsp; &nbsp; c = versions_-&gt;<a href="version_set.cc.html#L1364" title="db/version_set.cc:1364">CompactRange</a>(m-&gt;<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>, m-&gt;begin, m-&gt;end);<br/></li>
<li>&nbsp; &nbsp; m-&gt;done = (c == <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c != <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; manual_end = c-&gt;<a href="version_set.h.html#L338" title="db/version_set.h:338">input</a>(<span class="Constant">0</span>, c-&gt;<a href="version_set.h.html#L335" title="db/version_set.h:335">num_input_files</a>(<span class="Constant">0</span>) - <span class="Constant">1</span>)-&gt;largest;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <a href="../util/env.cc.html#L27" title="util/env.cc:27">Log</a>(options_.info_log,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;Manual compaction at <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>-</span><span class="Special">%d</span><span class="Constant"> from </span><span class="Special">%s</span><span class="Constant"> .. </span><span class="Special">%s</span><span class="Constant">; will stop at </span><span class="Special">%s\n</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; m-&gt;<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; (m-&gt;begin ? m-&gt;begin-&gt;<a href="version_set.cc.html#L565" title="db/version_set.cc:565">DebugString</a>().c_str() : <span class="Constant">&quot;(begin)&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; (m-&gt;end ? m-&gt;end-&gt;<a href="version_set.cc.html#L565" title="db/version_set.cc:565">DebugString</a>().c_str() : <span class="Constant">&quot;(end)&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; (m-&gt;done ? <span class="Constant">&quot;(end)&quot;</span> : manual_end.<a href="version_set.cc.html#L565" title="db/version_set.cc:565">DebugString</a>().c_str()));<br/></li>
<li>&nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; c = versions_-&gt;<a href="version_set.cc.html#L1243" title="db/version_set.cc:1243">PickCompaction</a>();<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> <a href="../table/two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a>;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (c == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// Nothing to do<br/></li>
<li></span>&nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (!is_manual &amp;&amp; c-&gt;<a href="version_set.cc.html#L1417" title="db/version_set.cc:1417">IsTrivialMove</a>()) {<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// Move file to next <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a><br/></li>
<li></span>&nbsp; &nbsp; assert(c-&gt;<a href="version_set.h.html#L335" title="db/version_set.h:335">num_input_files</a>(<span class="Constant">0</span>) == <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="version_edit.h.html#L17" title="db/version_edit.h:17">FileMetaData</a>* f = c-&gt;<a href="version_set.h.html#L338" title="db/version_set.h:338">input</a>(<span class="Constant">0</span>, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; c-&gt;<a href="version_set.h.html#L332" title="db/version_set.h:332">edit</a>()-&gt;<a href="../include/leveldb/env.h.html#L296" title="include/leveldb/env.h:296">DeleteFile</a>(c-&gt;<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>(), f-&gt;number);<br/></li>
<li>&nbsp; &nbsp; c-&gt;<a href="version_set.h.html#L332" title="db/version_set.h:332">edit</a>()-&gt;<a href="version_edit.h.html#L62" title="db/version_edit.h:62">AddFile</a>(c-&gt;<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>() + <span class="Constant">1</span>, f-&gt;number, f-&gt;file_size,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; f-&gt;smallest, f-&gt;largest);<br/></li>
<li>&nbsp; &nbsp; <a href="../table/two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a> = versions_-&gt;<a href="version_set.cc.html#L811" title="db/version_set.cc:811">LogAndApply</a>(c-&gt;<a href="version_set.h.html#L332" title="db/version_set.h:332">edit</a>(), &amp;mutex_);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!<a href="../table/two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a>.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>()) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L606" title="db/db_impl.cc:606">RecordBackgroundError</a>(<a href="../table/two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <a href="version_set.cc.html#L766" title="db/version_set.cc:766">VersionSet</a>::<a href="version_set.h.html#L266" title="db/version_set.h:266">LevelSummaryStorage</a> tmp;<br/></li>
<li>&nbsp; &nbsp; <a href="../util/env.cc.html#L27" title="util/env.cc:27">Log</a>(options_.info_log, <span class="Constant">&quot;Moved #</span><span class="Special">%lld</span><span class="Constant"> to <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>-</span><span class="Special">%d</span><span class="Constant"> </span><span class="Special">%lld</span><span class="Constant"> bytes </span><span class="Special">%s</span><span class="Constant">: </span><span class="Special">%s\n</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">static_cast</span>&lt;<span class="Type">unsigned</span> <span class="Type">long</span> <span class="Type">long</span>&gt;(f-&gt;number),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>() + <span class="Constant">1</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">static_cast</span>&lt;<span class="Type">unsigned</span> <span class="Type">long</span> <span class="Type">long</span>&gt;(f-&gt;file_size),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../table/two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a>.<a href="../table/table_test.cc.html#L587" title="table/table_test.cc:587">ToString</a>().c_str(),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; versions_-&gt;<a href="version_set.cc.html#L1090" title="db/version_set.cc:1090">LevelSummary</a>(&amp;tmp));<br/></li>
<li>&nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; <a href="#L51" title="db/db_impl.cc:51">CompactionState</a>* compact = <span class="Statement">new</span> <a href="#L51" title="db/db_impl.cc:51">CompactionState</a>(c);<br/></li>
<li>&nbsp; &nbsp; <a href="../table/two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a> = <a href="#L855" title="db/db_impl.cc:855">DoCompactionWork</a>(compact);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!<a href="../table/two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a>.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>()) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L606" title="db/db_impl.cc:606">RecordBackgroundError</a>(<a href="../table/two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <a href="#L740" title="db/db_impl.cc:740">CleanupCompaction</a>(compact);<br/></li>
<li>&nbsp; &nbsp; c-&gt;<a href="version_set.cc.html#L1477" title="db/version_set.cc:1477">ReleaseInputs</a>();<br/></li>
<li>&nbsp; &nbsp; <a href="#L218" title="db/db_impl.cc:218">DeleteObsoleteFiles</a>();<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">delete</span> c;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="../table/two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a>.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>()) {<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// Done<br/></li>
<li></span>&nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (shutting_down_.<a href="../port/atomic_pointer.h.html#L116" title="port/atomic_pointer.h:116">Acquire_Load</a>()) {<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// Ignore compaction errors found during shutting down<br/></li>
<li></span>&nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; <a href="../util/env.cc.html#L27" title="util/env.cc:27">Log</a>(options_.info_log,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;<a href="version_set.cc.html#L1399" title="db/version_set.cc:1399">Compaction</a> error: </span><span class="Special">%s</span><span class="Constant">&quot;</span>, <a href="../table/two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a>.<a href="../table/table_test.cc.html#L587" title="table/table_test.cc:587">ToString</a>().c_str());<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">if</span> (is_manual) {<br/></li>
<li>&nbsp; &nbsp; <a href="db_impl.h.html#L162" title="db/db_impl.h:162">ManualCompaction</a>* m = manual_compaction_;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!<a href="../table/two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a>.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>()) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; m-&gt;done = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!m-&gt;done) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Comment">// We only compacted part of the requested range.&nbsp; <a href="../table/iterator_wrapper.h.html#L49" title="table/iterator_wrapper.h:49">Update</a> *m<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Comment">// to the range that is left to be compacted.<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; m-&gt;tmp_storage = manual_end;<br/></li>
<li>&nbsp; &nbsp; &nbsp; m-&gt;begin = &amp;m-&gt;tmp_storage;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; manual_compaction_ = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L740">&#x200c;</a><span class="Type">void</span> <a href="#L116" title="db/db_impl.cc:116">DBImpl</a>::<span class="linkable">CleanupCompaction</span>(<a href="#L51" title="db/db_impl.cc:51">CompactionState</a>* compact) {<br/></li>
<li>&nbsp; mutex_.<a href="../port/port_posix.h.html#L89" title="port/port_posix.h:89">AssertHeld</a>();<br/></li>
<li>&nbsp; <span class="Statement">if</span> (compact-&gt;builder != <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// May happen if we get a shutdown call in the middle of compaction<br/></li>
<li></span>&nbsp; &nbsp; compact-&gt;builder-&gt;<a href="../table/table_builder.cc.html#L256" title="table/table_builder.cc:256">Abandon</a>();<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">delete</span> compact-&gt;builder;<br/></li>
<li>&nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; assert(compact-&gt;outfile == <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">delete</span> compact-&gt;outfile;<br/></li>
<li>&nbsp; <span class="Statement">for</span> (<span class="Type">size_t</span> i = <span class="Constant">0</span>; i &lt; compact-&gt;outputs.<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>(); i++) {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <a href="#L51" title="db/db_impl.cc:51">CompactionState</a>::<a href="#L61" title="db/db_impl.cc:61">Output</a>&amp; out = compact-&gt;outputs[i];<br/></li>
<li>&nbsp; &nbsp; pending_outputs_.erase(out.number);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">delete</span> compact;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L757">&#x200c;</a><a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> <a href="#L116" title="db/db_impl.cc:116">DBImpl</a>::<span class="linkable">OpenCompactionOutputFile</span>(<a href="#L51" title="db/db_impl.cc:51">CompactionState</a>* compact) {<br/></li>
<li>&nbsp; assert(compact != <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; assert(compact-&gt;builder == <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; <span class="Type"><a href="../port/win/stdint.h.html#L22" title="port/win/stdint.h:22">uint64_t</a></span> file_number;<br/></li>
<li>&nbsp; {<br/></li>
<li>&nbsp; &nbsp; mutex_.<a href="../port/port_posix.cc.html#L26" title="port/port_posix.cc:26">Lock</a>();<br/></li>
<li>&nbsp; &nbsp; file_number = versions_-&gt;<a href="version_set.h.html#L191" title="db/version_set.h:191">NewFileNumber</a>();<br/></li>
<li>&nbsp; &nbsp; pending_outputs_.insert(file_number);<br/></li>
<li>&nbsp; &nbsp; <a href="#L51" title="db/db_impl.cc:51">CompactionState</a>::<a href="#L61" title="db/db_impl.cc:61">Output</a> out;<br/></li>
<li>&nbsp; &nbsp; out.number = file_number;<br/></li>
<li>&nbsp; &nbsp; out.smallest.<a href="write_batch.cc.html#L37" title="db/write_batch.cc:37">Clear</a>();<br/></li>
<li>&nbsp; &nbsp; out.largest.<a href="write_batch.cc.html#L37" title="db/write_batch.cc:37">Clear</a>();<br/></li>
<li>&nbsp; &nbsp; compact-&gt;outputs.push_back(out);<br/></li>
<li>&nbsp; &nbsp; mutex_.<a href="../port/port_posix.cc.html#L28" title="port/port_posix.cc:28">Unlock</a>();<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// Make the output file<br/></li>
<li></span>&nbsp; std::string fname = <a href="filename.cc.html#L32" title="db/filename.cc:32">TableFileName</a>(dbname_, file_number);<br/></li>
<li>&nbsp; <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> s = env_-&gt;<a href="../include/leveldb/env.h.html#L289" title="include/leveldb/env.h:289">NewWritableFile</a>(fname, &amp;compact-&gt;outfile);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (s.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>()) {<br/></li>
<li>&nbsp; &nbsp; compact-&gt;builder = <span class="Statement">new</span> <a href="../table/table_builder.cc.html#L63" title="table/table_builder.cc:63">TableBuilder</a>(options_, compact-&gt;outfile);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> s;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L782">&#x200c;</a><a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> <a href="#L116" title="db/db_impl.cc:116">DBImpl</a>::<span class="linkable">FinishCompactionOutputFile</span>(<a href="#L51" title="db/db_impl.cc:51">CompactionState</a>* compact,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../table/iterator.cc.html#L9" title="table/iterator.cc:9">Iterator</a>* <a href="version_set.h.html#L338" title="db/version_set.h:338">input</a>) {<br/></li>
<li>&nbsp; assert(compact != <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; assert(compact-&gt;outfile != <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; assert(compact-&gt;builder != <span class="Constant">NULL</span>);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type"><a href="../port/win/stdint.h.html#L22" title="port/win/stdint.h:22">uint64_t</a></span> output_number = compact-&gt;<a href="#L74" title="db/db_impl.cc:74">current_output</a>()-&gt;number;<br/></li>
<li>&nbsp; assert(output_number != <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// <a href="corruption_test.cc.html#L88" title="db/corruption_test.cc:88">Check</a> for iterator errors<br/></li>
<li></span>&nbsp; <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> s = <a href="version_set.h.html#L338" title="db/version_set.h:338">input</a>-&gt;<a href="../table/two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a>();<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type"><a href="../port/win/stdint.h.html#L22" title="port/win/stdint.h:22">uint64_t</a></span> current_entries = compact-&gt;builder-&gt;<a href="../table/table_builder.cc.html#L262" title="table/table_builder.cc:262">NumEntries</a>();<br/></li>
<li>&nbsp; <span class="Statement">if</span> (s.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>()) {<br/></li>
<li>&nbsp; &nbsp; s = compact-&gt;builder-&gt;<a href="../table/table_test.cc.html#L153" title="table/table_test.cc:153">Finish</a>();<br/></li>
<li>&nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; compact-&gt;builder-&gt;<a href="../table/table_builder.cc.html#L256" title="table/table_builder.cc:256">Abandon</a>();<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type"><a href="../port/win/stdint.h.html#L22" title="port/win/stdint.h:22">uint64_t</a></span> current_bytes = compact-&gt;builder-&gt;<a href="../table/table_builder.cc.html#L266" title="table/table_builder.cc:266">FileSize</a>();<br/></li>
<li>&nbsp; compact-&gt;<a href="#L74" title="db/db_impl.cc:74">current_output</a>()-&gt;file_size = current_bytes;<br/></li>
<li>&nbsp; compact-&gt;total_bytes += current_bytes;<br/></li>
<li>&nbsp; <span class="Statement">delete</span> compact-&gt;builder;<br/></li>
<li>&nbsp; compact-&gt;builder = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// <a href="../table/table_test.cc.html#L153" title="table/table_test.cc:153">Finish</a> and check for file errors<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (s.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>()) {<br/></li>
<li>&nbsp; &nbsp; s = compact-&gt;outfile-&gt;<a href="../table/table_test.cc.html#L98" title="table/table_test.cc:98">Sync</a>();<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">if</span> (s.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>()) {<br/></li>
<li>&nbsp; &nbsp; s = compact-&gt;outfile-&gt;<a href="../table/table_test.cc.html#L96" title="table/table_test.cc:96">Close</a>();<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">delete</span> compact-&gt;outfile;<br/></li>
<li>&nbsp; compact-&gt;outfile = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">if</span> (s.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>() &amp;&amp; current_entries &gt; <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// Verify that the table is usable<br/></li>
<li></span>&nbsp; &nbsp; <a href="../table/iterator.cc.html#L9" title="table/iterator.cc:9">Iterator</a>* <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a> = table_cache_-&gt;<a href="../table/table_test.cc.html#L209" title="table/table_test.cc:209">NewIterator</a>(<a href="../include/leveldb/options.h.html#L143" title="include/leveldb/options.h:143">ReadOptions</a>(),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; output_number,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; current_bytes);<br/></li>
<li>&nbsp; &nbsp; s = <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="../table/two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a>();<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">delete</span> <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (s.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>()) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../util/env.cc.html#L27" title="util/env.cc:27">Log</a>(options_.info_log,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;Generated table #</span><span class="Special">%llu</span><span class="Constant">: </span><span class="Special">%lld</span><span class="Constant"> keys, </span><span class="Special">%lld</span><span class="Constant"> bytes&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<span class="Type">unsigned</span> <span class="Type">long</span> <span class="Type">long</span>) output_number,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<span class="Type">unsigned</span> <span class="Type">long</span> <span class="Type">long</span>) current_entries,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<span class="Type">unsigned</span> <span class="Type">long</span> <span class="Type">long</span>) current_bytes);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> s;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L834">&#x200c;</a><a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> <a href="#L116" title="db/db_impl.cc:116">DBImpl</a>::<span class="linkable">InstallCompactionResults</span>(<a href="#L51" title="db/db_impl.cc:51">CompactionState</a>* compact) {<br/></li>
<li>&nbsp; mutex_.<a href="../port/port_posix.h.html#L89" title="port/port_posix.h:89">AssertHeld</a>();<br/></li>
<li>&nbsp; <a href="../util/env.cc.html#L27" title="util/env.cc:27">Log</a>(options_.info_log,&nbsp; <span class="Constant">&quot;Compacted </span><span class="Special">%d</span><span class="Constant">@</span><span class="Special">%d</span><span class="Constant"> + </span><span class="Special">%d</span><span class="Constant">@</span><span class="Special">%d</span><span class="Constant"> files =&gt; </span><span class="Special">%lld</span><span class="Constant"> bytes&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; compact-&gt;compaction-&gt;<a href="version_set.h.html#L335" title="db/version_set.h:335">num_input_files</a>(<span class="Constant">0</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; compact-&gt;compaction-&gt;<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>(),<br/></li>
<li>&nbsp; &nbsp; &nbsp; compact-&gt;compaction-&gt;<a href="version_set.h.html#L335" title="db/version_set.h:335">num_input_files</a>(<span class="Constant">1</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; compact-&gt;compaction-&gt;<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>() + <span class="Constant">1</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">static_cast</span>&lt;<span class="Type">long</span> <span class="Type">long</span>&gt;(compact-&gt;total_bytes));<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// <a href="../table/table_test.cc.html#L146" title="table/table_test.cc:146">Add</a> compaction outputs<br/></li>
<li></span>&nbsp; compact-&gt;compaction-&gt;<a href="version_set.cc.html#L1426" title="db/version_set.cc:1426">AddInputDeletions</a>(compact-&gt;compaction-&gt;<a href="version_set.h.html#L332" title="db/version_set.h:332">edit</a>());<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">int</span> <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> = compact-&gt;compaction-&gt;<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>();<br/></li>
<li>&nbsp; <span class="Statement">for</span> (<span class="Type">size_t</span> i = <span class="Constant">0</span>; i &lt; compact-&gt;outputs.<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>(); i++) {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <a href="#L51" title="db/db_impl.cc:51">CompactionState</a>::<a href="#L61" title="db/db_impl.cc:61">Output</a>&amp; out = compact-&gt;outputs[i];<br/></li>
<li>&nbsp; &nbsp; compact-&gt;compaction-&gt;<a href="version_set.h.html#L332" title="db/version_set.h:332">edit</a>()-&gt;<a href="version_edit.h.html#L62" title="db/version_edit.h:62">AddFile</a>(<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> + <span class="Constant">1</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; out.number, out.file_size, out.smallest, out.largest);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> versions_-&gt;<a href="version_set.cc.html#L811" title="db/version_set.cc:811">LogAndApply</a>(compact-&gt;compaction-&gt;<a href="version_set.h.html#L332" title="db/version_set.h:332">edit</a>(), &amp;mutex_);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L855">&#x200c;</a><a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> <a href="#L116" title="db/db_impl.cc:116">DBImpl</a>::<span class="linkable">DoCompactionWork</span>(<a href="#L51" title="db/db_impl.cc:51">CompactionState</a>* compact) {<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type"><a href="../port/win/stdint.h.html#L22" title="port/win/stdint.h:22">uint64_t</a></span> start_micros = env_-&gt;<a href="../include/leveldb/env.h.html#L321" title="include/leveldb/env.h:321">NowMicros</a>();<br/></li>
<li>&nbsp; <span class="Type"><a href="../port/win/stdint.h.html#L18" title="port/win/stdint.h:18">int64_t</a></span> imm_micros = <span class="Constant">0</span>;&nbsp; <span class="Comment">// Micros spent doing imm_ compactions<br/></li>
<li></span><br/></li>
<li>&nbsp; <a href="../util/env.cc.html#L27" title="util/env.cc:27">Log</a>(options_.info_log,&nbsp; <span class="Constant">&quot;Compacting </span><span class="Special">%d</span><span class="Constant">@</span><span class="Special">%d</span><span class="Constant"> + </span><span class="Special">%d</span><span class="Constant">@</span><span class="Special">%d</span><span class="Constant"> files&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; compact-&gt;compaction-&gt;<a href="version_set.h.html#L335" title="db/version_set.h:335">num_input_files</a>(<span class="Constant">0</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; compact-&gt;compaction-&gt;<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>(),<br/></li>
<li>&nbsp; &nbsp; &nbsp; compact-&gt;compaction-&gt;<a href="version_set.h.html#L335" title="db/version_set.h:335">num_input_files</a>(<span class="Constant">1</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; compact-&gt;compaction-&gt;<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>() + <span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; assert(versions_-&gt;<a href="version_set.cc.html#L1084" title="db/version_set.cc:1084">NumLevelFiles</a>(compact-&gt;compaction-&gt;<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>()) &gt; <span class="Constant">0</span>);<br/></li>
<li>&nbsp; assert(compact-&gt;builder == <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; assert(compact-&gt;outfile == <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (snapshots_.<a href="../table/block_builder.h.html#L38" title="table/block_builder.h:38">empty</a>()) {<br/></li>
<li>&nbsp; &nbsp; compact-&gt;smallest_snapshot = versions_-&gt;<a href="version_set.h.html#L209" title="db/version_set.h:209">LastSequence</a>();<br/></li>
<li>&nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; compact-&gt;smallest_snapshot = snapshots_.<a href="snapshot.h.html#L38" title="db/snapshot.h:38">oldest</a>()-&gt;number_;<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// <a href="../util/cache.cc.html#L220" title="util/cache.cc:220">Release</a> mutex while we're actually doing the compaction work<br/></li>
<li></span>&nbsp; mutex_.<a href="../port/port_posix.cc.html#L28" title="port/port_posix.cc:28">Unlock</a>();<br/></li>
<li><br/></li>
<li>&nbsp; <a href="../table/iterator.cc.html#L9" title="table/iterator.cc:9">Iterator</a>* <a href="version_set.h.html#L338" title="db/version_set.h:338">input</a> = versions_-&gt;<a href="version_set.cc.html#L1210" title="db/version_set.cc:1210">MakeInputIterator</a>(compact-&gt;compaction);<br/></li>
<li>&nbsp; <a href="version_set.h.html#L338" title="db/version_set.h:338">input</a>-&gt;<a href="../table/two_level_iterator.cc.html#L98" title="table/two_level_iterator.cc:98">SeekToFirst</a>();<br/></li>
<li>&nbsp; <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> <a href="../table/two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a>;<br/></li>
<li>&nbsp; <a href="dbformat.h.html#L70" title="db/dbformat.h:70">ParsedInternalKey</a> ikey;<br/></li>
<li>&nbsp; std::string current_user_key;<br/></li>
<li>&nbsp; <span class="Type">bool</span> has_current_user_key = <span class="Constant">false</span>;<br/></li>
<li>&nbsp; <a href="dbformat.h.html#L63" title="db/dbformat.h:63">SequenceNumber</a> last_sequence_for_key = kMaxSequenceNumber;<br/></li>
<li>&nbsp; <span class="Statement">for</span> (; <a href="version_set.h.html#L338" title="db/version_set.h:338">input</a>-&gt;<a href="../table/two_level_iterator.cc.html#L34" title="table/two_level_iterator.cc:34">Valid</a>() &amp;&amp; !shutting_down_.<a href="../port/atomic_pointer.h.html#L116" title="port/atomic_pointer.h:116">Acquire_Load</a>(); ) {<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// Prioritize immutable compaction work<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (has_imm_.<a href="../port/atomic_pointer.h.html#L114" title="port/atomic_pointer.h:114">NoBarrier_Load</a>() != <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Type">const</span> <span class="Type"><a href="../port/win/stdint.h.html#L22" title="port/win/stdint.h:22">uint64_t</a></span> imm_start = env_-&gt;<a href="../include/leveldb/env.h.html#L321" title="include/leveldb/env.h:321">NowMicros</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; mutex_.<a href="../port/port_posix.cc.html#L26" title="port/port_posix.cc:26">Lock</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (imm_ != <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L503" title="db/db_impl.cc:503">CompactMemTable</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; bg_cv_.<a href="../port/port_posix.cc.html#L45" title="port/port_posix.cc:45">SignalAll</a>();&nbsp; <span class="Comment">// Wakeup <a href="#L1286" title="db/db_impl.cc:1286">MakeRoomForWrite</a>() if necessary<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; mutex_.<a href="../port/port_posix.cc.html#L28" title="port/port_posix.cc:28">Unlock</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; imm_micros += (env_-&gt;<a href="../include/leveldb/env.h.html#L321" title="include/leveldb/env.h:321">NowMicros</a>() - imm_start);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a> <a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a> = <a href="version_set.h.html#L338" title="db/version_set.h:338">input</a>-&gt;<a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>();<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (compact-&gt;compaction-&gt;<a href="version_set.cc.html#L1455" title="db/version_set.cc:1455">ShouldStopBefore</a>(<a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>) &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; compact-&gt;builder != <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../table/two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a> = <a href="#L782" title="db/db_impl.cc:782">FinishCompactionOutputFile</a>(compact, <a href="version_set.h.html#L338" title="db/version_set.h:338">input</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!<a href="../table/two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a>.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>()) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// <a href="../include/leveldb/cache.h.html#L41" title="include/leveldb/cache.h:41">Handle</a> <a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>/<a href="../table/two_level_iterator.cc.html#L41" title="table/two_level_iterator.cc:41">value</a>, add to state, etc.<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">bool</span> drop = <span class="Constant">false</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!<a href="dbformat.h.html#L176" title="db/dbformat.h:176">ParseInternalKey</a>(<a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>, &amp;ikey)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Comment">// Do not hide error keys<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; current_user_key.<a href="../include/leveldb/slice.h.html#L56" title="include/leveldb/slice.h:56">clear</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; has_current_user_key = <span class="Constant">false</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; last_sequence_for_key = kMaxSequenceNumber;<br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!has_current_user_key ||<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="db_impl.h.html#L197" title="db/db_impl.h:197">user_comparator</a>()-&gt;<a href="../table/table_test.cc.html#L44" title="table/table_test.cc:44">Compare</a>(ikey.<a href="dbformat.h.html#L159" title="db/dbformat.h:159">user_key</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>(current_user_key)) != <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">// First occurrence of this user <a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a><br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; current_user_key.assign(ikey.<a href="dbformat.h.html#L159" title="db/dbformat.h:159">user_key</a>.<a href="../table/table_test.cc.html#L173" title="table/table_test.cc:173">data</a>(), ikey.<a href="dbformat.h.html#L159" title="db/dbformat.h:159">user_key</a>.<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>());<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; has_current_user_key = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; last_sequence_for_key = kMaxSequenceNumber;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (last_sequence_for_key &lt;= compact-&gt;smallest_snapshot) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">// Hidden by an newer entry for same user <a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a><br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; drop = <span class="Constant">true</span>;&nbsp; &nbsp; <span class="Comment">// (A)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (ikey.type == kTypeDeletion &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ikey.sequence &lt;= compact-&gt;smallest_snapshot &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; compact-&gt;compaction-&gt;<a href="version_set.cc.html#L1434" title="db/version_set.cc:1434">IsBaseLevelForKey</a>(ikey.<a href="dbformat.h.html#L159" title="db/dbformat.h:159">user_key</a>)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">// For this user <a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>:<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">// (1) there is no <a href="../table/table_test.cc.html#L173" title="table/table_test.cc:173">data</a> in higher levels<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">// (2) <a href="../table/table_test.cc.html#L173" title="table/table_test.cc:173">data</a> in lower levels will have larger sequence numbers<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">// (3) <a href="../table/table_test.cc.html#L173" title="table/table_test.cc:173">data</a> in layers that are being compacted here and have<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">//&nbsp; &nbsp;&nbsp; smaller sequence numbers will be dropped in the next<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">//&nbsp; &nbsp;&nbsp; few iterations of this loop (by rule (A) above).<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">// Therefore this deletion marker is obsolete and can be dropped.<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; drop = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; last_sequence_for_key = ikey.sequence;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><span class="Comment">#if 0<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; <a href="../util/env.cc.html#L27" title="util/env.cc:27">Log</a>(options_.info_log,<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &quot;&nbsp; <a href="db_test.cc.html#L424" title="db/db_test.cc:424">Compact</a>: %s, seq %d, type: %d %d, drop: %d, is_base: %d, &quot;<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &quot;%d smallest_snapshot: %d&quot;,<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; ikey.<a href="dbformat.h.html#L159" title="db/dbformat.h:159">user_key</a>.<a href="../table/table_test.cc.html#L587" title="table/table_test.cc:587">ToString</a>().c_str(),<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; (int)ikey.sequence, ikey.type, kTypeValue, drop,<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; compact-&gt;compaction-&gt;<a href="version_set.cc.html#L1434" title="db/version_set.cc:1434">IsBaseLevelForKey</a>(ikey.<a href="dbformat.h.html#L159" title="db/dbformat.h:159">user_key</a>),<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; (int)last_sequence_for_key, (int)compact-&gt;smallest_snapshot);<br/></li>
<li></span><span class="Comment">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!drop) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Comment">// <a href="../table/table.cc.html#L38" title="table/table.cc:38">Open</a> output file if necessary<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (compact-&gt;builder == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../table/two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a> = <a href="#L757" title="db/db_impl.cc:757">OpenCompactionOutputFile</a>(compact);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!<a href="../table/two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a>.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>()) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (compact-&gt;builder-&gt;<a href="../table/table_builder.cc.html#L262" title="table/table_builder.cc:262">NumEntries</a>() == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; compact-&gt;<a href="#L74" title="db/db_impl.cc:74">current_output</a>()-&gt;smallest.<a href="../table/format.cc.html#L23" title="table/format.cc:23">DecodeFrom</a>(<a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; compact-&gt;<a href="#L74" title="db/db_impl.cc:74">current_output</a>()-&gt;largest.<a href="../table/format.cc.html#L23" title="table/format.cc:23">DecodeFrom</a>(<a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; compact-&gt;builder-&gt;<a href="../table/table_test.cc.html#L146" title="table/table_test.cc:146">Add</a>(<a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>, <a href="version_set.h.html#L338" title="db/version_set.h:338">input</a>-&gt;<a href="../table/two_level_iterator.cc.html#L41" title="table/two_level_iterator.cc:41">value</a>());<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Comment">// <a href="../table/table_test.cc.html#L96" title="table/table_test.cc:96">Close</a> output file if it is big enough<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (compact-&gt;builder-&gt;<a href="../table/table_builder.cc.html#L266" title="table/table_builder.cc:266">FileSize</a>() &gt;=<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; compact-&gt;compaction-&gt;<a href="version_set.h.html#L341" title="db/version_set.h:341">MaxOutputFileSize</a>()) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../table/two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a> = <a href="#L782" title="db/db_impl.cc:782">FinishCompactionOutputFile</a>(compact, <a href="version_set.h.html#L338" title="db/version_set.h:338">input</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!<a href="../table/two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a>.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>()) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="version_set.h.html#L338" title="db/version_set.h:338">input</a>-&gt;<a href="../table/two_level_iterator.cc.html#L112" title="table/two_level_iterator.cc:112">Next</a>();<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="../table/two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a>.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>() &amp;&amp; shutting_down_.<a href="../port/atomic_pointer.h.html#L116" title="port/atomic_pointer.h:116">Acquire_Load</a>()) {<br/></li>
<li>&nbsp; &nbsp; <a href="../table/two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a> = <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a>::<a href="../include/leveldb/status.h.html#L47" title="include/leveldb/status.h:47">IOError</a>(<span class="Constant">&quot;Deleting <a href="../include/leveldb/db.h.html#L55" title="include/leveldb/db.h:55">DB</a> during compaction&quot;</span>);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="../table/two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a>.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>() &amp;&amp; compact-&gt;builder != <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; <a href="../table/two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a> = <a href="#L782" title="db/db_impl.cc:782">FinishCompactionOutputFile</a>(compact, <a href="version_set.h.html#L338" title="db/version_set.h:338">input</a>);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="../table/two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a>.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>()) {<br/></li>
<li>&nbsp; &nbsp; <a href="../table/two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a> = <a href="version_set.h.html#L338" title="db/version_set.h:338">input</a>-&gt;<a href="../table/two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a>();<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">delete</span> <a href="version_set.h.html#L338" title="db/version_set.h:338">input</a>;<br/></li>
<li>&nbsp; <a href="version_set.h.html#L338" title="db/version_set.h:338">input</a> = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; <a href="db_impl.h.html#L178" title="db/db_impl.h:178">CompactionStats</a> stats;<br/></li>
<li>&nbsp; stats.micros = env_-&gt;<a href="../include/leveldb/env.h.html#L321" title="include/leveldb/env.h:321">NowMicros</a>() - start_micros - imm_micros;<br/></li>
<li>&nbsp; <span class="Statement">for</span> (<span class="Type">int</span> which = <span class="Constant">0</span>; which &lt; <span class="Constant">2</span>; which++) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (<span class="Type">int</span> i = <span class="Constant">0</span>; i &lt; compact-&gt;compaction-&gt;<a href="version_set.h.html#L335" title="db/version_set.h:335">num_input_files</a>(which); i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; stats.bytes_read += compact-&gt;compaction-&gt;<a href="version_set.h.html#L338" title="db/version_set.h:338">input</a>(which, i)-&gt;file_size;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">for</span> (<span class="Type">size_t</span> i = <span class="Constant">0</span>; i &lt; compact-&gt;outputs.<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>(); i++) {<br/></li>
<li>&nbsp; &nbsp; stats.bytes_written += compact-&gt;outputs[i].file_size;<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; mutex_.<a href="../port/port_posix.cc.html#L26" title="port/port_posix.cc:26">Lock</a>();<br/></li>
<li>&nbsp; stats_[compact-&gt;compaction-&gt;<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>() + <span class="Constant">1</span>].<a href="../table/table_test.cc.html#L146" title="table/table_test.cc:146">Add</a>(stats);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="../table/two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a>.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>()) {<br/></li>
<li>&nbsp; &nbsp; <a href="../table/two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a> = <a href="#L834" title="db/db_impl.cc:834">InstallCompactionResults</a>(compact);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">if</span> (!<a href="../table/two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a>.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>()) {<br/></li>
<li>&nbsp; &nbsp; <a href="#L606" title="db/db_impl.cc:606">RecordBackgroundError</a>(<a href="../table/two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a>);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <a href="version_set.cc.html#L766" title="db/version_set.cc:766">VersionSet</a>::<a href="version_set.h.html#L266" title="db/version_set.h:266">LevelSummaryStorage</a> tmp;<br/></li>
<li>&nbsp; <a href="../util/env.cc.html#L27" title="util/env.cc:27">Log</a>(options_.info_log,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">&quot;compacted to: </span><span class="Special">%s</span><span class="Constant">&quot;</span>, versions_-&gt;<a href="version_set.cc.html#L1090" title="db/version_set.cc:1090">LevelSummary</a>(&amp;tmp));<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="../table/two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Type">namespace</span> {<br/></li>
<li><a id="L1017">&#x200c;</a><span class="Type">struct</span> <span class="linkable">IterState</span> {<br/></li>
<li>&nbsp; port::<a href="../port/port_posix.cc.html#L22" title="port/port_posix.cc:22">Mutex</a>* mu;<br/></li>
<li>&nbsp; <a href="version_set.h.html#L150" title="db/version_set.h:150">Version</a>* version;<br/></li>
<li>&nbsp; <a href="memtable.cc.html#L21" title="db/memtable.cc:21">MemTable</a>* mem;<br/></li>
<li>&nbsp; <a href="memtable.cc.html#L21" title="db/memtable.cc:21">MemTable</a>* imm;<br/></li>
<li>};<br/></li>
<li><br/></li>
<li><a id="L1024">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">CleanupIteratorState</span>(<span class="Type">void</span>* arg1, <span class="Type">void</span>* arg2) {<br/></li>
<li>&nbsp; <a href="#L1017" title="db/db_impl.cc:1017">IterState</a>* state = <span class="Statement">reinterpret_cast</span>&lt;<a href="#L1017" title="db/db_impl.cc:1017">IterState</a>*&gt;(arg1);<br/></li>
<li>&nbsp; state-&gt;mu-&gt;<a href="../port/port_posix.cc.html#L26" title="port/port_posix.cc:26">Lock</a>();<br/></li>
<li>&nbsp; state-&gt;mem-&gt;<a href="version_set.cc.html#L477" title="db/version_set.cc:477">Unref</a>();<br/></li>
<li>&nbsp; <span class="Statement">if</span> (state-&gt;imm != <span class="Constant">NULL</span>) state-&gt;imm-&gt;<a href="version_set.cc.html#L477" title="db/version_set.cc:477">Unref</a>();<br/></li>
<li>&nbsp; state-&gt;version-&gt;<a href="version_set.cc.html#L477" title="db/version_set.cc:477">Unref</a>();<br/></li>
<li>&nbsp; state-&gt;mu-&gt;<a href="../port/port_posix.cc.html#L28" title="port/port_posix.cc:28">Unlock</a>();<br/></li>
<li>&nbsp; <span class="Statement">delete</span> state;<br/></li>
<li>}<br/></li>
<li>}&nbsp; <span class="Comment">// namespace<br/></li>
<li></span><br/></li>
<li><a id="L1035">&#x200c;</a><a href="../table/iterator.cc.html#L9" title="table/iterator.cc:9">Iterator</a>* <a href="#L116" title="db/db_impl.cc:116">DBImpl</a>::<span class="linkable">NewInternalIterator</span>(<span class="Type">const</span> <a href="../include/leveldb/options.h.html#L143" title="include/leveldb/options.h:143">ReadOptions</a>&amp; options,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="dbformat.h.html#L63" title="db/dbformat.h:63">SequenceNumber</a>* latest_snapshot,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type"><a href="../port/win/stdint.h.html#L21" title="port/win/stdint.h:21">uint32_t</a></span>* seed) {<br/></li>
<li>&nbsp; <a href="#L1017" title="db/db_impl.cc:1017">IterState</a>* cleanup = <span class="Statement">new</span> <a href="#L1017" title="db/db_impl.cc:1017">IterState</a>;<br/></li>
<li>&nbsp; mutex_.<a href="../port/port_posix.cc.html#L26" title="port/port_posix.cc:26">Lock</a>();<br/></li>
<li>&nbsp; *latest_snapshot = versions_-&gt;<a href="version_set.h.html#L209" title="db/version_set.h:209">LastSequence</a>();<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// Collect together all needed child iterators<br/></li>
<li></span>&nbsp; std::vector&lt;<a href="../table/iterator.cc.html#L9" title="table/iterator.cc:9">Iterator</a>*&gt; list;<br/></li>
<li>&nbsp; list.push_back(mem_-&gt;<a href="../table/table_test.cc.html#L209" title="table/table_test.cc:209">NewIterator</a>());<br/></li>
<li>&nbsp; mem_-&gt;<a href="version_set.cc.html#L473" title="db/version_set.cc:473">Ref</a>();<br/></li>
<li>&nbsp; <span class="Statement">if</span> (imm_ != <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; list.push_back(imm_-&gt;<a href="../table/table_test.cc.html#L209" title="table/table_test.cc:209">NewIterator</a>());<br/></li>
<li>&nbsp; &nbsp; imm_-&gt;<a href="version_set.cc.html#L473" title="db/version_set.cc:473">Ref</a>();<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; versions_-&gt;<a href="version_set.h.html#L185" title="db/version_set.h:185">current</a>()-&gt;<a href="version_set.cc.html#L225" title="db/version_set.cc:225">AddIterators</a>(options, &amp;list);<br/></li>
<li>&nbsp; <a href="../table/iterator.cc.html#L9" title="table/iterator.cc:9">Iterator</a>* internal_iter =<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../table/merger.cc.html#L186" title="table/merger.cc:186">NewMergingIterator</a>(&amp;internal_comparator_, &amp;list[<span class="Constant">0</span>], list.<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>());<br/></li>
<li>&nbsp; versions_-&gt;<a href="version_set.h.html#L185" title="db/version_set.h:185">current</a>()-&gt;<a href="version_set.cc.html#L473" title="db/version_set.cc:473">Ref</a>();<br/></li>
<li><br/></li>
<li>&nbsp; cleanup-&gt;mu = &amp;mutex_;<br/></li>
<li>&nbsp; cleanup-&gt;mem = mem_;<br/></li>
<li>&nbsp; cleanup-&gt;imm = imm_;<br/></li>
<li>&nbsp; cleanup-&gt;version = versions_-&gt;<a href="version_set.h.html#L185" title="db/version_set.h:185">current</a>();<br/></li>
<li>&nbsp; internal_iter-&gt;<a href="../table/iterator.cc.html#L26" title="table/iterator.cc:26">RegisterCleanup</a>(<a href="#L1024" title="db/db_impl.cc:1024">CleanupIteratorState</a>, cleanup, <span class="Constant">NULL</span>);<br/></li>
<li><br/></li>
<li>&nbsp; *seed = ++seed_;<br/></li>
<li>&nbsp; mutex_.<a href="../port/port_posix.cc.html#L28" title="port/port_posix.cc:28">Unlock</a>();<br/></li>
<li>&nbsp; <span class="Statement">return</span> internal_iter;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1066">&#x200c;</a><a href="../table/iterator.cc.html#L9" title="table/iterator.cc:9">Iterator</a>* <a href="#L116" title="db/db_impl.cc:116">DBImpl</a>::<span class="linkable">TEST_NewInternalIterator</span>() {<br/></li>
<li>&nbsp; <a href="dbformat.h.html#L63" title="db/dbformat.h:63">SequenceNumber</a> ignored;<br/></li>
<li>&nbsp; <span class="Type"><a href="../port/win/stdint.h.html#L21" title="port/win/stdint.h:21">uint32_t</a></span> ignored_seed;<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="#L1035" title="db/db_impl.cc:1035">NewInternalIterator</a>(<a href="../include/leveldb/options.h.html#L143" title="include/leveldb/options.h:143">ReadOptions</a>(), &amp;ignored, &amp;ignored_seed);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1072">&#x200c;</a><span class="Type"><a href="../port/win/stdint.h.html#L18" title="port/win/stdint.h:18">int64_t</a></span> <a href="#L116" title="db/db_impl.cc:116">DBImpl</a>::<span class="linkable">TEST_MaxNextLevelOverlappingBytes</span>() {<br/></li>
<li>&nbsp; MutexLock l(&amp;mutex_);<br/></li>
<li>&nbsp; <span class="Statement">return</span> versions_-&gt;<a href="version_set.cc.html#L1156" title="db/version_set.cc:1156">MaxNextLevelOverlappingBytes</a>();<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1077">&#x200c;</a><a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> <a href="#L116" title="db/db_impl.cc:116">DBImpl</a>::<span class="linkable">Get</span>(<span class="Type">const</span> <a href="../include/leveldb/options.h.html#L143" title="include/leveldb/options.h:143">ReadOptions</a>&amp; options,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type">const</span> <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>&amp; <a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; std::string* <a href="../table/two_level_iterator.cc.html#L41" title="table/two_level_iterator.cc:41">value</a>) {<br/></li>
<li>&nbsp; <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> s;<br/></li>
<li>&nbsp; MutexLock l(&amp;mutex_);<br/></li>
<li>&nbsp; <a href="dbformat.h.html#L63" title="db/dbformat.h:63">SequenceNumber</a> snapshot;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (options.snapshot != <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; snapshot = <span class="Statement">reinterpret_cast</span>&lt;<span class="Type">const</span> SnapshotImpl*&gt;(options.snapshot)-&gt;number_;<br/></li>
<li>&nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; snapshot = versions_-&gt;<a href="version_set.h.html#L209" title="db/version_set.h:209">LastSequence</a>();<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <a href="memtable.cc.html#L21" title="db/memtable.cc:21">MemTable</a>* mem = mem_;<br/></li>
<li>&nbsp; <a href="memtable.cc.html#L21" title="db/memtable.cc:21">MemTable</a>* imm = imm_;<br/></li>
<li>&nbsp; <a href="version_set.h.html#L150" title="db/version_set.h:150">Version</a>* <a href="version_set.h.html#L185" title="db/version_set.h:185">current</a> = versions_-&gt;<a href="version_set.h.html#L185" title="db/version_set.h:185">current</a>();<br/></li>
<li>&nbsp; mem-&gt;<a href="version_set.cc.html#L473" title="db/version_set.cc:473">Ref</a>();<br/></li>
<li>&nbsp; <span class="Statement">if</span> (imm != <span class="Constant">NULL</span>) imm-&gt;<a href="version_set.cc.html#L473" title="db/version_set.cc:473">Ref</a>();<br/></li>
<li>&nbsp; <a href="version_set.h.html#L185" title="db/version_set.h:185">current</a>-&gt;<a href="version_set.cc.html#L473" title="db/version_set.cc:473">Ref</a>();<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Type">bool</span> have_stat_update = <span class="Constant">false</span>;<br/></li>
<li>&nbsp; <a href="version_set.h.html#L150" title="db/version_set.h:150">Version</a>::<a href="version_set.h.html#L69" title="db/version_set.h:69">GetStats</a> stats;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// <a href="../port/port_posix.cc.html#L28" title="port/port_posix.cc:28">Unlock</a> while reading from files and memtables<br/></li>
<li></span>&nbsp; {<br/></li>
<li>&nbsp; &nbsp; mutex_.<a href="../port/port_posix.cc.html#L28" title="port/port_posix.cc:28">Unlock</a>();<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// First look in the memtable, then in the immutable memtable (if any).<br/></li>
<li></span>&nbsp; &nbsp; <a href="dbformat.cc.html#L121" title="db/dbformat.cc:121">LookupKey</a> lkey(<a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>, snapshot);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (mem-&gt;<a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(lkey, <a href="../table/two_level_iterator.cc.html#L41" title="table/two_level_iterator.cc:41">value</a>, &amp;s)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Comment">// Done<br/></li>
<li></span>&nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (imm != <span class="Constant">NULL</span> &amp;&amp; imm-&gt;<a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(lkey, <a href="../table/two_level_iterator.cc.html#L41" title="table/two_level_iterator.cc:41">value</a>, &amp;s)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Comment">// Done<br/></li>
<li></span>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; s = <a href="version_set.h.html#L185" title="db/version_set.h:185">current</a>-&gt;<a href="version_set.cc.html#L323" title="db/version_set.cc:323">Get</a>(options, lkey, <a href="../table/two_level_iterator.cc.html#L41" title="table/two_level_iterator.cc:41">value</a>, &amp;stats);<br/></li>
<li>&nbsp; &nbsp; &nbsp; have_stat_update = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; mutex_.<a href="../port/port_posix.cc.html#L26" title="port/port_posix.cc:26">Lock</a>();<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">if</span> (have_stat_update &amp;&amp; <a href="version_set.h.html#L185" title="db/version_set.h:185">current</a>-&gt;<a href="version_set.cc.html#L422" title="db/version_set.cc:422">UpdateStats</a>(stats)) {<br/></li>
<li>&nbsp; &nbsp; <a href="#L614" title="db/db_impl.cc:614">MaybeScheduleCompaction</a>();<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; mem-&gt;<a href="version_set.cc.html#L477" title="db/version_set.cc:477">Unref</a>();<br/></li>
<li>&nbsp; <span class="Statement">if</span> (imm != <span class="Constant">NULL</span>) imm-&gt;<a href="version_set.cc.html#L477" title="db/version_set.cc:477">Unref</a>();<br/></li>
<li>&nbsp; <a href="version_set.h.html#L185" title="db/version_set.h:185">current</a>-&gt;<a href="version_set.cc.html#L477" title="db/version_set.cc:477">Unref</a>();<br/></li>
<li>&nbsp; <span class="Statement">return</span> s;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1124">&#x200c;</a><a href="../table/iterator.cc.html#L9" title="table/iterator.cc:9">Iterator</a>* <a href="#L116" title="db/db_impl.cc:116">DBImpl</a>::<span class="linkable">NewIterator</span>(<span class="Type">const</span> <a href="../include/leveldb/options.h.html#L143" title="include/leveldb/options.h:143">ReadOptions</a>&amp; options) {<br/></li>
<li>&nbsp; <a href="dbformat.h.html#L63" title="db/dbformat.h:63">SequenceNumber</a> latest_snapshot;<br/></li>
<li>&nbsp; <span class="Type"><a href="../port/win/stdint.h.html#L21" title="port/win/stdint.h:21">uint32_t</a></span> seed;<br/></li>
<li>&nbsp; <a href="../table/iterator.cc.html#L9" title="table/iterator.cc:9">Iterator</a>* <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a> = <a href="#L1035" title="db/db_impl.cc:1035">NewInternalIterator</a>(options, &amp;latest_snapshot, &amp;seed);<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="db_iter.cc.html#L308" title="db/db_iter.cc:308">NewDBIterator</a>(<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">this</span>, <a href="db_impl.h.html#L197" title="db/db_impl.h:197">user_comparator</a>(), <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; (options.snapshot != <span class="Constant">NULL<br/></li>
<li></span>&nbsp; &nbsp; &nbsp;&nbsp; ? <span class="Statement">reinterpret_cast</span>&lt;<span class="Type">const</span> SnapshotImpl*&gt;(options.snapshot)-&gt;number_<br/></li>
<li>&nbsp; &nbsp; &nbsp;&nbsp; : latest_snapshot),<br/></li>
<li>&nbsp; &nbsp; &nbsp; seed);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1136">&#x200c;</a><span class="Type">void</span> <a href="#L116" title="db/db_impl.cc:116">DBImpl</a>::<span class="linkable">RecordReadSample</span>(<a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a> <a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>) {<br/></li>
<li>&nbsp; MutexLock l(&amp;mutex_);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (versions_-&gt;<a href="version_set.h.html#L185" title="db/version_set.h:185">current</a>()-&gt;<a href="version_set.cc.html#L435" title="db/version_set.cc:435">RecordReadSample</a>(<a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>)) {<br/></li>
<li>&nbsp; &nbsp; <a href="#L614" title="db/db_impl.cc:614">MaybeScheduleCompaction</a>();<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1143">&#x200c;</a><span class="Type">const</span> Snapshot* <a href="#L116" title="db/db_impl.cc:116">DBImpl</a>::<span class="linkable">GetSnapshot</span>() {<br/></li>
<li>&nbsp; MutexLock l(&amp;mutex_);<br/></li>
<li>&nbsp; <span class="Statement">return</span> snapshots_.<a href="snapshot.h.html#L41" title="db/snapshot.h:41">New</a>(versions_-&gt;<a href="version_set.h.html#L209" title="db/version_set.h:209">LastSequence</a>());<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1148">&#x200c;</a><span class="Type">void</span> <a href="#L116" title="db/db_impl.cc:116">DBImpl</a>::<span class="linkable">ReleaseSnapshot</span>(<span class="Type">const</span> Snapshot* s) {<br/></li>
<li>&nbsp; MutexLock l(&amp;mutex_);<br/></li>
<li>&nbsp; snapshots_.<a href="write_batch.cc.html#L105" title="db/write_batch.cc:105">Delete</a>(<span class="Statement">reinterpret_cast</span>&lt;<span class="Type">const</span> SnapshotImpl*&gt;(s));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">// Convenience methods<br/></li>
<li><a id="L1154">&#x200c;</a></span><a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> <a href="#L116" title="db/db_impl.cc:116">DBImpl</a>::<span class="linkable">Put</span>(<span class="Type">const</span> <a href="../include/leveldb/options.h.html#L169" title="include/leveldb/options.h:169">WriteOptions</a>&amp; o, <span class="Type">const</span> <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>&amp; <a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>, <span class="Type">const</span> <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>&amp; val) {<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="../include/leveldb/db.h.html#L55" title="include/leveldb/db.h:55">DB</a>::<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(o, <a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>, val);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1158">&#x200c;</a><a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> <a href="#L116" title="db/db_impl.cc:116">DBImpl</a>::<span class="linkable">Delete</span>(<span class="Type">const</span> <a href="../include/leveldb/options.h.html#L169" title="include/leveldb/options.h:169">WriteOptions</a>&amp; options, <span class="Type">const</span> <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>&amp; <a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>) {<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="../include/leveldb/db.h.html#L55" title="include/leveldb/db.h:55">DB</a>::<a href="write_batch.cc.html#L105" title="db/write_batch.cc:105">Delete</a>(options, <a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1162">&#x200c;</a><a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> <a href="#L116" title="db/db_impl.cc:116">DBImpl</a>::<span class="linkable">Write</span>(<span class="Type">const</span> <a href="../include/leveldb/options.h.html#L169" title="include/leveldb/options.h:169">WriteOptions</a>&amp; options, <a href="write_batch.cc.html#L29" title="db/write_batch.cc:29">WriteBatch</a>* my_batch) {<br/></li>
<li>&nbsp; <a href="#L41" title="db/db_impl.cc:41">Writer</a> w(&amp;mutex_);<br/></li>
<li>&nbsp; w.batch = my_batch;<br/></li>
<li>&nbsp; w.sync = options.sync;<br/></li>
<li>&nbsp; w.done = <span class="Constant">false</span>;<br/></li>
<li><br/></li>
<li>&nbsp; MutexLock l(&amp;mutex_);<br/></li>
<li>&nbsp; writers_.push_back(&amp;w);<br/></li>
<li>&nbsp; <span class="Statement">while</span> (!w.done &amp;&amp; &amp;w != writers_.front()) {<br/></li>
<li>&nbsp; &nbsp; w.cv.<a href="skiplist_test.cc.html#L315" title="db/skiplist_test.cc:315">Wait</a>();<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">if</span> (w.done) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> w.<a href="../table/two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a>;<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// May temporarily unlock and wait.<br/></li>
<li></span>&nbsp; <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> <a href="../table/two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a> = <a href="#L1286" title="db/db_impl.cc:1286">MakeRoomForWrite</a>(my_batch == <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; <span class="Type"><a href="../port/win/stdint.h.html#L22" title="port/win/stdint.h:22">uint64_t</a></span> last_sequence = versions_-&gt;<a href="version_set.h.html#L209" title="db/version_set.h:209">LastSequence</a>();<br/></li>
<li>&nbsp; <a href="#L41" title="db/db_impl.cc:41">Writer</a>* last_writer = &amp;w;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="../table/two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a>.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>() &amp;&amp; my_batch != <span class="Constant">NULL</span>) {&nbsp; <span class="Comment">// NULL batch is for compactions<br/></li>
<li></span>&nbsp; &nbsp; <a href="write_batch.cc.html#L29" title="db/write_batch.cc:29">WriteBatch</a>* updates = <a href="#L1237" title="db/db_impl.cc:1237">BuildBatchGroup</a>(&amp;last_writer);<br/></li>
<li>&nbsp; &nbsp; WriteBatchInternal::<a href="write_batch.cc.html#L94" title="db/write_batch.cc:94">SetSequence</a>(updates, last_sequence + <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; last_sequence += WriteBatchInternal::<a href="write_batch.cc.html#L82" title="db/write_batch.cc:82">Count</a>(updates);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// <a href="../table/table_test.cc.html#L146" title="table/table_test.cc:146">Add</a> to log and apply to memtable.&nbsp; We can release the lock<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">// during this <a href="c_test.c.html#L14" title="db/c_test.c:14">phase</a> since &amp;w is currently responsible for logging<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">// and protects against concurrent loggers and concurrent writes<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">// into mem_.<br/></li>
<li></span>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; mutex_.<a href="../port/port_posix.cc.html#L28" title="port/port_posix.cc:28">Unlock</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../table/two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a> = log_-&gt;<a href="log_writer.cc.html#L27" title="db/log_writer.cc:27">AddRecord</a>(WriteBatchInternal::<a href="write_batch_internal.h.html#L31" title="db/write_batch_internal.h:31">Contents</a>(updates));<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Type">bool</span> sync_error = <span class="Constant">false</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../table/two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a>.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>() &amp;&amp; options.sync) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../table/two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a> = logfile_-&gt;<a href="../table/table_test.cc.html#L98" title="table/table_test.cc:98">Sync</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!<a href="../table/two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a>.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>()) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sync_error = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../table/two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a>.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>()) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../table/two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a> = WriteBatchInternal::<a href="write_batch.cc.html#L128" title="db/write_batch.cc:128">InsertInto</a>(updates, mem_);<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; mutex_.<a href="../port/port_posix.cc.html#L26" title="port/port_posix.cc:26">Lock</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (sync_error) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">// The state of the log file is indeterminate: the log record we<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">// just added may or may not show up when the <a href="../include/leveldb/db.h.html#L55" title="include/leveldb/db.h:55">DB</a> is re-opened.<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">// So we force the <a href="../include/leveldb/db.h.html#L55" title="include/leveldb/db.h:55">DB</a> into a mode where all future writes fail.<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L606" title="db/db_impl.cc:606">RecordBackgroundError</a>(<a href="../table/two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (updates == tmp_batch_) tmp_batch_-&gt;<a href="write_batch.cc.html#L37" title="db/write_batch.cc:37">Clear</a>();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; versions_-&gt;<a href="version_set.h.html#L212" title="db/version_set.h:212">SetLastSequence</a>(last_sequence);<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">while</span> (<span class="Constant">true</span>) {<br/></li>
<li>&nbsp; &nbsp; <a href="#L41" title="db/db_impl.cc:41">Writer</a>* ready = writers_.front();<br/></li>
<li>&nbsp; &nbsp; writers_.pop_front();<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ready != &amp;w) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; ready-&gt;<a href="../table/two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a> = <a href="../table/two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; ready-&gt;done = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; ready-&gt;cv.<a href="../port/port_posix.cc.html#L41" title="port/port_posix.cc:41">Signal</a>();<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ready == last_writer) <span class="Statement">break</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// Notify new head of write queue<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (!writers_.<a href="../table/block_builder.h.html#L38" title="table/block_builder.h:38">empty</a>()) {<br/></li>
<li>&nbsp; &nbsp; writers_.front()-&gt;cv.<a href="../port/port_posix.cc.html#L41" title="port/port_posix.cc:41">Signal</a>();<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="../table/two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">// REQUIRES: <a href="#L41" title="db/db_impl.cc:41">Writer</a> list must be non-<a href="../table/block_builder.h.html#L38" title="table/block_builder.h:38">empty</a><br/></li>
<li></span><span class="Comment">// REQUIRES: First writer must have a non-NULL batch<br/></li>
<li><a id="L1237">&#x200c;</a></span><a href="write_batch.cc.html#L29" title="db/write_batch.cc:29">WriteBatch</a>* <a href="#L116" title="db/db_impl.cc:116">DBImpl</a>::<span class="linkable">BuildBatchGroup</span>(<a href="#L41" title="db/db_impl.cc:41">Writer</a>** last_writer) {<br/></li>
<li>&nbsp; assert(!writers_.<a href="../table/block_builder.h.html#L38" title="table/block_builder.h:38">empty</a>());<br/></li>
<li>&nbsp; <a href="#L41" title="db/db_impl.cc:41">Writer</a>* first = writers_.front();<br/></li>
<li>&nbsp; <a href="write_batch.cc.html#L29" title="db/write_batch.cc:29">WriteBatch</a>* result = first-&gt;batch;<br/></li>
<li>&nbsp; assert(result != <span class="Constant">NULL</span>);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Type">size_t</span> <a href="../table/format.h.html#L31" title="table/format.h:31">size</a> = WriteBatchInternal::<a href="write_batch_internal.h.html#L35" title="db/write_batch_internal.h:35">ByteSize</a>(first-&gt;batch);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// Allow the group to grow up to a maximum <a href="../table/format.h.html#L31" title="table/format.h:31">size</a>, but if the<br/></li>
<li></span>&nbsp; <span class="Comment">// original write is small, limit the growth so we do not slow<br/></li>
<li></span>&nbsp; <span class="Comment">// down the small write too much.<br/></li>
<li></span>&nbsp; <span class="Type">size_t</span> max_size = <span class="Constant">1</span> &lt;&lt; <span class="Constant">20</span>;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="../table/format.h.html#L31" title="table/format.h:31">size</a> &lt;= (<span class="Constant">128</span>&lt;&lt;<span class="Constant">10</span>)) {<br/></li>
<li>&nbsp; &nbsp; max_size = <a href="../table/format.h.html#L31" title="table/format.h:31">size</a> + (<span class="Constant">128</span>&lt;&lt;<span class="Constant">10</span>);<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; *last_writer = first;<br/></li>
<li>&nbsp; std::deque&lt;<a href="#L41" title="db/db_impl.cc:41">Writer</a>*&gt;::iterator <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a> = writers_.begin();<br/></li>
<li>&nbsp; ++<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>;&nbsp; <span class="Comment">// Advance past &quot;first&quot;<br/></li>
<li></span>&nbsp; <span class="Statement">for</span> (; <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a> != writers_.end(); ++<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>) {<br/></li>
<li>&nbsp; &nbsp; <a href="#L41" title="db/db_impl.cc:41">Writer</a>* w = *<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (w-&gt;sync &amp;&amp; !first-&gt;sync) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Comment">// Do not include a sync write into a batch handled by a non-sync write.<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (w-&gt;batch != <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../table/format.h.html#L31" title="table/format.h:31">size</a> += WriteBatchInternal::<a href="write_batch_internal.h.html#L35" title="db/write_batch_internal.h:35">ByteSize</a>(w-&gt;batch);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../table/format.h.html#L31" title="table/format.h:31">size</a> &gt; max_size) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">// Do not make batch too big<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Comment">// <a href="../table/table_test.cc.html#L100" title="table/table_test.cc:100">Append</a> to *result<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (result == first-&gt;batch) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">// Switch to temporary batch instead of disturbing caller's batch<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; result = tmp_batch_;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; assert(WriteBatchInternal::<a href="write_batch.cc.html#L82" title="db/write_batch.cc:82">Count</a>(result) == <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; WriteBatchInternal::<a href="../table/table_test.cc.html#L100" title="table/table_test.cc:100">Append</a>(result, first-&gt;batch);<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; WriteBatchInternal::<a href="../table/table_test.cc.html#L100" title="table/table_test.cc:100">Append</a>(result, w-&gt;batch);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; *last_writer = w;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> result;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">// REQUIRES: mutex_ is held<br/></li>
<li></span><span class="Comment">// REQUIRES: this thread is currently at the front of the writer queue<br/></li>
<li><a id="L1286">&#x200c;</a></span><a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> <a href="#L116" title="db/db_impl.cc:116">DBImpl</a>::<span class="linkable">MakeRoomForWrite</span>(<span class="Type">bool</span> force) {<br/></li>
<li>&nbsp; mutex_.<a href="../port/port_posix.h.html#L89" title="port/port_posix.h:89">AssertHeld</a>();<br/></li>
<li>&nbsp; assert(!writers_.<a href="../table/block_builder.h.html#L38" title="table/block_builder.h:38">empty</a>());<br/></li>
<li>&nbsp; <span class="Type">bool</span> allow_delay = !force;<br/></li>
<li>&nbsp; <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> s;<br/></li>
<li>&nbsp; <span class="Statement">while</span> (<span class="Constant">true</span>) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!bg_error_.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>()) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Comment">// Yield previous error<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; s = bg_error_;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; allow_delay &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; versions_-&gt;<a href="version_set.cc.html#L1084" title="db/version_set.cc:1084">NumLevelFiles</a>(<span class="Constant">0</span>) &gt;= config::kL0_SlowdownWritesTrigger) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Comment">// We are getting close to hitting a hard limit on the number of<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Comment">// L0 files.&nbsp; Rather than delaying a single write by several<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Comment">// seconds when we hit the hard limit, start delaying each<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Comment">// individual write by 1ms to reduce latency variance.&nbsp; Also,<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Comment">// this delay hands over some CPU to the compaction thread in<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Comment">// case it is sharing the same core as the writer.<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; mutex_.<a href="../port/port_posix.cc.html#L28" title="port/port_posix.cc:28">Unlock</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; env_-&gt;<a href="../include/leveldb/env.h.html#L324" title="include/leveldb/env.h:324">SleepForMicroseconds</a>(<span class="Constant">1000</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; allow_delay = <span class="Constant">false</span>;&nbsp; <span class="Comment">// Do not delay a single write more than once<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; mutex_.<a href="../port/port_posix.cc.html#L26" title="port/port_posix.cc:26">Lock</a>();<br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (!force &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (mem_-&gt;<a href="memtable.cc.html#L31" title="db/memtable.cc:31">ApproximateMemoryUsage</a>() &lt;= options_.write_buffer_size)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Comment">// There is room in <a href="version_set.h.html#L185" title="db/version_set.h:185">current</a> memtable<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (imm_ != <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Comment">// We have filled up the <a href="version_set.h.html#L185" title="db/version_set.h:185">current</a> memtable, but the previous<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Comment">// one is still being compacted, so we wait.<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <a href="../util/env.cc.html#L27" title="util/env.cc:27">Log</a>(options_.info_log, <span class="Constant">&quot;Current memtable full; waiting...</span><span class="Special">\n</span><span class="Constant">&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; bg_cv_.<a href="skiplist_test.cc.html#L315" title="db/skiplist_test.cc:315">Wait</a>();<br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (versions_-&gt;<a href="version_set.cc.html#L1084" title="db/version_set.cc:1084">NumLevelFiles</a>(<span class="Constant">0</span>) &gt;= config::kL0_StopWritesTrigger) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Comment">// There are too many <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>-0 files.<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <a href="../util/env.cc.html#L27" title="util/env.cc:27">Log</a>(options_.info_log, <span class="Constant">&quot;Too many L0 files; waiting...</span><span class="Special">\n</span><span class="Constant">&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; bg_cv_.<a href="skiplist_test.cc.html#L315" title="db/skiplist_test.cc:315">Wait</a>();<br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Comment">// Attempt to switch to a new memtable and trigger compaction of old<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; assert(versions_-&gt;<a href="version_set.h.html#L225" title="db/version_set.h:225">PrevLogNumber</a>() == <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Type"><a href="../port/win/stdint.h.html#L22" title="port/win/stdint.h:22">uint64_t</a></span> new_log_number = versions_-&gt;<a href="version_set.h.html#L191" title="db/version_set.h:191">NewFileNumber</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../include/leveldb/env.h.html#L214" title="include/leveldb/env.h:214">WritableFile</a>* lfile = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; s = env_-&gt;<a href="../include/leveldb/env.h.html#L289" title="include/leveldb/env.h:289">NewWritableFile</a>(<a href="filename.cc.html#L27" title="db/filename.cc:27">LogFileName</a>(dbname_, new_log_number), &amp;lfile);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!s.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>()) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">// Avoid chewing through file number space in a tight loop.<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; versions_-&gt;<a href="version_set.h.html#L196" title="db/version_set.h:196">ReuseFileNumber</a>(new_log_number);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">delete</span> log_;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">delete</span> logfile_;<br/></li>
<li>&nbsp; &nbsp; &nbsp; logfile_ = lfile;<br/></li>
<li>&nbsp; &nbsp; &nbsp; logfile_number_ = new_log_number;<br/></li>
<li>&nbsp; &nbsp; &nbsp; log_ = <span class="Statement">new</span> log::<a href="#L41" title="db/db_impl.cc:41">Writer</a>(lfile);<br/></li>
<li>&nbsp; &nbsp; &nbsp; imm_ = mem_;<br/></li>
<li>&nbsp; &nbsp; &nbsp; has_imm_.<a href="../port/atomic_pointer.h.html#L121" title="port/atomic_pointer.h:121">Release_Store</a>(imm_);<br/></li>
<li>&nbsp; &nbsp; &nbsp; mem_ = <span class="Statement">new</span> <a href="memtable.cc.html#L21" title="db/memtable.cc:21">MemTable</a>(internal_comparator_);<br/></li>
<li>&nbsp; &nbsp; &nbsp; mem_-&gt;<a href="version_set.cc.html#L473" title="db/version_set.cc:473">Ref</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; force = <span class="Constant">false</span>;&nbsp;&nbsp; <span class="Comment">// Do not force another compaction if have room<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <a href="#L614" title="db/db_impl.cc:614">MaybeScheduleCompaction</a>();<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> s;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1349">&#x200c;</a><span class="Type">bool</span> <a href="#L116" title="db/db_impl.cc:116">DBImpl</a>::<span class="linkable">GetProperty</span>(<span class="Type">const</span> <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>&amp; property, std::string* <a href="../table/two_level_iterator.cc.html#L41" title="table/two_level_iterator.cc:41">value</a>) {<br/></li>
<li>&nbsp; <a href="../table/two_level_iterator.cc.html#L41" title="table/two_level_iterator.cc:41">value</a>-&gt;<a href="../include/leveldb/slice.h.html#L56" title="include/leveldb/slice.h:56">clear</a>();<br/></li>
<li><br/></li>
<li>&nbsp; MutexLock l(&amp;mutex_);<br/></li>
<li>&nbsp; <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a> in = property;<br/></li>
<li>&nbsp; <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a> prefix(<span class="Constant">&quot;leveldb.&quot;</span>);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (!in.<a href="../include/leveldb/slice.h.html#L75" title="include/leveldb/slice.h:75">starts_with</a>(prefix)) <span class="Statement">return</span> <span class="Constant">false</span>;<br/></li>
<li>&nbsp; in.<a href="../include/leveldb/slice.h.html#L59" title="include/leveldb/slice.h:59">remove_prefix</a>(prefix.<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>());<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">if</span> (in.<a href="../include/leveldb/slice.h.html#L75" title="include/leveldb/slice.h:75">starts_with</a>(<span class="Constant">&quot;num-files-at-<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>&quot;</span>)) {<br/></li>
<li>&nbsp; &nbsp; in.<a href="../include/leveldb/slice.h.html#L59" title="include/leveldb/slice.h:59">remove_prefix</a>(strlen(<span class="Constant">&quot;num-files-at-<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>&quot;</span>));<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../port/win/stdint.h.html#L22" title="port/win/stdint.h:22">uint64_t</a></span> <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">bool</span> <a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a> = <a href="../util/logging.cc.html#L48" title="util/logging.cc:48">ConsumeDecimalNumber</a>(&amp;in, &amp;<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>) &amp;&amp; in.<a href="../table/block_builder.h.html#L38" title="table/block_builder.h:38">empty</a>();<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a> || <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> &gt;= config::kNumLevels) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">false</span>;<br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Type">char</span> buf[<span class="Constant">100</span>];<br/></li>
<li>&nbsp; &nbsp; &nbsp; snprintf(buf, <span class="Statement">sizeof</span>(buf), <span class="Constant">&quot;</span><span class="Special">%d</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; versions_-&gt;<a href="version_set.cc.html#L1084" title="db/version_set.cc:1084">NumLevelFiles</a>(<span class="Statement">static_cast</span>&lt;<span class="Type">int</span>&gt;(<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>)));<br/></li>
<li>&nbsp; &nbsp; &nbsp; *<a href="../table/two_level_iterator.cc.html#L41" title="table/two_level_iterator.cc:41">value</a> = buf;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (in == <span class="Constant">&quot;stats&quot;</span>) {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span> buf[<span class="Constant">200</span>];<br/></li>
<li>&nbsp; &nbsp; snprintf(buf, <span class="Statement">sizeof</span>(buf),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; Compactions</span><span class="Special">\n</span><span class="Constant">&quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;Level&nbsp; Files <a href="../table/table_test.cc.html#L118" title="table/table_test.cc:118">Size</a>(MB) Time(sec) <a href="../table/table_test.cc.html#L120" title="table/table_test.cc:120">Read</a>(MB) <a href="log_test.cc.html#L121" title="db/log_test.cc:121">Write</a>(MB)</span><span class="Special">\n</span><span class="Constant">&quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;--------------------------------------------------</span><span class="Special">\n</span><span class="Constant">&quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; );<br/></li>
<li>&nbsp; &nbsp; <a href="../table/two_level_iterator.cc.html#L41" title="table/two_level_iterator.cc:41">value</a>-&gt;append(buf);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (<span class="Type">int</span> <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> = <span class="Constant">0</span>; <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> &lt; config::kNumLevels; <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Type">int</span> files = versions_-&gt;<a href="version_set.cc.html#L1084" title="db/version_set.cc:1084">NumLevelFiles</a>(<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (stats_[<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>].micros &gt; <span class="Constant">0</span> || files &gt; <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; snprintf(<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; buf, <span class="Statement">sizeof</span>(buf),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;</span><span class="Special">%3d</span><span class="Constant"> </span><span class="Special">%8d</span><span class="Constant"> </span><span class="Special">%8.0f</span><span class="Constant"> </span><span class="Special">%9.0f</span><span class="Constant"> </span><span class="Special">%8.0f</span><span class="Constant"> </span><span class="Special">%9.0f\n</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; files,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; versions_-&gt;<a href="version_set.cc.html#L1150" title="db/version_set.cc:1150">NumLevelBytes</a>(<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>) / <span class="Constant">1048576.0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; stats_[<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>].micros / <span class="Constant">1e6</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; stats_[<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>].bytes_read / <span class="Constant">1048576.0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; stats_[<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>].bytes_written / <span class="Constant">1048576.0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../table/two_level_iterator.cc.html#L41" title="table/two_level_iterator.cc:41">value</a>-&gt;append(buf);<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">true</span>;<br/></li>
<li>&nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (in == <span class="Constant">&quot;sstables&quot;</span>) {<br/></li>
<li>&nbsp; &nbsp; *<a href="../table/two_level_iterator.cc.html#L41" title="table/two_level_iterator.cc:41">value</a> = versions_-&gt;<a href="version_set.h.html#L185" title="db/version_set.h:185">current</a>()-&gt;<a href="version_set.cc.html#L565" title="db/version_set.cc:565">DebugString</a>();<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">true</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">return</span> <span class="Constant">false</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1403">&#x200c;</a><span class="Type">void</span> <a href="#L116" title="db/db_impl.cc:116">DBImpl</a>::<span class="linkable">GetApproximateSizes</span>(<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <a href="../include/leveldb/db.h.html#L33" title="include/leveldb/db.h:33">Range</a>* range, <span class="Type">int</span> n,<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../port/win/stdint.h.html#L22" title="port/win/stdint.h:22">uint64_t</a></span>* sizes) {<br/></li>
<li>&nbsp; <span class="Comment">// </span><span class="Todo">TODO</span><span class="Comment">(opt): better implementation<br/></li>
<li></span>&nbsp; <a href="version_set.h.html#L150" title="db/version_set.h:150">Version</a>* v;<br/></li>
<li>&nbsp; {<br/></li>
<li>&nbsp; &nbsp; MutexLock l(&amp;mutex_);<br/></li>
<li>&nbsp; &nbsp; versions_-&gt;<a href="version_set.h.html#L185" title="db/version_set.h:185">current</a>()-&gt;<a href="version_set.cc.html#L473" title="db/version_set.cc:473">Ref</a>();<br/></li>
<li>&nbsp; &nbsp; v = versions_-&gt;<a href="version_set.h.html#L185" title="db/version_set.h:185">current</a>();<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">for</span> (<span class="Type">int</span> i = <span class="Constant">0</span>; i &lt; n; i++) {<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// Convert <a href="dbformat.h.html#L159" title="db/dbformat.h:159">user_key</a> into a corresponding internal <a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>.<br/></li>
<li></span>&nbsp; &nbsp; <a href="dbformat.h.html#L148" title="db/dbformat.h:148">InternalKey</a> k1(range[i].start, kMaxSequenceNumber, kValueTypeForSeek);<br/></li>
<li>&nbsp; &nbsp; <a href="dbformat.h.html#L148" title="db/dbformat.h:148">InternalKey</a> k2(range[i].limit, kMaxSequenceNumber, kValueTypeForSeek);<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../port/win/stdint.h.html#L22" title="port/win/stdint.h:22">uint64_t</a></span> start = versions_-&gt;<a href="../table/table_test.cc.html#L257" title="table/table_test.cc:257">ApproximateOffsetOf</a>(v, k1);<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../port/win/stdint.h.html#L22" title="port/win/stdint.h:22">uint64_t</a></span> limit = versions_-&gt;<a href="../table/table_test.cc.html#L257" title="table/table_test.cc:257">ApproximateOffsetOf</a>(v, k2);<br/></li>
<li>&nbsp; &nbsp; sizes[i] = (limit &gt;= start ? limit - start : <span class="Constant">0</span>);<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; {<br/></li>
<li>&nbsp; &nbsp; MutexLock l(&amp;mutex_);<br/></li>
<li>&nbsp; &nbsp; v-&gt;<a href="version_set.cc.html#L477" title="db/version_set.cc:477">Unref</a>();<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">// <a href="../util/env_posix.cc.html#L600" title="util/env_posix.cc:600">Default</a> implementations of convenience methods that subclasses of <a href="../include/leveldb/db.h.html#L55" title="include/leveldb/db.h:55">DB</a><br/></li>
<li></span><span class="Comment">// can call if they wish<br/></li>
<li><a id="L1431">&#x200c;</a></span><a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> <a href="../include/leveldb/db.h.html#L55" title="include/leveldb/db.h:55">DB</a>::<span class="linkable">Put</span>(<span class="Type">const</span> <a href="../include/leveldb/options.h.html#L169" title="include/leveldb/options.h:169">WriteOptions</a>&amp; opt, <span class="Type">const</span> <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>&amp; <a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>, <span class="Type">const</span> <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>&amp; <a href="../table/two_level_iterator.cc.html#L41" title="table/two_level_iterator.cc:41">value</a>) {<br/></li>
<li>&nbsp; <a href="write_batch.cc.html#L29" title="db/write_batch.cc:29">WriteBatch</a> batch;<br/></li>
<li>&nbsp; batch.<a href="write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(<a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>, <a href="../table/two_level_iterator.cc.html#L41" title="table/two_level_iterator.cc:41">value</a>);<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="log_test.cc.html#L121" title="db/log_test.cc:121">Write</a>(opt, &amp;batch);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1437">&#x200c;</a><a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> <a href="../include/leveldb/db.h.html#L55" title="include/leveldb/db.h:55">DB</a>::<span class="linkable">Delete</span>(<span class="Type">const</span> <a href="../include/leveldb/options.h.html#L169" title="include/leveldb/options.h:169">WriteOptions</a>&amp; opt, <span class="Type">const</span> <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>&amp; <a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>) {<br/></li>
<li>&nbsp; <a href="write_batch.cc.html#L29" title="db/write_batch.cc:29">WriteBatch</a> batch;<br/></li>
<li>&nbsp; batch.<a href="write_batch.cc.html#L105" title="db/write_batch.cc:105">Delete</a>(<a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>);<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="log_test.cc.html#L121" title="db/log_test.cc:121">Write</a>(opt, &amp;batch);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1443">&#x200c;</a><a href="../include/leveldb/db.h.html#L55" title="include/leveldb/db.h:55">DB</a>::~<a href="../include/leveldb/db.h.html#L55" title="include/leveldb/db.h:55">DB</a>() { }<br/></li>
<li><br/></li>
<li><a id="L1445">&#x200c;</a><a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> <a href="../include/leveldb/db.h.html#L55" title="include/leveldb/db.h:55">DB</a>::<span class="linkable">Open</span>(<span class="Type">const</span> <a href="../include/leveldb/options.h.html#L31" title="include/leveldb/options.h:31">Options</a>&amp; options, <span class="Type">const</span> std::string&amp; <a href="c_test.c.html#L15" title="db/c_test.c:15">dbname</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../include/leveldb/db.h.html#L55" title="include/leveldb/db.h:55">DB</a>** dbptr) {<br/></li>
<li>&nbsp; *dbptr = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; <a href="#L116" title="db/db_impl.cc:116">DBImpl</a>* impl = <span class="Statement">new</span> <a href="#L116" title="db/db_impl.cc:116">DBImpl</a>(options, <a href="c_test.c.html#L15" title="db/c_test.c:15">dbname</a>);<br/></li>
<li>&nbsp; impl-&gt;mutex_.<a href="../port/port_posix.cc.html#L26" title="port/port_posix.cc:26">Lock</a>();<br/></li>
<li>&nbsp; <a href="version_edit.h.html#L30" title="db/version_edit.h:30">VersionEdit</a> <a href="version_set.h.html#L332" title="db/version_set.h:332">edit</a>;<br/></li>
<li>&nbsp; <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> s = impl-&gt;<a href="version_set.cc.html#L896" title="db/version_set.cc:896">Recover</a>(&amp;<a href="version_set.h.html#L332" title="db/version_set.h:332">edit</a>); <span class="Comment">// Handles create_if_missing, error_if_exists<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (s.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>()) {<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../port/win/stdint.h.html#L22" title="port/win/stdint.h:22">uint64_t</a></span> new_log_number = impl-&gt;versions_-&gt;<a href="version_set.h.html#L191" title="db/version_set.h:191">NewFileNumber</a>();<br/></li>
<li>&nbsp; &nbsp; <a href="../include/leveldb/env.h.html#L214" title="include/leveldb/env.h:214">WritableFile</a>* lfile;<br/></li>
<li>&nbsp; &nbsp; s = options.env-&gt;<a href="../include/leveldb/env.h.html#L289" title="include/leveldb/env.h:289">NewWritableFile</a>(<a href="filename.cc.html#L27" title="db/filename.cc:27">LogFileName</a>(<a href="c_test.c.html#L15" title="db/c_test.c:15">dbname</a>, new_log_number),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;lfile);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (s.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>()) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="version_set.h.html#L332" title="db/version_set.h:332">edit</a>.<a href="version_edit.h.html#L39" title="db/version_edit.h:39">SetLogNumber</a>(new_log_number);<br/></li>
<li>&nbsp; &nbsp; &nbsp; impl-&gt;logfile_ = lfile;<br/></li>
<li>&nbsp; &nbsp; &nbsp; impl-&gt;logfile_number_ = new_log_number;<br/></li>
<li>&nbsp; &nbsp; &nbsp; impl-&gt;log_ = <span class="Statement">new</span> log::<a href="#L41" title="db/db_impl.cc:41">Writer</a>(lfile);<br/></li>
<li>&nbsp; &nbsp; &nbsp; s = impl-&gt;versions_-&gt;<a href="version_set.cc.html#L811" title="db/version_set.cc:811">LogAndApply</a>(&amp;<a href="version_set.h.html#L332" title="db/version_set.h:332">edit</a>, &amp;impl-&gt;mutex_);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (s.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>()) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; impl-&gt;<a href="#L218" title="db/db_impl.cc:218">DeleteObsoleteFiles</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; impl-&gt;<a href="#L614" title="db/db_impl.cc:614">MaybeScheduleCompaction</a>();<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; impl-&gt;mutex_.<a href="../port/port_posix.cc.html#L28" title="port/port_posix.cc:28">Unlock</a>();<br/></li>
<li>&nbsp; <span class="Statement">if</span> (s.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>()) {<br/></li>
<li>&nbsp; &nbsp; *dbptr = impl;<br/></li>
<li>&nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">delete</span> impl;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> s;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1479">&#x200c;</a>Snapshot::~Snapshot() {<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1482">&#x200c;</a><a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> <span class="linkable">DestroyDB</span>(<span class="Type">const</span> std::string&amp; <a href="c_test.c.html#L15" title="db/c_test.c:15">dbname</a>, <span class="Type">const</span> <a href="../include/leveldb/options.h.html#L31" title="include/leveldb/options.h:31">Options</a>&amp; options) {<br/></li>
<li>&nbsp; <a href="../include/leveldb/env.h.html#L33" title="include/leveldb/env.h:33">Env</a>* env = options.env;<br/></li>
<li>&nbsp; std::vector&lt;std::string&gt; filenames;<br/></li>
<li>&nbsp; <span class="Comment">// Ignore error in case directory does not exist<br/></li>
<li></span>&nbsp; env-&gt;<a href="../include/leveldb/env.h.html#L293" title="include/leveldb/env.h:293">GetChildren</a>(<a href="c_test.c.html#L15" title="db/c_test.c:15">dbname</a>, &amp;filenames);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (filenames.<a href="../table/block_builder.h.html#L38" title="table/block_builder.h:38">empty</a>()) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a>::<a href="../include/leveldb/status.h.html#L32" title="include/leveldb/status.h:32">OK</a>();<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <a href="../include/leveldb/env.h.html#L247" title="include/leveldb/env.h:247">FileLock</a>* lock;<br/></li>
<li>&nbsp; <span class="Type">const</span> std::string lockname = <a href="filename.cc.html#L54" title="db/filename.cc:54">LockFileName</a>(<a href="c_test.c.html#L15" title="db/c_test.c:15">dbname</a>);<br/></li>
<li>&nbsp; <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> result = env-&gt;<a href="../include/leveldb/env.h.html#L305" title="include/leveldb/env.h:305">LockFile</a>(lockname, &amp;lock);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (result.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>()) {<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../port/win/stdint.h.html#L22" title="port/win/stdint.h:22">uint64_t</a></span> number;<br/></li>
<li>&nbsp; &nbsp; <a href="filename.h.html#L20" title="db/filename.h:20">FileType</a> type;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (<span class="Type">size_t</span> i = <span class="Constant">0</span>; i &lt; filenames.<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>(); i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="filename.cc.html#L80" title="db/filename.cc:80">ParseFileName</a>(filenames[i], &amp;number, &amp;type) &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; type != kDBLockFile) {&nbsp; <span class="Comment">// <a href="../port/port_posix.cc.html#L26" title="port/port_posix.cc:26">Lock</a> file will be deleted at end<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> del = env-&gt;<a href="../include/leveldb/env.h.html#L296" title="include/leveldb/env.h:296">DeleteFile</a>(<a href="c_test.c.html#L15" title="db/c_test.c:15">dbname</a> + <span class="Constant">&quot;/&quot;</span> + filenames[i]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (result.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>() &amp;&amp; !del.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>()) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; result = del;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; env-&gt;<a href="../include/leveldb/env.h.html#L308" title="include/leveldb/env.h:308">UnlockFile</a>(lock);&nbsp; <span class="Comment">// Ignore error since state is already gone<br/></li>
<li></span>&nbsp; &nbsp; env-&gt;<a href="../include/leveldb/env.h.html#L296" title="include/leveldb/env.h:296">DeleteFile</a>(lockname);<br/></li>
<li>&nbsp; &nbsp; env-&gt;<a href="../include/leveldb/env.h.html#L298" title="include/leveldb/env.h:298">DeleteDir</a>(<a href="c_test.c.html#L15" title="db/c_test.c:15">dbname</a>);&nbsp; <span class="Comment">// Ignore error in case dir contains other files<br/></li>
<li></span>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> result;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li>}&nbsp; <span class="Comment">// namespace leveldb<br/></li>
</ol></span></code>
 </body>
</html>
