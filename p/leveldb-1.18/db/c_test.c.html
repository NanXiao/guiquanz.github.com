<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>db/c_test.c - leveldb-1.18</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

code {
    font-family: consolas, monospace;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
  <h3>db/c_test.c - leveldb-1.18</h3>
   <a href="../index.html"> Table of Contents </a>
 <h4>Global variables defined</h4>
 <ul>
<li><a href="#L15">dbname</a></li>
<li><a href="#L133">fake_filter_result</a></li>
<li><a href="#L14">phase</a></li>
</ul>
 <h4>Functions defined</h4>
 <ul>
<li><a href="#L108">CheckDel</a></li>
<li><a href="#L41">CheckEqual</a></li>
<li><a href="#L64">CheckGet</a></li>
<li><a href="#L78">CheckIter</a></li>
<li><a href="#L89">CheckPut</a></li>
<li><a href="#L117">CmpCompare</a></li>
<li><a href="#L115">CmpDestroy</a></li>
<li><a href="#L128">CmpName</a></li>
<li><a href="#L138">FilterCreate</a></li>
<li><a href="#L134">FilterDestroy</a></li>
<li><a href="#L148">FilterKeyMatch</a></li>
<li><a href="#L135">FilterName</a></li>
<li><a href="#L57">Free</a></li>
<li><a href="#L22">GetTempDir</a></li>
<li><a href="#L17">StartPhase</a></li>
<li><a href="#L157">main</a></li>
</ul>
 <h4>Macros defined</h4>
 <ul>
<li><a href="#L35">CheckCondition</a></li>
<li><a href="#L29">CheckNoError</a></li>
</ul>
 <h4>Source code</h4>

  <code><ol><li><span class="Comment">/* Copyright (c) 2011 The LevelDB Authors. All rights reserved.<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; Use of this source <a href="../include/leveldb/status.h.html#L84" title="include/leveldb/status.h:84">code</a> is governed by a BSD-style license that can be<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; found in the LICENSE file. See the AUTHORS file for names of contributors. */<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;leveldb/c.h&quot;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;stddef.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;stdio.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;stdlib.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;string.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;sys/types.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;unistd.h&gt;<br/></li>
<li></span><br/></li>
<li><a id="L14">&#x200c;</a><span class="Type">const</span> <span class="Type">char</span>* <span class="linkable">phase</span> = <span class="Constant">&quot;&quot;</span>;<br/></li>
<li><a id="L15">&#x200c;</a><span class="Type">static</span> <span class="Type">char</span> <span class="linkable">dbname</span>[<span class="Constant">200</span>];<br/></li>
<li><br/></li>
<li><a id="L17">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">StartPhase</span>(<span class="Type">const</span> <span class="Type">char</span>* name) {<br/></li>
<li>&nbsp; fprintf(<span class="Constant">stderr</span>, <span class="Constant">&quot;=== <a href="../table/table_test.cc.html#L477" title="table/table_test.cc:477">Test</a> </span><span class="Special">%s\n</span><span class="Constant">&quot;</span>, name);<br/></li>
<li>&nbsp; <a href="#L14" title="db/c_test.c:14">phase</a> = name;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L22">&#x200c;</a><span class="Type">static</span> <span class="Type">const</span> <span class="Type">char</span>* <span class="linkable">GetTempDir</span>(<span class="Type">void</span>) {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span>* ret = getenv(<span class="Constant">&quot;TEST_TMPDIR&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ret == <span class="Constant">NULL</span> || ret[<span class="Constant">0</span>] == <span class="Special">'\0'</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ret = <span class="Constant">&quot;/tmp&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> ret;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L29">&#x200c;</a><span class="PreProc">#define <span class="linkable">CheckNoError</span>(err)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; </span><span class="Statement">if</span><span class="PreProc"> ((err) != </span><span class="Constant">NULL</span><span class="PreProc">) {&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; fprintf(</span><span class="Constant">stderr</span><span class="PreProc">, </span><span class="Constant">&quot;</span><span class="Special">%s</span><span class="Constant">:</span><span class="Special">%d</span><span class="Constant">: </span><span class="Special">%s</span><span class="Constant">: </span><span class="Special">%s\n</span><span class="Constant">&quot;</span><span class="PreProc">, </span><span class="Constant">__FILE__</span><span class="PreProc">, </span><span class="Constant">__LINE__</span><span class="PreProc">, <a href="#L14" title="db/c_test.c:14">phase</a>, (err)); \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; abort();&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; }<br/></li>
<li></span><br/></li>
<li><a id="L35">&#x200c;</a><span class="PreProc">#define <span class="linkable">CheckCondition</span>(cond)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; </span><span class="Statement">if</span><span class="PreProc"> (!(cond)) {&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; fprintf(</span><span class="Constant">stderr</span><span class="PreProc">, </span><span class="Constant">&quot;</span><span class="Special">%s</span><span class="Constant">:</span><span class="Special">%d</span><span class="Constant">: </span><span class="Special">%s</span><span class="Constant">: </span><span class="Special">%s\n</span><span class="Constant">&quot;</span><span class="PreProc">, </span><span class="Constant">__FILE__</span><span class="PreProc">, </span><span class="Constant">__LINE__</span><span class="PreProc">, <a href="#L14" title="db/c_test.c:14">phase</a>, #cond); \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; abort();&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; }<br/></li>
<li></span><br/></li>
<li><a id="L41">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">CheckEqual</span>(<span class="Type">const</span> <span class="Type">char</span>* expected, <span class="Type">const</span> <span class="Type">char</span>* v, <span class="Type">size_t</span> n) {<br/></li>
<li>&nbsp; <span class="Statement">if</span> (expected == <span class="Constant">NULL</span> &amp;&amp; v == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// <a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a><br/></li>
<li></span>&nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (expected != <span class="Constant">NULL</span> &amp;&amp; v != <span class="Constant">NULL</span> &amp;&amp; n == strlen(expected) &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; memcmp(expected, v, n) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// <a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a><br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; fprintf(<span class="Constant">stderr</span>, <span class="Constant">&quot;</span><span class="Special">%s</span><span class="Constant">: expected '</span><span class="Special">%s</span><span class="Constant">', got '</span><span class="Special">%s</span><span class="Constant">'</span><span class="Special">\n</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L14" title="db/c_test.c:14">phase</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (expected ? expected : <span class="Constant">&quot;(null)&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (v ? v : <span class="Constant">&quot;(null&quot;</span>));<br/></li>
<li>&nbsp; &nbsp; abort();<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L57">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">Free</span>(<span class="Type">char</span>** ptr) {<br/></li>
<li>&nbsp; <span class="Statement">if</span> (*ptr) {<br/></li>
<li>&nbsp; &nbsp; free(*ptr);<br/></li>
<li>&nbsp; &nbsp; *ptr = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L64">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">CheckGet</span>(<br/></li>
<li>&nbsp; &nbsp; <a href="c.cc.html#L46" title="db/c.cc:46">leveldb_t</a>* <a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a>,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <a href="c.cc.html#L50" title="db/c.cc:50">leveldb_readoptions_t</a>* options,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span>* <a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span>* expected) {<br/></li>
<li>&nbsp; <span class="Type">char</span>* err = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; <span class="Type">size_t</span> val_len;<br/></li>
<li>&nbsp; <span class="Type">char</span>* val;<br/></li>
<li>&nbsp; val = <a href="c.cc.html#L197" title="db/c.cc:197">leveldb_get</a>(<a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a>, options, <a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>, strlen(<a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>), &amp;val_len, &amp;err);<br/></li>
<li>&nbsp; <a href="#L29" title="db/c_test.c:29">CheckNoError</a>(err);<br/></li>
<li>&nbsp; <a href="#L41" title="db/c_test.c:41">CheckEqual</a>(expected, val, val_len);<br/></li>
<li>&nbsp; <a href="#L57" title="db/c_test.c:57">Free</a>(&amp;val);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L78">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">CheckIter</span>(<a href="c.cc.html#L47" title="db/c.cc:47">leveldb_iterator_t</a>* <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span>* <a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>, <span class="Type">const</span> <span class="Type">char</span>* val) {<br/></li>
<li>&nbsp; <span class="Type">size_t</span> len;<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">char</span>* str;<br/></li>
<li>&nbsp; str = <a href="c.cc.html#L321" title="db/c.cc:321">leveldb_iter_key</a>(<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>, &amp;len);<br/></li>
<li>&nbsp; <a href="#L41" title="db/c_test.c:41">CheckEqual</a>(<a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>, str, len);<br/></li>
<li>&nbsp; str = <a href="c.cc.html#L327" title="db/c.cc:327">leveldb_iter_value</a>(<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>, &amp;len);<br/></li>
<li>&nbsp; <a href="#L41" title="db/c_test.c:41">CheckEqual</a>(val, str, len);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">// Callback from <a href="c.cc.html#L362" title="db/c.cc:362">leveldb_writebatch_iterate</a>()<br/></li>
<li><a id="L89">&#x200c;</a></span><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">CheckPut</span>(<span class="Type">void</span>* ptr,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type">const</span> <span class="Type">char</span>* k, <span class="Type">size_t</span> klen,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type">const</span> <span class="Type">char</span>* v, <span class="Type">size_t</span> vlen) {<br/></li>
<li>&nbsp; <span class="Type">int</span>* state = (<span class="Type">int</span>*) ptr;<br/></li>
<li>&nbsp; <a href="#L35" title="db/c_test.c:35">CheckCondition</a>(*state &lt; <span class="Constant">2</span>);<br/></li>
<li>&nbsp; <span class="Statement">switch</span> (*state) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">0</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L41" title="db/c_test.c:41">CheckEqual</a>(<span class="Constant">&quot;bar&quot;</span>, k, klen);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L41" title="db/c_test.c:41">CheckEqual</a>(<span class="Constant">&quot;b&quot;</span>, v, vlen);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">1</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L41" title="db/c_test.c:41">CheckEqual</a>(<span class="Constant">&quot;box&quot;</span>, k, klen);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L41" title="db/c_test.c:41">CheckEqual</a>(<span class="Constant">&quot;c&quot;</span>, v, vlen);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; (*state)++;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">// Callback from <a href="c.cc.html#L362" title="db/c.cc:362">leveldb_writebatch_iterate</a>()<br/></li>
<li><a id="L108">&#x200c;</a></span><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">CheckDel</span>(<span class="Type">void</span>* ptr, <span class="Type">const</span> <span class="Type">char</span>* k, <span class="Type">size_t</span> klen) {<br/></li>
<li>&nbsp; <span class="Type">int</span>* state = (<span class="Type">int</span>*) ptr;<br/></li>
<li>&nbsp; <a href="#L35" title="db/c_test.c:35">CheckCondition</a>(*state == <span class="Constant">2</span>);<br/></li>
<li>&nbsp; <a href="#L41" title="db/c_test.c:41">CheckEqual</a>(<span class="Constant">&quot;bar&quot;</span>, k, klen);<br/></li>
<li>&nbsp; (*state)++;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L115">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">CmpDestroy</span>(<span class="Type">void</span>* arg) { }<br/></li>
<li><br/></li>
<li><a id="L117">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">CmpCompare</span>(<span class="Type">void</span>* arg, <span class="Type">const</span> <span class="Type">char</span>* a, <span class="Type">size_t</span> alen,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span>* b, <span class="Type">size_t</span> blen) {<br/></li>
<li>&nbsp; <span class="Type">int</span> n = (alen &lt; blen) ? alen : blen;<br/></li>
<li>&nbsp; <span class="Type">int</span> r = memcmp(a, b, n);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (r == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (alen &lt; blen) r = -<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (alen &gt; blen) r = +<span class="Constant">1</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> r;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L128">&#x200c;</a><span class="Type">static</span> <span class="Type">const</span> <span class="Type">char</span>* <span class="linkable">CmpName</span>(<span class="Type">void</span>* arg) {<br/></li>
<li>&nbsp; <span class="Statement">return</span> <span class="Constant">&quot;foo&quot;</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">// Custom filter policy<br/></li>
<li><a id="L133">&#x200c;</a></span><span class="Type">static</span> <span class="Type">unsigned</span> <span class="Type">char</span> <span class="linkable">fake_filter_result</span> = <span class="Constant">1</span>;<br/></li>
<li><a id="L134">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">FilterDestroy</span>(<span class="Type">void</span>* arg) { }<br/></li>
<li><a id="L135">&#x200c;</a><span class="Type">static</span> <span class="Type">const</span> <span class="Type">char</span>* <span class="linkable">FilterName</span>(<span class="Type">void</span>* arg) {<br/></li>
<li>&nbsp; <span class="Statement">return</span> <span class="Constant">&quot;TestFilter&quot;</span>;<br/></li>
<li>}<br/></li>
<li><a id="L138">&#x200c;</a><span class="Type">static</span> <span class="Type">char</span>* <span class="linkable">FilterCreate</span>(<br/></li>
<li>&nbsp; &nbsp; <span class="Type">void</span>* arg,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span>* <span class="Type">const</span>* key_array, <span class="Type">const</span> <span class="Type">size_t</span>* key_length_array,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span> num_keys,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>* filter_length) {<br/></li>
<li>&nbsp; *filter_length = <span class="Constant">4</span>;<br/></li>
<li>&nbsp; <span class="Type">char</span>* result = malloc(<span class="Constant">4</span>);<br/></li>
<li>&nbsp; memcpy(result, <span class="Constant">&quot;fake&quot;</span>, <span class="Constant">4</span>);<br/></li>
<li>&nbsp; <span class="Statement">return</span> result;<br/></li>
<li>}<br/></li>
<li><a id="L148">&#x200c;</a><span class="Type">unsigned</span> <span class="Type">char</span> <span class="linkable">FilterKeyMatch</span>(<br/></li>
<li>&nbsp; &nbsp; <span class="Type">void</span>* arg,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span>* <a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>, <span class="Type">size_t</span> length,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span>* filter, <span class="Type">size_t</span> filter_length) {<br/></li>
<li>&nbsp; <a href="#L35" title="db/c_test.c:35">CheckCondition</a>(filter_length == <span class="Constant">4</span>);<br/></li>
<li>&nbsp; <a href="#L35" title="db/c_test.c:35">CheckCondition</a>(memcmp(filter, <span class="Constant">&quot;fake&quot;</span>, <span class="Constant">4</span>) == <span class="Constant">0</span>);<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="#L133" title="db/c_test.c:133">fake_filter_result</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L157">&#x200c;</a><span class="Type">int</span> <span class="linkable">main</span>(<span class="Type">int</span> argc, <span class="Type">char</span>** argv) {<br/></li>
<li>&nbsp; <a href="c.cc.html#L46" title="db/c.cc:46">leveldb_t</a>* <a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a>;<br/></li>
<li>&nbsp; <a href="c.cc.html#L60" title="db/c.cc:60">leveldb_comparator_t</a>* cmp;<br/></li>
<li>&nbsp; <a href="c.cc.html#L53" title="db/c.cc:53">leveldb_cache_t</a>* cache;<br/></li>
<li>&nbsp; <a href="c.cc.html#L127" title="db/c.cc:127">leveldb_env_t</a>* env;<br/></li>
<li>&nbsp; <a href="c.cc.html#L52" title="db/c.cc:52">leveldb_options_t</a>* options;<br/></li>
<li>&nbsp; <a href="c.cc.html#L50" title="db/c.cc:50">leveldb_readoptions_t</a>* roptions;<br/></li>
<li>&nbsp; <a href="c.cc.html#L51" title="db/c.cc:51">leveldb_writeoptions_t</a>* woptions;<br/></li>
<li>&nbsp; <span class="Type">char</span>* err = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; <span class="Type">int</span> run = -<span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; <a href="#L35" title="db/c_test.c:35">CheckCondition</a>(<a href="c.cc.html#L587" title="db/c.cc:587">leveldb_major_version</a>() &gt;= <span class="Constant">1</span>);<br/></li>
<li>&nbsp; <a href="#L35" title="db/c_test.c:35">CheckCondition</a>(<a href="c.cc.html#L591" title="db/c.cc:591">leveldb_minor_version</a>() &gt;= <span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; snprintf(<a href="#L15" title="db/c_test.c:15">dbname</a>, <span class="Statement">sizeof</span>(<a href="#L15" title="db/c_test.c:15">dbname</a>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;</span><span class="Special">%s</span><span class="Constant">/leveldb_c_test-</span><span class="Special">%d</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L22" title="db/c_test.c:22">GetTempDir</a>(),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ((<span class="Type">int</span>) geteuid()));<br/></li>
<li><br/></li>
<li>&nbsp; <a href="#L17" title="db/c_test.c:17">StartPhase</a>(<span class="Constant">&quot;create_objects&quot;</span>);<br/></li>
<li>&nbsp; cmp = <a href="c.cc.html#L453" title="db/c.cc:453">leveldb_comparator_create</a>(<span class="Constant">NULL</span>, <a href="#L115" title="db/c_test.c:115">CmpDestroy</a>, <a href="#L117" title="db/c_test.c:117">CmpCompare</a>, <a href="#L128" title="db/c_test.c:128">CmpName</a>);<br/></li>
<li>&nbsp; env = <a href="c.cc.html#L571" title="db/c.cc:571">leveldb_create_default_env</a>();<br/></li>
<li>&nbsp; cache = <a href="c.cc.html#L560" title="db/c.cc:560">leveldb_cache_create_lru</a>(<span class="Constant">100000</span>);<br/></li>
<li><br/></li>
<li>&nbsp; options = <a href="c.cc.html#L386" title="db/c.cc:386">leveldb_options_create</a>();<br/></li>
<li>&nbsp; <a href="c.cc.html#L394" title="db/c.cc:394">leveldb_options_set_comparator</a>(options, cmp);<br/></li>
<li>&nbsp; <a href="c.cc.html#L411" title="db/c.cc:411">leveldb_options_set_error_if_exists</a>(options, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; <a href="c.cc.html#L437" title="db/c.cc:437">leveldb_options_set_cache</a>(options, cache);<br/></li>
<li>&nbsp; <a href="c.cc.html#L421" title="db/c.cc:421">leveldb_options_set_env</a>(options, env);<br/></li>
<li>&nbsp; <a href="c.cc.html#L425" title="db/c.cc:425">leveldb_options_set_info_log</a>(options, <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; <a href="c.cc.html#L429" title="db/c.cc:429">leveldb_options_set_write_buffer_size</a>(options, <span class="Constant">100000</span>);<br/></li>
<li>&nbsp; <a href="c.cc.html#L416" title="db/c.cc:416">leveldb_options_set_paranoid_checks</a>(options, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; <a href="c.cc.html#L433" title="db/c.cc:433">leveldb_options_set_max_open_files</a>(options, <span class="Constant">10</span>);<br/></li>
<li>&nbsp; <a href="c.cc.html#L441" title="db/c.cc:441">leveldb_options_set_block_size</a>(options, <span class="Constant">1024</span>);<br/></li>
<li>&nbsp; <a href="c.cc.html#L445" title="db/c.cc:445">leveldb_options_set_block_restart_interval</a>(options, <span class="Constant">8</span>);<br/></li>
<li>&nbsp; <a href="c.cc.html#L449" title="db/c.cc:449">leveldb_options_set_compression</a>(options, leveldb_no_compression);<br/></li>
<li><br/></li>
<li>&nbsp; roptions = <a href="c.cc.html#L522" title="db/c.cc:522">leveldb_readoptions_create</a>();<br/></li>
<li>&nbsp; <a href="c.cc.html#L530" title="db/c.cc:530">leveldb_readoptions_set_verify_checksums</a>(roptions, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; <a href="c.cc.html#L536" title="db/c.cc:536">leveldb_readoptions_set_fill_cache</a>(roptions, <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; woptions = <a href="c.cc.html#L547" title="db/c.cc:547">leveldb_writeoptions_create</a>();<br/></li>
<li>&nbsp; <a href="c.cc.html#L555" title="db/c.cc:555">leveldb_writeoptions_set_sync</a>(woptions, <span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; <a href="#L17" title="db/c_test.c:17">StartPhase</a>(<span class="Constant">&quot;destroy&quot;</span>);<br/></li>
<li>&nbsp; <a href="c.cc.html#L278" title="db/c.cc:278">leveldb_destroy_db</a>(options, <a href="#L15" title="db/c_test.c:15">dbname</a>, &amp;err);<br/></li>
<li>&nbsp; <a href="#L57" title="db/c_test.c:57">Free</a>(&amp;err);<br/></li>
<li><br/></li>
<li>&nbsp; <a href="#L17" title="db/c_test.c:17">StartPhase</a>(<span class="Constant">&quot;open_error&quot;</span>);<br/></li>
<li>&nbsp; <a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a> = <a href="c.cc.html#L152" title="db/c.cc:152">leveldb_open</a>(options, <a href="#L15" title="db/c_test.c:15">dbname</a>, &amp;err);<br/></li>
<li>&nbsp; <a href="#L35" title="db/c_test.c:35">CheckCondition</a>(err != <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; <a href="#L57" title="db/c_test.c:57">Free</a>(&amp;err);<br/></li>
<li><br/></li>
<li>&nbsp; <a href="#L17" title="db/c_test.c:17">StartPhase</a>(<span class="Constant">&quot;<a href="c.cc.html#L583" title="db/c.cc:583">leveldb_free</a>&quot;</span>);<br/></li>
<li>&nbsp; <a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a> = <a href="c.cc.html#L152" title="db/c.cc:152">leveldb_open</a>(options, <a href="#L15" title="db/c_test.c:15">dbname</a>, &amp;err);<br/></li>
<li>&nbsp; <a href="#L35" title="db/c_test.c:35">CheckCondition</a>(err != <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; <a href="c.cc.html#L583" title="db/c.cc:583">leveldb_free</a>(err);<br/></li>
<li>&nbsp; err = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; <a href="#L17" title="db/c_test.c:17">StartPhase</a>(<span class="Constant">&quot;open&quot;</span>);<br/></li>
<li>&nbsp; <a href="c.cc.html#L406" title="db/c.cc:406">leveldb_options_set_create_if_missing</a>(options, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; <a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a> = <a href="c.cc.html#L152" title="db/c.cc:152">leveldb_open</a>(options, <a href="#L15" title="db/c_test.c:15">dbname</a>, &amp;err);<br/></li>
<li>&nbsp; <a href="#L29" title="db/c_test.c:29">CheckNoError</a>(err);<br/></li>
<li>&nbsp; <a href="#L64" title="db/c_test.c:64">CheckGet</a>(<a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a>, roptions, <span class="Constant">&quot;foo&quot;</span>, <span class="Constant">NULL</span>);<br/></li>
<li><br/></li>
<li>&nbsp; <a href="#L17" title="db/c_test.c:17">StartPhase</a>(<span class="Constant">&quot;put&quot;</span>);<br/></li>
<li>&nbsp; <a href="c.cc.html#L170" title="db/c.cc:170">leveldb_put</a>(<a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a>, woptions, <span class="Constant">&quot;foo&quot;</span>, <span class="Constant">3</span>, <span class="Constant">&quot;hello&quot;</span>, <span class="Constant">5</span>, &amp;err);<br/></li>
<li>&nbsp; <a href="#L29" title="db/c_test.c:29">CheckNoError</a>(err);<br/></li>
<li>&nbsp; <a href="#L64" title="db/c_test.c:64">CheckGet</a>(<a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a>, roptions, <span class="Constant">&quot;foo&quot;</span>, <span class="Constant">&quot;hello&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; <a href="#L17" title="db/c_test.c:17">StartPhase</a>(<span class="Constant">&quot;compactall&quot;</span>);<br/></li>
<li>&nbsp; <a href="c.cc.html#L267" title="db/c.cc:267">leveldb_compact_range</a>(<a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a>, <span class="Constant">NULL</span>, <span class="Constant">0</span>, <span class="Constant">NULL</span>, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; <a href="#L64" title="db/c_test.c:64">CheckGet</a>(<a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a>, roptions, <span class="Constant">&quot;foo&quot;</span>, <span class="Constant">&quot;hello&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; <a href="#L17" title="db/c_test.c:17">StartPhase</a>(<span class="Constant">&quot;compactrange&quot;</span>);<br/></li>
<li>&nbsp; <a href="c.cc.html#L267" title="db/c.cc:267">leveldb_compact_range</a>(<a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a>, <span class="Constant">&quot;a&quot;</span>, <span class="Constant">1</span>, <span class="Constant">&quot;z&quot;</span>, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; <a href="#L64" title="db/c_test.c:64">CheckGet</a>(<a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a>, roptions, <span class="Constant">&quot;foo&quot;</span>, <span class="Constant">&quot;hello&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; <a href="#L17" title="db/c_test.c:17">StartPhase</a>(<span class="Constant">&quot;writebatch&quot;</span>);<br/></li>
<li>&nbsp; {<br/></li>
<li>&nbsp; &nbsp; <a href="c.cc.html#L48" title="db/c.cc:48">leveldb_writebatch_t</a>* wb = <a href="c.cc.html#L337" title="db/c.cc:337">leveldb_writebatch_create</a>();<br/></li>
<li>&nbsp; &nbsp; <a href="c.cc.html#L349" title="db/c.cc:349">leveldb_writebatch_put</a>(wb, <span class="Constant">&quot;foo&quot;</span>, <span class="Constant">3</span>, <span class="Constant">&quot;a&quot;</span>, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="c.cc.html#L345" title="db/c.cc:345">leveldb_writebatch_clear</a>(wb);<br/></li>
<li>&nbsp; &nbsp; <a href="c.cc.html#L349" title="db/c.cc:349">leveldb_writebatch_put</a>(wb, <span class="Constant">&quot;bar&quot;</span>, <span class="Constant">3</span>, <span class="Constant">&quot;b&quot;</span>, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="c.cc.html#L349" title="db/c.cc:349">leveldb_writebatch_put</a>(wb, <span class="Constant">&quot;box&quot;</span>, <span class="Constant">3</span>, <span class="Constant">&quot;c&quot;</span>, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="c.cc.html#L356" title="db/c.cc:356">leveldb_writebatch_delete</a>(wb, <span class="Constant">&quot;bar&quot;</span>, <span class="Constant">3</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="c.cc.html#L189" title="db/c.cc:189">leveldb_write</a>(<a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a>, woptions, wb, &amp;err);<br/></li>
<li>&nbsp; &nbsp; <a href="#L29" title="db/c_test.c:29">CheckNoError</a>(err);<br/></li>
<li>&nbsp; &nbsp; <a href="#L64" title="db/c_test.c:64">CheckGet</a>(<a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a>, roptions, <span class="Constant">&quot;foo&quot;</span>, <span class="Constant">&quot;hello&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="#L64" title="db/c_test.c:64">CheckGet</a>(<a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a>, roptions, <span class="Constant">&quot;bar&quot;</span>, <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="#L64" title="db/c_test.c:64">CheckGet</a>(<a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a>, roptions, <span class="Constant">&quot;box&quot;</span>, <span class="Constant">&quot;c&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span> pos = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; <a href="c.cc.html#L362" title="db/c.cc:362">leveldb_writebatch_iterate</a>(wb, &amp;pos, <a href="#L89" title="db/c_test.c:89">CheckPut</a>, <a href="#L108" title="db/c_test.c:108">CheckDel</a>);<br/></li>
<li>&nbsp; &nbsp; <a href="#L35" title="db/c_test.c:35">CheckCondition</a>(pos == <span class="Constant">3</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="c.cc.html#L341" title="db/c.cc:341">leveldb_writebatch_destroy</a>(wb);<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <a href="#L17" title="db/c_test.c:17">StartPhase</a>(<span class="Constant">&quot;<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>&quot;</span>);<br/></li>
<li>&nbsp; {<br/></li>
<li>&nbsp; &nbsp; <a href="c.cc.html#L47" title="db/c.cc:47">leveldb_iterator_t</a>* <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a> = <a href="c.cc.html#L218" title="db/c.cc:218">leveldb_create_iterator</a>(<a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a>, roptions);<br/></li>
<li>&nbsp; &nbsp; <a href="#L35" title="db/c_test.c:35">CheckCondition</a>(!<a href="c.cc.html#L297" title="db/c.cc:297">leveldb_iter_valid</a>(<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>));<br/></li>
<li>&nbsp; &nbsp; <a href="c.cc.html#L301" title="db/c.cc:301">leveldb_iter_seek_to_first</a>(<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>);<br/></li>
<li>&nbsp; &nbsp; <a href="#L35" title="db/c_test.c:35">CheckCondition</a>(<a href="c.cc.html#L297" title="db/c.cc:297">leveldb_iter_valid</a>(<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>));<br/></li>
<li>&nbsp; &nbsp; <a href="#L78" title="db/c_test.c:78">CheckIter</a>(<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>, <span class="Constant">&quot;box&quot;</span>, <span class="Constant">&quot;c&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="c.cc.html#L313" title="db/c.cc:313">leveldb_iter_next</a>(<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>);<br/></li>
<li>&nbsp; &nbsp; <a href="#L78" title="db/c_test.c:78">CheckIter</a>(<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>, <span class="Constant">&quot;foo&quot;</span>, <span class="Constant">&quot;hello&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="c.cc.html#L317" title="db/c.cc:317">leveldb_iter_prev</a>(<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>);<br/></li>
<li>&nbsp; &nbsp; <a href="#L78" title="db/c_test.c:78">CheckIter</a>(<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>, <span class="Constant">&quot;box&quot;</span>, <span class="Constant">&quot;c&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="c.cc.html#L317" title="db/c.cc:317">leveldb_iter_prev</a>(<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>);<br/></li>
<li>&nbsp; &nbsp; <a href="#L35" title="db/c_test.c:35">CheckCondition</a>(!<a href="c.cc.html#L297" title="db/c.cc:297">leveldb_iter_valid</a>(<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>));<br/></li>
<li>&nbsp; &nbsp; <a href="c.cc.html#L305" title="db/c.cc:305">leveldb_iter_seek_to_last</a>(<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>);<br/></li>
<li>&nbsp; &nbsp; <a href="#L78" title="db/c_test.c:78">CheckIter</a>(<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>, <span class="Constant">&quot;foo&quot;</span>, <span class="Constant">&quot;hello&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="c.cc.html#L309" title="db/c.cc:309">leveldb_iter_seek</a>(<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>, <span class="Constant">&quot;b&quot;</span>, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="#L78" title="db/c_test.c:78">CheckIter</a>(<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>, <span class="Constant">&quot;box&quot;</span>, <span class="Constant">&quot;c&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="c.cc.html#L333" title="db/c.cc:333">leveldb_iter_get_error</a>(<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>, &amp;err);<br/></li>
<li>&nbsp; &nbsp; <a href="#L29" title="db/c_test.c:29">CheckNoError</a>(err);<br/></li>
<li>&nbsp; &nbsp; <a href="c.cc.html#L292" title="db/c.cc:292">leveldb_iter_destroy</a>(<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>);<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <a href="#L17" title="db/c_test.c:17">StartPhase</a>(<span class="Constant">&quot;approximate_sizes&quot;</span>);<br/></li>
<li>&nbsp; {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span> i;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span> n = <span class="Constant">20000</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span> keybuf[<span class="Constant">100</span>];<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span> valbuf[<span class="Constant">100</span>];<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../port/win/stdint.h.html#L22" title="port/win/stdint.h:22">uint64_t</a></span> sizes[<span class="Constant">2</span>];<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span>* start[<span class="Constant">2</span>] = { <span class="Constant">&quot;a&quot;</span>, <span class="Constant">&quot;k00000000000000010000&quot;</span> };<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span> start_len[<span class="Constant">2</span>] = { <span class="Constant">1</span>, <span class="Constant">21</span> };<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span>* limit[<span class="Constant">2</span>] = { <span class="Constant">&quot;k00000000000000010000&quot;</span>, <span class="Constant">&quot;z&quot;</span> };<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span> limit_len[<span class="Constant">2</span>] = { <span class="Constant">21</span>, <span class="Constant">1</span> };<br/></li>
<li>&nbsp; &nbsp; <a href="c.cc.html#L555" title="db/c.cc:555">leveldb_writeoptions_set_sync</a>(woptions, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; n; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; snprintf(keybuf, <span class="Statement">sizeof</span>(keybuf), <span class="Constant">&quot;k</span><span class="Special">%020d</span><span class="Constant">&quot;</span>, i);<br/></li>
<li>&nbsp; &nbsp; &nbsp; snprintf(valbuf, <span class="Statement">sizeof</span>(valbuf), <span class="Constant">&quot;v</span><span class="Special">%020d</span><span class="Constant">&quot;</span>, i);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="c.cc.html#L170" title="db/c.cc:170">leveldb_put</a>(<a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a>, woptions, keybuf, strlen(keybuf), valbuf, strlen(valbuf),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;err);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L29" title="db/c_test.c:29">CheckNoError</a>(err);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <a href="c.cc.html#L252" title="db/c.cc:252">leveldb_approximate_sizes</a>(<a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a>, <span class="Constant">2</span>, start, start_len, limit, limit_len, sizes);<br/></li>
<li>&nbsp; &nbsp; <a href="#L35" title="db/c_test.c:35">CheckCondition</a>(sizes[<span class="Constant">0</span>] &gt; <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="#L35" title="db/c_test.c:35">CheckCondition</a>(sizes[<span class="Constant">1</span>] &gt; <span class="Constant">0</span>);<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <a href="#L17" title="db/c_test.c:17">StartPhase</a>(<span class="Constant">&quot;property&quot;</span>);<br/></li>
<li>&nbsp; {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>* prop = <a href="c.cc.html#L240" title="db/c.cc:240">leveldb_property_value</a>(<a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a>, <span class="Constant">&quot;nosuchprop&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="#L35" title="db/c_test.c:35">CheckCondition</a>(prop == <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; prop = <a href="c.cc.html#L240" title="db/c.cc:240">leveldb_property_value</a>(<a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a>, <span class="Constant">&quot;leveldb.stats&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="#L35" title="db/c_test.c:35">CheckCondition</a>(prop != <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="#L57" title="db/c_test.c:57">Free</a>(&amp;prop);<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <a href="#L17" title="db/c_test.c:17">StartPhase</a>(<span class="Constant">&quot;snapshot&quot;</span>);<br/></li>
<li>&nbsp; {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <a href="c.cc.html#L49" title="db/c.cc:49">leveldb_snapshot_t</a>* snap;<br/></li>
<li>&nbsp; &nbsp; snap = <a href="c.cc.html#L226" title="db/c.cc:226">leveldb_create_snapshot</a>(<a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a>);<br/></li>
<li>&nbsp; &nbsp; <a href="c.cc.html#L180" title="db/c.cc:180">leveldb_delete</a>(<a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a>, woptions, <span class="Constant">&quot;foo&quot;</span>, <span class="Constant">3</span>, &amp;err);<br/></li>
<li>&nbsp; &nbsp; <a href="#L29" title="db/c_test.c:29">CheckNoError</a>(err);<br/></li>
<li>&nbsp; &nbsp; <a href="c.cc.html#L541" title="db/c.cc:541">leveldb_readoptions_set_snapshot</a>(roptions, snap);<br/></li>
<li>&nbsp; &nbsp; <a href="#L64" title="db/c_test.c:64">CheckGet</a>(<a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a>, roptions, <span class="Constant">&quot;foo&quot;</span>, <span class="Constant">&quot;hello&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="c.cc.html#L541" title="db/c.cc:541">leveldb_readoptions_set_snapshot</a>(roptions, <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="#L64" title="db/c_test.c:64">CheckGet</a>(<a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a>, roptions, <span class="Constant">&quot;foo&quot;</span>, <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="c.cc.html#L233" title="db/c.cc:233">leveldb_release_snapshot</a>(<a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a>, snap);<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <a href="#L17" title="db/c_test.c:17">StartPhase</a>(<span class="Constant">&quot;repair&quot;</span>);<br/></li>
<li>&nbsp; {<br/></li>
<li>&nbsp; &nbsp; <a href="c.cc.html#L165" title="db/c.cc:165">leveldb_close</a>(<a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a>);<br/></li>
<li>&nbsp; &nbsp; <a href="c.cc.html#L406" title="db/c.cc:406">leveldb_options_set_create_if_missing</a>(options, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="c.cc.html#L411" title="db/c.cc:411">leveldb_options_set_error_if_exists</a>(options, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="c.cc.html#L285" title="db/c.cc:285">leveldb_repair_db</a>(options, <a href="#L15" title="db/c_test.c:15">dbname</a>, &amp;err);<br/></li>
<li>&nbsp; &nbsp; <a href="#L29" title="db/c_test.c:29">CheckNoError</a>(err);<br/></li>
<li>&nbsp; &nbsp; <a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a> = <a href="c.cc.html#L152" title="db/c.cc:152">leveldb_open</a>(options, <a href="#L15" title="db/c_test.c:15">dbname</a>, &amp;err);<br/></li>
<li>&nbsp; &nbsp; <a href="#L29" title="db/c_test.c:29">CheckNoError</a>(err);<br/></li>
<li>&nbsp; &nbsp; <a href="#L64" title="db/c_test.c:64">CheckGet</a>(<a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a>, roptions, <span class="Constant">&quot;foo&quot;</span>, <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="#L64" title="db/c_test.c:64">CheckGet</a>(<a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a>, roptions, <span class="Constant">&quot;bar&quot;</span>, <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="#L64" title="db/c_test.c:64">CheckGet</a>(<a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a>, roptions, <span class="Constant">&quot;box&quot;</span>, <span class="Constant">&quot;c&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="c.cc.html#L406" title="db/c.cc:406">leveldb_options_set_create_if_missing</a>(options, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="c.cc.html#L411" title="db/c.cc:411">leveldb_options_set_error_if_exists</a>(options, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <a href="#L17" title="db/c_test.c:17">StartPhase</a>(<span class="Constant">&quot;filter&quot;</span>);<br/></li>
<li>&nbsp; <span class="Statement">for</span> (run = <span class="Constant">0</span>; run &lt; <span class="Constant">2</span>; run++) {<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// First run uses custom filter, second run uses bloom filter<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L29" title="db/c_test.c:29">CheckNoError</a>(err);<br/></li>
<li>&nbsp; &nbsp; <a href="c.cc.html#L86" title="db/c.cc:86">leveldb_filterpolicy_t</a>* policy;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (run == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; policy = <a href="c.cc.html#L473" title="db/c.cc:473">leveldb_filterpolicy_create</a>(<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">NULL</span>, <a href="#L134" title="db/c_test.c:134">FilterDestroy</a>, <a href="#L138" title="db/c_test.c:138">FilterCreate</a>, <a href="#L148" title="db/c_test.c:148">FilterKeyMatch</a>, <a href="#L135" title="db/c_test.c:135">FilterName</a>);<br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; policy = <a href="c.cc.html#L499" title="db/c.cc:499">leveldb_filterpolicy_create_bloom</a>(<span class="Constant">10</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// Create new database<br/></li>
<li></span>&nbsp; &nbsp; <a href="c.cc.html#L165" title="db/c.cc:165">leveldb_close</a>(<a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a>);<br/></li>
<li>&nbsp; &nbsp; <a href="c.cc.html#L278" title="db/c.cc:278">leveldb_destroy_db</a>(options, <a href="#L15" title="db/c_test.c:15">dbname</a>, &amp;err);<br/></li>
<li>&nbsp; &nbsp; <a href="c.cc.html#L400" title="db/c.cc:400">leveldb_options_set_filter_policy</a>(options, policy);<br/></li>
<li>&nbsp; &nbsp; <a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a> = <a href="c.cc.html#L152" title="db/c.cc:152">leveldb_open</a>(options, <a href="#L15" title="db/c_test.c:15">dbname</a>, &amp;err);<br/></li>
<li>&nbsp; &nbsp; <a href="#L29" title="db/c_test.c:29">CheckNoError</a>(err);<br/></li>
<li>&nbsp; &nbsp; <a href="c.cc.html#L170" title="db/c.cc:170">leveldb_put</a>(<a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a>, woptions, <span class="Constant">&quot;foo&quot;</span>, <span class="Constant">3</span>, <span class="Constant">&quot;foovalue&quot;</span>, <span class="Constant">8</span>, &amp;err);<br/></li>
<li>&nbsp; &nbsp; <a href="#L29" title="db/c_test.c:29">CheckNoError</a>(err);<br/></li>
<li>&nbsp; &nbsp; <a href="c.cc.html#L170" title="db/c.cc:170">leveldb_put</a>(<a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a>, woptions, <span class="Constant">&quot;bar&quot;</span>, <span class="Constant">3</span>, <span class="Constant">&quot;barvalue&quot;</span>, <span class="Constant">8</span>, &amp;err);<br/></li>
<li>&nbsp; &nbsp; <a href="#L29" title="db/c_test.c:29">CheckNoError</a>(err);<br/></li>
<li>&nbsp; &nbsp; <a href="c.cc.html#L267" title="db/c.cc:267">leveldb_compact_range</a>(<a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a>, <span class="Constant">NULL</span>, <span class="Constant">0</span>, <span class="Constant">NULL</span>, <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L133" title="db/c_test.c:133">fake_filter_result</a> = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; <a href="#L64" title="db/c_test.c:64">CheckGet</a>(<a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a>, roptions, <span class="Constant">&quot;foo&quot;</span>, <span class="Constant">&quot;foovalue&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="#L64" title="db/c_test.c:64">CheckGet</a>(<a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a>, roptions, <span class="Constant">&quot;bar&quot;</span>, <span class="Constant">&quot;barvalue&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L14" title="db/c_test.c:14">phase</a> == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Comment">// Must not find <a href="../table/two_level_iterator.cc.html#L41" title="table/two_level_iterator.cc:41">value</a> when custom filter returns false<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <a href="#L133" title="db/c_test.c:133">fake_filter_result</a> = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L64" title="db/c_test.c:64">CheckGet</a>(<a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a>, roptions, <span class="Constant">&quot;foo&quot;</span>, <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L64" title="db/c_test.c:64">CheckGet</a>(<a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a>, roptions, <span class="Constant">&quot;bar&quot;</span>, <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L133" title="db/c_test.c:133">fake_filter_result</a> = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L64" title="db/c_test.c:64">CheckGet</a>(<a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a>, roptions, <span class="Constant">&quot;foo&quot;</span>, <span class="Constant">&quot;foovalue&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L64" title="db/c_test.c:64">CheckGet</a>(<a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a>, roptions, <span class="Constant">&quot;bar&quot;</span>, <span class="Constant">&quot;barvalue&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <a href="c.cc.html#L400" title="db/c.cc:400">leveldb_options_set_filter_policy</a>(options, <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="c.cc.html#L495" title="db/c.cc:495">leveldb_filterpolicy_destroy</a>(policy);<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <a href="#L17" title="db/c_test.c:17">StartPhase</a>(<span class="Constant">&quot;cleanup&quot;</span>);<br/></li>
<li>&nbsp; <a href="c.cc.html#L165" title="db/c.cc:165">leveldb_close</a>(<a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a>);<br/></li>
<li>&nbsp; <a href="c.cc.html#L390" title="db/c.cc:390">leveldb_options_destroy</a>(options);<br/></li>
<li>&nbsp; <a href="c.cc.html#L526" title="db/c.cc:526">leveldb_readoptions_destroy</a>(roptions);<br/></li>
<li>&nbsp; <a href="c.cc.html#L551" title="db/c.cc:551">leveldb_writeoptions_destroy</a>(woptions);<br/></li>
<li>&nbsp; <a href="c.cc.html#L566" title="db/c.cc:566">leveldb_cache_destroy</a>(cache);<br/></li>
<li>&nbsp; <a href="c.cc.html#L469" title="db/c.cc:469">leveldb_comparator_destroy</a>(cmp);<br/></li>
<li>&nbsp; <a href="c.cc.html#L578" title="db/c.cc:578">leveldb_env_destroy</a>(env);<br/></li>
<li><br/></li>
<li>&nbsp; fprintf(<span class="Constant">stderr</span>, <span class="Constant">&quot;PASS</span><span class="Special">\n</span><span class="Constant">&quot;</span>);<br/></li>
<li>&nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>}<br/></li>
</ol></code>
 </body>
</html>
