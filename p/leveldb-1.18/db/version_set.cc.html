<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>db/version_set.cc - leveldb-1.18</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

code {
    font-family: consolas, monospace;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
  <h3>db/version_set.cc - leveldb-1.18</h3>
   <a href="../index.html"> Table of Contents </a>
 <h4>Data types defined</h4>
 <ul>
<li><a href="#L597">BySmallestKey</a></li>
<li><a href="#L611">FileSet</a></li>
<li><a href="#L612">LevelState</a></li>
<li><a href="#L252">Saver</a></li>
<li><a href="#L246">SaverState</a></li>
</ul>
 <h4>Functions defined</h4>
 <ul>
<li><a href="#L1426">AddInputDeletions</a></li>
<li><a href="#L225">AddIterators</a></li>
<li><a href="#L1137">AddLiveFiles</a></li>
<li><a href="#L98">AfterFile</a></li>
<li><a href="#L794">AppendVersion</a></li>
<li><a href="#L656">Apply</a></li>
<li><a href="#L1105">ApproximateOffsetOf</a></li>
<li><a href="#L105">BeforeFile</a></li>
<li><a href="#L623">Builder</a></li>
<li><a href="#L1364">CompactRange</a></li>
<li><a href="#L1399">Compaction</a></li>
<li><a href="#L565">DebugString</a></li>
<li><a href="#L1017">Finalize</a></li>
<li><a href="#L77">FindFile</a></li>
<li><a href="#L278">ForEachOverlapping</a></li>
<li><a href="#L323">Get</a></li>
<li><a href="#L204">GetFileIterator</a></li>
<li><a href="#L522">GetOverlappingInputs</a></li>
<li><a href="#L1176">GetRange</a></li>
<li><a href="#L1201">GetRange2</a></li>
<li><a href="#L1434">IsBaseLevelForKey</a></li>
<li><a href="#L1417">IsTrivialMove</a></li>
<li><a href="#L156">LevelFileNumIterator</a></li>
<li><a href="#L1090">LevelSummary</a></li>
<li><a href="#L811">LogAndApply</a></li>
<li><a href="#L1210">MakeInputIterator</a></li>
<li><a href="#L1011">MarkFileNumberUsed</a></li>
<li><a href="#L34">MaxBytesForLevel</a></li>
<li><a href="#L45">MaxFileSizeForLevel</a></li>
<li><a href="#L1156">MaxNextLevelOverlappingBytes</a></li>
<li><a href="#L750">MaybeAddFile</a></li>
<li><a href="#L218">NewConcatenatingIterator</a></li>
<li><a href="#L274">NewestFirst</a></li>
<li><a href="#L172">Next</a></li>
<li><a href="#L1150">NumLevelBytes</a></li>
<li><a href="#L1084">NumLevelFiles</a></li>
<li><a href="#L486">OverlapInLevel</a></li>
<li><a href="#L1243">PickCompaction</a></li>
<li><a href="#L493">PickLevelForMemTableOutput</a></li>
<li><a href="#L176">Prev</a></li>
<li><a href="#L435">RecordReadSample</a></li>
<li><a href="#L896">Recover</a></li>
<li><a href="#L473">Ref</a></li>
<li><a href="#L1477">ReleaseInputs</a></li>
<li><a href="#L702">SaveTo</a></li>
<li><a href="#L259">SaveValue</a></li>
<li><a href="#L165">Seek</a></li>
<li><a href="#L168">SeekToFirst</a></li>
<li><a href="#L169">SeekToLast</a></li>
<li><a href="#L1297">SetupOtherInputs</a></li>
<li><a href="#L1455">ShouldStopBefore</a></li>
<li><a href="#L112">SomeFileOverlapsRange</a></li>
<li><a href="#L49">TotalFileSize</a></li>
<li><a href="#L477">Unref</a></li>
<li><a href="#L422">UpdateStats</a></li>
<li><a href="#L162">Valid</a></li>
<li><a href="#L766">VersionSet</a></li>
<li><a href="#L1054">WriteSnapshot</a></li>
<li><a href="#L184">key</a></li>
<li><a href="#L600">operator ()</a></li>
<li><a href="#L194">status</a></li>
<li><a href="#L188">value</a></li>
<li><a href="#L634">~Builder</a></li>
<li><a href="#L1411">~Compaction</a></li>
<li><a href="#L57">~Version</a></li>
<li><a href="#L787">~VersionSet</a></li>
</ul>
 <h4>Source code</h4>

  <code><ol><li><span class="Comment">// Copyright (c) 2011 The LevelDB Authors. All rights reserved.<br/></li>
<li></span><span class="Comment">// Use of this source <a href="../include/leveldb/status.h.html#L84" title="include/leveldb/status.h:84">code</a> is governed by a BSD-style license that can be<br/></li>
<li></span><span class="Comment">// found in the LICENSE file. See the AUTHORS file for names of contributors.<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;<a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a>/version_set.h&quot;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;algorithm&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;stdio.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;<a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a>/filename.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;<a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a>/log_reader.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;<a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a>/log_writer.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;<a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a>/memtable.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;<a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a>/table_cache.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;leveldb/env.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;leveldb/table_builder.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;table/merger.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;table/two_level_iterator.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;util/coding.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;util/logging.h&quot;<br/></li>
<li></span><br/></li>
<li><span class="Type">namespace</span> leveldb {<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">const</span> <span class="Type">int</span> kTargetFileSize = <span class="Constant">2</span> * <span class="Constant">1048576</span>;<br/></li>
<li><br/></li>
<li><span class="Comment">// Maximum bytes of overlaps in grandparent (i.e., <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>+2) before we<br/></li>
<li></span><span class="Comment">// stop building a single file in a <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>-&gt;<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>+1 compaction.<br/></li>
<li></span><span class="Type">static</span> <span class="Type">const</span> <span class="Type"><a href="../port/win/stdint.h.html#L18" title="port/win/stdint.h:18">int64_t</a></span> kMaxGrandParentOverlapBytes = <span class="Constant">10</span> * kTargetFileSize;<br/></li>
<li><br/></li>
<li><span class="Comment">// Maximum number of bytes in all compacted files.&nbsp; We avoid expanding<br/></li>
<li></span><span class="Comment">// the lower <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> file set of a compaction if it would make the<br/></li>
<li></span><span class="Comment">// total compaction cover more than this many bytes.<br/></li>
<li></span><span class="Type">static</span> <span class="Type">const</span> <span class="Type"><a href="../port/win/stdint.h.html#L18" title="port/win/stdint.h:18">int64_t</a></span> kExpandedCompactionByteSizeLimit = <span class="Constant">25</span> * kTargetFileSize;<br/></li>
<li><br/></li>
<li><a id="L34">&#x200c;</a><span class="Type">static</span> <span class="Type">double</span> <span class="linkable">MaxBytesForLevel</span>(<span class="Type">int</span> <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>) {<br/></li>
<li>&nbsp; <span class="Comment">// Note: the result for <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> zero is not really used since we set<br/></li>
<li></span>&nbsp; <span class="Comment">// the <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>-0 compaction threshold based on number of files.<br/></li>
<li></span>&nbsp; <span class="Type">double</span> result = <span class="Constant">10</span> * <span class="Constant">1048576.0</span>;&nbsp; <span class="Comment">// Result for both <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>-0 and <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>-1<br/></li>
<li></span>&nbsp; <span class="Statement">while</span> (<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> &gt; <span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; result *= <span class="Constant">10</span>;<br/></li>
<li>&nbsp; &nbsp; <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>--;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> result;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L45">&#x200c;</a><span class="Type">static</span> <span class="Type"><a href="../port/win/stdint.h.html#L22" title="port/win/stdint.h:22">uint64_t</a></span> <span class="linkable">MaxFileSizeForLevel</span>(<span class="Type">int</span> <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>) {<br/></li>
<li>&nbsp; <span class="Statement">return</span> kTargetFileSize;&nbsp; <span class="Comment">// We could vary per <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> to reduce number of files?<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><a id="L49">&#x200c;</a><span class="Type">static</span> <span class="Type"><a href="../port/win/stdint.h.html#L18" title="port/win/stdint.h:18">int64_t</a></span> <span class="linkable">TotalFileSize</span>(<span class="Type">const</span> std::vector&lt;<a href="version_edit.h.html#L17" title="db/version_edit.h:17">FileMetaData</a>*&gt;&amp; files) {<br/></li>
<li>&nbsp; <span class="Type"><a href="../port/win/stdint.h.html#L18" title="port/win/stdint.h:18">int64_t</a></span> sum = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; <span class="Statement">for</span> (<span class="Type">size_t</span> i = <span class="Constant">0</span>; i &lt; files.<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>(); i++) {<br/></li>
<li>&nbsp; &nbsp; sum += files[i]-&gt;file_size;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> sum;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L57">&#x200c;</a><a href="version_set.h.html#L150" title="db/version_set.h:150">Version</a>::~<a href="version_set.h.html#L150" title="db/version_set.h:150">Version</a>() {<br/></li>
<li>&nbsp; assert(refs_ == <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// <a href="../util/cache.cc.html#L78" title="util/cache.cc:78">Remove</a> from linked list<br/></li>
<li></span>&nbsp; prev_-&gt;next_ = next_;<br/></li>
<li>&nbsp; next_-&gt;prev_ = prev_;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// Drop references to files<br/></li>
<li></span>&nbsp; <span class="Statement">for</span> (<span class="Type">int</span> <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> = <span class="Constant">0</span>; <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> &lt; config::kNumLevels; <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>++) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (<span class="Type">size_t</span> i = <span class="Constant">0</span>; i &lt; files_[<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>].<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>(); i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="version_edit.h.html#L17" title="db/version_edit.h:17">FileMetaData</a>* f = files_[<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>][i];<br/></li>
<li>&nbsp; &nbsp; &nbsp; assert(f-&gt;refs &gt; <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; f-&gt;refs--;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (f-&gt;refs &lt;= <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">delete</span> f;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L77">&#x200c;</a><span class="Type">int</span> <span class="linkable">FindFile</span>(<span class="Type">const</span> <a href="dbformat.h.html#L117" title="db/dbformat.h:117">InternalKeyComparator</a>&amp; icmp,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type">const</span> std::vector&lt;<a href="version_edit.h.html#L17" title="db/version_edit.h:17">FileMetaData</a>*&gt;&amp; files,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type">const</span> <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>&amp; <a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>) {<br/></li>
<li>&nbsp; <span class="Type"><a href="../port/win/stdint.h.html#L21" title="port/win/stdint.h:21">uint32_t</a></span> left = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; <span class="Type"><a href="../port/win/stdint.h.html#L21" title="port/win/stdint.h:21">uint32_t</a></span> right = files.<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>();<br/></li>
<li>&nbsp; <span class="Statement">while</span> (left &lt; right) {<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../port/win/stdint.h.html#L21" title="port/win/stdint.h:21">uint32_t</a></span> mid = (left + right) / <span class="Constant">2</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <a href="version_edit.h.html#L17" title="db/version_edit.h:17">FileMetaData</a>* f = files[mid];<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (icmp.<a href="dbformat.h.html#L117" title="db/dbformat.h:117">InternalKeyComparator</a>::<a href="../table/table_test.cc.html#L44" title="table/table_test.cc:44">Compare</a>(f-&gt;largest.<a href="dbformat.h.html#L154" title="db/dbformat.h:154">Encode</a>(), <a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>) &lt; <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Comment">// <a href="autocompact_test.cc.html#L36" title="db/autocompact_test.cc:36">Key</a> at &quot;mid.largest&quot; is &lt; &quot;<a href="../include/leveldb/env.h.html#L280" title="include/leveldb/env.h:280">target</a>&quot;.&nbsp; Therefore all<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Comment">// files at or before &quot;mid&quot; are uninteresting.<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; left = mid + <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Comment">// <a href="autocompact_test.cc.html#L36" title="db/autocompact_test.cc:36">Key</a> at &quot;mid.largest&quot; is &gt;= &quot;<a href="../include/leveldb/env.h.html#L280" title="include/leveldb/env.h:280">target</a>&quot;.&nbsp; Therefore all files<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Comment">// after &quot;mid&quot; are uninteresting.<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; right = mid;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> right;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L98">&#x200c;</a><span class="Type">static</span> <span class="Type">bool</span> <span class="linkable">AfterFile</span>(<span class="Type">const</span> <a href="skiplist_test.cc.html#L17" title="db/skiplist_test.cc:17">Comparator</a>* ucmp,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">const</span> <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>* <a href="dbformat.h.html#L159" title="db/dbformat.h:159">user_key</a>, <span class="Type">const</span> <a href="version_edit.h.html#L17" title="db/version_edit.h:17">FileMetaData</a>* f) {<br/></li>
<li>&nbsp; <span class="Comment">// NULL <a href="dbformat.h.html#L159" title="db/dbformat.h:159">user_key</a> occurs before all keys and is therefore never after *f<br/></li>
<li></span>&nbsp; <span class="Statement">return</span> (<a href="dbformat.h.html#L159" title="db/dbformat.h:159">user_key</a> != <span class="Constant">NULL</span> &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ucmp-&gt;<a href="../table/table_test.cc.html#L44" title="table/table_test.cc:44">Compare</a>(*<a href="dbformat.h.html#L159" title="db/dbformat.h:159">user_key</a>, f-&gt;largest.<a href="dbformat.h.html#L159" title="db/dbformat.h:159">user_key</a>()) &gt; <span class="Constant">0</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L105">&#x200c;</a><span class="Type">static</span> <span class="Type">bool</span> <span class="linkable">BeforeFile</span>(<span class="Type">const</span> <a href="skiplist_test.cc.html#L17" title="db/skiplist_test.cc:17">Comparator</a>* ucmp,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type">const</span> <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>* <a href="dbformat.h.html#L159" title="db/dbformat.h:159">user_key</a>, <span class="Type">const</span> <a href="version_edit.h.html#L17" title="db/version_edit.h:17">FileMetaData</a>* f) {<br/></li>
<li>&nbsp; <span class="Comment">// NULL <a href="dbformat.h.html#L159" title="db/dbformat.h:159">user_key</a> occurs after all keys and is therefore never before *f<br/></li>
<li></span>&nbsp; <span class="Statement">return</span> (<a href="dbformat.h.html#L159" title="db/dbformat.h:159">user_key</a> != <span class="Constant">NULL</span> &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ucmp-&gt;<a href="../table/table_test.cc.html#L44" title="table/table_test.cc:44">Compare</a>(*<a href="dbformat.h.html#L159" title="db/dbformat.h:159">user_key</a>, f-&gt;smallest.<a href="dbformat.h.html#L159" title="db/dbformat.h:159">user_key</a>()) &lt; <span class="Constant">0</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L112">&#x200c;</a><span class="Type">bool</span> <span class="linkable">SomeFileOverlapsRange</span>(<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <a href="dbformat.h.html#L117" title="db/dbformat.h:117">InternalKeyComparator</a>&amp; icmp,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">bool</span> disjoint_sorted_files,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> std::vector&lt;<a href="version_edit.h.html#L17" title="db/version_edit.h:17">FileMetaData</a>*&gt;&amp; files,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>* smallest_user_key,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>* largest_user_key) {<br/></li>
<li>&nbsp; <span class="Type">const</span> <a href="skiplist_test.cc.html#L17" title="db/skiplist_test.cc:17">Comparator</a>* ucmp = icmp.<a href="db_impl.h.html#L197" title="db/db_impl.h:197">user_comparator</a>();<br/></li>
<li>&nbsp; <span class="Statement">if</span> (!disjoint_sorted_files) {<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// Need to check against all files<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">for</span> (<span class="Type">size_t</span> i = <span class="Constant">0</span>; i &lt; files.<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>(); i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Type">const</span> <a href="version_edit.h.html#L17" title="db/version_edit.h:17">FileMetaData</a>* f = files[i];<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L98" title="db/version_set.cc:98">AfterFile</a>(ucmp, smallest_user_key, f) ||<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L105" title="db/version_set.cc:105">BeforeFile</a>(ucmp, largest_user_key, f)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">// No overlap<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">true</span>;&nbsp; <span class="Comment">// Overlap<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">false</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// Binary search over file list<br/></li>
<li></span>&nbsp; <span class="Type"><a href="../port/win/stdint.h.html#L21" title="port/win/stdint.h:21">uint32_t</a></span> index = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (smallest_user_key != <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// <a href="version_set_test.cc.html#L35" title="db/version_set_test.cc:35">Find</a> the earliest possible internal <a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a> for smallest_user_key<br/></li>
<li></span>&nbsp; &nbsp; <a href="dbformat.h.html#L148" title="db/dbformat.h:148">InternalKey</a> small(*smallest_user_key, kMaxSequenceNumber,kValueTypeForSeek);<br/></li>
<li>&nbsp; &nbsp; index = <a href="#L77" title="db/version_set.cc:77">FindFile</a>(icmp, files, small.<a href="dbformat.h.html#L154" title="db/dbformat.h:154">Encode</a>());<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">if</span> (index &gt;= files.<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>()) {<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// beginning of range is after all files, so no overlap.<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">false</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">return</span> !<a href="#L105" title="db/version_set.cc:105">BeforeFile</a>(ucmp, largest_user_key, files[index]);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">// An internal iterator.&nbsp; For a given version/<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> pair, yields<br/></li>
<li></span><span class="Comment">// information about the files in the <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>.&nbsp; For a given entry, <a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>()<br/></li>
<li></span><span class="Comment">// is the largest <a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a> that occurs in the file, and <a href="../table/two_level_iterator.cc.html#L41" title="table/two_level_iterator.cc:41">value</a>() is an<br/></li>
<li></span><span class="Comment">// 16-byte <a href="../table/two_level_iterator.cc.html#L41" title="table/two_level_iterator.cc:41">value</a> containing the file number and file <a href="../table/format.h.html#L31" title="table/format.h:31">size</a>, both<br/></li>
<li></span><span class="Comment">// encoded using <a href="../util/coding.cc.html#L20" title="util/coding.cc:20">EncodeFixed64</a>.<br/></li>
<li></span><span class="Type">class</span> <a href="version_set.h.html#L150" title="db/version_set.h:150">Version</a>::<a href="#L156" title="db/version_set.cc:156">LevelFileNumIterator</a> : <span class="Statement">public</span> <a href="../table/iterator.cc.html#L9" title="table/iterator.cc:9">Iterator</a> {<br/></li>
<li><span class="cUserCont"> </span><span class="Statement">public</span><span class="cUserCont">:<br/></li>
<li><a id="L156">&#x200c;</a></span>&nbsp; <span class="linkable">LevelFileNumIterator</span>(<span class="Type">const</span> <a href="dbformat.h.html#L117" title="db/dbformat.h:117">InternalKeyComparator</a>&amp; icmp,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type">const</span> std::vector&lt;<a href="version_edit.h.html#L17" title="db/version_edit.h:17">FileMetaData</a>*&gt;* flist)<br/></li>
<li>&nbsp; &nbsp; &nbsp; : icmp_(icmp),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; flist_(flist),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; index_(flist-&gt;<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>()) {&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">// Marks as invalid<br/></li>
<li></span>&nbsp; }<br/></li>
<li><a id="L162">&#x200c;</a>&nbsp; <span class="Type">virtual</span> <span class="Type">bool</span> <span class="linkable">Valid</span>() <span class="Type">const</span> {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> index_ &lt; flist_-&gt;<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>();<br/></li>
<li>&nbsp; }<br/></li>
<li><a id="L165">&#x200c;</a>&nbsp; <span class="Type">virtual</span> <span class="Type">void</span> <span class="linkable">Seek</span>(<span class="Type">const</span> <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>&amp; <a href="../include/leveldb/env.h.html#L280" title="include/leveldb/env.h:280">target</a>) {<br/></li>
<li>&nbsp; &nbsp; index_ = <a href="#L77" title="db/version_set.cc:77">FindFile</a>(icmp_, *flist_, <a href="../include/leveldb/env.h.html#L280" title="include/leveldb/env.h:280">target</a>);<br/></li>
<li>&nbsp; }<br/></li>
<li><a id="L168">&#x200c;</a>&nbsp; <span class="Type">virtual</span> <span class="Type">void</span> <span class="linkable">SeekToFirst</span>() { index_ = <span class="Constant">0</span>; }<br/></li>
<li><a id="L169">&#x200c;</a>&nbsp; <span class="Type">virtual</span> <span class="Type">void</span> <span class="linkable">SeekToLast</span>() {<br/></li>
<li>&nbsp; &nbsp; index_ = flist_-&gt;<a href="../table/block_builder.h.html#L38" title="table/block_builder.h:38">empty</a>() ? <span class="Constant">0</span> : flist_-&gt;<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>() - <span class="Constant">1</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li><a id="L172">&#x200c;</a>&nbsp; <span class="Type">virtual</span> <span class="Type">void</span> <span class="linkable">Next</span>() {<br/></li>
<li>&nbsp; &nbsp; assert(<a href="../table/two_level_iterator.cc.html#L34" title="table/two_level_iterator.cc:34">Valid</a>());<br/></li>
<li>&nbsp; &nbsp; index_++;<br/></li>
<li>&nbsp; }<br/></li>
<li><a id="L176">&#x200c;</a>&nbsp; <span class="Type">virtual</span> <span class="Type">void</span> <span class="linkable">Prev</span>() {<br/></li>
<li>&nbsp; &nbsp; assert(<a href="../table/two_level_iterator.cc.html#L34" title="table/two_level_iterator.cc:34">Valid</a>());<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (index_ == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; index_ = flist_-&gt;<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>();&nbsp; <span class="Comment">// Marks as invalid<br/></li>
<li></span>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; index_--;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li><a id="L184">&#x200c;</a>&nbsp; <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a> <span class="linkable">key</span>() <span class="Type">const</span> {<br/></li>
<li>&nbsp; &nbsp; assert(<a href="../table/two_level_iterator.cc.html#L34" title="table/two_level_iterator.cc:34">Valid</a>());<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> (*flist_)[index_]-&gt;largest.<a href="dbformat.h.html#L154" title="db/dbformat.h:154">Encode</a>();<br/></li>
<li>&nbsp; }<br/></li>
<li><a id="L188">&#x200c;</a>&nbsp; <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a> <span class="linkable">value</span>() <span class="Type">const</span> {<br/></li>
<li>&nbsp; &nbsp; assert(<a href="../table/two_level_iterator.cc.html#L34" title="table/two_level_iterator.cc:34">Valid</a>());<br/></li>
<li>&nbsp; &nbsp; <a href="../util/coding.cc.html#L20" title="util/coding.cc:20">EncodeFixed64</a>(value_buf_, (*flist_)[index_]-&gt;number);<br/></li>
<li>&nbsp; &nbsp; <a href="../util/coding.cc.html#L20" title="util/coding.cc:20">EncodeFixed64</a>(value_buf_+<span class="Constant">8</span>, (*flist_)[index_]-&gt;file_size);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>(value_buf_, <span class="Statement">sizeof</span>(value_buf_));<br/></li>
<li>&nbsp; }<br/></li>
<li><a id="L194">&#x200c;</a>&nbsp; <span class="Type">virtual</span> <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> <span class="linkable">status</span>() <span class="Type">const</span> { <span class="Statement">return</span> <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a>::<a href="../include/leveldb/status.h.html#L32" title="include/leveldb/status.h:32">OK</a>(); }<br/></li>
<li><span class="cUserCont"> </span><span class="Statement">private</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; <span class="Type">const</span> <a href="dbformat.h.html#L117" title="db/dbformat.h:117">InternalKeyComparator</a> icmp_;<br/></li>
<li>&nbsp; <span class="Type">const</span> std::vector&lt;<a href="version_edit.h.html#L17" title="db/version_edit.h:17">FileMetaData</a>*&gt;* <span class="Type">const</span> flist_;<br/></li>
<li>&nbsp; <span class="Type"><a href="../port/win/stdint.h.html#L21" title="port/win/stdint.h:21">uint32_t</a></span> index_;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// Backing store for <a href="../table/two_level_iterator.cc.html#L41" title="table/two_level_iterator.cc:41">value</a>().&nbsp; Holds the file number and <a href="../table/format.h.html#L31" title="table/format.h:31">size</a>.<br/></li>
<li></span>&nbsp; <span class="Type">mutable</span> <span class="Type">char</span> value_buf_[<span class="Constant">16</span>];<br/></li>
<li>};<br/></li>
<li><br/></li>
<li><a id="L204">&#x200c;</a><span class="Type">static</span> <a href="../table/iterator.cc.html#L9" title="table/iterator.cc:9">Iterator</a>* <span class="linkable">GetFileIterator</span>(<span class="Type">void</span>* arg,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type">const</span> <a href="../include/leveldb/options.h.html#L143" title="include/leveldb/options.h:143">ReadOptions</a>&amp; options,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type">const</span> <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>&amp; file_value) {<br/></li>
<li>&nbsp; <a href="table_cache.cc.html#L32" title="db/table_cache.cc:32">TableCache</a>* cache = <span class="Statement">reinterpret_cast</span>&lt;<a href="table_cache.cc.html#L32" title="db/table_cache.cc:32">TableCache</a>*&gt;(arg);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (file_value.<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>() != <span class="Constant">16</span>) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../table/iterator.cc.html#L63" title="table/iterator.cc:63">NewErrorIterator</a>(<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a>::<a href="../include/leveldb/status.h.html#L38" title="include/leveldb/status.h:38">Corruption</a>(<span class="Constant">&quot;FileReader invoked with unexpected <a href="../table/two_level_iterator.cc.html#L41" title="table/two_level_iterator.cc:41">value</a>&quot;</span>));<br/></li>
<li>&nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> cache-&gt;<a href="../table/table_test.cc.html#L209" title="table/table_test.cc:209">NewIterator</a>(options,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../util/coding.h.html#L72" title="util/coding.h:72">DecodeFixed64</a>(file_value.<a href="../table/table_test.cc.html#L173" title="table/table_test.cc:173">data</a>()),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../util/coding.h.html#L72" title="util/coding.h:72">DecodeFixed64</a>(file_value.<a href="../table/table_test.cc.html#L173" title="table/table_test.cc:173">data</a>() + <span class="Constant">8</span>));<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L218">&#x200c;</a><a href="../table/iterator.cc.html#L9" title="table/iterator.cc:9">Iterator</a>* <a href="version_set.h.html#L150" title="db/version_set.h:150">Version</a>::<span class="linkable">NewConcatenatingIterator</span>(<span class="Type">const</span> <a href="../include/leveldb/options.h.html#L143" title="include/leveldb/options.h:143">ReadOptions</a>&amp; options,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>) <span class="Type">const</span> {<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="../table/two_level_iterator.cc.html#L174" title="table/two_level_iterator.cc:174">NewTwoLevelIterator</a>(<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">new</span> <a href="#L156" title="db/version_set.cc:156">LevelFileNumIterator</a>(vset_-&gt;icmp_, &amp;files_[<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>]),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &amp;<a href="#L204" title="db/version_set.cc:204">GetFileIterator</a>, vset_-&gt;table_cache_, options);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L225">&#x200c;</a><span class="Type">void</span> <a href="version_set.h.html#L150" title="db/version_set.h:150">Version</a>::<span class="linkable">AddIterators</span>(<span class="Type">const</span> <a href="../include/leveldb/options.h.html#L143" title="include/leveldb/options.h:143">ReadOptions</a>&amp; options,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; std::vector&lt;<a href="../table/iterator.cc.html#L9" title="table/iterator.cc:9">Iterator</a>*&gt;* iters) {<br/></li>
<li>&nbsp; <span class="Comment">// <a href="db_bench.cc.html#L188" title="db/db_bench.cc:188">Merge</a> all <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> zero files together since they may overlap<br/></li>
<li></span>&nbsp; <span class="Statement">for</span> (<span class="Type">size_t</span> i = <span class="Constant">0</span>; i &lt; files_[<span class="Constant">0</span>].<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>(); i++) {<br/></li>
<li>&nbsp; &nbsp; iters-&gt;push_back(<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; vset_-&gt;table_cache_-&gt;<a href="../table/table_test.cc.html#L209" title="table/table_test.cc:209">NewIterator</a>(<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; options, files_[<span class="Constant">0</span>][i]-&gt;number, files_[<span class="Constant">0</span>][i]-&gt;file_size));<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// For levels &gt; 0, we can use a concatenating iterator that sequentially<br/></li>
<li></span>&nbsp; <span class="Comment">// walks through the non-overlapping files in the <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>, opening them<br/></li>
<li></span>&nbsp; <span class="Comment">// lazily.<br/></li>
<li></span>&nbsp; <span class="Statement">for</span> (<span class="Type">int</span> <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> = <span class="Constant">1</span>; <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> &lt; config::kNumLevels; <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>++) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!files_[<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>].<a href="../table/block_builder.h.html#L38" title="table/block_builder.h:38">empty</a>()) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; iters-&gt;push_back(<a href="#L218" title="db/version_set.cc:218">NewConcatenatingIterator</a>(options, <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>));<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">// Callback from <a href="table_cache.cc.html#L32" title="db/table_cache.cc:32">TableCache</a>::<a href="#L323" title="db/version_set.cc:323">Get</a>()<br/></li>
<li></span><span class="Type">namespace</span> {<br/></li>
<li><a id="L246">&#x200c;</a><span class="Type">enum</span> <span class="linkable">SaverState</span> {<br/></li>
<li>&nbsp; kNotFound,<br/></li>
<li>&nbsp; kFound,<br/></li>
<li>&nbsp; kDeleted,<br/></li>
<li>&nbsp; kCorrupt,<br/></li>
<li>};<br/></li>
<li><a id="L252">&#x200c;</a><span class="Type">struct</span> <span class="linkable">Saver</span> {<br/></li>
<li>&nbsp; <a href="#L246" title="db/version_set.cc:246">SaverState</a> state;<br/></li>
<li>&nbsp; <span class="Type">const</span> <a href="skiplist_test.cc.html#L17" title="db/skiplist_test.cc:17">Comparator</a>* ucmp;<br/></li>
<li>&nbsp; <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a> <a href="dbformat.h.html#L159" title="db/dbformat.h:159">user_key</a>;<br/></li>
<li>&nbsp; std::string* <a href="../table/two_level_iterator.cc.html#L41" title="table/two_level_iterator.cc:41">value</a>;<br/></li>
<li>};<br/></li>
<li>}<br/></li>
<li><a id="L259">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">SaveValue</span>(<span class="Type">void</span>* arg, <span class="Type">const</span> <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>&amp; ikey, <span class="Type">const</span> <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>&amp; v) {<br/></li>
<li>&nbsp; <a href="#L252" title="db/version_set.cc:252">Saver</a>* s = <span class="Statement">reinterpret_cast</span>&lt;<a href="#L252" title="db/version_set.cc:252">Saver</a>*&gt;(arg);<br/></li>
<li>&nbsp; <a href="dbformat.h.html#L70" title="db/dbformat.h:70">ParsedInternalKey</a> parsed_key;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (!<a href="dbformat.h.html#L176" title="db/dbformat.h:176">ParseInternalKey</a>(ikey, &amp;parsed_key)) {<br/></li>
<li>&nbsp; &nbsp; s-&gt;state = kCorrupt;<br/></li>
<li>&nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (s-&gt;ucmp-&gt;<a href="../table/table_test.cc.html#L44" title="table/table_test.cc:44">Compare</a>(parsed_key.<a href="dbformat.h.html#L159" title="db/dbformat.h:159">user_key</a>, s-&gt;<a href="dbformat.h.html#L159" title="db/dbformat.h:159">user_key</a>) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; s-&gt;state = (parsed_key.type == kTypeValue) ? kFound : kDeleted;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (s-&gt;state == kFound) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; s-&gt;<a href="../table/two_level_iterator.cc.html#L41" title="table/two_level_iterator.cc:41">value</a>-&gt;assign(v.<a href="../table/table_test.cc.html#L173" title="table/table_test.cc:173">data</a>(), v.<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>());<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L274">&#x200c;</a><span class="Type">static</span> <span class="Type">bool</span> <span class="linkable">NewestFirst</span>(<a href="version_edit.h.html#L17" title="db/version_edit.h:17">FileMetaData</a>* a, <a href="version_edit.h.html#L17" title="db/version_edit.h:17">FileMetaData</a>* b) {<br/></li>
<li>&nbsp; <span class="Statement">return</span> a-&gt;number &gt; b-&gt;number;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L278">&#x200c;</a><span class="Type">void</span> <a href="version_set.h.html#L150" title="db/version_set.h:150">Version</a>::<span class="linkable">ForEachOverlapping</span>(<a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a> <a href="dbformat.h.html#L159" title="db/dbformat.h:159">user_key</a>, <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a> <a href="dbformat.h.html#L201" title="db/dbformat.h:201">internal_key</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type">void</span>* arg,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type">bool</span> (*func)(<span class="Type">void</span>*, <span class="Type">int</span>, <a href="version_edit.h.html#L17" title="db/version_edit.h:17">FileMetaData</a>*)) {<br/></li>
<li>&nbsp; <span class="Comment">// </span><span class="Todo">TODO</span><span class="Comment">(sanjay): <a href="skiplist_test.cc.html#L323" title="db/skiplist_test.cc:323">Change</a> <a href="version_set.h.html#L150" title="db/version_set.h:150">Version</a>::<a href="#L323" title="db/version_set.cc:323">Get</a>() to use this function.<br/></li>
<li></span>&nbsp; <span class="Type">const</span> <a href="skiplist_test.cc.html#L17" title="db/skiplist_test.cc:17">Comparator</a>* ucmp = vset_-&gt;icmp_.<a href="db_impl.h.html#L197" title="db/db_impl.h:197">user_comparator</a>();<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// Search <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>-0 in order from <a href="snapshot.h.html#L39" title="db/snapshot.h:39">newest</a> to <a href="snapshot.h.html#L38" title="db/snapshot.h:38">oldest</a>.<br/></li>
<li></span>&nbsp; std::vector&lt;<a href="version_edit.h.html#L17" title="db/version_edit.h:17">FileMetaData</a>*&gt; tmp;<br/></li>
<li>&nbsp; tmp.reserve(files_[<span class="Constant">0</span>].<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>());<br/></li>
<li>&nbsp; <span class="Statement">for</span> (<span class="Type"><a href="../port/win/stdint.h.html#L21" title="port/win/stdint.h:21">uint32_t</a></span> i = <span class="Constant">0</span>; i &lt; files_[<span class="Constant">0</span>].<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>(); i++) {<br/></li>
<li>&nbsp; &nbsp; <a href="version_edit.h.html#L17" title="db/version_edit.h:17">FileMetaData</a>* f = files_[<span class="Constant">0</span>][i];<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ucmp-&gt;<a href="../table/table_test.cc.html#L44" title="table/table_test.cc:44">Compare</a>(<a href="dbformat.h.html#L159" title="db/dbformat.h:159">user_key</a>, f-&gt;smallest.<a href="dbformat.h.html#L159" title="db/dbformat.h:159">user_key</a>()) &gt;= <span class="Constant">0</span> &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ucmp-&gt;<a href="../table/table_test.cc.html#L44" title="table/table_test.cc:44">Compare</a>(<a href="dbformat.h.html#L159" title="db/dbformat.h:159">user_key</a>, f-&gt;largest.<a href="dbformat.h.html#L159" title="db/dbformat.h:159">user_key</a>()) &lt;= <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; tmp.push_back(f);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">if</span> (!tmp.<a href="../table/block_builder.h.html#L38" title="table/block_builder.h:38">empty</a>()) {<br/></li>
<li>&nbsp; &nbsp; std::sort(tmp.begin(), tmp.end(), <a href="#L274" title="db/version_set.cc:274">NewestFirst</a>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (<span class="Type"><a href="../port/win/stdint.h.html#L21" title="port/win/stdint.h:21">uint32_t</a></span> i = <span class="Constant">0</span>; i &lt; tmp.<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>(); i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!(*func)(arg, <span class="Constant">0</span>, tmp[i])) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// Search other levels.<br/></li>
<li></span>&nbsp; <span class="Statement">for</span> (<span class="Type">int</span> <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> = <span class="Constant">1</span>; <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> &lt; config::kNumLevels; <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>++) {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span> num_files = files_[<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>].<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>();<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (num_files == <span class="Constant">0</span>) <span class="Statement">continue</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// Binary search to find earliest index whose largest <a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a> &gt;= <a href="dbformat.h.html#L201" title="db/dbformat.h:201">internal_key</a>.<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type"><a href="../port/win/stdint.h.html#L21" title="port/win/stdint.h:21">uint32_t</a></span> index = <a href="#L77" title="db/version_set.cc:77">FindFile</a>(vset_-&gt;icmp_, files_[<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>], <a href="dbformat.h.html#L201" title="db/dbformat.h:201">internal_key</a>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (index &lt; num_files) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="version_edit.h.html#L17" title="db/version_edit.h:17">FileMetaData</a>* f = files_[<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>][index];<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ucmp-&gt;<a href="../table/table_test.cc.html#L44" title="table/table_test.cc:44">Compare</a>(<a href="dbformat.h.html#L159" title="db/dbformat.h:159">user_key</a>, f-&gt;smallest.<a href="dbformat.h.html#L159" title="db/dbformat.h:159">user_key</a>()) &lt; <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">// All of &quot;f&quot; is past any <a href="../table/table_test.cc.html#L173" title="table/table_test.cc:173">data</a> for <a href="dbformat.h.html#L159" title="db/dbformat.h:159">user_key</a><br/></li>
<li></span>&nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!(*func)(arg, <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>, f)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L323">&#x200c;</a><a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> <a href="version_set.h.html#L150" title="db/version_set.h:150">Version</a>::<span class="linkable">Get</span>(<span class="Type">const</span> <a href="../include/leveldb/options.h.html#L143" title="include/leveldb/options.h:143">ReadOptions</a>&amp; options,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">const</span> <a href="dbformat.cc.html#L121" title="db/dbformat.cc:121">LookupKey</a>&amp; k,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; std::string* <a href="../table/two_level_iterator.cc.html#L41" title="table/two_level_iterator.cc:41">value</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="version_set.h.html#L69" title="db/version_set.h:69">GetStats</a>* stats) {<br/></li>
<li>&nbsp; <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a> ikey = k.<a href="dbformat.h.html#L201" title="db/dbformat.h:201">internal_key</a>();<br/></li>
<li>&nbsp; <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a> <a href="dbformat.h.html#L159" title="db/dbformat.h:159">user_key</a> = k.<a href="dbformat.h.html#L159" title="db/dbformat.h:159">user_key</a>();<br/></li>
<li>&nbsp; <span class="Type">const</span> <a href="skiplist_test.cc.html#L17" title="db/skiplist_test.cc:17">Comparator</a>* ucmp = vset_-&gt;icmp_.<a href="db_impl.h.html#L197" title="db/db_impl.h:197">user_comparator</a>();<br/></li>
<li>&nbsp; <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> s;<br/></li>
<li><br/></li>
<li>&nbsp; stats-&gt;seek_file = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; stats-&gt;seek_file_level = -<span class="Constant">1</span>;<br/></li>
<li>&nbsp; <a href="version_edit.h.html#L17" title="db/version_edit.h:17">FileMetaData</a>* last_file_read = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; <span class="Type">int</span> last_file_read_level = -<span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// We can search <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>-by-<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> since entries never hop across<br/></li>
<li></span>&nbsp; <span class="Comment">// levels.&nbsp; Therefore we are guaranteed that if we find <a href="../table/table_test.cc.html#L173" title="table/table_test.cc:173">data</a><br/></li>
<li></span>&nbsp; <span class="Comment">// in an smaller <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>, later levels are irrelevant.<br/></li>
<li></span>&nbsp; std::vector&lt;<a href="version_edit.h.html#L17" title="db/version_edit.h:17">FileMetaData</a>*&gt; tmp;<br/></li>
<li>&nbsp; <a href="version_edit.h.html#L17" title="db/version_edit.h:17">FileMetaData</a>* tmp2;<br/></li>
<li>&nbsp; <span class="Statement">for</span> (<span class="Type">int</span> <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> = <span class="Constant">0</span>; <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> &lt; config::kNumLevels; <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>++) {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span> num_files = files_[<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>].<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>();<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (num_files == <span class="Constant">0</span>) <span class="Statement">continue</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// <a href="#L323" title="db/version_set.cc:323">Get</a> the list of files to search in this <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a><br/></li>
<li></span>&nbsp; &nbsp; <a href="version_edit.h.html#L17" title="db/version_edit.h:17">FileMetaData</a>* <span class="Type">const</span>* files = &amp;files_[<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>][<span class="Constant">0</span>];<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Comment">// Level-0 files may overlap each other.&nbsp; <a href="version_set_test.cc.html#L35" title="db/version_set_test.cc:35">Find</a> all files that<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Comment">// overlap <a href="dbformat.h.html#L159" title="db/dbformat.h:159">user_key</a> and process them in order from <a href="snapshot.h.html#L39" title="db/snapshot.h:39">newest</a> to <a href="snapshot.h.html#L38" title="db/snapshot.h:38">oldest</a>.<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; tmp.reserve(num_files);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (<span class="Type"><a href="../port/win/stdint.h.html#L21" title="port/win/stdint.h:21">uint32_t</a></span> i = <span class="Constant">0</span>; i &lt; num_files; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="version_edit.h.html#L17" title="db/version_edit.h:17">FileMetaData</a>* f = files[i];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ucmp-&gt;<a href="../table/table_test.cc.html#L44" title="table/table_test.cc:44">Compare</a>(<a href="dbformat.h.html#L159" title="db/dbformat.h:159">user_key</a>, f-&gt;smallest.<a href="dbformat.h.html#L159" title="db/dbformat.h:159">user_key</a>()) &gt;= <span class="Constant">0</span> &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ucmp-&gt;<a href="../table/table_test.cc.html#L44" title="table/table_test.cc:44">Compare</a>(<a href="dbformat.h.html#L159" title="db/dbformat.h:159">user_key</a>, f-&gt;largest.<a href="dbformat.h.html#L159" title="db/dbformat.h:159">user_key</a>()) &lt;= <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tmp.push_back(f);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (tmp.<a href="../table/block_builder.h.html#L38" title="table/block_builder.h:38">empty</a>()) <span class="Statement">continue</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; std::sort(tmp.begin(), tmp.end(), <a href="#L274" title="db/version_set.cc:274">NewestFirst</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; files = &amp;tmp[<span class="Constant">0</span>];<br/></li>
<li>&nbsp; &nbsp; &nbsp; num_files = tmp.<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>();<br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Comment">// Binary search to find earliest index whose largest <a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a> &gt;= ikey.<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Type"><a href="../port/win/stdint.h.html#L21" title="port/win/stdint.h:21">uint32_t</a></span> index = <a href="#L77" title="db/version_set.cc:77">FindFile</a>(vset_-&gt;icmp_, files_[<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>], ikey);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (index &gt;= num_files) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; files = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; num_files = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; tmp2 = files[index];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ucmp-&gt;<a href="../table/table_test.cc.html#L44" title="table/table_test.cc:44">Compare</a>(<a href="dbformat.h.html#L159" title="db/dbformat.h:159">user_key</a>, tmp2-&gt;smallest.<a href="dbformat.h.html#L159" title="db/dbformat.h:159">user_key</a>()) &lt; <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">// All of &quot;tmp2&quot; is past any <a href="../table/table_test.cc.html#L173" title="table/table_test.cc:173">data</a> for <a href="dbformat.h.html#L159" title="db/dbformat.h:159">user_key</a><br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; files = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; num_files = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; files = &amp;tmp2;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; num_files = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (<span class="Type"><a href="../port/win/stdint.h.html#L21" title="port/win/stdint.h:21">uint32_t</a></span> i = <span class="Constant">0</span>; i &lt; num_files; ++i) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (last_file_read != <span class="Constant">NULL</span> &amp;&amp; stats-&gt;seek_file == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">// We have had more than one seek for this read.&nbsp; Charge the 1st file.<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; stats-&gt;seek_file = last_file_read;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; stats-&gt;seek_file_level = last_file_read_level;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="version_edit.h.html#L17" title="db/version_edit.h:17">FileMetaData</a>* f = files[i];<br/></li>
<li>&nbsp; &nbsp; &nbsp; last_file_read = f;<br/></li>
<li>&nbsp; &nbsp; &nbsp; last_file_read_level = <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L252" title="db/version_set.cc:252">Saver</a> saver;<br/></li>
<li>&nbsp; &nbsp; &nbsp; saver.state = kNotFound;<br/></li>
<li>&nbsp; &nbsp; &nbsp; saver.ucmp = ucmp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; saver.<a href="dbformat.h.html#L159" title="db/dbformat.h:159">user_key</a> = <a href="dbformat.h.html#L159" title="db/dbformat.h:159">user_key</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; saver.<a href="../table/two_level_iterator.cc.html#L41" title="table/two_level_iterator.cc:41">value</a> = <a href="../table/two_level_iterator.cc.html#L41" title="table/two_level_iterator.cc:41">value</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; s = vset_-&gt;table_cache_-&gt;<a href="#L323" title="db/version_set.cc:323">Get</a>(options, f-&gt;number, f-&gt;file_size,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ikey, &amp;saver, <a href="#L259" title="db/version_set.cc:259">SaveValue</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!s.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>()) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> s;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (saver.state) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> kNotFound:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;&nbsp; &nbsp; &nbsp; <span class="Comment">// Keep searching in other files<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> kFound:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> s;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> kDeleted:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; s = <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a>::<a href="../include/leveldb/status.h.html#L35" title="include/leveldb/status.h:35">NotFound</a>(<a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>());&nbsp; <span class="Comment">// Use <a href="../table/block_builder.h.html#L38" title="table/block_builder.h:38">empty</a> error message for speed<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> s;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> kCorrupt:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; s = <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a>::<a href="../include/leveldb/status.h.html#L38" title="include/leveldb/status.h:38">Corruption</a>(<span class="Constant">&quot;corrupted <a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a> for &quot;</span>, <a href="dbformat.h.html#L159" title="db/dbformat.h:159">user_key</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> s;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a>::<a href="../include/leveldb/status.h.html#L35" title="include/leveldb/status.h:35">NotFound</a>(<a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>());&nbsp; <span class="Comment">// Use an <a href="../table/block_builder.h.html#L38" title="table/block_builder.h:38">empty</a> error message for speed<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><a id="L422">&#x200c;</a><span class="Type">bool</span> <a href="version_set.h.html#L150" title="db/version_set.h:150">Version</a>::<span class="linkable">UpdateStats</span>(<span class="Type">const</span> <a href="version_set.h.html#L69" title="db/version_set.h:69">GetStats</a>&amp; stats) {<br/></li>
<li>&nbsp; <a href="version_edit.h.html#L17" title="db/version_edit.h:17">FileMetaData</a>* f = stats.seek_file;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (f != <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; f-&gt;allowed_seeks--;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (f-&gt;allowed_seeks &lt;= <span class="Constant">0</span> &amp;&amp; file_to_compact_ == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; file_to_compact_ = f;<br/></li>
<li>&nbsp; &nbsp; &nbsp; file_to_compact_level_ = stats.seek_file_level;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> <span class="Constant">false</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L435">&#x200c;</a><span class="Type">bool</span> <a href="version_set.h.html#L150" title="db/version_set.h:150">Version</a>::<span class="linkable">RecordReadSample</span>(<a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a> <a href="dbformat.h.html#L201" title="db/dbformat.h:201">internal_key</a>) {<br/></li>
<li>&nbsp; <a href="dbformat.h.html#L70" title="db/dbformat.h:70">ParsedInternalKey</a> ikey;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (!<a href="dbformat.h.html#L176" title="db/dbformat.h:176">ParseInternalKey</a>(<a href="dbformat.h.html#L201" title="db/dbformat.h:201">internal_key</a>, &amp;ikey)) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">false</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="skiplist_test.cc.html#L188" title="db/skiplist_test.cc:188">State</a> {<br/></li>
<li>&nbsp; &nbsp; <a href="version_set.h.html#L69" title="db/version_set.h:69">GetStats</a> stats;&nbsp; <span class="Comment">// Holds first matching file<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">int</span> matches;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Type">static</span> <span class="Type">bool</span> Match(<span class="Type">void</span>* arg, <span class="Type">int</span> <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>, <a href="version_edit.h.html#L17" title="db/version_edit.h:17">FileMetaData</a>* f) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="skiplist_test.cc.html#L188" title="db/skiplist_test.cc:188">State</a>* state = <span class="Statement">reinterpret_cast</span>&lt;<a href="skiplist_test.cc.html#L188" title="db/skiplist_test.cc:188">State</a>*&gt;(arg);<br/></li>
<li>&nbsp; &nbsp; &nbsp; state-&gt;matches++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (state-&gt;matches == <span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">// Remember first match.<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; state-&gt;stats.seek_file = f;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; state-&gt;stats.seek_file_level = <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Comment">// We can stop iterating once we have a second match.<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span> state-&gt;matches &lt; <span class="Constant">2</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; };<br/></li>
<li><br/></li>
<li>&nbsp; <a href="skiplist_test.cc.html#L188" title="db/skiplist_test.cc:188">State</a> state;<br/></li>
<li>&nbsp; state.matches = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; <a href="#L278" title="db/version_set.cc:278">ForEachOverlapping</a>(ikey.<a href="dbformat.h.html#L159" title="db/dbformat.h:159">user_key</a>, <a href="dbformat.h.html#L201" title="db/dbformat.h:201">internal_key</a>, &amp;state, &amp;<a href="skiplist_test.cc.html#L188" title="db/skiplist_test.cc:188">State</a>::Match);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// Must have at least two matches since we want to merge across<br/></li>
<li></span>&nbsp; <span class="Comment">// files. But what if we have a single file that contains many<br/></li>
<li></span>&nbsp; <span class="Comment">// overwrites and deletions?&nbsp; Should we have another mechanism for<br/></li>
<li></span>&nbsp; <span class="Comment">// finding such files?<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (state.matches &gt;= <span class="Constant">2</span>) {<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// 1MB cost is about 1 seek (see comment in <a href="#L623" title="db/version_set.cc:623">Builder</a>::<a href="#L656" title="db/version_set.cc:656">Apply</a>).<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L422" title="db/version_set.cc:422">UpdateStats</a>(state.stats);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> <span class="Constant">false</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L473">&#x200c;</a><span class="Type">void</span> <a href="version_set.h.html#L150" title="db/version_set.h:150">Version</a>::<span class="linkable">Ref</span>() {<br/></li>
<li>&nbsp; ++refs_;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L477">&#x200c;</a><span class="Type">void</span> <a href="version_set.h.html#L150" title="db/version_set.h:150">Version</a>::<span class="linkable">Unref</span>() {<br/></li>
<li>&nbsp; assert(<span class="Statement">this</span> != &amp;vset_-&gt;dummy_versions_);<br/></li>
<li>&nbsp; assert(refs_ &gt;= <span class="Constant">1</span>);<br/></li>
<li>&nbsp; --refs_;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (refs_ == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">delete</span> <span class="Statement">this</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L486">&#x200c;</a><span class="Type">bool</span> <a href="version_set.h.html#L150" title="db/version_set.h:150">Version</a>::<span class="linkable">OverlapInLevel</span>(<span class="Type">int</span> <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type">const</span> <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>* smallest_user_key,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type">const</span> <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>* largest_user_key) {<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="#L112" title="db/version_set.cc:112">SomeFileOverlapsRange</a>(vset_-&gt;icmp_, (<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> &gt; <span class="Constant">0</span>), files_[<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>],<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; smallest_user_key, largest_user_key);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L493">&#x200c;</a><span class="Type">int</span> <a href="version_set.h.html#L150" title="db/version_set.h:150">Version</a>::<span class="linkable">PickLevelForMemTableOutput</span>(<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>&amp; smallest_user_key,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>&amp; largest_user_key) {<br/></li>
<li>&nbsp; <span class="Type">int</span> <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (!<a href="#L486" title="db/version_set.cc:486">OverlapInLevel</a>(<span class="Constant">0</span>, &amp;smallest_user_key, &amp;largest_user_key)) {<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// Push to next <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> if there is no overlap in next <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>,<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">// and the #bytes overlapping in the <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> after that are limited.<br/></li>
<li></span>&nbsp; &nbsp; <a href="dbformat.h.html#L148" title="db/dbformat.h:148">InternalKey</a> start(smallest_user_key, kMaxSequenceNumber, kValueTypeForSeek);<br/></li>
<li>&nbsp; &nbsp; <a href="dbformat.h.html#L148" title="db/dbformat.h:148">InternalKey</a> limit(largest_user_key, <span class="Constant">0</span>, <span class="Statement">static_cast</span>&lt;<a href="dbformat.h.html#L51" title="db/dbformat.h:51">ValueType</a>&gt;(<span class="Constant">0</span>));<br/></li>
<li>&nbsp; &nbsp; std::vector&lt;<a href="version_edit.h.html#L17" title="db/version_edit.h:17">FileMetaData</a>*&gt; overlaps;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> &lt; config::kMaxMemCompactLevel) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L486" title="db/version_set.cc:486">OverlapInLevel</a>(<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> + <span class="Constant">1</span>, &amp;smallest_user_key, &amp;largest_user_key)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> + <span class="Constant">2</span> &lt; config::kNumLevels) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">// <a href="corruption_test.cc.html#L88" title="db/corruption_test.cc:88">Check</a> that file does not overlap too many grandparent bytes.<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L522" title="db/version_set.cc:522">GetOverlappingInputs</a>(<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> + <span class="Constant">2</span>, &amp;start, &amp;limit, &amp;overlaps);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">const</span> <span class="Type"><a href="../port/win/stdint.h.html#L18" title="port/win/stdint.h:18">int64_t</a></span> sum = <a href="#L49" title="db/version_set.cc:49">TotalFileSize</a>(overlaps);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (sum &gt; kMaxGrandParentOverlapBytes) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>++;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">// Store in &quot;*inputs&quot; all files in &quot;<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>&quot; that overlap [begin,end]<br/></li>
<li><a id="L522">&#x200c;</a></span><span class="Type">void</span> <a href="version_set.h.html#L150" title="db/version_set.h:150">Version</a>::<span class="linkable">GetOverlappingInputs</span>(<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span> <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <a href="dbformat.h.html#L148" title="db/dbformat.h:148">InternalKey</a>* begin,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <a href="dbformat.h.html#L148" title="db/dbformat.h:148">InternalKey</a>* end,<br/></li>
<li>&nbsp; &nbsp; std::vector&lt;<a href="version_edit.h.html#L17" title="db/version_edit.h:17">FileMetaData</a>*&gt;* inputs) {<br/></li>
<li>&nbsp; assert(<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> &gt;= <span class="Constant">0</span>);<br/></li>
<li>&nbsp; assert(<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> &lt; config::kNumLevels);<br/></li>
<li>&nbsp; inputs-&gt;<a href="../include/leveldb/slice.h.html#L56" title="include/leveldb/slice.h:56">clear</a>();<br/></li>
<li>&nbsp; <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a> user_begin, user_end;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (begin != <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; user_begin = begin-&gt;<a href="dbformat.h.html#L159" title="db/dbformat.h:159">user_key</a>();<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">if</span> (end != <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; user_end = end-&gt;<a href="dbformat.h.html#L159" title="db/dbformat.h:159">user_key</a>();<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Type">const</span> <a href="skiplist_test.cc.html#L17" title="db/skiplist_test.cc:17">Comparator</a>* user_cmp = vset_-&gt;icmp_.<a href="db_impl.h.html#L197" title="db/db_impl.h:197">user_comparator</a>();<br/></li>
<li>&nbsp; <span class="Statement">for</span> (<span class="Type">size_t</span> i = <span class="Constant">0</span>; i &lt; files_[<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>].<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>(); ) {<br/></li>
<li>&nbsp; &nbsp; <a href="version_edit.h.html#L17" title="db/version_edit.h:17">FileMetaData</a>* f = files_[<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>][i++];<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a> file_start = f-&gt;smallest.<a href="dbformat.h.html#L159" title="db/dbformat.h:159">user_key</a>();<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a> file_limit = f-&gt;largest.<a href="dbformat.h.html#L159" title="db/dbformat.h:159">user_key</a>();<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (begin != <span class="Constant">NULL</span> &amp;&amp; user_cmp-&gt;<a href="../table/table_test.cc.html#L44" title="table/table_test.cc:44">Compare</a>(file_limit, user_begin) &lt; <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Comment">// &quot;f&quot; is completely before specified range; skip it<br/></li>
<li></span>&nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (end != <span class="Constant">NULL</span> &amp;&amp; user_cmp-&gt;<a href="../table/table_test.cc.html#L44" title="table/table_test.cc:44">Compare</a>(file_start, user_end) &gt; <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Comment">// &quot;f&quot; is completely after specified range; skip it<br/></li>
<li></span>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; inputs-&gt;push_back(f);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">// Level-0 files may overlap each other.&nbsp; So check if the newly<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">// added file has expanded the range.&nbsp; If so, restart search.<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (begin != <span class="Constant">NULL</span> &amp;&amp; user_cmp-&gt;<a href="../table/table_test.cc.html#L44" title="table/table_test.cc:44">Compare</a>(file_start, user_begin) &lt; <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; user_begin = file_start;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inputs-&gt;<a href="../include/leveldb/slice.h.html#L56" title="include/leveldb/slice.h:56">clear</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (end != <span class="Constant">NULL</span> &amp;&amp; user_cmp-&gt;<a href="../table/table_test.cc.html#L44" title="table/table_test.cc:44">Compare</a>(file_limit, user_end) &gt; <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; user_end = file_limit;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inputs-&gt;<a href="../include/leveldb/slice.h.html#L56" title="include/leveldb/slice.h:56">clear</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L565">&#x200c;</a>std::string <a href="version_set.h.html#L150" title="db/version_set.h:150">Version</a>::<span class="linkable">DebugString</span>() <span class="Type">const</span> {<br/></li>
<li>&nbsp; std::string r;<br/></li>
<li>&nbsp; <span class="Statement">for</span> (<span class="Type">int</span> <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> = <span class="Constant">0</span>; <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> &lt; config::kNumLevels; <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>++) {<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// E.g.,<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">//&nbsp;&nbsp; --- <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> 1 ---<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">//&nbsp;&nbsp; 17:123['a' .. 'd']<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">//&nbsp;&nbsp; 20:43['e' .. 'g']<br/></li>
<li></span>&nbsp; &nbsp; r.append(<span class="Constant">&quot;--- <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> &quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="../util/logging.cc.html#L16" title="util/logging.cc:16">AppendNumberTo</a>(&amp;r, <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>);<br/></li>
<li>&nbsp; &nbsp; r.append(<span class="Constant">&quot; ---</span><span class="Special">\n</span><span class="Constant">&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> std::vector&lt;<a href="version_edit.h.html#L17" title="db/version_edit.h:17">FileMetaData</a>*&gt;&amp; files = files_[<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>];<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (<span class="Type">size_t</span> i = <span class="Constant">0</span>; i &lt; files.<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>(); i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; r.push_back(<span class="Constant">' '</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../util/logging.cc.html#L16" title="util/logging.cc:16">AppendNumberTo</a>(&amp;r, files[i]-&gt;number);<br/></li>
<li>&nbsp; &nbsp; &nbsp; r.push_back(<span class="Constant">':'</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../util/logging.cc.html#L16" title="util/logging.cc:16">AppendNumberTo</a>(&amp;r, files[i]-&gt;file_size);<br/></li>
<li>&nbsp; &nbsp; &nbsp; r.append(<span class="Constant">&quot;[&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; r.append(files[i]-&gt;smallest.<a href="#L565" title="db/version_set.cc:565">DebugString</a>());<br/></li>
<li>&nbsp; &nbsp; &nbsp; r.append(<span class="Constant">&quot; .. &quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; r.append(files[i]-&gt;largest.<a href="#L565" title="db/version_set.cc:565">DebugString</a>());<br/></li>
<li>&nbsp; &nbsp; &nbsp; r.append(<span class="Constant">&quot;]</span><span class="Special">\n</span><span class="Constant">&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> r;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">// A helper class so we can efficiently apply a whole sequence<br/></li>
<li></span><span class="Comment">// of edits to a particular state without creating intermediate<br/></li>
<li></span><span class="Comment">// Versions that contain full copies of the intermediate state.<br/></li>
<li></span><span class="Type">class</span> <a href="#L766" title="db/version_set.cc:766">VersionSet</a>::<a href="#L623" title="db/version_set.cc:623">Builder</a> {<br/></li>
<li><span class="cUserCont"> </span><span class="Statement">private</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; <span class="Comment">// Helper to sort by v-&gt;files_[file_number].smallest<br/></li>
<li><a id="L597">&#x200c;</a></span>&nbsp; <span class="Type">struct</span> <span class="linkable">BySmallestKey</span> {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <a href="dbformat.h.html#L117" title="db/dbformat.h:117">InternalKeyComparator</a>* internal_comparator;<br/></li>
<li><br/></li>
<li><a id="L600">&#x200c;</a>&nbsp; &nbsp; <span class="Type">bool</span> <span class="Statement">operator</span>()(<a href="version_edit.h.html#L17" title="db/version_edit.h:17">FileMetaData</a>* f1, <a href="version_edit.h.html#L17" title="db/version_edit.h:17">FileMetaData</a>* f2) <span class="Type">const</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Type">int</span> r = internal_comparator-&gt;<a href="../table/table_test.cc.html#L44" title="table/table_test.cc:44">Compare</a>(f1-&gt;smallest, f2-&gt;smallest);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (r != <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> (r &lt; <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">// Break ties by file number<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> (f1-&gt;number &lt; f2-&gt;number);<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; };<br/></li>
<li><br/></li>
<li><a id="L611">&#x200c;</a>&nbsp; <span class="Type">typedef</span> std::set&lt;<a href="version_edit.h.html#L17" title="db/version_edit.h:17">FileMetaData</a>*, <a href="#L597" title="db/version_set.cc:597">BySmallestKey</a>&gt; <span class="linkable">FileSet</span>;<br/></li>
<li><a id="L612">&#x200c;</a>&nbsp; <span class="Type">struct</span> <span class="linkable">LevelState</span> {<br/></li>
<li>&nbsp; &nbsp; std::set&lt;<span class="Type"><a href="../port/win/stdint.h.html#L22" title="port/win/stdint.h:22">uint64_t</a></span>&gt; deleted_files;<br/></li>
<li>&nbsp; &nbsp; <a href="#L611" title="db/version_set.cc:611">FileSet</a>* added_files;<br/></li>
<li>&nbsp; };<br/></li>
<li><br/></li>
<li>&nbsp; <a href="#L766" title="db/version_set.cc:766">VersionSet</a>* vset_;<br/></li>
<li>&nbsp; <a href="version_set.h.html#L150" title="db/version_set.h:150">Version</a>* base_;<br/></li>
<li>&nbsp; <a href="#L612" title="db/version_set.cc:612">LevelState</a> levels_[config::kNumLevels];<br/></li>
<li><br/></li>
<li><span class="cUserCont"> </span><span class="Statement">public</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; <span class="Comment">// Initialize a builder with the files from *base and other info from *vset<br/></li>
<li><a id="L623">&#x200c;</a></span>&nbsp; <span class="linkable">Builder</span>(<a href="#L766" title="db/version_set.cc:766">VersionSet</a>* vset, <a href="version_set.h.html#L150" title="db/version_set.h:150">Version</a>* base)<br/></li>
<li>&nbsp; &nbsp; &nbsp; : vset_(vset),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; base_(base) {<br/></li>
<li>&nbsp; &nbsp; base_-&gt;<a href="#L473" title="db/version_set.cc:473">Ref</a>();<br/></li>
<li>&nbsp; &nbsp; <a href="#L597" title="db/version_set.cc:597">BySmallestKey</a> cmp;<br/></li>
<li>&nbsp; &nbsp; cmp.internal_comparator = &amp;vset_-&gt;icmp_;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (<span class="Type">int</span> <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> = <span class="Constant">0</span>; <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> &lt; config::kNumLevels; <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; levels_[<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>].added_files = <span class="Statement">new</span> <a href="#L611" title="db/version_set.cc:611">FileSet</a>(cmp);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li><a id="L634">&#x200c;</a>&nbsp; ~<a href="#L623" title="db/version_set.cc:623">Builder</a>() {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (<span class="Type">int</span> <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> = <span class="Constant">0</span>; <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> &lt; config::kNumLevels; <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Type">const</span> <a href="#L611" title="db/version_set.cc:611">FileSet</a>* added = levels_[<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>].added_files;<br/></li>
<li>&nbsp; &nbsp; &nbsp; std::vector&lt;<a href="version_edit.h.html#L17" title="db/version_edit.h:17">FileMetaData</a>*&gt; to_unref;<br/></li>
<li>&nbsp; &nbsp; &nbsp; to_unref.reserve(added-&gt;<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>());<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (<a href="#L611" title="db/version_set.cc:611">FileSet</a>::const_iterator it = added-&gt;begin();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; it != added-&gt;end(); ++it) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; to_unref.push_back(*it);<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">delete</span> added;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (<span class="Type"><a href="../port/win/stdint.h.html#L21" title="port/win/stdint.h:21">uint32_t</a></span> i = <span class="Constant">0</span>; i &lt; to_unref.<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>(); i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="version_edit.h.html#L17" title="db/version_edit.h:17">FileMetaData</a>* f = to_unref[i];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; f-&gt;refs--;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (f-&gt;refs &lt;= <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">delete</span> f;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; base_-&gt;<a href="#L477" title="db/version_set.cc:477">Unref</a>();<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// <a href="#L656" title="db/version_set.cc:656">Apply</a> all of the edits in *<a href="version_set.h.html#L332" title="db/version_set.h:332">edit</a> to the <a href="version_set.h.html#L185" title="db/version_set.h:185">current</a> state.<br/></li>
<li><a id="L656">&#x200c;</a></span>&nbsp; <span class="Type">void</span> <span class="linkable">Apply</span>(<a href="version_edit.h.html#L30" title="db/version_edit.h:30">VersionEdit</a>* <a href="version_set.h.html#L332" title="db/version_set.h:332">edit</a>) {<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// <a href="../table/iterator_wrapper.h.html#L49" title="table/iterator_wrapper.h:49">Update</a> compaction pointers<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">for</span> (<span class="Type">size_t</span> i = <span class="Constant">0</span>; i &lt; <a href="version_set.h.html#L332" title="db/version_set.h:332">edit</a>-&gt;compact_pointers_.<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>(); i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Type">const</span> <span class="Type">int</span> <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> = <a href="version_set.h.html#L332" title="db/version_set.h:332">edit</a>-&gt;compact_pointers_[i].first;<br/></li>
<li>&nbsp; &nbsp; &nbsp; vset_-&gt;compact_pointer_[<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>] =<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="version_set.h.html#L332" title="db/version_set.h:332">edit</a>-&gt;compact_pointers_[i].second.<a href="dbformat.h.html#L154" title="db/dbformat.h:154">Encode</a>().<a href="../table/table_test.cc.html#L587" title="table/table_test.cc:587">ToString</a>();<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// <a href="write_batch.cc.html#L105" title="db/write_batch.cc:105">Delete</a> files<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">const</span> <a href="version_edit.h.html#L30" title="db/version_edit.h:30">VersionEdit</a>::<a href="version_edit.h.html#L87" title="db/version_edit.h:87">DeletedFileSet</a>&amp; del = <a href="version_set.h.html#L332" title="db/version_set.h:332">edit</a>-&gt;deleted_files_;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (<a href="version_edit.h.html#L30" title="db/version_edit.h:30">VersionEdit</a>::<a href="version_edit.h.html#L87" title="db/version_edit.h:87">DeletedFileSet</a>::const_iterator <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a> = del.begin();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a> != del.end();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ++<a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Type">const</span> <span class="Type">int</span> <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> = <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;first;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Type">const</span> <span class="Type"><a href="../port/win/stdint.h.html#L22" title="port/win/stdint.h:22">uint64_t</a></span> number = <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;second;<br/></li>
<li>&nbsp; &nbsp; &nbsp; levels_[<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>].deleted_files.insert(number);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// <a href="../table/table_test.cc.html#L146" title="table/table_test.cc:146">Add</a> new files<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">for</span> (<span class="Type">size_t</span> i = <span class="Constant">0</span>; i &lt; <a href="version_set.h.html#L332" title="db/version_set.h:332">edit</a>-&gt;new_files_.<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>(); i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Type">const</span> <span class="Type">int</span> <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> = <a href="version_set.h.html#L332" title="db/version_set.h:332">edit</a>-&gt;new_files_[i].first;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="version_edit.h.html#L17" title="db/version_edit.h:17">FileMetaData</a>* f = <span class="Statement">new</span> <a href="version_edit.h.html#L17" title="db/version_edit.h:17">FileMetaData</a>(<a href="version_set.h.html#L332" title="db/version_set.h:332">edit</a>-&gt;new_files_[i].second);<br/></li>
<li>&nbsp; &nbsp; &nbsp; f-&gt;refs = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Comment">// We arrange to automatically compact this file after<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Comment">// a certain number of seeks.&nbsp; Let's assume:<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Comment">//&nbsp;&nbsp; (1) One seek costs 10ms<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Comment">//&nbsp;&nbsp; (2) Writing or reading 1MB costs 10ms (100MB/s)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Comment">//&nbsp;&nbsp; (3) A compaction of 1MB does 25MB of IO:<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Comment">//&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; 1MB read from this <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a><br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Comment">//&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; 10-12MB read from next <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> (boundaries may be misaligned)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Comment">//&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; 10-12MB written to next <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a><br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Comment">// This implies that 25 seeks cost the same as the compaction<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Comment">// of 1MB of <a href="../table/table_test.cc.html#L173" title="table/table_test.cc:173">data</a>.&nbsp; I.e., one seek costs approximately the<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Comment">// same as the compaction of 40KB of <a href="../table/table_test.cc.html#L173" title="table/table_test.cc:173">data</a>.&nbsp; We are a little<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Comment">// conservative and allow approximately one seek for every 16KB<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Comment">// of <a href="../table/table_test.cc.html#L173" title="table/table_test.cc:173">data</a> before triggering a compaction.<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; f-&gt;allowed_seeks = (f-&gt;file_size / <span class="Constant">16384</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (f-&gt;allowed_seeks &lt; <span class="Constant">100</span>) f-&gt;allowed_seeks = <span class="Constant">100</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; levels_[<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>].deleted_files.erase(f-&gt;number);<br/></li>
<li>&nbsp; &nbsp; &nbsp; levels_[<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>].added_files-&gt;insert(f);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// Save the <a href="version_set.h.html#L185" title="db/version_set.h:185">current</a> state in *v.<br/></li>
<li><a id="L702">&#x200c;</a></span>&nbsp; <span class="Type">void</span> <span class="linkable">SaveTo</span>(<a href="version_set.h.html#L150" title="db/version_set.h:150">Version</a>* v) {<br/></li>
<li>&nbsp; &nbsp; <a href="#L597" title="db/version_set.cc:597">BySmallestKey</a> cmp;<br/></li>
<li>&nbsp; &nbsp; cmp.internal_comparator = &amp;vset_-&gt;icmp_;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (<span class="Type">int</span> <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> = <span class="Constant">0</span>; <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> &lt; config::kNumLevels; <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Comment">// <a href="db_bench.cc.html#L188" title="db/db_bench.cc:188">Merge</a> the set of added files with the set of pre-existing files.<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Comment">// Drop any deleted files.&nbsp; Store the result in *v.<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Type">const</span> std::vector&lt;<a href="version_edit.h.html#L17" title="db/version_edit.h:17">FileMetaData</a>*&gt;&amp; base_files = base_-&gt;files_[<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>];<br/></li>
<li>&nbsp; &nbsp; &nbsp; std::vector&lt;<a href="version_edit.h.html#L17" title="db/version_edit.h:17">FileMetaData</a>*&gt;::const_iterator base_iter = base_files.begin();<br/></li>
<li>&nbsp; &nbsp; &nbsp; std::vector&lt;<a href="version_edit.h.html#L17" title="db/version_edit.h:17">FileMetaData</a>*&gt;::const_iterator base_end = base_files.end();<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Type">const</span> <a href="#L611" title="db/version_set.cc:611">FileSet</a>* added = levels_[<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>].added_files;<br/></li>
<li>&nbsp; &nbsp; &nbsp; v-&gt;files_[<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>].reserve(base_files.<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>() + added-&gt;<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>());<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (<a href="#L611" title="db/version_set.cc:611">FileSet</a>::const_iterator added_iter = added-&gt;begin();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; added_iter != added-&gt;end();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ++added_iter) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">// <a href="../table/table_test.cc.html#L146" title="table/table_test.cc:146">Add</a> all smaller files listed in base_<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (std::vector&lt;<a href="version_edit.h.html#L17" title="db/version_edit.h:17">FileMetaData</a>*&gt;::const_iterator bpos<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; = std::upper_bound(base_iter, base_end, *added_iter, cmp);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; base_iter != bpos;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ++base_iter) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L750" title="db/version_set.cc:750">MaybeAddFile</a>(v, <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>, *base_iter);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L750" title="db/version_set.cc:750">MaybeAddFile</a>(v, <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>, *added_iter);<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Comment">// <a href="../table/table_test.cc.html#L146" title="table/table_test.cc:146">Add</a> remaining base files<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (; base_iter != base_end; ++base_iter) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L750" title="db/version_set.cc:750">MaybeAddFile</a>(v, <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>, *base_iter);<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#ifndef NDEBUG<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Comment">// Make sure there is no overlap in levels &gt; 0<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> &gt; <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (<span class="Type"><a href="../port/win/stdint.h.html#L21" title="port/win/stdint.h:21">uint32_t</a></span> i = <span class="Constant">1</span>; i &lt; v-&gt;files_[<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>].<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>(); i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">const</span> <a href="dbformat.h.html#L148" title="db/dbformat.h:148">InternalKey</a>&amp; prev_end = v-&gt;files_[<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>][i-<span class="Constant">1</span>]-&gt;largest;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">const</span> <a href="dbformat.h.html#L148" title="db/dbformat.h:148">InternalKey</a>&amp; this_begin = v-&gt;files_[<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>][i]-&gt;smallest;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (vset_-&gt;icmp_.<a href="../table/table_test.cc.html#L44" title="table/table_test.cc:44">Compare</a>(prev_end, this_begin) &gt;= <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fprintf(<span class="Constant">stderr</span>, <span class="Constant">&quot;overlapping ranges in same <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> </span><span class="Special">%s</span><span class="Constant"> vs. </span><span class="Special">%s\n</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; prev_end.<a href="#L565" title="db/version_set.cc:565">DebugString</a>().c_str(),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; this_begin.<a href="#L565" title="db/version_set.cc:565">DebugString</a>().c_str());<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; abort();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li><a id="L750">&#x200c;</a>&nbsp; <span class="Type">void</span> <span class="linkable">MaybeAddFile</span>(<a href="version_set.h.html#L150" title="db/version_set.h:150">Version</a>* v, <span class="Type">int</span> <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>, <a href="version_edit.h.html#L17" title="db/version_edit.h:17">FileMetaData</a>* f) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (levels_[<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>].deleted_files.count(f-&gt;number) &gt; <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Comment">// File is deleted: do nothing<br/></li>
<li></span>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; std::vector&lt;<a href="version_edit.h.html#L17" title="db/version_edit.h:17">FileMetaData</a>*&gt;* files = &amp;v-&gt;files_[<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>];<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> &gt; <span class="Constant">0</span> &amp;&amp; !files-&gt;<a href="../table/block_builder.h.html#L38" title="table/block_builder.h:38">empty</a>()) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">// Must not overlap<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; assert(vset_-&gt;icmp_.<a href="../table/table_test.cc.html#L44" title="table/table_test.cc:44">Compare</a>((*files)[files-&gt;<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>()-<span class="Constant">1</span>]-&gt;largest,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; f-&gt;smallest) &lt; <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; f-&gt;refs++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; files-&gt;push_back(f);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>};<br/></li>
<li><br/></li>
<li><a id="L766">&#x200c;</a><span class="linkable">VersionSet</span>::<span class="linkable">VersionSet</span>(<span class="Type">const</span> std::string&amp; <a href="c_test.c.html#L15" title="db/c_test.c:15">dbname</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type">const</span> <a href="../include/leveldb/options.h.html#L31" title="include/leveldb/options.h:31">Options</a>* options,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="table_cache.cc.html#L32" title="db/table_cache.cc:32">TableCache</a>* table_cache,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type">const</span> <a href="dbformat.h.html#L117" title="db/dbformat.h:117">InternalKeyComparator</a>* cmp)<br/></li>
<li>&nbsp; &nbsp; : env_(options-&gt;env),<br/></li>
<li>&nbsp; &nbsp; &nbsp; dbname_(<a href="c_test.c.html#L15" title="db/c_test.c:15">dbname</a>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; options_(options),<br/></li>
<li>&nbsp; &nbsp; &nbsp; table_cache_(table_cache),<br/></li>
<li>&nbsp; &nbsp; &nbsp; icmp_(*cmp),<br/></li>
<li>&nbsp; &nbsp; &nbsp; next_file_number_(<span class="Constant">2</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; manifest_file_number_(<span class="Constant">0</span>),&nbsp; <span class="Comment">// Filled by <a href="#L896" title="db/version_set.cc:896">Recover</a>()<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; last_sequence_(<span class="Constant">0</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; log_number_(<span class="Constant">0</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; prev_log_number_(<span class="Constant">0</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; descriptor_file_(<span class="Constant">NULL</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; descriptor_log_(<span class="Constant">NULL</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; dummy_versions_(<span class="Statement">this</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; current_(<span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; <a href="#L794" title="db/version_set.cc:794">AppendVersion</a>(<span class="Statement">new</span> <a href="version_set.h.html#L150" title="db/version_set.h:150">Version</a>(<span class="Statement">this</span>));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L787">&#x200c;</a><a href="#L766" title="db/version_set.cc:766">VersionSet</a>::~<a href="#L766" title="db/version_set.cc:766">VersionSet</a>() {<br/></li>
<li>&nbsp; current_-&gt;<a href="#L477" title="db/version_set.cc:477">Unref</a>();<br/></li>
<li>&nbsp; assert(dummy_versions_.next_ == &amp;dummy_versions_);&nbsp; <span class="Comment">// List must be <a href="../table/block_builder.h.html#L38" title="table/block_builder.h:38">empty</a><br/></li>
<li></span>&nbsp; <span class="Statement">delete</span> descriptor_log_;<br/></li>
<li>&nbsp; <span class="Statement">delete</span> descriptor_file_;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L794">&#x200c;</a><span class="Type">void</span> <a href="#L766" title="db/version_set.cc:766">VersionSet</a>::<span class="linkable">AppendVersion</span>(<a href="version_set.h.html#L150" title="db/version_set.h:150">Version</a>* v) {<br/></li>
<li>&nbsp; <span class="Comment">// Make &quot;v&quot; <a href="version_set.h.html#L185" title="db/version_set.h:185">current</a><br/></li>
<li></span>&nbsp; assert(v-&gt;refs_ == <span class="Constant">0</span>);<br/></li>
<li>&nbsp; assert(v != current_);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (current_ != <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; current_-&gt;<a href="#L477" title="db/version_set.cc:477">Unref</a>();<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; current_ = v;<br/></li>
<li>&nbsp; v-&gt;<a href="#L473" title="db/version_set.cc:473">Ref</a>();<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// <a href="../table/table_test.cc.html#L100" title="table/table_test.cc:100">Append</a> to linked list<br/></li>
<li></span>&nbsp; v-&gt;prev_ = dummy_versions_.prev_;<br/></li>
<li>&nbsp; v-&gt;next_ = &amp;dummy_versions_;<br/></li>
<li>&nbsp; v-&gt;prev_-&gt;next_ = v;<br/></li>
<li>&nbsp; v-&gt;next_-&gt;prev_ = v;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L811">&#x200c;</a><a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> <a href="#L766" title="db/version_set.cc:766">VersionSet</a>::<span class="linkable">LogAndApply</span>(<a href="version_edit.h.html#L30" title="db/version_edit.h:30">VersionEdit</a>* <a href="version_set.h.html#L332" title="db/version_set.h:332">edit</a>, port::<a href="../port/port_posix.cc.html#L22" title="port/port_posix.cc:22">Mutex</a>* mu) {<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="version_set.h.html#L332" title="db/version_set.h:332">edit</a>-&gt;has_log_number_) {<br/></li>
<li>&nbsp; &nbsp; assert(<a href="version_set.h.html#L332" title="db/version_set.h:332">edit</a>-&gt;log_number_ &gt;= log_number_);<br/></li>
<li>&nbsp; &nbsp; assert(<a href="version_set.h.html#L332" title="db/version_set.h:332">edit</a>-&gt;log_number_ &lt; next_file_number_);<br/></li>
<li>&nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; <a href="version_set.h.html#L332" title="db/version_set.h:332">edit</a>-&gt;<a href="version_edit.h.html#L39" title="db/version_edit.h:39">SetLogNumber</a>(log_number_);<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">if</span> (!<a href="version_set.h.html#L332" title="db/version_set.h:332">edit</a>-&gt;has_prev_log_number_) {<br/></li>
<li>&nbsp; &nbsp; <a href="version_set.h.html#L332" title="db/version_set.h:332">edit</a>-&gt;<a href="version_edit.h.html#L43" title="db/version_edit.h:43">SetPrevLogNumber</a>(prev_log_number_);<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <a href="version_set.h.html#L332" title="db/version_set.h:332">edit</a>-&gt;<a href="version_edit.h.html#L47" title="db/version_edit.h:47">SetNextFile</a>(next_file_number_);<br/></li>
<li>&nbsp; <a href="version_set.h.html#L332" title="db/version_set.h:332">edit</a>-&gt;<a href="version_set.h.html#L212" title="db/version_set.h:212">SetLastSequence</a>(last_sequence_);<br/></li>
<li><br/></li>
<li>&nbsp; <a href="version_set.h.html#L150" title="db/version_set.h:150">Version</a>* v = <span class="Statement">new</span> <a href="version_set.h.html#L150" title="db/version_set.h:150">Version</a>(<span class="Statement">this</span>);<br/></li>
<li>&nbsp; {<br/></li>
<li>&nbsp; &nbsp; <a href="#L623" title="db/version_set.cc:623">Builder</a> builder(<span class="Statement">this</span>, current_);<br/></li>
<li>&nbsp; &nbsp; builder.<a href="#L656" title="db/version_set.cc:656">Apply</a>(<a href="version_set.h.html#L332" title="db/version_set.h:332">edit</a>);<br/></li>
<li>&nbsp; &nbsp; builder.<a href="#L702" title="db/version_set.cc:702">SaveTo</a>(v);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <a href="#L1017" title="db/version_set.cc:1017">Finalize</a>(v);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// Initialize new descriptor log file if necessary by creating<br/></li>
<li></span>&nbsp; <span class="Comment">// a temporary file that contains a snapshot of the <a href="version_set.h.html#L185" title="db/version_set.h:185">current</a> version.<br/></li>
<li></span>&nbsp; std::string new_manifest_file;<br/></li>
<li>&nbsp; <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> s;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (descriptor_log_ == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// No reason to unlock *mu here since we only hit this path in the<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">// first call to <a href="#L811" title="db/version_set.cc:811">LogAndApply</a> (when opening the database).<br/></li>
<li></span>&nbsp; &nbsp; assert(descriptor_file_ == <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; new_manifest_file = <a href="filename.cc.html#L42" title="db/filename.cc:42">DescriptorFileName</a>(dbname_, manifest_file_number_);<br/></li>
<li>&nbsp; &nbsp; <a href="version_set.h.html#L332" title="db/version_set.h:332">edit</a>-&gt;<a href="version_edit.h.html#L47" title="db/version_edit.h:47">SetNextFile</a>(next_file_number_);<br/></li>
<li>&nbsp; &nbsp; s = env_-&gt;<a href="../include/leveldb/env.h.html#L289" title="include/leveldb/env.h:289">NewWritableFile</a>(new_manifest_file, &amp;descriptor_file_);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (s.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>()) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; descriptor_log_ = <span class="Statement">new</span> log::<a href="db_impl.cc.html#L41" title="db/db_impl.cc:41">Writer</a>(descriptor_file_);<br/></li>
<li>&nbsp; &nbsp; &nbsp; s = <a href="#L1054" title="db/version_set.cc:1054">WriteSnapshot</a>(descriptor_log_);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// <a href="../port/port_posix.cc.html#L28" title="port/port_posix.cc:28">Unlock</a> during expensive MANIFEST log write<br/></li>
<li></span>&nbsp; {<br/></li>
<li>&nbsp; &nbsp; mu-&gt;<a href="../port/port_posix.cc.html#L28" title="port/port_posix.cc:28">Unlock</a>();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// <a href="log_test.cc.html#L121" title="db/log_test.cc:121">Write</a> new record to MANIFEST log<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (s.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>()) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; std::string record;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="version_set.h.html#L332" title="db/version_set.h:332">edit</a>-&gt;<a href="../table/format.cc.html#L15" title="table/format.cc:15">EncodeTo</a>(&amp;record);<br/></li>
<li>&nbsp; &nbsp; &nbsp; s = descriptor_log_-&gt;<a href="log_writer.cc.html#L27" title="db/log_writer.cc:27">AddRecord</a>(record);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (s.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>()) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; s = descriptor_file_-&gt;<a href="../table/table_test.cc.html#L98" title="table/table_test.cc:98">Sync</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!s.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>()) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../util/env.cc.html#L27" title="util/env.cc:27">Log</a>(options_-&gt;info_log, <span class="Constant">&quot;MANIFEST write: </span><span class="Special">%s\n</span><span class="Constant">&quot;</span>, s.<a href="../table/table_test.cc.html#L587" title="table/table_test.cc:587">ToString</a>().c_str());<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// If we just created a new descriptor file, install it by writing a<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">// new CURRENT file that points to it.<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (s.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>() &amp;&amp; !new_manifest_file.<a href="../table/block_builder.h.html#L38" title="table/block_builder.h:38">empty</a>()) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; s = <a href="filename.cc.html#L126" title="db/filename.cc:126">SetCurrentFile</a>(env_, dbname_, manifest_file_number_);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; mu-&gt;<a href="../port/port_posix.cc.html#L26" title="port/port_posix.cc:26">Lock</a>();<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// Install the new version<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (s.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>()) {<br/></li>
<li>&nbsp; &nbsp; <a href="#L794" title="db/version_set.cc:794">AppendVersion</a>(v);<br/></li>
<li>&nbsp; &nbsp; log_number_ = <a href="version_set.h.html#L332" title="db/version_set.h:332">edit</a>-&gt;log_number_;<br/></li>
<li>&nbsp; &nbsp; prev_log_number_ = <a href="version_set.h.html#L332" title="db/version_set.h:332">edit</a>-&gt;prev_log_number_;<br/></li>
<li>&nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">delete</span> v;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!new_manifest_file.<a href="../table/block_builder.h.html#L38" title="table/block_builder.h:38">empty</a>()) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">delete</span> descriptor_log_;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">delete</span> descriptor_file_;<br/></li>
<li>&nbsp; &nbsp; &nbsp; descriptor_log_ = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; descriptor_file_ = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; env_-&gt;<a href="../include/leveldb/env.h.html#L296" title="include/leveldb/env.h:296">DeleteFile</a>(new_manifest_file);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">return</span> s;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L896">&#x200c;</a><a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> <a href="#L766" title="db/version_set.cc:766">VersionSet</a>::<span class="linkable">Recover</span>() {<br/></li>
<li>&nbsp; <span class="Type">struct</span> LogReporter : <span class="Statement">public</span> log::<a href="log_reader.cc.html#L18" title="db/log_reader.cc:18">Reader</a>::Reporter {<br/></li>
<li>&nbsp; &nbsp; <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a>* <a href="../table/two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a>;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">virtual</span> <span class="Type">void</span> <a href="../include/leveldb/status.h.html#L38" title="include/leveldb/status.h:38">Corruption</a>(<span class="Type">size_t</span> bytes, <span class="Type">const</span> <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a>&amp; s) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<span class="Statement">this</span>-&gt;<a href="../table/two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a>-&gt;<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>()) *<span class="Statement">this</span>-&gt;<a href="../table/two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a> = s;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; };<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// <a href="../table/table_test.cc.html#L120" title="table/table_test.cc:120">Read</a> &quot;CURRENT&quot; file, which contains a pointer to the <a href="version_set.h.html#L185" title="db/version_set.h:185">current</a> manifest file<br/></li>
<li></span>&nbsp; std::string <a href="version_set.h.html#L185" title="db/version_set.h:185">current</a>;<br/></li>
<li>&nbsp; <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> s = <a href="../util/env.cc.html#L68" title="util/env.cc:68">ReadFileToString</a>(env_, <a href="filename.cc.html#L50" title="db/filename.cc:50">CurrentFileName</a>(dbname_), &amp;<a href="version_set.h.html#L185" title="db/version_set.h:185">current</a>);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (!s.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>()) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> s;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="version_set.h.html#L185" title="db/version_set.h:185">current</a>.<a href="../table/block_builder.h.html#L38" title="table/block_builder.h:38">empty</a>() || <a href="version_set.h.html#L185" title="db/version_set.h:185">current</a>[<a href="version_set.h.html#L185" title="db/version_set.h:185">current</a>.<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>()-<span class="Constant">1</span>] != <span class="Special">'\n'</span>) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a>::<a href="../include/leveldb/status.h.html#L38" title="include/leveldb/status.h:38">Corruption</a>(<span class="Constant">&quot;CURRENT file does not end with newline&quot;</span>);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <a href="version_set.h.html#L185" title="db/version_set.h:185">current</a>.resize(<a href="version_set.h.html#L185" title="db/version_set.h:185">current</a>.<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>() - <span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; std::string dscname = dbname_ + <span class="Constant">&quot;/&quot;</span> + <a href="version_set.h.html#L185" title="db/version_set.h:185">current</a>;<br/></li>
<li>&nbsp; <a href="../include/leveldb/env.h.html#L157" title="include/leveldb/env.h:157">SequentialFile</a>* file;<br/></li>
<li>&nbsp; s = env_-&gt;<a href="../include/leveldb/env.h.html#L283" title="include/leveldb/env.h:283">NewSequentialFile</a>(dscname, &amp;file);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (!s.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>()) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> s;<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Type">bool</span> have_log_number = <span class="Constant">false</span>;<br/></li>
<li>&nbsp; <span class="Type">bool</span> have_prev_log_number = <span class="Constant">false</span>;<br/></li>
<li>&nbsp; <span class="Type">bool</span> have_next_file = <span class="Constant">false</span>;<br/></li>
<li>&nbsp; <span class="Type">bool</span> have_last_sequence = <span class="Constant">false</span>;<br/></li>
<li>&nbsp; <span class="Type"><a href="../port/win/stdint.h.html#L22" title="port/win/stdint.h:22">uint64_t</a></span> next_file = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; <span class="Type"><a href="../port/win/stdint.h.html#L22" title="port/win/stdint.h:22">uint64_t</a></span> last_sequence = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; <span class="Type"><a href="../port/win/stdint.h.html#L22" title="port/win/stdint.h:22">uint64_t</a></span> log_number = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; <span class="Type"><a href="../port/win/stdint.h.html#L22" title="port/win/stdint.h:22">uint64_t</a></span> prev_log_number = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; <a href="#L623" title="db/version_set.cc:623">Builder</a> builder(<span class="Statement">this</span>, current_);<br/></li>
<li><br/></li>
<li>&nbsp; {<br/></li>
<li>&nbsp; &nbsp; LogReporter reporter;<br/></li>
<li>&nbsp; &nbsp; reporter.<a href="../table/two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a> = &amp;s;<br/></li>
<li>&nbsp; &nbsp; log::<a href="log_reader.cc.html#L18" title="db/log_reader.cc:18">Reader</a> reader(file, &amp;reporter, <span class="Constant">true</span><span class="Comment">/*checksum*/</span>, <span class="Constant">0</span><span class="Comment">/*initial_offset*/</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a> record;<br/></li>
<li>&nbsp; &nbsp; std::string scratch;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (reader.<a href="log_reader.cc.html#L59" title="db/log_reader.cc:59">ReadRecord</a>(&amp;record, &amp;scratch) &amp;&amp; s.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>()) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="version_edit.h.html#L30" title="db/version_edit.h:30">VersionEdit</a> <a href="version_set.h.html#L332" title="db/version_set.h:332">edit</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; s = <a href="version_set.h.html#L332" title="db/version_set.h:332">edit</a>.<a href="../table/format.cc.html#L23" title="table/format.cc:23">DecodeFrom</a>(record);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (s.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>()) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="version_set.h.html#L332" title="db/version_set.h:332">edit</a>.has_comparator_ &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="version_set.h.html#L332" title="db/version_set.h:332">edit</a>.comparator_ != icmp_.<a href="db_impl.h.html#L197" title="db/db_impl.h:197">user_comparator</a>()-&gt;<a href="../table/table_test.cc.html#L40" title="table/table_test.cc:40">Name</a>()) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; s = <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a>::<a href="../include/leveldb/status.h.html#L44" title="include/leveldb/status.h:44">InvalidArgument</a>(<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="version_set.h.html#L332" title="db/version_set.h:332">edit</a>.comparator_ + <span class="Constant">&quot; does not match existing comparator &quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; icmp_.<a href="db_impl.h.html#L197" title="db/db_impl.h:197">user_comparator</a>()-&gt;<a href="../table/table_test.cc.html#L40" title="table/table_test.cc:40">Name</a>());<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (s.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>()) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; builder.<a href="#L656" title="db/version_set.cc:656">Apply</a>(&amp;<a href="version_set.h.html#L332" title="db/version_set.h:332">edit</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="version_set.h.html#L332" title="db/version_set.h:332">edit</a>.has_log_number_) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; log_number = <a href="version_set.h.html#L332" title="db/version_set.h:332">edit</a>.log_number_;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; have_log_number = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="version_set.h.html#L332" title="db/version_set.h:332">edit</a>.has_prev_log_number_) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; prev_log_number = <a href="version_set.h.html#L332" title="db/version_set.h:332">edit</a>.prev_log_number_;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; have_prev_log_number = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="version_set.h.html#L332" title="db/version_set.h:332">edit</a>.has_next_file_number_) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; next_file = <a href="version_set.h.html#L332" title="db/version_set.h:332">edit</a>.next_file_number_;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; have_next_file = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="version_set.h.html#L332" title="db/version_set.h:332">edit</a>.has_last_sequence_) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; last_sequence = <a href="version_set.h.html#L332" title="db/version_set.h:332">edit</a>.last_sequence_;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; have_last_sequence = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">delete</span> file;<br/></li>
<li>&nbsp; file = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">if</span> (s.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>()) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!have_next_file) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; s = <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a>::<a href="../include/leveldb/status.h.html#L38" title="include/leveldb/status.h:38">Corruption</a>(<span class="Constant">&quot;no meta-nextfile entry in descriptor&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (!have_log_number) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; s = <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a>::<a href="../include/leveldb/status.h.html#L38" title="include/leveldb/status.h:38">Corruption</a>(<span class="Constant">&quot;no meta-lognumber entry in descriptor&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (!have_last_sequence) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; s = <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a>::<a href="../include/leveldb/status.h.html#L38" title="include/leveldb/status.h:38">Corruption</a>(<span class="Constant">&quot;no last-sequence-number entry in descriptor&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!have_prev_log_number) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; prev_log_number = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L1011" title="db/version_set.cc:1011">MarkFileNumberUsed</a>(prev_log_number);<br/></li>
<li>&nbsp; &nbsp; <a href="#L1011" title="db/version_set.cc:1011">MarkFileNumberUsed</a>(log_number);<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">if</span> (s.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>()) {<br/></li>
<li>&nbsp; &nbsp; <a href="version_set.h.html#L150" title="db/version_set.h:150">Version</a>* v = <span class="Statement">new</span> <a href="version_set.h.html#L150" title="db/version_set.h:150">Version</a>(<span class="Statement">this</span>);<br/></li>
<li>&nbsp; &nbsp; builder.<a href="#L702" title="db/version_set.cc:702">SaveTo</a>(v);<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// Install recovered version<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L1017" title="db/version_set.cc:1017">Finalize</a>(v);<br/></li>
<li>&nbsp; &nbsp; <a href="#L794" title="db/version_set.cc:794">AppendVersion</a>(v);<br/></li>
<li>&nbsp; &nbsp; manifest_file_number_ = next_file;<br/></li>
<li>&nbsp; &nbsp; next_file_number_ = next_file + <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; last_sequence_ = last_sequence;<br/></li>
<li>&nbsp; &nbsp; log_number_ = log_number;<br/></li>
<li>&nbsp; &nbsp; prev_log_number_ = prev_log_number;<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">return</span> s;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1011">&#x200c;</a><span class="Type">void</span> <a href="#L766" title="db/version_set.cc:766">VersionSet</a>::<span class="linkable">MarkFileNumberUsed</span>(<span class="Type"><a href="../port/win/stdint.h.html#L22" title="port/win/stdint.h:22">uint64_t</a></span> number) {<br/></li>
<li>&nbsp; <span class="Statement">if</span> (next_file_number_ &lt;= number) {<br/></li>
<li>&nbsp; &nbsp; next_file_number_ = number + <span class="Constant">1</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1017">&#x200c;</a><span class="Type">void</span> <a href="#L766" title="db/version_set.cc:766">VersionSet</a>::<span class="linkable">Finalize</span>(<a href="version_set.h.html#L150" title="db/version_set.h:150">Version</a>* v) {<br/></li>
<li>&nbsp; <span class="Comment">// Precomputed best <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> for next compaction<br/></li>
<li></span>&nbsp; <span class="Type">int</span> best_level = -<span class="Constant">1</span>;<br/></li>
<li>&nbsp; <span class="Type">double</span> best_score = -<span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">for</span> (<span class="Type">int</span> <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> = <span class="Constant">0</span>; <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> &lt; config::kNumLevels-<span class="Constant">1</span>; <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>++) {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">double</span> score;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Comment">// We treat <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>-0 specially by bounding the number of files<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Comment">// instead of number of bytes for two reasons:<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Comment">//<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Comment">// (1) With larger write-buffer sizes, it is nice not to do too<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Comment">// many <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>-0 compactions.<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Comment">//<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Comment">// (2) The files in <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>-0 are merged on every read and<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Comment">// therefore we wish to avoid too many files when the individual<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Comment">// file <a href="../table/format.h.html#L31" title="table/format.h:31">size</a> is small (perhaps because of a small write-buffer<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Comment">// setting, or very high compression ratios, or lots of<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Comment">// overwrites/deletions).<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; score = v-&gt;files_[<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>].<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>() /<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">static_cast</span>&lt;<span class="Type">double</span>&gt;(config::kL0_CompactionTrigger);<br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Comment">// Compute the ratio of <a href="version_set.h.html#L185" title="db/version_set.h:185">current</a> <a href="../table/format.h.html#L31" title="table/format.h:31">size</a> to <a href="../table/format.h.html#L31" title="table/format.h:31">size</a> limit.<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Type">const</span> <span class="Type"><a href="../port/win/stdint.h.html#L22" title="port/win/stdint.h:22">uint64_t</a></span> level_bytes = <a href="#L49" title="db/version_set.cc:49">TotalFileSize</a>(v-&gt;files_[<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; score = <span class="Statement">static_cast</span>&lt;<span class="Type">double</span>&gt;(level_bytes) / <a href="#L34" title="db/version_set.cc:34">MaxBytesForLevel</a>(<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (score &gt; best_score) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; best_level = <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; best_score = score;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; v-&gt;compaction_level_ = best_level;<br/></li>
<li>&nbsp; v-&gt;compaction_score_ = best_score;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1054">&#x200c;</a><a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> <a href="#L766" title="db/version_set.cc:766">VersionSet</a>::<span class="linkable">WriteSnapshot</span>(log::<a href="db_impl.cc.html#L41" title="db/db_impl.cc:41">Writer</a>* log) {<br/></li>
<li>&nbsp; <span class="Comment">// </span><span class="Todo">TODO</span><span class="Comment">: Break up into multiple records to reduce memory usage on recovery?<br/></li>
<li></span><br/></li>
<li>&nbsp; <span class="Comment">// Save metadata<br/></li>
<li></span>&nbsp; <a href="version_edit.h.html#L30" title="db/version_edit.h:30">VersionEdit</a> <a href="version_set.h.html#L332" title="db/version_set.h:332">edit</a>;<br/></li>
<li>&nbsp; <a href="version_set.h.html#L332" title="db/version_set.h:332">edit</a>.<a href="version_edit.h.html#L35" title="db/version_edit.h:35">SetComparatorName</a>(icmp_.<a href="db_impl.h.html#L197" title="db/db_impl.h:197">user_comparator</a>()-&gt;<a href="../table/table_test.cc.html#L40" title="table/table_test.cc:40">Name</a>());<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// Save compaction pointers<br/></li>
<li></span>&nbsp; <span class="Statement">for</span> (<span class="Type">int</span> <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> = <span class="Constant">0</span>; <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> &lt; config::kNumLevels; <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>++) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!compact_pointer_[<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>].<a href="../table/block_builder.h.html#L38" title="table/block_builder.h:38">empty</a>()) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="dbformat.h.html#L148" title="db/dbformat.h:148">InternalKey</a> <a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>.<a href="../table/format.cc.html#L23" title="table/format.cc:23">DecodeFrom</a>(compact_pointer_[<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="version_set.h.html#L332" title="db/version_set.h:332">edit</a>.<a href="version_edit.h.html#L55" title="db/version_edit.h:55">SetCompactPointer</a>(<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>, <a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// Save files<br/></li>
<li></span>&nbsp; <span class="Statement">for</span> (<span class="Type">int</span> <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> = <span class="Constant">0</span>; <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> &lt; config::kNumLevels; <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>++) {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> std::vector&lt;<a href="version_edit.h.html#L17" title="db/version_edit.h:17">FileMetaData</a>*&gt;&amp; files = current_-&gt;files_[<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>];<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (<span class="Type">size_t</span> i = <span class="Constant">0</span>; i &lt; files.<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>(); i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Type">const</span> <a href="version_edit.h.html#L17" title="db/version_edit.h:17">FileMetaData</a>* f = files[i];<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="version_set.h.html#L332" title="db/version_set.h:332">edit</a>.<a href="version_edit.h.html#L62" title="db/version_edit.h:62">AddFile</a>(<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>, f-&gt;number, f-&gt;file_size, f-&gt;smallest, f-&gt;largest);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; std::string record;<br/></li>
<li>&nbsp; <a href="version_set.h.html#L332" title="db/version_set.h:332">edit</a>.<a href="../table/format.cc.html#L15" title="table/format.cc:15">EncodeTo</a>(&amp;record);<br/></li>
<li>&nbsp; <span class="Statement">return</span> log-&gt;<a href="log_writer.cc.html#L27" title="db/log_writer.cc:27">AddRecord</a>(record);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1084">&#x200c;</a><span class="Type">int</span> <a href="#L766" title="db/version_set.cc:766">VersionSet</a>::<span class="linkable">NumLevelFiles</span>(<span class="Type">int</span> <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>) <span class="Type">const</span> {<br/></li>
<li>&nbsp; assert(<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> &gt;= <span class="Constant">0</span>);<br/></li>
<li>&nbsp; assert(<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> &lt; config::kNumLevels);<br/></li>
<li>&nbsp; <span class="Statement">return</span> current_-&gt;files_[<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>].<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>();<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1090">&#x200c;</a><span class="Type">const</span> <span class="Type">char</span>* <a href="#L766" title="db/version_set.cc:766">VersionSet</a>::<span class="linkable">LevelSummary</span>(<a href="version_set.h.html#L266" title="db/version_set.h:266">LevelSummaryStorage</a>* scratch) <span class="Type">const</span> {<br/></li>
<li>&nbsp; <span class="Comment">// <a href="../table/iterator_wrapper.h.html#L49" title="table/iterator_wrapper.h:49">Update</a> <a href="../include/leveldb/status.h.html#L84" title="include/leveldb/status.h:84">code</a> if kNumLevels changes<br/></li>
<li></span>&nbsp; assert(config::kNumLevels == <span class="Constant">7</span>);<br/></li>
<li>&nbsp; snprintf(scratch-&gt;buffer, <span class="Statement">sizeof</span>(scratch-&gt;buffer),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;files[ </span><span class="Special">%d</span><span class="Constant"> </span><span class="Special">%d</span><span class="Constant"> </span><span class="Special">%d</span><span class="Constant"> </span><span class="Special">%d</span><span class="Constant"> </span><span class="Special">%d</span><span class="Constant"> </span><span class="Special">%d</span><span class="Constant"> </span><span class="Special">%d</span><span class="Constant"> ]&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type">int</span>(current_-&gt;files_[<span class="Constant">0</span>].<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>()),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type">int</span>(current_-&gt;files_[<span class="Constant">1</span>].<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>()),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type">int</span>(current_-&gt;files_[<span class="Constant">2</span>].<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>()),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type">int</span>(current_-&gt;files_[<span class="Constant">3</span>].<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>()),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type">int</span>(current_-&gt;files_[<span class="Constant">4</span>].<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>()),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type">int</span>(current_-&gt;files_[<span class="Constant">5</span>].<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>()),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type">int</span>(current_-&gt;files_[<span class="Constant">6</span>].<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>()));<br/></li>
<li>&nbsp; <span class="Statement">return</span> scratch-&gt;buffer;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1105">&#x200c;</a><span class="Type"><a href="../port/win/stdint.h.html#L22" title="port/win/stdint.h:22">uint64_t</a></span> <a href="#L766" title="db/version_set.cc:766">VersionSet</a>::<span class="linkable">ApproximateOffsetOf</span>(<a href="version_set.h.html#L150" title="db/version_set.h:150">Version</a>* v, <span class="Type">const</span> <a href="dbformat.h.html#L148" title="db/dbformat.h:148">InternalKey</a>&amp; ikey) {<br/></li>
<li>&nbsp; <span class="Type"><a href="../port/win/stdint.h.html#L22" title="port/win/stdint.h:22">uint64_t</a></span> result = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; <span class="Statement">for</span> (<span class="Type">int</span> <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> = <span class="Constant">0</span>; <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> &lt; config::kNumLevels; <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>++) {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> std::vector&lt;<a href="version_edit.h.html#L17" title="db/version_edit.h:17">FileMetaData</a>*&gt;&amp; files = v-&gt;files_[<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>];<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (<span class="Type">size_t</span> i = <span class="Constant">0</span>; i &lt; files.<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>(); i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (icmp_.<a href="../table/table_test.cc.html#L44" title="table/table_test.cc:44">Compare</a>(files[i]-&gt;largest, ikey) &lt;= <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">// Entire file is before &quot;ikey&quot;, so just add the file <a href="../table/format.h.html#L31" title="table/format.h:31">size</a><br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; result += files[i]-&gt;file_size;<br/></li>
<li>&nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (icmp_.<a href="../table/table_test.cc.html#L44" title="table/table_test.cc:44">Compare</a>(files[i]-&gt;smallest, ikey) &gt; <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">// Entire file is after &quot;ikey&quot;, so ignore<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> &gt; <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">// Files other than <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> 0 are sorted by meta-&gt;smallest, so<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">// no further files in this <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> will contain <a href="../table/table_test.cc.html#L173" title="table/table_test.cc:173">data</a> for<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">// &quot;ikey&quot;.<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">// &quot;ikey&quot; falls in the range for this table.&nbsp; <a href="../table/table_test.cc.html#L146" title="table/table_test.cc:146">Add</a> the<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">// approximate <a href="../table/format.h.html#L27" title="table/format.h:27">offset</a> of &quot;ikey&quot; within the table.<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../include/leveldb/table.h.html#L62" title="include/leveldb/table.h:62">Table</a>* tableptr;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../table/iterator.cc.html#L9" title="table/iterator.cc:9">Iterator</a>* <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a> = table_cache_-&gt;<a href="../table/table_test.cc.html#L209" title="table/table_test.cc:209">NewIterator</a>(<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../include/leveldb/options.h.html#L143" title="include/leveldb/options.h:143">ReadOptions</a>(), files[i]-&gt;number, files[i]-&gt;file_size, &amp;tableptr);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (tableptr != <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; result += tableptr-&gt;<a href="../table/table_test.cc.html#L257" title="table/table_test.cc:257">ApproximateOffsetOf</a>(ikey.<a href="dbformat.h.html#L154" title="db/dbformat.h:154">Encode</a>());<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">delete</span> <a href="../table/iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> result;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1137">&#x200c;</a><span class="Type">void</span> <a href="#L766" title="db/version_set.cc:766">VersionSet</a>::<span class="linkable">AddLiveFiles</span>(std::set&lt;<span class="Type"><a href="../port/win/stdint.h.html#L22" title="port/win/stdint.h:22">uint64_t</a></span>&gt;* live) {<br/></li>
<li>&nbsp; <span class="Statement">for</span> (<a href="version_set.h.html#L150" title="db/version_set.h:150">Version</a>* v = dummy_versions_.next_;<br/></li>
<li>&nbsp; &nbsp; &nbsp;&nbsp; v != &amp;dummy_versions_;<br/></li>
<li>&nbsp; &nbsp; &nbsp;&nbsp; v = v-&gt;next_) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (<span class="Type">int</span> <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> = <span class="Constant">0</span>; <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> &lt; config::kNumLevels; <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Type">const</span> std::vector&lt;<a href="version_edit.h.html#L17" title="db/version_edit.h:17">FileMetaData</a>*&gt;&amp; files = v-&gt;files_[<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>];<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (<span class="Type">size_t</span> i = <span class="Constant">0</span>; i &lt; files.<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>(); i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; live-&gt;insert(files[i]-&gt;number);<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1150">&#x200c;</a><span class="Type"><a href="../port/win/stdint.h.html#L18" title="port/win/stdint.h:18">int64_t</a></span> <a href="#L766" title="db/version_set.cc:766">VersionSet</a>::<span class="linkable">NumLevelBytes</span>(<span class="Type">int</span> <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>) <span class="Type">const</span> {<br/></li>
<li>&nbsp; assert(<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> &gt;= <span class="Constant">0</span>);<br/></li>
<li>&nbsp; assert(<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> &lt; config::kNumLevels);<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="#L49" title="db/version_set.cc:49">TotalFileSize</a>(current_-&gt;files_[<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>]);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1156">&#x200c;</a><span class="Type"><a href="../port/win/stdint.h.html#L18" title="port/win/stdint.h:18">int64_t</a></span> <a href="#L766" title="db/version_set.cc:766">VersionSet</a>::<span class="linkable">MaxNextLevelOverlappingBytes</span>() {<br/></li>
<li>&nbsp; <span class="Type"><a href="../port/win/stdint.h.html#L18" title="port/win/stdint.h:18">int64_t</a></span> result = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; std::vector&lt;<a href="version_edit.h.html#L17" title="db/version_edit.h:17">FileMetaData</a>*&gt; overlaps;<br/></li>
<li>&nbsp; <span class="Statement">for</span> (<span class="Type">int</span> <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> = <span class="Constant">1</span>; <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> &lt; config::kNumLevels - <span class="Constant">1</span>; <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>++) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (<span class="Type">size_t</span> i = <span class="Constant">0</span>; i &lt; current_-&gt;files_[<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>].<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>(); i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Type">const</span> <a href="version_edit.h.html#L17" title="db/version_edit.h:17">FileMetaData</a>* f = current_-&gt;files_[<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>][i];<br/></li>
<li>&nbsp; &nbsp; &nbsp; current_-&gt;<a href="#L522" title="db/version_set.cc:522">GetOverlappingInputs</a>(<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>+<span class="Constant">1</span>, &amp;f-&gt;smallest, &amp;f-&gt;largest,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;overlaps);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Type">const</span> <span class="Type"><a href="../port/win/stdint.h.html#L18" title="port/win/stdint.h:18">int64_t</a></span> sum = <a href="#L49" title="db/version_set.cc:49">TotalFileSize</a>(overlaps);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (sum &gt; result) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; result = sum;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> result;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">// Stores the minimal range that covers all entries in inputs in<br/></li>
<li></span><span class="Comment">// *smallest, *largest.<br/></li>
<li></span><span class="Comment">// REQUIRES: inputs is not <a href="../table/block_builder.h.html#L38" title="table/block_builder.h:38">empty</a><br/></li>
<li><a id="L1176">&#x200c;</a></span><span class="Type">void</span> <a href="#L766" title="db/version_set.cc:766">VersionSet</a>::<span class="linkable">GetRange</span>(<span class="Type">const</span> std::vector&lt;<a href="version_edit.h.html#L17" title="db/version_edit.h:17">FileMetaData</a>*&gt;&amp; inputs,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="dbformat.h.html#L148" title="db/dbformat.h:148">InternalKey</a>* smallest,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="dbformat.h.html#L148" title="db/dbformat.h:148">InternalKey</a>* largest) {<br/></li>
<li>&nbsp; assert(!inputs.<a href="../table/block_builder.h.html#L38" title="table/block_builder.h:38">empty</a>());<br/></li>
<li>&nbsp; smallest-&gt;<a href="write_batch.cc.html#L37" title="db/write_batch.cc:37">Clear</a>();<br/></li>
<li>&nbsp; largest-&gt;<a href="write_batch.cc.html#L37" title="db/write_batch.cc:37">Clear</a>();<br/></li>
<li>&nbsp; <span class="Statement">for</span> (<span class="Type">size_t</span> i = <span class="Constant">0</span>; i &lt; inputs.<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>(); i++) {<br/></li>
<li>&nbsp; &nbsp; <a href="version_edit.h.html#L17" title="db/version_edit.h:17">FileMetaData</a>* f = inputs[i];<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (i == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; *smallest = f-&gt;smallest;<br/></li>
<li>&nbsp; &nbsp; &nbsp; *largest = f-&gt;largest;<br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (icmp_.<a href="../table/table_test.cc.html#L44" title="table/table_test.cc:44">Compare</a>(f-&gt;smallest, *smallest) &lt; <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *smallest = f-&gt;smallest;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (icmp_.<a href="../table/table_test.cc.html#L44" title="table/table_test.cc:44">Compare</a>(f-&gt;largest, *largest) &gt; <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *largest = f-&gt;largest;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">// Stores the minimal range that covers all entries in inputs1 and inputs2<br/></li>
<li></span><span class="Comment">// in *smallest, *largest.<br/></li>
<li></span><span class="Comment">// REQUIRES: inputs is not <a href="../table/block_builder.h.html#L38" title="table/block_builder.h:38">empty</a><br/></li>
<li><a id="L1201">&#x200c;</a></span><span class="Type">void</span> <a href="#L766" title="db/version_set.cc:766">VersionSet</a>::<span class="linkable">GetRange2</span>(<span class="Type">const</span> std::vector&lt;<a href="version_edit.h.html#L17" title="db/version_edit.h:17">FileMetaData</a>*&gt;&amp; inputs1,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type">const</span> std::vector&lt;<a href="version_edit.h.html#L17" title="db/version_edit.h:17">FileMetaData</a>*&gt;&amp; inputs2,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="dbformat.h.html#L148" title="db/dbformat.h:148">InternalKey</a>* smallest,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="dbformat.h.html#L148" title="db/dbformat.h:148">InternalKey</a>* largest) {<br/></li>
<li>&nbsp; std::vector&lt;<a href="version_edit.h.html#L17" title="db/version_edit.h:17">FileMetaData</a>*&gt; all = inputs1;<br/></li>
<li>&nbsp; all.insert(all.end(), inputs2.begin(), inputs2.end());<br/></li>
<li>&nbsp; <a href="#L1176" title="db/version_set.cc:1176">GetRange</a>(all, smallest, largest);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1210">&#x200c;</a><a href="../table/iterator.cc.html#L9" title="table/iterator.cc:9">Iterator</a>* <a href="#L766" title="db/version_set.cc:766">VersionSet</a>::<span class="linkable">MakeInputIterator</span>(<a href="#L1399" title="db/version_set.cc:1399">Compaction</a>* c) {<br/></li>
<li>&nbsp; <a href="../include/leveldb/options.h.html#L143" title="include/leveldb/options.h:143">ReadOptions</a> options;<br/></li>
<li>&nbsp; options.verify_checksums = options_-&gt;paranoid_checks;<br/></li>
<li>&nbsp; options.fill_cache = <span class="Constant">false</span>;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// Level-0 files have to be merged together.&nbsp; For other levels,<br/></li>
<li></span>&nbsp; <span class="Comment">// we will make a concatenating iterator per <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>.<br/></li>
<li></span>&nbsp; <span class="Comment">// </span><span class="Todo">TODO</span><span class="Comment">(opt): use concatenating iterator for <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>-0 if there is no overlap<br/></li>
<li></span>&nbsp; <span class="Type">const</span> <span class="Type">int</span> space = (c-&gt;<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>() == <span class="Constant">0</span> ? c-&gt;inputs_[<span class="Constant">0</span>].<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>() + <span class="Constant">1</span> : <span class="Constant">2</span>);<br/></li>
<li>&nbsp; <a href="../table/iterator.cc.html#L9" title="table/iterator.cc:9">Iterator</a>** list = <span class="Statement">new</span> <a href="../table/iterator.cc.html#L9" title="table/iterator.cc:9">Iterator</a>*[space];<br/></li>
<li>&nbsp; <span class="Type">int</span> num = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; <span class="Statement">for</span> (<span class="Type">int</span> which = <span class="Constant">0</span>; which &lt; <span class="Constant">2</span>; which++) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!c-&gt;inputs_[which].<a href="../table/block_builder.h.html#L38" title="table/block_builder.h:38">empty</a>()) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>() + which == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">const</span> std::vector&lt;<a href="version_edit.h.html#L17" title="db/version_edit.h:17">FileMetaData</a>*&gt;&amp; files = c-&gt;inputs_[which];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (<span class="Type">size_t</span> i = <span class="Constant">0</span>; i &lt; files.<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>(); i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; list[num++] = table_cache_-&gt;<a href="../table/table_test.cc.html#L209" title="table/table_test.cc:209">NewIterator</a>(<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; options, files[i]-&gt;number, files[i]-&gt;file_size);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">// Create concatenating iterator for the files from this <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a><br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; list[num++] = <a href="../table/two_level_iterator.cc.html#L174" title="table/two_level_iterator.cc:174">NewTwoLevelIterator</a>(<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">new</span> <a href="version_set.h.html#L150" title="db/version_set.h:150">Version</a>::<a href="#L156" title="db/version_set.cc:156">LevelFileNumIterator</a>(icmp_, &amp;c-&gt;inputs_[which]),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;<a href="#L204" title="db/version_set.cc:204">GetFileIterator</a>, table_cache_, options);<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; assert(num &lt;= space);<br/></li>
<li>&nbsp; <a href="../table/iterator.cc.html#L9" title="table/iterator.cc:9">Iterator</a>* result = <a href="../table/merger.cc.html#L186" title="table/merger.cc:186">NewMergingIterator</a>(&amp;icmp_, list, num);<br/></li>
<li>&nbsp; <span class="Statement">delete</span>[] list;<br/></li>
<li>&nbsp; <span class="Statement">return</span> result;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1243">&#x200c;</a><a href="#L1399" title="db/version_set.cc:1399">Compaction</a>* <a href="#L766" title="db/version_set.cc:766">VersionSet</a>::<span class="linkable">PickCompaction</span>() {<br/></li>
<li>&nbsp; <a href="#L1399" title="db/version_set.cc:1399">Compaction</a>* c;<br/></li>
<li>&nbsp; <span class="Type">int</span> <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// We prefer compactions triggered by too much <a href="../table/table_test.cc.html#L173" title="table/table_test.cc:173">data</a> in a <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> over<br/></li>
<li></span>&nbsp; <span class="Comment">// the compactions triggered by seeks.<br/></li>
<li></span>&nbsp; <span class="Type">const</span> <span class="Type">bool</span> size_compaction = (current_-&gt;compaction_score_ &gt;= <span class="Constant">1</span>);<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">bool</span> seek_compaction = (current_-&gt;file_to_compact_ != <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (size_compaction) {<br/></li>
<li>&nbsp; &nbsp; <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> = current_-&gt;compaction_level_;<br/></li>
<li>&nbsp; &nbsp; assert(<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> &gt;= <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; assert(<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>+<span class="Constant">1</span> &lt; config::kNumLevels);<br/></li>
<li>&nbsp; &nbsp; c = <span class="Statement">new</span> <a href="#L1399" title="db/version_set.cc:1399">Compaction</a>(<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// Pick the first file that comes after compact_pointer_[<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>]<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">for</span> (<span class="Type">size_t</span> i = <span class="Constant">0</span>; i &lt; current_-&gt;files_[<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>].<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>(); i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="version_edit.h.html#L17" title="db/version_edit.h:17">FileMetaData</a>* f = current_-&gt;files_[<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>][i];<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (compact_pointer_[<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>].<a href="../table/block_builder.h.html#L38" title="table/block_builder.h:38">empty</a>() ||<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; icmp_.<a href="../table/table_test.cc.html#L44" title="table/table_test.cc:44">Compare</a>(f-&gt;largest.<a href="dbformat.h.html#L154" title="db/dbformat.h:154">Encode</a>(), compact_pointer_[<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>]) &gt; <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;inputs_[<span class="Constant">0</span>].push_back(f);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;inputs_[<span class="Constant">0</span>].<a href="../table/block_builder.h.html#L38" title="table/block_builder.h:38">empty</a>()) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Comment">// Wrap-around to the beginning of the <a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a> space<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; c-&gt;inputs_[<span class="Constant">0</span>].push_back(current_-&gt;files_[<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>][<span class="Constant">0</span>]);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (seek_compaction) {<br/></li>
<li>&nbsp; &nbsp; <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> = current_-&gt;file_to_compact_level_;<br/></li>
<li>&nbsp; &nbsp; c = <span class="Statement">new</span> <a href="#L1399" title="db/version_set.cc:1399">Compaction</a>(<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>);<br/></li>
<li>&nbsp; &nbsp; c-&gt;inputs_[<span class="Constant">0</span>].push_back(current_-&gt;file_to_compact_);<br/></li>
<li>&nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; c-&gt;input_version_ = current_;<br/></li>
<li>&nbsp; c-&gt;input_version_-&gt;<a href="#L473" title="db/version_set.cc:473">Ref</a>();<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// Files in <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> 0 may overlap each other, so pick up all overlapping ones<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; <a href="dbformat.h.html#L148" title="db/dbformat.h:148">InternalKey</a> smallest, largest;<br/></li>
<li>&nbsp; &nbsp; <a href="#L1176" title="db/version_set.cc:1176">GetRange</a>(c-&gt;inputs_[<span class="Constant">0</span>], &amp;smallest, &amp;largest);<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// Note that the next call will discard the file we placed in<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">// c-&gt;inputs_[0] earlier and replace it with an overlapping set<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">// which will include the picked file.<br/></li>
<li></span>&nbsp; &nbsp; current_-&gt;<a href="#L522" title="db/version_set.cc:522">GetOverlappingInputs</a>(<span class="Constant">0</span>, &amp;smallest, &amp;largest, &amp;c-&gt;inputs_[<span class="Constant">0</span>]);<br/></li>
<li>&nbsp; &nbsp; assert(!c-&gt;inputs_[<span class="Constant">0</span>].<a href="../table/block_builder.h.html#L38" title="table/block_builder.h:38">empty</a>());<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <a href="#L1297" title="db/version_set.cc:1297">SetupOtherInputs</a>(c);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">return</span> c;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1297">&#x200c;</a><span class="Type">void</span> <a href="#L766" title="db/version_set.cc:766">VersionSet</a>::<span class="linkable">SetupOtherInputs</span>(<a href="#L1399" title="db/version_set.cc:1399">Compaction</a>* c) {<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">int</span> <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> = c-&gt;<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>();<br/></li>
<li>&nbsp; <a href="dbformat.h.html#L148" title="db/dbformat.h:148">InternalKey</a> smallest, largest;<br/></li>
<li>&nbsp; <a href="#L1176" title="db/version_set.cc:1176">GetRange</a>(c-&gt;inputs_[<span class="Constant">0</span>], &amp;smallest, &amp;largest);<br/></li>
<li><br/></li>
<li>&nbsp; current_-&gt;<a href="#L522" title="db/version_set.cc:522">GetOverlappingInputs</a>(<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>+<span class="Constant">1</span>, &amp;smallest, &amp;largest, &amp;c-&gt;inputs_[<span class="Constant">1</span>]);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// <a href="#L323" title="db/version_set.cc:323">Get</a> entire range covered by compaction<br/></li>
<li></span>&nbsp; <a href="dbformat.h.html#L148" title="db/dbformat.h:148">InternalKey</a> all_start, all_limit;<br/></li>
<li>&nbsp; <a href="#L1201" title="db/version_set.cc:1201">GetRange2</a>(c-&gt;inputs_[<span class="Constant">0</span>], c-&gt;inputs_[<span class="Constant">1</span>], &amp;all_start, &amp;all_limit);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// See if we can grow the number of inputs in &quot;<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>&quot; without<br/></li>
<li></span>&nbsp; <span class="Comment">// changing the number of &quot;<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>+1&quot; files we pick up.<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (!c-&gt;inputs_[<span class="Constant">1</span>].<a href="../table/block_builder.h.html#L38" title="table/block_builder.h:38">empty</a>()) {<br/></li>
<li>&nbsp; &nbsp; std::vector&lt;<a href="version_edit.h.html#L17" title="db/version_edit.h:17">FileMetaData</a>*&gt; expanded0;<br/></li>
<li>&nbsp; &nbsp; current_-&gt;<a href="#L522" title="db/version_set.cc:522">GetOverlappingInputs</a>(<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>, &amp;all_start, &amp;all_limit, &amp;expanded0);<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <span class="Type"><a href="../port/win/stdint.h.html#L18" title="port/win/stdint.h:18">int64_t</a></span> inputs0_size = <a href="#L49" title="db/version_set.cc:49">TotalFileSize</a>(c-&gt;inputs_[<span class="Constant">0</span>]);<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <span class="Type"><a href="../port/win/stdint.h.html#L18" title="port/win/stdint.h:18">int64_t</a></span> inputs1_size = <a href="#L49" title="db/version_set.cc:49">TotalFileSize</a>(c-&gt;inputs_[<span class="Constant">1</span>]);<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <span class="Type"><a href="../port/win/stdint.h.html#L18" title="port/win/stdint.h:18">int64_t</a></span> expanded0_size = <a href="#L49" title="db/version_set.cc:49">TotalFileSize</a>(expanded0);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (expanded0.<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>() &gt; c-&gt;inputs_[<span class="Constant">0</span>].<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>() &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; inputs1_size + expanded0_size &lt; kExpandedCompactionByteSizeLimit) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="dbformat.h.html#L148" title="db/dbformat.h:148">InternalKey</a> new_start, new_limit;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L1176" title="db/version_set.cc:1176">GetRange</a>(expanded0, &amp;new_start, &amp;new_limit);<br/></li>
<li>&nbsp; &nbsp; &nbsp; std::vector&lt;<a href="version_edit.h.html#L17" title="db/version_edit.h:17">FileMetaData</a>*&gt; expanded1;<br/></li>
<li>&nbsp; &nbsp; &nbsp; current_-&gt;<a href="#L522" title="db/version_set.cc:522">GetOverlappingInputs</a>(<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>+<span class="Constant">1</span>, &amp;new_start, &amp;new_limit,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;expanded1);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (expanded1.<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>() == c-&gt;inputs_[<span class="Constant">1</span>].<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>()) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../util/env.cc.html#L27" title="util/env.cc:27">Log</a>(options_-&gt;info_log,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;Expanding@</span><span class="Special">%d</span><span class="Constant"> </span><span class="Special">%d</span><span class="Constant">+</span><span class="Special">%d</span><span class="Constant"> (</span><span class="Special">%ld</span><span class="Constant">+</span><span class="Special">%ld</span><span class="Constant"> bytes) to </span><span class="Special">%d</span><span class="Constant">+</span><span class="Special">%d</span><span class="Constant"> (</span><span class="Special">%ld</span><span class="Constant">+</span><span class="Special">%ld</span><span class="Constant"> bytes)</span><span class="Special">\n</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span>(c-&gt;inputs_[<span class="Constant">0</span>].<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>()),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span>(c-&gt;inputs_[<span class="Constant">1</span>].<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>()),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">long</span>(inputs0_size), <span class="Type">long</span>(inputs1_size),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span>(expanded0.<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>()),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span>(expanded1.<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>()),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">long</span>(expanded0_size), <span class="Type">long</span>(inputs1_size));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; smallest = new_start;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; largest = new_limit;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;inputs_[<span class="Constant">0</span>] = expanded0;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;inputs_[<span class="Constant">1</span>] = expanded1;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1201" title="db/version_set.cc:1201">GetRange2</a>(c-&gt;inputs_[<span class="Constant">0</span>], c-&gt;inputs_[<span class="Constant">1</span>], &amp;all_start, &amp;all_limit);<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// Compute the set of grandparent files that overlap this compaction<br/></li>
<li></span>&nbsp; <span class="Comment">// (parent == <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>+1; grandparent == <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>+2)<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> + <span class="Constant">2</span> &lt; config::kNumLevels) {<br/></li>
<li>&nbsp; &nbsp; current_-&gt;<a href="#L522" title="db/version_set.cc:522">GetOverlappingInputs</a>(<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> + <span class="Constant">2</span>, &amp;all_start, &amp;all_limit,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;c-&gt;grandparents_);<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">if</span> (<span class="Constant">false</span>) {<br/></li>
<li>&nbsp; &nbsp; <a href="../util/env.cc.html#L27" title="util/env.cc:27">Log</a>(options_-&gt;info_log, <span class="Constant">&quot;Compacting </span><span class="Special">%d</span><span class="Constant"> '</span><span class="Special">%s</span><span class="Constant">' .. '</span><span class="Special">%s</span><span class="Constant">'&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; smallest.<a href="#L565" title="db/version_set.cc:565">DebugString</a>().c_str(),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; largest.<a href="#L565" title="db/version_set.cc:565">DebugString</a>().c_str());<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// <a href="../table/iterator_wrapper.h.html#L49" title="table/iterator_wrapper.h:49">Update</a> the place where we will do the next compaction for this <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>.<br/></li>
<li></span>&nbsp; <span class="Comment">// We update this immediately instead of waiting for the <a href="version_edit.h.html#L30" title="db/version_edit.h:30">VersionEdit</a><br/></li>
<li></span>&nbsp; <span class="Comment">// to be applied so that if the compaction fails, we will try a different<br/></li>
<li></span>&nbsp; <span class="Comment">// <a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a> range next time.<br/></li>
<li></span>&nbsp; compact_pointer_[<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>] = largest.<a href="dbformat.h.html#L154" title="db/dbformat.h:154">Encode</a>().<a href="../table/table_test.cc.html#L587" title="table/table_test.cc:587">ToString</a>();<br/></li>
<li>&nbsp; c-&gt;edit_.<a href="version_edit.h.html#L55" title="db/version_edit.h:55">SetCompactPointer</a>(<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>, largest);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1364">&#x200c;</a><a href="#L1399" title="db/version_set.cc:1399">Compaction</a>* <a href="#L766" title="db/version_set.cc:766">VersionSet</a>::<span class="linkable">CompactRange</span>(<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span> <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <a href="dbformat.h.html#L148" title="db/dbformat.h:148">InternalKey</a>* begin,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <a href="dbformat.h.html#L148" title="db/dbformat.h:148">InternalKey</a>* end) {<br/></li>
<li>&nbsp; std::vector&lt;<a href="version_edit.h.html#L17" title="db/version_edit.h:17">FileMetaData</a>*&gt; inputs;<br/></li>
<li>&nbsp; current_-&gt;<a href="#L522" title="db/version_set.cc:522">GetOverlappingInputs</a>(<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>, begin, end, &amp;inputs);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (inputs.<a href="../table/block_builder.h.html#L38" title="table/block_builder.h:38">empty</a>()) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// Avoid compacting too much in one shot in case the range is large.<br/></li>
<li></span>&nbsp; <span class="Comment">// But we cannot do this for <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>-0 since <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>-0 files can overlap<br/></li>
<li></span>&nbsp; <span class="Comment">// and we must not pick one file and drop another older file if the<br/></li>
<li></span>&nbsp; <span class="Comment">// two files overlap.<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a> &gt; <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <span class="Type"><a href="../port/win/stdint.h.html#L22" title="port/win/stdint.h:22">uint64_t</a></span> limit = <a href="#L45" title="db/version_set.cc:45">MaxFileSizeForLevel</a>(<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>);<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../port/win/stdint.h.html#L22" title="port/win/stdint.h:22">uint64_t</a></span> total = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (<span class="Type">size_t</span> i = <span class="Constant">0</span>; i &lt; inputs.<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>(); i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Type"><a href="../port/win/stdint.h.html#L22" title="port/win/stdint.h:22">uint64_t</a></span> s = inputs[i]-&gt;file_size;<br/></li>
<li>&nbsp; &nbsp; &nbsp; total += s;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (total &gt;= limit) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; inputs.resize(i + <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <a href="#L1399" title="db/version_set.cc:1399">Compaction</a>* c = <span class="Statement">new</span> <a href="#L1399" title="db/version_set.cc:1399">Compaction</a>(<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>);<br/></li>
<li>&nbsp; c-&gt;input_version_ = current_;<br/></li>
<li>&nbsp; c-&gt;input_version_-&gt;<a href="#L473" title="db/version_set.cc:473">Ref</a>();<br/></li>
<li>&nbsp; c-&gt;inputs_[<span class="Constant">0</span>] = inputs;<br/></li>
<li>&nbsp; <a href="#L1297" title="db/version_set.cc:1297">SetupOtherInputs</a>(c);<br/></li>
<li>&nbsp; <span class="Statement">return</span> c;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1399">&#x200c;</a><span class="linkable">Compaction</span>::<span class="linkable">Compaction</span>(<span class="Type">int</span> <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>)<br/></li>
<li>&nbsp; &nbsp; : level_(<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; max_output_file_size_(<a href="#L45" title="db/version_set.cc:45">MaxFileSizeForLevel</a>(<a href="version_set.h.html#L328" title="db/version_set.h:328">level</a>)),<br/></li>
<li>&nbsp; &nbsp; &nbsp; input_version_(<span class="Constant">NULL</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; grandparent_index_(<span class="Constant">0</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; seen_key_(<span class="Constant">false</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; overlapped_bytes_(<span class="Constant">0</span>) {<br/></li>
<li>&nbsp; <span class="Statement">for</span> (<span class="Type">int</span> i = <span class="Constant">0</span>; i &lt; config::kNumLevels; i++) {<br/></li>
<li>&nbsp; &nbsp; level_ptrs_[i] = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1411">&#x200c;</a><a href="#L1399" title="db/version_set.cc:1399">Compaction</a>::~<a href="#L1399" title="db/version_set.cc:1399">Compaction</a>() {<br/></li>
<li>&nbsp; <span class="Statement">if</span> (input_version_ != <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; input_version_-&gt;<a href="#L477" title="db/version_set.cc:477">Unref</a>();<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1417">&#x200c;</a><span class="Type">bool</span> <a href="#L1399" title="db/version_set.cc:1399">Compaction</a>::<span class="linkable">IsTrivialMove</span>() <span class="Type">const</span> {<br/></li>
<li>&nbsp; <span class="Comment">// Avoid a move if there is lots of overlapping grandparent <a href="../table/table_test.cc.html#L173" title="table/table_test.cc:173">data</a>.<br/></li>
<li></span>&nbsp; <span class="Comment">// Otherwise, the move could create a parent file that will require<br/></li>
<li></span>&nbsp; <span class="Comment">// a very expensive merge later on.<br/></li>
<li></span>&nbsp; <span class="Statement">return</span> (<a href="version_set.h.html#L335" title="db/version_set.h:335">num_input_files</a>(<span class="Constant">0</span>) == <span class="Constant">1</span> &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="version_set.h.html#L335" title="db/version_set.h:335">num_input_files</a>(<span class="Constant">1</span>) == <span class="Constant">0</span> &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L49" title="db/version_set.cc:49">TotalFileSize</a>(grandparents_) &lt;= kMaxGrandParentOverlapBytes);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1426">&#x200c;</a><span class="Type">void</span> <a href="#L1399" title="db/version_set.cc:1399">Compaction</a>::<span class="linkable">AddInputDeletions</span>(<a href="version_edit.h.html#L30" title="db/version_edit.h:30">VersionEdit</a>* <a href="version_set.h.html#L332" title="db/version_set.h:332">edit</a>) {<br/></li>
<li>&nbsp; <span class="Statement">for</span> (<span class="Type">int</span> which = <span class="Constant">0</span>; which &lt; <span class="Constant">2</span>; which++) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (<span class="Type">size_t</span> i = <span class="Constant">0</span>; i &lt; inputs_[which].<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>(); i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="version_set.h.html#L332" title="db/version_set.h:332">edit</a>-&gt;<a href="../include/leveldb/env.h.html#L296" title="include/leveldb/env.h:296">DeleteFile</a>(level_ + which, inputs_[which][i]-&gt;number);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1434">&#x200c;</a><span class="Type">bool</span> <a href="#L1399" title="db/version_set.cc:1399">Compaction</a>::<span class="linkable">IsBaseLevelForKey</span>(<span class="Type">const</span> <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>&amp; <a href="dbformat.h.html#L159" title="db/dbformat.h:159">user_key</a>) {<br/></li>
<li>&nbsp; <span class="Comment">// Maybe use binary search to find right entry instead of linear search?<br/></li>
<li></span>&nbsp; <span class="Type">const</span> <a href="skiplist_test.cc.html#L17" title="db/skiplist_test.cc:17">Comparator</a>* user_cmp = input_version_-&gt;vset_-&gt;icmp_.<a href="db_impl.h.html#L197" title="db/db_impl.h:197">user_comparator</a>();<br/></li>
<li>&nbsp; <span class="Statement">for</span> (<span class="Type">int</span> lvl = level_ + <span class="Constant">2</span>; lvl &lt; config::kNumLevels; lvl++) {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> std::vector&lt;<a href="version_edit.h.html#L17" title="db/version_edit.h:17">FileMetaData</a>*&gt;&amp; files = input_version_-&gt;files_[lvl];<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (; level_ptrs_[lvl] &lt; files.<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>(); ) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="version_edit.h.html#L17" title="db/version_edit.h:17">FileMetaData</a>* f = files[level_ptrs_[lvl]];<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (user_cmp-&gt;<a href="../table/table_test.cc.html#L44" title="table/table_test.cc:44">Compare</a>(<a href="dbformat.h.html#L159" title="db/dbformat.h:159">user_key</a>, f-&gt;largest.<a href="dbformat.h.html#L159" title="db/dbformat.h:159">user_key</a>()) &lt;= <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">// We've advanced far enough<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (user_cmp-&gt;<a href="../table/table_test.cc.html#L44" title="table/table_test.cc:44">Compare</a>(<a href="dbformat.h.html#L159" title="db/dbformat.h:159">user_key</a>, f-&gt;smallest.<a href="dbformat.h.html#L159" title="db/dbformat.h:159">user_key</a>()) &gt;= <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">// <a href="autocompact_test.cc.html#L36" title="db/autocompact_test.cc:36">Key</a> falls in this file's range, so definitely not base <a href="version_set.h.html#L328" title="db/version_set.h:328">level</a><br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">false</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; level_ptrs_[lvl]++;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> <span class="Constant">true</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1455">&#x200c;</a><span class="Type">bool</span> <a href="#L1399" title="db/version_set.cc:1399">Compaction</a>::<span class="linkable">ShouldStopBefore</span>(<span class="Type">const</span> <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>&amp; <a href="dbformat.h.html#L201" title="db/dbformat.h:201">internal_key</a>) {<br/></li>
<li>&nbsp; <span class="Comment">// Scan to find earliest grandparent file that contains <a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>.<br/></li>
<li></span>&nbsp; <span class="Type">const</span> <a href="dbformat.h.html#L117" title="db/dbformat.h:117">InternalKeyComparator</a>* icmp = &amp;input_version_-&gt;vset_-&gt;icmp_;<br/></li>
<li>&nbsp; <span class="Statement">while</span> (grandparent_index_ &lt; grandparents_.<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>() &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; icmp-&gt;<a href="../table/table_test.cc.html#L44" title="table/table_test.cc:44">Compare</a>(<a href="dbformat.h.html#L201" title="db/dbformat.h:201">internal_key</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; grandparents_[grandparent_index_]-&gt;largest.<a href="dbformat.h.html#L154" title="db/dbformat.h:154">Encode</a>()) &gt; <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (seen_key_) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; overlapped_bytes_ += grandparents_[grandparent_index_]-&gt;file_size;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; grandparent_index_++;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; seen_key_ = <span class="Constant">true</span>;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">if</span> (overlapped_bytes_ &gt; kMaxGrandParentOverlapBytes) {<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// Too much overlap for <a href="version_set.h.html#L185" title="db/version_set.h:185">current</a> output; start new output<br/></li>
<li></span>&nbsp; &nbsp; overlapped_bytes_ = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">true</span>;<br/></li>
<li>&nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">false</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1477">&#x200c;</a><span class="Type">void</span> <a href="#L1399" title="db/version_set.cc:1399">Compaction</a>::<span class="linkable">ReleaseInputs</span>() {<br/></li>
<li>&nbsp; <span class="Statement">if</span> (input_version_ != <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; input_version_-&gt;<a href="#L477" title="db/version_set.cc:477">Unref</a>();<br/></li>
<li>&nbsp; &nbsp; input_version_ = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li>}&nbsp; <span class="Comment">// namespace leveldb<br/></li>
</ol></span></code>
 </body>
</html>
