<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>db/log_test.cc - leveldb-1.18</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

code {
    font-family: consolas, monospace;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
  <h3>db/log_test.cc - leveldb-1.18</h3>
   <a href="../index.html"> Table of Contents </a>
 <h4>Functions defined</h4>
 <ul>
<li><a href="#L48">Append</a></li>
<li><a href="#L18">BigString</a></li>
<li><a href="#L204">CheckInitialOffsetRecord</a></li>
<li><a href="#L192">CheckOffsetPastEndReturnsNoRecords</a></li>
<li><a href="#L45">Close</a></li>
<li><a href="#L97">Corruption</a></li>
<li><a href="#L167">DroppedBytes</a></li>
<li><a href="#L156">FixChecksum</a></li>
<li><a href="#L46">Flush</a></li>
<li><a href="#L163">ForceError</a></li>
<li><a href="#L144">IncrementByte</a></li>
<li><a href="#L115">LogTest</a></li>
<li><a href="#L176">MatchError</a></li>
<li><a href="#L28">NumberString</a></li>
<li><a href="#L35">RandomSkewedString</a></li>
<li><a href="#L61">Read</a></li>
<li><a href="#L130">Read</a></li>
<li><a href="#L96">ReportCollector</a></li>
<li><a href="#L171">ReportMessage</a></li>
<li><a href="#L148">SetByte</a></li>
<li><a href="#L152">ShrinkSize</a></li>
<li><a href="#L79">Skip</a></li>
<li><a href="#L59">StringSource</a></li>
<li><a href="#L47">Sync</a></li>
<li><a href="#L238">TEST(LogTest, Empty) {</a></li>
<li><a href="#L242">TEST(LogTest, ReadWrite) {</a></li>
<li><a href="#L255">TEST(LogTest, ManyBlocks) {</a></li>
<li><a href="#L265">TEST(LogTest, Fragmentation) {</a></li>
<li><a href="#L275">TEST(LogTest, MarginalTrailer) {</a></li>
<li><a href="#L288">TEST(LogTest, MarginalTrailer2) {</a></li>
<li><a href="#L301">TEST(LogTest, ShortTrailer) {</a></li>
<li><a href="#L313">TEST(LogTest, AlignedEof) {</a></li>
<li><a href="#L321">TEST(LogTest, RandomRead) {</a></li>
<li><a href="#L336">TEST(LogTest, ReadError) {</a></li>
<li><a href="#L344">TEST(LogTest, BadRecordType) {</a></li>
<li><a href="#L354">TEST(LogTest, TruncatedTrailingRecordIsIgnored) {</a></li>
<li><a href="#L363">TEST(LogTest, BadLength) {</a></li>
<li><a href="#L374">TEST(LogTest, BadLengthAtEndIsIgnored) {</a></li>
<li><a href="#L382">TEST(LogTest, ChecksumMismatch) {</a></li>
<li><a href="#L390">TEST(LogTest, UnexpectedMiddleType) {</a></li>
<li><a href="#L399">TEST(LogTest, UnexpectedLastType) {</a></li>
<li><a href="#L408">TEST(LogTest, UnexpectedFullType) {</a></li>
<li><a href="#L419">TEST(LogTest, UnexpectedFirstType) {</a></li>
<li><a href="#L430">TEST(LogTest, MissingLastIsIgnored) {</a></li>
<li><a href="#L439">TEST(LogTest, PartialLastIsIgnored) {</a></li>
<li><a href="#L448">TEST(LogTest, ErrorJoinsRecords) {</a></li>
<li><a href="#L471">TEST(LogTest, ReadStart) {</a></li>
<li><a href="#L475">TEST(LogTest, ReadSecondOneOff) {</a></li>
<li><a href="#L479">TEST(LogTest, ReadSecondTenThousand) {</a></li>
<li><a href="#L483">TEST(LogTest, ReadSecondStart) {</a></li>
<li><a href="#L487">TEST(LogTest, ReadThirdOneOff) {</a></li>
<li><a href="#L491">TEST(LogTest, ReadThirdStart) {</a></li>
<li><a href="#L495">TEST(LogTest, ReadFourthOneOff) {</a></li>
<li><a href="#L499">TEST(LogTest, ReadFourthFirstBlockTrailer) {</a></li>
<li><a href="#L503">TEST(LogTest, ReadFourthMiddleBlock) {</a></li>
<li><a href="#L507">TEST(LogTest, ReadFourthLastBlock) {</a></li>
<li><a href="#L511">TEST(LogTest, ReadFourthStart) {</a></li>
<li><a href="#L517">TEST(LogTest, ReadEnd) {</a></li>
<li><a href="#L521">TEST(LogTest, ReadPastEnd) {</a></li>
<li><a href="#L121">Write</a></li>
<li><a href="#L184">WriteInitialOffsetLog</a></li>
<li><a href="#L126">WrittenBytes</a></li>
<li><a href="#L528">main</a></li>
</ul>
 <h4>Source code</h4>

  <code><ol><li><span class="Comment">// Copyright (c) 2011 The LevelDB Authors. All rights reserved.<br/></li>
<li></span><span class="Comment">// Use of this source <a href="../include/leveldb/status.h.html#L84" title="include/leveldb/status.h:84">code</a> is governed by a BSD-style license that can be<br/></li>
<li></span><span class="Comment">// found in the LICENSE file. See the AUTHORS file for names of contributors.<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;<a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a>/log_reader.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;<a href="../table/table_test.cc.html#L175" title="table/table_test.cc:175">db</a>/log_writer.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;leveldb/env.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;util/coding.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;util/crc32c.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;util/random.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;util/testharness.h&quot;<br/></li>
<li></span><br/></li>
<li><span class="Type">namespace</span> leveldb {<br/></li>
<li><span class="Type">namespace</span> log {<br/></li>
<li><br/></li>
<li><span class="Comment">// Construct a string of the specified length made out of the supplied<br/></li>
<li></span><span class="Comment">// partial string.<br/></li>
<li><a id="L18">&#x200c;</a></span><span class="Type">static</span> std::string <span class="linkable">BigString</span>(<span class="Type">const</span> std::string&amp; partial_string, <span class="Type">size_t</span> n) {<br/></li>
<li>&nbsp; std::string result;<br/></li>
<li>&nbsp; <span class="Statement">while</span> (result.<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>() &lt; n) {<br/></li>
<li>&nbsp; &nbsp; result.append(partial_string);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; result.resize(n);<br/></li>
<li>&nbsp; <span class="Statement">return</span> result;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">// Construct a string from a number<br/></li>
<li><a id="L28">&#x200c;</a></span><span class="Type">static</span> std::string <span class="linkable">NumberString</span>(<span class="Type">int</span> n) {<br/></li>
<li>&nbsp; <span class="Type">char</span> buf[<span class="Constant">50</span>];<br/></li>
<li>&nbsp; snprintf(buf, <span class="Statement">sizeof</span>(buf), <span class="Constant">&quot;</span><span class="Special">%d</span><span class="Constant">.&quot;</span>, n);<br/></li>
<li>&nbsp; <span class="Statement">return</span> std::string(buf);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">// Return a skewed potentially long string<br/></li>
<li><a id="L35">&#x200c;</a></span><span class="Type">static</span> std::string <span class="linkable">RandomSkewedString</span>(<span class="Type">int</span> i, <a href="../util/random.h.html#L19" title="util/random.h:19">Random</a>* rnd) {<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="#L18" title="db/log_test.cc:18">BigString</a>(<a href="#L28" title="db/log_test.cc:28">NumberString</a>(i), rnd-&gt;<a href="../util/random.h.html#L57" title="util/random.h:57">Skewed</a>(<span class="Constant">17</span>));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Type">class</span> <a href="#L115" title="db/log_test.cc:115">LogTest</a> {<br/></li>
<li><span class="cUserCont"> </span><span class="Statement">private</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; <span class="Type">class</span> StringDest : <span class="Statement">public</span> <a href="../include/leveldb/env.h.html#L214" title="include/leveldb/env.h:214">WritableFile</a> {<br/></li>
<li><span class="cUserCont">&nbsp;&nbsp; </span><span class="Statement">public</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; &nbsp; std::string contents_;<br/></li>
<li><br/></li>
<li><a id="L45">&#x200c;</a>&nbsp; &nbsp; <span class="Type">virtual</span> <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> <span class="linkable">Close</span>() { <span class="Statement">return</span> <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a>::<a href="../include/leveldb/status.h.html#L32" title="include/leveldb/status.h:32">OK</a>(); }<br/></li>
<li><a id="L46">&#x200c;</a>&nbsp; &nbsp; <span class="Type">virtual</span> <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> <span class="linkable">Flush</span>() { <span class="Statement">return</span> <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a>::<a href="../include/leveldb/status.h.html#L32" title="include/leveldb/status.h:32">OK</a>(); }<br/></li>
<li><a id="L47">&#x200c;</a>&nbsp; &nbsp; <span class="Type">virtual</span> <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> <span class="linkable">Sync</span>() { <span class="Statement">return</span> <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a>::<a href="../include/leveldb/status.h.html#L32" title="include/leveldb/status.h:32">OK</a>(); }<br/></li>
<li><a id="L48">&#x200c;</a>&nbsp; &nbsp; <span class="Type">virtual</span> <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> <span class="linkable">Append</span>(<span class="Type">const</span> <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>&amp; slice) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; contents_.append(slice.<a href="../table/table_test.cc.html#L173" title="table/table_test.cc:173">data</a>(), slice.<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>());<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a>::<a href="../include/leveldb/status.h.html#L32" title="include/leveldb/status.h:32">OK</a>();<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; };<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Type">class</span> <a href="../table/table_test.cc.html#L112" title="table/table_test.cc:112">StringSource</a> : <span class="Statement">public</span> <a href="../include/leveldb/env.h.html#L157" title="include/leveldb/env.h:157">SequentialFile</a> {<br/></li>
<li><span class="cUserCont">&nbsp;&nbsp; </span><span class="Statement">public</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; &nbsp; <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a> contents_;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">bool</span> force_error_;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">bool</span> returned_partial_;<br/></li>
<li><a id="L59">&#x200c;</a>&nbsp; &nbsp; <span class="linkable">StringSource</span>() : force_error_(<span class="Constant">false</span>), returned_partial_(<span class="Constant">false</span>) { }<br/></li>
<li><br/></li>
<li><a id="L61">&#x200c;</a>&nbsp; &nbsp; <span class="Type">virtual</span> <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> <span class="linkable">Read</span>(<span class="Type">size_t</span> n, <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>* result, <span class="Type">char</span>* scratch) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(!returned_partial_) &lt;&lt; <span class="Constant">&quot;must not <a href="../table/table_test.cc.html#L120" title="table/table_test.cc:120">Read</a>() after eof/error&quot;</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (force_error_) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; force_error_ = <span class="Constant">false</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; returned_partial_ = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a>::<a href="../include/leveldb/status.h.html#L38" title="include/leveldb/status.h:38">Corruption</a>(<span class="Constant">&quot;read error&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (contents_.<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>() &lt; n) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; n = contents_.<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; returned_partial_ = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; *result = <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>(contents_.<a href="../table/table_test.cc.html#L173" title="table/table_test.cc:173">data</a>(), n);<br/></li>
<li>&nbsp; &nbsp; &nbsp; contents_.<a href="../include/leveldb/slice.h.html#L59" title="include/leveldb/slice.h:59">remove_prefix</a>(n);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a>::<a href="../include/leveldb/status.h.html#L32" title="include/leveldb/status.h:32">OK</a>();<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><a id="L79">&#x200c;</a>&nbsp; &nbsp; <span class="Type">virtual</span> <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> <span class="linkable">Skip</span>(<span class="Type"><a href="../port/win/stdint.h.html#L22" title="port/win/stdint.h:22">uint64_t</a></span> n) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n &gt; contents_.<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>()) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; contents_.<a href="../include/leveldb/slice.h.html#L56" title="include/leveldb/slice.h:56">clear</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a>::<a href="../include/leveldb/status.h.html#L35" title="include/leveldb/status.h:35">NotFound</a>(<span class="Constant">&quot;in-memory file skipepd past end&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; contents_.<a href="../include/leveldb/slice.h.html#L59" title="include/leveldb/slice.h:59">remove_prefix</a>(n);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a>::<a href="../include/leveldb/status.h.html#L32" title="include/leveldb/status.h:32">OK</a>();<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; };<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Type">class</span> <a href="#L96" title="db/log_test.cc:96">ReportCollector</a> : <span class="Statement">public</span> <a href="log_reader.cc.html#L18" title="db/log_reader.cc:18">Reader</a>::Reporter {<br/></li>
<li><span class="cUserCont">&nbsp;&nbsp; </span><span class="Statement">public</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">size_t</span> dropped_bytes_;<br/></li>
<li>&nbsp; &nbsp; std::string message_;<br/></li>
<li><br/></li>
<li><a id="L96">&#x200c;</a>&nbsp; &nbsp; <span class="linkable">ReportCollector</span>() : dropped_bytes_(<span class="Constant">0</span>) { }<br/></li>
<li><a id="L97">&#x200c;</a>&nbsp; &nbsp; <span class="Type">virtual</span> <span class="Type">void</span> <span class="linkable">Corruption</span>(<span class="Type">size_t</span> bytes, <span class="Type">const</span> <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a>&amp; <a href="../table/two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; dropped_bytes_ += bytes;<br/></li>
<li>&nbsp; &nbsp; &nbsp; message_.append(<a href="../table/two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a>.<a href="../table/table_test.cc.html#L587" title="table/table_test.cc:587">ToString</a>());<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; };<br/></li>
<li><br/></li>
<li>&nbsp; StringDest dest_;<br/></li>
<li>&nbsp; <a href="../table/table_test.cc.html#L112" title="table/table_test.cc:112">StringSource</a> source_;<br/></li>
<li>&nbsp; <a href="#L96" title="db/log_test.cc:96">ReportCollector</a> report_;<br/></li>
<li>&nbsp; <span class="Type">bool</span> reading_;<br/></li>
<li>&nbsp; <a href="db_impl.cc.html#L41" title="db/db_impl.cc:41">Writer</a> writer_;<br/></li>
<li>&nbsp; <a href="log_reader.cc.html#L18" title="db/log_reader.cc:18">Reader</a> reader_;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// Record metadata for testing initial <a href="../table/format.h.html#L27" title="table/format.h:27">offset</a> functionality<br/></li>
<li></span>&nbsp; <span class="Type">static</span> <span class="Type">size_t</span> initial_offset_record_sizes_[];<br/></li>
<li>&nbsp; <span class="Type">static</span> <span class="Type"><a href="../port/win/stdint.h.html#L22" title="port/win/stdint.h:22">uint64_t</a></span> initial_offset_last_record_offsets_[];<br/></li>
<li><br/></li>
<li><span class="cUserCont"> </span><span class="Statement">public</span><span class="cUserCont">:<br/></li>
<li><a id="L115">&#x200c;</a></span>&nbsp; <span class="linkable">LogTest</span>() : reading_(<span class="Constant">false</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; writer_(&amp;dest_),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; reader_(&amp;source_, &amp;report_, <span class="Constant">true</span><span class="Comment">/*checksum*/</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">0</span><span class="Comment">/*initial_offset*/</span>) {<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li><a id="L121">&#x200c;</a>&nbsp; <span class="Type">void</span> <span class="linkable">Write</span>(<span class="Type">const</span> std::string&amp; msg) {<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(!reading_) &lt;&lt; <span class="Constant">&quot;<a href="#L121" title="db/log_test.cc:121">Write</a>() after starting to read&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; writer_.<a href="log_writer.cc.html#L27" title="db/log_writer.cc:27">AddRecord</a>(<a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>(msg));<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li><a id="L126">&#x200c;</a>&nbsp; <span class="Type">size_t</span> <span class="linkable">WrittenBytes</span>() <span class="Type">const</span> {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> dest_.contents_.<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>();<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li><a id="L130">&#x200c;</a>&nbsp; std::string <span class="linkable">Read</span>() {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!reading_) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; reading_ = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; source_.contents_ = <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>(dest_.contents_);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; std::string scratch;<br/></li>
<li>&nbsp; &nbsp; <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a> record;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (reader_.<a href="log_reader.cc.html#L59" title="db/log_reader.cc:59">ReadRecord</a>(&amp;record, &amp;scratch)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span> record.<a href="../table/table_test.cc.html#L587" title="table/table_test.cc:587">ToString</a>();<br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">&quot;EOF&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li><a id="L144">&#x200c;</a>&nbsp; <span class="Type">void</span> <span class="linkable">IncrementByte</span>(<span class="Type">int</span> <a href="../table/format.h.html#L27" title="table/format.h:27">offset</a>, <span class="Type">int</span> delta) {<br/></li>
<li>&nbsp; &nbsp; dest_.contents_[<a href="../table/format.h.html#L27" title="table/format.h:27">offset</a>] += delta;<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li><a id="L148">&#x200c;</a>&nbsp; <span class="Type">void</span> <span class="linkable">SetByte</span>(<span class="Type">int</span> <a href="../table/format.h.html#L27" title="table/format.h:27">offset</a>, <span class="Type">char</span> new_byte) {<br/></li>
<li>&nbsp; &nbsp; dest_.contents_[<a href="../table/format.h.html#L27" title="table/format.h:27">offset</a>] = new_byte;<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li><a id="L152">&#x200c;</a>&nbsp; <span class="Type">void</span> <span class="linkable">ShrinkSize</span>(<span class="Type">int</span> bytes) {<br/></li>
<li>&nbsp; &nbsp; dest_.contents_.resize(dest_.contents_.<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>() - bytes);<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li><a id="L156">&#x200c;</a>&nbsp; <span class="Type">void</span> <span class="linkable">FixChecksum</span>(<span class="Type">int</span> header_offset, <span class="Type">int</span> len) {<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// Compute crc of type/len/<a href="../table/table_test.cc.html#L173" title="table/table_test.cc:173">data</a><br/></li>
<li></span>&nbsp; &nbsp; <span class="Type"><a href="../port/win/stdint.h.html#L21" title="port/win/stdint.h:21">uint32_t</a></span> crc = crc32c::<a href="corruption_test.cc.html#L196" title="db/corruption_test.cc:196">Value</a>(&amp;dest_.contents_[header_offset+<span class="Constant">6</span>], <span class="Constant">1</span> + len);<br/></li>
<li>&nbsp; &nbsp; crc = crc32c::<a href="../util/crc32c.h.html#L31" title="util/crc32c.h:31">Mask</a>(crc);<br/></li>
<li>&nbsp; &nbsp; <a href="../util/coding.cc.html#L9" title="util/coding.cc:9">EncodeFixed32</a>(&amp;dest_.contents_[header_offset], crc);<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li><a id="L163">&#x200c;</a>&nbsp; <span class="Type">void</span> <span class="linkable">ForceError</span>() {<br/></li>
<li>&nbsp; &nbsp; source_.force_error_ = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li><a id="L167">&#x200c;</a>&nbsp; <span class="Type">size_t</span> <span class="linkable">DroppedBytes</span>() <span class="Type">const</span> {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> report_.dropped_bytes_;<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li><a id="L171">&#x200c;</a>&nbsp; std::string <span class="linkable">ReportMessage</span>() <span class="Type">const</span> {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> report_.message_;<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// Returns <a href="../include/leveldb/status.h.html#L32" title="include/leveldb/status.h:32">OK</a> iff recorded error message contains &quot;msg&quot;<br/></li>
<li><a id="L176">&#x200c;</a></span>&nbsp; std::string <span class="linkable">MatchError</span>(<span class="Type">const</span> std::string&amp; msg) <span class="Type">const</span> {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (report_.message_.find(msg) == std::string::npos) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span> report_.message_;<br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">&quot;<a href="../include/leveldb/status.h.html#L32" title="include/leveldb/status.h:32">OK</a>&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li><a id="L184">&#x200c;</a>&nbsp; <span class="Type">void</span> <span class="linkable">WriteInitialOffsetLog</span>() {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (<span class="Type">int</span> i = <span class="Constant">0</span>; i &lt; <span class="Constant">4</span>; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; std::string record(initial_offset_record_sizes_[i],<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Statement">static_cast</span>&lt;<span class="Type">char</span>&gt;(<span class="Constant">'a'</span> + i));<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L121" title="db/log_test.cc:121">Write</a>(record);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li><a id="L192">&#x200c;</a>&nbsp; <span class="Type">void</span> <span class="linkable">CheckOffsetPastEndReturnsNoRecords</span>(<span class="Type"><a href="../port/win/stdint.h.html#L22" title="port/win/stdint.h:22">uint64_t</a></span> offset_past_end) {<br/></li>
<li>&nbsp; &nbsp; <a href="#L184" title="db/log_test.cc:184">WriteInitialOffsetLog</a>();<br/></li>
<li>&nbsp; &nbsp; reading_ = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; source_.contents_ = <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>(dest_.contents_);<br/></li>
<li>&nbsp; &nbsp; <a href="log_reader.cc.html#L18" title="db/log_reader.cc:18">Reader</a>* offset_reader = <span class="Statement">new</span> <a href="log_reader.cc.html#L18" title="db/log_reader.cc:18">Reader</a>(&amp;source_, &amp;report_, <span class="Constant">true</span><span class="Comment">/*checksum*/</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L126" title="db/log_test.cc:126">WrittenBytes</a>() + offset_past_end);<br/></li>
<li>&nbsp; &nbsp; <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a> record;<br/></li>
<li>&nbsp; &nbsp; std::string scratch;<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(!offset_reader-&gt;<a href="log_reader.cc.html#L59" title="db/log_reader.cc:59">ReadRecord</a>(&amp;record, &amp;scratch));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">delete</span> offset_reader;<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li><a id="L204">&#x200c;</a>&nbsp; <span class="Type">void</span> <span class="linkable">CheckInitialOffsetRecord</span>(<span class="Type"><a href="../port/win/stdint.h.html#L22" title="port/win/stdint.h:22">uint64_t</a></span> initial_offset,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> expected_record_offset) {<br/></li>
<li>&nbsp; &nbsp; <a href="#L184" title="db/log_test.cc:184">WriteInitialOffsetLog</a>();<br/></li>
<li>&nbsp; &nbsp; reading_ = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; source_.contents_ = <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>(dest_.contents_);<br/></li>
<li>&nbsp; &nbsp; <a href="log_reader.cc.html#L18" title="db/log_reader.cc:18">Reader</a>* offset_reader = <span class="Statement">new</span> <a href="log_reader.cc.html#L18" title="db/log_reader.cc:18">Reader</a>(&amp;source_, &amp;report_, <span class="Constant">true</span><span class="Comment">/*checksum*/</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; initial_offset);<br/></li>
<li>&nbsp; &nbsp; <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a> record;<br/></li>
<li>&nbsp; &nbsp; std::string scratch;<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(offset_reader-&gt;<a href="log_reader.cc.html#L59" title="db/log_reader.cc:59">ReadRecord</a>(&amp;record, &amp;scratch));<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(initial_offset_record_sizes_[expected_record_offset],<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; record.<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>());<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(initial_offset_last_record_offsets_[expected_record_offset],<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; offset_reader-&gt;<a href="log_reader.cc.html#L166" title="db/log_reader.cc:166">LastRecordOffset</a>());<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>((<span class="Type">char</span>)(<span class="Constant">'a'</span> + expected_record_offset), record.<a href="../table/table_test.cc.html#L173" title="table/table_test.cc:173">data</a>()[<span class="Constant">0</span>]);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">delete</span> offset_reader;<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>};<br/></li>
<li><br/></li>
<li><span class="Type">size_t</span> <a href="#L115" title="db/log_test.cc:115">LogTest</a>::initial_offset_record_sizes_[] =<br/></li>
<li>&nbsp; &nbsp; {<span class="Constant">10000</span>,&nbsp; <span class="Comment">// Two sizable records in first block<br/></li>
<li></span>&nbsp; &nbsp;&nbsp; <span class="Constant">10000</span>,<br/></li>
<li>&nbsp; &nbsp;&nbsp; <span class="Constant">2</span> * log::kBlockSize - <span class="Constant">1000</span>,&nbsp; <span class="Comment">// Span three blocks<br/></li>
<li></span>&nbsp; &nbsp;&nbsp; <span class="Constant">1</span>};<br/></li>
<li><br/></li>
<li><span class="Type"><a href="../port/win/stdint.h.html#L22" title="port/win/stdint.h:22">uint64_t</a></span> <a href="#L115" title="db/log_test.cc:115">LogTest</a>::initial_offset_last_record_offsets_[] =<br/></li>
<li>&nbsp; &nbsp; {<span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp;&nbsp; kHeaderSize + <span class="Constant">10000</span>,<br/></li>
<li>&nbsp; &nbsp;&nbsp; <span class="Constant">2</span> * (kHeaderSize + <span class="Constant">10000</span>),<br/></li>
<li>&nbsp; &nbsp;&nbsp; <span class="Constant">2</span> * (kHeaderSize + <span class="Constant">10000</span>) +<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (<span class="Constant">2</span> * log::kBlockSize - <span class="Constant">1000</span>) + <span class="Constant">3</span> * kHeaderSize};<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L238">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L115" title="db/log_test.cc:115">LogTest</a>, Empty) {<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;EOF&quot;</span>, <a href="../table/table_test.cc.html#L120" title="table/table_test.cc:120">Read</a>());<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L242">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L115" title="db/log_test.cc:115">LogTest</a>, ReadWrite) {<br/></li>
<li>&nbsp; <a href="#L121" title="db/log_test.cc:121">Write</a>(<span class="Constant">&quot;foo&quot;</span>);<br/></li>
<li>&nbsp; <a href="#L121" title="db/log_test.cc:121">Write</a>(<span class="Constant">&quot;bar&quot;</span>);<br/></li>
<li>&nbsp; <a href="#L121" title="db/log_test.cc:121">Write</a>(<span class="Constant">&quot;&quot;</span>);<br/></li>
<li>&nbsp; <a href="#L121" title="db/log_test.cc:121">Write</a>(<span class="Constant">&quot;xxxx&quot;</span>);<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;foo&quot;</span>, <a href="../table/table_test.cc.html#L120" title="table/table_test.cc:120">Read</a>());<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;bar&quot;</span>, <a href="../table/table_test.cc.html#L120" title="table/table_test.cc:120">Read</a>());<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;&quot;</span>, <a href="../table/table_test.cc.html#L120" title="table/table_test.cc:120">Read</a>());<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;xxxx&quot;</span>, <a href="../table/table_test.cc.html#L120" title="table/table_test.cc:120">Read</a>());<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;EOF&quot;</span>, <a href="../table/table_test.cc.html#L120" title="table/table_test.cc:120">Read</a>());<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;EOF&quot;</span>, <a href="../table/table_test.cc.html#L120" title="table/table_test.cc:120">Read</a>());&nbsp; <span class="Comment">// Make sure reads at eof work<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><a id="L255">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L115" title="db/log_test.cc:115">LogTest</a>, ManyBlocks) {<br/></li>
<li>&nbsp; <span class="Statement">for</span> (<span class="Type">int</span> i = <span class="Constant">0</span>; i &lt; <span class="Constant">100000</span>; i++) {<br/></li>
<li>&nbsp; &nbsp; <a href="#L121" title="db/log_test.cc:121">Write</a>(<a href="#L28" title="db/log_test.cc:28">NumberString</a>(i));<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">for</span> (<span class="Type">int</span> i = <span class="Constant">0</span>; i &lt; <span class="Constant">100000</span>; i++) {<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L28" title="db/log_test.cc:28">NumberString</a>(i), <a href="../table/table_test.cc.html#L120" title="table/table_test.cc:120">Read</a>());<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;EOF&quot;</span>, <a href="../table/table_test.cc.html#L120" title="table/table_test.cc:120">Read</a>());<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L265">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L115" title="db/log_test.cc:115">LogTest</a>, Fragmentation) {<br/></li>
<li>&nbsp; <a href="#L121" title="db/log_test.cc:121">Write</a>(<span class="Constant">&quot;small&quot;</span>);<br/></li>
<li>&nbsp; <a href="#L121" title="db/log_test.cc:121">Write</a>(<a href="#L18" title="db/log_test.cc:18">BigString</a>(<span class="Constant">&quot;medium&quot;</span>, <span class="Constant">50000</span>));<br/></li>
<li>&nbsp; <a href="#L121" title="db/log_test.cc:121">Write</a>(<a href="#L18" title="db/log_test.cc:18">BigString</a>(<span class="Constant">&quot;large&quot;</span>, <span class="Constant">100000</span>));<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;small&quot;</span>, <a href="../table/table_test.cc.html#L120" title="table/table_test.cc:120">Read</a>());<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L18" title="db/log_test.cc:18">BigString</a>(<span class="Constant">&quot;medium&quot;</span>, <span class="Constant">50000</span>), <a href="../table/table_test.cc.html#L120" title="table/table_test.cc:120">Read</a>());<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L18" title="db/log_test.cc:18">BigString</a>(<span class="Constant">&quot;large&quot;</span>, <span class="Constant">100000</span>), <a href="../table/table_test.cc.html#L120" title="table/table_test.cc:120">Read</a>());<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;EOF&quot;</span>, <a href="../table/table_test.cc.html#L120" title="table/table_test.cc:120">Read</a>());<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L275">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L115" title="db/log_test.cc:115">LogTest</a>, MarginalTrailer) {<br/></li>
<li>&nbsp; <span class="Comment">// Make a trailer that is exactly the same length as an <a href="../table/block_builder.h.html#L38" title="table/block_builder.h:38">empty</a> record.<br/></li>
<li></span>&nbsp; <span class="Type">const</span> <span class="Type">int</span> n = kBlockSize - <span class="Constant">2</span>*kHeaderSize;<br/></li>
<li>&nbsp; <a href="#L121" title="db/log_test.cc:121">Write</a>(<a href="#L18" title="db/log_test.cc:18">BigString</a>(<span class="Constant">&quot;foo&quot;</span>, n));<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(kBlockSize - kHeaderSize, <a href="#L126" title="db/log_test.cc:126">WrittenBytes</a>());<br/></li>
<li>&nbsp; <a href="#L121" title="db/log_test.cc:121">Write</a>(<span class="Constant">&quot;&quot;</span>);<br/></li>
<li>&nbsp; <a href="#L121" title="db/log_test.cc:121">Write</a>(<span class="Constant">&quot;bar&quot;</span>);<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L18" title="db/log_test.cc:18">BigString</a>(<span class="Constant">&quot;foo&quot;</span>, n), <a href="../table/table_test.cc.html#L120" title="table/table_test.cc:120">Read</a>());<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;&quot;</span>, <a href="../table/table_test.cc.html#L120" title="table/table_test.cc:120">Read</a>());<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;bar&quot;</span>, <a href="../table/table_test.cc.html#L120" title="table/table_test.cc:120">Read</a>());<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;EOF&quot;</span>, <a href="../table/table_test.cc.html#L120" title="table/table_test.cc:120">Read</a>());<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L288">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L115" title="db/log_test.cc:115">LogTest</a>, MarginalTrailer2) {<br/></li>
<li>&nbsp; <span class="Comment">// Make a trailer that is exactly the same length as an <a href="../table/block_builder.h.html#L38" title="table/block_builder.h:38">empty</a> record.<br/></li>
<li></span>&nbsp; <span class="Type">const</span> <span class="Type">int</span> n = kBlockSize - <span class="Constant">2</span>*kHeaderSize;<br/></li>
<li>&nbsp; <a href="#L121" title="db/log_test.cc:121">Write</a>(<a href="#L18" title="db/log_test.cc:18">BigString</a>(<span class="Constant">&quot;foo&quot;</span>, n));<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(kBlockSize - kHeaderSize, <a href="#L126" title="db/log_test.cc:126">WrittenBytes</a>());<br/></li>
<li>&nbsp; <a href="#L121" title="db/log_test.cc:121">Write</a>(<span class="Constant">&quot;bar&quot;</span>);<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L18" title="db/log_test.cc:18">BigString</a>(<span class="Constant">&quot;foo&quot;</span>, n), <a href="../table/table_test.cc.html#L120" title="table/table_test.cc:120">Read</a>());<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;bar&quot;</span>, <a href="../table/table_test.cc.html#L120" title="table/table_test.cc:120">Read</a>());<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;EOF&quot;</span>, <a href="../table/table_test.cc.html#L120" title="table/table_test.cc:120">Read</a>());<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">0</span>, <a href="#L167" title="db/log_test.cc:167">DroppedBytes</a>());<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;&quot;</span>, <a href="#L171" title="db/log_test.cc:171">ReportMessage</a>());<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L301">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L115" title="db/log_test.cc:115">LogTest</a>, ShortTrailer) {<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">int</span> n = kBlockSize - <span class="Constant">2</span>*kHeaderSize + <span class="Constant">4</span>;<br/></li>
<li>&nbsp; <a href="#L121" title="db/log_test.cc:121">Write</a>(<a href="#L18" title="db/log_test.cc:18">BigString</a>(<span class="Constant">&quot;foo&quot;</span>, n));<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(kBlockSize - kHeaderSize + <span class="Constant">4</span>, <a href="#L126" title="db/log_test.cc:126">WrittenBytes</a>());<br/></li>
<li>&nbsp; <a href="#L121" title="db/log_test.cc:121">Write</a>(<span class="Constant">&quot;&quot;</span>);<br/></li>
<li>&nbsp; <a href="#L121" title="db/log_test.cc:121">Write</a>(<span class="Constant">&quot;bar&quot;</span>);<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L18" title="db/log_test.cc:18">BigString</a>(<span class="Constant">&quot;foo&quot;</span>, n), <a href="../table/table_test.cc.html#L120" title="table/table_test.cc:120">Read</a>());<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;&quot;</span>, <a href="../table/table_test.cc.html#L120" title="table/table_test.cc:120">Read</a>());<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;bar&quot;</span>, <a href="../table/table_test.cc.html#L120" title="table/table_test.cc:120">Read</a>());<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;EOF&quot;</span>, <a href="../table/table_test.cc.html#L120" title="table/table_test.cc:120">Read</a>());<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L313">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L115" title="db/log_test.cc:115">LogTest</a>, AlignedEof) {<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">int</span> n = kBlockSize - <span class="Constant">2</span>*kHeaderSize + <span class="Constant">4</span>;<br/></li>
<li>&nbsp; <a href="#L121" title="db/log_test.cc:121">Write</a>(<a href="#L18" title="db/log_test.cc:18">BigString</a>(<span class="Constant">&quot;foo&quot;</span>, n));<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(kBlockSize - kHeaderSize + <span class="Constant">4</span>, <a href="#L126" title="db/log_test.cc:126">WrittenBytes</a>());<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L18" title="db/log_test.cc:18">BigString</a>(<span class="Constant">&quot;foo&quot;</span>, n), <a href="../table/table_test.cc.html#L120" title="table/table_test.cc:120">Read</a>());<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;EOF&quot;</span>, <a href="../table/table_test.cc.html#L120" title="table/table_test.cc:120">Read</a>());<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L321">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L115" title="db/log_test.cc:115">LogTest</a>, RandomRead) {<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">int</span> N = <span class="Constant">500</span>;<br/></li>
<li>&nbsp; <a href="../util/random.h.html#L19" title="util/random.h:19">Random</a> write_rnd(<span class="Constant">301</span>);<br/></li>
<li>&nbsp; <span class="Statement">for</span> (<span class="Type">int</span> i = <span class="Constant">0</span>; i &lt; N; i++) {<br/></li>
<li>&nbsp; &nbsp; <a href="#L121" title="db/log_test.cc:121">Write</a>(<a href="#L35" title="db/log_test.cc:35">RandomSkewedString</a>(i, &amp;write_rnd));<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <a href="../util/random.h.html#L19" title="util/random.h:19">Random</a> read_rnd(<span class="Constant">301</span>);<br/></li>
<li>&nbsp; <span class="Statement">for</span> (<span class="Type">int</span> i = <span class="Constant">0</span>; i &lt; N; i++) {<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L35" title="db/log_test.cc:35">RandomSkewedString</a>(i, &amp;read_rnd), <a href="../table/table_test.cc.html#L120" title="table/table_test.cc:120">Read</a>());<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;EOF&quot;</span>, <a href="../table/table_test.cc.html#L120" title="table/table_test.cc:120">Read</a>());<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">// Tests of all the error paths in log_reader.cc follow:<br/></li>
<li></span><br/></li>
<li><a id="L336">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L115" title="db/log_test.cc:115">LogTest</a>, ReadError) {<br/></li>
<li>&nbsp; <a href="#L121" title="db/log_test.cc:121">Write</a>(<span class="Constant">&quot;foo&quot;</span>);<br/></li>
<li>&nbsp; <a href="#L163" title="db/log_test.cc:163">ForceError</a>();<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;EOF&quot;</span>, <a href="../table/table_test.cc.html#L120" title="table/table_test.cc:120">Read</a>());<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(kBlockSize, <a href="#L167" title="db/log_test.cc:167">DroppedBytes</a>());<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;<a href="../include/leveldb/status.h.html#L32" title="include/leveldb/status.h:32">OK</a>&quot;</span>, <a href="#L176" title="db/log_test.cc:176">MatchError</a>(<span class="Constant">&quot;read error&quot;</span>));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L344">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L115" title="db/log_test.cc:115">LogTest</a>, BadRecordType) {<br/></li>
<li>&nbsp; <a href="#L121" title="db/log_test.cc:121">Write</a>(<span class="Constant">&quot;foo&quot;</span>);<br/></li>
<li>&nbsp; <span class="Comment">// Type is stored in header[6]<br/></li>
<li></span>&nbsp; <a href="#L144" title="db/log_test.cc:144">IncrementByte</a>(<span class="Constant">6</span>, <span class="Constant">100</span>);<br/></li>
<li>&nbsp; <a href="#L156" title="db/log_test.cc:156">FixChecksum</a>(<span class="Constant">0</span>, <span class="Constant">3</span>);<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;EOF&quot;</span>, <a href="../table/table_test.cc.html#L120" title="table/table_test.cc:120">Read</a>());<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">3</span>, <a href="#L167" title="db/log_test.cc:167">DroppedBytes</a>());<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;<a href="../include/leveldb/status.h.html#L32" title="include/leveldb/status.h:32">OK</a>&quot;</span>, <a href="#L176" title="db/log_test.cc:176">MatchError</a>(<span class="Constant">&quot;unknown record type&quot;</span>));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L354">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L115" title="db/log_test.cc:115">LogTest</a>, TruncatedTrailingRecordIsIgnored) {<br/></li>
<li>&nbsp; <a href="#L121" title="db/log_test.cc:121">Write</a>(<span class="Constant">&quot;foo&quot;</span>);<br/></li>
<li>&nbsp; <a href="#L152" title="db/log_test.cc:152">ShrinkSize</a>(<span class="Constant">4</span>);&nbsp;&nbsp; <span class="Comment">// Drop all payload as well as a header byte<br/></li>
<li></span>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;EOF&quot;</span>, <a href="../table/table_test.cc.html#L120" title="table/table_test.cc:120">Read</a>());<br/></li>
<li>&nbsp; <span class="Comment">// Truncated last record is ignored, not treated as an error.<br/></li>
<li></span>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">0</span>, <a href="#L167" title="db/log_test.cc:167">DroppedBytes</a>());<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;&quot;</span>, <a href="#L171" title="db/log_test.cc:171">ReportMessage</a>());<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L363">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L115" title="db/log_test.cc:115">LogTest</a>, BadLength) {<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">int</span> kPayloadSize = kBlockSize - kHeaderSize;<br/></li>
<li>&nbsp; <a href="#L121" title="db/log_test.cc:121">Write</a>(<a href="#L18" title="db/log_test.cc:18">BigString</a>(<span class="Constant">&quot;bar&quot;</span>, kPayloadSize));<br/></li>
<li>&nbsp; <a href="#L121" title="db/log_test.cc:121">Write</a>(<span class="Constant">&quot;foo&quot;</span>);<br/></li>
<li>&nbsp; <span class="Comment">// Least significant <a href="../table/format.h.html#L31" title="table/format.h:31">size</a> byte is stored in header[4].<br/></li>
<li></span>&nbsp; <a href="#L144" title="db/log_test.cc:144">IncrementByte</a>(<span class="Constant">4</span>, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;foo&quot;</span>, <a href="../table/table_test.cc.html#L120" title="table/table_test.cc:120">Read</a>());<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(kBlockSize, <a href="#L167" title="db/log_test.cc:167">DroppedBytes</a>());<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;<a href="../include/leveldb/status.h.html#L32" title="include/leveldb/status.h:32">OK</a>&quot;</span>, <a href="#L176" title="db/log_test.cc:176">MatchError</a>(<span class="Constant">&quot;bad record length&quot;</span>));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L374">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L115" title="db/log_test.cc:115">LogTest</a>, BadLengthAtEndIsIgnored) {<br/></li>
<li>&nbsp; <a href="#L121" title="db/log_test.cc:121">Write</a>(<span class="Constant">&quot;foo&quot;</span>);<br/></li>
<li>&nbsp; <a href="#L152" title="db/log_test.cc:152">ShrinkSize</a>(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;EOF&quot;</span>, <a href="../table/table_test.cc.html#L120" title="table/table_test.cc:120">Read</a>());<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">0</span>, <a href="#L167" title="db/log_test.cc:167">DroppedBytes</a>());<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;&quot;</span>, <a href="#L171" title="db/log_test.cc:171">ReportMessage</a>());<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L382">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L115" title="db/log_test.cc:115">LogTest</a>, ChecksumMismatch) {<br/></li>
<li>&nbsp; <a href="#L121" title="db/log_test.cc:121">Write</a>(<span class="Constant">&quot;foo&quot;</span>);<br/></li>
<li>&nbsp; <a href="#L144" title="db/log_test.cc:144">IncrementByte</a>(<span class="Constant">0</span>, <span class="Constant">10</span>);<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;EOF&quot;</span>, <a href="../table/table_test.cc.html#L120" title="table/table_test.cc:120">Read</a>());<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">10</span>, <a href="#L167" title="db/log_test.cc:167">DroppedBytes</a>());<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;<a href="../include/leveldb/status.h.html#L32" title="include/leveldb/status.h:32">OK</a>&quot;</span>, <a href="#L176" title="db/log_test.cc:176">MatchError</a>(<span class="Constant">&quot;checksum mismatch&quot;</span>));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L390">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L115" title="db/log_test.cc:115">LogTest</a>, UnexpectedMiddleType) {<br/></li>
<li>&nbsp; <a href="#L121" title="db/log_test.cc:121">Write</a>(<span class="Constant">&quot;foo&quot;</span>);<br/></li>
<li>&nbsp; <a href="#L148" title="db/log_test.cc:148">SetByte</a>(<span class="Constant">6</span>, kMiddleType);<br/></li>
<li>&nbsp; <a href="#L156" title="db/log_test.cc:156">FixChecksum</a>(<span class="Constant">0</span>, <span class="Constant">3</span>);<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;EOF&quot;</span>, <a href="../table/table_test.cc.html#L120" title="table/table_test.cc:120">Read</a>());<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">3</span>, <a href="#L167" title="db/log_test.cc:167">DroppedBytes</a>());<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;<a href="../include/leveldb/status.h.html#L32" title="include/leveldb/status.h:32">OK</a>&quot;</span>, <a href="#L176" title="db/log_test.cc:176">MatchError</a>(<span class="Constant">&quot;missing start&quot;</span>));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L399">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L115" title="db/log_test.cc:115">LogTest</a>, UnexpectedLastType) {<br/></li>
<li>&nbsp; <a href="#L121" title="db/log_test.cc:121">Write</a>(<span class="Constant">&quot;foo&quot;</span>);<br/></li>
<li>&nbsp; <a href="#L148" title="db/log_test.cc:148">SetByte</a>(<span class="Constant">6</span>, kLastType);<br/></li>
<li>&nbsp; <a href="#L156" title="db/log_test.cc:156">FixChecksum</a>(<span class="Constant">0</span>, <span class="Constant">3</span>);<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;EOF&quot;</span>, <a href="../table/table_test.cc.html#L120" title="table/table_test.cc:120">Read</a>());<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">3</span>, <a href="#L167" title="db/log_test.cc:167">DroppedBytes</a>());<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;<a href="../include/leveldb/status.h.html#L32" title="include/leveldb/status.h:32">OK</a>&quot;</span>, <a href="#L176" title="db/log_test.cc:176">MatchError</a>(<span class="Constant">&quot;missing start&quot;</span>));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L408">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L115" title="db/log_test.cc:115">LogTest</a>, UnexpectedFullType) {<br/></li>
<li>&nbsp; <a href="#L121" title="db/log_test.cc:121">Write</a>(<span class="Constant">&quot;foo&quot;</span>);<br/></li>
<li>&nbsp; <a href="#L121" title="db/log_test.cc:121">Write</a>(<span class="Constant">&quot;bar&quot;</span>);<br/></li>
<li>&nbsp; <a href="#L148" title="db/log_test.cc:148">SetByte</a>(<span class="Constant">6</span>, kFirstType);<br/></li>
<li>&nbsp; <a href="#L156" title="db/log_test.cc:156">FixChecksum</a>(<span class="Constant">0</span>, <span class="Constant">3</span>);<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;bar&quot;</span>, <a href="../table/table_test.cc.html#L120" title="table/table_test.cc:120">Read</a>());<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;EOF&quot;</span>, <a href="../table/table_test.cc.html#L120" title="table/table_test.cc:120">Read</a>());<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">3</span>, <a href="#L167" title="db/log_test.cc:167">DroppedBytes</a>());<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;<a href="../include/leveldb/status.h.html#L32" title="include/leveldb/status.h:32">OK</a>&quot;</span>, <a href="#L176" title="db/log_test.cc:176">MatchError</a>(<span class="Constant">&quot;partial record without end&quot;</span>));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L419">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L115" title="db/log_test.cc:115">LogTest</a>, UnexpectedFirstType) {<br/></li>
<li>&nbsp; <a href="#L121" title="db/log_test.cc:121">Write</a>(<span class="Constant">&quot;foo&quot;</span>);<br/></li>
<li>&nbsp; <a href="#L121" title="db/log_test.cc:121">Write</a>(<a href="#L18" title="db/log_test.cc:18">BigString</a>(<span class="Constant">&quot;bar&quot;</span>, <span class="Constant">100000</span>));<br/></li>
<li>&nbsp; <a href="#L148" title="db/log_test.cc:148">SetByte</a>(<span class="Constant">6</span>, kFirstType);<br/></li>
<li>&nbsp; <a href="#L156" title="db/log_test.cc:156">FixChecksum</a>(<span class="Constant">0</span>, <span class="Constant">3</span>);<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L18" title="db/log_test.cc:18">BigString</a>(<span class="Constant">&quot;bar&quot;</span>, <span class="Constant">100000</span>), <a href="../table/table_test.cc.html#L120" title="table/table_test.cc:120">Read</a>());<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;EOF&quot;</span>, <a href="../table/table_test.cc.html#L120" title="table/table_test.cc:120">Read</a>());<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">3</span>, <a href="#L167" title="db/log_test.cc:167">DroppedBytes</a>());<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;<a href="../include/leveldb/status.h.html#L32" title="include/leveldb/status.h:32">OK</a>&quot;</span>, <a href="#L176" title="db/log_test.cc:176">MatchError</a>(<span class="Constant">&quot;partial record without end&quot;</span>));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L430">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L115" title="db/log_test.cc:115">LogTest</a>, MissingLastIsIgnored) {<br/></li>
<li>&nbsp; <a href="#L121" title="db/log_test.cc:121">Write</a>(<a href="#L18" title="db/log_test.cc:18">BigString</a>(<span class="Constant">&quot;bar&quot;</span>, kBlockSize));<br/></li>
<li>&nbsp; <span class="Comment">// <a href="../util/cache.cc.html#L78" title="util/cache.cc:78">Remove</a> the LAST block, including header.<br/></li>
<li></span>&nbsp; <a href="#L152" title="db/log_test.cc:152">ShrinkSize</a>(<span class="Constant">14</span>);<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;EOF&quot;</span>, <a href="../table/table_test.cc.html#L120" title="table/table_test.cc:120">Read</a>());<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;&quot;</span>, <a href="#L171" title="db/log_test.cc:171">ReportMessage</a>());<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">0</span>, <a href="#L167" title="db/log_test.cc:167">DroppedBytes</a>());<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L439">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L115" title="db/log_test.cc:115">LogTest</a>, PartialLastIsIgnored) {<br/></li>
<li>&nbsp; <a href="#L121" title="db/log_test.cc:121">Write</a>(<a href="#L18" title="db/log_test.cc:18">BigString</a>(<span class="Constant">&quot;bar&quot;</span>, kBlockSize));<br/></li>
<li>&nbsp; <span class="Comment">// Cause a bad record length in the LAST block.<br/></li>
<li></span>&nbsp; <a href="#L152" title="db/log_test.cc:152">ShrinkSize</a>(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;EOF&quot;</span>, <a href="../table/table_test.cc.html#L120" title="table/table_test.cc:120">Read</a>());<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;&quot;</span>, <a href="#L171" title="db/log_test.cc:171">ReportMessage</a>());<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">0</span>, <a href="#L167" title="db/log_test.cc:167">DroppedBytes</a>());<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L448">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L115" title="db/log_test.cc:115">LogTest</a>, ErrorJoinsRecords) {<br/></li>
<li>&nbsp; <span class="Comment">// Consider two fragmented records:<br/></li>
<li></span>&nbsp; <span class="Comment">//&nbsp; &nbsp; first(R1) last(R1) first(R2) last(R2)<br/></li>
<li></span>&nbsp; <span class="Comment">// where the middle two fragments disappear.&nbsp; We do not want<br/></li>
<li></span>&nbsp; <span class="Comment">// first(R1),last(R2) to get joined and returned as a valid record.<br/></li>
<li></span><br/></li>
<li>&nbsp; <span class="Comment">// <a href="#L121" title="db/log_test.cc:121">Write</a> records that span two blocks<br/></li>
<li></span>&nbsp; <a href="#L121" title="db/log_test.cc:121">Write</a>(<a href="#L18" title="db/log_test.cc:18">BigString</a>(<span class="Constant">&quot;foo&quot;</span>, kBlockSize));<br/></li>
<li>&nbsp; <a href="#L121" title="db/log_test.cc:121">Write</a>(<a href="#L18" title="db/log_test.cc:18">BigString</a>(<span class="Constant">&quot;bar&quot;</span>, kBlockSize));<br/></li>
<li>&nbsp; <a href="#L121" title="db/log_test.cc:121">Write</a>(<span class="Constant">&quot;correct&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// Wipe the middle block<br/></li>
<li></span>&nbsp; <span class="Statement">for</span> (<span class="Type">int</span> <a href="../table/format.h.html#L27" title="table/format.h:27">offset</a> = kBlockSize; <a href="../table/format.h.html#L27" title="table/format.h:27">offset</a> &lt; <span class="Constant">2</span>*kBlockSize; <a href="../table/format.h.html#L27" title="table/format.h:27">offset</a>++) {<br/></li>
<li>&nbsp; &nbsp; <a href="#L148" title="db/log_test.cc:148">SetByte</a>(<a href="../table/format.h.html#L27" title="table/format.h:27">offset</a>, <span class="Constant">'x'</span>);<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;correct&quot;</span>, <a href="../table/table_test.cc.html#L120" title="table/table_test.cc:120">Read</a>());<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">&quot;EOF&quot;</span>, <a href="../table/table_test.cc.html#L120" title="table/table_test.cc:120">Read</a>());<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">size_t</span> dropped = <a href="#L167" title="db/log_test.cc:167">DroppedBytes</a>();<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L111" title="util/testharness.h:111">ASSERT_LE</a>(dropped, <span class="Constant">2</span>*kBlockSize + <span class="Constant">100</span>);<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L109" title="util/testharness.h:109">ASSERT_GE</a>(dropped, <span class="Constant">2</span>*kBlockSize);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L471">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L115" title="db/log_test.cc:115">LogTest</a>, ReadStart) {<br/></li>
<li>&nbsp; <a href="#L204" title="db/log_test.cc:204">CheckInitialOffsetRecord</a>(<span class="Constant">0</span>, <span class="Constant">0</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L475">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L115" title="db/log_test.cc:115">LogTest</a>, ReadSecondOneOff) {<br/></li>
<li>&nbsp; <a href="#L204" title="db/log_test.cc:204">CheckInitialOffsetRecord</a>(<span class="Constant">1</span>, <span class="Constant">1</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L479">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L115" title="db/log_test.cc:115">LogTest</a>, ReadSecondTenThousand) {<br/></li>
<li>&nbsp; <a href="#L204" title="db/log_test.cc:204">CheckInitialOffsetRecord</a>(<span class="Constant">10000</span>, <span class="Constant">1</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L483">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L115" title="db/log_test.cc:115">LogTest</a>, ReadSecondStart) {<br/></li>
<li>&nbsp; <a href="#L204" title="db/log_test.cc:204">CheckInitialOffsetRecord</a>(<span class="Constant">10007</span>, <span class="Constant">1</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L487">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L115" title="db/log_test.cc:115">LogTest</a>, ReadThirdOneOff) {<br/></li>
<li>&nbsp; <a href="#L204" title="db/log_test.cc:204">CheckInitialOffsetRecord</a>(<span class="Constant">10008</span>, <span class="Constant">2</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L491">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L115" title="db/log_test.cc:115">LogTest</a>, ReadThirdStart) {<br/></li>
<li>&nbsp; <a href="#L204" title="db/log_test.cc:204">CheckInitialOffsetRecord</a>(<span class="Constant">20014</span>, <span class="Constant">2</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L495">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L115" title="db/log_test.cc:115">LogTest</a>, ReadFourthOneOff) {<br/></li>
<li>&nbsp; <a href="#L204" title="db/log_test.cc:204">CheckInitialOffsetRecord</a>(<span class="Constant">20015</span>, <span class="Constant">3</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L499">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L115" title="db/log_test.cc:115">LogTest</a>, ReadFourthFirstBlockTrailer) {<br/></li>
<li>&nbsp; <a href="#L204" title="db/log_test.cc:204">CheckInitialOffsetRecord</a>(log::kBlockSize - <span class="Constant">4</span>, <span class="Constant">3</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L503">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L115" title="db/log_test.cc:115">LogTest</a>, ReadFourthMiddleBlock) {<br/></li>
<li>&nbsp; <a href="#L204" title="db/log_test.cc:204">CheckInitialOffsetRecord</a>(log::kBlockSize + <span class="Constant">1</span>, <span class="Constant">3</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L507">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L115" title="db/log_test.cc:115">LogTest</a>, ReadFourthLastBlock) {<br/></li>
<li>&nbsp; <a href="#L204" title="db/log_test.cc:204">CheckInitialOffsetRecord</a>(<span class="Constant">2</span> * log::kBlockSize + <span class="Constant">1</span>, <span class="Constant">3</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L511">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L115" title="db/log_test.cc:115">LogTest</a>, ReadFourthStart) {<br/></li>
<li>&nbsp; <a href="#L204" title="db/log_test.cc:204">CheckInitialOffsetRecord</a>(<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">2</span> * (kHeaderSize + <span class="Constant">1000</span>) + (<span class="Constant">2</span> * log::kBlockSize - <span class="Constant">1000</span>) + <span class="Constant">3</span> * kHeaderSize,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">3</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L517">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L115" title="db/log_test.cc:115">LogTest</a>, ReadEnd) {<br/></li>
<li>&nbsp; <a href="#L192" title="db/log_test.cc:192">CheckOffsetPastEndReturnsNoRecords</a>(<span class="Constant">0</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L521">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L115" title="db/log_test.cc:115">LogTest</a>, ReadPastEnd) {<br/></li>
<li>&nbsp; <a href="#L192" title="db/log_test.cc:192">CheckOffsetPastEndReturnsNoRecords</a>(<span class="Constant">5</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li>}&nbsp; <span class="Comment">// namespace log<br/></li>
<li></span>}&nbsp; <span class="Comment">// namespace leveldb<br/></li>
<li></span><br/></li>
<li><a id="L528">&#x200c;</a><span class="Type">int</span> <span class="linkable">main</span>(<span class="Type">int</span> argc, <span class="Type">char</span>** argv) {<br/></li>
<li>&nbsp; <span class="Statement">return</span> leveldb::test::<a href="../util/testharness.cc.html#L36" title="util/testharness.cc:36">RunAllTests</a>();<br/></li>
<li>}<br/></li>
</ol></code>
 </body>
</html>
