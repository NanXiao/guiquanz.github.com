<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>table/table_test.cc - leveldb-1.18</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

code {
    font-family: consolas, monospace;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
  <h3>table/table_test.cc - leveldb-1.18</h3>
   <a href="../index.html"> Table of Contents </a>
 <h4>Data types defined</h4>
 <ul>
<li><a href="#L137">KVMap</a></li>
<li><a href="#L79">STLLessThan</a></li>
<li><a href="#L406">TestArgs</a></li>
<li><a href="#L399">TestType</a></li>
</ul>
 <h4>Functions defined</h4>
 <ul>
<li><a href="#L146">Add</a></li>
<li><a href="#L473">Add</a></li>
<li><a href="#L100">Append</a></li>
<li><a href="#L257">ApproximateOffsetOf</a></li>
<li><a href="#L787">Between</a></li>
<li><a href="#L183">BlockConstructor</a></li>
<li><a href="#L96">Close</a></li>
<li><a href="#L44">Compare</a></li>
<li><a href="#L143">Constructor</a></li>
<li><a href="#L351">DBConstructor</a></li>
<li><a href="#L57">FindShortSuccessor</a></li>
<li><a href="#L48">FindShortestSeparator</a></li>
<li><a href="#L153">Finish</a></li>
<li><a href="#L190">FinishImpl</a></li>
<li><a href="#L230">FinishImpl</a></li>
<li><a href="#L327">FinishImpl</a></li>
<li><a href="#L360">FinishImpl</a></li>
<li><a href="#L97">Flush</a></li>
<li><a href="#L439">Harness</a></li>
<li><a href="#L66">Increment</a></li>
<li><a href="#L441">Init</a></li>
<li><a href="#L278">KeyConvertingIterator</a></li>
<li><a href="#L318">MemTableConstructor</a></li>
<li><a href="#L40">Name</a></li>
<li><a href="#L380">NewDB</a></li>
<li><a href="#L209">NewIterator</a></li>
<li><a href="#L253">NewIterator</a></li>
<li><a href="#L340">NewIterator</a></li>
<li><a href="#L373">NewIterator</a></li>
<li><a href="#L289">Next</a></li>
<li><a href="#L612">PickRandomKey</a></li>
<li><a href="#L290">Prev</a></li>
<li><a href="#L120">Read</a></li>
<li><a href="#L262">Reset</a></li>
<li><a href="#L27">Reverse</a></li>
<li><a href="#L82">STLLessThan</a></li>
<li><a href="#L83">STLLessThan</a></li>
<li><a href="#L281">Seek</a></li>
<li><a href="#L287">SeekToFirst</a></li>
<li><a href="#L288">SeekToLast</a></li>
<li><a href="#L118">Size</a></li>
<li><a href="#L830">SnappyCompressionSupported</a></li>
<li><a href="#L112">StringSource</a></li>
<li><a href="#L98">Sync</a></li>
<li><a href="#L648">TEST(Harness, Empty) {</a></li>
<li><a href="#L659">TEST(Harness, ZeroRestartPointsInBlock) {</a></li>
<li><a href="#L678">TEST(Harness, SimpleEmptyKey) {</a></li>
<li><a href="#L687">TEST(Harness, SimpleSingle) {</a></li>
<li><a href="#L696">TEST(Harness, SimpleMulti) {</a></li>
<li><a href="#L707">TEST(Harness, SimpleSpecialKey) {</a></li>
<li><a href="#L716">TEST(Harness, Randomized) {</a></li>
<li><a href="#L736">TEST(Harness, RandomizedLongDB) {</a></li>
<li><a href="#L762">TEST(MemTableTest, Simple) {</a></li>
<li><a href="#L800">TEST(TableTest, ApproximateOffsetOfPlain) {</a></li>
<li><a href="#L836">TEST(TableTest, ApproximateOffsetOfCompressed) {</a></li>
<li><a href="#L223">TableConstructor</a></li>
<li><a href="#L477">Test</a></li>
<li><a href="#L502">TestBackwardScan</a></li>
<li><a href="#L487">TestForwardScan</a></li>
<li><a href="#L517">TestRandomAccess</a></li>
<li><a href="#L587">ToString</a></li>
<li><a href="#L595">ToString</a></li>
<li><a href="#L604">ToString</a></li>
<li><a href="#L280">Valid</a></li>
<li><a href="#L94">contents</a></li>
<li><a href="#L173">data</a></li>
<li><a href="#L175">db</a></li>
<li><a href="#L377">db</a></li>
<li><a href="#L640">db</a></li>
<li><a href="#L292">key</a></li>
<li><a href="#L866">main</a></li>
<li><a href="#L84">operator ()</a></li>
<li><a href="#L303">status</a></li>
<li><a href="#L302">value</a></li>
<li><a href="#L187">~BlockConstructor</a></li>
<li><a href="#L144">~Constructor</a></li>
<li><a href="#L357">~DBConstructor</a></li>
<li><a href="#L469">~Harness</a></li>
<li><a href="#L279">~KeyConvertingIterator</a></li>
<li><a href="#L324">~MemTableConstructor</a></li>
<li><a href="#L92">~StringSink</a></li>
<li><a href="#L116">~StringSource</a></li>
<li><a href="#L227">~TableConstructor</a></li>
</ul>
 <h4>Source code</h4>

  <code><ol><li><span class="Comment">// Copyright (c) 2011 The LevelDB Authors. All rights reserved.<br/></li>
<li></span><span class="Comment">// Use of this source <a href="../include/leveldb/status.h.html#L84" title="include/leveldb/status.h:84">code</a> is governed by a BSD-style license that can be<br/></li>
<li></span><span class="Comment">// found in the LICENSE file. See the AUTHORS file for names of contributors.<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;leveldb/table.h&quot;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;map&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;string&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;<a href="#L175" title="table/table_test.cc:175">db</a>/dbformat.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;<a href="#L175" title="table/table_test.cc:175">db</a>/memtable.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;<a href="#L175" title="table/table_test.cc:175">db</a>/write_batch_internal.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;leveldb/<a href="#L175" title="table/table_test.cc:175">db</a>.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;leveldb/env.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;leveldb/iterator.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;leveldb/table_builder.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;table/block.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;table/block_builder.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;table/format.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;util/random.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;util/testharness.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;util/testutil.h&quot;<br/></li>
<li></span><br/></li>
<li><span class="Type">namespace</span> leveldb {<br/></li>
<li><br/></li>
<li><span class="Comment">// Return reverse of &quot;<a href="two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>&quot;.<br/></li>
<li></span><span class="Comment">// Used to test non-lexicographic comparators.<br/></li>
<li><a id="L27">&#x200c;</a></span><span class="Type">static</span> std::string <span class="linkable">Reverse</span>(<span class="Type">const</span> <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>&amp; <a href="two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>) {<br/></li>
<li>&nbsp; std::string str(<a href="two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>.<a href="#L587" title="table/table_test.cc:587">ToString</a>());<br/></li>
<li>&nbsp; std::string rev(<span class="Constant">&quot;&quot;</span>);<br/></li>
<li>&nbsp; <span class="Statement">for</span> (std::string::reverse_iterator rit = str.rbegin();<br/></li>
<li>&nbsp; &nbsp; &nbsp;&nbsp; rit != str.rend(); ++rit) {<br/></li>
<li>&nbsp; &nbsp; rev.push_back(*rit);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> rev;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Type">namespace</span> {<br/></li>
<li><span class="Type">class</span> ReverseKeyComparator : <span class="Statement">public</span> <a href="../db/skiplist_test.cc.html#L17" title="db/skiplist_test.cc:17">Comparator</a> {<br/></li>
<li><span class="cUserCont"> </span><span class="Statement">public</span><span class="cUserCont">:<br/></li>
<li><a id="L40">&#x200c;</a></span>&nbsp; <span class="Type">virtual</span> <span class="Type">const</span> <span class="Type">char</span>* <span class="linkable">Name</span>() <span class="Type">const</span> {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">&quot;leveldb.ReverseBytewiseComparator&quot;</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li><a id="L44">&#x200c;</a>&nbsp; <span class="Type">virtual</span> <span class="Type">int</span> <span class="linkable">Compare</span>(<span class="Type">const</span> <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>&amp; a, <span class="Type">const</span> <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>&amp; b) <span class="Type">const</span> {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../util/comparator.cc.html#L76" title="util/comparator.cc:76">BytewiseComparator</a>()-&gt;<a href="#L44" title="table/table_test.cc:44">Compare</a>(<a href="#L27" title="table/table_test.cc:27">Reverse</a>(a), <a href="#L27" title="table/table_test.cc:27">Reverse</a>(b));<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li><a id="L48">&#x200c;</a>&nbsp; <span class="Type">virtual</span> <span class="Type">void</span> <span class="linkable">FindShortestSeparator</span>(<br/></li>
<li>&nbsp; &nbsp; &nbsp; std::string* start,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Type">const</span> <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>&amp; limit) <span class="Type">const</span> {<br/></li>
<li>&nbsp; &nbsp; std::string s = <a href="#L27" title="table/table_test.cc:27">Reverse</a>(*start);<br/></li>
<li>&nbsp; &nbsp; std::string l = <a href="#L27" title="table/table_test.cc:27">Reverse</a>(limit);<br/></li>
<li>&nbsp; &nbsp; <a href="../util/comparator.cc.html#L76" title="util/comparator.cc:76">BytewiseComparator</a>()-&gt;<a href="#L48" title="table/table_test.cc:48">FindShortestSeparator</a>(&amp;s, l);<br/></li>
<li>&nbsp; &nbsp; *start = <a href="#L27" title="table/table_test.cc:27">Reverse</a>(s);<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li><a id="L57">&#x200c;</a>&nbsp; <span class="Type">virtual</span> <span class="Type">void</span> <span class="linkable">FindShortSuccessor</span>(std::string* <a href="two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>) <span class="Type">const</span> {<br/></li>
<li>&nbsp; &nbsp; std::string s = <a href="#L27" title="table/table_test.cc:27">Reverse</a>(*<a href="two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>);<br/></li>
<li>&nbsp; &nbsp; <a href="../util/comparator.cc.html#L76" title="util/comparator.cc:76">BytewiseComparator</a>()-&gt;<a href="#L57" title="table/table_test.cc:57">FindShortSuccessor</a>(&amp;s);<br/></li>
<li>&nbsp; &nbsp; *<a href="two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a> = <a href="#L27" title="table/table_test.cc:27">Reverse</a>(s);<br/></li>
<li>&nbsp; }<br/></li>
<li>};<br/></li>
<li>}&nbsp; <span class="Comment">// namespace<br/></li>
<li></span><span class="Type">static</span> ReverseKeyComparator reverse_key_comparator;<br/></li>
<li><br/></li>
<li><a id="L66">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">Increment</span>(<span class="Type">const</span> <a href="../db/skiplist_test.cc.html#L17" title="db/skiplist_test.cc:17">Comparator</a>* cmp, std::string* <a href="two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>) {<br/></li>
<li>&nbsp; <span class="Statement">if</span> (cmp == <a href="../util/comparator.cc.html#L76" title="util/comparator.cc:76">BytewiseComparator</a>()) {<br/></li>
<li>&nbsp; &nbsp; <a href="two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>-&gt;push_back(<span class="Special">'\0'</span>);<br/></li>
<li>&nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; assert(cmp == &amp;reverse_key_comparator);<br/></li>
<li>&nbsp; &nbsp; std::string rev = <a href="#L27" title="table/table_test.cc:27">Reverse</a>(*<a href="two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>);<br/></li>
<li>&nbsp; &nbsp; rev.push_back(<span class="Special">'\0'</span>);<br/></li>
<li>&nbsp; &nbsp; *<a href="two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a> = <a href="#L27" title="table/table_test.cc:27">Reverse</a>(rev);<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">// An STL comparator that uses a <a href="../db/skiplist_test.cc.html#L17" title="db/skiplist_test.cc:17">Comparator</a><br/></li>
<li></span><span class="Type">namespace</span> {<br/></li>
<li><a id="L79">&#x200c;</a><span class="Type">struct</span> <span class="linkable">STLLessThan</span> {<br/></li>
<li>&nbsp; <span class="Type">const</span> <a href="../db/skiplist_test.cc.html#L17" title="db/skiplist_test.cc:17">Comparator</a>* cmp;<br/></li>
<li><br/></li>
<li><a id="L82">&#x200c;</a>&nbsp; <span class="linkable">STLLessThan</span>() : cmp(<a href="../util/comparator.cc.html#L76" title="util/comparator.cc:76">BytewiseComparator</a>()) { }<br/></li>
<li><a id="L83">&#x200c;</a>&nbsp; <span class="linkable">STLLessThan</span>(<span class="Type">const</span> <a href="../db/skiplist_test.cc.html#L17" title="db/skiplist_test.cc:17">Comparator</a>* c) : cmp(c) { }<br/></li>
<li><a id="L84">&#x200c;</a>&nbsp; <span class="Type">bool</span> <span class="Statement">operator</span>()(<span class="Type">const</span> std::string&amp; a, <span class="Type">const</span> std::string&amp; b) <span class="Type">const</span> {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> cmp-&gt;<a href="#L44" title="table/table_test.cc:44">Compare</a>(<a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>(a), <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>(b)) &lt; <span class="Constant">0</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li>};<br/></li>
<li>}&nbsp; <span class="Comment">// namespace<br/></li>
<li></span><br/></li>
<li><span class="Type">class</span> StringSink: <span class="Statement">public</span> <a href="../include/leveldb/env.h.html#L214" title="include/leveldb/env.h:214">WritableFile</a> {<br/></li>
<li><span class="cUserCont"> </span><span class="Statement">public</span><span class="cUserCont">:<br/></li>
<li><a id="L92">&#x200c;</a></span>&nbsp; ~StringSink() { }<br/></li>
<li><br/></li>
<li><a id="L94">&#x200c;</a>&nbsp; <span class="Type">const</span> std::string&amp; <span class="linkable">contents</span>() <span class="Type">const</span> { <span class="Statement">return</span> contents_; }<br/></li>
<li><br/></li>
<li><a id="L96">&#x200c;</a>&nbsp; <span class="Type">virtual</span> <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> <span class="linkable">Close</span>() { <span class="Statement">return</span> <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a>::<a href="../include/leveldb/status.h.html#L32" title="include/leveldb/status.h:32">OK</a>(); }<br/></li>
<li><a id="L97">&#x200c;</a>&nbsp; <span class="Type">virtual</span> <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> <span class="linkable">Flush</span>() { <span class="Statement">return</span> <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a>::<a href="../include/leveldb/status.h.html#L32" title="include/leveldb/status.h:32">OK</a>(); }<br/></li>
<li><a id="L98">&#x200c;</a>&nbsp; <span class="Type">virtual</span> <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> <span class="linkable">Sync</span>() { <span class="Statement">return</span> <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a>::<a href="../include/leveldb/status.h.html#L32" title="include/leveldb/status.h:32">OK</a>(); }<br/></li>
<li><br/></li>
<li><a id="L100">&#x200c;</a>&nbsp; <span class="Type">virtual</span> <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> <span class="linkable">Append</span>(<span class="Type">const</span> <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>&amp; <a href="#L173" title="table/table_test.cc:173">data</a>) {<br/></li>
<li>&nbsp; &nbsp; contents_.append(<a href="#L173" title="table/table_test.cc:173">data</a>.<a href="#L173" title="table/table_test.cc:173">data</a>(), <a href="#L173" title="table/table_test.cc:173">data</a>.<a href="format.h.html#L31" title="table/format.h:31">size</a>());<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a>::<a href="../include/leveldb/status.h.html#L32" title="include/leveldb/status.h:32">OK</a>();<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li><span class="cUserCont"> </span><span class="Statement">private</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; std::string contents_;<br/></li>
<li>};<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">class</span> <a href="#L112" title="table/table_test.cc:112">StringSource</a>: <span class="Statement">public</span> <a href="../include/leveldb/env.h.html#L188" title="include/leveldb/env.h:188">RandomAccessFile</a> {<br/></li>
<li><span class="cUserCont"> </span><span class="Statement">public</span><span class="cUserCont">:<br/></li>
<li><a id="L112">&#x200c;</a></span>&nbsp; <span class="linkable">StringSource</span>(<span class="Type">const</span> <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>&amp; <a href="#L94" title="table/table_test.cc:94">contents</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; : contents_(<a href="#L94" title="table/table_test.cc:94">contents</a>.<a href="#L173" title="table/table_test.cc:173">data</a>(), <a href="#L94" title="table/table_test.cc:94">contents</a>.<a href="format.h.html#L31" title="table/format.h:31">size</a>()) {<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li><a id="L116">&#x200c;</a>&nbsp; <span class="Type">virtual</span> ~<a href="#L112" title="table/table_test.cc:112">StringSource</a>() { }<br/></li>
<li><br/></li>
<li><a id="L118">&#x200c;</a>&nbsp; <span class="Type"><a href="../port/win/stdint.h.html#L22" title="port/win/stdint.h:22">uint64_t</a></span> <span class="linkable">Size</span>() <span class="Type">const</span> { <span class="Statement">return</span> contents_.<a href="format.h.html#L31" title="table/format.h:31">size</a>(); }<br/></li>
<li><br/></li>
<li><a id="L120">&#x200c;</a>&nbsp; <span class="Type">virtual</span> <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> <span class="linkable">Read</span>(<span class="Type"><a href="../port/win/stdint.h.html#L22" title="port/win/stdint.h:22">uint64_t</a></span> <a href="format.h.html#L27" title="table/format.h:27">offset</a>, <span class="Type">size_t</span> n, <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>* result,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type">char</span>* scratch) <span class="Type">const</span> {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="format.h.html#L27" title="table/format.h:27">offset</a> &gt; contents_.<a href="format.h.html#L31" title="table/format.h:31">size</a>()) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a>::<a href="../include/leveldb/status.h.html#L44" title="include/leveldb/status.h:44">InvalidArgument</a>(<span class="Constant">&quot;invalid <a href="#L120" title="table/table_test.cc:120">Read</a> <a href="format.h.html#L27" title="table/format.h:27">offset</a>&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="format.h.html#L27" title="table/format.h:27">offset</a> + n &gt; contents_.<a href="format.h.html#L31" title="table/format.h:31">size</a>()) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; n = contents_.<a href="format.h.html#L31" title="table/format.h:31">size</a>() - <a href="format.h.html#L27" title="table/format.h:27">offset</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; memcpy(scratch, &amp;contents_[<a href="format.h.html#L27" title="table/format.h:27">offset</a>], n);<br/></li>
<li>&nbsp; &nbsp; *result = <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>(scratch, n);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a>::<a href="../include/leveldb/status.h.html#L32" title="include/leveldb/status.h:32">OK</a>();<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li><span class="cUserCont"> </span><span class="Statement">private</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; std::string contents_;<br/></li>
<li>};<br/></li>
<li><br/></li>
<li><a id="L137">&#x200c;</a><span class="Type">typedef</span> std::map&lt;std::string, std::string, <a href="#L79" title="table/table_test.cc:79">STLLessThan</a>&gt; <span class="linkable">KVMap</span>;<br/></li>
<li><br/></li>
<li><span class="Comment">// Helper class for tests to unify the interface between<br/></li>
<li></span><span class="Comment">// <a href="block_builder.cc.html#L39" title="table/block_builder.cc:39">BlockBuilder</a>/<a href="table_builder.cc.html#L63" title="table/table_builder.cc:63">TableBuilder</a> and <a href="block.cc.html#L23" title="table/block.cc:23">Block</a>/<a href="../include/leveldb/table.h.html#L62" title="include/leveldb/table.h:62">Table</a>.<br/></li>
<li></span><span class="Type">class</span> <a href="#L143" title="table/table_test.cc:143">Constructor</a> {<br/></li>
<li><span class="cUserCont"> </span><span class="Statement">public</span><span class="cUserCont">:<br/></li>
<li><a id="L143">&#x200c;</a></span>&nbsp; <span class="Type">explicit</span> <span class="linkable">Constructor</span>(<span class="Type">const</span> <a href="../db/skiplist_test.cc.html#L17" title="db/skiplist_test.cc:17">Comparator</a>* cmp) : data_(<a href="#L79" title="table/table_test.cc:79">STLLessThan</a>(cmp)) { }<br/></li>
<li><a id="L144">&#x200c;</a>&nbsp; <span class="Type">virtual</span> ~<a href="#L143" title="table/table_test.cc:143">Constructor</a>() { }<br/></li>
<li><br/></li>
<li><a id="L146">&#x200c;</a>&nbsp; <span class="Type">void</span> <span class="linkable">Add</span>(<span class="Type">const</span> std::string&amp; <a href="two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>, <span class="Type">const</span> <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>&amp; <a href="two_level_iterator.cc.html#L41" title="table/two_level_iterator.cc:41">value</a>) {<br/></li>
<li>&nbsp; &nbsp; data_[<a href="two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>] = <a href="two_level_iterator.cc.html#L41" title="table/two_level_iterator.cc:41">value</a>.<a href="#L587" title="table/table_test.cc:587">ToString</a>();<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// <a href="#L153" title="table/table_test.cc:153">Finish</a> constructing the <a href="#L173" title="table/table_test.cc:173">data</a> structure with all the keys that have<br/></li>
<li></span>&nbsp; <span class="Comment">// been added so far.&nbsp; Returns the keys in sorted order in &quot;*keys&quot;<br/></li>
<li></span>&nbsp; <span class="Comment">// and stores the <a href="two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>/<a href="two_level_iterator.cc.html#L41" title="table/two_level_iterator.cc:41">value</a> pairs in &quot;*kvmap&quot;<br/></li>
<li><a id="L153">&#x200c;</a></span>&nbsp; <span class="Type">void</span> <span class="linkable">Finish</span>(<span class="Type">const</span> <a href="../include/leveldb/options.h.html#L31" title="include/leveldb/options.h:31">Options</a>&amp; options,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; std::vector&lt;std::string&gt;* keys,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L137" title="table/table_test.cc:137">KVMap</a>* kvmap) {<br/></li>
<li>&nbsp; &nbsp; *kvmap = data_;<br/></li>
<li>&nbsp; &nbsp; keys-&gt;<a href="../include/leveldb/slice.h.html#L56" title="include/leveldb/slice.h:56">clear</a>();<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (<a href="#L137" title="table/table_test.cc:137">KVMap</a>::const_iterator it = data_.begin();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; it != data_.end();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ++it) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; keys-&gt;push_back(it-&gt;first);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; data_.<a href="../include/leveldb/slice.h.html#L56" title="include/leveldb/slice.h:56">clear</a>();<br/></li>
<li>&nbsp; &nbsp; <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> s = <a href="#L190" title="table/table_test.cc:190">FinishImpl</a>(options, *kvmap);<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(s.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>()) &lt;&lt; s.<a href="#L587" title="table/table_test.cc:587">ToString</a>();<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// Construct the <a href="#L173" title="table/table_test.cc:173">data</a> structure from the <a href="#L173" title="table/table_test.cc:173">data</a> in &quot;<a href="#L173" title="table/table_test.cc:173">data</a>&quot;<br/></li>
<li></span>&nbsp; <span class="Type">virtual</span> <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> <a href="#L190" title="table/table_test.cc:190">FinishImpl</a>(<span class="Type">const</span> <a href="../include/leveldb/options.h.html#L31" title="include/leveldb/options.h:31">Options</a>&amp; options, <span class="Type">const</span> <a href="#L137" title="table/table_test.cc:137">KVMap</a>&amp; <a href="#L173" title="table/table_test.cc:173">data</a>) = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Type">virtual</span> <a href="iterator.cc.html#L9" title="table/iterator.cc:9">Iterator</a>* <a href="#L209" title="table/table_test.cc:209">NewIterator</a>() <span class="Type">const</span> = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li><a id="L173">&#x200c;</a>&nbsp; <span class="Type">virtual</span> <span class="Type">const</span> <a href="#L137" title="table/table_test.cc:137">KVMap</a>&amp; <span class="linkable">data</span>() { <span class="Statement">return</span> data_; }<br/></li>
<li><br/></li>
<li><a id="L175">&#x200c;</a>&nbsp; <span class="Type">virtual</span> <a href="../include/leveldb/db.h.html#L55" title="include/leveldb/db.h:55">DB</a>* <span class="linkable">db</span>() <span class="Type">const</span> { <span class="Statement">return</span> <span class="Constant">NULL</span>; }&nbsp; <span class="Comment">// Overridden in <a href="#L351" title="table/table_test.cc:351">DBConstructor</a><br/></li>
<li></span><br/></li>
<li><span class="cUserCont"> </span><span class="Statement">private</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; <a href="#L137" title="table/table_test.cc:137">KVMap</a> data_;<br/></li>
<li>};<br/></li>
<li><br/></li>
<li><span class="Type">class</span> <a href="#L183" title="table/table_test.cc:183">BlockConstructor</a>: <span class="Statement">public</span> <a href="#L143" title="table/table_test.cc:143">Constructor</a> {<br/></li>
<li><span class="cUserCont"> </span><span class="Statement">public</span><span class="cUserCont">:<br/></li>
<li><a id="L183">&#x200c;</a></span>&nbsp; <span class="Type">explicit</span> <span class="linkable">BlockConstructor</span>(<span class="Type">const</span> <a href="../db/skiplist_test.cc.html#L17" title="db/skiplist_test.cc:17">Comparator</a>* cmp)<br/></li>
<li>&nbsp; &nbsp; &nbsp; : <a href="#L143" title="table/table_test.cc:143">Constructor</a>(cmp),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; comparator_(cmp),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; block_(<span class="Constant">NULL</span>) { }<br/></li>
<li><a id="L187">&#x200c;</a>&nbsp; ~<a href="#L183" title="table/table_test.cc:183">BlockConstructor</a>() {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">delete</span> block_;<br/></li>
<li>&nbsp; }<br/></li>
<li><a id="L190">&#x200c;</a>&nbsp; <span class="Type">virtual</span> <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> <span class="linkable">FinishImpl</span>(<span class="Type">const</span> <a href="../include/leveldb/options.h.html#L31" title="include/leveldb/options.h:31">Options</a>&amp; options, <span class="Type">const</span> <a href="#L137" title="table/table_test.cc:137">KVMap</a>&amp; <a href="#L173" title="table/table_test.cc:173">data</a>) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">delete</span> block_;<br/></li>
<li>&nbsp; &nbsp; block_ = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; <a href="block_builder.cc.html#L39" title="table/block_builder.cc:39">BlockBuilder</a> builder(&amp;options);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (<a href="#L137" title="table/table_test.cc:137">KVMap</a>::const_iterator it = <a href="#L173" title="table/table_test.cc:173">data</a>.begin();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; it != <a href="#L173" title="table/table_test.cc:173">data</a>.end();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ++it) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; builder.<a href="#L146" title="table/table_test.cc:146">Add</a>(it-&gt;first, it-&gt;second);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// <a href="table.cc.html#L38" title="table/table.cc:38">Open</a> the block<br/></li>
<li></span>&nbsp; &nbsp; data_ = builder.<a href="#L153" title="table/table_test.cc:153">Finish</a>().<a href="#L587" title="table/table_test.cc:587">ToString</a>();<br/></li>
<li>&nbsp; &nbsp; <a href="format.h.html#L86" title="table/format.h:86">BlockContents</a> <a href="#L94" title="table/table_test.cc:94">contents</a>;<br/></li>
<li>&nbsp; &nbsp; <a href="#L94" title="table/table_test.cc:94">contents</a>.<a href="#L173" title="table/table_test.cc:173">data</a> = data_;<br/></li>
<li>&nbsp; &nbsp; <a href="#L94" title="table/table_test.cc:94">contents</a>.cachable = <span class="Constant">false</span>;<br/></li>
<li>&nbsp; &nbsp; <a href="#L94" title="table/table_test.cc:94">contents</a>.heap_allocated = <span class="Constant">false</span>;<br/></li>
<li>&nbsp; &nbsp; block_ = <span class="Statement">new</span> <a href="block.cc.html#L23" title="table/block.cc:23">Block</a>(<a href="#L94" title="table/table_test.cc:94">contents</a>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a>::<a href="../include/leveldb/status.h.html#L32" title="include/leveldb/status.h:32">OK</a>();<br/></li>
<li>&nbsp; }<br/></li>
<li><a id="L209">&#x200c;</a>&nbsp; <span class="Type">virtual</span> <a href="iterator.cc.html#L9" title="table/iterator.cc:9">Iterator</a>* <span class="linkable">NewIterator</span>() <span class="Type">const</span> {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> block_-&gt;<a href="#L209" title="table/table_test.cc:209">NewIterator</a>(comparator_);<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li><span class="cUserCont"> </span><span class="Statement">private</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; <span class="Type">const</span> <a href="../db/skiplist_test.cc.html#L17" title="db/skiplist_test.cc:17">Comparator</a>* comparator_;<br/></li>
<li>&nbsp; std::string data_;<br/></li>
<li>&nbsp; <a href="block.cc.html#L23" title="table/block.cc:23">Block</a>* block_;<br/></li>
<li><br/></li>
<li>&nbsp; <a href="#L183" title="table/table_test.cc:183">BlockConstructor</a>();<br/></li>
<li>};<br/></li>
<li><br/></li>
<li><span class="Type">class</span> <a href="#L223" title="table/table_test.cc:223">TableConstructor</a>: <span class="Statement">public</span> <a href="#L143" title="table/table_test.cc:143">Constructor</a> {<br/></li>
<li><span class="cUserCont"> </span><span class="Statement">public</span><span class="cUserCont">:<br/></li>
<li><a id="L223">&#x200c;</a></span>&nbsp; <span class="linkable">TableConstructor</span>(<span class="Type">const</span> <a href="../db/skiplist_test.cc.html#L17" title="db/skiplist_test.cc:17">Comparator</a>* cmp)<br/></li>
<li>&nbsp; &nbsp; &nbsp; : <a href="#L143" title="table/table_test.cc:143">Constructor</a>(cmp),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; source_(<span class="Constant">NULL</span>), table_(<span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; }<br/></li>
<li><a id="L227">&#x200c;</a>&nbsp; ~<a href="#L223" title="table/table_test.cc:223">TableConstructor</a>() {<br/></li>
<li>&nbsp; &nbsp; <a href="#L262" title="table/table_test.cc:262">Reset</a>();<br/></li>
<li>&nbsp; }<br/></li>
<li><a id="L230">&#x200c;</a>&nbsp; <span class="Type">virtual</span> <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> <span class="linkable">FinishImpl</span>(<span class="Type">const</span> <a href="../include/leveldb/options.h.html#L31" title="include/leveldb/options.h:31">Options</a>&amp; options, <span class="Type">const</span> <a href="#L137" title="table/table_test.cc:137">KVMap</a>&amp; <a href="#L173" title="table/table_test.cc:173">data</a>) {<br/></li>
<li>&nbsp; &nbsp; <a href="#L262" title="table/table_test.cc:262">Reset</a>();<br/></li>
<li>&nbsp; &nbsp; StringSink sink;<br/></li>
<li>&nbsp; &nbsp; <a href="table_builder.cc.html#L63" title="table/table_builder.cc:63">TableBuilder</a> builder(options, &amp;sink);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (<a href="#L137" title="table/table_test.cc:137">KVMap</a>::const_iterator it = <a href="#L173" title="table/table_test.cc:173">data</a>.begin();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; it != <a href="#L173" title="table/table_test.cc:173">data</a>.end();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ++it) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; builder.<a href="#L146" title="table/table_test.cc:146">Add</a>(it-&gt;first, it-&gt;second);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(builder.<a href="two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a>().<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>());<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> s = builder.<a href="#L153" title="table/table_test.cc:153">Finish</a>();<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(s.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>()) &lt;&lt; s.<a href="#L587" title="table/table_test.cc:587">ToString</a>();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(sink.<a href="#L94" title="table/table_test.cc:94">contents</a>().<a href="format.h.html#L31" title="table/format.h:31">size</a>(), builder.<a href="table_builder.cc.html#L266" title="table/table_builder.cc:266">FileSize</a>());<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// <a href="table.cc.html#L38" title="table/table.cc:38">Open</a> the table<br/></li>
<li></span>&nbsp; &nbsp; source_ = <span class="Statement">new</span> <a href="#L112" title="table/table_test.cc:112">StringSource</a>(sink.<a href="#L94" title="table/table_test.cc:94">contents</a>());<br/></li>
<li>&nbsp; &nbsp; <a href="../include/leveldb/options.h.html#L31" title="include/leveldb/options.h:31">Options</a> table_options;<br/></li>
<li>&nbsp; &nbsp; table_options.comparator = options.comparator;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../include/leveldb/table.h.html#L62" title="include/leveldb/table.h:62">Table</a>::<a href="table.cc.html#L38" title="table/table.cc:38">Open</a>(table_options, source_, sink.<a href="#L94" title="table/table_test.cc:94">contents</a>().<a href="format.h.html#L31" title="table/format.h:31">size</a>(), &amp;table_);<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li><a id="L253">&#x200c;</a>&nbsp; <span class="Type">virtual</span> <a href="iterator.cc.html#L9" title="table/iterator.cc:9">Iterator</a>* <span class="linkable">NewIterator</span>() <span class="Type">const</span> {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> table_-&gt;<a href="#L209" title="table/table_test.cc:209">NewIterator</a>(<a href="../include/leveldb/options.h.html#L143" title="include/leveldb/options.h:143">ReadOptions</a>());<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li><a id="L257">&#x200c;</a>&nbsp; <span class="Type"><a href="../port/win/stdint.h.html#L22" title="port/win/stdint.h:22">uint64_t</a></span> <span class="linkable">ApproximateOffsetOf</span>(<span class="Type">const</span> <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>&amp; <a href="two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>) <span class="Type">const</span> {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> table_-&gt;<a href="#L257" title="table/table_test.cc:257">ApproximateOffsetOf</a>(<a href="two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>);<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li><span class="cUserCont"> </span><span class="Statement">private</span><span class="cUserCont">:<br/></li>
<li><a id="L262">&#x200c;</a></span>&nbsp; <span class="Type">void</span> <span class="linkable">Reset</span>() {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">delete</span> table_;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">delete</span> source_;<br/></li>
<li>&nbsp; &nbsp; table_ = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; source_ = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <a href="#L112" title="table/table_test.cc:112">StringSource</a>* source_;<br/></li>
<li>&nbsp; <a href="../include/leveldb/table.h.html#L62" title="include/leveldb/table.h:62">Table</a>* table_;<br/></li>
<li><br/></li>
<li>&nbsp; <a href="#L223" title="table/table_test.cc:223">TableConstructor</a>();<br/></li>
<li>};<br/></li>
<li><br/></li>
<li><span class="Comment">// A helper class that converts internal format keys into user keys<br/></li>
<li></span><span class="Type">class</span> <a href="#L278" title="table/table_test.cc:278">KeyConvertingIterator</a>: <span class="Statement">public</span> <a href="iterator.cc.html#L9" title="table/iterator.cc:9">Iterator</a> {<br/></li>
<li><span class="cUserCont"> </span><span class="Statement">public</span><span class="cUserCont">:<br/></li>
<li><a id="L278">&#x200c;</a></span>&nbsp; <span class="Type">explicit</span> <span class="linkable">KeyConvertingIterator</span>(<a href="iterator.cc.html#L9" title="table/iterator.cc:9">Iterator</a>* <a href="iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>) : iter_(<a href="iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>) { }<br/></li>
<li><a id="L279">&#x200c;</a>&nbsp; <span class="Type">virtual</span> ~<a href="#L278" title="table/table_test.cc:278">KeyConvertingIterator</a>() { <span class="Statement">delete</span> iter_; }<br/></li>
<li><a id="L280">&#x200c;</a>&nbsp; <span class="Type">virtual</span> <span class="Type">bool</span> <span class="linkable">Valid</span>() <span class="Type">const</span> { <span class="Statement">return</span> iter_-&gt;<span class="linkable">Valid</span>(); }<br/></li>
<li><a id="L281">&#x200c;</a>&nbsp; <span class="Type">virtual</span> <span class="Type">void</span> <span class="linkable">Seek</span>(<span class="Type">const</span> <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>&amp; <a href="../include/leveldb/env.h.html#L280" title="include/leveldb/env.h:280">target</a>) {<br/></li>
<li>&nbsp; &nbsp; <a href="../db/dbformat.h.html#L70" title="db/dbformat.h:70">ParsedInternalKey</a> ikey(<a href="../include/leveldb/env.h.html#L280" title="include/leveldb/env.h:280">target</a>, kMaxSequenceNumber, kTypeValue);<br/></li>
<li>&nbsp; &nbsp; std::string encoded;<br/></li>
<li>&nbsp; &nbsp; <a href="../db/dbformat.cc.html#L18" title="db/dbformat.cc:18">AppendInternalKey</a>(&amp;encoded, ikey);<br/></li>
<li>&nbsp; &nbsp; iter_-&gt;<a href="two_level_iterator.cc.html#L91" title="table/two_level_iterator.cc:91">Seek</a>(encoded);<br/></li>
<li>&nbsp; }<br/></li>
<li><a id="L287">&#x200c;</a>&nbsp; <span class="Type">virtual</span> <span class="Type">void</span> <span class="linkable">SeekToFirst</span>() { iter_-&gt;<span class="linkable">SeekToFirst</span>(); }<br/></li>
<li><a id="L288">&#x200c;</a>&nbsp; <span class="Type">virtual</span> <span class="Type">void</span> <span class="linkable">SeekToLast</span>() { iter_-&gt;<span class="linkable">SeekToLast</span>(); }<br/></li>
<li><a id="L289">&#x200c;</a>&nbsp; <span class="Type">virtual</span> <span class="Type">void</span> <span class="linkable">Next</span>() { iter_-&gt;<span class="linkable">Next</span>(); }<br/></li>
<li><a id="L290">&#x200c;</a>&nbsp; <span class="Type">virtual</span> <span class="Type">void</span> <span class="linkable">Prev</span>() { iter_-&gt;<span class="linkable">Prev</span>(); }<br/></li>
<li><br/></li>
<li><a id="L292">&#x200c;</a>&nbsp; <span class="Type">virtual</span> <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a> <span class="linkable">key</span>() <span class="Type">const</span> {<br/></li>
<li>&nbsp; &nbsp; assert(<a href="two_level_iterator.cc.html#L34" title="table/two_level_iterator.cc:34">Valid</a>());<br/></li>
<li>&nbsp; &nbsp; <a href="../db/dbformat.h.html#L70" title="db/dbformat.h:70">ParsedInternalKey</a> <a href="two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!<a href="../db/dbformat.h.html#L176" title="db/dbformat.h:176">ParseInternalKey</a>(iter_-&gt;<a href="two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>(), &amp;<a href="two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; status_ = <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a>::<a href="../include/leveldb/status.h.html#L38" title="include/leveldb/status.h:38">Corruption</a>(<span class="Constant">&quot;malformed internal <a href="two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>(<span class="Constant">&quot;corrupted <a href="two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>.<a href="../db/dbformat.h.html#L159" title="db/dbformat.h:159">user_key</a>;<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li><a id="L302">&#x200c;</a>&nbsp; <span class="Type">virtual</span> <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a> <span class="linkable">value</span>() <span class="Type">const</span> { <span class="Statement">return</span> iter_-&gt;<span class="linkable">value</span>(); }<br/></li>
<li><a id="L303">&#x200c;</a>&nbsp; <span class="Type">virtual</span> <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> <span class="linkable">status</span>() <span class="Type">const</span> {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> status_.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>() ? iter_-&gt;<a href="two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a>() : status_;<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li><span class="cUserCont"> </span><span class="Statement">private</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; <span class="Type">mutable</span> <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> status_;<br/></li>
<li>&nbsp; <a href="iterator.cc.html#L9" title="table/iterator.cc:9">Iterator</a>* iter_;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// No copying allowed<br/></li>
<li></span>&nbsp; <a href="#L278" title="table/table_test.cc:278">KeyConvertingIterator</a>(<span class="Type">const</span> <a href="#L278" title="table/table_test.cc:278">KeyConvertingIterator</a>&amp;);<br/></li>
<li>&nbsp; <span class="Type">void</span> <span class="Statement">operator</span>=(<span class="Type">const</span> <a href="#L278" title="table/table_test.cc:278">KeyConvertingIterator</a>&amp;);<br/></li>
<li>};<br/></li>
<li><br/></li>
<li><span class="Type">class</span> <a href="#L318" title="table/table_test.cc:318">MemTableConstructor</a>: <span class="Statement">public</span> <a href="#L143" title="table/table_test.cc:143">Constructor</a> {<br/></li>
<li><span class="cUserCont"> </span><span class="Statement">public</span><span class="cUserCont">:<br/></li>
<li><a id="L318">&#x200c;</a></span>&nbsp; <span class="Type">explicit</span> <span class="linkable">MemTableConstructor</span>(<span class="Type">const</span> <a href="../db/skiplist_test.cc.html#L17" title="db/skiplist_test.cc:17">Comparator</a>* cmp)<br/></li>
<li>&nbsp; &nbsp; &nbsp; : <a href="#L143" title="table/table_test.cc:143">Constructor</a>(cmp),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; internal_comparator_(cmp) {<br/></li>
<li>&nbsp; &nbsp; memtable_ = <span class="Statement">new</span> <a href="../db/memtable.cc.html#L21" title="db/memtable.cc:21">MemTable</a>(internal_comparator_);<br/></li>
<li>&nbsp; &nbsp; memtable_-&gt;<a href="../db/version_set.cc.html#L473" title="db/version_set.cc:473">Ref</a>();<br/></li>
<li>&nbsp; }<br/></li>
<li><a id="L324">&#x200c;</a>&nbsp; ~<a href="#L318" title="table/table_test.cc:318">MemTableConstructor</a>() {<br/></li>
<li>&nbsp; &nbsp; memtable_-&gt;<a href="../db/version_set.cc.html#L477" title="db/version_set.cc:477">Unref</a>();<br/></li>
<li>&nbsp; }<br/></li>
<li><a id="L327">&#x200c;</a>&nbsp; <span class="Type">virtual</span> <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> <span class="linkable">FinishImpl</span>(<span class="Type">const</span> <a href="../include/leveldb/options.h.html#L31" title="include/leveldb/options.h:31">Options</a>&amp; options, <span class="Type">const</span> <a href="#L137" title="table/table_test.cc:137">KVMap</a>&amp; <a href="#L173" title="table/table_test.cc:173">data</a>) {<br/></li>
<li>&nbsp; &nbsp; memtable_-&gt;<a href="../db/version_set.cc.html#L477" title="db/version_set.cc:477">Unref</a>();<br/></li>
<li>&nbsp; &nbsp; memtable_ = <span class="Statement">new</span> <a href="../db/memtable.cc.html#L21" title="db/memtable.cc:21">MemTable</a>(internal_comparator_);<br/></li>
<li>&nbsp; &nbsp; memtable_-&gt;<a href="../db/version_set.cc.html#L473" title="db/version_set.cc:473">Ref</a>();<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span> seq = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (<a href="#L137" title="table/table_test.cc:137">KVMap</a>::const_iterator it = <a href="#L173" title="table/table_test.cc:173">data</a>.begin();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; it != <a href="#L173" title="table/table_test.cc:173">data</a>.end();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ++it) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; memtable_-&gt;<a href="#L146" title="table/table_test.cc:146">Add</a>(seq, kTypeValue, it-&gt;first, it-&gt;second);<br/></li>
<li>&nbsp; &nbsp; &nbsp; seq++;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a>::<a href="../include/leveldb/status.h.html#L32" title="include/leveldb/status.h:32">OK</a>();<br/></li>
<li>&nbsp; }<br/></li>
<li><a id="L340">&#x200c;</a>&nbsp; <span class="Type">virtual</span> <a href="iterator.cc.html#L9" title="table/iterator.cc:9">Iterator</a>* <span class="linkable">NewIterator</span>() <span class="Type">const</span> {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Statement">new</span> <a href="#L278" title="table/table_test.cc:278">KeyConvertingIterator</a>(memtable_-&gt;<a href="#L209" title="table/table_test.cc:209">NewIterator</a>());<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li><span class="cUserCont"> </span><span class="Statement">private</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; <a href="../db/dbformat.h.html#L117" title="db/dbformat.h:117">InternalKeyComparator</a> internal_comparator_;<br/></li>
<li>&nbsp; <a href="../db/memtable.cc.html#L21" title="db/memtable.cc:21">MemTable</a>* memtable_;<br/></li>
<li>};<br/></li>
<li><br/></li>
<li><span class="Type">class</span> <a href="#L351" title="table/table_test.cc:351">DBConstructor</a>: <span class="Statement">public</span> <a href="#L143" title="table/table_test.cc:143">Constructor</a> {<br/></li>
<li><span class="cUserCont"> </span><span class="Statement">public</span><span class="cUserCont">:<br/></li>
<li><a id="L351">&#x200c;</a></span>&nbsp; <span class="Type">explicit</span> <span class="linkable">DBConstructor</span>(<span class="Type">const</span> <a href="../db/skiplist_test.cc.html#L17" title="db/skiplist_test.cc:17">Comparator</a>* cmp)<br/></li>
<li>&nbsp; &nbsp; &nbsp; : <a href="#L143" title="table/table_test.cc:143">Constructor</a>(cmp),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; comparator_(cmp) {<br/></li>
<li>&nbsp; &nbsp; db_ = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; <a href="#L380" title="table/table_test.cc:380">NewDB</a>();<br/></li>
<li>&nbsp; }<br/></li>
<li><a id="L357">&#x200c;</a>&nbsp; ~<a href="#L351" title="table/table_test.cc:351">DBConstructor</a>() {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">delete</span> db_;<br/></li>
<li>&nbsp; }<br/></li>
<li><a id="L360">&#x200c;</a>&nbsp; <span class="Type">virtual</span> <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> <span class="linkable">FinishImpl</span>(<span class="Type">const</span> <a href="../include/leveldb/options.h.html#L31" title="include/leveldb/options.h:31">Options</a>&amp; options, <span class="Type">const</span> <a href="#L137" title="table/table_test.cc:137">KVMap</a>&amp; <a href="#L173" title="table/table_test.cc:173">data</a>) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">delete</span> db_;<br/></li>
<li>&nbsp; &nbsp; db_ = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; <a href="#L380" title="table/table_test.cc:380">NewDB</a>();<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (<a href="#L137" title="table/table_test.cc:137">KVMap</a>::const_iterator it = <a href="#L173" title="table/table_test.cc:173">data</a>.begin();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; it != <a href="#L173" title="table/table_test.cc:173">data</a>.end();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ++it) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../db/write_batch.cc.html#L29" title="db/write_batch.cc:29">WriteBatch</a> batch;<br/></li>
<li>&nbsp; &nbsp; &nbsp; batch.<a href="../db/write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(it-&gt;first, it-&gt;second);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(db_-&gt;<a href="../db/log_test.cc.html#L121" title="db/log_test.cc:121">Write</a>(<a href="../include/leveldb/options.h.html#L169" title="include/leveldb/options.h:169">WriteOptions</a>(), &amp;batch).<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>());<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a>::<a href="../include/leveldb/status.h.html#L32" title="include/leveldb/status.h:32">OK</a>();<br/></li>
<li>&nbsp; }<br/></li>
<li><a id="L373">&#x200c;</a>&nbsp; <span class="Type">virtual</span> <a href="iterator.cc.html#L9" title="table/iterator.cc:9">Iterator</a>* <span class="linkable">NewIterator</span>() <span class="Type">const</span> {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> db_-&gt;<a href="#L209" title="table/table_test.cc:209">NewIterator</a>(<a href="../include/leveldb/options.h.html#L143" title="include/leveldb/options.h:143">ReadOptions</a>());<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li><a id="L377">&#x200c;</a>&nbsp; <span class="Type">virtual</span> <a href="../include/leveldb/db.h.html#L55" title="include/leveldb/db.h:55">DB</a>* <span class="linkable">db</span>() <span class="Type">const</span> { <span class="Statement">return</span> db_; }<br/></li>
<li><br/></li>
<li><span class="cUserCont"> </span><span class="Statement">private</span><span class="cUserCont">:<br/></li>
<li><a id="L380">&#x200c;</a></span>&nbsp; <span class="Type">void</span> <span class="linkable">NewDB</span>() {<br/></li>
<li>&nbsp; &nbsp; std::string name = test::<a href="../util/testharness.cc.html#L60" title="util/testharness.cc:60">TmpDir</a>() + <span class="Constant">&quot;/table_testdb&quot;</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../include/leveldb/options.h.html#L31" title="include/leveldb/options.h:31">Options</a> options;<br/></li>
<li>&nbsp; &nbsp; options.comparator = comparator_;<br/></li>
<li>&nbsp; &nbsp; <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> <a href="two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a> = <a href="../db/db_impl.cc.html#L1482" title="db/db_impl.cc:1482">DestroyDB</a>(name, options);<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(<a href="two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a>.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>()) &lt;&lt; <a href="two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a>.<a href="#L587" title="table/table_test.cc:587">ToString</a>();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; options.create_if_missing = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; options.error_if_exists = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; options.write_buffer_size = <span class="Constant">10000</span>;&nbsp; <span class="Comment">// Something small to force merging<br/></li>
<li></span>&nbsp; &nbsp; <a href="two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a> = <a href="../include/leveldb/db.h.html#L55" title="include/leveldb/db.h:55">DB</a>::<a href="table.cc.html#L38" title="table/table.cc:38">Open</a>(options, name, &amp;db_);<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(<a href="two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a>.<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>()) &lt;&lt; <a href="two_level_iterator.cc.html#L45" title="table/two_level_iterator.cc:45">status</a>.<a href="#L587" title="table/table_test.cc:587">ToString</a>();<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Type">const</span> <a href="../db/skiplist_test.cc.html#L17" title="db/skiplist_test.cc:17">Comparator</a>* comparator_;<br/></li>
<li>&nbsp; <a href="../include/leveldb/db.h.html#L55" title="include/leveldb/db.h:55">DB</a>* db_;<br/></li>
<li>};<br/></li>
<li><br/></li>
<li><a id="L399">&#x200c;</a><span class="Type">enum</span> <span class="linkable">TestType</span> {<br/></li>
<li>&nbsp; TABLE_TEST,<br/></li>
<li>&nbsp; BLOCK_TEST,<br/></li>
<li>&nbsp; MEMTABLE_TEST,<br/></li>
<li>&nbsp; DB_TEST<br/></li>
<li>};<br/></li>
<li><br/></li>
<li><a id="L406">&#x200c;</a><span class="Type">struct</span> <span class="linkable">TestArgs</span> {<br/></li>
<li>&nbsp; <a href="#L399" title="table/table_test.cc:399">TestType</a> type;<br/></li>
<li>&nbsp; <span class="Type">bool</span> reverse_compare;<br/></li>
<li>&nbsp; <span class="Type">int</span> restart_interval;<br/></li>
<li>};<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">const</span> <a href="#L406" title="table/table_test.cc:406">TestArgs</a> kTestArgList[] = {<br/></li>
<li>&nbsp; { TABLE_TEST, <span class="Constant">false</span>, <span class="Constant">16</span> },<br/></li>
<li>&nbsp; { TABLE_TEST, <span class="Constant">false</span>, <span class="Constant">1</span> },<br/></li>
<li>&nbsp; { TABLE_TEST, <span class="Constant">false</span>, <span class="Constant">1024</span> },<br/></li>
<li>&nbsp; { TABLE_TEST, <span class="Constant">true</span>, <span class="Constant">16</span> },<br/></li>
<li>&nbsp; { TABLE_TEST, <span class="Constant">true</span>, <span class="Constant">1</span> },<br/></li>
<li>&nbsp; { TABLE_TEST, <span class="Constant">true</span>, <span class="Constant">1024</span> },<br/></li>
<li><br/></li>
<li>&nbsp; { BLOCK_TEST, <span class="Constant">false</span>, <span class="Constant">16</span> },<br/></li>
<li>&nbsp; { BLOCK_TEST, <span class="Constant">false</span>, <span class="Constant">1</span> },<br/></li>
<li>&nbsp; { BLOCK_TEST, <span class="Constant">false</span>, <span class="Constant">1024</span> },<br/></li>
<li>&nbsp; { BLOCK_TEST, <span class="Constant">true</span>, <span class="Constant">16</span> },<br/></li>
<li>&nbsp; { BLOCK_TEST, <span class="Constant">true</span>, <span class="Constant">1</span> },<br/></li>
<li>&nbsp; { BLOCK_TEST, <span class="Constant">true</span>, <span class="Constant">1024</span> },<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// Restart interval does not matter for memtables<br/></li>
<li></span>&nbsp; { MEMTABLE_TEST, <span class="Constant">false</span>, <span class="Constant">16</span> },<br/></li>
<li>&nbsp; { MEMTABLE_TEST, <span class="Constant">true</span>, <span class="Constant">16</span> },<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// Do not bother with restart interval variations for <a href="../include/leveldb/db.h.html#L55" title="include/leveldb/db.h:55">DB</a><br/></li>
<li></span>&nbsp; { DB_TEST, <span class="Constant">false</span>, <span class="Constant">16</span> },<br/></li>
<li>&nbsp; { DB_TEST, <span class="Constant">true</span>, <span class="Constant">16</span> },<br/></li>
<li>};<br/></li>
<li><span class="Type">static</span> <span class="Type">const</span> <span class="Type">int</span> kNumTestArgs = <span class="Statement">sizeof</span>(kTestArgList) / <span class="Statement">sizeof</span>(kTestArgList[<span class="Constant">0</span>]);<br/></li>
<li><br/></li>
<li><span class="Type">class</span> <a href="#L439" title="table/table_test.cc:439">Harness</a> {<br/></li>
<li><span class="cUserCont"> </span><span class="Statement">public</span><span class="cUserCont">:<br/></li>
<li><a id="L439">&#x200c;</a></span>&nbsp; <span class="linkable">Harness</span>() : constructor_(<span class="Constant">NULL</span>) { }<br/></li>
<li><br/></li>
<li><a id="L441">&#x200c;</a>&nbsp; <span class="Type">void</span> <span class="linkable">Init</span>(<span class="Type">const</span> <a href="#L406" title="table/table_test.cc:406">TestArgs</a>&amp; args) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">delete</span> constructor_;<br/></li>
<li>&nbsp; &nbsp; constructor_ = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; options_ = <a href="../include/leveldb/options.h.html#L31" title="include/leveldb/options.h:31">Options</a>();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; options_.block_restart_interval = args.restart_interval;<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// Use shorter block <a href="format.h.html#L31" title="table/format.h:31">size</a> for tests to exercise block boundary<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">// conditions more.<br/></li>
<li></span>&nbsp; &nbsp; options_.block_size = <span class="Constant">256</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (args.reverse_compare) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; options_.comparator = &amp;reverse_key_comparator;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">switch</span> (args.type) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> TABLE_TEST:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; constructor_ = <span class="Statement">new</span> <a href="#L223" title="table/table_test.cc:223">TableConstructor</a>(options_.comparator);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> BLOCK_TEST:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; constructor_ = <span class="Statement">new</span> <a href="#L183" title="table/table_test.cc:183">BlockConstructor</a>(options_.comparator);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> MEMTABLE_TEST:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; constructor_ = <span class="Statement">new</span> <a href="#L318" title="table/table_test.cc:318">MemTableConstructor</a>(options_.comparator);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> DB_TEST:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; constructor_ = <span class="Statement">new</span> <a href="#L351" title="table/table_test.cc:351">DBConstructor</a>(options_.comparator);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li><a id="L469">&#x200c;</a>&nbsp; ~<a href="#L439" title="table/table_test.cc:439">Harness</a>() {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">delete</span> constructor_;<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li><a id="L473">&#x200c;</a>&nbsp; <span class="Type">void</span> <span class="linkable">Add</span>(<span class="Type">const</span> std::string&amp; <a href="two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>, <span class="Type">const</span> std::string&amp; <a href="two_level_iterator.cc.html#L41" title="table/two_level_iterator.cc:41">value</a>) {<br/></li>
<li>&nbsp; &nbsp; constructor_-&gt;<a href="#L146" title="table/table_test.cc:146">Add</a>(<a href="two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>, <a href="two_level_iterator.cc.html#L41" title="table/two_level_iterator.cc:41">value</a>);<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li><a id="L477">&#x200c;</a>&nbsp; <span class="Type">void</span> <span class="linkable">Test</span>(<a href="../util/random.h.html#L19" title="util/random.h:19">Random</a>* rnd) {<br/></li>
<li>&nbsp; &nbsp; std::vector&lt;std::string&gt; keys;<br/></li>
<li>&nbsp; &nbsp; <a href="#L137" title="table/table_test.cc:137">KVMap</a> <a href="#L173" title="table/table_test.cc:173">data</a>;<br/></li>
<li>&nbsp; &nbsp; constructor_-&gt;<a href="#L153" title="table/table_test.cc:153">Finish</a>(options_, &amp;keys, &amp;<a href="#L173" title="table/table_test.cc:173">data</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L487" title="table/table_test.cc:487">TestForwardScan</a>(keys, <a href="#L173" title="table/table_test.cc:173">data</a>);<br/></li>
<li>&nbsp; &nbsp; <a href="#L502" title="table/table_test.cc:502">TestBackwardScan</a>(keys, <a href="#L173" title="table/table_test.cc:173">data</a>);<br/></li>
<li>&nbsp; &nbsp; <a href="#L517" title="table/table_test.cc:517">TestRandomAccess</a>(rnd, keys, <a href="#L173" title="table/table_test.cc:173">data</a>);<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li><a id="L487">&#x200c;</a>&nbsp; <span class="Type">void</span> <span class="linkable">TestForwardScan</span>(<span class="Type">const</span> std::vector&lt;std::string&gt;&amp; keys,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type">const</span> <a href="#L137" title="table/table_test.cc:137">KVMap</a>&amp; <a href="#L173" title="table/table_test.cc:173">data</a>) {<br/></li>
<li>&nbsp; &nbsp; <a href="iterator.cc.html#L9" title="table/iterator.cc:9">Iterator</a>* <a href="iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a> = constructor_-&gt;<a href="#L209" title="table/table_test.cc:209">NewIterator</a>();<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(!<a href="iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="two_level_iterator.cc.html#L34" title="table/two_level_iterator.cc:34">Valid</a>());<br/></li>
<li>&nbsp; &nbsp; <a href="iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="two_level_iterator.cc.html#L98" title="table/two_level_iterator.cc:98">SeekToFirst</a>();<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (<a href="#L137" title="table/table_test.cc:137">KVMap</a>::const_iterator model_iter = <a href="#L173" title="table/table_test.cc:173">data</a>.begin();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; model_iter != <a href="#L173" title="table/table_test.cc:173">data</a>.end();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ++model_iter) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L587" title="table/table_test.cc:587">ToString</a>(<a href="#L173" title="table/table_test.cc:173">data</a>, model_iter), <a href="#L587" title="table/table_test.cc:587">ToString</a>(<a href="iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="two_level_iterator.cc.html#L112" title="table/two_level_iterator.cc:112">Next</a>();<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(!<a href="iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="two_level_iterator.cc.html#L34" title="table/two_level_iterator.cc:34">Valid</a>());<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">delete</span> <a href="iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>;<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li><a id="L502">&#x200c;</a>&nbsp; <span class="Type">void</span> <span class="linkable">TestBackwardScan</span>(<span class="Type">const</span> std::vector&lt;std::string&gt;&amp; keys,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">const</span> <a href="#L137" title="table/table_test.cc:137">KVMap</a>&amp; <a href="#L173" title="table/table_test.cc:173">data</a>) {<br/></li>
<li>&nbsp; &nbsp; <a href="iterator.cc.html#L9" title="table/iterator.cc:9">Iterator</a>* <a href="iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a> = constructor_-&gt;<a href="#L209" title="table/table_test.cc:209">NewIterator</a>();<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(!<a href="iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="two_level_iterator.cc.html#L34" title="table/two_level_iterator.cc:34">Valid</a>());<br/></li>
<li>&nbsp; &nbsp; <a href="iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="two_level_iterator.cc.html#L105" title="table/two_level_iterator.cc:105">SeekToLast</a>();<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (<a href="#L137" title="table/table_test.cc:137">KVMap</a>::const_reverse_iterator model_iter = <a href="#L173" title="table/table_test.cc:173">data</a>.rbegin();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; model_iter != <a href="#L173" title="table/table_test.cc:173">data</a>.rend();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ++model_iter) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L587" title="table/table_test.cc:587">ToString</a>(<a href="#L173" title="table/table_test.cc:173">data</a>, model_iter), <a href="#L587" title="table/table_test.cc:587">ToString</a>(<a href="iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="two_level_iterator.cc.html#L118" title="table/two_level_iterator.cc:118">Prev</a>();<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(!<a href="iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="two_level_iterator.cc.html#L34" title="table/two_level_iterator.cc:34">Valid</a>());<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">delete</span> <a href="iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>;<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li><a id="L517">&#x200c;</a>&nbsp; <span class="Type">void</span> <span class="linkable">TestRandomAccess</span>(<a href="../util/random.h.html#L19" title="util/random.h:19">Random</a>* rnd,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">const</span> std::vector&lt;std::string&gt;&amp; keys,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">const</span> <a href="#L137" title="table/table_test.cc:137">KVMap</a>&amp; <a href="#L173" title="table/table_test.cc:173">data</a>) {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">static</span> <span class="Type">const</span> <span class="Type">bool</span> kVerbose = <span class="Constant">false</span>;<br/></li>
<li>&nbsp; &nbsp; <a href="iterator.cc.html#L9" title="table/iterator.cc:9">Iterator</a>* <a href="iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a> = constructor_-&gt;<a href="#L209" title="table/table_test.cc:209">NewIterator</a>();<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(!<a href="iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="two_level_iterator.cc.html#L34" title="table/two_level_iterator.cc:34">Valid</a>());<br/></li>
<li>&nbsp; &nbsp; <a href="#L137" title="table/table_test.cc:137">KVMap</a>::const_iterator model_iter = <a href="#L173" title="table/table_test.cc:173">data</a>.begin();<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (kVerbose) fprintf(<span class="Constant">stderr</span>, <span class="Constant">&quot;---</span><span class="Special">\n</span><span class="Constant">&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (<span class="Type">int</span> i = <span class="Constant">0</span>; i &lt; <span class="Constant">200</span>; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Type">const</span> <span class="Type">int</span> toss = rnd-&gt;<a href="../util/random.h.html#L48" title="util/random.h:48">Uniform</a>(<span class="Constant">5</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (toss) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">0</span>: {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="two_level_iterator.cc.html#L34" title="table/two_level_iterator.cc:34">Valid</a>()) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (kVerbose) fprintf(<span class="Constant">stderr</span>, <span class="Constant">&quot;<a href="two_level_iterator.cc.html#L112" title="table/two_level_iterator.cc:112">Next</a></span><span class="Special">\n</span><span class="Constant">&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="two_level_iterator.cc.html#L112" title="table/two_level_iterator.cc:112">Next</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ++model_iter;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L587" title="table/table_test.cc:587">ToString</a>(<a href="#L173" title="table/table_test.cc:173">data</a>, model_iter), <a href="#L587" title="table/table_test.cc:587">ToString</a>(<a href="iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">1</span>: {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (kVerbose) fprintf(<span class="Constant">stderr</span>, <span class="Constant">&quot;<a href="two_level_iterator.cc.html#L98" title="table/two_level_iterator.cc:98">SeekToFirst</a></span><span class="Special">\n</span><span class="Constant">&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="two_level_iterator.cc.html#L98" title="table/two_level_iterator.cc:98">SeekToFirst</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; model_iter = <a href="#L173" title="table/table_test.cc:173">data</a>.begin();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L587" title="table/table_test.cc:587">ToString</a>(<a href="#L173" title="table/table_test.cc:173">data</a>, model_iter), <a href="#L587" title="table/table_test.cc:587">ToString</a>(<a href="iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">2</span>: {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; std::string <a href="two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a> = <a href="#L612" title="table/table_test.cc:612">PickRandomKey</a>(rnd, keys);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; model_iter = <a href="#L173" title="table/table_test.cc:173">data</a>.lower_bound(<a href="two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (kVerbose) fprintf(<span class="Constant">stderr</span>, <span class="Constant">&quot;<a href="two_level_iterator.cc.html#L91" title="table/two_level_iterator.cc:91">Seek</a> '</span><span class="Special">%s</span><span class="Constant">'</span><span class="Special">\n</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../util/logging.cc.html#L42" title="util/logging.cc:42">EscapeString</a>(<a href="two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>).c_str());<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="two_level_iterator.cc.html#L91" title="table/two_level_iterator.cc:91">Seek</a>(<a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>(<a href="two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L587" title="table/table_test.cc:587">ToString</a>(<a href="#L173" title="table/table_test.cc:173">data</a>, model_iter), <a href="#L587" title="table/table_test.cc:587">ToString</a>(<a href="iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">3</span>: {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="two_level_iterator.cc.html#L34" title="table/two_level_iterator.cc:34">Valid</a>()) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (kVerbose) fprintf(<span class="Constant">stderr</span>, <span class="Constant">&quot;<a href="two_level_iterator.cc.html#L118" title="table/two_level_iterator.cc:118">Prev</a></span><span class="Special">\n</span><span class="Constant">&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="two_level_iterator.cc.html#L118" title="table/two_level_iterator.cc:118">Prev</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (model_iter == <a href="#L173" title="table/table_test.cc:173">data</a>.begin()) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; model_iter = <a href="#L173" title="table/table_test.cc:173">data</a>.end();&nbsp;&nbsp; <span class="Comment">// Wrap around to invalid <a href="two_level_iterator.cc.html#L41" title="table/two_level_iterator.cc:41">value</a><br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; --model_iter;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L587" title="table/table_test.cc:587">ToString</a>(<a href="#L173" title="table/table_test.cc:173">data</a>, model_iter), <a href="#L587" title="table/table_test.cc:587">ToString</a>(<a href="iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">4</span>: {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (kVerbose) fprintf(<span class="Constant">stderr</span>, <span class="Constant">&quot;<a href="two_level_iterator.cc.html#L105" title="table/two_level_iterator.cc:105">SeekToLast</a></span><span class="Special">\n</span><span class="Constant">&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="two_level_iterator.cc.html#L105" title="table/two_level_iterator.cc:105">SeekToLast</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (keys.<a href="block_builder.h.html#L38" title="table/block_builder.h:38">empty</a>()) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; model_iter = <a href="#L173" title="table/table_test.cc:173">data</a>.end();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; std::string last = <a href="#L173" title="table/table_test.cc:173">data</a>.rbegin()-&gt;first;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; model_iter = <a href="#L173" title="table/table_test.cc:173">data</a>.lower_bound(last);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../util/testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<a href="#L587" title="table/table_test.cc:587">ToString</a>(<a href="#L173" title="table/table_test.cc:173">data</a>, model_iter), <a href="#L587" title="table/table_test.cc:587">ToString</a>(<a href="iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">delete</span> <a href="iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>;<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li><a id="L587">&#x200c;</a>&nbsp; std::string <span class="linkable">ToString</span>(<span class="Type">const</span> <a href="#L137" title="table/table_test.cc:137">KVMap</a>&amp; <a href="#L173" title="table/table_test.cc:173">data</a>, <span class="Type">const</span> <a href="#L137" title="table/table_test.cc:137">KVMap</a>::const_iterator&amp; it) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (it == <a href="#L173" title="table/table_test.cc:173">data</a>.end()) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">&quot;END&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">&quot;'&quot;</span> + it-&gt;first + <span class="Constant">&quot;-&gt;&quot;</span> + it-&gt;second + <span class="Constant">&quot;'&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li><a id="L595">&#x200c;</a>&nbsp; std::string <span class="linkable">ToString</span>(<span class="Type">const</span> <a href="#L137" title="table/table_test.cc:137">KVMap</a>&amp; <a href="#L173" title="table/table_test.cc:173">data</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type">const</span> <a href="#L137" title="table/table_test.cc:137">KVMap</a>::const_reverse_iterator&amp; it) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (it == <a href="#L173" title="table/table_test.cc:173">data</a>.rend()) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">&quot;END&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">&quot;'&quot;</span> + it-&gt;first + <span class="Constant">&quot;-&gt;&quot;</span> + it-&gt;second + <span class="Constant">&quot;'&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li><a id="L604">&#x200c;</a>&nbsp; std::string <span class="linkable">ToString</span>(<span class="Type">const</span> <a href="iterator.cc.html#L9" title="table/iterator.cc:9">Iterator</a>* it) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!it-&gt;<a href="two_level_iterator.cc.html#L34" title="table/two_level_iterator.cc:34">Valid</a>()) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">&quot;END&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">&quot;'&quot;</span> + it-&gt;<a href="two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>().<a href="#L587" title="table/table_test.cc:587">ToString</a>() + <span class="Constant">&quot;-&gt;&quot;</span> + it-&gt;<a href="two_level_iterator.cc.html#L41" title="table/two_level_iterator.cc:41">value</a>().<a href="#L587" title="table/table_test.cc:587">ToString</a>() + <span class="Constant">&quot;'&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li><a id="L612">&#x200c;</a>&nbsp; std::string <span class="linkable">PickRandomKey</span>(<a href="../util/random.h.html#L19" title="util/random.h:19">Random</a>* rnd, <span class="Type">const</span> std::vector&lt;std::string&gt;&amp; keys) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (keys.<a href="block_builder.h.html#L38" title="table/block_builder.h:38">empty</a>()) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">&quot;foo&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Type">const</span> <span class="Type">int</span> index = rnd-&gt;<a href="../util/random.h.html#L48" title="util/random.h:48">Uniform</a>(keys.<a href="format.h.html#L31" title="table/format.h:31">size</a>());<br/></li>
<li>&nbsp; &nbsp; &nbsp; std::string result = keys[index];<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (rnd-&gt;<a href="../util/random.h.html#L48" title="util/random.h:48">Uniform</a>(<span class="Constant">3</span>)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">0</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">// Return an existing <a href="two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a><br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">1</span>: {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">// Attempt to return something smaller than an existing <a href="two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a><br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (result.<a href="format.h.html#L31" title="table/format.h:31">size</a>() &gt; <span class="Constant">0</span> &amp;&amp; result[result.<a href="format.h.html#L31" title="table/format.h:31">size</a>()-<span class="Constant">1</span>] &gt; <span class="Special">'\0'</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; result[result.<a href="format.h.html#L31" title="table/format.h:31">size</a>()-<span class="Constant">1</span>]--;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">2</span>: {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">// Return something larger than an existing <a href="two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a><br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L66" title="table/table_test.cc:66">Increment</a>(options_.comparator, &amp;result);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span> result;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// Returns NULL if not running against a <a href="../include/leveldb/db.h.html#L55" title="include/leveldb/db.h:55">DB</a><br/></li>
<li><a id="L640">&#x200c;</a></span>&nbsp; <a href="../include/leveldb/db.h.html#L55" title="include/leveldb/db.h:55">DB</a>* <span class="linkable">db</span>() <span class="Type">const</span> { <span class="Statement">return</span> constructor_-&gt;<span class="linkable">db</span>(); }<br/></li>
<li><br/></li>
<li><span class="cUserCont"> </span><span class="Statement">private</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; <a href="../include/leveldb/options.h.html#L31" title="include/leveldb/options.h:31">Options</a> options_;<br/></li>
<li>&nbsp; <a href="#L143" title="table/table_test.cc:143">Constructor</a>* constructor_;<br/></li>
<li>};<br/></li>
<li><br/></li>
<li><span class="Comment">// <a href="#L477" title="table/table_test.cc:477">Test</a> <a href="block_builder.h.html#L38" title="table/block_builder.h:38">empty</a> table/block.<br/></li>
<li><a id="L648">&#x200c;</a></span><span class="linkable">TEST</span>(<a href="#L439" title="table/table_test.cc:439">Harness</a>, Empty) {<br/></li>
<li>&nbsp; <span class="Statement">for</span> (<span class="Type">int</span> i = <span class="Constant">0</span>; i &lt; kNumTestArgs; i++) {<br/></li>
<li>&nbsp; &nbsp; <a href="#L441" title="table/table_test.cc:441">Init</a>(kTestArgList[i]);<br/></li>
<li>&nbsp; &nbsp; <a href="../util/random.h.html#L19" title="util/random.h:19">Random</a> rnd(test::<a href="../util/testharness.cc.html#L67" title="util/testharness.cc:67">RandomSeed</a>() + <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="#L477" title="table/table_test.cc:477">Test</a>(&amp;rnd);<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">// Special test for a block with no restart entries.&nbsp; The C++ leveldb<br/></li>
<li></span><span class="Comment">// <a href="../include/leveldb/status.h.html#L84" title="include/leveldb/status.h:84">code</a> never generates such blocks, but the Java version of leveldb<br/></li>
<li></span><span class="Comment">// seems to.<br/></li>
<li><a id="L659">&#x200c;</a></span><span class="linkable">TEST</span>(<a href="#L439" title="table/table_test.cc:439">Harness</a>, ZeroRestartPointsInBlock) {<br/></li>
<li>&nbsp; <span class="Type">char</span> <a href="#L173" title="table/table_test.cc:173">data</a>[<span class="Statement">sizeof</span>(<span class="Type"><a href="../port/win/stdint.h.html#L21" title="port/win/stdint.h:21">uint32_t</a></span>)];<br/></li>
<li>&nbsp; memset(<a href="#L173" title="table/table_test.cc:173">data</a>, <span class="Constant">0</span>, <span class="Statement">sizeof</span>(<a href="#L173" title="table/table_test.cc:173">data</a>));<br/></li>
<li>&nbsp; <a href="format.h.html#L86" title="table/format.h:86">BlockContents</a> <a href="#L94" title="table/table_test.cc:94">contents</a>;<br/></li>
<li>&nbsp; <a href="#L94" title="table/table_test.cc:94">contents</a>.<a href="#L173" title="table/table_test.cc:173">data</a> = <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>(<a href="#L173" title="table/table_test.cc:173">data</a>, <span class="Statement">sizeof</span>(<a href="#L173" title="table/table_test.cc:173">data</a>));<br/></li>
<li>&nbsp; <a href="#L94" title="table/table_test.cc:94">contents</a>.cachable = <span class="Constant">false</span>;<br/></li>
<li>&nbsp; <a href="#L94" title="table/table_test.cc:94">contents</a>.heap_allocated = <span class="Constant">false</span>;<br/></li>
<li>&nbsp; <a href="block.cc.html#L23" title="table/block.cc:23">Block</a> block(<a href="#L94" title="table/table_test.cc:94">contents</a>);<br/></li>
<li>&nbsp; <a href="iterator.cc.html#L9" title="table/iterator.cc:9">Iterator</a>* <a href="iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a> = block.<a href="#L209" title="table/table_test.cc:209">NewIterator</a>(<a href="../util/comparator.cc.html#L76" title="util/comparator.cc:76">BytewiseComparator</a>());<br/></li>
<li>&nbsp; <a href="iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="two_level_iterator.cc.html#L98" title="table/two_level_iterator.cc:98">SeekToFirst</a>();<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(!<a href="iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="two_level_iterator.cc.html#L34" title="table/two_level_iterator.cc:34">Valid</a>());<br/></li>
<li>&nbsp; <a href="iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="two_level_iterator.cc.html#L105" title="table/two_level_iterator.cc:105">SeekToLast</a>();<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(!<a href="iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="two_level_iterator.cc.html#L34" title="table/two_level_iterator.cc:34">Valid</a>());<br/></li>
<li>&nbsp; <a href="iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="two_level_iterator.cc.html#L91" title="table/two_level_iterator.cc:91">Seek</a>(<span class="Constant">&quot;foo&quot;</span>);<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(!<a href="iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="two_level_iterator.cc.html#L34" title="table/two_level_iterator.cc:34">Valid</a>());<br/></li>
<li>&nbsp; <span class="Statement">delete</span> <a href="iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">// <a href="#L477" title="table/table_test.cc:477">Test</a> the <a href="block_builder.h.html#L38" title="table/block_builder.h:38">empty</a> <a href="two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a><br/></li>
<li><a id="L678">&#x200c;</a></span><span class="linkable">TEST</span>(<a href="#L439" title="table/table_test.cc:439">Harness</a>, SimpleEmptyKey) {<br/></li>
<li>&nbsp; <span class="Statement">for</span> (<span class="Type">int</span> i = <span class="Constant">0</span>; i &lt; kNumTestArgs; i++) {<br/></li>
<li>&nbsp; &nbsp; <a href="#L441" title="table/table_test.cc:441">Init</a>(kTestArgList[i]);<br/></li>
<li>&nbsp; &nbsp; <a href="../util/random.h.html#L19" title="util/random.h:19">Random</a> rnd(test::<a href="../util/testharness.cc.html#L67" title="util/testharness.cc:67">RandomSeed</a>() + <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="#L146" title="table/table_test.cc:146">Add</a>(<span class="Constant">&quot;&quot;</span>, <span class="Constant">&quot;v&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="#L477" title="table/table_test.cc:477">Test</a>(&amp;rnd);<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L687">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L439" title="table/table_test.cc:439">Harness</a>, SimpleSingle) {<br/></li>
<li>&nbsp; <span class="Statement">for</span> (<span class="Type">int</span> i = <span class="Constant">0</span>; i &lt; kNumTestArgs; i++) {<br/></li>
<li>&nbsp; &nbsp; <a href="#L441" title="table/table_test.cc:441">Init</a>(kTestArgList[i]);<br/></li>
<li>&nbsp; &nbsp; <a href="../util/random.h.html#L19" title="util/random.h:19">Random</a> rnd(test::<a href="../util/testharness.cc.html#L67" title="util/testharness.cc:67">RandomSeed</a>() + <span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="#L146" title="table/table_test.cc:146">Add</a>(<span class="Constant">&quot;abc&quot;</span>, <span class="Constant">&quot;v&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="#L477" title="table/table_test.cc:477">Test</a>(&amp;rnd);<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L696">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L439" title="table/table_test.cc:439">Harness</a>, SimpleMulti) {<br/></li>
<li>&nbsp; <span class="Statement">for</span> (<span class="Type">int</span> i = <span class="Constant">0</span>; i &lt; kNumTestArgs; i++) {<br/></li>
<li>&nbsp; &nbsp; <a href="#L441" title="table/table_test.cc:441">Init</a>(kTestArgList[i]);<br/></li>
<li>&nbsp; &nbsp; <a href="../util/random.h.html#L19" title="util/random.h:19">Random</a> rnd(test::<a href="../util/testharness.cc.html#L67" title="util/testharness.cc:67">RandomSeed</a>() + <span class="Constant">3</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="#L146" title="table/table_test.cc:146">Add</a>(<span class="Constant">&quot;abc&quot;</span>, <span class="Constant">&quot;v&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="#L146" title="table/table_test.cc:146">Add</a>(<span class="Constant">&quot;abcd&quot;</span>, <span class="Constant">&quot;v&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="#L146" title="table/table_test.cc:146">Add</a>(<span class="Constant">&quot;ac&quot;</span>, <span class="Constant">&quot;v2&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="#L477" title="table/table_test.cc:477">Test</a>(&amp;rnd);<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L707">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L439" title="table/table_test.cc:439">Harness</a>, SimpleSpecialKey) {<br/></li>
<li>&nbsp; <span class="Statement">for</span> (<span class="Type">int</span> i = <span class="Constant">0</span>; i &lt; kNumTestArgs; i++) {<br/></li>
<li>&nbsp; &nbsp; <a href="#L441" title="table/table_test.cc:441">Init</a>(kTestArgList[i]);<br/></li>
<li>&nbsp; &nbsp; <a href="../util/random.h.html#L19" title="util/random.h:19">Random</a> rnd(test::<a href="../util/testharness.cc.html#L67" title="util/testharness.cc:67">RandomSeed</a>() + <span class="Constant">4</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="#L146" title="table/table_test.cc:146">Add</a>(<span class="Constant">&quot;</span><span class="Special">\xff\xff</span><span class="Constant">&quot;</span>, <span class="Constant">&quot;v3&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="#L477" title="table/table_test.cc:477">Test</a>(&amp;rnd);<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L716">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L439" title="table/table_test.cc:439">Harness</a>, Randomized) {<br/></li>
<li>&nbsp; <span class="Statement">for</span> (<span class="Type">int</span> i = <span class="Constant">0</span>; i &lt; kNumTestArgs; i++) {<br/></li>
<li>&nbsp; &nbsp; <a href="#L441" title="table/table_test.cc:441">Init</a>(kTestArgList[i]);<br/></li>
<li>&nbsp; &nbsp; <a href="../util/random.h.html#L19" title="util/random.h:19">Random</a> rnd(test::<a href="../util/testharness.cc.html#L67" title="util/testharness.cc:67">RandomSeed</a>() + <span class="Constant">5</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (<span class="Type">int</span> num_entries = <span class="Constant">0</span>; num_entries &lt; <span class="Constant">2000</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; num_entries += (num_entries &lt; <span class="Constant">50</span> ? <span class="Constant">1</span> : <span class="Constant">200</span>)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((num_entries % <span class="Constant">10</span>) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; fprintf(<span class="Constant">stderr</span>, <span class="Constant">&quot;case </span><span class="Special">%d</span><span class="Constant"> of </span><span class="Special">%d</span><span class="Constant">: num_entries = </span><span class="Special">%d\n</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (i + <span class="Constant">1</span>), <span class="Type">int</span>(kNumTestArgs), num_entries);<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (<span class="Type">int</span> e = <span class="Constant">0</span>; e &lt; num_entries; e++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; std::string v;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L146" title="table/table_test.cc:146">Add</a>(test::<a href="../db/db_test.cc.html#L1933" title="db/db_test.cc:1933">RandomKey</a>(&amp;rnd, rnd.<a href="../util/random.h.html#L57" title="util/random.h:57">Skewed</a>(<span class="Constant">4</span>)),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; test::<a href="../db/db_test.cc.html#L22" title="db/db_test.cc:22">RandomString</a>(&amp;rnd, rnd.<a href="../util/random.h.html#L57" title="util/random.h:57">Skewed</a>(<span class="Constant">5</span>), &amp;v).<a href="#L587" title="table/table_test.cc:587">ToString</a>());<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L477" title="table/table_test.cc:477">Test</a>(&amp;rnd);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L736">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L439" title="table/table_test.cc:439">Harness</a>, RandomizedLongDB) {<br/></li>
<li>&nbsp; <a href="../util/random.h.html#L19" title="util/random.h:19">Random</a> rnd(test::<a href="../util/testharness.cc.html#L67" title="util/testharness.cc:67">RandomSeed</a>());<br/></li>
<li>&nbsp; <a href="#L406" title="table/table_test.cc:406">TestArgs</a> args = { DB_TEST, <span class="Constant">false</span>, <span class="Constant">16</span> };<br/></li>
<li>&nbsp; <a href="#L441" title="table/table_test.cc:441">Init</a>(args);<br/></li>
<li>&nbsp; <span class="Type">int</span> num_entries = <span class="Constant">100000</span>;<br/></li>
<li>&nbsp; <span class="Statement">for</span> (<span class="Type">int</span> e = <span class="Constant">0</span>; e &lt; num_entries; e++) {<br/></li>
<li>&nbsp; &nbsp; std::string v;<br/></li>
<li>&nbsp; &nbsp; <a href="#L146" title="table/table_test.cc:146">Add</a>(test::<a href="../db/db_test.cc.html#L1933" title="db/db_test.cc:1933">RandomKey</a>(&amp;rnd, rnd.<a href="../util/random.h.html#L57" title="util/random.h:57">Skewed</a>(<span class="Constant">4</span>)),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; test::<a href="../db/db_test.cc.html#L22" title="db/db_test.cc:22">RandomString</a>(&amp;rnd, rnd.<a href="../util/random.h.html#L57" title="util/random.h:57">Skewed</a>(<span class="Constant">5</span>), &amp;v).<a href="#L587" title="table/table_test.cc:587">ToString</a>());<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <a href="#L477" title="table/table_test.cc:477">Test</a>(&amp;rnd);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// We must have created enough <a href="#L173" title="table/table_test.cc:173">data</a> to force merging<br/></li>
<li></span>&nbsp; <span class="Type">int</span> files = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; <span class="Statement">for</span> (<span class="Type">int</span> <a href="../db/version_set.h.html#L328" title="db/version_set.h:328">level</a> = <span class="Constant">0</span>; <a href="../db/version_set.h.html#L328" title="db/version_set.h:328">level</a> &lt; config::kNumLevels; <a href="../db/version_set.h.html#L328" title="db/version_set.h:328">level</a>++) {<br/></li>
<li>&nbsp; &nbsp; std::string <a href="two_level_iterator.cc.html#L41" title="table/two_level_iterator.cc:41">value</a>;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span> name[<span class="Constant">100</span>];<br/></li>
<li>&nbsp; &nbsp; snprintf(name, <span class="Statement">sizeof</span>(name), <span class="Constant">&quot;leveldb.num-files-at-<a href="../db/version_set.h.html#L328" title="db/version_set.h:328">level</a></span><span class="Special">%d</span><span class="Constant">&quot;</span>, <a href="../db/version_set.h.html#L328" title="db/version_set.h:328">level</a>);<br/></li>
<li>&nbsp; &nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(<a href="#L175" title="table/table_test.cc:175">db</a>()-&gt;<a href="../db/db_impl.cc.html#L1349" title="db/db_impl.cc:1349">GetProperty</a>(name, &amp;<a href="two_level_iterator.cc.html#L41" title="table/two_level_iterator.cc:41">value</a>));<br/></li>
<li>&nbsp; &nbsp; files += atoi(<a href="two_level_iterator.cc.html#L41" title="table/two_level_iterator.cc:41">value</a>.c_str());<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L110" title="util/testharness.h:110">ASSERT_GT</a>(files, <span class="Constant">0</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Type">class</span> MemTableTest { };<br/></li>
<li><br/></li>
<li><a id="L762">&#x200c;</a><span class="linkable">TEST</span>(MemTableTest, Simple) {<br/></li>
<li>&nbsp; <a href="../db/dbformat.h.html#L117" title="db/dbformat.h:117">InternalKeyComparator</a> cmp(<a href="../util/comparator.cc.html#L76" title="util/comparator.cc:76">BytewiseComparator</a>());<br/></li>
<li>&nbsp; <a href="../db/memtable.cc.html#L21" title="db/memtable.cc:21">MemTable</a>* memtable = <span class="Statement">new</span> <a href="../db/memtable.cc.html#L21" title="db/memtable.cc:21">MemTable</a>(cmp);<br/></li>
<li>&nbsp; memtable-&gt;<a href="../db/version_set.cc.html#L473" title="db/version_set.cc:473">Ref</a>();<br/></li>
<li>&nbsp; <a href="../db/write_batch.cc.html#L29" title="db/write_batch.cc:29">WriteBatch</a> batch;<br/></li>
<li>&nbsp; WriteBatchInternal::<a href="../db/write_batch.cc.html#L94" title="db/write_batch.cc:94">SetSequence</a>(&amp;batch, <span class="Constant">100</span>);<br/></li>
<li>&nbsp; batch.<a href="../db/write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(std::string(<span class="Constant">&quot;k1&quot;</span>), std::string(<span class="Constant">&quot;v1&quot;</span>));<br/></li>
<li>&nbsp; batch.<a href="../db/write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(std::string(<span class="Constant">&quot;k2&quot;</span>), std::string(<span class="Constant">&quot;v2&quot;</span>));<br/></li>
<li>&nbsp; batch.<a href="../db/write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(std::string(<span class="Constant">&quot;k3&quot;</span>), std::string(<span class="Constant">&quot;v3&quot;</span>));<br/></li>
<li>&nbsp; batch.<a href="../db/write_batch.cc.html#L98" title="db/write_batch.cc:98">Put</a>(std::string(<span class="Constant">&quot;largekey&quot;</span>), std::string(<span class="Constant">&quot;vlarge&quot;</span>));<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(WriteBatchInternal::<a href="../db/write_batch.cc.html#L128" title="db/write_batch.cc:128">InsertInto</a>(&amp;batch, memtable).<a href="../include/leveldb/table_builder.h.html#L78" title="include/leveldb/table_builder.h:78">ok</a>());<br/></li>
<li><br/></li>
<li>&nbsp; <a href="iterator.cc.html#L9" title="table/iterator.cc:9">Iterator</a>* <a href="iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a> = memtable-&gt;<a href="#L209" title="table/table_test.cc:209">NewIterator</a>();<br/></li>
<li>&nbsp; <a href="iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="two_level_iterator.cc.html#L98" title="table/two_level_iterator.cc:98">SeekToFirst</a>();<br/></li>
<li>&nbsp; <span class="Statement">while</span> (<a href="iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="two_level_iterator.cc.html#L34" title="table/two_level_iterator.cc:34">Valid</a>()) {<br/></li>
<li>&nbsp; &nbsp; fprintf(<span class="Constant">stderr</span>, <span class="Constant">&quot;<a href="two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>: '</span><span class="Special">%s</span><span class="Constant">' -&gt; '</span><span class="Special">%s</span><span class="Constant">'</span><span class="Special">\n</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>().<a href="#L587" title="table/table_test.cc:587">ToString</a>().c_str(),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="two_level_iterator.cc.html#L41" title="table/two_level_iterator.cc:41">value</a>().<a href="#L587" title="table/table_test.cc:587">ToString</a>().c_str());<br/></li>
<li>&nbsp; &nbsp; <a href="iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>-&gt;<a href="two_level_iterator.cc.html#L112" title="table/two_level_iterator.cc:112">Next</a>();<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">delete</span> <a href="iterator_wrapper.h.html#L21" title="table/iterator_wrapper.h:21">iter</a>;<br/></li>
<li>&nbsp; memtable-&gt;<a href="../db/version_set.cc.html#L477" title="db/version_set.cc:477">Unref</a>();<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L787">&#x200c;</a><span class="Type">static</span> <span class="Type">bool</span> <span class="linkable">Between</span>(<span class="Type"><a href="../port/win/stdint.h.html#L22" title="port/win/stdint.h:22">uint64_t</a></span> val, <span class="Type"><a href="../port/win/stdint.h.html#L22" title="port/win/stdint.h:22">uint64_t</a></span> low, <span class="Type"><a href="../port/win/stdint.h.html#L22" title="port/win/stdint.h:22">uint64_t</a></span> high) {<br/></li>
<li>&nbsp; <span class="Type">bool</span> result = (val &gt;= low) &amp;&amp; (val &lt;= high);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (!result) {<br/></li>
<li>&nbsp; &nbsp; fprintf(<span class="Constant">stderr</span>, <span class="Constant">&quot;<a href="../db/corruption_test.cc.html#L196" title="db/corruption_test.cc:196">Value</a> </span><span class="Special">%llu</span><span class="Constant"> is not in range [</span><span class="Special">%llu</span><span class="Constant">, </span><span class="Special">%llu</span><span class="Constant">]</span><span class="Special">\n</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<span class="Type">unsigned</span> <span class="Type">long</span> <span class="Type">long</span>)(val),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<span class="Type">unsigned</span> <span class="Type">long</span> <span class="Type">long</span>)(low),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<span class="Type">unsigned</span> <span class="Type">long</span> <span class="Type">long</span>)(high));<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> result;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Type">class</span> TableTest { };<br/></li>
<li><br/></li>
<li><a id="L800">&#x200c;</a><span class="linkable">TEST</span>(TableTest, ApproximateOffsetOfPlain) {<br/></li>
<li>&nbsp; <a href="#L223" title="table/table_test.cc:223">TableConstructor</a> c(<a href="../util/comparator.cc.html#L76" title="util/comparator.cc:76">BytewiseComparator</a>());<br/></li>
<li>&nbsp; c.<a href="#L146" title="table/table_test.cc:146">Add</a>(<span class="Constant">&quot;k01&quot;</span>, <span class="Constant">&quot;hello&quot;</span>);<br/></li>
<li>&nbsp; c.<a href="#L146" title="table/table_test.cc:146">Add</a>(<span class="Constant">&quot;k02&quot;</span>, <span class="Constant">&quot;hello2&quot;</span>);<br/></li>
<li>&nbsp; c.<a href="#L146" title="table/table_test.cc:146">Add</a>(<span class="Constant">&quot;k03&quot;</span>, std::string(<span class="Constant">10000</span>, <span class="Constant">'x'</span>));<br/></li>
<li>&nbsp; c.<a href="#L146" title="table/table_test.cc:146">Add</a>(<span class="Constant">&quot;k04&quot;</span>, std::string(<span class="Constant">200000</span>, <span class="Constant">'x'</span>));<br/></li>
<li>&nbsp; c.<a href="#L146" title="table/table_test.cc:146">Add</a>(<span class="Constant">&quot;k05&quot;</span>, std::string(<span class="Constant">300000</span>, <span class="Constant">'x'</span>));<br/></li>
<li>&nbsp; c.<a href="#L146" title="table/table_test.cc:146">Add</a>(<span class="Constant">&quot;k06&quot;</span>, <span class="Constant">&quot;hello3&quot;</span>);<br/></li>
<li>&nbsp; c.<a href="#L146" title="table/table_test.cc:146">Add</a>(<span class="Constant">&quot;k07&quot;</span>, std::string(<span class="Constant">100000</span>, <span class="Constant">'x'</span>));<br/></li>
<li>&nbsp; std::vector&lt;std::string&gt; keys;<br/></li>
<li>&nbsp; <a href="#L137" title="table/table_test.cc:137">KVMap</a> kvmap;<br/></li>
<li>&nbsp; <a href="../include/leveldb/options.h.html#L31" title="include/leveldb/options.h:31">Options</a> options;<br/></li>
<li>&nbsp; options.block_size = <span class="Constant">1024</span>;<br/></li>
<li>&nbsp; options.compression = kNoCompression;<br/></li>
<li>&nbsp; c.<a href="#L153" title="table/table_test.cc:153">Finish</a>(options, &amp;keys, &amp;kvmap);<br/></li>
<li><br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(<a href="#L787" title="table/table_test.cc:787">Between</a>(c.<a href="#L257" title="table/table_test.cc:257">ApproximateOffsetOf</a>(<span class="Constant">&quot;abc&quot;</span>),&nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">0</span>,&nbsp; &nbsp; &nbsp; <span class="Constant">0</span>));<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(<a href="#L787" title="table/table_test.cc:787">Between</a>(c.<a href="#L257" title="table/table_test.cc:257">ApproximateOffsetOf</a>(<span class="Constant">&quot;k01&quot;</span>),&nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">0</span>,&nbsp; &nbsp; &nbsp; <span class="Constant">0</span>));<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(<a href="#L787" title="table/table_test.cc:787">Between</a>(c.<a href="#L257" title="table/table_test.cc:257">ApproximateOffsetOf</a>(<span class="Constant">&quot;k01a&quot;</span>),&nbsp; &nbsp; &nbsp; <span class="Constant">0</span>,&nbsp; &nbsp; &nbsp; <span class="Constant">0</span>));<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(<a href="#L787" title="table/table_test.cc:787">Between</a>(c.<a href="#L257" title="table/table_test.cc:257">ApproximateOffsetOf</a>(<span class="Constant">&quot;k02&quot;</span>),&nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">0</span>,&nbsp; &nbsp; &nbsp; <span class="Constant">0</span>));<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(<a href="#L787" title="table/table_test.cc:787">Between</a>(c.<a href="#L257" title="table/table_test.cc:257">ApproximateOffsetOf</a>(<span class="Constant">&quot;k03&quot;</span>),&nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">0</span>,&nbsp; &nbsp; &nbsp; <span class="Constant">0</span>));<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(<a href="#L787" title="table/table_test.cc:787">Between</a>(c.<a href="#L257" title="table/table_test.cc:257">ApproximateOffsetOf</a>(<span class="Constant">&quot;k04&quot;</span>),&nbsp;&nbsp; <span class="Constant">10000</span>,&nbsp; <span class="Constant">11000</span>));<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(<a href="#L787" title="table/table_test.cc:787">Between</a>(c.<a href="#L257" title="table/table_test.cc:257">ApproximateOffsetOf</a>(<span class="Constant">&quot;k04a&quot;</span>), <span class="Constant">210000</span>, <span class="Constant">211000</span>));<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(<a href="#L787" title="table/table_test.cc:787">Between</a>(c.<a href="#L257" title="table/table_test.cc:257">ApproximateOffsetOf</a>(<span class="Constant">&quot;k05&quot;</span>),&nbsp; <span class="Constant">210000</span>, <span class="Constant">211000</span>));<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(<a href="#L787" title="table/table_test.cc:787">Between</a>(c.<a href="#L257" title="table/table_test.cc:257">ApproximateOffsetOf</a>(<span class="Constant">&quot;k06&quot;</span>),&nbsp; <span class="Constant">510000</span>, <span class="Constant">511000</span>));<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(<a href="#L787" title="table/table_test.cc:787">Between</a>(c.<a href="#L257" title="table/table_test.cc:257">ApproximateOffsetOf</a>(<span class="Constant">&quot;k07&quot;</span>),&nbsp; <span class="Constant">510000</span>, <span class="Constant">511000</span>));<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(<a href="#L787" title="table/table_test.cc:787">Between</a>(c.<a href="#L257" title="table/table_test.cc:257">ApproximateOffsetOf</a>(<span class="Constant">&quot;xyz&quot;</span>),&nbsp; <span class="Constant">610000</span>, <span class="Constant">612000</span>));<br/></li>
<li><br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L830">&#x200c;</a><span class="Type">static</span> <span class="Type">bool</span> <span class="linkable">SnappyCompressionSupported</span>() {<br/></li>
<li>&nbsp; std::string out;<br/></li>
<li>&nbsp; <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a> in = <span class="Constant">&quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;</span>;<br/></li>
<li>&nbsp; <span class="Statement">return</span> port::<a href="../port/port_posix.h.html#L116" title="port/port_posix.h:116">Snappy_Compress</a>(in.<a href="#L173" title="table/table_test.cc:173">data</a>(), in.<a href="format.h.html#L31" title="table/format.h:31">size</a>(), &amp;out);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L836">&#x200c;</a><span class="linkable">TEST</span>(TableTest, ApproximateOffsetOfCompressed) {<br/></li>
<li>&nbsp; <span class="Statement">if</span> (!<a href="#L830" title="table/table_test.cc:830">SnappyCompressionSupported</a>()) {<br/></li>
<li>&nbsp; &nbsp; fprintf(<span class="Constant">stderr</span>, <span class="Constant">&quot;skipping compression tests</span><span class="Special">\n</span><span class="Constant">&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <a href="../util/random.h.html#L19" title="util/random.h:19">Random</a> rnd(<span class="Constant">301</span>);<br/></li>
<li>&nbsp; <a href="#L223" title="table/table_test.cc:223">TableConstructor</a> c(<a href="../util/comparator.cc.html#L76" title="util/comparator.cc:76">BytewiseComparator</a>());<br/></li>
<li>&nbsp; std::string tmp;<br/></li>
<li>&nbsp; c.<a href="#L146" title="table/table_test.cc:146">Add</a>(<span class="Constant">&quot;k01&quot;</span>, <span class="Constant">&quot;hello&quot;</span>);<br/></li>
<li>&nbsp; c.<a href="#L146" title="table/table_test.cc:146">Add</a>(<span class="Constant">&quot;k02&quot;</span>, test::<a href="../util/testutil.cc.html#L34" title="util/testutil.cc:34">CompressibleString</a>(&amp;rnd, <span class="Constant">0.25</span>, <span class="Constant">10000</span>, &amp;tmp));<br/></li>
<li>&nbsp; c.<a href="#L146" title="table/table_test.cc:146">Add</a>(<span class="Constant">&quot;k03&quot;</span>, <span class="Constant">&quot;hello3&quot;</span>);<br/></li>
<li>&nbsp; c.<a href="#L146" title="table/table_test.cc:146">Add</a>(<span class="Constant">&quot;k04&quot;</span>, test::<a href="../util/testutil.cc.html#L34" title="util/testutil.cc:34">CompressibleString</a>(&amp;rnd, <span class="Constant">0.25</span>, <span class="Constant">10000</span>, &amp;tmp));<br/></li>
<li>&nbsp; std::vector&lt;std::string&gt; keys;<br/></li>
<li>&nbsp; <a href="#L137" title="table/table_test.cc:137">KVMap</a> kvmap;<br/></li>
<li>&nbsp; <a href="../include/leveldb/options.h.html#L31" title="include/leveldb/options.h:31">Options</a> options;<br/></li>
<li>&nbsp; options.block_size = <span class="Constant">1024</span>;<br/></li>
<li>&nbsp; options.compression = kSnappyCompression;<br/></li>
<li>&nbsp; c.<a href="#L153" title="table/table_test.cc:153">Finish</a>(options, &amp;keys, &amp;kvmap);<br/></li>
<li><br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(<a href="#L787" title="table/table_test.cc:787">Between</a>(c.<a href="#L257" title="table/table_test.cc:257">ApproximateOffsetOf</a>(<span class="Constant">&quot;abc&quot;</span>),&nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">0</span>,&nbsp; &nbsp; &nbsp; <span class="Constant">0</span>));<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(<a href="#L787" title="table/table_test.cc:787">Between</a>(c.<a href="#L257" title="table/table_test.cc:257">ApproximateOffsetOf</a>(<span class="Constant">&quot;k01&quot;</span>),&nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">0</span>,&nbsp; &nbsp; &nbsp; <span class="Constant">0</span>));<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(<a href="#L787" title="table/table_test.cc:787">Between</a>(c.<a href="#L257" title="table/table_test.cc:257">ApproximateOffsetOf</a>(<span class="Constant">&quot;k02&quot;</span>),&nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">0</span>,&nbsp; &nbsp; &nbsp; <span class="Constant">0</span>));<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(<a href="#L787" title="table/table_test.cc:787">Between</a>(c.<a href="#L257" title="table/table_test.cc:257">ApproximateOffsetOf</a>(<span class="Constant">&quot;k03&quot;</span>),&nbsp; &nbsp; <span class="Constant">2000</span>,&nbsp;&nbsp; <span class="Constant">3000</span>));<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(<a href="#L787" title="table/table_test.cc:787">Between</a>(c.<a href="#L257" title="table/table_test.cc:257">ApproximateOffsetOf</a>(<span class="Constant">&quot;k04&quot;</span>),&nbsp; &nbsp; <span class="Constant">2000</span>,&nbsp;&nbsp; <span class="Constant">3000</span>));<br/></li>
<li>&nbsp; <a href="../util/testharness.h.html#L105" title="util/testharness.h:105">ASSERT_TRUE</a>(<a href="#L787" title="table/table_test.cc:787">Between</a>(c.<a href="#L257" title="table/table_test.cc:257">ApproximateOffsetOf</a>(<span class="Constant">&quot;xyz&quot;</span>),&nbsp; &nbsp; <span class="Constant">4000</span>,&nbsp;&nbsp; <span class="Constant">6000</span>));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li>}&nbsp; <span class="Comment">// namespace leveldb<br/></li>
<li></span><br/></li>
<li><a id="L866">&#x200c;</a><span class="Type">int</span> <span class="linkable">main</span>(<span class="Type">int</span> argc, <span class="Type">char</span>** argv) {<br/></li>
<li>&nbsp; <span class="Statement">return</span> leveldb::test::<a href="../util/testharness.cc.html#L36" title="util/testharness.cc:36">RunAllTests</a>();<br/></li>
<li>}<br/></li>
</ol></code>
 </body>
</html>
