<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>table/block.cc - leveldb-1.18</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

code {
    font-family: consolas, monospace;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
  <h3>table/block.cc - leveldb-1.18</h3>
   <a href="../index.html"> Table of Contents </a>
 <h4>Functions defined</h4>
 <ul>
<li><a href="#L23">Block</a></li>
<li><a href="#L90">Compare</a></li>
<li><a href="#L218">CorruptionError</a></li>
<li><a href="#L53">DecodeEntry</a></li>
<li><a href="#L99">GetRestartPoint</a></li>
<li><a href="#L115">Iter</a></li>
<li><a href="#L256">NewIterator</a></li>
<li><a href="#L139">Next</a></li>
<li><a href="#L95">NextEntryOffset</a></li>
<li><a href="#L18">NumRestarts</a></li>
<li><a href="#L226">ParseNextKey</a></li>
<li><a href="#L144">Prev</a></li>
<li><a href="#L165">Seek</a></li>
<li><a href="#L205">SeekToFirst</a></li>
<li><a href="#L210">SeekToLast</a></li>
<li><a href="#L104">SeekToRestartPoint</a></li>
<li><a href="#L128">Valid</a></li>
<li><a href="#L130">key</a></li>
<li><a href="#L129">status</a></li>
<li><a href="#L134">value</a></li>
<li><a href="#L40">~Block</a></li>
</ul>
 <h4>Source code</h4>

  <code><ol><li><span class="Comment">// Copyright (c) 2011 The LevelDB Authors. All rights reserved.<br/></li>
<li></span><span class="Comment">// Use of this source <a href="../include/leveldb/status.h.html#L84" title="include/leveldb/status.h:84">code</a> is governed by a BSD-style license that can be<br/></li>
<li></span><span class="Comment">// found in the LICENSE file. See the AUTHORS file for names of contributors.<br/></li>
<li></span><span class="Comment">//<br/></li>
<li></span><span class="Comment">// Decodes the blocks generated by block_builder.cc.<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;table/block.h&quot;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;vector&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;algorithm&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;leveldb/comparator.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;table/format.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;util/coding.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;util/logging.h&quot;<br/></li>
<li></span><br/></li>
<li><span class="Type">namespace</span> leveldb {<br/></li>
<li><br/></li>
<li><a id="L18">&#x200c;</a><span class="Type">inline</span> <span class="Type"><a href="../port/win/stdint.h.html#L21" title="port/win/stdint.h:21">uint32_t</a></span> <a href="#L23" title="table/block.cc:23">Block</a>::<span class="linkable">NumRestarts</span>() <span class="Type">const</span> {<br/></li>
<li>&nbsp; assert(size_ &gt;= <span class="Statement">sizeof</span>(<span class="Type"><a href="../port/win/stdint.h.html#L21" title="port/win/stdint.h:21">uint32_t</a></span>));<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="../util/coding.h.html#L58" title="util/coding.h:58">DecodeFixed32</a>(data_ + size_ - <span class="Statement">sizeof</span>(<span class="Type"><a href="../port/win/stdint.h.html#L21" title="port/win/stdint.h:21">uint32_t</a></span>));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L23">&#x200c;</a><span class="linkable">Block</span>::<span class="linkable">Block</span>(<span class="Type">const</span> <a href="format.h.html#L86" title="table/format.h:86">BlockContents</a>&amp; <a href="table_test.cc.html#L94" title="table/table_test.cc:94">contents</a>)<br/></li>
<li>&nbsp; &nbsp; : data_(<a href="table_test.cc.html#L94" title="table/table_test.cc:94">contents</a>.<a href="table_test.cc.html#L173" title="table/table_test.cc:173">data</a>.<a href="table_test.cc.html#L173" title="table/table_test.cc:173">data</a>()),<br/></li>
<li>&nbsp; &nbsp; &nbsp; size_(<a href="table_test.cc.html#L94" title="table/table_test.cc:94">contents</a>.<a href="table_test.cc.html#L173" title="table/table_test.cc:173">data</a>.<a href="format.h.html#L31" title="table/format.h:31">size</a>()),<br/></li>
<li>&nbsp; &nbsp; &nbsp; owned_(<a href="table_test.cc.html#L94" title="table/table_test.cc:94">contents</a>.heap_allocated) {<br/></li>
<li>&nbsp; <span class="Statement">if</span> (size_ &lt; <span class="Statement">sizeof</span>(<span class="Type"><a href="../port/win/stdint.h.html#L21" title="port/win/stdint.h:21">uint32_t</a></span>)) {<br/></li>
<li>&nbsp; &nbsp; size_ = <span class="Constant">0</span>;&nbsp; <span class="Comment">// Error marker<br/></li>
<li></span>&nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span> max_restarts_allowed = (size_-<span class="Statement">sizeof</span>(<span class="Type"><a href="../port/win/stdint.h.html#L21" title="port/win/stdint.h:21">uint32_t</a></span>)) / <span class="Statement">sizeof</span>(<span class="Type"><a href="../port/win/stdint.h.html#L21" title="port/win/stdint.h:21">uint32_t</a></span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L18" title="table/block.cc:18">NumRestarts</a>() &gt; max_restarts_allowed) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Comment">// The <a href="format.h.html#L31" title="table/format.h:31">size</a> is too small for <a href="#L18" title="table/block.cc:18">NumRestarts</a>()<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; size_ = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; restart_offset_ = size_ - (<span class="Constant">1</span> + <a href="#L18" title="table/block.cc:18">NumRestarts</a>()) * <span class="Statement">sizeof</span>(<span class="Type"><a href="../port/win/stdint.h.html#L21" title="port/win/stdint.h:21">uint32_t</a></span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L40">&#x200c;</a><a href="#L23" title="table/block.cc:23">Block</a>::~<a href="#L23" title="table/block.cc:23">Block</a>() {<br/></li>
<li>&nbsp; <span class="Statement">if</span> (owned_) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">delete</span>[] data_;<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">// Helper routine: decode the next block entry starting at &quot;p&quot;,<br/></li>
<li></span><span class="Comment">// storing the number of shared <a href="two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a> bytes, non_shared <a href="two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a> bytes,<br/></li>
<li></span><span class="Comment">// and the length of the <a href="two_level_iterator.cc.html#L41" title="table/two_level_iterator.cc:41">value</a> in &quot;*shared&quot;, &quot;*non_shared&quot;, and<br/></li>
<li></span><span class="Comment">// &quot;*value_length&quot;, respectively.&nbsp; Will not dereference past &quot;limit&quot;.<br/></li>
<li></span><span class="Comment">//<br/></li>
<li></span><span class="Comment">// If any errors are detected, returns NULL.&nbsp; Otherwise, returns a<br/></li>
<li></span><span class="Comment">// pointer to the <a href="two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a> delta (just past the three decoded values).<br/></li>
<li><a id="L53">&#x200c;</a></span><span class="Type">static</span> <span class="Type">inline</span> <span class="Type">const</span> <span class="Type">char</span>* <span class="linkable">DecodeEntry</span>(<span class="Type">const</span> <span class="Type">char</span>* p, <span class="Type">const</span> <span class="Type">char</span>* limit,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type"><a href="../port/win/stdint.h.html#L21" title="port/win/stdint.h:21">uint32_t</a></span>* shared,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type"><a href="../port/win/stdint.h.html#L21" title="port/win/stdint.h:21">uint32_t</a></span>* non_shared,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type"><a href="../port/win/stdint.h.html#L21" title="port/win/stdint.h:21">uint32_t</a></span>* value_length) {<br/></li>
<li>&nbsp; <span class="Statement">if</span> (limit - p &lt; <span class="Constant">3</span>) <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; *shared = <span class="Statement">reinterpret_cast</span>&lt;<span class="Type">const</span> <span class="Type">unsigned</span> <span class="Type">char</span>*&gt;(p)[<span class="Constant">0</span>];<br/></li>
<li>&nbsp; *non_shared = <span class="Statement">reinterpret_cast</span>&lt;<span class="Type">const</span> <span class="Type">unsigned</span> <span class="Type">char</span>*&gt;(p)[<span class="Constant">1</span>];<br/></li>
<li>&nbsp; *value_length = <span class="Statement">reinterpret_cast</span>&lt;<span class="Type">const</span> <span class="Type">unsigned</span> <span class="Type">char</span>*&gt;(p)[<span class="Constant">2</span>];<br/></li>
<li>&nbsp; <span class="Statement">if</span> ((*shared | *non_shared | *value_length) &lt; <span class="Constant">128</span>) {<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// Fast path: all three values are encoded in one byte each<br/></li>
<li></span>&nbsp; &nbsp; p += <span class="Constant">3</span>;<br/></li>
<li>&nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> ((p = <a href="../util/coding.h.html#L89" title="util/coding.h:89">GetVarint32Ptr</a>(p, limit, shared)) == <span class="Constant">NULL</span>) <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> ((p = <a href="../util/coding.h.html#L89" title="util/coding.h:89">GetVarint32Ptr</a>(p, limit, non_shared)) == <span class="Constant">NULL</span>) <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> ((p = <a href="../util/coding.h.html#L89" title="util/coding.h:89">GetVarint32Ptr</a>(p, limit, value_length)) == <span class="Constant">NULL</span>) <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">if</span> (<span class="Statement">static_cast</span>&lt;<span class="Type"><a href="../port/win/stdint.h.html#L21" title="port/win/stdint.h:21">uint32_t</a></span>&gt;(limit - p) &lt; (*non_shared + *value_length)) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> p;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Type">class</span> <a href="#L23" title="table/block.cc:23">Block</a>::<a href="#L115" title="table/block.cc:115">Iter</a> : <span class="Statement">public</span> <a href="iterator.cc.html#L9" title="table/iterator.cc:9">Iterator</a> {<br/></li>
<li><span class="cUserCont"> </span><span class="Statement">private</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; <span class="Type">const</span> <a href="../db/skiplist_test.cc.html#L17" title="db/skiplist_test.cc:17">Comparator</a>* <span class="Type">const</span> comparator_;<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">char</span>* <span class="Type">const</span> data_;&nbsp; &nbsp; &nbsp; <span class="Comment">// underlying block <a href="table_test.cc.html#L94" title="table/table_test.cc:94">contents</a><br/></li>
<li></span>&nbsp; <span class="Type"><a href="../port/win/stdint.h.html#L21" title="port/win/stdint.h:21">uint32_t</a></span> <span class="Type">const</span> restarts_;&nbsp; &nbsp;&nbsp; <span class="Comment">// Offset of restart array (list of fixed32)<br/></li>
<li></span>&nbsp; <span class="Type"><a href="../port/win/stdint.h.html#L21" title="port/win/stdint.h:21">uint32_t</a></span> <span class="Type">const</span> num_restarts_; <span class="Comment">// Number of <a href="../port/win/stdint.h.html#L21" title="port/win/stdint.h:21">uint32_t</a> entries in restart array<br/></li>
<li></span><br/></li>
<li>&nbsp; <span class="Comment">// current_ is <a href="format.h.html#L27" title="table/format.h:27">offset</a> in data_ of <a href="../db/version_set.h.html#L185" title="db/version_set.h:185">current</a> entry.&nbsp; &gt;= restarts_ if !<a href="two_level_iterator.cc.html#L34" title="table/two_level_iterator.cc:34">Valid</a><br/></li>
<li></span>&nbsp; <span class="Type"><a href="../port/win/stdint.h.html#L21" title="port/win/stdint.h:21">uint32_t</a></span> current_;<br/></li>
<li>&nbsp; <span class="Type"><a href="../port/win/stdint.h.html#L21" title="port/win/stdint.h:21">uint32_t</a></span> restart_index_;&nbsp; <span class="Comment">// Index of restart block in which current_ falls<br/></li>
<li></span>&nbsp; std::string key_;<br/></li>
<li>&nbsp; <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a> value_;<br/></li>
<li>&nbsp; <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> status_;<br/></li>
<li><br/></li>
<li><a id="L90">&#x200c;</a>&nbsp; <span class="Type">inline</span> <span class="Type">int</span> <span class="linkable">Compare</span>(<span class="Type">const</span> <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>&amp; a, <span class="Type">const</span> <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>&amp; b) <span class="Type">const</span> {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> comparator_-&gt;<a href="table_test.cc.html#L44" title="table/table_test.cc:44">Compare</a>(a, b);<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// Return the <a href="format.h.html#L27" title="table/format.h:27">offset</a> in data_ just past the end of the <a href="../db/version_set.h.html#L185" title="db/version_set.h:185">current</a> entry.<br/></li>
<li><a id="L95">&#x200c;</a></span>&nbsp; <span class="Type">inline</span> <span class="Type"><a href="../port/win/stdint.h.html#L21" title="port/win/stdint.h:21">uint32_t</a></span> <span class="linkable">NextEntryOffset</span>() <span class="Type">const</span> {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> (value_.<a href="table_test.cc.html#L173" title="table/table_test.cc:173">data</a>() + value_.<a href="format.h.html#L31" title="table/format.h:31">size</a>()) - data_;<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li><a id="L99">&#x200c;</a>&nbsp; <span class="Type"><a href="../port/win/stdint.h.html#L21" title="port/win/stdint.h:21">uint32_t</a></span> <span class="linkable">GetRestartPoint</span>(<span class="Type"><a href="../port/win/stdint.h.html#L21" title="port/win/stdint.h:21">uint32_t</a></span> index) {<br/></li>
<li>&nbsp; &nbsp; assert(index &lt; num_restarts_);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../util/coding.h.html#L58" title="util/coding.h:58">DecodeFixed32</a>(data_ + restarts_ + index * <span class="Statement">sizeof</span>(<span class="Type"><a href="../port/win/stdint.h.html#L21" title="port/win/stdint.h:21">uint32_t</a></span>));<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li><a id="L104">&#x200c;</a>&nbsp; <span class="Type">void</span> <span class="linkable">SeekToRestartPoint</span>(<span class="Type"><a href="../port/win/stdint.h.html#L21" title="port/win/stdint.h:21">uint32_t</a></span> index) {<br/></li>
<li>&nbsp; &nbsp; key_.<a href="../include/leveldb/slice.h.html#L56" title="include/leveldb/slice.h:56">clear</a>();<br/></li>
<li>&nbsp; &nbsp; restart_index_ = index;<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// current_ will be fixed by <a href="#L226" title="table/block.cc:226">ParseNextKey</a>();<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// <a href="#L226" title="table/block.cc:226">ParseNextKey</a>() starts at the end of value_, so set value_ accordingly<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type"><a href="../port/win/stdint.h.html#L21" title="port/win/stdint.h:21">uint32_t</a></span> <a href="format.h.html#L27" title="table/format.h:27">offset</a> = <a href="#L99" title="table/block.cc:99">GetRestartPoint</a>(index);<br/></li>
<li>&nbsp; &nbsp; value_ = <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>(data_ + <a href="format.h.html#L27" title="table/format.h:27">offset</a>, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li><span class="cUserCont"> </span><span class="Statement">public</span><span class="cUserCont">:<br/></li>
<li><a id="L115">&#x200c;</a></span>&nbsp; <span class="linkable">Iter</span>(<span class="Type">const</span> <a href="../db/skiplist_test.cc.html#L17" title="db/skiplist_test.cc:17">Comparator</a>* comparator,<br/></li>
<li>&nbsp; &nbsp; &nbsp;&nbsp; <span class="Type">const</span> <span class="Type">char</span>* <a href="table_test.cc.html#L173" title="table/table_test.cc:173">data</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp;&nbsp; <span class="Type"><a href="../port/win/stdint.h.html#L21" title="port/win/stdint.h:21">uint32_t</a></span> restarts,<br/></li>
<li>&nbsp; &nbsp; &nbsp;&nbsp; <span class="Type"><a href="../port/win/stdint.h.html#L21" title="port/win/stdint.h:21">uint32_t</a></span> num_restarts)<br/></li>
<li>&nbsp; &nbsp; &nbsp; : comparator_(comparator),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; data_(<a href="table_test.cc.html#L173" title="table/table_test.cc:173">data</a>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; restarts_(restarts),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; num_restarts_(num_restarts),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; current_(restarts_),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; restart_index_(num_restarts_) {<br/></li>
<li>&nbsp; &nbsp; assert(num_restarts_ &gt; <span class="Constant">0</span>);<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li><a id="L128">&#x200c;</a>&nbsp; <span class="Type">virtual</span> <span class="Type">bool</span> <span class="linkable">Valid</span>() <span class="Type">const</span> { <span class="Statement">return</span> current_ &lt; restarts_; }<br/></li>
<li><a id="L129">&#x200c;</a>&nbsp; <span class="Type">virtual</span> <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a> <span class="linkable">status</span>() <span class="Type">const</span> { <span class="Statement">return</span> status_; }<br/></li>
<li><a id="L130">&#x200c;</a>&nbsp; <span class="Type">virtual</span> <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a> <span class="linkable">key</span>() <span class="Type">const</span> {<br/></li>
<li>&nbsp; &nbsp; assert(<a href="two_level_iterator.cc.html#L34" title="table/two_level_iterator.cc:34">Valid</a>());<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> key_;<br/></li>
<li>&nbsp; }<br/></li>
<li><a id="L134">&#x200c;</a>&nbsp; <span class="Type">virtual</span> <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a> <span class="linkable">value</span>() <span class="Type">const</span> {<br/></li>
<li>&nbsp; &nbsp; assert(<a href="two_level_iterator.cc.html#L34" title="table/two_level_iterator.cc:34">Valid</a>());<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> value_;<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li><a id="L139">&#x200c;</a>&nbsp; <span class="Type">virtual</span> <span class="Type">void</span> <span class="linkable">Next</span>() {<br/></li>
<li>&nbsp; &nbsp; assert(<a href="two_level_iterator.cc.html#L34" title="table/two_level_iterator.cc:34">Valid</a>());<br/></li>
<li>&nbsp; &nbsp; <a href="#L226" title="table/block.cc:226">ParseNextKey</a>();<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li><a id="L144">&#x200c;</a>&nbsp; <span class="Type">virtual</span> <span class="Type">void</span> <span class="linkable">Prev</span>() {<br/></li>
<li>&nbsp; &nbsp; assert(<a href="two_level_iterator.cc.html#L34" title="table/two_level_iterator.cc:34">Valid</a>());<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// Scan backwards to a restart point before current_<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">const</span> <span class="Type"><a href="../port/win/stdint.h.html#L21" title="port/win/stdint.h:21">uint32_t</a></span> original = current_;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (<a href="#L99" title="table/block.cc:99">GetRestartPoint</a>(restart_index_) &gt;= original) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (restart_index_ == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">// No more entries<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; current_ = restarts_;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; restart_index_ = num_restarts_;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; restart_index_--;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L104" title="table/block.cc:104">SeekToRestartPoint</a>(restart_index_);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">do</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Comment">// Loop until end of <a href="../db/version_set.h.html#L185" title="db/version_set.h:185">current</a> entry hits the start of original entry<br/></li>
<li></span>&nbsp; &nbsp; } <span class="Statement">while</span> (<a href="#L226" title="table/block.cc:226">ParseNextKey</a>() &amp;&amp; <a href="#L95" title="table/block.cc:95">NextEntryOffset</a>() &lt; original);<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li><a id="L165">&#x200c;</a>&nbsp; <span class="Type">virtual</span> <span class="Type">void</span> <span class="linkable">Seek</span>(<span class="Type">const</span> <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>&amp; <a href="../include/leveldb/env.h.html#L280" title="include/leveldb/env.h:280">target</a>) {<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// Binary search in restart array to find the last restart point<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">// with a <a href="two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a> &lt; <a href="../include/leveldb/env.h.html#L280" title="include/leveldb/env.h:280">target</a><br/></li>
<li></span>&nbsp; &nbsp; <span class="Type"><a href="../port/win/stdint.h.html#L21" title="port/win/stdint.h:21">uint32_t</a></span> left = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../port/win/stdint.h.html#L21" title="port/win/stdint.h:21">uint32_t</a></span> right = num_restarts_ - <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (left &lt; right) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Type"><a href="../port/win/stdint.h.html#L21" title="port/win/stdint.h:21">uint32_t</a></span> mid = (left + right + <span class="Constant">1</span>) / <span class="Constant">2</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Type"><a href="../port/win/stdint.h.html#L21" title="port/win/stdint.h:21">uint32_t</a></span> region_offset = <a href="#L99" title="table/block.cc:99">GetRestartPoint</a>(mid);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Type"><a href="../port/win/stdint.h.html#L21" title="port/win/stdint.h:21">uint32_t</a></span> shared, non_shared, value_length;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span>* key_ptr = <a href="#L53" title="table/block.cc:53">DecodeEntry</a>(data_ + region_offset,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; data_ + restarts_,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;shared, &amp;non_shared, &amp;value_length);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (key_ptr == <span class="Constant">NULL</span> || (shared != <span class="Constant">0</span>)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L218" title="table/block.cc:218">CorruptionError</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a> mid_key(key_ptr, non_shared);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="table_test.cc.html#L44" title="table/table_test.cc:44">Compare</a>(mid_key, <a href="../include/leveldb/env.h.html#L280" title="include/leveldb/env.h:280">target</a>) &lt; <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">// <a href="../db/autocompact_test.cc.html#L36" title="db/autocompact_test.cc:36">Key</a> at &quot;mid&quot; is smaller than &quot;<a href="../include/leveldb/env.h.html#L280" title="include/leveldb/env.h:280">target</a>&quot;.&nbsp; Therefore all<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">// blocks before &quot;mid&quot; are uninteresting.<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; left = mid;<br/></li>
<li>&nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">// <a href="../db/autocompact_test.cc.html#L36" title="db/autocompact_test.cc:36">Key</a> at &quot;mid&quot; is &gt;= &quot;<a href="../include/leveldb/env.h.html#L280" title="include/leveldb/env.h:280">target</a>&quot;.&nbsp; Therefore all blocks at or<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">// after &quot;mid&quot; are uninteresting.<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; right = mid - <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// Linear search (within restart block) for first <a href="two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a> &gt;= <a href="../include/leveldb/env.h.html#L280" title="include/leveldb/env.h:280">target</a><br/></li>
<li></span>&nbsp; &nbsp; <a href="#L104" title="table/block.cc:104">SeekToRestartPoint</a>(left);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (<span class="Constant">true</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!<a href="#L226" title="table/block.cc:226">ParseNextKey</a>()) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="table_test.cc.html#L44" title="table/table_test.cc:44">Compare</a>(key_, <a href="../include/leveldb/env.h.html#L280" title="include/leveldb/env.h:280">target</a>) &gt;= <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li><a id="L205">&#x200c;</a>&nbsp; <span class="Type">virtual</span> <span class="Type">void</span> <span class="linkable">SeekToFirst</span>() {<br/></li>
<li>&nbsp; &nbsp; <a href="#L104" title="table/block.cc:104">SeekToRestartPoint</a>(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="#L226" title="table/block.cc:226">ParseNextKey</a>();<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li><a id="L210">&#x200c;</a>&nbsp; <span class="Type">virtual</span> <span class="Type">void</span> <span class="linkable">SeekToLast</span>() {<br/></li>
<li>&nbsp; &nbsp; <a href="#L104" title="table/block.cc:104">SeekToRestartPoint</a>(num_restarts_ - <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (<a href="#L226" title="table/block.cc:226">ParseNextKey</a>() &amp;&amp; <a href="#L95" title="table/block.cc:95">NextEntryOffset</a>() &lt; restarts_) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Comment">// Keep skipping<br/></li>
<li></span>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li><span class="cUserCont"> </span><span class="Statement">private</span><span class="cUserCont">:<br/></li>
<li><a id="L218">&#x200c;</a></span>&nbsp; <span class="Type">void</span> <span class="linkable">CorruptionError</span>() {<br/></li>
<li>&nbsp; &nbsp; current_ = restarts_;<br/></li>
<li>&nbsp; &nbsp; restart_index_ = num_restarts_;<br/></li>
<li>&nbsp; &nbsp; status_ = <a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a>::<a href="../include/leveldb/status.h.html#L38" title="include/leveldb/status.h:38">Corruption</a>(<span class="Constant">&quot;bad entry in block&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; key_.<a href="../include/leveldb/slice.h.html#L56" title="include/leveldb/slice.h:56">clear</a>();<br/></li>
<li>&nbsp; &nbsp; value_.<a href="../include/leveldb/slice.h.html#L56" title="include/leveldb/slice.h:56">clear</a>();<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li><a id="L226">&#x200c;</a>&nbsp; <span class="Type">bool</span> <span class="linkable">ParseNextKey</span>() {<br/></li>
<li>&nbsp; &nbsp; current_ = <a href="#L95" title="table/block.cc:95">NextEntryOffset</a>();<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span>* p = data_ + current_;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span>* limit = data_ + restarts_;&nbsp; <span class="Comment">// Restarts come right after <a href="table_test.cc.html#L173" title="table/table_test.cc:173">data</a><br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (p &gt;= limit) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Comment">// No more entries to return.&nbsp; Mark as invalid.<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; current_ = restarts_;<br/></li>
<li>&nbsp; &nbsp; &nbsp; restart_index_ = num_restarts_;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">false</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// Decode next entry<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type"><a href="../port/win/stdint.h.html#L21" title="port/win/stdint.h:21">uint32_t</a></span> shared, non_shared, value_length;<br/></li>
<li>&nbsp; &nbsp; p = <a href="#L53" title="table/block.cc:53">DecodeEntry</a>(p, limit, &amp;shared, &amp;non_shared, &amp;value_length);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (p == <span class="Constant">NULL</span> || key_.<a href="format.h.html#L31" title="table/format.h:31">size</a>() &lt; shared) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L218" title="table/block.cc:218">CorruptionError</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">false</span>;<br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; key_.resize(shared);<br/></li>
<li>&nbsp; &nbsp; &nbsp; key_.append(p, non_shared);<br/></li>
<li>&nbsp; &nbsp; &nbsp; value_ = <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>(p + non_shared, value_length);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">while</span> (restart_index_ + <span class="Constant">1</span> &lt; num_restarts_ &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L99" title="table/block.cc:99">GetRestartPoint</a>(restart_index_ + <span class="Constant">1</span>) &lt; current_) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ++restart_index_;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>};<br/></li>
<li><br/></li>
<li><a id="L256">&#x200c;</a><a href="iterator.cc.html#L9" title="table/iterator.cc:9">Iterator</a>* <a href="#L23" title="table/block.cc:23">Block</a>::<span class="linkable">NewIterator</span>(<span class="Type">const</span> <a href="../db/skiplist_test.cc.html#L17" title="db/skiplist_test.cc:17">Comparator</a>* cmp) {<br/></li>
<li>&nbsp; <span class="Statement">if</span> (size_ &lt; <span class="Statement">sizeof</span>(<span class="Type"><a href="../port/win/stdint.h.html#L21" title="port/win/stdint.h:21">uint32_t</a></span>)) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="iterator.cc.html#L63" title="table/iterator.cc:63">NewErrorIterator</a>(<a href="../include/leveldb/status.h.html#L24" title="include/leveldb/status.h:24">Status</a>::<a href="../include/leveldb/status.h.html#L38" title="include/leveldb/status.h:38">Corruption</a>(<span class="Constant">&quot;bad block <a href="table_test.cc.html#L94" title="table/table_test.cc:94">contents</a>&quot;</span>));<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type"><a href="../port/win/stdint.h.html#L21" title="port/win/stdint.h:21">uint32_t</a></span> num_restarts = <a href="#L18" title="table/block.cc:18">NumRestarts</a>();<br/></li>
<li>&nbsp; <span class="Statement">if</span> (num_restarts == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="iterator.cc.html#L59" title="table/iterator.cc:59">NewEmptyIterator</a>();<br/></li>
<li>&nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Statement">new</span> <a href="#L115" title="table/block.cc:115">Iter</a>(cmp, data_, restart_offset_, num_restarts);<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li>}&nbsp; <span class="Comment">// namespace leveldb<br/></li>
</ol></span></code>
 </body>
</html>
