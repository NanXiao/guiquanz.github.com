<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>util/cache_test.cc - leveldb-1.18</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

code {
    font-family: consolas, monospace;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
  <h3>util/cache_test.cc - leveldb-1.18</h3>
   <a href="../index.html"> Table of Contents </a>
 <h4>Functions defined</h4>
 <ul>
<li><a href="#L40">CacheTest</a></li>
<li><a href="#L19">DecodeKey</a></li>
<li><a href="#L24">DecodeValue</a></li>
<li><a href="#L30">Deleter</a></li>
<li><a href="#L14">EncodeKey</a></li>
<li><a href="#L23">EncodeValue</a></li>
<li><a href="#L62">Erase</a></li>
<li><a href="#L57">Insert</a></li>
<li><a href="#L48">Lookup</a></li>
<li><a href="#L68">TEST(CacheTest, HitAndMiss) {</a></li>
<li><a href="#L91">TEST(CacheTest, Erase) {</a></li>
<li><a href="#L110">TEST(CacheTest, EntriesArePinned) {</a></li>
<li><a href="#L135">TEST(CacheTest, EvictionPolicy) {</a></li>
<li><a href="#L149">TEST(CacheTest, HeavyEntries) {</a></li>
<li><a href="#L176">TEST(CacheTest, NewId) {</a></li>
<li><a href="#L184">main</a></li>
<li><a href="#L44">~CacheTest</a></li>
</ul>
 <h4>Source code</h4>

  <code><ol><li><span class="Comment">// Copyright (c) 2011 The LevelDB Authors. All rights reserved.<br/></li>
<li></span><span class="Comment">// Use of this source <a href="../include/leveldb/status.h.html#L84" title="include/leveldb/status.h:84">code</a> is governed by a BSD-style license that can be<br/></li>
<li></span><span class="Comment">// found in the LICENSE file. See the AUTHORS file for names of contributors.<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;leveldb/cache.h&quot;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;vector&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;util/coding.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;util/testharness.h&quot;<br/></li>
<li></span><br/></li>
<li><span class="Type">namespace</span> leveldb {<br/></li>
<li><br/></li>
<li><span class="Comment">// Conversions between numeric keys/values and the types expected by <a href="../include/leveldb/cache.h.html#L34" title="include/leveldb/cache.h:34">Cache</a>.<br/></li>
<li><a id="L14">&#x200c;</a></span><span class="Type">static</span> std::string <span class="linkable">EncodeKey</span>(<span class="Type">int</span> k) {<br/></li>
<li>&nbsp; std::string result;<br/></li>
<li>&nbsp; <a href="coding.cc.html#L35" title="util/coding.cc:35">PutFixed32</a>(&amp;result, k);<br/></li>
<li>&nbsp; <span class="Statement">return</span> result;<br/></li>
<li>}<br/></li>
<li><a id="L19">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">DecodeKey</span>(<span class="Type">const</span> <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>&amp; k) {<br/></li>
<li>&nbsp; assert(k.<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>() == <span class="Constant">4</span>);<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="coding.h.html#L58" title="util/coding.h:58">DecodeFixed32</a>(k.<a href="../table/table_test.cc.html#L173" title="table/table_test.cc:173">data</a>());<br/></li>
<li>}<br/></li>
<li><a id="L23">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span>* <span class="linkable">EncodeValue</span>(<span class="Type">uintptr_t</span> v) { <span class="Statement">return</span> <span class="Statement">reinterpret_cast</span>&lt;<span class="Type">void</span>*&gt;(v); }<br/></li>
<li><a id="L24">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">DecodeValue</span>(<span class="Type">void</span>* v) { <span class="Statement">return</span> <span class="Statement">reinterpret_cast</span>&lt;<span class="Type">uintptr_t</span>&gt;(v); }<br/></li>
<li><br/></li>
<li><span class="Type">class</span> <a href="#L40" title="util/cache_test.cc:40">CacheTest</a> {<br/></li>
<li><span class="cUserCont"> </span><span class="Statement">public</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; <span class="Type">static</span> <a href="#L40" title="util/cache_test.cc:40">CacheTest</a>* current_;<br/></li>
<li><br/></li>
<li><a id="L30">&#x200c;</a>&nbsp; <span class="Type">static</span> <span class="Type">void</span> <span class="linkable">Deleter</span>(<span class="Type">const</span> <a href="../include/leveldb/slice.h.html#L28" title="include/leveldb/slice.h:28">Slice</a>&amp; <a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>, <span class="Type">void</span>* v) {<br/></li>
<li>&nbsp; &nbsp; current_-&gt;deleted_keys_.push_back(<a href="#L19" title="util/cache_test.cc:19">DecodeKey</a>(<a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>));<br/></li>
<li>&nbsp; &nbsp; current_-&gt;deleted_values_.push_back(<a href="#L24" title="util/cache_test.cc:24">DecodeValue</a>(v));<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Type">static</span> <span class="Type">const</span> <span class="Type">int</span> kCacheSize = <span class="Constant">1000</span>;<br/></li>
<li>&nbsp; std::vector&lt;<span class="Type">int</span>&gt; deleted_keys_;<br/></li>
<li>&nbsp; std::vector&lt;<span class="Type">int</span>&gt; deleted_values_;<br/></li>
<li>&nbsp; <a href="../include/leveldb/cache.h.html#L34" title="include/leveldb/cache.h:34">Cache</a>* cache_;<br/></li>
<li><br/></li>
<li><a id="L40">&#x200c;</a>&nbsp; <span class="linkable">CacheTest</span>() : cache_(<a href="cache.cc.html#L321" title="util/cache.cc:321">NewLRUCache</a>(kCacheSize)) {<br/></li>
<li>&nbsp; &nbsp; current_ = <span class="Statement">this</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li><a id="L44">&#x200c;</a>&nbsp; ~<a href="#L40" title="util/cache_test.cc:40">CacheTest</a>() {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">delete</span> cache_;<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li><a id="L48">&#x200c;</a>&nbsp; <span class="Type">int</span> <span class="linkable">Lookup</span>(<span class="Type">int</span> <a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>) {<br/></li>
<li>&nbsp; &nbsp; <a href="../include/leveldb/cache.h.html#L34" title="include/leveldb/cache.h:34">Cache</a>::<a href="../include/leveldb/cache.h.html#L41" title="include/leveldb/cache.h:41">Handle</a>* handle = cache_-&gt;<a href="cache.cc.html#L58" title="util/cache.cc:58">Lookup</a>(<a href="../db/memtable.cc.html#L44" title="db/memtable.cc:44">EncodeKey</a>(<a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <span class="Type">int</span> r = (handle == <span class="Constant">NULL</span>) ? -<span class="Constant">1</span> : <a href="#L24" title="util/cache_test.cc:24">DecodeValue</a>(cache_-&gt;<a href="../db/corruption_test.cc.html#L196" title="db/corruption_test.cc:196">Value</a>(handle));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (handle != <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; cache_-&gt;<a href="cache.cc.html#L220" title="util/cache.cc:220">Release</a>(handle);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> r;<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li><a id="L57">&#x200c;</a>&nbsp; <span class="Type">void</span> <span class="linkable">Insert</span>(<span class="Type">int</span> <a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>, <span class="Type">int</span> <a href="../table/two_level_iterator.cc.html#L41" title="table/two_level_iterator.cc:41">value</a>, <span class="Type">int</span> charge = <span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; cache_-&gt;<a href="cache.cc.html#L220" title="util/cache.cc:220">Release</a>(cache_-&gt;<a href="../db/skiplist.h.html#L337" title="db/skiplist.h:337">Insert</a>(<a href="../db/memtable.cc.html#L44" title="db/memtable.cc:44">EncodeKey</a>(<a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>), <a href="#L23" title="util/cache_test.cc:23">EncodeValue</a>(<a href="../table/two_level_iterator.cc.html#L41" title="table/two_level_iterator.cc:41">value</a>), charge,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;<a href="#L40" title="util/cache_test.cc:40">CacheTest</a>::<a href="#L30" title="util/cache_test.cc:30">Deleter</a>));<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li><a id="L62">&#x200c;</a>&nbsp; <span class="Type">void</span> <span class="linkable">Erase</span>(<span class="Type">int</span> <a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>) {<br/></li>
<li>&nbsp; &nbsp; cache_-&gt;<a href="cache.cc.html#L258" title="util/cache.cc:258">Erase</a>(<a href="../db/memtable.cc.html#L44" title="db/memtable.cc:44">EncodeKey</a>(<a href="../table/two_level_iterator.cc.html#L37" title="table/two_level_iterator.cc:37">key</a>));<br/></li>
<li>&nbsp; }<br/></li>
<li>};<br/></li>
<li><a href="#L40" title="util/cache_test.cc:40">CacheTest</a>* <a href="#L40" title="util/cache_test.cc:40">CacheTest</a>::current_;<br/></li>
<li><br/></li>
<li><a id="L68">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L40" title="util/cache_test.cc:40">CacheTest</a>, HitAndMiss) {<br/></li>
<li>&nbsp; <a href="testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(-<span class="Constant">1</span>, <a href="cache.cc.html#L58" title="util/cache.cc:58">Lookup</a>(<span class="Constant">100</span>));<br/></li>
<li><br/></li>
<li>&nbsp; <a href="../db/skiplist.h.html#L337" title="db/skiplist.h:337">Insert</a>(<span class="Constant">100</span>, <span class="Constant">101</span>);<br/></li>
<li>&nbsp; <a href="testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">101</span>, <a href="cache.cc.html#L58" title="util/cache.cc:58">Lookup</a>(<span class="Constant">100</span>));<br/></li>
<li>&nbsp; <a href="testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(-<span class="Constant">1</span>,&nbsp; <a href="cache.cc.html#L58" title="util/cache.cc:58">Lookup</a>(<span class="Constant">200</span>));<br/></li>
<li>&nbsp; <a href="testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(-<span class="Constant">1</span>,&nbsp; <a href="cache.cc.html#L58" title="util/cache.cc:58">Lookup</a>(<span class="Constant">300</span>));<br/></li>
<li><br/></li>
<li>&nbsp; <a href="../db/skiplist.h.html#L337" title="db/skiplist.h:337">Insert</a>(<span class="Constant">200</span>, <span class="Constant">201</span>);<br/></li>
<li>&nbsp; <a href="testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">101</span>, <a href="cache.cc.html#L58" title="util/cache.cc:58">Lookup</a>(<span class="Constant">100</span>));<br/></li>
<li>&nbsp; <a href="testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">201</span>, <a href="cache.cc.html#L58" title="util/cache.cc:58">Lookup</a>(<span class="Constant">200</span>));<br/></li>
<li>&nbsp; <a href="testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(-<span class="Constant">1</span>,&nbsp; <a href="cache.cc.html#L58" title="util/cache.cc:58">Lookup</a>(<span class="Constant">300</span>));<br/></li>
<li><br/></li>
<li>&nbsp; <a href="../db/skiplist.h.html#L337" title="db/skiplist.h:337">Insert</a>(<span class="Constant">100</span>, <span class="Constant">102</span>);<br/></li>
<li>&nbsp; <a href="testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">102</span>, <a href="cache.cc.html#L58" title="util/cache.cc:58">Lookup</a>(<span class="Constant">100</span>));<br/></li>
<li>&nbsp; <a href="testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">201</span>, <a href="cache.cc.html#L58" title="util/cache.cc:58">Lookup</a>(<span class="Constant">200</span>));<br/></li>
<li>&nbsp; <a href="testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(-<span class="Constant">1</span>,&nbsp; <a href="cache.cc.html#L58" title="util/cache.cc:58">Lookup</a>(<span class="Constant">300</span>));<br/></li>
<li><br/></li>
<li>&nbsp; <a href="testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">1</span>, deleted_keys_.<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>());<br/></li>
<li>&nbsp; <a href="testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">100</span>, deleted_keys_[<span class="Constant">0</span>]);<br/></li>
<li>&nbsp; <a href="testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">101</span>, deleted_values_[<span class="Constant">0</span>]);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L91">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L40" title="util/cache_test.cc:40">CacheTest</a>, <a href="cache.cc.html#L258" title="util/cache.cc:258">Erase</a>) {<br/></li>
<li>&nbsp; <a href="cache.cc.html#L258" title="util/cache.cc:258">Erase</a>(<span class="Constant">200</span>);<br/></li>
<li>&nbsp; <a href="testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">0</span>, deleted_keys_.<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>());<br/></li>
<li><br/></li>
<li>&nbsp; <a href="../db/skiplist.h.html#L337" title="db/skiplist.h:337">Insert</a>(<span class="Constant">100</span>, <span class="Constant">101</span>);<br/></li>
<li>&nbsp; <a href="../db/skiplist.h.html#L337" title="db/skiplist.h:337">Insert</a>(<span class="Constant">200</span>, <span class="Constant">201</span>);<br/></li>
<li>&nbsp; <a href="cache.cc.html#L258" title="util/cache.cc:258">Erase</a>(<span class="Constant">100</span>);<br/></li>
<li>&nbsp; <a href="testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(-<span class="Constant">1</span>,&nbsp; <a href="cache.cc.html#L58" title="util/cache.cc:58">Lookup</a>(<span class="Constant">100</span>));<br/></li>
<li>&nbsp; <a href="testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">201</span>, <a href="cache.cc.html#L58" title="util/cache.cc:58">Lookup</a>(<span class="Constant">200</span>));<br/></li>
<li>&nbsp; <a href="testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">1</span>, deleted_keys_.<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>());<br/></li>
<li>&nbsp; <a href="testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">100</span>, deleted_keys_[<span class="Constant">0</span>]);<br/></li>
<li>&nbsp; <a href="testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">101</span>, deleted_values_[<span class="Constant">0</span>]);<br/></li>
<li><br/></li>
<li>&nbsp; <a href="cache.cc.html#L258" title="util/cache.cc:258">Erase</a>(<span class="Constant">100</span>);<br/></li>
<li>&nbsp; <a href="testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(-<span class="Constant">1</span>,&nbsp; <a href="cache.cc.html#L58" title="util/cache.cc:58">Lookup</a>(<span class="Constant">100</span>));<br/></li>
<li>&nbsp; <a href="testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">201</span>, <a href="cache.cc.html#L58" title="util/cache.cc:58">Lookup</a>(<span class="Constant">200</span>));<br/></li>
<li>&nbsp; <a href="testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">1</span>, deleted_keys_.<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>());<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L110">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L40" title="util/cache_test.cc:40">CacheTest</a>, EntriesArePinned) {<br/></li>
<li>&nbsp; <a href="../db/skiplist.h.html#L337" title="db/skiplist.h:337">Insert</a>(<span class="Constant">100</span>, <span class="Constant">101</span>);<br/></li>
<li>&nbsp; <a href="../include/leveldb/cache.h.html#L34" title="include/leveldb/cache.h:34">Cache</a>::<a href="../include/leveldb/cache.h.html#L41" title="include/leveldb/cache.h:41">Handle</a>* h1 = cache_-&gt;<a href="cache.cc.html#L58" title="util/cache.cc:58">Lookup</a>(<a href="../db/memtable.cc.html#L44" title="db/memtable.cc:44">EncodeKey</a>(<span class="Constant">100</span>));<br/></li>
<li>&nbsp; <a href="testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">101</span>, <a href="#L24" title="util/cache_test.cc:24">DecodeValue</a>(cache_-&gt;<a href="../db/corruption_test.cc.html#L196" title="db/corruption_test.cc:196">Value</a>(h1)));<br/></li>
<li><br/></li>
<li>&nbsp; <a href="../db/skiplist.h.html#L337" title="db/skiplist.h:337">Insert</a>(<span class="Constant">100</span>, <span class="Constant">102</span>);<br/></li>
<li>&nbsp; <a href="../include/leveldb/cache.h.html#L34" title="include/leveldb/cache.h:34">Cache</a>::<a href="../include/leveldb/cache.h.html#L41" title="include/leveldb/cache.h:41">Handle</a>* h2 = cache_-&gt;<a href="cache.cc.html#L58" title="util/cache.cc:58">Lookup</a>(<a href="../db/memtable.cc.html#L44" title="db/memtable.cc:44">EncodeKey</a>(<span class="Constant">100</span>));<br/></li>
<li>&nbsp; <a href="testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">102</span>, <a href="#L24" title="util/cache_test.cc:24">DecodeValue</a>(cache_-&gt;<a href="../db/corruption_test.cc.html#L196" title="db/corruption_test.cc:196">Value</a>(h2)));<br/></li>
<li>&nbsp; <a href="testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">0</span>, deleted_keys_.<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>());<br/></li>
<li><br/></li>
<li>&nbsp; cache_-&gt;<a href="cache.cc.html#L220" title="util/cache.cc:220">Release</a>(h1);<br/></li>
<li>&nbsp; <a href="testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">1</span>, deleted_keys_.<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>());<br/></li>
<li>&nbsp; <a href="testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">100</span>, deleted_keys_[<span class="Constant">0</span>]);<br/></li>
<li>&nbsp; <a href="testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">101</span>, deleted_values_[<span class="Constant">0</span>]);<br/></li>
<li><br/></li>
<li>&nbsp; <a href="cache.cc.html#L258" title="util/cache.cc:258">Erase</a>(<span class="Constant">100</span>);<br/></li>
<li>&nbsp; <a href="testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(-<span class="Constant">1</span>, <a href="cache.cc.html#L58" title="util/cache.cc:58">Lookup</a>(<span class="Constant">100</span>));<br/></li>
<li>&nbsp; <a href="testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">1</span>, deleted_keys_.<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>());<br/></li>
<li><br/></li>
<li>&nbsp; cache_-&gt;<a href="cache.cc.html#L220" title="util/cache.cc:220">Release</a>(h2);<br/></li>
<li>&nbsp; <a href="testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">2</span>, deleted_keys_.<a href="../table/format.h.html#L31" title="table/format.h:31">size</a>());<br/></li>
<li>&nbsp; <a href="testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">100</span>, deleted_keys_[<span class="Constant">1</span>]);<br/></li>
<li>&nbsp; <a href="testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">102</span>, deleted_values_[<span class="Constant">1</span>]);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L135">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L40" title="util/cache_test.cc:40">CacheTest</a>, EvictionPolicy) {<br/></li>
<li>&nbsp; <a href="../db/skiplist.h.html#L337" title="db/skiplist.h:337">Insert</a>(<span class="Constant">100</span>, <span class="Constant">101</span>);<br/></li>
<li>&nbsp; <a href="../db/skiplist.h.html#L337" title="db/skiplist.h:337">Insert</a>(<span class="Constant">200</span>, <span class="Constant">201</span>);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// Frequently used entry must be kept around<br/></li>
<li></span>&nbsp; <span class="Statement">for</span> (<span class="Type">int</span> i = <span class="Constant">0</span>; i &lt; kCacheSize + <span class="Constant">100</span>; i++) {<br/></li>
<li>&nbsp; &nbsp; <a href="../db/skiplist.h.html#L337" title="db/skiplist.h:337">Insert</a>(<span class="Constant">1000</span>+i, <span class="Constant">2000</span>+i);<br/></li>
<li>&nbsp; &nbsp; <a href="testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">2000</span>+i, <a href="cache.cc.html#L58" title="util/cache.cc:58">Lookup</a>(<span class="Constant">1000</span>+i));<br/></li>
<li>&nbsp; &nbsp; <a href="testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">101</span>, <a href="cache.cc.html#L58" title="util/cache.cc:58">Lookup</a>(<span class="Constant">100</span>));<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <a href="testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">101</span>, <a href="cache.cc.html#L58" title="util/cache.cc:58">Lookup</a>(<span class="Constant">100</span>));<br/></li>
<li>&nbsp; <a href="testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(-<span class="Constant">1</span>, <a href="cache.cc.html#L58" title="util/cache.cc:58">Lookup</a>(<span class="Constant">200</span>));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L149">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L40" title="util/cache_test.cc:40">CacheTest</a>, HeavyEntries) {<br/></li>
<li>&nbsp; <span class="Comment">// <a href="../table/table_test.cc.html#L146" title="table/table_test.cc:146">Add</a> a bunch of light and heavy entries and then count the combined<br/></li>
<li></span>&nbsp; <span class="Comment">// <a href="../table/format.h.html#L31" title="table/format.h:31">size</a> of items still in the cache, which must be approximately the<br/></li>
<li></span>&nbsp; <span class="Comment">// same as the total capacity.<br/></li>
<li></span>&nbsp; <span class="Type">const</span> <span class="Type">int</span> kLight = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">int</span> kHeavy = <span class="Constant">10</span>;<br/></li>
<li>&nbsp; <span class="Type">int</span> added = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; <span class="Type">int</span> index = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; <span class="Statement">while</span> (added &lt; <span class="Constant">2</span>*kCacheSize) {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <span class="Type">int</span> weight = (index &amp; <span class="Constant">1</span>) ? kLight : kHeavy;<br/></li>
<li>&nbsp; &nbsp; <a href="../db/skiplist.h.html#L337" title="db/skiplist.h:337">Insert</a>(index, <span class="Constant">1000</span>+index, weight);<br/></li>
<li>&nbsp; &nbsp; added += weight;<br/></li>
<li>&nbsp; &nbsp; index++;<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Type">int</span> cached_weight = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; <span class="Statement">for</span> (<span class="Type">int</span> i = <span class="Constant">0</span>; i &lt; index; i++) {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <span class="Type">int</span> weight = (i &amp; <span class="Constant">1</span> ? kLight : kHeavy);<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span> r = <a href="cache.cc.html#L58" title="util/cache.cc:58">Lookup</a>(i);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r &gt;= <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; cached_weight += weight;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="testharness.h.html#L107" title="util/testharness.h:107">ASSERT_EQ</a>(<span class="Constant">1000</span>+i, r);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <a href="testharness.h.html#L111" title="util/testharness.h:111">ASSERT_LE</a>(cached_weight, kCacheSize + kCacheSize/<span class="Constant">10</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L176">&#x200c;</a><span class="linkable">TEST</span>(<a href="#L40" title="util/cache_test.cc:40">CacheTest</a>, <a href="cache.cc.html#L313" title="util/cache.cc:313">NewId</a>) {<br/></li>
<li>&nbsp; <span class="Type"><a href="../port/win/stdint.h.html#L22" title="port/win/stdint.h:22">uint64_t</a></span> a = cache_-&gt;<a href="cache.cc.html#L313" title="util/cache.cc:313">NewId</a>();<br/></li>
<li>&nbsp; <span class="Type"><a href="../port/win/stdint.h.html#L22" title="port/win/stdint.h:22">uint64_t</a></span> b = cache_-&gt;<a href="cache.cc.html#L313" title="util/cache.cc:313">NewId</a>();<br/></li>
<li>&nbsp; <a href="testharness.h.html#L108" title="util/testharness.h:108">ASSERT_NE</a>(a, b);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li>}&nbsp; <span class="Comment">// namespace leveldb<br/></li>
<li></span><br/></li>
<li><a id="L184">&#x200c;</a><span class="Type">int</span> <span class="linkable">main</span>(<span class="Type">int</span> argc, <span class="Type">char</span>** argv) {<br/></li>
<li>&nbsp; <span class="Statement">return</span> leveldb::test::<a href="testharness.cc.html#L36" title="util/testharness.cc:36">RunAllTests</a>();<br/></li>
<li>}<br/></li>
</ol></code>
 </body>
</html>
