<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>util/histogram.cc - leveldb-1.18</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

code {
    font-family: consolas, monospace;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
  <h3>util/histogram.cc - leveldb-1.18</h3>
   <a href="../index.html"> Table of Contents </a>
 <h4>Functions defined</h4>
 <ul>
<li><a href="#L44">Add</a></li>
<li><a href="#L94">Average</a></li>
<li><a href="#L33">Clear</a></li>
<li><a href="#L69">Median</a></li>
<li><a href="#L58">Merge</a></li>
<li><a href="#L73">Percentile</a></li>
<li><a href="#L99">StandardDeviation</a></li>
<li><a href="#L105">ToString</a></li>
</ul>
 <h4>Source code</h4>

  <code><ol><li><span class="Comment">// Copyright (c) 2011 The LevelDB Authors. All rights reserved.<br/></li>
<li></span><span class="Comment">// Use of this source <a href="../include/leveldb/status.h.html#L84" title="include/leveldb/status.h:84">code</a> is governed by a BSD-style license that can be<br/></li>
<li></span><span class="Comment">// found in the LICENSE file. See the AUTHORS file for names of contributors.<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;math.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;stdio.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;port/port.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;util/histogram.h&quot;<br/></li>
<li></span><br/></li>
<li><span class="Type">namespace</span> leveldb {<br/></li>
<li><br/></li>
<li><span class="Type">const</span> <span class="Type">double</span> <a href="histogram.h.html#L14" title="util/histogram.h:14">Histogram</a>::kBucketLimit[kNumBuckets] = {<br/></li>
<li>&nbsp; <span class="Constant">1</span>, <span class="Constant">2</span>, <span class="Constant">3</span>, <span class="Constant">4</span>, <span class="Constant">5</span>, <span class="Constant">6</span>, <span class="Constant">7</span>, <span class="Constant">8</span>, <span class="Constant">9</span>, <span class="Constant">10</span>, <span class="Constant">12</span>, <span class="Constant">14</span>, <span class="Constant">16</span>, <span class="Constant">18</span>, <span class="Constant">20</span>, <span class="Constant">25</span>, <span class="Constant">30</span>, <span class="Constant">35</span>, <span class="Constant">40</span>, <span class="Constant">45</span>,<br/></li>
<li>&nbsp; <span class="Constant">50</span>, <span class="Constant">60</span>, <span class="Constant">70</span>, <span class="Constant">80</span>, <span class="Constant">90</span>, <span class="Constant">100</span>, <span class="Constant">120</span>, <span class="Constant">140</span>, <span class="Constant">160</span>, <span class="Constant">180</span>, <span class="Constant">200</span>, <span class="Constant">250</span>, <span class="Constant">300</span>, <span class="Constant">350</span>, <span class="Constant">400</span>, <span class="Constant">450</span>,<br/></li>
<li>&nbsp; <span class="Constant">500</span>, <span class="Constant">600</span>, <span class="Constant">700</span>, <span class="Constant">800</span>, <span class="Constant">900</span>, <span class="Constant">1000</span>, <span class="Constant">1200</span>, <span class="Constant">1400</span>, <span class="Constant">1600</span>, <span class="Constant">1800</span>, <span class="Constant">2000</span>, <span class="Constant">2500</span>, <span class="Constant">3000</span>,<br/></li>
<li>&nbsp; <span class="Constant">3500</span>, <span class="Constant">4000</span>, <span class="Constant">4500</span>, <span class="Constant">5000</span>, <span class="Constant">6000</span>, <span class="Constant">7000</span>, <span class="Constant">8000</span>, <span class="Constant">9000</span>, <span class="Constant">10000</span>, <span class="Constant">12000</span>, <span class="Constant">14000</span>,<br/></li>
<li>&nbsp; <span class="Constant">16000</span>, <span class="Constant">18000</span>, <span class="Constant">20000</span>, <span class="Constant">25000</span>, <span class="Constant">30000</span>, <span class="Constant">35000</span>, <span class="Constant">40000</span>, <span class="Constant">45000</span>, <span class="Constant">50000</span>, <span class="Constant">60000</span>,<br/></li>
<li>&nbsp; <span class="Constant">70000</span>, <span class="Constant">80000</span>, <span class="Constant">90000</span>, <span class="Constant">100000</span>, <span class="Constant">120000</span>, <span class="Constant">140000</span>, <span class="Constant">160000</span>, <span class="Constant">180000</span>, <span class="Constant">200000</span>,<br/></li>
<li>&nbsp; <span class="Constant">250000</span>, <span class="Constant">300000</span>, <span class="Constant">350000</span>, <span class="Constant">400000</span>, <span class="Constant">450000</span>, <span class="Constant">500000</span>, <span class="Constant">600000</span>, <span class="Constant">700000</span>, <span class="Constant">800000</span>,<br/></li>
<li>&nbsp; <span class="Constant">900000</span>, <span class="Constant">1000000</span>, <span class="Constant">1200000</span>, <span class="Constant">1400000</span>, <span class="Constant">1600000</span>, <span class="Constant">1800000</span>, <span class="Constant">2000000</span>, <span class="Constant">2500000</span>,<br/></li>
<li>&nbsp; <span class="Constant">3000000</span>, <span class="Constant">3500000</span>, <span class="Constant">4000000</span>, <span class="Constant">4500000</span>, <span class="Constant">5000000</span>, <span class="Constant">6000000</span>, <span class="Constant">7000000</span>, <span class="Constant">8000000</span>,<br/></li>
<li>&nbsp; <span class="Constant">9000000</span>, <span class="Constant">10000000</span>, <span class="Constant">12000000</span>, <span class="Constant">14000000</span>, <span class="Constant">16000000</span>, <span class="Constant">18000000</span>, <span class="Constant">20000000</span>,<br/></li>
<li>&nbsp; <span class="Constant">25000000</span>, <span class="Constant">30000000</span>, <span class="Constant">35000000</span>, <span class="Constant">40000000</span>, <span class="Constant">45000000</span>, <span class="Constant">50000000</span>, <span class="Constant">60000000</span>,<br/></li>
<li>&nbsp; <span class="Constant">70000000</span>, <span class="Constant">80000000</span>, <span class="Constant">90000000</span>, <span class="Constant">100000000</span>, <span class="Constant">120000000</span>, <span class="Constant">140000000</span>, <span class="Constant">160000000</span>,<br/></li>
<li>&nbsp; <span class="Constant">180000000</span>, <span class="Constant">200000000</span>, <span class="Constant">250000000</span>, <span class="Constant">300000000</span>, <span class="Constant">350000000</span>, <span class="Constant">400000000</span>,<br/></li>
<li>&nbsp; <span class="Constant">450000000</span>, <span class="Constant">500000000</span>, <span class="Constant">600000000</span>, <span class="Constant">700000000</span>, <span class="Constant">800000000</span>, <span class="Constant">900000000</span>,<br/></li>
<li>&nbsp; <span class="Constant">1000000000</span>, <span class="Constant">1200000000</span>, <span class="Constant">1400000000</span>, <span class="Constant">1600000000</span>, <span class="Constant">1800000000</span>, <span class="Constant">2000000000</span>,<br/></li>
<li>&nbsp; <span class="Constant">2500000000.0</span>, <span class="Constant">3000000000.0</span>, <span class="Constant">3500000000.0</span>, <span class="Constant">4000000000.0</span>, <span class="Constant">4500000000.0</span>,<br/></li>
<li>&nbsp; <span class="Constant">5000000000.0</span>, <span class="Constant">6000000000.0</span>, <span class="Constant">7000000000.0</span>, <span class="Constant">8000000000.0</span>, <span class="Constant">9000000000.0</span>,<br/></li>
<li>&nbsp; <span class="Constant">1e200</span>,<br/></li>
<li>};<br/></li>
<li><br/></li>
<li><a id="L33">&#x200c;</a><span class="Type">void</span> <a href="histogram.h.html#L14" title="util/histogram.h:14">Histogram</a>::<span class="linkable">Clear</span>() {<br/></li>
<li>&nbsp; min_ = kBucketLimit[kNumBuckets-<span class="Constant">1</span>];<br/></li>
<li>&nbsp; max_ = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; num_ = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; sum_ = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; sum_squares_ = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; <span class="Statement">for</span> (<span class="Type">int</span> i = <span class="Constant">0</span>; i &lt; kNumBuckets; i++) {<br/></li>
<li>&nbsp; &nbsp; buckets_[i] = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L44">&#x200c;</a><span class="Type">void</span> <a href="histogram.h.html#L14" title="util/histogram.h:14">Histogram</a>::<span class="linkable">Add</span>(<span class="Type">double</span> <a href="../table/two_level_iterator.cc.html#L41" title="table/two_level_iterator.cc:41">value</a>) {<br/></li>
<li>&nbsp; <span class="Comment">// Linear search is fast enough for our usage in db_bench<br/></li>
<li></span>&nbsp; <span class="Type">int</span> b = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; <span class="Statement">while</span> (b &lt; kNumBuckets - <span class="Constant">1</span> &amp;&amp; kBucketLimit[b] &lt;= <a href="../table/two_level_iterator.cc.html#L41" title="table/two_level_iterator.cc:41">value</a>) {<br/></li>
<li>&nbsp; &nbsp; b++;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; buckets_[b] += <span class="Constant">1.0</span>;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (min_ &gt; <a href="../table/two_level_iterator.cc.html#L41" title="table/two_level_iterator.cc:41">value</a>) min_ = <a href="../table/two_level_iterator.cc.html#L41" title="table/two_level_iterator.cc:41">value</a>;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (max_ &lt; <a href="../table/two_level_iterator.cc.html#L41" title="table/two_level_iterator.cc:41">value</a>) max_ = <a href="../table/two_level_iterator.cc.html#L41" title="table/two_level_iterator.cc:41">value</a>;<br/></li>
<li>&nbsp; num_++;<br/></li>
<li>&nbsp; sum_ += <a href="../table/two_level_iterator.cc.html#L41" title="table/two_level_iterator.cc:41">value</a>;<br/></li>
<li>&nbsp; sum_squares_ += (<a href="../table/two_level_iterator.cc.html#L41" title="table/two_level_iterator.cc:41">value</a> * <a href="../table/two_level_iterator.cc.html#L41" title="table/two_level_iterator.cc:41">value</a>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L58">&#x200c;</a><span class="Type">void</span> <a href="histogram.h.html#L14" title="util/histogram.h:14">Histogram</a>::<span class="linkable">Merge</span>(<span class="Type">const</span> <a href="histogram.h.html#L14" title="util/histogram.h:14">Histogram</a>&amp; other) {<br/></li>
<li>&nbsp; <span class="Statement">if</span> (other.min_ &lt; min_) min_ = other.min_;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (other.max_ &gt; max_) max_ = other.max_;<br/></li>
<li>&nbsp; num_ += other.num_;<br/></li>
<li>&nbsp; sum_ += other.sum_;<br/></li>
<li>&nbsp; sum_squares_ += other.sum_squares_;<br/></li>
<li>&nbsp; <span class="Statement">for</span> (<span class="Type">int</span> b = <span class="Constant">0</span>; b &lt; kNumBuckets; b++) {<br/></li>
<li>&nbsp; &nbsp; buckets_[b] += other.buckets_[b];<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L69">&#x200c;</a><span class="Type">double</span> <a href="histogram.h.html#L14" title="util/histogram.h:14">Histogram</a>::<span class="linkable">Median</span>() <span class="Type">const</span> {<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="#L73" title="util/histogram.cc:73">Percentile</a>(<span class="Constant">50.0</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L73">&#x200c;</a><span class="Type">double</span> <a href="histogram.h.html#L14" title="util/histogram.h:14">Histogram</a>::<span class="linkable">Percentile</span>(<span class="Type">double</span> p) <span class="Type">const</span> {<br/></li>
<li>&nbsp; <span class="Type">double</span> threshold = num_ * (p / <span class="Constant">100.0</span>);<br/></li>
<li>&nbsp; <span class="Type">double</span> sum = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; <span class="Statement">for</span> (<span class="Type">int</span> b = <span class="Constant">0</span>; b &lt; kNumBuckets; b++) {<br/></li>
<li>&nbsp; &nbsp; sum += buckets_[b];<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (sum &gt;= threshold) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Comment">// Scale linearly within this bucket<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Type">double</span> left_point = (b == <span class="Constant">0</span>) ? <span class="Constant">0</span> : kBucketLimit[b-<span class="Constant">1</span>];<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Type">double</span> right_point = kBucketLimit[b];<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Type">double</span> left_sum = sum - buckets_[b];<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Type">double</span> right_sum = sum;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Type">double</span> pos = (threshold - left_sum) / (right_sum - left_sum);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Type">double</span> r = left_point + (right_point - left_point) * pos;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (r &lt; min_) r = min_;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (r &gt; max_) r = max_;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span> r;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> max_;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L94">&#x200c;</a><span class="Type">double</span> <a href="histogram.h.html#L14" title="util/histogram.h:14">Histogram</a>::<span class="linkable">Average</span>() <span class="Type">const</span> {<br/></li>
<li>&nbsp; <span class="Statement">if</span> (num_ == <span class="Constant">0.0</span>) <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>&nbsp; <span class="Statement">return</span> sum_ / num_;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L99">&#x200c;</a><span class="Type">double</span> <a href="histogram.h.html#L14" title="util/histogram.h:14">Histogram</a>::<span class="linkable">StandardDeviation</span>() <span class="Type">const</span> {<br/></li>
<li>&nbsp; <span class="Statement">if</span> (num_ == <span class="Constant">0.0</span>) <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>&nbsp; <span class="Type">double</span> variance = (sum_squares_ * num_ - sum_ * sum_) / (num_ * num_);<br/></li>
<li>&nbsp; <span class="Statement">return</span> sqrt(variance);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L105">&#x200c;</a>std::string <a href="histogram.h.html#L14" title="util/histogram.h:14">Histogram</a>::<span class="linkable">ToString</span>() <span class="Type">const</span> {<br/></li>
<li>&nbsp; std::string r;<br/></li>
<li>&nbsp; <span class="Type">char</span> buf[<span class="Constant">200</span>];<br/></li>
<li>&nbsp; snprintf(buf, <span class="Statement">sizeof</span>(buf),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;<a href="../db/write_batch.cc.html#L82" title="db/write_batch.cc:82">Count</a>: </span><span class="Special">%.0f</span><span class="Constant">&nbsp; <a href="#L94" title="util/histogram.cc:94">Average</a>: </span><span class="Special">%.4f</span><span class="Constant">&nbsp; StdDev: </span><span class="Special">%.2f\n</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; num_, <a href="#L94" title="util/histogram.cc:94">Average</a>(), <a href="#L99" title="util/histogram.cc:99">StandardDeviation</a>());<br/></li>
<li>&nbsp; r.append(buf);<br/></li>
<li>&nbsp; snprintf(buf, <span class="Statement">sizeof</span>(buf),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;Min: </span><span class="Special">%.4f</span><span class="Constant">&nbsp; <a href="#L69" title="util/histogram.cc:69">Median</a>: </span><span class="Special">%.4f</span><span class="Constant">&nbsp; Max: </span><span class="Special">%.4f\n</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (num_ == <span class="Constant">0.0</span> ? <span class="Constant">0.0</span> : min_), <a href="#L69" title="util/histogram.cc:69">Median</a>(), max_);<br/></li>
<li>&nbsp; r.append(buf);<br/></li>
<li>&nbsp; r.append(<span class="Constant">&quot;------------------------------------------------------</span><span class="Special">\n</span><span class="Constant">&quot;</span>);<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">double</span> mult = <span class="Constant">100.0</span> / num_;<br/></li>
<li>&nbsp; <span class="Type">double</span> sum = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; <span class="Statement">for</span> (<span class="Type">int</span> b = <span class="Constant">0</span>; b &lt; kNumBuckets; b++) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (buckets_[b] &lt;= <span class="Constant">0.0</span>) <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; sum += buckets_[b];<br/></li>
<li>&nbsp; &nbsp; snprintf(buf, <span class="Statement">sizeof</span>(buf),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;[ </span><span class="Special">%7.0f</span><span class="Constant">, </span><span class="Special">%7.0f</span><span class="Constant"> ) </span><span class="Special">%7.0f</span><span class="Constant"> </span><span class="Special">%7.3f%%</span><span class="Constant"> </span><span class="Special">%7.3f%%</span><span class="Constant"> &quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ((b == <span class="Constant">0</span>) ? <span class="Constant">0.0</span> : kBucketLimit[b-<span class="Constant">1</span>]),&nbsp; &nbsp; &nbsp; <span class="Comment">// left<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; kBucketLimit[b],&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">// right<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; buckets_[b],&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">// count<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; mult * buckets_[b],&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">// percentage<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; mult * sum);&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">// cumulative percentage<br/></li>
<li></span>&nbsp; &nbsp; r.append(buf);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// <a href="../table/table_test.cc.html#L146" title="table/table_test.cc:146">Add</a> <a href="../db/skiplist_test.cc.html#L155" title="db/skiplist_test.cc:155">hash</a> marks based on percentage; 20 marks for 100%.<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">int</span> marks = <span class="Statement">static_cast</span>&lt;<span class="Type">int</span>&gt;(<span class="Constant">20</span>*(buckets_[b] / num_) + <span class="Constant">0.5</span>);<br/></li>
<li>&nbsp; &nbsp; r.append(marks, <span class="Constant">'#'</span>);<br/></li>
<li>&nbsp; &nbsp; r.push_back(<span class="Special">'\n'</span>);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> r;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li>}&nbsp; <span class="Comment">// namespace leveldb<br/></li>
</ol></span></code>
 </body>
</html>
