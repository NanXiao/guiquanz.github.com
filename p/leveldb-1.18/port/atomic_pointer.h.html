<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>port/atomic_pointer.h - leveldb-1.18</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

code {
    font-family: consolas, monospace;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
  <h3>port/atomic_pointer.h - leveldb-1.18</h3>
   <a href="../index.html"> Table of Contents </a>
 <h4>Functions defined</h4>
 <ul>
<li><a href="#L116">Acquire_Load</a></li>
<li><a href="#L112">AtomicPointer</a></li>
<li><a href="#L113">AtomicPointer</a></li>
<li><a href="#L114">NoBarrier_Load</a></li>
<li><a href="#L115">NoBarrier_Store</a></li>
<li><a href="#L121">Release_Store</a></li>
</ul>
 <h4>Macros defined</h4>
 <ul>
<li><a href="#L37">ARCH_CPU_ARM_FAMILY</a></li>
<li><a href="#L217">ARCH_CPU_ARM_FAMILY</a></li>
<li><a href="#L39">ARCH_CPU_PPC_FAMILY</a></li>
<li><a href="#L218">ARCH_CPU_PPC_FAMILY</a></li>
<li><a href="#L33">ARCH_CPU_X86_FAMILY</a></li>
<li><a href="#L35">ARCH_CPU_X86_FAMILY</a></li>
<li><a href="#L216">ARCH_CPU_X86_FAMILY</a></li>
<li><a href="#L50">LEVELDB_HAVE_MEMORY_BARRIER</a></li>
<li><a href="#L215">LEVELDB_HAVE_MEMORY_BARRIER</a></li>
<li><a href="#L19">PORT_ATOMIC_POINTER_H_</a></li>
</ul>
 <h4>Source code</h4>

  <code><ol><li><span class="Comment">// Copyright (c) 2011 The LevelDB Authors. All rights reserved.<br/></li>
<li></span><span class="Comment">// Use of this source <a href="../include/leveldb/status.h.html#L84" title="include/leveldb/status.h:84">code</a> is governed by a BSD-style license that can be<br/></li>
<li></span><span class="Comment">// found in the LICENSE file. See the AUTHORS file for names of contributors.<br/></li>
<li></span><br/></li>
<li><span class="Comment">// <a href="port_example.h.html#L83" title="port/port_example.h:83">AtomicPointer</a> provides storage for a lock-free pointer.<br/></li>
<li></span><span class="Comment">// Platform-dependent implementation of <a href="port_example.h.html#L83" title="port/port_example.h:83">AtomicPointer</a>:<br/></li>
<li></span><span class="Comment">// - If the platform provides a cheap barrier, we use it with raw pointers<br/></li>
<li></span><span class="Comment">// - If &lt;atomic&gt; is present (on newer versions of gcc, it is), we use<br/></li>
<li></span><span class="Comment">//&nbsp;&nbsp; a &lt;atomic&gt;-based <a href="port_example.h.html#L83" title="port/port_example.h:83">AtomicPointer</a>.&nbsp; However we prefer the memory<br/></li>
<li></span><span class="Comment">//&nbsp;&nbsp; barrier based version, because at least on a gcc 4.4 32-bit build<br/></li>
<li></span><span class="Comment">//&nbsp;&nbsp; on linux, we have encountered a buggy &lt;atomic&gt; implementation.<br/></li>
<li></span><span class="Comment">//&nbsp;&nbsp; Also, some &lt;atomic&gt; implementations are much slower than a memory-barrier<br/></li>
<li></span><span class="Comment">//&nbsp;&nbsp; based implementation (~16ns for &lt;atomic&gt; based acquire-load vs. ~1ns for<br/></li>
<li></span><span class="Comment">//&nbsp;&nbsp; a barrier based acquire-load).<br/></li>
<li></span><span class="Comment">// This <a href="../include/leveldb/status.h.html#L84" title="include/leveldb/status.h:84">code</a> is based on atomicops-internals-* in Google's perftools:<br/></li>
<li></span><span class="Comment">// http://<a href="../include/leveldb/status.h.html#L84" title="include/leveldb/status.h:84">code</a>.google.com/p/google-perftools/source/browse/#svn%2Ftrunk%2Fsrc%2Fbase<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#ifndef <a href="#L19" title="port/atomic_pointer.h:19">PORT_ATOMIC_POINTER_H_</a><br/></li>
<li><a id="L19">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">PORT_ATOMIC_POINTER_H_</span><br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;stdint.h&gt;<br/></li>
<li></span><span class="PreProc">#ifdef LEVELDB_ATOMIC_PRESENT<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;atomic&gt;<br/></li>
<li></span><span class="PreProc">#endif<br/></li>
<li></span><span class="PreProc">#ifdef OS_WIN<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;windows.h&gt;<br/></li>
<li></span><span class="PreProc">#endif<br/></li>
<li></span><span class="PreProc">#ifdef OS_MACOSX<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;libkern/OSAtomic.h&gt;<br/></li>
<li></span><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#if defined(_M_X64) || defined(__x86_64__)<br/></li>
<li><a id="L33">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">ARCH_CPU_X86_FAMILY</span> </span><span class="Constant">1<br/></li>
<li></span><span class="PreProc">#elif defined(_M_IX86) || defined(__i386__) || defined(__i386)<br/></li>
<li><a id="L35">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">ARCH_CPU_X86_FAMILY</span> </span><span class="Constant">1<br/></li>
<li></span><span class="PreProc">#elif defined(__ARMEL__)<br/></li>
<li><a id="L37">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">ARCH_CPU_ARM_FAMILY</span> </span><span class="Constant">1<br/></li>
<li></span><span class="PreProc">#elif defined(__ppc__) || defined(__powerpc__) || defined(__powerpc64__)<br/></li>
<li><a id="L39">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">ARCH_CPU_PPC_FAMILY</span> </span><span class="Constant">1<br/></li>
<li></span><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="Type">namespace</span> leveldb {<br/></li>
<li><span class="Type">namespace</span> port {<br/></li>
<li><br/></li>
<li><span class="Comment">// Define MemoryBarrier() if available<br/></li>
<li></span><span class="Comment">// Windows on x86<br/></li>
<li></span><span class="PreProc">#if defined(OS_WIN) &amp;&amp; defined(COMPILER_MSVC) &amp;&amp; defined(<a href="#L33" title="port/atomic_pointer.h:33">ARCH_CPU_X86_FAMILY</a>)<br/></li>
<li></span><span class="Comment">// windows.h already provides a MemoryBarrier(void) macro<br/></li>
<li></span><span class="Comment">// http://msdn.microsoft.com/en-us/library/ms684208(v=vs.85).aspx<br/></li>
<li><a id="L50">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">LEVELDB_HAVE_MEMORY_BARRIER</span><br/></li>
<li></span><br/></li>
<li><span class="Comment">// Mac OS<br/></li>
<li></span><span class="PreProc">#elif defined(OS_MACOSX)<br/></li>
<li></span><span class="Type">inline</span> <span class="Type">void</span> MemoryBarrier() {<br/></li>
<li>&nbsp; OSMemoryBarrier();<br/></li>
<li>}<br/></li>
<li><span class="PreProc">#define <a href="#L50" title="port/atomic_pointer.h:50">LEVELDB_HAVE_MEMORY_BARRIER</a><br/></li>
<li></span><br/></li>
<li><span class="Comment">// Gcc on x86<br/></li>
<li></span><span class="PreProc">#elif defined(<a href="#L33" title="port/atomic_pointer.h:33">ARCH_CPU_X86_FAMILY</a>) &amp;&amp; defined(__GNUC__)<br/></li>
<li></span><span class="Type">inline</span> <span class="Type">void</span> MemoryBarrier() {<br/></li>
<li>&nbsp; <span class="Comment">// See http://gcc.gnu.org/ml/gcc/2003-04/msg01180.html for a discussion on<br/></li>
<li></span>&nbsp; <span class="Comment">// this idiom. Also see http://en.wikipedia.org/wiki/Memory_ordering.<br/></li>
<li></span>&nbsp; __asm__ __volatile__(<span class="Constant">&quot;&quot;</span> : : : <span class="Constant">&quot;memory&quot;</span>);<br/></li>
<li>}<br/></li>
<li><span class="PreProc">#define <a href="#L50" title="port/atomic_pointer.h:50">LEVELDB_HAVE_MEMORY_BARRIER</a><br/></li>
<li></span><br/></li>
<li><span class="Comment">// Sun Studio<br/></li>
<li></span><span class="PreProc">#elif defined(<a href="#L33" title="port/atomic_pointer.h:33">ARCH_CPU_X86_FAMILY</a>) &amp;&amp; defined(__SUNPRO_CC)<br/></li>
<li></span><span class="Type">inline</span> <span class="Type">void</span> MemoryBarrier() {<br/></li>
<li>&nbsp; <span class="Comment">// See http://gcc.gnu.org/ml/gcc/2003-04/msg01180.html for a discussion on<br/></li>
<li></span>&nbsp; <span class="Comment">// this idiom. Also see http://en.wikipedia.org/wiki/Memory_ordering.<br/></li>
<li></span>&nbsp; <span class="Statement">asm</span> <span class="Type">volatile</span>(<span class="Constant">&quot;&quot;</span> : : : <span class="Constant">&quot;memory&quot;</span>);<br/></li>
<li>}<br/></li>
<li><span class="PreProc">#define <a href="#L50" title="port/atomic_pointer.h:50">LEVELDB_HAVE_MEMORY_BARRIER</a><br/></li>
<li></span><br/></li>
<li><span class="Comment">// ARM Linux<br/></li>
<li></span><span class="PreProc">#elif defined(<a href="#L37" title="port/atomic_pointer.h:37">ARCH_CPU_ARM_FAMILY</a>) &amp;&amp; defined(__linux__)<br/></li>
<li></span><span class="Type">typedef</span> <span class="Type">void</span> (*LinuxKernelMemoryBarrierFunc)(<span class="Type">void</span>);<br/></li>
<li><span class="Comment">// The Linux ARM kernel provides a highly optimized device-specific memory<br/></li>
<li></span><span class="Comment">// barrier function at a fixed memory address that is mapped in every<br/></li>
<li></span><span class="Comment">// user-<a href="../db/version_set.h.html#L328" title="db/version_set.h:328">level</a> process.<br/></li>
<li></span><span class="Comment">//<br/></li>
<li></span><span class="Comment">// This beats using CPU-specific instructions which are, on single-core<br/></li>
<li></span><span class="Comment">// devices, un-necessary and very costly (e.g. ARMv7-A &quot;dmb&quot; takes more<br/></li>
<li></span><span class="Comment">// than 180ns on a Cortex-A8 like the one on a Nexus One). Benchmarking<br/></li>
<li></span><span class="Comment">// shows that the extra function call cost is completely negligible on<br/></li>
<li></span><span class="Comment">// multi-core devices.<br/></li>
<li></span><span class="Comment">//<br/></li>
<li></span><span class="Type">inline</span> <span class="Type">void</span> MemoryBarrier() {<br/></li>
<li>&nbsp; (*(LinuxKernelMemoryBarrierFunc)<span class="Constant">0xffff0fa0</span>)();<br/></li>
<li>}<br/></li>
<li><span class="PreProc">#define <a href="#L50" title="port/atomic_pointer.h:50">LEVELDB_HAVE_MEMORY_BARRIER</a><br/></li>
<li></span><br/></li>
<li><span class="Comment">// PPC<br/></li>
<li></span><span class="PreProc">#elif defined(<a href="#L39" title="port/atomic_pointer.h:39">ARCH_CPU_PPC_FAMILY</a>) &amp;&amp; defined(__GNUC__)<br/></li>
<li></span><span class="Type">inline</span> <span class="Type">void</span> MemoryBarrier() {<br/></li>
<li>&nbsp; <span class="Comment">// </span><span class="Todo">TODO</span><span class="Comment"> for some powerpc expert: is there a cheaper suitable variant?<br/></li>
<li></span>&nbsp; <span class="Comment">// Perhaps by having separate barriers for acquire and release ops.<br/></li>
<li></span>&nbsp; <span class="Statement">asm</span> <span class="Type">volatile</span>(<span class="Constant">&quot;sync&quot;</span> : : : <span class="Constant">&quot;memory&quot;</span>);<br/></li>
<li>}<br/></li>
<li><span class="PreProc">#define <a href="#L50" title="port/atomic_pointer.h:50">LEVELDB_HAVE_MEMORY_BARRIER</a><br/></li>
<li></span><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="Comment">// <a href="port_example.h.html#L83" title="port/port_example.h:83">AtomicPointer</a> built using platform-specific MemoryBarrier()<br/></li>
<li></span><span class="PreProc">#if defined(<a href="#L50" title="port/atomic_pointer.h:50">LEVELDB_HAVE_MEMORY_BARRIER</a>)<br/></li>
<li></span><span class="Type">class</span> <a href="port_example.h.html#L83" title="port/port_example.h:83">AtomicPointer</a> {<br/></li>
<li><span class="cUserCont"> </span><span class="Statement">private</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; <span class="Type">void</span>* rep_;<br/></li>
<li><span class="cUserCont"> </span><span class="Statement">public</span><span class="cUserCont">:<br/></li>
<li><a id="L112">&#x200c;</a></span>&nbsp; <span class="linkable">AtomicPointer</span>() { }<br/></li>
<li><a id="L113">&#x200c;</a>&nbsp; <span class="Type">explicit</span> <span class="linkable">AtomicPointer</span>(<span class="Type">void</span>* p) : rep_(p) {}<br/></li>
<li><a id="L114">&#x200c;</a>&nbsp; <span class="Type">inline</span> <span class="Type">void</span>* <span class="linkable">NoBarrier_Load</span>() <span class="Type">const</span> { <span class="Statement">return</span> rep_; }<br/></li>
<li><a id="L115">&#x200c;</a>&nbsp; <span class="Type">inline</span> <span class="Type">void</span> <span class="linkable">NoBarrier_Store</span>(<span class="Type">void</span>* v) { rep_ = v; }<br/></li>
<li><a id="L116">&#x200c;</a>&nbsp; <span class="Type">inline</span> <span class="Type">void</span>* <span class="linkable">Acquire_Load</span>() <span class="Type">const</span> {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">void</span>* result = rep_;<br/></li>
<li>&nbsp; &nbsp; MemoryBarrier();<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> result;<br/></li>
<li>&nbsp; }<br/></li>
<li><a id="L121">&#x200c;</a>&nbsp; <span class="Type">inline</span> <span class="Type">void</span> <span class="linkable">Release_Store</span>(<span class="Type">void</span>* v) {<br/></li>
<li>&nbsp; &nbsp; MemoryBarrier();<br/></li>
<li>&nbsp; &nbsp; rep_ = v;<br/></li>
<li>&nbsp; }<br/></li>
<li>};<br/></li>
<li><br/></li>
<li><span class="Comment">// <a href="port_example.h.html#L83" title="port/port_example.h:83">AtomicPointer</a> based on &lt;cstdatomic&gt;<br/></li>
<li></span><span class="PreProc">#elif defined(LEVELDB_ATOMIC_PRESENT)<br/></li>
<li></span><span class="Type">class</span> <a href="port_example.h.html#L83" title="port/port_example.h:83">AtomicPointer</a> {<br/></li>
<li><span class="cUserCont"> </span><span class="Statement">private</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; std::atomic&lt;<span class="Type">void</span>*&gt; rep_;<br/></li>
<li><span class="cUserCont"> </span><span class="Statement">public</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; <a href="port_example.h.html#L83" title="port/port_example.h:83">AtomicPointer</a>() { }<br/></li>
<li>&nbsp; <span class="Type">explicit</span> <a href="port_example.h.html#L83" title="port/port_example.h:83">AtomicPointer</a>(<span class="Type">void</span>* v) : rep_(v) { }<br/></li>
<li>&nbsp; <span class="Type">inline</span> <span class="Type">void</span>* <a href="#L116" title="port/atomic_pointer.h:116">Acquire_Load</a>() <span class="Type">const</span> {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> rep_.load(std::memory_order_acquire);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Type">inline</span> <span class="Type">void</span> <a href="#L121" title="port/atomic_pointer.h:121">Release_Store</a>(<span class="Type">void</span>* v) {<br/></li>
<li>&nbsp; &nbsp; rep_.store(v, std::memory_order_release);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Type">inline</span> <span class="Type">void</span>* <a href="#L114" title="port/atomic_pointer.h:114">NoBarrier_Load</a>() <span class="Type">const</span> {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> rep_.load(std::memory_order_relaxed);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Type">inline</span> <span class="Type">void</span> <a href="#L115" title="port/atomic_pointer.h:115">NoBarrier_Store</a>(<span class="Type">void</span>* v) {<br/></li>
<li>&nbsp; &nbsp; rep_.store(v, std::memory_order_relaxed);<br/></li>
<li>&nbsp; }<br/></li>
<li>};<br/></li>
<li><br/></li>
<li><span class="Comment">// Atomic pointer based on sparc memory barriers<br/></li>
<li></span><span class="PreProc">#elif defined(__sparcv9) &amp;&amp; defined(__GNUC__)<br/></li>
<li></span><span class="Type">class</span> <a href="port_example.h.html#L83" title="port/port_example.h:83">AtomicPointer</a> {<br/></li>
<li><span class="cUserCont"> </span><span class="Statement">private</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; <span class="Type">void</span>* rep_;<br/></li>
<li><span class="cUserCont"> </span><span class="Statement">public</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; <a href="port_example.h.html#L83" title="port/port_example.h:83">AtomicPointer</a>() { }<br/></li>
<li>&nbsp; <span class="Type">explicit</span> <a href="port_example.h.html#L83" title="port/port_example.h:83">AtomicPointer</a>(<span class="Type">void</span>* v) : rep_(v) { }<br/></li>
<li>&nbsp; <span class="Type">inline</span> <span class="Type">void</span>* <a href="#L116" title="port/atomic_pointer.h:116">Acquire_Load</a>() <span class="Type">const</span> {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">void</span>* val;<br/></li>
<li>&nbsp; &nbsp; __asm__ __volatile__ (<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;ldx [</span><span class="Special">%[rep_]</span><span class="Constant">], </span><span class="Special">%[val]</span><span class="Constant"> </span><span class="Special">\n\t</span><span class="Constant">&quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;membar #LoadLoad|#LoadStore </span><span class="Special">\n\t</span><span class="Constant">&quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; : [val] <span class="Constant">&quot;=r&quot;</span> (val)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; : [rep_] <span class="Constant">&quot;r&quot;</span> (&amp;rep_)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; : <span class="Constant">&quot;memory&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> val;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Type">inline</span> <span class="Type">void</span> <a href="#L121" title="port/atomic_pointer.h:121">Release_Store</a>(<span class="Type">void</span>* v) {<br/></li>
<li>&nbsp; &nbsp; __asm__ __volatile__ (<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;membar #LoadStore|#StoreStore </span><span class="Special">\n\t</span><span class="Constant">&quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;stx </span><span class="Special">%[v]</span><span class="Constant">, [</span><span class="Special">%[rep_]</span><span class="Constant">] </span><span class="Special">\n\t</span><span class="Constant">&quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; :<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; : [rep_] <span class="Constant">&quot;r&quot;</span> (&amp;rep_), [v] <span class="Constant">&quot;r&quot;</span> (v)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; : <span class="Constant">&quot;memory&quot;</span>);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Type">inline</span> <span class="Type">void</span>* <a href="#L114" title="port/atomic_pointer.h:114">NoBarrier_Load</a>() <span class="Type">const</span> { <span class="Statement">return</span> rep_; }<br/></li>
<li>&nbsp; <span class="Type">inline</span> <span class="Type">void</span> <a href="#L115" title="port/atomic_pointer.h:115">NoBarrier_Store</a>(<span class="Type">void</span>* v) { rep_ = v; }<br/></li>
<li>};<br/></li>
<li><br/></li>
<li><span class="Comment">// Atomic pointer based on ia64 acq/rel<br/></li>
<li></span><span class="PreProc">#elif defined(__ia64) &amp;&amp; defined(__GNUC__)<br/></li>
<li></span><span class="Type">class</span> <a href="port_example.h.html#L83" title="port/port_example.h:83">AtomicPointer</a> {<br/></li>
<li><span class="cUserCont"> </span><span class="Statement">private</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; <span class="Type">void</span>* rep_;<br/></li>
<li><span class="cUserCont"> </span><span class="Statement">public</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; <a href="port_example.h.html#L83" title="port/port_example.h:83">AtomicPointer</a>() { }<br/></li>
<li>&nbsp; <span class="Type">explicit</span> <a href="port_example.h.html#L83" title="port/port_example.h:83">AtomicPointer</a>(<span class="Type">void</span>* v) : rep_(v) { }<br/></li>
<li>&nbsp; <span class="Type">inline</span> <span class="Type">void</span>* <a href="#L116" title="port/atomic_pointer.h:116">Acquire_Load</a>() <span class="Type">const</span> {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">void</span>* val&nbsp; &nbsp; ;<br/></li>
<li>&nbsp; &nbsp; __asm__ __volatile__ (<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;ld8.acq </span><span class="Special">%[val]</span><span class="Constant"> = [</span><span class="Special">%[rep_]</span><span class="Constant">] </span><span class="Special">\n\t</span><span class="Constant">&quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; : [val] <span class="Constant">&quot;=r&quot;</span> (val)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; : [rep_] <span class="Constant">&quot;r&quot;</span> (&amp;rep_)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; : <span class="Constant">&quot;memory&quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; );<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> val;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Type">inline</span> <span class="Type">void</span> <a href="#L121" title="port/atomic_pointer.h:121">Release_Store</a>(<span class="Type">void</span>* v) {<br/></li>
<li>&nbsp; &nbsp; __asm__ __volatile__ (<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;st8.rel [</span><span class="Special">%[rep_]</span><span class="Constant">] = </span><span class="Special">%[v]</span><span class="Constant">&nbsp; </span><span class="Special">\n\t</span><span class="Constant">&quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; :<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; : [rep_] <span class="Constant">&quot;r&quot;</span> (&amp;rep_), [v] <span class="Constant">&quot;r&quot;</span> (v)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; : <span class="Constant">&quot;memory&quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; );<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Type">inline</span> <span class="Type">void</span>* <a href="#L114" title="port/atomic_pointer.h:114">NoBarrier_Load</a>() <span class="Type">const</span> { <span class="Statement">return</span> rep_; }<br/></li>
<li>&nbsp; <span class="Type">inline</span> <span class="Type">void</span> <a href="#L115" title="port/atomic_pointer.h:115">NoBarrier_Store</a>(<span class="Type">void</span>* v) { rep_ = v; }<br/></li>
<li>};<br/></li>
<li><br/></li>
<li><span class="Comment">// We have neither MemoryBarrier(), nor &lt;atomic&gt;<br/></li>
<li></span><span class="PreProc">#else<br/></li>
<li></span><span class="PreProc">#error Please implement <a href="port_example.h.html#L83" title="port/port_example.h:83">AtomicPointer</a> </span><span class="Statement">for</span><span class="PreProc"> </span><span class="Statement">this</span><span class="PreProc"> platform.<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><a id="L215">&#x200c;</a><span class="PreProc">#undef <span class="linkable">LEVELDB_HAVE_MEMORY_BARRIER</span><br/></li>
<li><a id="L216">&#x200c;</a></span><span class="PreProc">#undef <span class="linkable">ARCH_CPU_X86_FAMILY</span><br/></li>
<li><a id="L217">&#x200c;</a></span><span class="PreProc">#undef <span class="linkable">ARCH_CPU_ARM_FAMILY</span><br/></li>
<li><a id="L218">&#x200c;</a></span><span class="PreProc">#undef <span class="linkable">ARCH_CPU_PPC_FAMILY</span><br/></li>
<li></span><br/></li>
<li>}&nbsp; <span class="Comment">// namespace port<br/></li>
<li></span>}&nbsp; <span class="Comment">// namespace leveldb<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#endif</span>&nbsp; <span class="Comment">// <a href="#L19" title="port/atomic_pointer.h:19">PORT_ATOMIC_POINTER_H_</a><br/></li>
</ol></span></code>
 </body>
</html>
